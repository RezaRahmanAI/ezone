----------COMMONSOURCE----------
-------------Nahid--------------
----------25-05-2025------------

ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = s.TSQty,
		ActionStatus = ActionStatus + 1
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	Create Table #tmpStock3(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate,
		sod.SRate = SD.UnitPrice - SD.PPDisAmt
		
	
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)



	--Stock out
	delete #tmpStock

 --   INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	--(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	--where  s.Status = 3 OR s.Status = 4
	--group by s.ProductId,s.ColorId,s.Compressor
	--)

	--DECLARE @prevQty DECIMAL(18,2) = (SELECT ISNULL(SUM(s.Quantity), 0) FROM @SODetails s
	--INNER JOIN Products P On s.ProductId = p.ProductID
	--WHERE s.Status = 4 AND p.ProductType !=2)

	--UPDATE st
	--SET st.Quantity = ((st.Quantity - sod.Qty) + @prevQty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	--FROM #tmpStock sod
	--INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--INNER JOIN Products p ON p.ProductID = st.ProductID
	--where p.ProductType !=2

	--UPDATE st
	--SET st.Quantity = ((st.Quantity - sod.Qty)),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	--FROM #tmpStock sod
	--INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--INNER JOIN Products p ON p.ProductID = st.ProductID
	--where p.ProductType =2

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	JOIN Products p on s.ProductID=p.ProductID 
	where s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	INSERT INTO #tmpStock3(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty + sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType !=2

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock3 sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType !=2

	UPDATE st
	SET st.Quantity = ((st.Quantity - sod.Qty)),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType =2

	UPDATE st
	SET st.Quantity = ((st.Quantity - sod.Qty)),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock3 sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType =2

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2 and IsDamage = 0



	
-- For No barcode Stock Details out and SOrderDetails Insert
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @GodownID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @SOrderDetailID INT
DECLARE @Quantity decimal(18,2)
DECLARE @StockQty decimal(18,2)
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL FOR
SELECT s.ProductId,
       s.colorid,
       s.Compressor,
       s.quantity,
       sorderdetailid
FROM @SODetails s
JOIN products ON products.productid = s.productid
WHERE products.ProductType = 2 AND s.Status = 3

OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID,
     @ColorID,
     @GodownID,
     @Quantity,
     @SOrderDetailID

WHILE @@FETCH_STATUS = 0
BEGIN
    WHILE (@Quantity != 0)
    BEGIN
        -- Get the first available stock detail
        SET @SDetailID = (
            SELECT MIN(SDetailID)
            FROM stockdetails
            WHERE productid = @ProductID AND colorid = @ColorID
            AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1 and IsDamage = 0
        )

        -- Get the stock quantity
        SET @StockQty = (
            SELECT quantity
            FROM stockdetails
            WHERE sdetailid = @SDetailID
        )

        IF (@StockQty > @Quantity)
        BEGIN
            -- If stock quantity is greater than the order quantity
            SET @StockQty = @StockQty - @Quantity

            -- Update stock details
            UPDATE stockdetails
            SET quantity = @StockQty
            WHERE sdetailid = @SDetailID			

            -- Insert into order details
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
        ELSE IF (@StockQty < @Quantity)
        BEGIN
            -- If stock quantity is less than order quantity
            SET @Quantity = @Quantity - @StockQty

            -- Update stock to 0 and change status to 2 (unavailable)
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

			
            -- Insert into order details for partial quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @StockQty,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @StockQty,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3
        END
        ELSE
        BEGIN
            -- If stock quantity equals the order quantity, mark as processed
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

            -- Insert the order detail for the exact quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
    END

    FETCH NEXT
    FROM cur
    INTO @ProductID,
         @ColorID,
         @GodownID,
         @Quantity,
         @SOrderDetailID
END

CLOSE cur
DEALLOCATE cur


	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId



	--***************************************
	--SR visit Update**************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0
	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT so.InvoiceDate,
		so.invoiceno,
		so.customerid,
		so.vatpercentage,
		so.vatamount,
		so.grandtotal,
		so.TDPercentage,
		so.TDAmount,
		so.netdiscount,
		so.totalamount,
		so.paymentdue,
		so.RecAmount,
		so.adjamount,
		so.totaldue,
		so.STATUS,
		so.concernid,
		so.createdby,
		so.createdate,
		so.totaloffer,
		so.Remarks,
		so.TramsAndCondition,
		so.CardTypeSetupID,
		so.CardPaidAmount,
		so.DepositChargePercent,
		so.BankTransID,
		so.TSQty,
		so.PrevDue,
		so.ActionStatus,
		so.SOrderID
		FROM SOrders so
		INNER JOIN SOrders s on so.SOrderID = s.SOrderID AND s.SOrderID =  @SalesOrderId
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH



----------COMMONSOURCE----------
-------------Nahid--------------
----------12-05-2025------------



ALTER TABLE dbo.Products ADD
	UserInputWarranty nvarchar(100) NULL
GO


----------COMMONSOURCE----------
-------------Nahid--------------
----------23-04-2025------------


-- EXEC GetDatewiseSupplierDue 5213,0,'2024-01-14 00:00:00.000','2024-01-14 00:00:00.000','2024-01-14 00:00:00.000'
ALTER PROC [dbo].[GetDatewiseSupplierDue]
(
		@concernId INT
		,@SupplierId INT,
		@asOnDate datetime,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.SupplierID,
		(
			(
				ISNULL(piv.TotalAmt, 0) + ISNULL(piv.OpeningDue, 0) + ISNULL(piv.BankCashCollectionReturnAmt, 0)
				+ ISNULL(piv.TotalReturnRecAmt, 0) + ISNULL(piv.CashCollectionIntAmt, 0) + ISNULL(piv.CashCollectionDebitAdjAmt, 0) + ISNULL(piv.CashCollectionReturnAmt, 0)
			)
			-
			(
				ISNULL(piv.TotalRecAmt, 0) 
				+ ISNULL(piv.TotalReturnAmt, 0) + ISNULL(piv.CashCollectionAmt, 0) + ISNULL(piv.CashCollectionCreditAdjAmt, 0) + ISNULL(piv.BankCashCollectionAmt, 0) 
			)
		) 'TotalDue'

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.SupplierID FROM Suppliers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@SupplierId = 0 OR c.SupplierID = @SupplierId)
	GROUP BY c.SupplierID, c.Address
	UNION ALL
	--start here 
	

	-- end here
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SupplierID  FROM
	(
	SELECT po.TotalAmt PrevSales, 'TotalAmt' Id, po.SupplierID FROM dbo.POrders po
	JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
	JOIN dbo.Products p ON p.ProductID = pd.ProductID
	WHERE po.ConcernID = @concernId
	AND po.Status IN (1,6)
	AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY po.SupplierID, po.TotalAmt, po.ChallanNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.SupplierID

	UNION ALL

	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SupplierID  FROM
	(
	SELECT po.RecAmt PrevSales, 'TotalRecAmt' Id, po.SupplierID FROM dbo.POrders po
	JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
	JOIN dbo.Products p ON p.ProductID = pd.ProductID
	WHERE po.ConcernID = @concernId
	AND po.Status IN (1,6)
	AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY po.SupplierID, po.RecAmt, po.ChallanNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.SupplierID
	
	UNION ALL
	SELECT SUM(tblReturn.PrevSales) PrevSales, tblReturn.Id, tblReturn.SupplierID FROM
	(
		SELECT po.TotalAmt PrevSales, 'TotalReturnAmt' Id, po.SupplierID FROM dbo.POrders po
		JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
		JOIN dbo.Products p ON p.ProductID = pd.ProductID
		WHERE po.ConcernID = @concernId
		AND po.Status IN (5,4)
		AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
		AND (
			(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
				OR
			(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
		)
		GROUP BY po.SupplierID, po.TotalAmt, po.ChallanNo
	) tblReturn
	GROUP BY tblReturn.Id, tblReturn.SupplierID
	UNION ALL

		SELECT SUM(tblReturn.PrevSales) PrevSales, tblReturn.Id, tblReturn.SupplierID FROM
	(
		SELECT po.RecAmt PrevSales, 'TotalReturnRecAmt' Id, po.SupplierID FROM dbo.POrders po
		JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
		JOIN dbo.Products p ON p.ProductID = pd.ProductID
		WHERE po.ConcernID = @concernId
		AND po.Status IN (5,4)
		AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
		AND (
			(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
				OR
			(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
		)
		GROUP BY po.SupplierID, po.RecAmt, po.ChallanNo
	) tblReturn
	GROUP BY tblReturn.Id, tblReturn.SupplierID

	UNION ALL

	SELECT SUM(ISNULL(cc.InterestAmt, 0)), 'CashCollectionIntAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY cc.SupplierID
	
	UNION ALL

	SELECT SUM(ISNULL(cc.Amount, 0) + ISNULL(cc.AdjustAmt, 0)), 'CashCollectionAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId AND cc.TransactionType IN(2)
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY cc.SupplierID

	UNION ALL

	SELECT SUM(ISNULL(cc.Amount, 0)), 'BankCashCollectionAmt' Id, cc.SupplierID FROM dbo.BankTransactions cc
	WHERE cc.ConcernID = @concernId AND cc.TransactionType IN(4)
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY cc.SupplierID

	UNION ALL

	SELECT SUM(ISNULL(cc.Amount, 0) + ISNULL(cc.AdjustAmt, 0)), 'CashCollectionReturnAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId AND cc.TransactionType IN(3)
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY cc.SupplierID

	UNION ALL

	SELECT SUM(ISNULL(cc.Amount, 0)), 'BankCashCollectionReturnAmt' Id, cc.SupplierID FROM dbo.BankTransactions cc
	WHERE cc.ConcernID = @concernId AND cc.TransactionType IN(10)
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY cc.SupplierID

	UNION ALL

	SELECT SUM(ISNULL(cc.Amount, 0) + ISNULL(cc.AdjustAmt, 0)), 'CashCollectionDebitAdjAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId AND cc.TransactionType IN(6)
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY cc.SupplierID

	UNION ALL

	SELECT SUM(ISNULL(cc.Amount, 0) + ISNULL(cc.AdjustAmt, 0)), 'CashCollectionCreditAdjAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId AND cc.TransactionType IN(7)
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY cc.SupplierID
	--UNION ALL

	--SELECT SUM(ISNULL(bt.Amount, 0)), 'BankTransaction', bt.SupplierID FROM dbo.BankTransactions bt
	--WHERE bt.ConcernID = @concernId
	--AND bt.SupplierID <> 0
	--AND (@SupplierId = 0 OR bt.SupplierID = @SupplierId)
	--	AND (
	--	(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
	--		OR
	--	(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	--)

	--GROUP BY bt.SupplierID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			TotalAmt, TotalRecAmt, TotalReturnAmt, TotalReturnRecAmt, CashCollectionIntAmt, CashCollectionAmt, BankTransaction,CashCollectionDebitAdjAmt,CashCollectionCreditAdjAmt,
			OpeningDue,CashCollectionReturnAmt,BankCashCollectionAmt,BankCashCollectionReturnAmt

		)
	) piv
 END


--------------------------------------------------------------------------------------------------------------------------



ALTER PROC [dbo].[sp_AddReplacementOrder]
(
    @SalesOrder [InsertReplaceOrderTable] readonly,
    @SODetails [InsertRODetailTable] readonly
)
AS
DECLARE @SalesOrderId INT;
DECLARE @ProductType INT;
DECLARE @Quantity DECIMAL(18, 2);
DECLARE @StockDetailId INT;

BEGIN TRY
    BEGIN TRANSACTION;

    -- Insert into SOrders
    INSERT INTO SOrders
    (
        InvoiceDate, InvoiceNo, CustomerID, VATPercentage, VATAmount, GrandTotal, TDPercentage, TDAmount, NetDiscount,
        TotalAmount, PaymentDue, RecAmount, AdjAmount, TotalDue, Status, ConcernID, CreatedBy, CreateDate, TotalOffer, IsReplacement
    )
    SELECT InvoiceDate, InvoiceNo, CustomerID, VATPercentage, VATAmount, GrandTotal, TDiscountPercentage, TDiscountAmount, NetDiscount,
           TotalAmount, PaymentDue, RecAmt, AdjAmount, TotalDue, Status, ConcernID, CreatedBy, CreateDate, TotalOffer, IsReplacement
    FROM @SalesOrder;

    -- Update Customer's TotalDue
    UPDATE Customers
    SET Customers.TotalDue = (Customers.TotalDue + s.TotalDue)
    FROM @SalesOrder s
    JOIN Customers ON Customers.CustomerID = s.CustomerID;

    -- Capture the new SalesOrderId
    SET @SalesOrderId = SCOPE_IDENTITY();

    -- Update SOrderDetails with the new values
    UPDATE SOrderDetails
    SET RStockDetailId = s.RStockDetailId,
        RepOrderID = @SalesOrderId,
        RepUnitPrice = s.UnitPrice,
        Remarks = s.Remarks,
        RQuantity = (RQuantity + s.Quantity),
        ReplaceProductType = s.IsDamage
    FROM @SODetails s
    JOIN SOrderDetails SOD ON SOD.SDetailID = s.StockDetailId
    JOIN SOrders SO ON SOD.SOrderID = SO.SOrderID
    WHERE SOD.SDetailId IN (SELECT StockDetailId FROM @SODetails)
      AND SO.Status != 4
      AND SOD.IsProductReturn != 1 AND sod.SOrderDetailID = s.dSOrderDetailID;

    -- Insert new SOrderDetails
    INSERT INTO SOrderDetails
    (
        ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, PPDAmount, MPRate, SOrderID, SDetailID, PPOffer, Remarks
    )
    SELECT ProductId, Quantity, UnitPrice, TAmount, PPDisPer, PPDisAmt, MrpRate, @SalesOrderId SOrderID, RStockDetailId, PPOffer, Remarks
    FROM @SODetails;

    -- Stock Decrease for New Product
    UPDATE Stocks
    SET Stocks.Quantity = (Stocks.Quantity - s.Quantity)
    FROM @SODetails s
    JOIN Stocks ON Stocks.ProductID = s.ProductId AND Stocks.ColorID = s.ColorId;

UPDATE StockDetails
SET StockDetails.Status = 2
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.RStockDetailId
INNER JOIN Products ON Products.ProductID = StockDetails.ProductID
WHERE Products.ProductType !=2

UPDATE StockDetails
SET StockDetails.Quantity = (StockDetails.Quantity - s.Quantity)
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.RStockDetailId
INNER JOIN Products ON Products.ProductID = StockDetails.ProductID
WHERE Products.ProductType = 2

UPDATE StockDetails
SET StockDetails.Status = 2
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.RStockDetailId
INNER JOIN Products ON Products.ProductID = StockDetails.ProductID
WHERE Products.ProductType = 2 AND StockDetails.Quantity = 0





    --**************************************************************
    --*********************not damage*******************************
    UPDATE Stocks
    SET Stocks.Quantity = (Stocks.Quantity + s.Quantity)
    FROM @SODetails s
    JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
    JOIN Stocks ON Stocks.StockID = StockDetails.StockID;

    UPDATE StockDetails
    SET StockDetails.Quantity = (StockDetails.Quantity + s.Quantity), StockDetails.Status = 1
    FROM @SODetails s
    JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
    WHERE s.IsDamage = 2;

    --**************************************************************
    --*********************damage***********************************
    -- Cursor to handle damaged products
    DECLARE cur_damaged CURSOR LOCAL FOR
    SELECT p.ProductType, s.Quantity, s.StockDetailId
    FROM @SODetails s
	JOIN StockDetails sd ON sd.SDetailID = s.StockDetailId
    JOIN Products p ON sd.ProductId = p.ProductID
    WHERE s.IsDamage = 1;

    OPEN cur_damaged;

    FETCH NEXT FROM cur_damaged INTO @ProductType, @Quantity, @StockDetailId;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        IF (@ProductType = 2) -- No Barcode Product
        BEGIN
            -- Insert a new row with Status = 4 for the damaged product
            INSERT INTO StockDetails
            (
                StockCode, ProductID, IMENO, StockID, Status, ColorID, POrderDetailID, PRate, SRate, CreditSRate, 
                CRSalesRate12Month, CRSalesRate3Month, Quantity, GodownID, TransferDetailID, UsedStockStatus, UsedSaleRate, UsedPurchaseRate, IsDamage
            )
            SELECT StockCode, ProductID, IMENO, StockID, 1, ColorID, POrderDetailID, PRate, SRate, CreditSRate, 
                   CRSalesRate12Month, CRSalesRate3Month, @Quantity, GodownID, TransferDetailID, UsedStockStatus, UsedSaleRate, UsedPurchaseRate, 1
            FROM StockDetails
            WHERE SDetailID = @StockDetailId;

           
        END
        ELSE
        BEGIN
            -- For other product types, just update the status to 4
            UPDATE StockDetails
            SET StockDetails.Status = 1, IsDamage = 1
            WHERE StockDetails.SDetailID = @StockDetailId;
        END;

        FETCH NEXT FROM cur_damaged INTO @ProductType, @Quantity, @StockDetailId;
    END;

    -- Close and deallocate cursor
    CLOSE cur_damaged;
    DEALLOCATE cur_damaged;

    -- Update the status in SRVProductDetails for damaged products
    UPDATE SRVProductDetails
    SET SRVProductDetails.Status = 2
    FROM @SODetails s
    JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.RStockDetailId
    WHERE SRVProductDetails.Status = 1;

    COMMIT

    RETURN 1;

END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK

    RETURN 0;
END CATCH

--------------------------------------------------------------------------------------------------------------------------

ALTER PROC [dbo].[sp_AddTransferOrder]
(
	@dtTransferOrder ADDTransferTable readonly,
	@dtTransferDetails ADDTransferDetailsTable readonly,
	@dtTransferFromStock InsertTransferStockTable readonly,
	@dtTransferToStock InsertTransferStockTable readonly,
	@ReturnResult int output,
	@ReturnTransferID int Output
)
  
AS 

BEGIN TRY  
 BEGIN TRANSACTION 

 Declare @TransferID int
 Declare @ToConcernID int
 Declare @CreatedBy int
 Declare @CreatedDate Datetime

INSERT INTO Transfers
(
TransferDate,TransferNo,ConcernID,CreateDate,FromConcernID,Remarks,Status,ToConcernID,TotalAmount,CreatedBy
)
(Select TransferDate,TransferNo,ConcernID,CreateDate,FromConcernID,Remarks,Status,ToConcernID,TotalAmount,CreatedBy from @dtTransferOrder)

set  @TransferID = SCOPE_IDENTITY()

set @CreatedBy =ISNULL((select CreatedBy from @dtTransferOrder),0)
set @CreatedDate =ISNULL((select CreateDate from @dtTransferOrder),GETDATE())
set @ToConcernID =ISNULL((select ToConcernID from @dtTransferOrder),0)

INSERT INTO TransferDetails
(
 PRate,ProductID,Quantity,SDetailID,ToColorID,ToGodownID,ToProductID,UTAmount,TransferID,IMEI, SRate
)
(
select  UnitPrice,td.ProductID,Quantity,SDetailID,ToColorID,ToGodownID,ToProductID,UTAmount,@TransferID,IMEI, SRate from @dtTransferDetails td
INNER JOIN Products p ON td.ProductId = p.ProductID
WHERE p.ProductType!=2
)
--*******************Decrease From Godown stocks****************
UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity - t.Quantity),ModifiedDate =  @CreatedDate,ModifiedBy=@CreatedBy
from @dtTransferFromStock t
INNER JOIN Stocks ON Stocks.ProductID =t.ProductID and Stocks.ColorID=t.ColorID and Stocks.GodownID = t.GodownID

UPDATE stockdetails
SET stockdetails.STATUS = 2
FROM @dtTransferDetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.SDetailID
INNER JOIN products ON stockdetails.productid = products.productid
WHERE products.producttype = 1 OR products.producttype = 3 AND IsDamage = 0

--No barcode product quantity update
--UPDATE stockdetails
--SET Quantity=stockdetails.Quantity-s.Quantity
--FROM @dtTransferDetails s
--INNER JOIN stockdetails ON stockdetails.sdetailid = s.SDetailID
--INNER JOIN products ON stockdetails.productid = products.productid
--WHERE products.producttype = 2


DECLARE @ProductID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @GodownID INT
DECLARE @Quantity DECIMAL(18,2)
DECLARE @SQty DECIMAL(18,2)

DECLARE cur CURSOR LOCAL
FOR
SELECT s.ProductID,
		s.ColorID,
		s.GodownID,
		s.Quantity,
		s.SDetailID
	FROM @dtTransferDetails s
	INNER JOIN products
		ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity > 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1 AND IsDamage = 0
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)


		IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity
				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				INSERT INTO TransferDetails
				(
					PRate,ProductID,Quantity,SDetailID,ToColorID,ToGodownID,ToProductID,UTAmount,TransferID,IMEI, SRate
				)
				(
					SELECT TOP 1  
					UnitPrice,td.ProductID,@Quantity,@SDetailID,ToColorID,ToGodownID,ToProductID,(td.UnitPrice * @Quantity),@TransferID,IMEI, td.SRate from @dtTransferDetails td
					INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
					INNER JOIN products p ON STD.productid = p.productid
					WHERE td.productid = @ProductID
		            AND td.colorid = @ColorID
				    AND td.GodownID = @GodownID
					AND STD.SDetailID = @SDetailID
				)


				SET @Quantity = 0
			END

			ELSE IF (@SQty < @Quantity)
			BEGIN
				print(@Quantity)
				SET @Quantity = @Quantity - @SQty

				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO TransferDetails
				(
					PRate,ProductID,Quantity,SDetailID,ToColorID,ToGodownID,ToProductID,UTAmount,TransferID,IMEI, SRate
				)
				(
					SELECT TOP 1  
					UnitPrice,td.ProductID,@SQty,@SDetailID,ToColorID,ToGodownID,ToProductID,(td.UnitPrice * @SQty),@TransferID,IMEI, td.SRate from @dtTransferDetails td
					INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
					INNER JOIN products p ON STD.productid = p.productid
					WHERE td.productid = @ProductID
		            AND td.colorid = @ColorID
				    AND td.GodownID = @GodownID
					AND STD.SDetailID = @SDetailID
				)

			END

			ELSE
			BEGIN

				print(@Quantity)
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO TransferDetails
				(
					PRate,ProductID,Quantity,SDetailID,ToColorID,ToGodownID,ToProductID,UTAmount,TransferID,IMEI, SRate
				)
				(
					SELECT TOP 1  
					UnitPrice,td.ProductID,@Quantity,@SDetailID,ToColorID,ToGodownID,ToProductID,(td.UnitPrice * @Quantity),@TransferID,IMEI, td.SRate from @dtTransferDetails td
					INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
					INNER JOIN products p ON STD.productid = p.productid
					WHERE td.productid = @ProductID
		            AND td.colorid = @ColorID
				    AND td.GodownID = @GodownID
					AND STD.SDetailID = @SDetailID
				)


				SET @Quantity = 0

			END

		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SDetailID

	END


--No barcode product status update
--UPDATE stockdetails
--SET StockDetails.Status=2
--FROM @dtTransferDetails s
--INNER JOIN stockdetails ON stockdetails.sdetailid = s.SDetailID
--INNER JOIN products ON stockdetails.productid = products.productid
--WHERE products.producttype = 2 and StockDetails.Quantity=0

--*******************Decrease From Godown stocks****************

--********************Increase To Godown Stocks******************

UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity + t.Quantity),ModifiedDate = @CreatedDate ,ModifiedBy=@CreatedBy
from @dtTransferToStock t
JOIN Stocks ON Stocks.ProductID =t.ProductID and Stocks.ColorID=t.ColorID and Stocks.GodownID = t.GodownID

INSERT INTO Stocks
(
StockCode, EntryDate, Quantity, ProductID,ColorID,
GodownID,MRPPrice, LPPrice,CreatedBy,CreateDate,ConcernID
)
(Select 
Max(t.StockCode), @CreatedDate,Sum(t.Quantity), t.ToProductID,t.ToColorID,
t.ToGodownID,  Max(t.UnitPrice), Max(t.UnitPrice), @CreatedBy,@CreatedDate,@ToConcernID
from @dtTransferDetails t 
group by t.ToProductID,ToColorID,ToGodownID
having Min(t.StockId)=0
)

INSERT INTO StockDetails
(
StockCode, Quantity, ProductID,ColorID,IMENO,
GodownID,PRate,Status,SRate,CRSalesRate3Month,CreditSRate,CRSalesRate12Month,TransferDetailID,StockID,POrderDetailID
)
(Select 
s.StockCode,t.Quantity, t.ToProductID,t.ToColorID,t.IMEI,
t.ToGodownID,t.PRate,1,t.SRate,t.SRate,t.SRate,t.SRate,t.TDetailID,s.StockID,0
from TransferDetails t
INNER join Stocks s on s.ProductID = t.ToProductID and s.ColorID=t.ToColorID and s.GodownID = t.ToGodownID
WHERE t.TransferID = @TransferID
)

--INSERT INTO StockDetails
--(
--StockCode, Quantity, ProductID,ColorID,IMENO,
--GodownID,PRate,Status,SRate,CRSalesRate3Month,CreditSRate,CRSalesRate12Month,TransferDetailID,StockID,POrderDetailID
--)
--(Select 
--t.StockCode,t.Quantity, t.ToProductID,t.ToColorID,t.IMEI,
--t.ToGodownID,t.UnitPrice,1,t.SRate,t.SRate,t.SRate,t.SRate,td.TDetailID,s.StockID,0
--from @dtTransferDetails t 
--INNER join Stocks s on s.ProductID = t.ToProductID and s.ColorID=t.ToColorID and s.GodownID = t.ToGodownID
--INNER join TransferDetails td on t.ToProductID=td.ToProductID and t.ToColorID=td.ToColorID and t.ToGodownID = td.ToGodownID and td.TransferID=@TransferID and t.IMEI=td.IMEI
--)

--********************Increase To Godown Stocks******************
COMMIT

set @ReturnResult= 1;
set @ReturnTransferID= @TransferID;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		set @ReturnResult= 0;
        set @ReturnTransferID= 0;
END CATCH

--------------------------------------------------------------------------------------------------------------------------


ALTER PROCEDURE [dbo].[AddCreditSalesOrder] (
@CSalesOrder [dbo].[INSERTCREDITSALESORDERTABLE] readonly, 
@CSODetails [INSERTCSODETAILTABLE] readonly,
@CSSchedules [INSERTCSSCHEDULESTABLE] readonly,
@BankTrans [InsertBankTransTable] readonly,
@SorderID int out,
@Result int Out)
AS
DECLARE @CreditSalesId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY  
 BEGIN TRANSACTION 

-----------------Card Payment Bank Deposit--------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @CSalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

------------------Card Payment Bank Deposit--------------

INSERT INTO creditsales (invoiceno, customerid, tsalesamt, noofinstallment,
 intallmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamt, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress, ProcessingFee)
(SELECT
 invoiceno, customerid, tsalesamt, noofinstallment, 
 installmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamount, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,@BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress, ProcessingFee FROM @CSalesOrder)

UPDATE customers
SET customers.CreditDue = (customers.CreditDue + s.totaldue)
FROM @CSalesOrder s
INNER JOIN customers ON customers.customerid = s.customerid

SET @CreditSalesId = Scope_identity()

INSERT INTO CreditSaleDetails 
( 
ProductID ,UnitPrice, Quantity, UTAmount, CreditSalesID,  
MPRateTotal, MPRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,Compressor,Motor,
Panel,Spareparts,Service, Warranty
) 
( 
Select sd.ProductID ,UnitPrice, Quantity, UTAmount, @CreditSalesId CreditSalesID,  
MPRateTotal, MrpRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,p.CompressorWarrentyMonth,p.MotorWarrentyMonth,
p.PanelWarrentyMonth,p.SparePartsWarrentyMonth,p.ServiceWarrentyMonth, sd.Warranty from @CSODetails sd
join Products p on sd.ProductID=p.ProductID 
where p.ProductType!=2
) 

INSERT INTO dbo.CreditInterestHistories(InterestDate, InterestAmount, HireSaleId, IsFirstTime)
(
	SELECT salesdate, interestamount, @CreditSalesId, 1 FROM @CSalesOrder
)


	--Stock Update 
	CREATE TABLE #tmpStock (
		ProductID INT,
		ColorID INT,
		GodownID INT,
		Qty DECIMAL(18, 2)
		)

	INSERT INTO #tmpStock (
		ProductID,
		ColorID,
		GodownID,
		Qty
		) (
		SELECT s.ProductId,
		s.ColorId,
		s.Compressor,
		SUM(s.Quantity) FROM @CSODetails s 
		GROUP BY s.ProductId,
		s.ColorId,
		s.Compressor
		)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st
		ON st.ProductID = sod.ProductID AND st.ColorID = sod.ColorID AND st.GodownID = sod.GodownID

--UPDATE stocks
--SET stocks.quantity = (stocks.quantity - s.quantity)
--FROM @CSODetails s
--INNER JOIN stocks ON stocks.productid = s.productid AND stocks.colorid = s.colorid AND Stocks.GodownID=s.Compressor

UPDATE StockDetails 
SET StockDetails.Status = 2 
from @CSODetails s 
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId 
join Products on StockDetails.ProductID = Products.ProductID 
where Products.ProductType!=2 and IsDamage = 0

--***************FIFO for Nobarcode Product**********************
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @CreditSaleProductsID INT
DECLARE @Quantity INT
DECLARE @SQty INT
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL
FOR
SELECT s.productid, s.colorid, s.quantity, creditsalesdetailsid
-- from   InsertCSODetailTable SOD join CreditSales SO on SO.CreditSalesID=SOD.CreditSalesID where SO.Status=1
FROM @CSODetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.stockdetailid
INNER JOIN products ON stockdetails.productid = products.productid
where Products.ProductType=2 
OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID

WHILE @@FETCH_STATUS = 0
BEGIN
	WHILE @Quantity != 0
	BEGIN
		SET @SDetailID = (
				SELECT Min(sdetailid)
				FROM stockdetails
				WHERE productid = @ProductID AND colorid = @ColorID AND quantity != 0 AND STATUS = 1 and IsDamage = 0
				)
		SET @SQty = (
				SELECT quantity
				FROM stockdetails
				WHERE sdetailid = @SDetailID
				)

		IF (@SQty > @Quantity)
		BEGIN
			SET @SQty = @SQty - @Quantity

			UPDATE stockdetails
			SET quantity = @SQty
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service, Warranty)
			 (SELECT sd.productid, unitprice, @Quantity,((unitprice * @Quantity) + inttotalamt), @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID  =@CreditSaleProductsID
			SET @Quantity = 0
		END
		ELSE IF (@SQty < @Quantity)
		BEGIN
			SET @Quantity = @Quantity - @SQty

			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service, Warranty)
			(SELECT sd.productid, unitprice, @SQty, ((unitprice * @SQty) + inttotalamt), @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)
				--update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
		END
		ELSE
		BEGIN
			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (
			productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate,
			 stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service,Warranty
			 ) 
			 (SELECT 
			  sd.productid, unitprice, @SQty, ((unitprice * @SQty) + inttotalamt), @CreditSalesId CreditSalesID, mpratetotal, mrprate,
			  @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, 
			  p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd 
			  INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID
			  )

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
			SET @Quantity = 0
		END
	END

	FETCH NEXT
	FROM cur
	INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID
END

INSERT INTO creditsalesschedules (monthdate, balance, installmentamt, 
paymentdate, creditsalesid, paymentstatus, interestamount, closingbalance,
 scheduleno, remarks, isunexpected, hirevalue, netvalue)
(SELECT monthdate, balance, installmentamt,
 paymentdate, @CreditSalesId CreditSalesID, paymentstatus, interestamount, closingbalance,
  scheduleno, remarks, isunexpected, hirevalue, netvalue FROM @CSSchedules)

COMMIT
--RETURN 1;
SELECT @SorderID=@CreditSalesId,@Result=1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		--RETURN 0;
	SELECT @SorderID=0,@Result=0
END CATCH


--------------------------------------------------------------------------------------------------------------------------



ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = s.TSQty,
		ActionStatus = ActionStatus + 1
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	Create Table #tmpStock3(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)



	--Stock out
	delete #tmpStock

 --   INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	--(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	--where  s.Status = 3 OR s.Status = 4
	--group by s.ProductId,s.ColorId,s.Compressor
	--)

	--DECLARE @prevQty DECIMAL(18,2) = (SELECT ISNULL(SUM(s.Quantity), 0) FROM @SODetails s
	--INNER JOIN Products P On s.ProductId = p.ProductID
	--WHERE s.Status = 4 AND p.ProductType !=2)

	--UPDATE st
	--SET st.Quantity = ((st.Quantity - sod.Qty) + @prevQty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	--FROM #tmpStock sod
	--INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--INNER JOIN Products p ON p.ProductID = st.ProductID
	--where p.ProductType !=2

	--UPDATE st
	--SET st.Quantity = ((st.Quantity - sod.Qty)),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	--FROM #tmpStock sod
	--INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--INNER JOIN Products p ON p.ProductID = st.ProductID
	--where p.ProductType =2

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	JOIN Products p on s.ProductID=p.ProductID 
	where s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	INSERT INTO #tmpStock3(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty + sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType !=2

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock3 sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType !=2

	UPDATE st
	SET st.Quantity = ((st.Quantity - sod.Qty)),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType =2

	UPDATE st
	SET st.Quantity = ((st.Quantity - sod.Qty)),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock3 sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType =2

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2 and IsDamage = 0



	
-- For No barcode Stock Details out and SOrderDetails Insert
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @GodownID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @SOrderDetailID INT
DECLARE @Quantity decimal(18,2)
DECLARE @StockQty decimal(18,2)
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL FOR
SELECT s.ProductId,
       s.colorid,
       s.Compressor,
       s.quantity,
       sorderdetailid
FROM @SODetails s
JOIN products ON products.productid = s.productid
WHERE products.ProductType = 2 AND s.Status = 3

OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID,
     @ColorID,
     @GodownID,
     @Quantity,
     @SOrderDetailID

WHILE @@FETCH_STATUS = 0
BEGIN
    WHILE (@Quantity != 0)
    BEGIN
        -- Get the first available stock detail
        SET @SDetailID = (
            SELECT MIN(SDetailID)
            FROM stockdetails
            WHERE productid = @ProductID AND colorid = @ColorID
            AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1 and IsDamage = 0
        )

        -- Get the stock quantity
        SET @StockQty = (
            SELECT quantity
            FROM stockdetails
            WHERE sdetailid = @SDetailID
        )

        IF (@StockQty > @Quantity)
        BEGIN
            -- If stock quantity is greater than the order quantity
            SET @StockQty = @StockQty - @Quantity

            -- Update stock details
            UPDATE stockdetails
            SET quantity = @StockQty
            WHERE sdetailid = @SDetailID			

            -- Insert into order details
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
        ELSE IF (@StockQty < @Quantity)
        BEGIN
            -- If stock quantity is less than order quantity
            SET @Quantity = @Quantity - @StockQty

            -- Update stock to 0 and change status to 2 (unavailable)
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

			
            -- Insert into order details for partial quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @StockQty,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @StockQty,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3
        END
        ELSE
        BEGIN
            -- If stock quantity equals the order quantity, mark as processed
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

            -- Insert the order detail for the exact quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
    END

    FETCH NEXT
    FROM cur
    INTO @ProductID,
         @ColorID,
         @GodownID,
         @Quantity,
         @SOrderDetailID
END

CLOSE cur
DEALLOCATE cur


	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId



	--***************************************
	--SR visit Update**************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0
	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT so.InvoiceDate,
		so.invoiceno,
		so.customerid,
		so.vatpercentage,
		so.vatamount,
		so.grandtotal,
		so.TDPercentage,
		so.TDAmount,
		so.netdiscount,
		so.totalamount,
		so.paymentdue,
		so.RecAmount,
		so.adjamount,
		so.totaldue,
		so.STATUS,
		so.concernid,
		so.createdby,
		so.createdate,
		so.totaloffer,
		so.Remarks,
		so.TramsAndCondition,
		so.CardTypeSetupID,
		so.CardPaidAmount,
		so.DepositChargePercent,
		so.BankTransID,
		so.TSQty,
		so.PrevDue,
		so.ActionStatus,
		so.SOrderID
		FROM SOrders so
		INNER JOIN SOrders s on so.SOrderID = s.SOrderID AND s.SOrderID =  @SalesOrderId
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH

--------------------------------------------------------------------------------------------------------------------------


ALTER PROCEDURE [dbo].[AddSalesOrder] (
	@SalesOrder [INSERTSALESORDERTABLE] readonly,
	@SODetails [INSERTSODETAILTABLE] readonly,
	@RemindDate DATE,
	@BankTrans [InsertBankTransTable] readonly,
	@SorderID int out,
	@Result int Out
	)
AS
DECLARE @SalesOrderId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY
	BEGIN TRANSACTION

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @SalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	INSERT INTO sorders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID,
		TSQty,
		PrevDue,
		1 FROM @SalesOrder
		)

	SET @SalesOrderId = Scope_identity()

	INSERT INTO SOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		Warranty
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.TAmount,
		SOD.PPDisPer,
		SOD.PPDisAmt,
		SOD.MrpRate,
		@SalesOrderId SOrderID,
		SOD.StockDetailId,
		SOD.PPOffer,
		(SOD.UnitPrice - SOD.PPDisAmt),
		STD.PRate,
		p.CompressorWarrentyMonth,
		p.PanelWarrentyMonth,
		p.MotorWarrentyMonth,
		p.SparePartsWarrentyMonth,
		p.ServiceWarrentyMonth,
		SOD.Warranty FROM @SODetails SOD INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailId INNER JOIN Products p
		ON STD.ProductID = p.ProductID WHERE P.ProductType = 1 OR p.ProductType = 3
		)

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue),
		reminddate = @RemindDate
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NOT NULL

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue)
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NULL

	--Stock Update 
	CREATE TABLE #tmpStock (
		ProductID INT,
		ColorID INT,
		GodownID INT,
		Qty DECIMAL(18, 2)
		)

	INSERT INTO #tmpStock (
		ProductID,
		ColorID,
		GodownID,
		Qty
		) (
		SELECT s.ProductID,
		s.ColorID,
		s.Compressor,
		SUM(s.Quantity) FROM @SODetails s 
		GROUP BY s.ProductId,
		s.ColorId,
		s.Compressor
		)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st
		ON st.ProductID = sod.ProductID AND st.ColorID = sod.ColorID AND st.GodownID = sod.GodownID

	--For barCode Product 
	UPDATE stockdetails
	SET stockdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN stockdetails
		ON stockdetails.sdetailid = s.stockdetailid
	INNER JOIN products
		ON stockdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3 and IsDamage = 0

	--*****************FIFO for Nobarcode************************** 
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @GodownID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity INT
	DECLARE @SQty INT
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.productid,
		colorid,
		s.Compressor,
		quantity,
		sorderdetailid
	FROM @SODetails s
	INNER JOIN products
		ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity != 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1 and IsDamage = 0
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)

			IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity

				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					SOD.Warranty FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.Compressor=@GodownID AND SOD.colorid = @ColorID
					)

				SET @Quantity = 0
			END
			ELSE IF (@SQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @SQty

				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@SQty,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @SQty),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					SOD.Warranty FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					SOD.Warranty FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

	--For barCode Product SRVisit Status update 
	UPDATE srvproductdetails
	SET srvproductdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN srvproductdetails
		ON srvproductdetails.sdetailid = s.stockdetailid AND srvproductdetails.STATUS = 1
	INNER JOIN products
		ON srvproductdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3


	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID,
		TSQty,
		PrevDue,
		1,
		@SalesOrderId FROM @SalesOrder
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT CreatedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT CreateDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	SELECT @SorderID=@SalesOrderId,@Result=1;
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	SELECT @SorderID=0,@Result=0
END CATCH

--------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[sp_AddReturnPurchaseOrder]
(
	@PurchaseOrder [InsertPurchaseOrderTable] readonly,
	@PODetails [InsertPODetailTable] readonly,
	@POProductDetails [InsertReturnPOProductDetailTable] readonly,
	@Result INT OUTPUT,
	@OutPOrderID INT OUTPUT
)
  
AS 
DECLARE @PurchaseOrderId int

BEGIN TRY  
 BEGIN TRANSACTION 
  
INSERT INTO POrders
(
OrderDate, ChallanNo, SupplierID, GrandTotal, TDiscount, TotalAmt, AdjAmount, RecAmt, PaymentDue, TotalDue,
Status, PPDisAmt, NetDiscount, LaborCost, ConcernID, CreateDate, CreatedBy,IsDamageOrder,Remarks
)
(
Select OrderDate, ChallanNo, SupplierID, GrandTotal, TDiscount, TotalAmt, AdjAmount, RecAmt, PaymentDue, TotalDue,
Status, PPTDisAmt, NetDiscount, LabourCost, ConcernID, CreateDate, CreatedBy,IsDamageOrder, Remarks from @PurchaseOrder)

UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - p.PaymentDue)
from @PurchaseOrder p
JOIN Suppliers ON Suppliers.SupplierID = p.SupplierId
where p.IsDamageOrder!=1

SET @PurchaseOrderId = SCOPE_IDENTITY()


INSERT INTO POrderDetails
(
ProductID, ColorID, Quantity, UnitPrice, TAmount, PPDISPer, PPDISAmt, MRPRate, POrderID,SalesRate,ExtraPPDISPer,ExtraPPDISAmt,PPOFFER,CreditSalesRate,GodownID
)
(
Select ProductId, ColorId, Quantity, UnitPrice, TAmount,  PPDisPer,
PPDisAmt, MrpRate, @PurchaseOrderId POrderID,SalesRate,ExtraPPDISPer,ExtraPPDISAmt,PPOffer,CreditSalesRate,GodownId  from @PODetails)

INSERT INTO POProductDetails
(
ProductID, ColorID, IMENO, POrderDetailID,ReturnSDetailID,ReturnQty
)
(
Select POPD.ProductId, POPD.ColorId, POPD.IMENo, POD.POrderDetailID,POPD.ReturnSDetailID,POPD.ReturnQty from @POProductDetails POPD
INNER JOIN POrderDetails POD ON POD.ProductID = POPD.ProductId AND POD.ColorID = POPD.ColorId AND POD.POrderID = @PurchaseOrderId
)

-----------------------------Delete IMEI----------------------------------
declare @POrderID int
declare @SupplierID int
declare @ProductID int
declare @ColorID int
declare @ProductType int
declare @StockID int
declare @SDetailID int
declare @POrderDetailID int
declare @TotalDue decimal(18,2)
declare @GrandTotal decimal(18,2)
declare @TotalAmount decimal(18,2)
declare @NetDiscount decimal(18,2)
declare @PPDISAmt decimal(18,2)
declare @PaymentDue decimal(18,2)
declare @MRPRate decimal(18,2)
declare @UnitPrice decimal(18,2)
declare @PPDISPer decimal(18,2)
declare @IMEI varchar(300)
declare @POPDID int
declare @Quantity decimal(18,2)

declare cur CURSOR LOCAL 
for  select  sd.StockID,SDetailID,POrderDetailID,sd.ProductID,sd.IMENO,st.ReturnQty,p.ProductType,sd.ColorID
     from @POProductDetails st
     join StockDetails sd on st.ReturnSDetailID =sd.SDetailID
	 join Products p on sd.ProductID = p.ProductID
     where sd.Status=1 and sd.IsDamage = 0
open cur
         fetch next from cur into @StockID,@SDetailID,@POrderDetailID,@ProductID,@IMEI,@Quantity,@ProductType,@ColorID
         
while @@FETCH_STATUS = 0
BEGIN


----Update stock Start
update Stocks set Quantity=Quantity-@Quantity where StockID=@StockID

IF(@ProductType=2)
BEGIN
update StockDetails set Quantity=Quantity-@Quantity where SDetailID=@SDetailID
update StockDetails set Status=3 where SDetailID=@SDetailID and Quantity=0
END
ELSE
update StockDetails set Status=3 where SDetailID=@SDetailID

delete [dbo].[SRVProductDetails] where SDetailID=@SDetailID


  fetch next from cur into @StockID,@SDetailID,@POrderDetailID,@ProductID,@IMEI,@Quantity,@ProductType,@ColorID
END


COMMIT

SET @Result=1
SET @OutPOrderID=@PurchaseOrderId

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

	SET @Result=0
    SET @OutPOrderID=0

END CATCH

--------------------------------------------------------------------------------------------------------------------------


CREATE PROC [dbo].[sp_AddDamageReturnPurchaseOrder]
(
	@PurchaseOrder [InsertPurchaseOrderTable] readonly,
	@PODetails [InsertPODetailTable] readonly,
	@POProductDetails [InsertReturnPOProductDetailTable] readonly,
	@Result INT OUTPUT,
	@OutPOrderID INT OUTPUT
)
  
AS 
DECLARE @PurchaseOrderId int

BEGIN TRY  
 BEGIN TRANSACTION 
  
INSERT INTO POrders
(
OrderDate, ChallanNo, SupplierID, GrandTotal, TDiscount, TotalAmt, AdjAmount, RecAmt, PaymentDue, TotalDue,
Status, PPDisAmt, NetDiscount, LaborCost, ConcernID, CreateDate, CreatedBy,IsDamageOrder,Remarks
)
(
Select OrderDate, ChallanNo, SupplierID, GrandTotal, TDiscount, TotalAmt, AdjAmount, RecAmt, PaymentDue, TotalDue,
Status, PPTDisAmt, NetDiscount, LabourCost, ConcernID, CreateDate, CreatedBy,IsDamageOrder, Remarks from @PurchaseOrder)

UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - p.PaymentDue)
from @PurchaseOrder p
JOIN Suppliers ON Suppliers.SupplierID = p.SupplierId
where p.IsDamageOrder!=1

SET @PurchaseOrderId = SCOPE_IDENTITY()


INSERT INTO POrderDetails
(
ProductID, ColorID, Quantity, UnitPrice, TAmount, PPDISPer, PPDISAmt, MRPRate, POrderID,SalesRate,ExtraPPDISPer,ExtraPPDISAmt,PPOFFER,CreditSalesRate,GodownID
)
(
Select ProductId, ColorId, Quantity, UnitPrice, TAmount,  PPDisPer,
PPDisAmt, MrpRate, @PurchaseOrderId POrderID,SalesRate,ExtraPPDISPer,ExtraPPDISAmt,PPOffer,CreditSalesRate,GodownId  from @PODetails)

INSERT INTO POProductDetails
(
ProductID, ColorID, IMENO, POrderDetailID,ReturnSDetailID,ReturnQty
)
(
Select POPD.ProductId, POPD.ColorId, POPD.IMENo, POD.POrderDetailID,POPD.ReturnSDetailID,POPD.ReturnQty from @POProductDetails POPD
INNER JOIN POrderDetails POD ON POD.ProductID = POPD.ProductId AND POD.ColorID = POPD.ColorId AND POD.POrderID = @PurchaseOrderId
)

-----------------------------Delete IMEI----------------------------------
declare @POrderID int
declare @SupplierID int
declare @ProductID int
declare @ColorID int
declare @ProductType int
declare @StockID int
declare @SDetailID int
declare @POrderDetailID int
declare @TotalDue decimal(18,2)
declare @GrandTotal decimal(18,2)
declare @TotalAmount decimal(18,2)
declare @NetDiscount decimal(18,2)
declare @PPDISAmt decimal(18,2)
declare @PaymentDue decimal(18,2)
declare @MRPRate decimal(18,2)
declare @UnitPrice decimal(18,2)
declare @PPDISPer decimal(18,2)
declare @IMEI varchar(300)
declare @POPDID int
declare @Quantity decimal(18,2)

declare cur CURSOR LOCAL 
for  select  sd.StockID,SDetailID,POrderDetailID,sd.ProductID,sd.IMENO,st.ReturnQty,p.ProductType,sd.ColorID
     from @POProductDetails st
     join StockDetails sd on st.ReturnSDetailID =sd.SDetailID
	 join Products p on sd.ProductID = p.ProductID
     where sd.Status=1 and sd.IsDamage = 1
open cur
         fetch next from cur into @StockID,@SDetailID,@POrderDetailID,@ProductID,@IMEI,@Quantity,@ProductType,@ColorID
         
while @@FETCH_STATUS = 0
BEGIN


----Update stock Start
update Stocks set Quantity=Quantity-@Quantity where StockID=@StockID

IF(@ProductType=2)
BEGIN
update StockDetails set Quantity=Quantity-@Quantity where SDetailID=@SDetailID
update StockDetails set Status=3 where SDetailID=@SDetailID and Quantity=0
END
ELSE
update StockDetails set Status=3 where SDetailID=@SDetailID

delete [dbo].[SRVProductDetails] where SDetailID=@SDetailID


  fetch next from cur into @StockID,@SDetailID,@POrderDetailID,@ProductID,@IMEI,@Quantity,@ProductType,@ColorID
END


COMMIT

SET @Result=1
SET @OutPOrderID=@PurchaseOrderId

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

	SET @Result=0
    SET @OutPOrderID=0

END CATCH

----------COMMONSOURCE----------
-------------Nahid--------------
----------19-04-2025------------


ALTER PROC [dbo].[sp_AddReplacementOrder]
(
    @SalesOrder [InsertReplaceOrderTable] readonly,
    @SODetails [InsertRODetailTable] readonly
)
AS
DECLARE @SalesOrderId INT;
DECLARE @ProductType INT;
DECLARE @Quantity DECIMAL(18, 2);
DECLARE @StockDetailId INT;

BEGIN TRY
    BEGIN TRANSACTION;

    -- Insert into SOrders
    INSERT INTO SOrders
    (
        InvoiceDate, InvoiceNo, CustomerID, VATPercentage, VATAmount, GrandTotal, TDPercentage, TDAmount, NetDiscount,
        TotalAmount, PaymentDue, RecAmount, AdjAmount, TotalDue, Status, ConcernID, CreatedBy, CreateDate, TotalOffer, IsReplacement
    )
    SELECT InvoiceDate, InvoiceNo, CustomerID, VATPercentage, VATAmount, GrandTotal, TDiscountPercentage, TDiscountAmount, NetDiscount,
           TotalAmount, PaymentDue, RecAmt, AdjAmount, TotalDue, Status, ConcernID, CreatedBy, CreateDate, TotalOffer, IsReplacement
    FROM @SalesOrder;

    -- Update Customer's TotalDue
    UPDATE Customers
    SET Customers.TotalDue = (Customers.TotalDue + s.TotalDue)
    FROM @SalesOrder s
    JOIN Customers ON Customers.CustomerID = s.CustomerID;

    -- Capture the new SalesOrderId
    SET @SalesOrderId = SCOPE_IDENTITY();

    -- Update SOrderDetails with the new values
    UPDATE SOrderDetails
    SET RStockDetailId = s.RStockDetailId,
        RepOrderID = @SalesOrderId,
        RepUnitPrice = s.UnitPrice,
        Remarks = s.Remarks,
        RQuantity = (RQuantity + s.Quantity),
        ReplaceProductType = s.IsDamage
    FROM @SODetails s
    JOIN SOrderDetails SOD ON SOD.SDetailID = s.StockDetailId
    JOIN SOrders SO ON SOD.SOrderID = SO.SOrderID
    WHERE SOD.SDetailId IN (SELECT StockDetailId FROM @SODetails)
      AND SO.Status != 4
      AND SOD.IsProductReturn != 1 AND sod.SOrderDetailID = s.dSOrderDetailID;

    -- Insert new SOrderDetails
    INSERT INTO SOrderDetails
    (
        ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, PPDAmount, MPRate, SOrderID, SDetailID, PPOffer, Remarks
    )
    SELECT ProductId, Quantity, UnitPrice, TAmount, PPDisPer, PPDisAmt, MrpRate, @SalesOrderId SOrderID, RStockDetailId, PPOffer, Remarks
    FROM @SODetails;

    -- Stock Decrease for New Product
    UPDATE Stocks
    SET Stocks.Quantity = (Stocks.Quantity - s.Quantity)
    FROM @SODetails s
    JOIN Stocks ON Stocks.ProductID = s.ProductId AND Stocks.ColorID = s.ColorId;

UPDATE StockDetails
SET StockDetails.Status = 2
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.RStockDetailId
INNER JOIN Products ON Products.ProductID = StockDetails.ProductID
WHERE Products.ProductType !=2

UPDATE StockDetails
SET StockDetails.Quantity = (StockDetails.Quantity - s.Quantity)
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.RStockDetailId
INNER JOIN Products ON Products.ProductID = StockDetails.ProductID
WHERE Products.ProductType = 2

UPDATE StockDetails
SET StockDetails.Status = 2
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.RStockDetailId
INNER JOIN Products ON Products.ProductID = StockDetails.ProductID
WHERE Products.ProductType = 2 AND StockDetails.Quantity = 0





    --**************************************************************
    --*********************not damage*******************************
    UPDATE Stocks
    SET Stocks.Quantity = (Stocks.Quantity + s.Quantity)
    FROM @SODetails s
    JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
    JOIN Stocks ON Stocks.StockID = StockDetails.StockID
    WHERE s.IsDamage = 2;

    UPDATE StockDetails
    SET StockDetails.Quantity = (StockDetails.Quantity + s.Quantity), StockDetails.Status = 1
    FROM @SODetails s
    JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
    WHERE s.IsDamage = 2;

    --**************************************************************
    --*********************damage***********************************
    -- Cursor to handle damaged products
    DECLARE cur_damaged CURSOR LOCAL FOR
    SELECT p.ProductType, s.Quantity, s.StockDetailId
    FROM @SODetails s
    JOIN Products p ON s.ProductId = p.ProductID
    WHERE s.IsDamage = 1;

    OPEN cur_damaged;

    FETCH NEXT FROM cur_damaged INTO @ProductType, @Quantity, @StockDetailId;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        IF (@ProductType = 2) -- No Barcode Product
        BEGIN
            -- Insert a new row with Status = 4 for the damaged product
            INSERT INTO StockDetails
            (
                StockCode, ProductID, IMENO, StockID, Status, ColorID, POrderDetailID, PRate, SRate, CreditSRate, 
                CRSalesRate12Month, CRSalesRate3Month, Quantity, GodownID, TransferDetailID, UsedStockStatus, UsedSaleRate, UsedPurchaseRate, IsDamage
            )
            SELECT StockCode, ProductID, IMENO, StockID, 1, ColorID, POrderDetailID, PRate, SRate, CreditSRate, 
                   CRSalesRate12Month, CRSalesRate3Month, @Quantity, GodownID, TransferDetailID, UsedStockStatus, UsedSaleRate, UsedPurchaseRate, 1
            FROM StockDetails
            WHERE SDetailID = @StockDetailId;

           
        END
        ELSE
        BEGIN
            -- For other product types, just update the status to 4
            UPDATE StockDetails
            SET StockDetails.Status = 1, IsDamage = 1
            WHERE StockDetails.SDetailID = @StockDetailId;
        END;

        FETCH NEXT FROM cur_damaged INTO @ProductType, @Quantity, @StockDetailId;
    END;

    -- Close and deallocate cursor
    CLOSE cur_damaged;
    DEALLOCATE cur_damaged;

    -- Update the status in SRVProductDetails for damaged products
    UPDATE SRVProductDetails
    SET SRVProductDetails.Status = 2
    FROM @SODetails s
    JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.RStockDetailId
    WHERE SRVProductDetails.Status = 1;

    COMMIT

    RETURN 1;

END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK

    RETURN 0;
END CATCH


----------COMMONSOURCE----------
-------------Nahid--------------
----------16-04-2025------------

CREATE view [dbo].[vw_DateWiseProductPicker] as

Select P.Code'ProductCode',P.ProductName,G.Name'GodownName', CL.Name'ColorName', CA.Description'CategoryName', SD.IMENO,
SD.SRate'MRPRate',P.ConcernID,P.ProductID,S.ColorID,S.GodownID,P.CategoryID,P.CompanyID,SD.SDetailID'StockDetailsId',
S.StockID,CM.Name'CompanyName', SD.PRate'PRate',SD.Quantity'PreStock', p.ProductType, p.ServiceWarrentyMonth'Service',
PO.OrderDate'OrderDate'
From Products P
Inner Join Companies CM on CM.CompanyID=P.CompanyID and P.ConcernID=CM.ConcernID
Inner Join Categorys CA on CA.CategoryID=P.CategoryID and CA.ConcernID=P.ConcernID
Inner Join StockDetails SD on SD.ProductID=P.ProductID
Inner join Stocks S on S.StockID = SD.StockID and P.ConcernID = S.ConcernID
Inner Join Godowns G on SD.GodownID = G.GodownID and G.ConcernID = S.ConcernID
Inner Join Colors CL on CL.ColorID = SD.ColorID and CL.ConcernID = S.ConcernID
INNER JOIN POrderDetails POD on POD.POrderDetailID = SD.POrderDetailID
INNER JOIN POrders PO on PO.POrderID = POD.POrderID
where SD.Status=1 AND SD.IsDamage = 0

UNION

Select P.Code'ProductCode',P.ProductName,G.Name'GodownName', CL.Name'ColorName', CA.Description'CategoryName', SD.IMENO,
SD.SRate'MRPRate',P.ConcernID,P.ProductID,S.ColorID,S.GodownID,P.CategoryID,P.CompanyID,SD.SDetailID'StockDetailsId',
S.StockID,CM.Name'CompanyName', SD.PRate'PRate',SD.Quantity'PreStock', p.ProductType, p.ServiceWarrentyMonth'Service',
T.TransferDate'OrderDate'
From Products P
Inner Join Companies CM on CM.CompanyID=P.CompanyID and P.ConcernID=CM.ConcernID
Inner Join Categorys CA on CA.CategoryID=P.CategoryID and CA.ConcernID=P.ConcernID
Inner Join StockDetails SD on SD.ProductID=P.ProductID
Inner join Stocks S on S.StockID = SD.StockID and P.ConcernID = S.ConcernID
Inner Join Godowns G on SD.GodownID = G.GodownID and G.ConcernID = S.ConcernID
Inner Join Colors CL on CL.ColorID = SD.ColorID and CL.ConcernID = S.ConcernID
INNER JOIN TransferDetails TD on TD.TDetailID = SD.TransferDetailID
INNER JOIN Transfers T on T.TransferID = TD.TransferID
where SD.Status=1 AND SD.IsDamage = 0

GO



------------------------------------------------------------------------------------------------------------------


Create PROCEDURE [dbo].[SP_DateWiseProductPickerInStock] (
	@concernId int
)
AS
	BEGIN
	  Select * from vw_DateWiseProductPicker where ConcernID=@concernId 
	END

------------------------------------------------------------------------------------------------------------------


ALTER TABLE dbo.SystemInformations ADD
	IsDateWiseProductPicker int NOT NULL CONSTRAINT DF_SystemInformations_IsDateWiseProductPicker DEFAULT ((0))
GO



----------COMMONSOURCE----------
-------------Nahid--------------
----------12-04-2025------------


ALTER view [dbo].[vw_ProductPicker] as
Select P.Code'ProductCode',P.ProductName,G.Name'GodownName', CL.Name'ColorName', CA.Description'CategoryName', SD.IMENO, SD.SRate'MRPRate',P.ConcernID,P.ProductID,S.ColorID,S.GodownID,P.CategoryID,P.CompanyID,SD.SDetailID'StockDetailsId',S.StockID,CM.Name'CompanyName', SD.PRate'PRate',SD.Quantity'PreStock', p.ProductType, p.ServiceWarrentyMonth'Service'
From Products P
Inner Join Companies CM on CM.CompanyID=P.CompanyID and P.ConcernID=CM.ConcernID
Inner Join Categorys CA on CA.CategoryID=P.CategoryID and CA.ConcernID=P.ConcernID
Inner Join StockDetails SD on SD.ProductID=P.ProductID
Inner join Stocks S on S.StockID = SD.StockID and P.ConcernID = S.ConcernID
Inner Join Godowns G on SD.GodownID = G.GodownID and G.ConcernID = S.ConcernID
Inner Join Colors CL on CL.ColorID = SD.ColorID and CL.ConcernID = S.ConcernID
where SD.Status=1 AND SD.IsDamage = 0
--and S.ConcernID = 5126 Order By CA.CategoryID
GO




----------COMMONSOURCE----------
-------------Nahid--------------
----------10-04-2025------------

ALTER TABLE dbo.StockDetails ADD
	IsDamage int NOT NULL CONSTRAINT DF_StockDetails_IsDamage DEFAULT ((0))
GO

------------------------------------------------------------------------------------------------------------------


CREATE PROC [dbo].[AddDamagePurchaseOrder] (
	@PurchaseOrder [InsertPurchaseOrderTable] readonly
	,@PODetails [InsertPODetailTable] readonly
	,@POProductDetails [InsertPOProductDetailTable] readonly
	,@Stocks [InsertStockTable] readonly
	,@StockDetails [InsertStockDetailTable] readonly,
	@PorderID int out,
	@Result int Out
	)
AS
DECLARE @PurchaseOrderId INT
DECLARE @GrandTotal DECIMAL(18, 2)
		,@NetDiscount DECIMAL(18, 2)
		,@FlatDis DECIMAL(18, 2)
		,@Adjustment DECIMAL(18, 2)

--***************Product Type*****************
--ExistingBC = 1,
--NoBarcode = 2,
--AutoBC = 3
--***************Product Type*****************

BEGIN TRY
	BEGIN TRANSACTION

	INSERT INTO POrders (
		OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPDisAmt
		,NetDiscount
		,LaborCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,ActionStatus
		,VATPercentage,
		VATAmount
		) (
		SELECT OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPTDisAmt
		,NetDiscount
		,LabourCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,1,
		VatPercentage,
		VatAmount
		 FROM @PurchaseOrder
		)

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue + p.PaymentDue)
	FROM @PurchaseOrder p
	JOIN Suppliers ON Suppliers.SupplierID = p.SupplierId
	WHERE p.IsDamageOrder != 1

	SET @PurchaseOrderId = SCOPE_IDENTITY()
	SET @GrandTotal = ISNULL((
				SELECT GrandTotal
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @NetDiscount = ISNULL((
				SELECT NetDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @FlatDis = ISNULL((
				SELECT TDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
    SET @Adjustment = ISNULL((
				SELECT AdjAmount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)

	INSERT INTO PriceProtections (
		ProductID
		,ColorID
		,PrvPrice
		,ChangePrice
		,POrderID
		,ConcernID
		,SupplierID
		,PrvStockQty
		,PChangeDate
		) (
		SELECT stk.ProductId
		,stk.ColorId
		,stk.MRPPrice
		,stkt.MRPPrice
		,@PurchaseOrderId
		,stk.ConcernID
		,(
			SELECT SupplierId
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,stk.Quantity
		,GETDATE() FROM @Stocks stkt INNER JOIN Stocks stk ON stk.ProductID = stkt.ProductId
		AND stk.ColorID = stkt.ColorId WHERE stk.MRPPrice > stkt.MRPPrice
		)

	INSERT INTO POrderDetails (
		ProductID
		,ColorID
		,Quantity
		,UnitPrice
		,TAmount
		,PPDISPer
		,PPDISAmt
		,MRPRate
		,POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOFFER
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownID
		,DOrderDetailId
		) (
		SELECT ProductId
		,ColorId
		,Quantity
		,UnitPrice
		,TAmount
		,PPDisPer
		,PPDisAmt
		,MrpRate
		,@PurchaseOrderId POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOffer
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownId
		,DOrderDetailId FROM @PODetails
		)

	INSERT INTO POProductDetails (
		ProductID
		,ColorID
		,IMENO
		,POrderDetailID
		,DamagePOPDID
		) (
		SELECT POPD.ProductId
		,POPD.ColorId
		,POPD.IMENo
		,POD.POrderDetailID
		,DamagePOPDID FROM @POProductDetails POPD INNER JOIN POrderDetails POD ON POD.ProductID = POPD.ProductId
		AND POD.ColorID = POPD.ColorId
		AND POD.POrderID = @PurchaseOrderId
		)

	UPDATE POProductDetails
	SET IsDamageReplaced = 1
	FROM @POProductDetails dtPOPD
	JOIN POProductDetails POPD ON dtPOPD.DamagePOPDID = POPD.POPDID

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity + s.Quantity)
		,Stocks.MRPPrice = s.MRPPrice
		,LPPrice = s.LPPrice
		,ModifiedBy = s.CreatedBy
		,ModifiedDate = s.CreateDate
	FROM @Stocks s
	JOIN Stocks ON Stocks.StockID = s.StockID

	INSERT INTO Stocks (
		StockCode
		,EntryDate
		,Quantity
		,ProductID
		,ColorID
		,MRPPrice
		,LPPrice
		,ConcernID
		,CreatedBy
		,CreateDate
		,GodownID
		) (
		SELECT StockCode
		,EntryDate
		,Quantity
		,ProductId
		,ColorId
		,MRPPrice
		,LPPrice
		,ConcernId
		,CreatedBy
		,CreateDate
		,GodownId FROM @Stocks WHERE StockId IS NULL
		)

	--************For Nobarcode*****************
	INSERT INTO StockDetails (
		StockID
		,StockCode
		,ProductID
		,ColorID
		,POrderDetailID
		,IMENO
		,STATUS
		,PRate
		,SRate
		,CreditSRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,Quantity
		,GodownID,
		IsDamage
		) (
		SELECT stk.StockID
		,stkd.StockCode
		,stkd.ProductId
		,stkd.ColorId
		,POD.POrderDetailID
		,stkd.IMENo
		,stkd.STATUS
		,(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment))))
		,stkd.SalesRate
		,stkd.CreditSRate
		,POD.CRSalesRate12Month
		,POD.CRSalesRate3Month
		,POD.Quantity
		,stkd.GodownId,
		1 
		FROM @StockDetails stkd INNER JOIN Stocks stk ON stk.ProductID = stkd.ProductId
		AND stk.ColorID = stkd.ColorID
		AND stk.GodownID = stkd.GodownId INNER JOIN POrderDetails POD ON POD.ProductID = stkd.ProductId
		AND POD.ColorID = stkd.ColorId
		AND POD.GodownID = stkd.GodownID
		AND POD.POrderID = @PurchaseOrderId INNER JOIN Products P ON P.ProductID = stk.ProductID WHERE P.ProductType = 2
		)

	--************For Nobarcode*****************
	--************For barcode*******************
	INSERT INTO StockDetails (
		StockID
		,StockCode
		,ProductID
		,ColorID
		,POrderDetailID
		,IMENO
		,STATUS
		,PRate
		,SRate
		,CreditSRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,Quantity
		,GodownID,
		IsDamage
		) (
		SELECT stk.StockID
		,stkd.StockCode
		,stkd.ProductId
		,stkd.ColorId
		,POD.POrderDetailID
		,stkd.IMENo
		,stkd.STATUS
		,(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment))))
		,stkd.SalesRate
		,stkd.CreditSRate
		,POD.CRSalesRate12Month
		,POD.CRSalesRate3Month
		,0
		,stkd.GodownId,
		1
		FROM @StockDetails stkd INNER JOIN Stocks stk ON stk.ProductID = stkd.ProductId
		AND stk.ColorID = stkd.ColorID
		AND stk.GodownID = stkd.GodownId INNER JOIN POrderDetails POD ON POD.ProductID = stkd.ProductId
		AND POD.ColorID = stkd.ColorId
		AND POD.GodownID = stkd.GodownId
		AND POD.POrderID = @PurchaseOrderId INNER JOIN Products P ON P.ProductID = stk.ProductID WHERE P.ProductType != 2
		)


	INSERT INTO TransactionPOrders (
		OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPDisAmt
		,NetDiscount
		,LaborCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,ActionStatus
		,POrderID
		) (
		SELECT OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPTDisAmt
		,NetDiscount
		,LabourCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,1
		,@PurchaseOrderId
		 FROM @PurchaseOrder
		)
	INSERT INTO TransactionPOrderDetails (
		ProductID
		,ColorID
		,Quantity
		,UnitPrice
		,TAmount
		,PPDISPer
		,PPDISAmt
		,MRPRate
		,POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOFFER
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownID
		,ActionStatus
		,ActionBy
		,ActionDate
		) (
		SELECT ProductId
		,ColorId
		,Quantity
		,UnitPrice
		,TAmount
		,PPDisPer
		,PPDisAmt
		,MrpRate
		,@PurchaseOrderId POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOffer
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownId
		,1
		,(
			SELECT CreatedBy
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,(
			SELECT CreateDate
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		FROM @PODetails
		)


	---**************Update DO**********************
  update do set GivenQty = GivenQty+sd.Quantity
	  from @PODetails sd 
	  join DODetails do on sd.ProductId = do.ProductID
	  where sd.DOrderDetailId = do.DODID

	--************For barcode*******************
	COMMIT
	SELECT @PorderID=@PurchaseOrderId,@Result=1;
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		ROLLBACK

	SELECT @PorderID=0,@Result=0
	--RETURN 0;
END CATCH
GO



------------------------------------------------------------------------------------------------------------------


CREATE PROCEDURE [dbo].[UpdateDamagePurchaseOrder] (
	@PurchaseOrderId INT,
	@PurchaseOrder [InsertPurchaseOrderTable] readonly,
	@PODetails [InsertPODetailTable] readonly,
	@POProductDetails [InsertPOProductDetailTable] readonly,
	@Stocks [InsertStockTable] readonly,
	@StockDetails [InsertStockDetailTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

Declare @TPQty decimal(18,2)
DECLARE @GrandTotal DECIMAL(18, 2)
		,@NetDiscount DECIMAL(18, 2)
		,@FlatDis DECIMAL(18, 2)
		,@Adjustment DECIMAL(18, 2)

	SET @GrandTotal = ISNULL((
				SELECT GrandTotal
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @NetDiscount = ISNULL((
				SELECT NetDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @FlatDis = ISNULL((
				SELECT TDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
    SET @Adjustment = ISNULL((
				SELECT AdjAmount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue - p.PaymentDue)
	FROM POrders p
	INNER JOIN Suppliers
		ON Suppliers.SupplierID = p.SupplierId
	WHERE p.POrderID = @PurchaseOrderId AND p.IsDamageOrder != 1

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue + p.PaymentDue)
	FROM @PurchaseOrder p
	INNER JOIN Suppliers
		ON Suppliers.SupplierID = p.SupplierId
	WHERE p.IsDamageOrder != 1

	UPDATE POrders
	SET OrderDate = p.OrderDate,
		ChallanNo = p.ChallanNo,
		SupplierID = p.SupplierID,
		GrandTotal = p.GrandTotal,
		TDiscount = p.TDiscount,
		TotalAmt = p.TotalAmt,
		AdjAmount = p.AdjAmount,
		RecAmt = p.RecAmt,
		PaymentDue = p.PaymentDue,
		TotalDue = p.TotalDue,
		STATUS = p.STATUS,
		PPDisAmt = p.PPTDisAmt,
		NetDiscount = p.NetDiscount,
		LaborCost = p.LabourCost,
		ConcernID = p.ConcernID,
		ModifiedDate = p.CreateDate,
		ModifiedBy = p.CreatedBy,
		IsDamageOrder = p.IsDamageOrder,
		Remarks = p.Remarks,
		InvoiceNo = p.InvoiceNo,
		EditReqStatus = 0,
		TPQty = p.TPQty,
		ActionStatus = ActionStatus + 1
	FROM @PurchaseOrder p
	WHERE POrderID = @PurchaseOrderId

	UPDATE POrderDetails
	SET POrderDetails.ProductID = PODT.ProductId,
		POrderDetails.ColorID = PODT.ColorId,
		POrderDetails.Quantity = PODT.Quantity,
		POrderDetails.UnitPrice = PODT.UnitPrice,
		POrderDetails.TAmount = PODT.TAmount,
		POrderDetails.PPDISPer = PODT.PPDisPer,
		POrderDetails.PPDISAmt = PODT.PPDisAmt,
		POrderDetails.MRPRate = PODT.MrpRate,
		POrderDetails.POrderID = @PurchaseOrderId,
		POrderDetails.SalesRate = PODT.SalesRate,
		POrderDetails.ExtraPPDISPer = PODT.ExtraPPDISPer,
		POrderDetails.ExtraPPDISAmt = PODT.ExtraPPDISAmt,
		PORderDetails.PPOFFER = PODT.PPOffer,
		POrderDetails.CreditSalesRate = PODT.CreditSalesRate,
		POrderDetails.CRSalesRate12Month = PODT.CRSalesRate12Month,
		POrderDetails.CRSalesRate3Month = PODT.CRSalesRate3Month,
		POrderDetails.GodownID = PODT.GodownID
	FROM @PODetails PODT
	INNER JOIN POrderDetails POD
		ON POD.POrderDetailId = PODT.POrderDetailId
	WHERE PODT.STATUS = 4

	INSERT INTO POrderDetails (
		ProductID,
		ColorID,
		Quantity,
		UnitPrice,
		TAmount,
		PPDISPer,
		PPDISAmt,
		MRPRate,
		POrderID,
		SalesRate,
		ExtraPPDISPer,
		ExtraPPDISAmt,
		PPOFFER,
		CreditSalesRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownID
		) (
		SELECT ProductId,
		ColorId,
		Quantity,
		UnitPrice,
		TAmount,
		PPDisPer,
		PPDisAmt,
		MrpRate,
		@PurchaseOrderId POrderID,
		SalesRate,
		ExtraPPDISPer,
		ExtraPPDISAmt,
		PPOffer,
		CreditSalesRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownId FROM @PODetails WHERE STATUS = 3
		)

	DELETE
	FROM POProductDetails
	WHERE POrderDetailID IN (
			SELECT POrderDetailId
			FROM @PODetails
			WHERE STATUS = 4 OR STATUS = 5
			)

	DELETE
	FROM POrderDetails
	WHERE POrderDetailID IN (
			SELECT POrderDetailId
			FROM @PODetails
			WHERE STATUS = 5
			)

	INSERT INTO POProductDetails (
		ProductID,
		ColorID,
		IMENO,
		POrderDetailID,
		DamagePOPDID
		) (
		SELECT POPD.ProductId,
		POPD.ColorId,
		POPD.IMENo,
		POD.POrderDetailID,
		POPD.DamagePOPDID FROM @POProductDetails POPD INNER JOIN POrderDetails POD
		ON POD.ProductID = POPD.ProductId AND POD.ColorID = POPD.ColorId AND POD.POrderID = @PurchaseOrderId
		)

	UPDATE POProductDetails
	SET IsDamageReplaced = 1
	FROM @POProductDetails dtPOPD
	INNER JOIN POProductDetails POPD
		ON dtPOPD.DamagePOPDID = POPD.POPDID

	Set @TPQty=ISNULL((Select sum(Quantity) from POrderDetails where POrderID=@PurchaseOrderId),0)
	Update POrders set TPQty=@TPQty where POrderID=@PurchaseOrderId

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity - s.Quantity),
		Stocks.MRPPrice = s.MRPPrice,
		LPPrice = s.LPPrice,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate
	FROM @Stocks s
	INNER JOIN Stocks
		ON Stocks.StockID = s.StockID
	WHERE s.STATUS = 5

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity + s.Quantity),
		Stocks.MRPPrice = s.MRPPrice,
		LPPrice = s.LPPrice,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate
	FROM @Stocks s
	INNER JOIN Stocks
		ON Stocks.StockID = s.StockID
	WHERE s.STATUS = 3 OR s.STATUS = 4

	INSERT INTO Stocks (
		StockCode,
		ColorId,
		EntryDate,
		Quantity,
		ProductID,
		MRPPrice,
		LPPrice,
		ConcernID,
		CreatedBy,
		CreateDate,
		GodownID
		) (
		SELECT StockCode,
		ColorId,
		EntryDate,
		Quantity,
		ProductId,
		MRPPrice,
		LPPrice,
		ConcernId,
		CreatedBy,
		CreateDate,
		GodownId
		FROM @Stocks WHERE StockId IS NULL
		)

	DELETE
	FROM StockDetails
	WHERE StockDetails.POrderDetailID IN (
			SELECT POrderDetailId
			FROM @PODetails
			WHERE STATUS = 4 OR STATUS = 5
			)

	INSERT INTO StockDetails (
		StockID,
		StockCode,
		ProductID,
		ColorID,
		POrderDetailID,
		IMENO,
		STATUS,
		PRate,
		SRate,
		CreditSRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownID,
		Quantity,
		IsDamage
		) (
		SELECT stk.StockID,
		stkd.StockCode,
		stkd.ProductId,
		stkd.ColorId,
		POD.POrderDetailID,
		stkd.IMENo,
		stkd.STATUS,
		(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment)))),
		stkd.SalesRate,
		stkd.CreditSRate,
		POD.CRSalesRate12Month,
		POD.CRSalesRate3Month,
		stkd.GodownId,
		POD.Quantity,
		1
		FROM @StockDetails stkd INNER JOIN Stocks stk
		ON stk.ProductID = stkd.ProductId AND stk.ColorID = stkd.ColorID AND stk.GodownID = stkd.GodownId
		INNER JOIN POrderDetails POD
		ON POD.ProductID = stkd.ProductId AND POD.ColorID = stkd.ColorId AND POD.GodownID=stkd.GodownId AND POD.POrderID = @PurchaseOrderId
		INNER JOIN Products p on stkd.ProductId = p.ProductID
		where p.ProductType=2
		)

		INSERT INTO StockDetails (
		StockID,
		StockCode,
		ProductID,
		ColorID,
		POrderDetailID,
		IMENO,
		STATUS,
		PRate,
		SRate,
		CreditSRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownID,
		IsDamage
		) (
		SELECT stk.StockID,
		stkd.StockCode,
		stkd.ProductId,
		stkd.ColorId,
		POD.POrderDetailID,
		stkd.IMENo,
		stkd.STATUS,
		(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment)))),
		stkd.SalesRate,
		stkd.CreditSRate,
		POD.CRSalesRate12Month,
		POD.CRSalesRate3Month,
		stkd.GodownId,
		1
		FROM @StockDetails stkd 
		INNER JOIN Stocks stk
		ON stk.ProductID = stkd.ProductId AND stk.ColorID = stkd.ColorID AND stk.GodownID = stkd.GodownId
		INNER JOIN POrderDetails POD
		ON POD.ProductID = stkd.ProductId AND POD.ColorID = stkd.ColorId AND POD.GodownID=stkd.GodownId AND POD.POrderID = @PurchaseOrderId
		INNER JOIN Products p on stkd.ProductId = p.ProductID
		where p.ProductType!=2
		)

	UPDATE StockDetails
	SET PRate = (POD.UnitPrice - (((po.TDiscount + po.AdjAmount) * POD.UnitPrice) / (po.GrandTotal - po.NetDiscount + (po.TDiscount + po.AdjAmount))))
	FROM POrderDetails pod
	INNER JOIN StockDetails sd
		ON pod.POrderDetailID = sd.POrderDetailID
	INNER JOIN POrders po
		ON pod.POrderID = po.POrderID
	WHERE po.POrderID = @PurchaseOrderId



	INSERT INTO TransactionPOrders (
		OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPDisAmt
		,NetDiscount
		,LaborCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,ActionStatus
		,ModifiedBy
		,ModifiedDate
		,POrderID

		) (
		SELECT po.OrderDate
		,po.ChallanNo
		,po.SupplierID
		,po.GrandTotal
		,po.TDiscount
		,po.TotalAmt
		,po.AdjAmount
		,po.RecAmt
		,po.PaymentDue
		,po.TotalDue
		,po.Status
		,po.PPDisAmt
		,po.NetDiscount
		,po.LaborCost
		,po.ConcernID
		,po.CreateDate
		,po.CreatedBy
		,po.IsDamageOrder
		,po.Remarks
		,po.InvoiceNo
		,po.TPQty
		,po.ActionStatus
		,po.ModifiedBy
		,po.ModifiedDate
		,po.POrderID
		 FROM POrders po
		INNER JOIN POrders p on po.POrderID = p.POrderID AND p.POrderID =  @PurchaseOrderId
		)

	INSERT INTO TransactionPOrderDetails (
		ProductID
		,ColorID
		,Quantity
		,UnitPrice
		,TAmount
		,PPDISPer
		,PPDISAmt
		,MRPRate
		,POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOFFER
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownID
		,ActionStatus
		,ActionBy
		,ActionDate
		) (
		SELECT pd.ProductId
		,pd.ColorId
		,pd.Quantity
		,pd.UnitPrice
		,pd.TAmount
		,pd.PPDisPer
		,pd.PPDisAmt
		,pd.MrpRate
		,@PurchaseOrderId POrderID
		,pd.SalesRate
		,pd.ExtraPPDISPer
		,pd.ExtraPPDISAmt
		,pd.PPOffer
		,pd.CreditSalesRate
		,pd.CRSalesRate12Month
		,pd.CRSalesRate3Month
		,pd.GodownId
		,(
			SELECT ActionStatus 
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,(
			SELECT ModifiedBy
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,(
			SELECT ModifiedDate
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		FROM POrderDetails pd
		INNER JOIN POrders p on p.POrderID =  @PurchaseOrderId
		INNER JOIN POrderDetails ppd on pd.POrderDetailID = ppd.POrderDetailID AND ppd.POrderID = @PurchaseOrderId
		)


	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	DECLARE @CreatedDate DATETIME,
		@CreatedBy INT

	SELECT @CreatedBy = CreatedBy,
		@CreatedDate = CreateDate
	FROM @PurchaseOrder

	INSERT INTO Errors (
		Message,
		StackTrace,
		CreatedBy,
		CreateDate
		)
	VALUES (
		ERROR_MESSAGE(),
		ERROR_PROCEDURE() + ':' + CONVERT(VARCHAR(10), ERROR_LINE()) + '-' + ERROR_MESSAGE(),
		@CreatedBy,
		@CreatedDate
		)

	RETURN 0;
END CATCH
GO



----------COMMONSOURCE----------
----------Mostafizur--------------
----------17-03-2025------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[sp_TrialBalance]
(
  @FromDate datetime,
  @ToDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int)



--****************************************************
--***************Debit Start**************************
--****************************************************

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Cash at Banks', ISNULL(sum(TotalAmount),0.0),0.00,1 from Banks
--where ConcernID=@ConcernID

------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)
--set @OpeningBalance = ISNULL((select sum(Amount)from ShareInvestments i
--JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
--JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
--where i.ConcernID=@ConcernID AND ih.Name LIKE 'Opening%' AND (p.Name='Current Asset' OR p.Name='Fixed Asset')),0.00)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

----direct expense
--set @TotalExpense =ISNULL((
--select SUM(Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1),0)

----cash delivery
--set @TotalExpense =@TotalExpense+ISNULL((
--select sum(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

----sales return
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4
--),0)

-----cash purchase
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID
--),0)

----cash deposite
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID
--),0)

-------------------Income----------------

----cash collection
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

----installment collections
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(css.InstallmentAmt) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

----direct income
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(ex.Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2
--),0)

----hire sales downpayment
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

----cash sales
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1
--),0)

----cash withdraw from bank
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)
DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in hand',@TotalCashInHand,0.00,1)

-------------------------------------------Cash in the bank--------------------------------------------
--set @TotalIncome=0
--set @TotalExpense=0
----Deposit
--set @TotalIncome= @TotalIncome + ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
----Collection from Customer
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)

----Withdraw
--set @TotalExpense= ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)

----Delivery to suppliers
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)
----Fund Transfer Out
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=5 and bt.ConcernID=@ConcernID and bt.BankID!=0
--),0)
----Fund Transfer In
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=5 and bt.ConcernID=@ConcernID and bt.AnotherBankID!=0
--),0)

----Bank Expense
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=6 and bt.ConcernID=@ConcernID and bt.ExpenseItemID!=0
--),0)

----Bank Income
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=7 and bt.ConcernID=@ConcernID and bt.ExpenseItemID!=0
--),0)

----Lia. Pay
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=8 and bt.ConcernID=@ConcernID and bt.SIHID!=0
--),0)

----Lia. Rec
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=9 and bt.ConcernID=@ConcernID and bt.SIHID!=0
--),0)

----Return From Supplier
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=10 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)

--declare @allBankOpening DECIMAL(18,2) = (SELECT ISNULL(SUM(OpeningBalance), 0) FROM Banks WHERE ConcernID = @ConcernID)

--IF(@TotalIncome-@TotalExpense!=0)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash at Bank',(@TotalIncome-@TotalExpense) + @allBankOpening, 0.00,2)


-- Summary---
--declare @BankBalance decimal(18,2)


--SET @BankBalance = (SELECT SUM(ISNULL(TotalAmount, 0)) FROM dbo.Banks WHERE @ConcernID = ConcernID)
--DECLARE @payBL INT = 8;
--IF(@BankBalance != 0)
--	BEGIN
--		create table #tmpBankBalance(BankID INT, TotalAmount DECIMAL(18,2))


--		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
--			EXEC dbo.GetDatewiseBankBalance @ConcernID, 0, @ToDate, @ToDate, @ToDate

--		SET @BankBalance = (SELECT SUM(TotalAmount) FROM #tmpBankBalance)
--		drop TABLE #tmpBankBalance
--		SET @BankBalance = @BankBalance

--		Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash at Bank',@BankBalance, 0.00,2)
--	END

----------------------------------------
declare @BankBalance decimal(18,2)
DECLARE @HoqueConcern INT

SET @HoqueConcern = (SELECT ConcernID FROM SisterConcerns  WHERE Name = 'HOQUE ELECTRONICS' AND @ConcernID = ConcernID)

SET @BankBalance = (SELECT SUM(ISNULL(TotalAmount, 0)) FROM dbo.Banks WHERE @ConcernID = ConcernID)
DECLARE @payBL INT = 8;
IF(@BankBalance != 0)
	BEGIN
		create table #tmpBankBalance(BankID INT, TotalAmount DECIMAL(18,2))

IF(@HoqueConcern = @ConcernID)
BEGIN
		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
			EXEC dbo.GetDatewiseBankBalanceHoque @ConcernID, 0, @ToDate, @ToDate, @ToDate
END

ELSE
BEGIN
		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
			EXEC dbo.GetDatewiseBankBalance @ConcernID, 0, @ToDate, @ToDate, @ToDate
END


		SET @BankBalance = (SELECT SUM(TotalAmount) FROM #tmpBankBalance)
		drop TABLE #tmpBankBalance
		SET @BankBalance = @BankBalance


		Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash at Bank',@BankBalance, 0.00,2)
	END

--------------------------------------------Direct Expense-----------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select exi.Description,Amount,0.00,8 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1

---------------------------------------------Purchase----------------------------------------
DECLARE @CashCollection decimal(18,2)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Purchase',po.GrandTotal,0.00,3 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID

---------------------------------------Transfer In and Transfer Receivables--------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer In',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4


--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Receivables',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

----------------------------------------Adjustment------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',cc.AdjustAmt,0.0,8 from CashCollections cc
where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',css.LastPayAdjust,0.0,8 from CreditSales so
join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.LastPayAdjust>0 and css.PaymentStatus='Paid')

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',so.AdjAmount,0.0,8 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.AdjAmount>0

------------------------------------------Discount Given---------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.Discount,0.0,5 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.Discount>0


Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.NetDiscount,0.0,5 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0

declare @disAmt DECIMAL(18,2) = (select SUM(so.NetDiscount) from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0)

print(@disAmt)

------------------------------------------Sales Return------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Return',so.TotalAmount,0.0,6 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4

----------------------------------------------Customer Due---------------------------------
Declare @TotalSaleAmt  decimal(18,2)

--Set @TotalSaleAmt= ISNULL((
--select SUM(so.TotalAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and  so.InvoiceDate<=@ToDate) and so.Status=1),0)

----Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
----select SUM(so.OpeningDue) from Customers so
----where so.ConcernID=@ConcernID and (so.CreatedDate<=@ToDate)),0)

--Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
--select SUM(so.NetAmount) from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos = ISNULL((
--select SUM(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.RecAmount>0),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.PaymentDue) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4 and so.PaymentDue>0),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(css.InstallmentAmt+css.LastPayAdjust) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((select SUM(cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and  cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)
--IF(@TotalSaleAmt-@CashInHandPos!=0)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values ('Customer Due',0,0,2) --amount will come from another sp, follow c# method


----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

--set  @TotalPOAmt=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0.00)

--set  @TotalPOAmt=@TotalPOAmt+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4),0.00)

--set  @TotalPOReturn=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0.00)



--set @TotalSales=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=1),0)

--set  @TotalSales=@TotalSales+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4),0.00)

--set @TotalSalesReturn=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=4),0)

--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Stock',(@TotalPOAmt+@TotalSalesReturn-@TotalPOReturn-@TotalSales),0.00,7)

---------------------------------------Stock Value End-------------------------------



--****************************************************
--***************Debit End****************************
--****************************************************



--****************************************************
--***************Credit Start*************************
--****************************************************


-----------------------------------Transfer Out and Transfer Payable---------------------------------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Out',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Payable',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4

------------------Investment-----------------------------------------------------
declare @Liability decimal(18,2)

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Lia. Receive',0.00,@Liability,3)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
INSERT INTO #crTemp(Particulars, Debit, Credit, SerialNum) values('Lia. Receive',0.00,@Liability,7)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,7)
END

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=2 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
END

---Asset
set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Current Asset' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
END
-------------------------------------Direct Income-------------------------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select exi.Description,0.00,ex.Amount,5 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2

-------------------------------------Retail and hire Sales----------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.GrandTotal,1 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.NetAmount,1 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'ProcessingFee',0.00,so.ProcessingFee,1 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1

--------------------------------------Purchase Discount------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Discount',0.00,po.NetDiscount,3 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID and po.NetDiscount>0

-----------------------------------------Hire Interest--------------------------
--Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
--select 'Hire Interest',0.00,so.InterestAmount,12 from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.InterestAmount>0

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
SELECT 'Hire Extend Interest',0.00,csi.InterestAmount,12 from dbo.CreditInterestHistories csi
JOIN dbo.CreditSales cs ON csi.HireSaleId = cs.CreditSalesID
WHERE cs.ConcernID = @ConcernID and cs.IsStatus=1 AND csi.IsFirstTime = 0
AND CAST(csi.InterestDate AS DATE) BETWEEN CAST(@FromDate AS DATE) AND CAST(@ToDate AS DATE)



----------------------------------------Supplier Due----------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)


SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)

--IF(@SupplierDue-@CashDelivery!=0)
--	Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue-@CashDelivery,5)
IF(@SupplierDue != 0)
	BEGIN
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @ToDate, @ToDate, @ToDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		drop TABLE #tmpSupplierDue

		--DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue

		--SET @SupplierDue = @SupplierDue + @totalOpeningDue


		Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,4)
	END


-----------------------------Purchase Return---------------------------

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Return',0.00,po.TotalAmt,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID

--****************************************************
--***************Credit End***************************
--****************************************************
--INSERT INTO #fTemp(ID,DebitParticular, Debit, CreditPaticular, Credit, SerialNum)
--SELECT ISNULL(T1.ID, 3), ISNULL(T1.Particulars, ''), ISNULL(T1.Debit, 0), '', 0.00, T1.SerialNum FROM #temp T1
--UNION ALL
--SELECT 0, '', 0, ISNULL(T2.Particulars, ''), ISNULL(T2.Credit, 0), T2.SerialNum FROM #crTemp T2


-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit, SerialNum as SL from #fTemp
GROUP BY DebitParticular, CreditParticular, SerialNum
order by SL




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--exec sp_TrialBalance  '01 Oct 2020 12:00:00 AM','02 Oct 2023 11:59:59 PM',5212

----------COMMONSOURCE----------
----------Mostafizur--------------
----------17-03-2025------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_YearlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-02-09'


if (@ConcernID = 1)
	set @CashInHand = 1263.00
else if (@ConcernID = 5)
	set @CashInHand = 8755.00
else if (@ConcernID = 6)
	set @CashInHand = - 2.00
else if (@ConcernID = 4)
	set @CashInHand = 65000.00
else if (@ConcernID = 20)
BEGIN
	set @CashInHand = 137340.00
	set @StartDate = '2020-03-12'
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END


set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(YEAR, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

insert into #temp_Data1
select @StartDate, s.Name, sum(po.recAmt), 'Cash Sales', 0, 'Order'
from POrders po
join Suppliers s on po.SupplierID = s.SupplierID
where po.ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
 and po.RecAmt>0
group by s.SupplierID,s.Name

insert into #temp_Data1
select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END

-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections cc 
join Suppliers s on cc.SupplierID = s.SupplierID
where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,  s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc 
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate 
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3 AND CustomerID > 0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Customer Cash Collection Return', @total, 'Customer Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID 
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Retail/Dealer', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID 
		and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Retail/Dealere', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID 
				and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Hire', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID 
		and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Hire', 0, '', 0, 'Header'
	END

------------- -------------------------------------------- Direct Expense--------------------------------------------
set @total =isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)

if (@total) != 0
begin
insert into #temp_Data1
select @StartDate,'Expense', 0, '', 0, 'Header'

insert into #temp_Data1
select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1  AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description

insert into #temp_Data1
select @StartDate,'Total Expense', @total, '', 0, 'Header'

end

		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID and Year(Convert(date, TransactionDate)) = Year(@StartDate)  and  TransactionDate>= @InitailDate
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0 and  TransactionDate>= @InitailDate
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
						where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end


-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0
 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE  SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
 END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END


---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 1 and BT.WFStatus = 2   and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate,'Bank Customer Collections', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	inner join Customers c on BT.CustomerID = c.CustomerID
	where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName, c.CustomerType

	insert into #temp_Data1
	select @StartDate,'Total Bank Customer Collections', @total, '', 0, 'Header'
END
---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Supplier Payment', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Supplier Payment', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Supplier Payment', @total, '', 0, 'Header'
END

---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate,'Bank Fund Out', 0, '', 0, 'Header'
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName
insert into #temp_Data1
select @StartDate,'Total Bank Fund Out ', @total, '', 0, 'Header'
END

				---------------------------------Expens from Bank Expens---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Expense', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Expense)', sum(Amount), 'Bank Expense', 0, 'Cash'

		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Expense ', @total, '', 0, 'Header'


	END
---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Income', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Income (Cr))', sum(Amount), 'Bank Income ', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Income ', @total, '', 0, 'Header'
END

----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'


-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1 and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
  
END
-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1  and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1   and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END


-- ------------------------------------Income Processing Fee from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(ProcessingFee), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1  and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Processing Fee', 0.00, 'Processing Fee', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, ProcessingFee, 'Processing Fee'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1   and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Processing Fee', 0.00, 'Total Processing Fee', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID  and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0
						and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

	-----------------------------------Income from Return From Supplier------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from CashCollections EX
						inner join Suppliers  E on E.SupplierID = EX.SupplierID
						where E.ConcernID = @ConcernID and EX.TransactionType = 3 
						AND Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Return From Supplier', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Name, sum(Amount), E.Name
		from CashCollections EX
		inner join Suppliers E on E.SupplierID = EX.SupplierID
		where E.ConcernID = @ConcernID and EX.TransactionType = 3 and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Name
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Total Return From Supplier',@total, 'Header')
	
	end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1   AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
 END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
------------------------------------------------------------------------------------------------------------------------------------------------------

 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE  SIH.ParentId=2  and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END
---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Withdwal', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Withdwal', @total, 'Header'

END
---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Customer Collection', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Customer Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
inner join Customers c on bt.CustomerID=c.CustomerID
where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Customer Collection', @total, 'Header'

END

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Supplier payment', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Supplier payment', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Supplier payment', @total, 'Header'

END
----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Fund IN', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Fund IN', @total, 'Header'

END
---------------------------------Income from Bank Expense as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Expense', 0, 'Header'

		insert into #temp_Data2
		select @StartDate, 'Bank Expense', 0, B.AccountNo + ',' + B.BankName + '(Bank Expense(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Expense', @total, 'Header'

	END
---------------------------------Income from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Income', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Income', 0, B.AccountNo + ',' + B.BankName + '(Bank Income)', sum(Amount), 'Cash'

		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Income', @total, 'Header'		
END


------------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)

set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(YEAR, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

----------COMMONSOURCE----------
----------Mostafizur--------------
----------17-03-2025------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_MonthlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0


if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-06-09'
set @CashInHand=26500
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(MONTH, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate)
and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

insert into #temp_Data1
select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
from POrders po
join Suppliers s on po.SupplierID = s.SupplierID
where po.ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate)
and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate and po.RecAmt>0
group by s.SupplierID,s.Name

insert into #temp_Data1
select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 



-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections cc 
join Suppliers s on cc.SupplierID = s.SupplierID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) 
and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(cc.amount), 'Due Collection', 0, 'Cash'
		from CashCollections cc 
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) 
		and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
	-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3 AND CustomerID > 0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Customer Cash Collection Return', @total, 'Customer Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'
END
------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID 
				and  Month(Convert(date, InvoiceDate)) = Month(@StartDate)
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Retail/Dealer', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID 
	and  Month(Convert(date, InvoiceDate)) = Month(@StartDate)
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Retail/Dealere', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID 
			    and  Month(Convert(date, SalesDate)) = Month(@StartDate)
				and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Hire', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID 
	    and  Month(Convert(date, SalesDate)) = Month(@StartDate)
		and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Hire', 0, '', 0, 'Header'
	END
------------- -------------------------------------------- Direct Expense--------------------------------------------
set @total=isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)

if(@total) != 0
begin
	insert into #temp_Data1
	select @StartDate,'Expense', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
	from Expenditures EX
	inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
	where EX.ConcernID = @ConcernID and E.status = 1 AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
	group by E.Description

	insert into #temp_Data1
	select @StartDate,'Total Expense', @total, '', 0, 'Header'
end
		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID  and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate)  and  TransactionDate>= @InitailDate
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0 and  TransactionDate>= @InitailDate
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
					    where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end


-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2 AND    SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
 END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END
---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 1 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Customer Collections', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on BT.CustomerID = c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
		group by B.BankID, B.AccountNo, B.BankName, c.CustomerType

		insert into #temp_Data1
		select @StartDate,'Total Bank Customer collections', @total, '', 0, 'Header'
END
---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Supplier Payment', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Supplier Payment', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Supplier Payment', @total, '', 0, 'Header'
END

---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate,'Bank Fund Out', 0, '', 0, 'Header'
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName
insert into #temp_Data1
select @StartDate,'Total Bank Fund Out ', @total, '', 0, 'Header'
END
				---------------------------------Expens from Bank Expens---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Expense', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Expense)', sum(Amount), 'Bank Expense', 0, 'Cash'

		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Expense ', @total, '', 0, 'Header'


	END
---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Income', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Income (Cr))', sum(Amount), 'Bank Income ', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Income ', @total, '', 0, 'Header'
END



----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1  and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
  
END
-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1 and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1  and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END


-- ------------------------------------Income Processing Fee from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(ProcessingFee), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1 and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Processing Fee', 0.00, 'Processing Fee', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cs.ProcessingFee, 'Processing Fee'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1  and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Processing Fee', 0.00, 'Total Processing Fee', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0 AND EX.IsBankTransaction = 0
						and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

	-----------------------------------Income from Return From Supplier------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from CashCollections EX
						inner join Suppliers  E on E.SupplierID = EX.SupplierID
						where E.ConcernID = @ConcernID and EX.TransactionType = 3 
						and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Return From Supplier', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Name, sum(Amount), E.Name
		from CashCollections EX
		inner join Suppliers E on E.SupplierID = EX.SupplierID
		where E.ConcernID = @ConcernID and EX.TransactionType = 3 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Name
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Total Return From Supplier',@total, 'Header')
	
	end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name

 insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')

 END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
------------------------------------------------------------------------------------------------------------------------------------------------------

 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END

---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Withdwal', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Withdwal', @total, 'Header'

END

---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Customer Collection', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Customer Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
inner join Customers c on bt.CustomerID=c.CustomerID
where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Customer Collection', @total, 'Header'

END

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Supplier payment', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Supplier payment', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Supplier payment', @total, 'Header'

END
----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Fund IN', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Fund IN', @total, 'Header'

END
---------------------------------Income from Bank Expense as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Expense', 0, 'Header'

		insert into #temp_Data2
		select @StartDate, 'Bank Expense', 0, B.AccountNo + ',' + B.BankName + '(Bank Expense(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Expense', @total, 'Header'

	END
---------------------------------Income from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Income', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Income', 0, B.AccountNo + ',' + B.BankName + '(Bank Income)', sum(Amount), 'Cash'

		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Income', @total, 'Header'		
END

 ------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(MONTH, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

----------COMMONSOURCE----------
----------Mostafizur--------------
----------17-03-2025------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[sp_TrialBalance]
(
  @FromDate datetime,
  @ToDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int)



--****************************************************
--***************Debit Start**************************
--****************************************************

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Cash at Banks', ISNULL(sum(TotalAmount),0.0),0.00,1 from Banks
--where ConcernID=@ConcernID

------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)
--set @OpeningBalance = ISNULL((select sum(Amount)from ShareInvestments i
--JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
--JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
--where i.ConcernID=@ConcernID AND ih.Name LIKE 'Opening%' AND (p.Name='Current Asset' OR p.Name='Fixed Asset')),0.00)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

----direct expense
--set @TotalExpense =ISNULL((
--select SUM(Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1),0)

----cash delivery
--set @TotalExpense =@TotalExpense+ISNULL((
--select sum(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

----sales return
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4
--),0)

-----cash purchase
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID
--),0)

----cash deposite
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID
--),0)

-------------------Income----------------

----cash collection
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

----installment collections
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(css.InstallmentAmt) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

----direct income
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(ex.Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2
--),0)

----hire sales downpayment
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

----cash sales
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1
--),0)

----cash withdraw from bank
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)
DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in hand',@TotalCashInHand,0.00,1)

-------------------------------------------Cash in the bank--------------------------------------------
--set @TotalIncome=0
--set @TotalExpense=0
----Deposit
--set @TotalIncome= @TotalIncome + ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
----Collection from Customer
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)

----Withdraw
--set @TotalExpense= ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)

----Delivery to suppliers
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)
----Fund Transfer Out
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=5 and bt.ConcernID=@ConcernID and bt.BankID!=0
--),0)
----Fund Transfer In
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=5 and bt.ConcernID=@ConcernID and bt.AnotherBankID!=0
--),0)

----Bank Expense
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=6 and bt.ConcernID=@ConcernID and bt.ExpenseItemID!=0
--),0)

----Bank Income
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=7 and bt.ConcernID=@ConcernID and bt.ExpenseItemID!=0
--),0)

----Lia. Pay
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=8 and bt.ConcernID=@ConcernID and bt.SIHID!=0
--),0)

----Lia. Rec
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=9 and bt.ConcernID=@ConcernID and bt.SIHID!=0
--),0)

----Return From Supplier
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=10 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)

--declare @allBankOpening DECIMAL(18,2) = (SELECT ISNULL(SUM(OpeningBalance), 0) FROM Banks WHERE ConcernID = @ConcernID)

--IF(@TotalIncome-@TotalExpense!=0)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash at Bank',(@TotalIncome-@TotalExpense) + @allBankOpening, 0.00,2)


-- Summary---
--declare @BankBalance decimal(18,2)


--SET @BankBalance = (SELECT SUM(ISNULL(TotalAmount, 0)) FROM dbo.Banks WHERE @ConcernID = ConcernID)
--DECLARE @payBL INT = 8;
--IF(@BankBalance != 0)
--	BEGIN
--		create table #tmpBankBalance(BankID INT, TotalAmount DECIMAL(18,2))


--		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
--			EXEC dbo.GetDatewiseBankBalance @ConcernID, 0, @ToDate, @ToDate, @ToDate

--		SET @BankBalance = (SELECT SUM(TotalAmount) FROM #tmpBankBalance)
--		drop TABLE #tmpBankBalance
--		SET @BankBalance = @BankBalance

--		Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash at Bank',@BankBalance, 0.00,2)
--	END

----------------------------------------
declare @BankBalance decimal(18,2)
DECLARE @HoqueConcern INT

SET @HoqueConcern = (SELECT ConcernID FROM SisterConcerns  WHERE Name = 'HOQUE ELECTRONICS' AND @ConcernID = ConcernID)

SET @BankBalance = (SELECT SUM(ISNULL(TotalAmount, 0)) FROM dbo.Banks WHERE @ConcernID = ConcernID)
DECLARE @payBL INT = 8;
IF(@BankBalance != 0)
	BEGIN
		create table #tmpBankBalance(BankID INT, TotalAmount DECIMAL(18,2))

IF(@HoqueConcern = @ConcernID)
BEGIN
		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
			EXEC dbo.GetDatewiseBankBalanceHoque @ConcernID, 0, @ToDate, @ToDate, @ToDate
END

ELSE
BEGIN
		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
			EXEC dbo.GetDatewiseBankBalance @ConcernID, 0, @ToDate, @ToDate, @ToDate
END


		SET @BankBalance = (SELECT SUM(TotalAmount) FROM #tmpBankBalance)
		drop TABLE #tmpBankBalance
		SET @BankBalance = @BankBalance


		Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash at Bank',@BankBalance, 0.00,2)
	END

--------------------------------------------Direct Expense-----------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select exi.Description,Amount,0.00,8 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1

---------------------------------------------Purchase----------------------------------------
DECLARE @CashCollection decimal(18,2)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Purchase',po.GrandTotal,0.00,3 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID

---------------------------------------Transfer In and Transfer Receivables--------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer In',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4


--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Receivables',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

----------------------------------------Adjustment------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',cc.AdjustAmt,0.0,8 from CashCollections cc
where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',css.LastPayAdjust,0.0,8 from CreditSales so
join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.LastPayAdjust>0 and css.PaymentStatus='Paid')

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',so.AdjAmount,0.0,8 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.AdjAmount>0

------------------------------------------Discount Given---------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.Discount,0.0,5 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.Discount>0


Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.NetDiscount,0.0,5 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0

declare @disAmt DECIMAL(18,2) = (select SUM(so.NetDiscount) from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0)

print(@disAmt)

------------------------------------------Sales Return------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Return',so.TotalAmount,0.0,6 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4

----------------------------------------------Customer Due---------------------------------
Declare @TotalSaleAmt  decimal(18,2)

--Set @TotalSaleAmt= ISNULL((
--select SUM(so.TotalAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and  so.InvoiceDate<=@ToDate) and so.Status=1),0)

----Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
----select SUM(so.OpeningDue) from Customers so
----where so.ConcernID=@ConcernID and (so.CreatedDate<=@ToDate)),0)

--Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
--select SUM(so.NetAmount) from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos = ISNULL((
--select SUM(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.RecAmount>0),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.PaymentDue) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4 and so.PaymentDue>0),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(css.InstallmentAmt+css.LastPayAdjust) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((select SUM(cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and  cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)
--IF(@TotalSaleAmt-@CashInHandPos!=0)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values ('Customer Due',0,0,2) --amount will come from another sp, follow c# method


----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

--set  @TotalPOAmt=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0.00)

--set  @TotalPOAmt=@TotalPOAmt+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4),0.00)

--set  @TotalPOReturn=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0.00)



--set @TotalSales=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=1),0)

--set  @TotalSales=@TotalSales+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4),0.00)

--set @TotalSalesReturn=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=4),0)

--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Stock',(@TotalPOAmt+@TotalSalesReturn-@TotalPOReturn-@TotalSales),0.00,7)

---------------------------------------Stock Value End-------------------------------



--****************************************************
--***************Debit End****************************
--****************************************************



--****************************************************
--***************Credit Start*************************
--****************************************************


-----------------------------------Transfer Out and Transfer Payable---------------------------------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Out',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Payable',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4

------------------Investment-----------------------------------------------------
declare @Liability decimal(18,2)

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Lia. Receive',0.00,@Liability,3)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
INSERT INTO #crTemp(Particulars, Debit, Credit, SerialNum) values('Lia. Receive',0.00,@Liability,7)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,7)
END

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=2 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
END

---Asset
set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Current Asset' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
END
-------------------------------------Direct Income-------------------------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select exi.Description,0.00,ex.Amount,5 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2

-------------------------------------Retail and hire Sales----------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.GrandTotal,1 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.NetAmount,1 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.ProcessingFee,1 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1

--------------------------------------Purchase Discount------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Discount',0.00,po.NetDiscount,3 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID and po.NetDiscount>0

-----------------------------------------Hire Interest--------------------------
--Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
--select 'Hire Interest',0.00,so.InterestAmount,12 from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.InterestAmount>0

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
SELECT 'Hire Extend Interest',0.00,csi.InterestAmount,12 from dbo.CreditInterestHistories csi
JOIN dbo.CreditSales cs ON csi.HireSaleId = cs.CreditSalesID
WHERE cs.ConcernID = @ConcernID and cs.IsStatus=1 AND csi.IsFirstTime = 0
AND CAST(csi.InterestDate AS DATE) BETWEEN CAST(@FromDate AS DATE) AND CAST(@ToDate AS DATE)



----------------------------------------Supplier Due----------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)


SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)

--IF(@SupplierDue-@CashDelivery!=0)
--	Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue-@CashDelivery,5)
IF(@SupplierDue != 0)
	BEGIN
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @ToDate, @ToDate, @ToDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		drop TABLE #tmpSupplierDue

		--DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue

		--SET @SupplierDue = @SupplierDue + @totalOpeningDue


		Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,4)
	END


-----------------------------Purchase Return---------------------------

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Return',0.00,po.TotalAmt,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID

--****************************************************
--***************Credit End***************************
--****************************************************
--INSERT INTO #fTemp(ID,DebitParticular, Debit, CreditPaticular, Credit, SerialNum)
--SELECT ISNULL(T1.ID, 3), ISNULL(T1.Particulars, ''), ISNULL(T1.Debit, 0), '', 0.00, T1.SerialNum FROM #temp T1
--UNION ALL
--SELECT 0, '', 0, ISNULL(T2.Particulars, ''), ISNULL(T2.Credit, 0), T2.SerialNum FROM #crTemp T2


-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit, SerialNum as SL from #fTemp
GROUP BY DebitParticular, CreditParticular, SerialNum
order by SL




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--exec sp_TrialBalance  '01 Oct 2020 12:00:00 AM','02 Oct 2023 11:59:59 PM',5212

----------COMMONSOURCE----------
----------Mostafizur--------------
----------16-03-2025------------


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--EXEC sp_DailyCashInHand  '11 MAY 2021 12:00:00 AM','11 MAY 2021 11:59:59 PM',16
ALTER procedure [dbo].[sp_DailyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-08-01'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)



create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(DAY, 1, Convert(date, GetDate()))
begin
	print @StartDate

	delete
	from #temp_Data1

	delete
	from #temp_Data2

	--	DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
	--	DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
	------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
	insert into #temp_Data1
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
				and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
		from POrders po
		join Suppliers s on po.SupplierID = s.SupplierID
		where po.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
		and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and po.RecAmt>0
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
	-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections cc
				join Suppliers s on cc.SupplierID = s.SupplierID
				where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
				and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
		and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
	------------------------------------------------------Expense in Product return----------------------------------
	set @total = isnull((
				select sum(PaidAmount)
				from ROrders
				where ConcernID = @ConcernID and DAY(Convert(date, ReturnDate)) = DAY(@StartDate) and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

END

	-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3 AND CustomerID > 0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Customer Cash Collection Return', @total, 'Customer Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

	------------- -------------------------------------------- Direct Expense--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0
		and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description

		insert into #temp_Data1
		select @StartDate,'Total Expense', @total, '', 0, 'Header'
	end

		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID  and DAY(Convert(date, TransactionDate)) = DAY(@StartDate)
				and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and DAY(Convert(date, TransactionDate)) = DAY(@StartDate)
		and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
	------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
						where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end



	-- ----------------------------Expens from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=3  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END
	---------------------------------Expense from Bank Deposit--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 1 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 1 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

	END

	---------------------------------Expense from Bank Loan--------------------
	set @total = isnull((
				SELECT SUM(ISNULL(BC.CollectionAmount, 0) + ISNULL(BC.SDPS, 0) + ISNULL(BC.Savings,0)) FROM dbo.BankLoanCollections BC
				JOIN dbo.BankLoanDetails BLD ON BC.Id = BLD.LoanCollectionId
				JOIN  dbo.BankLoans BL ON BLD.BankLoanId = BL.Id
				JOIN dbo.Banks B ON BL.BankId = B.BankID
				where BL.ConcernID = @ConcernID AND BLD.LoanCollectionId IS NOT NULL
				AND CAST(BC.CollectionDate AS DATE) = CAST(@StartDate AS DATE)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Loan Payment', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ', ' + B.BankName, SUM(ISNULL(BC.CollectionAmount, 0) + ISNULL(BC.SDPS, 0) + ISNULL(BC.Savings,0)), 'Bank Loan', 0, 'Cash'
		FROM dbo.BankLoanCollections BC
		JOIN dbo.BankLoanDetails BLD ON BC.Id = BLD.LoanCollectionId
		JOIN  dbo.BankLoans BL ON BLD.BankLoanId = BL.Id
		JOIN dbo.Banks B ON BL.BankId = B.BankID
		where BL.ConcernID = @ConcernID AND BLD.LoanCollectionId IS NOT NULL
		AND CAST(BC.CollectionDate AS DATE) = CAST(@StartDate AS DATE)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Loan Payment', @total, '', 0, 'Header'

	END
	---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------


	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2  and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Customer Collections', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	inner join Customers c on BT.CustomerID = c.CustomerID
	where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
	group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	insert into #temp_Data1
	select @StartDate,'Total Bank Customer collections', @total, '', 0, 'Header'
END
	---------------------------------Expens from Bank Cash Delivery---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Supplier Payment', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Supplier Payment', @total, '', 0, 'Header'
END
	---------------------------------Expense from Fund Out---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Fund Out', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		insert into #temp_Data1
		select @StartDate,'Total Bank Fund Out ', @total, '', 0, 'Header'
END

				---------------------------------Expens from Bank Expens---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Expense', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Expense)', sum(Amount), 'Bank Expense', 0, 'Cash'

		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Expense ', @total, '', 0, 'Header'


	END

---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Income', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Income (Cr))', sum(Amount), 'Bank Income ', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Income ', @total, '', 0, 'Header'
END


	----------------------------------------------Opening Cash In Hand in Income Table--------------------------------------------------------------- 
	insert into #temp_Data2
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	-----------------------------------------------Income in Sales Order-------------------------------------------
	set @total = isnull((
				select sum(RecAmount)
				from SOrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount,Convert(varchar(10),c.CustomerType)+'Order' from SOrders so
		join Customers c on so.CustomerID = c.CustomerID
		where so.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
	    insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
   
   END

	-- ---------------------------------------Income from Cash Collection from Customer-------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
				), 0)

	if (@total != 0)
	BEGIN
	insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, Convert(varchar(10),c.CustomerType)+'Cash'
		from CashCollections cc
		join Customers c on cc.CustomerID = c.CustomerID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
	    insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')
		
		END
	-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
	set @total = isnull((
				select isnull(sum(DownPayment), 0)
				from CreditSales
				where ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
		from CreditSales cs
		join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')
	
	END


	-- ------------------------------------Income Processing Fee from CreditSales   ----------------------------
	set @total = isnull((
				select isnull(sum(ProcessingFee), 0)
				from CreditSales
				where ConcernID = @ConcernID and ProcessingFee !=0 and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Processing Fee', 0.00, 'Processing Fee', 0.00, 'Header')
		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cs.ProcessingFee, 'Processing Fee'
		from CreditSales cs
		join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID and cs.ProcessingFee !=0 and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
		insert into #temp_Data2 values(@StartDate, 'Processing Fee', 0.00, 'Total Processing Fee', @total, 'Header')
	
	END
	--------------------------------------Income in Purchase Product return----------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and DAY(Convert(date, OrderDate)) = DAY(@StartDate) and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and status = 5
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Purchase Return Cash'

	-------------------------------Income Installment Collection from Creditsales------------------
	set @total = isnull((
				select sum(InstallmentAmt)
				from CreditSalesSchedules css
				inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
				where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
		from CreditSalesSchedules css
		inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
		inner join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
	  
	  insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')
	
	END
	-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0 AND EX.IsBankTransaction = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Description, sum(Amount), E.Description
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 2 and  EX.CashInHandReportStatus = 0 AND EX.IsBankTransaction = 0 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')
	
	end

	-----------------------------------Income from Return From Supplier------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from CashCollections EX
						inner join Suppliers  E on E.SupplierID = EX.SupplierID
						where E.ConcernID = @ConcernID and EX.TransactionType = 3 
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Return From Supplier', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Name, sum(Amount), E.Name
		from CashCollections EX
		inner join Suppliers E on E.SupplierID = EX.SupplierID
		where E.ConcernID = @ConcernID and EX.TransactionType = 3  and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Name
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Total Return From Supplier',@total, 'Header')
	
	end

	-- ----------------------------Income from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
	END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
	-----------------------------------------------------------------------------------------------------------------------------------
	   SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)
	IF (@total != 0)
	BEGIN
		INSERT INTO #temp_Data2
		SELECT @StartDate, '', 0.00,SIH.Name+'(Current Asset)',  sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name

		insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')
	END
	---------------------------------Income from Bank Withdwal--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 2 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Withdwal', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 2 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Withdwal', @total, 'Header'

	END


	---------------------------------Income from Bank Cash Collection---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Customer Collection', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Customer Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
		('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on bt.CustomerID=c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Customer Collection', @total, 'Header'

	END

	---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Supplier payment', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Supplier payment', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Supplier payment', @total, 'Header'

	END
	----------------------------------------Income from Fund IN------------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.AnotherBankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Fund IN', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.AnotherBankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Fund IN', @total, 'Header'

	END

				---------------------------------Income from Bank Expens as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Expense', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Expense', 0, B.AccountNo + ',' + B.BankName + '(Bank Expens(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Expense', @total, 'Header'

	END

---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Income', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Income', 0, B.AccountNo + ',' + B.BankName + '(Bank Income)', sum(Amount), 'Cash'

		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Income', @total, 'Header'		
END
	---------------------------------Income from Bank Loan--------------------
	set @total = ISNULL((
				SELECT SUM(BL.PrincipleLoanAmount) FROM dbo.BankLoans BL
				JOIN dbo.Banks B ON BL.BankId = B.BankID
				WHERE BL.ConcernId = @ConcernID
				AND CAST(BL.LoanDate AS DATE) = CAST(@StartDate AS DATE)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Loan', 0, 'Header'

		insert into #temp_Data2
		select @StartDate, '', 0, B.AccountNo + ',' + B.BankName, SUM(BL.PrincipleLoanAmount), 'Cash'
		FROM dbo.BankLoans BL
		JOIN dbo.Banks B ON BL.BankId = B.BankID
		where BL.ConcernID = @ConcernID
		AND CAST(BL.LoanDate AS DATE) = CAST(@StartDate AS DATE)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Loan', @total, 'Header'

	END


	-----------------------------------------------------------------------------------------------------------------------------------
	--insert into #temp_Data3
	--select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), '', 0.00,  ''
	--from #temp_Data1 T1
	--UNION ALL
	--select @StartDate, 0,  '', 0, isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
	--from #temp_Data2 T2

	insert into #temp_Data3
	select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
	from #temp_Data1 T1
	full join #temp_Data2 T2 on T1.id = T2.id

	declare @a decimal(18, 2)
	declare @b decimal(18, 2)
	declare @ExpenseWithinDate decimal(18, 2)
	declare @IncomeWithinDate decimal(18, 2)
	declare @CashInHandWithinDate decimal(18, 2)

	set @a = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @b = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @ExpenseWithinDate = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @IncomeWithinDate = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
	set @CashInHand = @CashInHand + (@b - @a)

	insert into #temp_Data3
	values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

	insert into #temp_Data3
	values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

	insert into #temp_Data3
	values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

	set @StartDate = DATEADD(DAY, 1, @StartDate)
	--select *From #temp_Data1
	--select *From #temp_Data2
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

----------COMMONSOURCE----------
----------Mostafizur--------------
----------12-03-2025------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[AddCreditSalesOrder] (
@CSalesOrder [dbo].[INSERTCREDITSALESORDERTABLE] readonly, 
@CSODetails [INSERTCSODETAILTABLE] readonly,
@CSSchedules [INSERTCSSCHEDULESTABLE] readonly,
@BankTrans [InsertBankTransTable] readonly,
@SorderID int out,
@Result int Out)
AS
DECLARE @CreditSalesId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY  
 BEGIN TRANSACTION 

-----------------Card Payment Bank Deposit--------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @CSalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

------------------Card Payment Bank Deposit--------------

INSERT INTO creditsales (invoiceno, customerid, tsalesamt, noofinstallment,
 intallmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamt, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress, ProcessingFee)
(SELECT
 invoiceno, customerid, tsalesamt, noofinstallment, 
 installmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamount, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,@BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress, ProcessingFee FROM @CSalesOrder)

UPDATE customers
SET customers.CreditDue = (customers.CreditDue + s.totaldue)
FROM @CSalesOrder s
INNER JOIN customers ON customers.customerid = s.customerid

SET @CreditSalesId = Scope_identity()

INSERT INTO CreditSaleDetails 
( 
ProductID ,UnitPrice, Quantity, UTAmount, CreditSalesID,  
MPRateTotal, MPRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,Compressor,Motor,
Panel,Spareparts,Service, Warranty
) 
( 
Select sd.ProductID ,UnitPrice, Quantity, UTAmount, @CreditSalesId CreditSalesID,  
MPRateTotal, MrpRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,p.CompressorWarrentyMonth,p.MotorWarrentyMonth,
p.PanelWarrentyMonth,p.SparePartsWarrentyMonth,p.ServiceWarrentyMonth, sd.Warranty from @CSODetails sd
join Products p on sd.ProductID=p.ProductID 
where p.ProductType!=2
) 

INSERT INTO dbo.CreditInterestHistories(InterestDate, InterestAmount, HireSaleId, IsFirstTime)
(
	SELECT salesdate, interestamount, @CreditSalesId, 1 FROM @CSalesOrder
)


	--Stock Update 
	CREATE TABLE #tmpStock (
		ProductID INT,
		ColorID INT,
		GodownID INT,
		Qty DECIMAL(18, 2)
		)

	INSERT INTO #tmpStock (
		ProductID,
		ColorID,
		GodownID,
		Qty
		) (
		SELECT s.ProductId,
		s.ColorId,
		s.Compressor,
		SUM(s.Quantity) FROM @CSODetails s 
		GROUP BY s.ProductId,
		s.ColorId,
		s.Compressor
		)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st
		ON st.ProductID = sod.ProductID AND st.ColorID = sod.ColorID AND st.GodownID = sod.GodownID

--UPDATE stocks
--SET stocks.quantity = (stocks.quantity - s.quantity)
--FROM @CSODetails s
--INNER JOIN stocks ON stocks.productid = s.productid AND stocks.colorid = s.colorid AND Stocks.GodownID=s.Compressor

UPDATE StockDetails 
SET StockDetails.Status = 2 
from @CSODetails s 
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId 
join Products on StockDetails.ProductID = Products.ProductID 
where Products.ProductType!=2 

--***************FIFO for Nobarcode Product**********************
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @CreditSaleProductsID INT
DECLARE @Quantity INT
DECLARE @SQty INT
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL
FOR
SELECT s.productid, s.colorid, s.quantity, creditsalesdetailsid
-- from   InsertCSODetailTable SOD join CreditSales SO on SO.CreditSalesID=SOD.CreditSalesID where SO.Status=1
FROM @CSODetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.stockdetailid
INNER JOIN products ON stockdetails.productid = products.productid
where Products.ProductType=2 
OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID

WHILE @@FETCH_STATUS = 0
BEGIN
	WHILE @Quantity != 0
	BEGIN
		SET @SDetailID = (
				SELECT Min(sdetailid)
				FROM stockdetails
				WHERE productid = @ProductID AND colorid = @ColorID AND quantity != 0 AND STATUS = 1
				)
		SET @SQty = (
				SELECT quantity
				FROM stockdetails
				WHERE sdetailid = @SDetailID
				)

		IF (@SQty > @Quantity)
		BEGIN
			SET @SQty = @SQty - @Quantity

			UPDATE stockdetails
			SET quantity = @SQty
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service, Warranty)
			 (SELECT sd.productid, unitprice, @Quantity,((unitprice * @Quantity) + inttotalamt), @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID  =@CreditSaleProductsID
			SET @Quantity = 0
		END
		ELSE IF (@SQty < @Quantity)
		BEGIN
			SET @Quantity = @Quantity - @SQty

			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service, Warranty)
			(SELECT sd.productid, unitprice, @SQty, ((unitprice * @SQty) + inttotalamt), @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)
				--update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
		END
		ELSE
		BEGIN
			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (
			productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate,
			 stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service,Warranty
			 ) 
			 (SELECT 
			  sd.productid, unitprice, @SQty, ((unitprice * @SQty) + inttotalamt), @CreditSalesId CreditSalesID, mpratetotal, mrprate,
			  @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, 
			  p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd 
			  INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID
			  )

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
			SET @Quantity = 0
		END
	END

	FETCH NEXT
	FROM cur
	INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID
END

INSERT INTO creditsalesschedules (monthdate, balance, installmentamt, 
paymentdate, creditsalesid, paymentstatus, interestamount, closingbalance,
 scheduleno, remarks, isunexpected, hirevalue, netvalue)
(SELECT monthdate, balance, installmentamt,
 paymentdate, @CreditSalesId CreditSalesID, paymentstatus, interestamount, closingbalance,
  scheduleno, remarks, isunexpected, hirevalue, netvalue FROM @CSSchedules)

COMMIT
--RETURN 1;
SELECT @SorderID=@CreditSalesId,@Result=1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		--RETURN 0;
	SELECT @SorderID=0,@Result=0
END CATCH

----------COMMONSOURCE----------
----------Mostafizur--------------
----------12-03-2025------------

EXEC sys.sp_rename 'dbo.InsertCreditSalesOrderTable', 'zInsertCreditSalesOrderTable';
GO

CREATE TYPE [dbo].[InsertCreditSalesOrderTable] AS TABLE(
	[InvoiceNo] [varchar](150) NULL,
	[CustomerID] [int] NULL,
	[TSalesAmt] [money] NULL,
	[NoOfInstallment] [int] NULL,
	[InstallmentPrinciple] [money] NULL,
	[IssueDate] [datetime] NULL,
	[UserName] [varchar](250) NULL,
	[Remaining] [money] NULL,
	[InterestRate] [decimal](6, 2) NULL,
	[InterestAmount] [decimal](18, 2) NULL,
	[SalesDate] [datetime] NULL,
	[DownPayment] [money] NULL,
	[WInterestAmt] [money] NULL,
	[FixedAmount] [money] NULL,
	[IsStatus] [int] NULL,
	[UnExInstallment] [int] NULL,
	[Quantity] [int] NULL,
	[Discount] [money] NULL,
	[NetAmount] [money] NULL,
	[IsUnExpected] [bit] NULL,
	[Remarks] [varchar](max) NULL,
	[Status] [bit] NULL,
	[VatPercentage] [decimal](18, 2) NULL,
	[VatAmount] [decimal](18, 2) NULL,
	[TotalDue] [money] NULL,
	[ConcernId] [int] NULL,
	[CreatedBy] [int] NULL,
	[CreateDate] [datetime] NULL,
	[TotalOffer] [decimal](18, 2) NULL,
	[InstallmentPeriod] [varchar](max) NULL,
	[CardPaidAmount] [decimal](18, 2) NULL,
	[CardTypeSetupID] [int] NULL,
	[DepositChargePercent] [decimal](18, 2) NULL,
	[IsWeekly] [int] NOT NULL,
	[GuarName] [varchar](max) NULL,
	[GuarContactNo] [varchar](max) NULL,
	[GuarAddress] [varchar](max) NULL,
	[ProcessingFee] [decimal](18, 2) NULL
)
GO

DECLARE @Name NVARCHAR(776);

DECLARE REF_CURSOR CURSOR FOR
SELECT referencing_schema_name + '.' + referencing_entity_name
FROM sys.dm_sql_referencing_entities('dbo.InsertCreditSalesOrderTable', 'TYPE');

OPEN REF_CURSOR;

FETCH NEXT FROM REF_CURSOR INTO @Name;
WHILE (@@FETCH_STATUS = 0)
BEGIN
    EXEC sys.sp_refreshsqlmodule @name = @Name;
    FETCH NEXT FROM REF_CURSOR INTO @Name;
END;

CLOSE REF_CURSOR;
DEALLOCATE REF_CURSOR;
GO
DROP TYPE dbo.zInsertCreditSalesOrderTable;
GO




----------COMMONSOURCE----------
----------Mostafizur--------------
----------12-03-2025------------

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.CreditSales ADD
	ProcessingFee decimal(18, 2) NOT NULL CONSTRAINT DF_CreditSales_ProcessingFee DEFAULT ((0))
GO
ALTER TABLE dbo.CreditSales SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

----------COMMONSOURCE----------
-------------Nahid--------------
----------10-03-2025------------


ALTER PROCEDURE [dbo].[AddCreditSalesOrder] (
@CSalesOrder [dbo].[INSERTCREDITSALESORDERTABLE] readonly, 
@CSODetails [INSERTCSODETAILTABLE] readonly,
@CSSchedules [INSERTCSSCHEDULESTABLE] readonly,
@BankTrans [InsertBankTransTable] readonly,
@SorderID int out,
@Result int Out)
AS
DECLARE @CreditSalesId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY  
 BEGIN TRANSACTION 

-----------------Card Payment Bank Deposit--------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @CSalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

------------------Card Payment Bank Deposit--------------

INSERT INTO creditsales (invoiceno, customerid, tsalesamt, noofinstallment,
 intallmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamt, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress)
(SELECT
 invoiceno, customerid, tsalesamt, noofinstallment, 
 installmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamount, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,@BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress FROM @CSalesOrder)

UPDATE customers
SET customers.CreditDue = (customers.CreditDue + s.totaldue)
FROM @CSalesOrder s
INNER JOIN customers ON customers.customerid = s.customerid

SET @CreditSalesId = Scope_identity()

INSERT INTO CreditSaleDetails 
( 
ProductID ,UnitPrice, Quantity, UTAmount, CreditSalesID,  
MPRateTotal, MPRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,Compressor,Motor,
Panel,Spareparts,Service, Warranty
) 
( 
Select sd.ProductID ,UnitPrice, Quantity, UTAmount, @CreditSalesId CreditSalesID,  
MPRateTotal, MrpRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,p.CompressorWarrentyMonth,p.MotorWarrentyMonth,
p.PanelWarrentyMonth,p.SparePartsWarrentyMonth,p.ServiceWarrentyMonth, sd.Warranty from @CSODetails sd
join Products p on sd.ProductID=p.ProductID 
where p.ProductType!=2
) 

INSERT INTO dbo.CreditInterestHistories(InterestDate, InterestAmount, HireSaleId, IsFirstTime)
(
	SELECT salesdate, interestamount, @CreditSalesId, 1 FROM @CSalesOrder
)


	--Stock Update 
	CREATE TABLE #tmpStock (
		ProductID INT,
		ColorID INT,
		GodownID INT,
		Qty DECIMAL(18, 2)
		)

	INSERT INTO #tmpStock (
		ProductID,
		ColorID,
		GodownID,
		Qty
		) (
		SELECT s.ProductId,
		s.ColorId,
		s.Compressor,
		SUM(s.Quantity) FROM @CSODetails s 
		GROUP BY s.ProductId,
		s.ColorId,
		s.Compressor
		)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st
		ON st.ProductID = sod.ProductID AND st.ColorID = sod.ColorID AND st.GodownID = sod.GodownID

--UPDATE stocks
--SET stocks.quantity = (stocks.quantity - s.quantity)
--FROM @CSODetails s
--INNER JOIN stocks ON stocks.productid = s.productid AND stocks.colorid = s.colorid AND Stocks.GodownID=s.Compressor

UPDATE StockDetails 
SET StockDetails.Status = 2 
from @CSODetails s 
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId 
join Products on StockDetails.ProductID = Products.ProductID 
where Products.ProductType!=2 

--***************FIFO for Nobarcode Product**********************
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @CreditSaleProductsID INT
DECLARE @Quantity INT
DECLARE @SQty INT
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL
FOR
SELECT s.productid, s.colorid, s.quantity, creditsalesdetailsid
-- from   InsertCSODetailTable SOD join CreditSales SO on SO.CreditSalesID=SOD.CreditSalesID where SO.Status=1
FROM @CSODetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.stockdetailid
INNER JOIN products ON stockdetails.productid = products.productid
where Products.ProductType=2 
OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID

WHILE @@FETCH_STATUS = 0
BEGIN
	WHILE @Quantity != 0
	BEGIN
		SET @SDetailID = (
				SELECT Min(sdetailid)
				FROM stockdetails
				WHERE productid = @ProductID AND colorid = @ColorID AND quantity != 0 AND STATUS = 1
				)
		SET @SQty = (
				SELECT quantity
				FROM stockdetails
				WHERE sdetailid = @SDetailID
				)

		IF (@SQty > @Quantity)
		BEGIN
			SET @SQty = @SQty - @Quantity

			UPDATE stockdetails
			SET quantity = @SQty
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service, Warranty)
			 (SELECT sd.productid, unitprice, @Quantity,((unitprice * @Quantity) + inttotalamt), @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID  =@CreditSaleProductsID
			SET @Quantity = 0
		END
		ELSE IF (@SQty < @Quantity)
		BEGIN
			SET @Quantity = @Quantity - @SQty

			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service, Warranty)
			(SELECT sd.productid, unitprice, @SQty, ((unitprice * @SQty) + inttotalamt), @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)
				--update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
		END
		ELSE
		BEGIN
			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (
			productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate,
			 stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service,Warranty
			 ) 
			 (SELECT 
			  sd.productid, unitprice, @SQty, ((unitprice * @SQty) + inttotalamt), @CreditSalesId CreditSalesID, mpratetotal, mrprate,
			  @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, 
			  p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd 
			  INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID
			  )

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
			SET @Quantity = 0
		END
	END

	FETCH NEXT
	FROM cur
	INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID
END

INSERT INTO creditsalesschedules (monthdate, balance, installmentamt, 
paymentdate, creditsalesid, paymentstatus, interestamount, closingbalance,
 scheduleno, remarks, isunexpected, hirevalue, netvalue)
(SELECT monthdate, balance, installmentamt,
 paymentdate, @CreditSalesId CreditSalesID, paymentstatus, interestamount, closingbalance,
  scheduleno, remarks, isunexpected, hirevalue, netvalue FROM @CSSchedules)

COMMIT
--RETURN 1;
SELECT @SorderID=@CreditSalesId,@Result=1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		--RETURN 0;
	SELECT @SorderID=0,@Result=0
END CATCH


------------------------------------
-------Date: 8-03-2025-------------
---------------Rizve----------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.Customers ADD
	profession nvarchar(MAX) NULL
GO
ALTER TABLE dbo.Customers SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
------------------------------------
-------Date: 23-02-2025-------------
---------------Rizve----------------

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	isposinvoice int NOT NULL CONSTRAINT DF_SystemInformations_isposinvoice DEFAULT 0,
	isposmoneyrecipt int NOT NULL CONSTRAINT DF_SystemInformations_isposmoneyrecipt DEFAULT 0
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
----------GadgetHouse----------
-------------Rizve--------------
----------24-02-2025------------

ALTER PROC [dbo].[sp_SOAddReplacementOrder]
(
    @SalesOrder [InsertReplaceOrderTable] readonly,
    @SODetails [InsertRODetailTable] readonly,
	@PurchaseOrder [InsertPurchaseOrderTable] readonly,
	@PODetails [InsertPODetailTable] readonly,
	@POProductDetails [InsertReturnPOProductDetailTable] readonly,
	@OutPOrderID INT OUTPUT
)
AS
DECLARE @SalesOrderId INT;
DECLARE @ProductType INT;
DECLARE @Quantity DECIMAL(18, 2);
DECLARE @StockDetailId INT;
DECLARE @PurchaseOrderId int

BEGIN TRY
    BEGIN TRANSACTION;

    -- Insert into SOrders
    INSERT INTO SOrders
    (
        InvoiceDate, InvoiceNo, CustomerID, VATPercentage, VATAmount, GrandTotal, TDPercentage, TDAmount, NetDiscount,
        TotalAmount, PaymentDue, RecAmount, AdjAmount, TotalDue, Status, ConcernID, CreatedBy, CreateDate, TotalOffer, IsReplacement
    )
    SELECT InvoiceDate, InvoiceNo, CustomerID, VATPercentage, VATAmount, GrandTotal, TDiscountPercentage, TDiscountAmount, NetDiscount,
           TotalAmount, PaymentDue, RecAmt, AdjAmount, TotalDue, Status, ConcernID, CreatedBy, CreateDate, TotalOffer, IsReplacement
    FROM @SalesOrder;

    -- Update Customer's TotalDue
    UPDATE Customers
    SET Customers.TotalDue = (Customers.TotalDue + s.TotalDue)
    FROM @SalesOrder s
    JOIN Customers ON Customers.CustomerID = s.CustomerID;

    -- Capture the new SalesOrderId
    SET @SalesOrderId = SCOPE_IDENTITY();

    -- Update SOrderDetails with the new values
    UPDATE SOrderDetails
    SET RStockDetailId = s.RStockDetailId,
        RepOrderID = @SalesOrderId,
        RepUnitPrice = s.UnitPrice,
        Remarks = s.Remarks,
        RQuantity = (RQuantity + s.Quantity),
        ReplaceProductType = s.IsDamage
    FROM @SODetails s
    JOIN SOrderDetails SOD ON SOD.SDetailID = s.StockDetailId
    JOIN SOrders SO ON SOD.SOrderID = SO.SOrderID
    WHERE SOD.SDetailId IN (SELECT StockDetailId FROM @SODetails)
      AND SO.Status != 4
      AND SOD.IsProductReturn != 1 AND sod.SOrderDetailID = s.dSOrderDetailID;

    -- Insert new SOrderDetails
    INSERT INTO SOrderDetails
    (
        ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, PPDAmount, MPRate, SOrderID, SDetailID, PPOffer, Remarks
    )
    SELECT ProductId, Quantity, UnitPrice, TAmount, PPDisPer, PPDisAmt, MrpRate, @SalesOrderId SOrderID, RStockDetailId, PPOffer, Remarks
    FROM @SODetails;

    -- Stock Decrease for New Product
    UPDATE Stocks
    SET Stocks.Quantity = (Stocks.Quantity - s.Quantity)
    FROM @SODetails s
    JOIN Stocks ON Stocks.ProductID = s.ProductId AND Stocks.ColorID = s.ColorId;

UPDATE StockDetails
SET StockDetails.Status = 2
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.RStockDetailId
INNER JOIN Products ON Products.ProductID = StockDetails.ProductID
WHERE Products.ProductType !=2

UPDATE StockDetails
SET StockDetails.Quantity = (StockDetails.Quantity - s.Quantity)
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.RStockDetailId
INNER JOIN Products ON Products.ProductID = StockDetails.ProductID
WHERE Products.ProductType = 2

UPDATE StockDetails
SET StockDetails.Status = 2
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.RStockDetailId
INNER JOIN Products ON Products.ProductID = StockDetails.ProductID
WHERE Products.ProductType = 2 AND StockDetails.Quantity = 0


INSERT INTO POrders
(
OrderDate, ChallanNo, SupplierID, GrandTotal, TDiscount, TotalAmt, AdjAmount, RecAmt, PaymentDue, TotalDue,
Status, PPDisAmt, NetDiscount, LaborCost, ConcernID, CreateDate, CreatedBy,IsDamageOrder,Remarks, SORepId
)
(
Select OrderDate, ChallanNo, SupplierID, GrandTotal, TDiscount, TotalAmt, AdjAmount, RecAmt, PaymentDue, TotalDue,
Status, PPTDisAmt, NetDiscount, LabourCost, ConcernID, CreateDate, CreatedBy,IsDamageOrder, Remarks, @SalesOrderId from @PurchaseOrder)

UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - p.TotalAmt)
from @PurchaseOrder p
JOIN Suppliers ON Suppliers.SupplierID = p.SupplierId
where p.IsDamageOrder!=1

SET @PurchaseOrderId = SCOPE_IDENTITY()


INSERT INTO POrderDetails
(
ProductID, ColorID, Quantity, UnitPrice, TAmount, PPDISPer, PPDISAmt, MRPRate, POrderID,SalesRate,ExtraPPDISPer,ExtraPPDISAmt,PPOFFER,CreditSalesRate,GodownID
)
(
Select ProductId, ColorId, Quantity, UnitPrice, TAmount,  PPDisPer,
PPDisAmt, MrpRate, @PurchaseOrderId POrderID,SalesRate,ExtraPPDISPer,ExtraPPDISAmt,PPOffer,CreditSalesRate,GodownId  from @PODetails)

INSERT INTO POProductDetails
(
ProductID, ColorID, IMENO, POrderDetailID,ReturnSDetailID,ReturnQty
)
(
Select POPD.ProductId, POPD.ColorId, POPD.IMENo, POD.POrderDetailID,POPD.ReturnSDetailID,POPD.ReturnQty from @POProductDetails POPD
INNER JOIN POrderDetails POD ON POD.ProductID = POPD.ProductId AND POD.ColorID = POPD.ColorId AND POD.POrderID = @PurchaseOrderId
)



    --**************************************************************
    --*********************not damage*******************************
    UPDATE Stocks
    SET Stocks.Quantity = (Stocks.Quantity + s.Quantity)
    FROM @SODetails s
    JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
    JOIN Stocks ON Stocks.StockID = StockDetails.StockID
    WHERE s.IsDamage = 2;

    UPDATE StockDetails
    SET StockDetails.Quantity = (StockDetails.Quantity + s.Quantity), StockDetails.Status = 1
    FROM @SODetails s
    JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
    WHERE s.IsDamage = 2;

    --**************************************************************
    --*********************damage***********************************
    -- Cursor to handle damaged products
    --DECLARE cur_damaged CURSOR LOCAL FOR
    --SELECT p.ProductType, s.Quantity, s.StockDetailId
    --FROM @SODetails s
    --JOIN Products p ON s.ProductId = p.ProductID
    --WHERE s.IsDamage = 1;

    --OPEN cur_damaged;

    --FETCH NEXT FROM cur_damaged INTO @ProductType, @Quantity, @StockDetailId;

    --WHILE @@FETCH_STATUS = 0
    --BEGIN
    --    IF (@ProductType = 2) -- No Barcode Product
    --    BEGIN
    --        -- Insert a new row with Status = 4 for the damaged product
    --        INSERT INTO StockDetails
    --        (
    --            StockCode, ProductID, IMENO, StockID, Status, ColorID, POrderDetailID, PRate, SRate, CreditSRate, 
    --            CRSalesRate12Month, CRSalesRate3Month, Quantity, GodownID, TransferDetailID, UsedStockStatus, UsedSaleRate, UsedPurchaseRate
    --        )
    --        SELECT StockCode, ProductID, IMENO, StockID, 4, ColorID, POrderDetailID, PRate, SRate, CreditSRate, 
    --               CRSalesRate12Month, CRSalesRate3Month, @Quantity, GodownID, TransferDetailID, UsedStockStatus, UsedSaleRate, UsedPurchaseRate
    --        FROM StockDetails
    --        WHERE SDetailID = @StockDetailId;

           
    --    END
    --    ELSE
    --    BEGIN
    --        -- For other product types, just update the status to 4
    --        UPDATE StockDetails
    --        SET StockDetails.Status = 4
    --        WHERE StockDetails.SDetailID = @StockDetailId;
    --    END;

    --    FETCH NEXT FROM cur_damaged INTO @ProductType, @Quantity, @StockDetailId;
    --END;

    ---- Close and deallocate cursor
    --CLOSE cur_damaged;
    --DEALLOCATE cur_damaged;

    -- Update the status in SRVProductDetails for damaged products
    UPDATE SRVProductDetails
    SET SRVProductDetails.Status = 2
    FROM @SODetails s
    JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.RStockDetailId
    WHERE SRVProductDetails.Status = 1;

    COMMIT

    RETURN 1;
	SET @OutPOrderID=@PurchaseOrderId

END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK

    RETURN 0;
	SET @OutPOrderID=0
END CATCH
GO


----------COMMONSOURCE----------
-------------Rizve--------------
----------20-01-2025------------

BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.POrders ADD
	SORepId int NOT NULL CONSTRAINT DF_POrders_SORepId DEFAULT 0
GO
ALTER TABLE dbo.POrders SET (LOCK_ESCALATION = TABLE)
GO
COMMIT



=============================================================================================================================

/****** Object:  StoredProcedure [dbo].[sp_SOAddReplacementOrder]    Script Date: 25/01/2025 08:59:54 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER PROC [dbo].[sp_SOAddReplacementOrder]
(
    @SalesOrder [InsertReplaceOrderTable] readonly,
    @SODetails [InsertRODetailTable] readonly,
	@PurchaseOrder [InsertPurchaseOrderTable] readonly,
	@PODetails [InsertPODetailTable] readonly,
	@POProductDetails [InsertReturnPOProductDetailTable] readonly,
	@OutPOrderID INT OUTPUT
)
AS
DECLARE @SalesOrderId INT;
DECLARE @ProductType INT;
DECLARE @Quantity DECIMAL(18, 2);
DECLARE @StockDetailId INT;
DECLARE @PurchaseOrderId int

BEGIN TRY
    BEGIN TRANSACTION;

    -- Insert into SOrders
    INSERT INTO SOrders
    (
        InvoiceDate, InvoiceNo, CustomerID, VATPercentage, VATAmount, GrandTotal, TDPercentage, TDAmount, NetDiscount,
        TotalAmount, PaymentDue, RecAmount, AdjAmount, TotalDue, Status, ConcernID, CreatedBy, CreateDate, TotalOffer, IsReplacement
    )
    SELECT InvoiceDate, InvoiceNo, CustomerID, VATPercentage, VATAmount, GrandTotal, TDiscountPercentage, TDiscountAmount, NetDiscount,
           TotalAmount, PaymentDue, RecAmt, AdjAmount, TotalDue, Status, ConcernID, CreatedBy, CreateDate, TotalOffer, IsReplacement
    FROM @SalesOrder;

    -- Update Customer's TotalDue
    UPDATE Customers
    SET Customers.TotalDue = (Customers.TotalDue + s.TotalDue)
    FROM @SalesOrder s
    JOIN Customers ON Customers.CustomerID = s.CustomerID;

    -- Capture the new SalesOrderId
    SET @SalesOrderId = SCOPE_IDENTITY();

    -- Update SOrderDetails with the new values
    UPDATE SOrderDetails
    SET RStockDetailId = s.RStockDetailId,
        RepOrderID = @SalesOrderId,
        RepUnitPrice = s.UnitPrice,
        Remarks = s.Remarks,
        RQuantity = (RQuantity + s.Quantity),
        ReplaceProductType = s.IsDamage
    FROM @SODetails s
    JOIN SOrderDetails SOD ON SOD.SDetailID = s.StockDetailId
    JOIN SOrders SO ON SOD.SOrderID = SO.SOrderID
    WHERE SOD.SDetailId IN (SELECT StockDetailId FROM @SODetails)
      AND SO.Status != 4
      AND SOD.IsProductReturn != 1 AND sod.SOrderDetailID = s.dSOrderDetailID;

    -- Insert new SOrderDetails
    INSERT INTO SOrderDetails
    (
        ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, PPDAmount, MPRate, SOrderID, SDetailID, PPOffer, Remarks
    )
    SELECT ProductId, Quantity, UnitPrice, TAmount, PPDisPer, PPDisAmt, MrpRate, @SalesOrderId SOrderID, RStockDetailId, PPOffer, Remarks
    FROM @SODetails;

    -- Stock Decrease for New Product
    UPDATE Stocks
    SET Stocks.Quantity = (Stocks.Quantity - s.Quantity)
    FROM @SODetails s
    JOIN Stocks ON Stocks.ProductID = s.ProductId AND Stocks.ColorID = s.ColorId;

UPDATE StockDetails
SET StockDetails.Status = 2
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.RStockDetailId
INNER JOIN Products ON Products.ProductID = StockDetails.ProductID
WHERE Products.ProductType !=2

UPDATE StockDetails
SET StockDetails.Quantity = (StockDetails.Quantity - s.Quantity)
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.RStockDetailId
INNER JOIN Products ON Products.ProductID = StockDetails.ProductID
WHERE Products.ProductType = 2

UPDATE StockDetails
SET StockDetails.Status = 2
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.RStockDetailId
INNER JOIN Products ON Products.ProductID = StockDetails.ProductID
WHERE Products.ProductType = 2 AND StockDetails.Quantity = 0


INSERT INTO POrders
(
OrderDate, ChallanNo, SupplierID, GrandTotal, TDiscount, TotalAmt, AdjAmount, RecAmt, PaymentDue, TotalDue,
Status, PPDisAmt, NetDiscount, LaborCost, ConcernID, CreateDate, CreatedBy,IsDamageOrder,Remarks, SORepId
)
(
Select OrderDate, ChallanNo, SupplierID, GrandTotal, TDiscount, TotalAmt, AdjAmount, RecAmt, PaymentDue, TotalDue,
Status, PPTDisAmt, NetDiscount, LabourCost, ConcernID, CreateDate, CreatedBy,IsDamageOrder, Remarks, @SalesOrderId from @PurchaseOrder)

UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - p.TotalAmt)
from @PurchaseOrder p
JOIN Suppliers ON Suppliers.SupplierID = p.SupplierId
where p.IsDamageOrder!=1

SET @PurchaseOrderId = SCOPE_IDENTITY()


INSERT INTO POrderDetails
(
ProductID, ColorID, Quantity, UnitPrice, TAmount, PPDISPer, PPDISAmt, MRPRate, POrderID,SalesRate,ExtraPPDISPer,ExtraPPDISAmt,PPOFFER,CreditSalesRate,GodownID
)
(
Select ProductId, ColorId, Quantity, UnitPrice, TAmount,  PPDisPer,
PPDisAmt, MrpRate, @PurchaseOrderId POrderID,SalesRate,ExtraPPDISPer,ExtraPPDISAmt,PPOffer,CreditSalesRate,GodownId  from @PODetails)

INSERT INTO POProductDetails
(
ProductID, ColorID, IMENO, POrderDetailID,ReturnSDetailID,ReturnQty
)
(
Select POPD.ProductId, POPD.ColorId, POPD.IMENo, POD.POrderDetailID,POPD.ReturnSDetailID,POPD.ReturnQty from @POProductDetails POPD
INNER JOIN POrderDetails POD ON POD.ProductID = POPD.ProductId AND POD.ColorID = POPD.ColorId AND POD.POrderID = @PurchaseOrderId
)



    --**************************************************************
    --*********************not damage*******************************
    UPDATE Stocks
    SET Stocks.Quantity = (Stocks.Quantity + s.Quantity)
    FROM @SODetails s
    JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
    JOIN Stocks ON Stocks.StockID = StockDetails.StockID
    WHERE s.IsDamage = 2;

    UPDATE StockDetails
    SET StockDetails.Quantity = (StockDetails.Quantity + s.Quantity), StockDetails.Status = 1
    FROM @SODetails s
    JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
    WHERE s.IsDamage = 2;

    --**************************************************************
    --*********************damage***********************************
    -- Cursor to handle damaged products
    DECLARE cur_damaged CURSOR LOCAL FOR
    SELECT p.ProductType, s.Quantity, s.StockDetailId
    FROM @SODetails s
    JOIN Products p ON s.ProductId = p.ProductID
    WHERE s.IsDamage = 1;

    OPEN cur_damaged;

    FETCH NEXT FROM cur_damaged INTO @ProductType, @Quantity, @StockDetailId;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        IF (@ProductType = 2) -- No Barcode Product
        BEGIN
            -- Insert a new row with Status = 4 for the damaged product
            INSERT INTO StockDetails
            (
                StockCode, ProductID, IMENO, StockID, Status, ColorID, POrderDetailID, PRate, SRate, CreditSRate, 
                CRSalesRate12Month, CRSalesRate3Month, Quantity, GodownID, TransferDetailID, UsedStockStatus, UsedSaleRate, UsedPurchaseRate
            )
            SELECT StockCode, ProductID, IMENO, StockID, 4, ColorID, POrderDetailID, PRate, SRate, CreditSRate, 
                   CRSalesRate12Month, CRSalesRate3Month, @Quantity, GodownID, TransferDetailID, UsedStockStatus, UsedSaleRate, UsedPurchaseRate
            FROM StockDetails
            WHERE SDetailID = @StockDetailId;

           
        END
        ELSE
        BEGIN
            -- For other product types, just update the status to 4
            UPDATE StockDetails
            SET StockDetails.Status = 4
            WHERE StockDetails.SDetailID = @StockDetailId;
        END;

        FETCH NEXT FROM cur_damaged INTO @ProductType, @Quantity, @StockDetailId;
    END;

    -- Close and deallocate cursor
    CLOSE cur_damaged;
    DEALLOCATE cur_damaged;

    -- Update the status in SRVProductDetails for damaged products
    UPDATE SRVProductDetails
    SET SRVProductDetails.Status = 2
    FROM @SODetails s
    JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.RStockDetailId
    WHERE SRVProductDetails.Status = 1;

    COMMIT

    RETURN 1;
	SET @OutPOrderID=@PurchaseOrderId

END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK

    RETURN 0;
	SET @OutPOrderID=0
END CATCH
GO









----------COMMONSOURCE----------
-------------Nahid--------------
----------03-02-2025------------

ALTER TABLE dbo.ShareInvestmentHeads ADD
	OpeningDate datetime NULL
GO
------------------------------------------------------------------------------------------------------------------

UPDATE ShareInvestmentHeads Set OpeningDate = CreateDate

------------------------------------------------------------------------------------------------------------------


ALTER PROCEDURE [dbo].[sp_ProductWiseBenefitReport] (
	@Fromdate DATETIME,
	@ToDate DATETIME,
	@ConcernID INT
	)
AS
WITH Final_table
AS (
	SELECT P.Code,
		P.ProductID,
		P.ProductName,
		SO.InvoiceDate AS 'SalesDate',
		C.Description AS 'CategoryName',
		STD.IMENO,
		CUS.CustomerID,
		(((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity AS 'SalesTotal',
		(SOD.PPDAmount + (((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity AS 'Discount',
		(SOD.PRate * SOD.Quantity) AS 'PurchaseTotal',
		((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity) - (SOD.PRate* SOD.Quantity) AS 'CommisionProfit',
		0.00 AS 'HireProfit',
		0.00 AS 'HireCollection',
		((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity) - (SOD.PRate * SOD.Quantity) AS 'TotalProfit'
	FROM SOrderDetails SOD
	INNER JOIN SOrders SO ON SOD.SOrderID = SO.SOrderID
	INNER JOIN StockDetails STD ON STD.SDetailID = SOD.SDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	INNER JOIN Customers CUS ON CUS.CustomerID = SO.CustomerID
	WHERE SO.STATUS = 1 ANd SO.IsReplacement = 0 AND SO.InvoiceDate >= @Fromdate AND SO.InvoiceDate <= @ToDate AND SO.ConcernID = @ConcernID
	
	UNION ALL
	
	SELECT P.Code,
		P.ProductID,
		P.ProductName,
		SO.ReturnDate AS 'SalesDate',
		C.Description AS 'CategoryName',
		STD.IMENO,
		CUS.CustomerID,
		(SOD.UnitPrice* SOD.Quantity) * (-1) AS 'SalesTotal',
		0 AS 'Discount',
		(STD.PRate * SOD.Quantity) * ( -1) AS 'PurchaseTotal',
		((SOD.UnitPrice* SOD.Quantity) - (STD.PRate*SOD.Quantity ))* -1 AS 'CommisionProfit',
		0.00 AS 'HireProfit',
		0.00 AS 'HireCollection',
		((SOD.UnitPrice* SOD.Quantity) - (STD.PRate*SOD.Quantity ))* -1 AS 'TotalProfit'
	FROM ROrderDetails SOD
	INNER JOIN ROrders SO ON SOD.ROrderID = SO.ROrderID
	INNER JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	INNER JOIN Customers CUS ON CUS.CustomerID = SO.CustomerID
	WHERE SO.ReturnDate >= @Fromdate AND SO.ReturnDate <= @ToDate AND SO.ConcernID = @ConcernID
	
	UNION ALL
	
	SELECT p.Code,
		P.ProductID,
		P.ProductName,
		CS.SalesDate AS 'SalesDate',
		C.Description AS 'CategoryName',
		STD.IMENO,
		CUS.CustomerID,
		(((CSP.UnitPrice+CSP.IntTotalAmt)-((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt)) * CSP.Quantity) AS 'SalesTotal',
		((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt) * CSP.Quantity AS 'Discount',
		STD.PRate * CSP.Quantity AS 'PurchaseTotal',
		(((CSP.UnitPrice)-((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt)) * CSP.Quantity) - (STD.PRate * CSP.Quantity) AS 'CommisionProfit',
		(CSP.IntTotalAmt * CSP.Quantity) AS 'HireProfit',
		0 AS 'HireCollection',
		0 AS 'TotalProfit'
	FROM CreditSaleDetails CSP
	INNER JOIN CreditSales CS ON CS.CreditSalesID = CSP.CreditSalesID
	INNER JOIN StockDetails STD ON STD.SDetailID = CSP.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	INNER JOIN Customers CUS ON CUS.CustomerID = CS.CustomerID
	WHERE CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.IsStatus=1
	
	UNION ALL
	
	SELECT P.Code,
		P.ProductID,
		P.ProductName,	
		CS.SalesDate AS 'SalesDate',
		C.Description AS 'CategoryName',
		Std.IMENO,
		CUS.CustomerID,
		0 AS 'SalesTotal',
		0 AS 'Discount',
		0 AS 'PurchaseTotal',
		0 AS 'CommisionProfit',
		0 AS 'HireProfit',
		SUM(HireValue) AS 'HireCollection',
		SUM(HireValue) AS 'TotalProfit'
	FROM CreditSales CS
	INNER JOIN CreditSaleDetails CSP ON CSP.CreditSalesID = CS.CreditSalesID
	INNER JOIN CreditSalesSchedules CSD ON CSD.CreditSalesID = CS.CreditSalesID
	INNER JOIN StockDetails STD ON STD.SDetailID = CSP.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	INNER JOIN Customers CUS ON CUS.CustomerID = CS.CustomerID
	WHERE CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID AND CS.IsStatus=1
	GROUP BY P.Code,
		P.ProductID,
		P.ProductName,
		CS.SalesDate,
		C.Description,
		Std.IMENO,
		CUS.CustomerID
	)
SELECT Code,
	ProductID,
	ProductName,
	SalesDate,
	CategoryName,
	IMENO,
	CustomerID,
	sum(SalesTotal + Discount) AS 'SalesTotal',
	sum(Discount) AS 'Discount',
	sum(SalesTotal) AS 'NetSales',
	sum(PurchaseTotal) AS 'PurchaseTotal',
	sum(CommisionProfit) AS 'CommisionProfit',
	sum(HireProfit) AS 'HireProfit',
	sum(HireCollection) AS 'HireCollection',
	sum(CommisionProfit) + sum(HireCollection) AS 'TotalProfit'
FROM Final_table
GROUP BY Code,
	ProductID,
	ProductName,
	SalesDate,
	CategoryName,
	IMENO,
	CustomerID

----------COMMONSOURCE----------
-------------Nahid--------------
----------01-02-2025------------


ALTER FUNCTION [dbo].[CheckProductStatusByPOId]
(
  @PurchaseOrderId int
)  
  RETURNS int
AS 
 BEGIN
	DECLARE	@Sold int
    
    SELECT @Sold = COUNT(*)
	FROM StockDetails
	JOIN POrderDetails POD ON POD.POrderDetailID = StockDetails.POrderDetailID 
	join POrders PO on POD.POrderID = PO.POrderID
	JOIN SOrderDetails sod on sod.SDetailID = StockDetails.SDetailID
	join Products p on POD.ProductID = p.ProductID
	WHERE p.ProductType <> 2 AND POD.POrderID = @PurchaseOrderId
	
	--IF @Sold IS NULL
	--  SET @Sold=0

	IF @Sold IS NULL OR @Sold = 0
		begin
			SET @Sold=0

			set @Sold =  (select ISNULL(COUNT(*), 0) FROM StockDetails sd
			JOIN POrderDetails POD ON POD.POrderDetailID = sd.POrderDetailID 
			join POrders PO on POD.POrderID = PO.POrderID
			JOIN SOrderDetails sod on sod.SDetailID = sd.SDetailID
			join Products p on POD.ProductID = p.ProductID
			WHERE p.ProductType = 2 and POD.POrderID = @PurchaseOrderId)
			--and POD.Quantity != sd.Quantity


		end
	  
	RETURN@Sold
END

-------------------------------------------------------------------------------------------------------------------


ALTER FUNCTION [dbo].[CheckHireSalesProductStatusByPOId]
(
  @PurchaseOrderId int
)  
  RETURNS int
AS 
 BEGIN
	DECLARE	@Sold int
    
    SELECT @Sold = COUNT(*)
	FROM StockDetails
	JOIN POrderDetails POD ON POD.POrderDetailID = StockDetails.POrderDetailID 
	join POrders PO on POD.POrderID = PO.POrderID
	JOIN CreditSaleDetails sod on sod.StockDetailID = StockDetails.SDetailID
	join Products p on POD.ProductID = p.ProductID
	WHERE p.ProductType <> 2 AND POD.POrderID = @PurchaseOrderId
	
	--IF @Sold IS NULL
	--  SET @Sold=0

	IF @Sold IS NULL OR @Sold = 0
		begin
			SET @Sold=0

			set @Sold =  (select ISNULL(COUNT(*), 0) FROM StockDetails sd
			JOIN POrderDetails POD ON POD.POrderDetailID = sd.POrderDetailID 
			join POrders PO on POD.POrderID = PO.POrderID
			JOIN CreditSaleDetails sod on sod.StockDetailID = sd.SDetailID
			join Products p on POD.ProductID = p.ProductID
			WHERE p.ProductType = 2 and POD.POrderID = @PurchaseOrderId)
			--and POD.Quantity != sd.Quantity


		end
	  
	RETURN@Sold
END


----------COMMONSOURCE----------
-------------Nahid--------------
----------27-01-2025------------


ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = s.TSQty,
		ActionStatus = ActionStatus + 1
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	Create Table #tmpStock3(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)



	--Stock out
	delete #tmpStock

 --   INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	--(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	--where  s.Status = 3 OR s.Status = 4
	--group by s.ProductId,s.ColorId,s.Compressor
	--)

	--DECLARE @prevQty DECIMAL(18,2) = (SELECT ISNULL(SUM(s.Quantity), 0) FROM @SODetails s
	--INNER JOIN Products P On s.ProductId = p.ProductID
	--WHERE s.Status = 4 AND p.ProductType !=2)

	--UPDATE st
	--SET st.Quantity = ((st.Quantity - sod.Qty) + @prevQty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	--FROM #tmpStock sod
	--INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--INNER JOIN Products p ON p.ProductID = st.ProductID
	--where p.ProductType !=2

	--UPDATE st
	--SET st.Quantity = ((st.Quantity - sod.Qty)),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	--FROM #tmpStock sod
	--INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--INNER JOIN Products p ON p.ProductID = st.ProductID
	--where p.ProductType =2

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	JOIN Products p on s.ProductID=p.ProductID 
	where s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	INSERT INTO #tmpStock3(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty + sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType !=2

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock3 sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType !=2

	UPDATE st
	SET st.Quantity = ((st.Quantity - sod.Qty)),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType =2

	UPDATE st
	SET st.Quantity = ((st.Quantity - sod.Qty)),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock3 sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType =2

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	
-- For No barcode Stock Details out and SOrderDetails Insert
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @GodownID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @SOrderDetailID INT
DECLARE @Quantity decimal(18,2)
DECLARE @StockQty decimal(18,2)
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL FOR
SELECT s.ProductId,
       s.colorid,
       s.Compressor,
       s.quantity,
       sorderdetailid
FROM @SODetails s
JOIN products ON products.productid = s.productid
WHERE products.ProductType = 2 AND s.Status = 3

OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID,
     @ColorID,
     @GodownID,
     @Quantity,
     @SOrderDetailID

WHILE @@FETCH_STATUS = 0
BEGIN
    WHILE (@Quantity != 0)
    BEGIN
        -- Get the first available stock detail
        SET @SDetailID = (
            SELECT MIN(SDetailID)
            FROM stockdetails
            WHERE productid = @ProductID AND colorid = @ColorID
            AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
        )

        -- Get the stock quantity
        SET @StockQty = (
            SELECT quantity
            FROM stockdetails
            WHERE sdetailid = @SDetailID
        )

        IF (@StockQty > @Quantity)
        BEGIN
            -- If stock quantity is greater than the order quantity
            SET @StockQty = @StockQty - @Quantity

            -- Update stock details
            UPDATE stockdetails
            SET quantity = @StockQty
            WHERE sdetailid = @SDetailID			

            -- Insert into order details
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
        ELSE IF (@StockQty < @Quantity)
        BEGIN
            -- If stock quantity is less than order quantity
            SET @Quantity = @Quantity - @StockQty

            -- Update stock to 0 and change status to 2 (unavailable)
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

			
            -- Insert into order details for partial quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @StockQty,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @StockQty,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3
        END
        ELSE
        BEGIN
            -- If stock quantity equals the order quantity, mark as processed
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

            -- Insert the order detail for the exact quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
    END

    FETCH NEXT
    FROM cur
    INTO @ProductID,
         @ColorID,
         @GodownID,
         @Quantity,
         @SOrderDetailID
END

CLOSE cur
DEALLOCATE cur


	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId



	--***************************************
	--SR visit Update**************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0
	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT so.InvoiceDate,
		so.invoiceno,
		so.customerid,
		so.vatpercentage,
		so.vatamount,
		so.grandtotal,
		so.TDPercentage,
		so.TDAmount,
		so.netdiscount,
		so.totalamount,
		so.paymentdue,
		so.RecAmount,
		so.adjamount,
		so.totaldue,
		so.STATUS,
		so.concernid,
		so.createdby,
		so.createdate,
		so.totaloffer,
		so.Remarks,
		so.TramsAndCondition,
		so.CardTypeSetupID,
		so.CardPaidAmount,
		so.DepositChargePercent,
		so.BankTransID,
		so.TSQty,
		so.PrevDue,
		so.ActionStatus,
		so.SOrderID
		FROM SOrders so
		INNER JOIN SOrders s on so.SOrderID = s.SOrderID AND s.SOrderID =  @SalesOrderId
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH


----------COMMONSOURCE----------
-------------Nahid--------------
----------20-01-2025------------


ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = s.TSQty,
		ActionStatus = ActionStatus + 1
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)



	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	DECLARE @prevQty DECIMAL(18,2) = (SELECT ISNULL(SUM(s.Quantity), 0) FROM @SODetails s
	INNER JOIN Products P On s.ProductId = p.ProductID
	WHERE s.Status = 4 AND p.ProductType !=2)

	UPDATE st
	SET st.Quantity = ((st.Quantity - sod.Qty) + @prevQty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType !=2

	UPDATE st
	SET st.Quantity = ((st.Quantity - sod.Qty)),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType =2

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	
-- For No barcode Stock Details out and SOrderDetails Insert
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @GodownID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @SOrderDetailID INT
DECLARE @Quantity decimal(18,2)
DECLARE @StockQty decimal(18,2)
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL FOR
SELECT s.ProductId,
       s.colorid,
       s.Compressor,
       s.quantity,
       sorderdetailid
FROM @SODetails s
JOIN products ON products.productid = s.productid
WHERE products.ProductType = 2 AND s.Status = 3

OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID,
     @ColorID,
     @GodownID,
     @Quantity,
     @SOrderDetailID

WHILE @@FETCH_STATUS = 0
BEGIN
    WHILE (@Quantity != 0)
    BEGIN
        -- Get the first available stock detail
        SET @SDetailID = (
            SELECT MIN(SDetailID)
            FROM stockdetails
            WHERE productid = @ProductID AND colorid = @ColorID
            AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
        )

        -- Get the stock quantity
        SET @StockQty = (
            SELECT quantity
            FROM stockdetails
            WHERE sdetailid = @SDetailID
        )

        IF (@StockQty > @Quantity)
        BEGIN
            -- If stock quantity is greater than the order quantity
            SET @StockQty = @StockQty - @Quantity

            -- Update stock details
            UPDATE stockdetails
            SET quantity = @StockQty
            WHERE sdetailid = @SDetailID			

            -- Insert into order details
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
        ELSE IF (@StockQty < @Quantity)
        BEGIN
            -- If stock quantity is less than order quantity
            SET @Quantity = @Quantity - @StockQty

            -- Update stock to 0 and change status to 2 (unavailable)
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

			
            -- Insert into order details for partial quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @StockQty,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @StockQty,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3
        END
        ELSE
        BEGIN
            -- If stock quantity equals the order quantity, mark as processed
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

            -- Insert the order detail for the exact quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
    END

    FETCH NEXT
    FROM cur
    INTO @ProductID,
         @ColorID,
         @GodownID,
         @Quantity,
         @SOrderDetailID
END

CLOSE cur
DEALLOCATE cur


	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId



	--***************************************
	--SR visit Update**************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0
	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT so.InvoiceDate,
		so.invoiceno,
		so.customerid,
		so.vatpercentage,
		so.vatamount,
		so.grandtotal,
		so.TDPercentage,
		so.TDAmount,
		so.netdiscount,
		so.totalamount,
		so.paymentdue,
		so.RecAmount,
		so.adjamount,
		so.totaldue,
		so.STATUS,
		so.concernid,
		so.createdby,
		so.createdate,
		so.totaloffer,
		so.Remarks,
		so.TramsAndCondition,
		so.CardTypeSetupID,
		so.CardPaidAmount,
		so.DepositChargePercent,
		so.BankTransID,
		so.TSQty,
		so.PrevDue,
		so.ActionStatus,
		so.SOrderID
		FROM SOrders so
		INNER JOIN SOrders s on so.SOrderID = s.SOrderID AND s.SOrderID =  @SalesOrderId
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH

------------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[sp_AddTransferOrder]
(
	@dtTransferOrder ADDTransferTable readonly,
	@dtTransferDetails ADDTransferDetailsTable readonly,
	@dtTransferFromStock InsertTransferStockTable readonly,
	@dtTransferToStock InsertTransferStockTable readonly,
	@ReturnResult int output,
	@ReturnTransferID int Output
)
  
AS 

BEGIN TRY  
 BEGIN TRANSACTION 

 Declare @TransferID int
 Declare @ToConcernID int
 Declare @CreatedBy int
 Declare @CreatedDate Datetime

INSERT INTO Transfers
(
TransferDate,TransferNo,ConcernID,CreateDate,FromConcernID,Remarks,Status,ToConcernID,TotalAmount,CreatedBy
)
(Select TransferDate,TransferNo,ConcernID,CreateDate,FromConcernID,Remarks,Status,ToConcernID,TotalAmount,CreatedBy from @dtTransferOrder)

set  @TransferID = SCOPE_IDENTITY()

set @CreatedBy =ISNULL((select CreatedBy from @dtTransferOrder),0)
set @CreatedDate =ISNULL((select CreateDate from @dtTransferOrder),GETDATE())
set @ToConcernID =ISNULL((select ToConcernID from @dtTransferOrder),0)

INSERT INTO TransferDetails
(
 PRate,ProductID,Quantity,SDetailID,ToColorID,ToGodownID,ToProductID,UTAmount,TransferID,IMEI, SRate
)
(
select  UnitPrice,td.ProductID,Quantity,SDetailID,ToColorID,ToGodownID,ToProductID,UTAmount,@TransferID,IMEI, SRate from @dtTransferDetails td
INNER JOIN Products p ON td.ProductId = p.ProductID
WHERE p.ProductType!=2
)
--*******************Decrease From Godown stocks****************
UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity - t.Quantity),ModifiedDate =  @CreatedDate,ModifiedBy=@CreatedBy
from @dtTransferFromStock t
INNER JOIN Stocks ON Stocks.ProductID =t.ProductID and Stocks.ColorID=t.ColorID and Stocks.GodownID = t.GodownID

UPDATE stockdetails
SET stockdetails.STATUS = 2
FROM @dtTransferDetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.SDetailID
INNER JOIN products ON stockdetails.productid = products.productid
WHERE products.producttype = 1 OR products.producttype = 3

--No barcode product quantity update
--UPDATE stockdetails
--SET Quantity=stockdetails.Quantity-s.Quantity
--FROM @dtTransferDetails s
--INNER JOIN stockdetails ON stockdetails.sdetailid = s.SDetailID
--INNER JOIN products ON stockdetails.productid = products.productid
--WHERE products.producttype = 2


DECLARE @ProductID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @GodownID INT
DECLARE @Quantity DECIMAL(18,2)
DECLARE @SQty DECIMAL(18,2)

DECLARE cur CURSOR LOCAL
FOR
SELECT s.ProductID,
		s.ColorID,
		s.GodownID,
		s.Quantity,
		s.SDetailID
	FROM @dtTransferDetails s
	INNER JOIN products
		ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity > 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)


		IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity
				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				INSERT INTO TransferDetails
				(
					PRate,ProductID,Quantity,SDetailID,ToColorID,ToGodownID,ToProductID,UTAmount,TransferID,IMEI, SRate
				)
				(
					SELECT TOP 1  
					UnitPrice,td.ProductID,@Quantity,@SDetailID,ToColorID,ToGodownID,ToProductID,(td.UnitPrice * @Quantity),@TransferID,IMEI, td.SRate from @dtTransferDetails td
					INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
					INNER JOIN products p ON STD.productid = p.productid
					WHERE td.productid = @ProductID
		            AND td.colorid = @ColorID
				    AND td.GodownID = @GodownID
					AND STD.SDetailID = @SDetailID
				)


				SET @Quantity = 0
			END

			ELSE IF (@SQty < @Quantity)
			BEGIN
				print(@Quantity)
				SET @Quantity = @Quantity - @SQty

				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO TransferDetails
				(
					PRate,ProductID,Quantity,SDetailID,ToColorID,ToGodownID,ToProductID,UTAmount,TransferID,IMEI, SRate
				)
				(
					SELECT TOP 1  
					UnitPrice,td.ProductID,@SQty,@SDetailID,ToColorID,ToGodownID,ToProductID,(td.UnitPrice * @SQty),@TransferID,IMEI, td.SRate from @dtTransferDetails td
					INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
					INNER JOIN products p ON STD.productid = p.productid
					WHERE td.productid = @ProductID
		            AND td.colorid = @ColorID
				    AND td.GodownID = @GodownID
					AND STD.SDetailID = @SDetailID
				)

			END

			ELSE
			BEGIN

				print(@Quantity)
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO TransferDetails
				(
					PRate,ProductID,Quantity,SDetailID,ToColorID,ToGodownID,ToProductID,UTAmount,TransferID,IMEI, SRate
				)
				(
					SELECT TOP 1  
					UnitPrice,td.ProductID,@Quantity,@SDetailID,ToColorID,ToGodownID,ToProductID,(td.UnitPrice * @Quantity),@TransferID,IMEI, td.SRate from @dtTransferDetails td
					INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
					INNER JOIN products p ON STD.productid = p.productid
					WHERE td.productid = @ProductID
		            AND td.colorid = @ColorID
				    AND td.GodownID = @GodownID
					AND STD.SDetailID = @SDetailID
				)


				SET @Quantity = 0

			END

		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SDetailID

	END


--No barcode product status update
--UPDATE stockdetails
--SET StockDetails.Status=2
--FROM @dtTransferDetails s
--INNER JOIN stockdetails ON stockdetails.sdetailid = s.SDetailID
--INNER JOIN products ON stockdetails.productid = products.productid
--WHERE products.producttype = 2 and StockDetails.Quantity=0

--*******************Decrease From Godown stocks****************

--********************Increase To Godown Stocks******************

UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity + t.Quantity),ModifiedDate = @CreatedDate ,ModifiedBy=@CreatedBy
from @dtTransferToStock t
JOIN Stocks ON Stocks.ProductID =t.ProductID and Stocks.ColorID=t.ColorID and Stocks.GodownID = t.GodownID

INSERT INTO Stocks
(
StockCode, EntryDate, Quantity, ProductID,ColorID,
GodownID,MRPPrice, LPPrice,CreatedBy,CreateDate,ConcernID
)
(Select 
Max(t.StockCode), @CreatedDate,Sum(t.Quantity), t.ToProductID,t.ToColorID,
t.ToGodownID,  Max(t.UnitPrice), Max(t.UnitPrice), @CreatedBy,@CreatedDate,@ToConcernID
from @dtTransferDetails t 
group by t.ToProductID,ToColorID,ToGodownID
having Min(t.StockId)=0
)

INSERT INTO StockDetails
(
StockCode, Quantity, ProductID,ColorID,IMENO,
GodownID,PRate,Status,SRate,CRSalesRate3Month,CreditSRate,CRSalesRate12Month,TransferDetailID,StockID,POrderDetailID
)
(Select 
s.StockCode,t.Quantity, t.ToProductID,t.ToColorID,t.IMEI,
t.ToGodownID,t.PRate,1,t.SRate,t.SRate,t.SRate,t.SRate,t.TDetailID,s.StockID,0
from TransferDetails t
INNER join Stocks s on s.ProductID = t.ToProductID and s.ColorID=t.ToColorID and s.GodownID = t.ToGodownID
WHERE t.TransferID = @TransferID
)

--INSERT INTO StockDetails
--(
--StockCode, Quantity, ProductID,ColorID,IMENO,
--GodownID,PRate,Status,SRate,CRSalesRate3Month,CreditSRate,CRSalesRate12Month,TransferDetailID,StockID,POrderDetailID
--)
--(Select 
--t.StockCode,t.Quantity, t.ToProductID,t.ToColorID,t.IMEI,
--t.ToGodownID,t.UnitPrice,1,t.SRate,t.SRate,t.SRate,t.SRate,td.TDetailID,s.StockID,0
--from @dtTransferDetails t 
--INNER join Stocks s on s.ProductID = t.ToProductID and s.ColorID=t.ToColorID and s.GodownID = t.ToGodownID
--INNER join TransferDetails td on t.ToProductID=td.ToProductID and t.ToColorID=td.ToColorID and t.ToGodownID = td.ToGodownID and td.TransferID=@TransferID and t.IMEI=td.IMEI
--)

--********************Increase To Godown Stocks******************
COMMIT

set @ReturnResult= 1;
set @ReturnTransferID= @TransferID;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		set @ReturnResult= 0;
        set @ReturnTransferID= 0;
END CATCH

----------COMMONSOURCE----------
-------------Nahid--------------
----------16-01-2025------------

ALTER TABLE dbo.TransferDetails ADD
	SRate decimal(18, 2) NOT NULL CONSTRAINT DF_TransferDetails_SRate DEFAULT ((0))
GO

------------------------------------------------------------------------------------------------------------------------------

ALTER PROC [dbo].[sp_AddTransferOrder]
(
	@dtTransferOrder ADDTransferTable readonly,
	@dtTransferDetails ADDTransferDetailsTable readonly,
	@dtTransferFromStock InsertTransferStockTable readonly,
	@dtTransferToStock InsertTransferStockTable readonly,
	@ReturnResult int output,
	@ReturnTransferID int Output
)
  
AS 

BEGIN TRY  
 BEGIN TRANSACTION 

 Declare @TransferID int
 Declare @ToConcernID int
 Declare @CreatedBy int
 Declare @CreatedDate Datetime

INSERT INTO Transfers
(
TransferDate,TransferNo,ConcernID,CreateDate,FromConcernID,Remarks,Status,ToConcernID,TotalAmount,CreatedBy
)
(Select TransferDate,TransferNo,ConcernID,CreateDate,FromConcernID,Remarks,Status,ToConcernID,TotalAmount,CreatedBy from @dtTransferOrder)

set  @TransferID = SCOPE_IDENTITY()

set @CreatedBy =ISNULL((select CreatedBy from @dtTransferOrder),0)
set @CreatedDate =ISNULL((select CreateDate from @dtTransferOrder),GETDATE())
set @ToConcernID =ISNULL((select ToConcernID from @dtTransferOrder),0)

INSERT INTO TransferDetails
(
 PRate,ProductID,Quantity,SDetailID,ToColorID,ToGodownID,ToProductID,UTAmount,TransferID,IMEI, SRate
)
(
select  UnitPrice,ProductID,Quantity,SDetailID,ToColorID,ToGodownID,ToProductID,UTAmount,@TransferID,IMEI, SRate from @dtTransferDetails
)
--*******************Decrease From Godown stocks****************
UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity - t.Quantity),ModifiedDate =  @CreatedDate,ModifiedBy=@CreatedBy
from @dtTransferFromStock t
INNER JOIN Stocks ON Stocks.ProductID =t.ProductID and Stocks.ColorID=t.ColorID and Stocks.GodownID = t.GodownID

UPDATE stockdetails
SET stockdetails.STATUS = 2
FROM @dtTransferDetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.SDetailID
INNER JOIN products ON stockdetails.productid = products.productid
WHERE products.producttype = 1 OR products.producttype = 3

--No barcode product quantity update
--UPDATE stockdetails
--SET Quantity=stockdetails.Quantity-s.Quantity
--FROM @dtTransferDetails s
--INNER JOIN stockdetails ON stockdetails.sdetailid = s.SDetailID
--INNER JOIN products ON stockdetails.productid = products.productid
--WHERE products.producttype = 2


DECLARE @ProductID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @GodownID INT
DECLARE @Quantity DECIMAL(18,2)
DECLARE @SQty DECIMAL(18,2)

DECLARE cur CURSOR LOCAL
FOR
SELECT s.ProductID,
		s.ColorID,
		s.GodownID,
		s.Quantity,
		s.SDetailID
	FROM @dtTransferDetails s
	INNER JOIN products
		ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity > 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)


		IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity
				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				SET @Quantity = 0
			END

			ELSE IF (@SQty < @Quantity)
			BEGIN
				print(@Quantity)
				SET @Quantity = @Quantity - @SQty
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

			END

			ELSE
			BEGIN

				print(@Quantity)
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				SET @Quantity = 0

			END

		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SDetailID

	END


--No barcode product status update
--UPDATE stockdetails
--SET StockDetails.Status=2
--FROM @dtTransferDetails s
--INNER JOIN stockdetails ON stockdetails.sdetailid = s.SDetailID
--INNER JOIN products ON stockdetails.productid = products.productid
--WHERE products.producttype = 2 and StockDetails.Quantity=0

--*******************Decrease From Godown stocks****************

--********************Increase To Godown Stocks******************

UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity + t.Quantity),ModifiedDate = @CreatedDate ,ModifiedBy=@CreatedBy
from @dtTransferToStock t
JOIN Stocks ON Stocks.ProductID =t.ProductID and Stocks.ColorID=t.ColorID and Stocks.GodownID = t.GodownID

INSERT INTO Stocks
(
StockCode, EntryDate, Quantity, ProductID,ColorID,
GodownID,MRPPrice, LPPrice,CreatedBy,CreateDate,ConcernID
)
(Select 
Max(t.StockCode), @CreatedDate,Sum(t.Quantity), t.ToProductID,t.ToColorID,
t.ToGodownID,  Max(t.UnitPrice), Max(t.UnitPrice), @CreatedBy,@CreatedDate,@ToConcernID
from @dtTransferDetails t 
group by t.ToProductID,ToColorID,ToGodownID
having Min(t.StockId)=0
)

INSERT INTO StockDetails
(
StockCode, Quantity, ProductID,ColorID,IMENO,
GodownID,PRate,Status,SRate,CRSalesRate3Month,CreditSRate,CRSalesRate12Month,TransferDetailID,StockID,POrderDetailID
)
(Select 
s.StockCode,t.Quantity, t.ToProductID,t.ToColorID,t.IMEI,
t.ToGodownID,t.PRate,1,t.SRate,t.SRate,t.SRate,t.SRate,t.TDetailID,s.StockID,0
from TransferDetails t
INNER join Stocks s on s.ProductID = t.ToProductID and s.ColorID=t.ToColorID and s.GodownID = t.ToGodownID
WHERE t.TransferID = @TransferID
)

--INSERT INTO StockDetails
--(
--StockCode, Quantity, ProductID,ColorID,IMENO,
--GodownID,PRate,Status,SRate,CRSalesRate3Month,CreditSRate,CRSalesRate12Month,TransferDetailID,StockID,POrderDetailID
--)
--(Select 
--t.StockCode,t.Quantity, t.ToProductID,t.ToColorID,t.IMEI,
--t.ToGodownID,t.UnitPrice,1,t.SRate,t.SRate,t.SRate,t.SRate,td.TDetailID,s.StockID,0
--from @dtTransferDetails t 
--INNER join Stocks s on s.ProductID = t.ToProductID and s.ColorID=t.ToColorID and s.GodownID = t.ToGodownID
--INNER join TransferDetails td on t.ToProductID=td.ToProductID and t.ToColorID=td.ToColorID and t.ToGodownID = td.ToGodownID and td.TransferID=@TransferID and t.IMEI=td.IMEI
--)

--********************Increase To Godown Stocks******************
COMMIT

set @ReturnResult= 1;
set @ReturnTransferID= @TransferID;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		set @ReturnResult= 0;
        set @ReturnTransferID= 0;
END CATCH

------------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[sp_ReturnTransfer](@TransferID int)
AS
BEGIN TRY
BEGIN TRANSACTION

	DECLARE @TDetailID INT
	DECLARE @ToStockID INT
	DECLARE @FColorID INT
	DECLARE @FGodownID INT
	DECLARE @StockID INT
	DECLARE @SDetailID INT
	DECLARE @Quantity INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT td.TDetailID,td.SDetailID,sd.StockID,td.Quantity FROM TransferDetails td
	join StockDetails sd on td.SDetailID=sd.SDetailID
	join Transfers t on td.TransferID=t.TransferID
	WHERE td.TransferID=@TransferID and t.Status=1

	OPEN cur
	FETCH NEXT
	FROM cur
	INTO @TDetailID, @SDetailID, @StockID, @Quantity

	WHILE @@FETCH_STATUS = 0
	BEGIN
	   Update StockDetails set Status=1
	   from StockDetails s
	   join Products p on p.ProductID = s.ProductID 
	   where SDetailID=@SDetailID and p.ProductType != 2

	   Update StockDetails set Status=1, Quantity = Quantity+@Quantity
	   from StockDetails s
	   join Products p on p.ProductID = s.ProductID 
	   where SDetailID=@SDetailID and p.ProductType = 2

	   Update Stocks set Quantity=Quantity+@Quantity where StockID=@StockID

	   set @ToStockID = ISNULL((Select StockID from StockDetails where TransferDetailID=@TDetailID),0)
	   Delete StockDetails where TransferDetailID=@TDetailID
	   Update Stocks set Quantity=Quantity-@Quantity where StockID=@ToStockID


	   FETCH NEXT
	   FROM cur
	   INTO @TDetailID, @SDetailID, @StockID, @Quantity
	END


	Update Transfers set Status=2 where TransferID=@TransferID
	
COMMIT
RETURN 1;

END TRY
BEGIN CATCH
  IF(@@TRANCOUNT>0)
  ROLLBACK;
  RETURN 0;
END CATCH



------------------------------------------------------------------------------------------------------------------------------


ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = s.TSQty,
		ActionStatus = ActionStatus + 1
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)



	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	DECLARE @prevQty DECIMAL(18,2) = (SELECT ISNULL(SUM(s.Quantity), 0) FROM @SODetails s
	INNER JOIN Products P On s.ProductId = p.ProductID
	WHERE s.Status = 4 AND p.ProductType !=2)

	UPDATE st
	SET st.Quantity = ((st.Quantity - sod.Qty) + @prevQty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType !=2

	UPDATE st
	SET st.Quantity = ((st.Quantity - sod.Qty)),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType =2

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	
-- For No barcode Stock Details out and SOrderDetails Insert
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @GodownID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @SOrderDetailID INT
DECLARE @Quantity decimal(18,2)
DECLARE @StockQty decimal(18,2)
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL FOR
SELECT s.ProductId,
       s.colorid,
       s.Compressor,
       s.quantity,
       sorderdetailid
FROM @SODetails s
JOIN products ON products.productid = s.productid
WHERE products.ProductType = 2 AND s.Status = 3

OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID,
     @ColorID,
     @GodownID,
     @Quantity,
     @SOrderDetailID

WHILE @@FETCH_STATUS = 0
BEGIN
    WHILE (@Quantity != 0)
    BEGIN
        -- Get the first available stock detail
        SET @SDetailID = (
            SELECT MIN(SDetailID)
            FROM stockdetails
            WHERE productid = @ProductID AND colorid = @ColorID
            AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
        )

        -- Get the stock quantity
        SET @StockQty = (
            SELECT quantity
            FROM stockdetails
            WHERE sdetailid = @SDetailID
        )

        IF (@StockQty > @Quantity)
        BEGIN
            -- If stock quantity is greater than the order quantity
            SET @StockQty = @StockQty - @Quantity

            -- Update stock details
            UPDATE stockdetails
            SET quantity = @StockQty
            WHERE sdetailid = @SDetailID			

            -- Insert into order details
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
        ELSE IF (@StockQty < @Quantity)
        BEGIN
            -- If stock quantity is less than order quantity
            SET @Quantity = @Quantity - @StockQty

            -- Update stock to 0 and change status to 2 (unavailable)
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

			
            -- Insert into order details for partial quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @StockQty,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3
        END
        ELSE
        BEGIN
            -- If stock quantity equals the order quantity, mark as processed
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

            -- Insert the order detail for the exact quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
    END

    FETCH NEXT
    FROM cur
    INTO @ProductID,
         @ColorID,
         @GodownID,
         @Quantity,
         @SOrderDetailID
END

CLOSE cur
DEALLOCATE cur


	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId



	--***************************************
	--SR visit Update**************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0
	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT so.InvoiceDate,
		so.invoiceno,
		so.customerid,
		so.vatpercentage,
		so.vatamount,
		so.grandtotal,
		so.TDPercentage,
		so.TDAmount,
		so.netdiscount,
		so.totalamount,
		so.paymentdue,
		so.RecAmount,
		so.adjamount,
		so.totaldue,
		so.STATUS,
		so.concernid,
		so.createdby,
		so.createdate,
		so.totaloffer,
		so.Remarks,
		so.TramsAndCondition,
		so.CardTypeSetupID,
		so.CardPaidAmount,
		so.DepositChargePercent,
		so.BankTransID,
		so.TSQty,
		so.PrevDue,
		so.ActionStatus,
		so.SOrderID
		FROM SOrders so
		INNER JOIN SOrders s on so.SOrderID = s.SOrderID AND s.SOrderID =  @SalesOrderId
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH

----------COMMONSOURCE----------
-------------Nahid--------------
----------15-01-2025------------


Create FUNCTION [dbo].[CheckTransProductHireSalesStatusByTransDId]
(
  @TransferID int
)  
  RETURNS int
AS 
 BEGIN
	DECLARE	@Sold int
    
    SELECT @Sold = COUNT(*)
	FROM StockDetails
	JOIN TransferDetails TFD ON TFD.TDetailID = StockDetails.TransferDetailID 
	join Transfers TF on TFD.TransferID = TF.TransferID
	JOIN CreditSaleDetails sod on sod.StockDetailID = StockDetails.SDetailID
	join Products p on TFD.ProductID = p.ProductID
	WHERE p.ProductType <> 2 and TFD.TransferID = @TransferID  AND StockDetails.Status = 2


	IF @Sold IS NULL OR @Sold = 0
		begin
			SET @Sold=0

			set @Sold =  (select ISNULL(COUNT(*), 0) FROM StockDetails sd
			JOIN TransferDetails TFD ON TFD.TDetailID = sd.TransferDetailID 
			join Transfers TF on TFD.TransferID = TF.TransferID
			JOIN CreditSaleDetails sod on sod.StockDetailID = sd.SDetailID
			join Products p on TFD.ProductID = p.ProductID
			WHERE p.ProductType = 2 and  TFD.TransferID = @TransferID) 


		end
	  
	  
	RETURN  @Sold
  END

  --select dbo.CheckTransProductHireSalesStatusByTransDId(28078)

------------------------------------------------------------------------------------------------------------------------------

Create FUNCTION [dbo].[CheckHireSalesProductStatusByPOId]
(
  @PurchaseOrderId int
)  
  RETURNS int
AS 
 BEGIN
	DECLARE	@Sold int
    
    SELECT @Sold = COUNT(*)
	FROM StockDetails
	JOIN POrderDetails POD ON POD.POrderDetailID = StockDetails.POrderDetailID 
	join POrders PO on POD.POrderID = PO.POrderID
	JOIN CreditSaleDetails sod on sod.StockDetailID = StockDetails.SDetailID
	join Products p on POD.ProductID = p.ProductID
	WHERE p.ProductType <> 2 AND POD.POrderID = @PurchaseOrderId AND StockDetails.Status = 2
	
	--IF @Sold IS NULL
	--  SET @Sold=0

	IF @Sold IS NULL OR @Sold = 0
		begin
			SET @Sold=0

			set @Sold =  (select ISNULL(COUNT(*), 0) FROM StockDetails sd
			JOIN POrderDetails POD ON POD.POrderDetailID = sd.POrderDetailID 
			join POrders PO on POD.POrderID = PO.POrderID
			JOIN CreditSaleDetails sod on sod.StockDetailID = sd.SDetailID
			join Products p on POD.ProductID = p.ProductID
			WHERE p.ProductType = 2 and POD.POrderID = @PurchaseOrderId)
			--and POD.Quantity != sd.Quantity


		end
	  
	RETURN@Sold
END

------------------------------------------------------------------------------------------------------------------------------

ALTER FUNCTION [dbo].[CheckTransProductStatusByTransDId]
(
  @TransferID int
)  
  RETURNS int
AS 
 BEGIN
	DECLARE	@Sold int
    
    SELECT @Sold = COUNT(*)
	FROM StockDetails
	JOIN TransferDetails TFD ON TFD.TDetailID = StockDetails.TransferDetailID 
	join Transfers TF on TFD.TransferID = TF.TransferID
	JOIN SOrderDetails sod on sod.SDetailID = StockDetails.SDetailID
	join Products p on TFD.ProductID = p.ProductID
	WHERE p.ProductType <> 2 and TFD.TransferID = @TransferID  AND StockDetails.Status = 2


	IF @Sold IS NULL OR @Sold = 0
		begin
			SET @Sold=0

			set @Sold =  (select ISNULL(COUNT(*), 0) FROM StockDetails sd
			JOIN TransferDetails TFD ON TFD.TDetailID = sd.TransferDetailID 
			join Transfers TF on TFD.TransferID = TF.TransferID
			JOIN SOrderDetails sod on sod.SDetailID = sd.SDetailID
			join Products p on TFD.ProductID = p.ProductID
			WHERE p.ProductType = 2 and  TFD.TransferID = @TransferID) 


		end
	  
	  
	RETURN  @Sold
  END

  --select dbo.CheckTransProductStatusByTransDId(28078)

------------------------------------------------------------------------------------------------------------------------------
----------COMMONSOURCE----------
-------------Nahid--------------
----------11-01-2025------------

--EXEC GetDatewiseCustomerDueRptRetail '5213', '0', '30 Nov 2024 12:00:00 AM', '0', '01 Dec 2024 12:00:00 AM','11 Jan 2025 11:59:59 PM'
ALTER PROC [dbo].[GetDatewiseCustomerDueRptRetail]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturn, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CrAdjustment, 0)
					 --+ ISNULL(piv.CashCollectionReturn, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.[CashCollectionReturn], 0) AS DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(((ISNULL(piv.CashCollectionAdjustType + piv.CashCollectionAdjustTypeAdjustment, 0))) AS DECIMAL(18,2)) 'CashCollectionsTypeAdjustment',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(			(
				
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) +
					ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.CrAdjustment, 0)) +
					ISNULL(piv.[Return], 0) + ISNULL(piv.CashCollectionAdjustType, 0) + ISNULL(piv.CashCollectionAdjustTypeAdjustment, 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 1
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 1
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	--JOIN Customers c ON cc.CustomerID = c.CustomerID
	--WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	--AND c.ConcernID = @ConcernID 
	--AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND cc.TransactionType IN(1)
	----AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (
	--	(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
	--	OR
	--	(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	--)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionAdjustType' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType IN (9,14,15,16,17) AND c.ConcernID = @ConcernID AND c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'CashCollectionAdjustTypeAdjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN (1,9,14,15,16,17)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID AND c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return],CashCollectionReturnBank, CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount,CashCollectionAdjustType,
			CashCollectionAdjustTypeAdjustment


		)
	) piv
 END


---------------------------------------------------------------------------------------------------------------------------

ALTER PROC [dbo].[GetDatewiseCustomerDueRptDealer]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)  + ISNULL(piv.CashCollectionReturn, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0)+ ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CrAdjustment, 0)
					 --+ ISNULL(piv.CashCollectionReturn, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.[CashCollectionReturn], 0) AS DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(((ISNULL(piv.CashCollectionAdjustType + piv.CashCollectionAdjustTypeAdjustment, 0))) AS DECIMAL(18,2)) 'CashCollectionsTypeAdjustment',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) +
					ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.CrAdjustment, 0)) +
					ISNULL(piv.[Return], 0) + ISNULL(piv.CashCollectionAdjustType, 0) + ISNULL(piv.CashCollectionAdjustTypeAdjustment, 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 2
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 2
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	--JOIN Customers c ON cc.CustomerID = c.CustomerID
	--WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	--AND c.ConcernID = @ConcernID 
	--AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND cc.TransactionType IN(1)
	----AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (
	--	(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
	--	OR
	--	(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	--)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionAdjustType' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType IN (9,14,15,16,17) AND c.ConcernID = @ConcernID and c.CustomerType = 2 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'CashCollectionAdjustTypeAdjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN (1,9,14,15,16,17)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID



	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn, CashCollectionReturnBank,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount,CashCollectionAdjustType,
			CashCollectionAdjustTypeAdjustment

		)
	) piv
 END


---------------------------------------------------------------------------------------------------------------------------

ALTER PROC [dbo].[GetDatewiseCustomerDueRptHire]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturn, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CrAdjustment, 0)
					--+ ISNULL(piv.CashCollectionReturn, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.[CashCollectionReturn], 0) AS DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(((ISNULL(piv.CashCollectionAdjustType + piv.CashCollectionAdjustTypeAdjustment, 0))) AS DECIMAL(18,2)) 'CashCollectionsTypeAdjustment',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) +
					ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.CrAdjustment, 0)) +
					ISNULL(piv.[Return], 0) + ISNULL(piv.CashCollectionAdjustType, 0) + ISNULL(piv.CashCollectionAdjustTypeAdjustment, 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 3
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 3
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	--JOIN Customers c ON cc.CustomerID = c.CustomerID
	--WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	--AND c.ConcernID = @ConcernID 
	--AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND cc.TransactionType IN(1)
	----AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (
	--	(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
	--	OR
	--	(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	--)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionAdjustType' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType IN (9,14,15,16,17) AND c.ConcernID = @ConcernID and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'CashCollectionAdjustTypeAdjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN (1,9,14,15,16,17)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionReturnBank,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount,CashCollectionAdjustType,
			CashCollectionAdjustTypeAdjustment


		)
	) piv
 END


---------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[GetDatewiseCustomerDueRptBranch]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturn, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CrAdjustment, 0)
					--+ ISNULL(piv.CashCollectionReturn, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.[CashCollectionReturn], 0) AS DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(((ISNULL(piv.CashCollectionAdjustType + piv.CashCollectionAdjustTypeAdjustment, 0))) AS DECIMAL(18,2)) 'CashCollectionsTypeAdjustment',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) +
					ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.CrAdjustment, 0)) +
					ISNULL(piv.[Return], 0) + ISNULL(piv.CashCollectionAdjustType, 0) + ISNULL(piv.CashCollectionAdjustTypeAdjustment, 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 4
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 4
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	--JOIN Customers c ON cc.CustomerID = c.CustomerID
	--WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	--AND c.ConcernID = @ConcernID 
	--AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND cc.TransactionType IN(1)
	----AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (
	--	(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
	--	OR
	--	(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	--)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionAdjustType' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType IN (9,14,15,16,17) AND c.ConcernID = @ConcernID and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'CashCollectionAdjustTypeAdjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN (1,9,14,15,16,17)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount,CashCollectionAdjustType,
			CashCollectionAdjustTypeAdjustment

		)
	) piv
 END

----------COMMONSOURCE----------
-------------Nahid--------------
----------29-12-2024------------


--EXEC sp_DailyCashInHand  '11 MAY 2021 12:00:00 AM','11 MAY 2021 11:59:59 PM',16
ALTER procedure [dbo].[sp_DailyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-08-01'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)



create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(DAY, 1, Convert(date, GetDate()))
begin
	print @StartDate

	delete
	from #temp_Data1

	delete
	from #temp_Data2

	--	DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
	--	DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
	------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
	insert into #temp_Data1
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
				and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
		from POrders po
		join Suppliers s on po.SupplierID = s.SupplierID
		where po.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
		and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and po.RecAmt>0
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
	-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections cc
				join Suppliers s on cc.SupplierID = s.SupplierID
				where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
				and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
		and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
	------------------------------------------------------Expense in Product return----------------------------------
	set @total = isnull((
				select sum(PaidAmount)
				from ROrders
				where ConcernID = @ConcernID and DAY(Convert(date, ReturnDate)) = DAY(@StartDate) and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

END

	-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3 AND CustomerID > 0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Customer Cash Collection Return', @total, 'Customer Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

	------------- -------------------------------------------- Direct Expense--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0
		and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description

		insert into #temp_Data1
		select @StartDate,'Total Expense', @total, '', 0, 'Header'
	end

		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID  and DAY(Convert(date, TransactionDate)) = DAY(@StartDate)
				and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and DAY(Convert(date, TransactionDate)) = DAY(@StartDate)
		and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
	------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
						where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end



	-- ----------------------------Expens from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=3  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END
	---------------------------------Expense from Bank Deposit--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 1 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 1 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

	END

	---------------------------------Expense from Bank Loan--------------------
	set @total = isnull((
				SELECT SUM(ISNULL(BC.CollectionAmount, 0) + ISNULL(BC.SDPS, 0) + ISNULL(BC.Savings,0)) FROM dbo.BankLoanCollections BC
				JOIN dbo.BankLoanDetails BLD ON BC.Id = BLD.LoanCollectionId
				JOIN  dbo.BankLoans BL ON BLD.BankLoanId = BL.Id
				JOIN dbo.Banks B ON BL.BankId = B.BankID
				where BL.ConcernID = @ConcernID AND BLD.LoanCollectionId IS NOT NULL
				AND CAST(BC.CollectionDate AS DATE) = CAST(@StartDate AS DATE)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Loan Payment', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ', ' + B.BankName, SUM(ISNULL(BC.CollectionAmount, 0) + ISNULL(BC.SDPS, 0) + ISNULL(BC.Savings,0)), 'Bank Loan', 0, 'Cash'
		FROM dbo.BankLoanCollections BC
		JOIN dbo.BankLoanDetails BLD ON BC.Id = BLD.LoanCollectionId
		JOIN  dbo.BankLoans BL ON BLD.BankLoanId = BL.Id
		JOIN dbo.Banks B ON BL.BankId = B.BankID
		where BL.ConcernID = @ConcernID AND BLD.LoanCollectionId IS NOT NULL
		AND CAST(BC.CollectionDate AS DATE) = CAST(@StartDate AS DATE)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Loan Payment', @total, '', 0, 'Header'

	END
	---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------


	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2  and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Customer Collections', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	inner join Customers c on BT.CustomerID = c.CustomerID
	where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
	group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	insert into #temp_Data1
	select @StartDate,'Total Bank Customer collections', @total, '', 0, 'Header'
END
	---------------------------------Expens from Bank Cash Delivery---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Supplier Payment', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Supplier Payment', @total, '', 0, 'Header'
END
	---------------------------------Expense from Fund Out---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Fund Out', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		insert into #temp_Data1
		select @StartDate,'Total Bank Fund Out ', @total, '', 0, 'Header'
END

				---------------------------------Expens from Bank Expens---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Expense', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Expense)', sum(Amount), 'Bank Expense', 0, 'Cash'

		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Expense ', @total, '', 0, 'Header'


	END

---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Income', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Income (Cr))', sum(Amount), 'Bank Income ', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Income ', @total, '', 0, 'Header'
END


	----------------------------------------------Opening Cash In Hand in Income Table--------------------------------------------------------------- 
	insert into #temp_Data2
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	-----------------------------------------------Income in Sales Order-------------------------------------------
	set @total = isnull((
				select sum(RecAmount)
				from SOrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount,Convert(varchar(10),c.CustomerType)+'Order' from SOrders so
		join Customers c on so.CustomerID = c.CustomerID
		where so.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
	    insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
   
   END

	-- ---------------------------------------Income from Cash Collection from Customer-------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
				), 0)

	if (@total != 0)
	BEGIN
	insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, Convert(varchar(10),c.CustomerType)+'Cash'
		from CashCollections cc
		join Customers c on cc.CustomerID = c.CustomerID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
	    insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')
		
		END
	-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
	set @total = isnull((
				select isnull(sum(DownPayment), 0)
				from CreditSales
				where ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
		from CreditSales cs
		join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')
	
	END
	--------------------------------------Income in Purchase Product return----------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and DAY(Convert(date, OrderDate)) = DAY(@StartDate) and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and status = 5
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Purchase Return Cash'

	-------------------------------Income Installment Collection from Creditsales------------------
	set @total = isnull((
				select sum(InstallmentAmt)
				from CreditSalesSchedules css
				inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
				where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
		from CreditSalesSchedules css
		inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
		inner join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
	  
	  insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')
	
	END
	-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0 AND EX.IsBankTransaction = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Description, sum(Amount), E.Description
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 2 and  EX.CashInHandReportStatus = 0 AND EX.IsBankTransaction = 0 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')
	
	end

	-----------------------------------Income from Return From Supplier------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from CashCollections EX
						inner join Suppliers  E on E.SupplierID = EX.SupplierID
						where E.ConcernID = @ConcernID and EX.TransactionType = 3 
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Return From Supplier', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Name, sum(Amount), E.Name
		from CashCollections EX
		inner join Suppliers E on E.SupplierID = EX.SupplierID
		where E.ConcernID = @ConcernID and EX.TransactionType = 3  and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Name
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Total Return From Supplier',@total, 'Header')
	
	end

	-- ----------------------------Income from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
	END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
	-----------------------------------------------------------------------------------------------------------------------------------
	   SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)
	IF (@total != 0)
	BEGIN
		INSERT INTO #temp_Data2
		SELECT @StartDate, '', 0.00,SIH.Name+'(Current Asset)',  sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name

		insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')
	END
	---------------------------------Income from Bank Withdwal--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 2 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Withdwal', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 2 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Withdwal', @total, 'Header'

	END


	---------------------------------Income from Bank Cash Collection---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Customer Collection', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Customer Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
		('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on bt.CustomerID=c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Customer Collection', @total, 'Header'

	END

	---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Supplier payment', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Supplier payment', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Supplier payment', @total, 'Header'

	END
	----------------------------------------Income from Fund IN------------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.AnotherBankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Fund IN', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.AnotherBankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Fund IN', @total, 'Header'

	END

				---------------------------------Income from Bank Expens as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Expense', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Expense', 0, B.AccountNo + ',' + B.BankName + '(Bank Expens(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Expense', @total, 'Header'

	END

---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Income', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Income', 0, B.AccountNo + ',' + B.BankName + '(Bank Income)', sum(Amount), 'Cash'

		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Income', @total, 'Header'		
END
	---------------------------------Income from Bank Loan--------------------
	set @total = ISNULL((
				SELECT SUM(BL.PrincipleLoanAmount) FROM dbo.BankLoans BL
				JOIN dbo.Banks B ON BL.BankId = B.BankID
				WHERE BL.ConcernId = @ConcernID
				AND CAST(BL.LoanDate AS DATE) = CAST(@StartDate AS DATE)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Loan', 0, 'Header'

		insert into #temp_Data2
		select @StartDate, '', 0, B.AccountNo + ',' + B.BankName, SUM(BL.PrincipleLoanAmount), 'Cash'
		FROM dbo.BankLoans BL
		JOIN dbo.Banks B ON BL.BankId = B.BankID
		where BL.ConcernID = @ConcernID
		AND CAST(BL.LoanDate AS DATE) = CAST(@StartDate AS DATE)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Loan', @total, 'Header'

	END


	-----------------------------------------------------------------------------------------------------------------------------------
	--insert into #temp_Data3
	--select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), '', 0.00,  ''
	--from #temp_Data1 T1
	--UNION ALL
	--select @StartDate, 0,  '', 0, isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
	--from #temp_Data2 T2

	insert into #temp_Data3
	select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
	from #temp_Data1 T1
	full join #temp_Data2 T2 on T1.id = T2.id

	declare @a decimal(18, 2)
	declare @b decimal(18, 2)
	declare @ExpenseWithinDate decimal(18, 2)
	declare @IncomeWithinDate decimal(18, 2)
	declare @CashInHandWithinDate decimal(18, 2)

	set @a = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @b = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @ExpenseWithinDate = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @IncomeWithinDate = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
	set @CashInHand = @CashInHand + (@b - @a)

	insert into #temp_Data3
	values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

	insert into #temp_Data3
	values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

	insert into #temp_Data3
	values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

	set @StartDate = DATEADD(DAY, 1, @StartDate)
	--select *From #temp_Data1
	--select *From #temp_Data2
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

-------------------------------------------------------------------------------------------------------------------------


--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_MonthlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0


if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-06-09'
set @CashInHand=26500
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(MONTH, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate)
and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

insert into #temp_Data1
select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
from POrders po
join Suppliers s on po.SupplierID = s.SupplierID
where po.ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate)
and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate and po.RecAmt>0
group by s.SupplierID,s.Name

insert into #temp_Data1
select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 



-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections cc 
join Suppliers s on cc.SupplierID = s.SupplierID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) 
and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(cc.amount), 'Due Collection', 0, 'Cash'
		from CashCollections cc 
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) 
		and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
	-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3 AND CustomerID > 0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Customer Cash Collection Return', @total, 'Customer Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'
END
------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID 
				and  Month(Convert(date, InvoiceDate)) = Month(@StartDate)
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Retail/Dealer', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID 
	and  Month(Convert(date, InvoiceDate)) = Month(@StartDate)
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Retail/Dealere', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID 
			    and  Month(Convert(date, SalesDate)) = Month(@StartDate)
				and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Hire', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID 
	    and  Month(Convert(date, SalesDate)) = Month(@StartDate)
		and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Hire', 0, '', 0, 'Header'
	END
------------- -------------------------------------------- Direct Expense--------------------------------------------
set @total=isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)

if(@total) != 0
begin
	insert into #temp_Data1
	select @StartDate,'Expense', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
	from Expenditures EX
	inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
	where EX.ConcernID = @ConcernID and E.status = 1 AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
	group by E.Description

	insert into #temp_Data1
	select @StartDate,'Total Expense', @total, '', 0, 'Header'
end
		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID  and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate)  and  TransactionDate>= @InitailDate
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0 and  TransactionDate>= @InitailDate
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
					    where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end


-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2 AND    SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
 END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END
---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 1 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Customer Collections', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on BT.CustomerID = c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
		group by B.BankID, B.AccountNo, B.BankName, c.CustomerType

		insert into #temp_Data1
		select @StartDate,'Total Bank Customer collections', @total, '', 0, 'Header'
END
---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Supplier Payment', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Supplier Payment', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Supplier Payment', @total, '', 0, 'Header'
END

---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate,'Bank Fund Out', 0, '', 0, 'Header'
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName
insert into #temp_Data1
select @StartDate,'Total Bank Fund Out ', @total, '', 0, 'Header'
END
				---------------------------------Expens from Bank Expens---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Expense', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Expense)', sum(Amount), 'Bank Expense', 0, 'Cash'

		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Expense ', @total, '', 0, 'Header'


	END
---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Income', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Income (Cr))', sum(Amount), 'Bank Income ', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Income ', @total, '', 0, 'Header'
END



----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1  and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
  
END
-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1 and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1  and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0 AND EX.IsBankTransaction = 0
						and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

	-----------------------------------Income from Return From Supplier------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from CashCollections EX
						inner join Suppliers  E on E.SupplierID = EX.SupplierID
						where E.ConcernID = @ConcernID and EX.TransactionType = 3 
						and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Return From Supplier', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Name, sum(Amount), E.Name
		from CashCollections EX
		inner join Suppliers E on E.SupplierID = EX.SupplierID
		where E.ConcernID = @ConcernID and EX.TransactionType = 3 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Name
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Total Return From Supplier',@total, 'Header')
	
	end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name

 insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')

 END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
------------------------------------------------------------------------------------------------------------------------------------------------------

 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END

---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Withdwal', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Withdwal', @total, 'Header'

END

---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Customer Collection', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Customer Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
inner join Customers c on bt.CustomerID=c.CustomerID
where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Customer Collection', @total, 'Header'

END

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Supplier payment', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Supplier payment', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Supplier payment', @total, 'Header'

END
----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Fund IN', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Fund IN', @total, 'Header'

END
---------------------------------Income from Bank Expense as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Expense', 0, 'Header'

		insert into #temp_Data2
		select @StartDate, 'Bank Expense', 0, B.AccountNo + ',' + B.BankName + '(Bank Expense(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Expense', @total, 'Header'

	END
---------------------------------Income from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Income', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Income', 0, B.AccountNo + ',' + B.BankName + '(Bank Income)', sum(Amount), 'Cash'

		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Income', @total, 'Header'		
END

 ------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(MONTH, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

-------------------------------------------------------------------------------------------------------------------------


--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_YearlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-02-09'


if (@ConcernID = 1)
	set @CashInHand = 1263.00
else if (@ConcernID = 5)
	set @CashInHand = 8755.00
else if (@ConcernID = 6)
	set @CashInHand = - 2.00
else if (@ConcernID = 4)
	set @CashInHand = 65000.00
else if (@ConcernID = 20)
BEGIN
	set @CashInHand = 137340.00
	set @StartDate = '2020-03-12'
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END


set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(YEAR, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

insert into #temp_Data1
select @StartDate, s.Name, sum(po.recAmt), 'Cash Sales', 0, 'Order'
from POrders po
join Suppliers s on po.SupplierID = s.SupplierID
where po.ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
 and po.RecAmt>0
group by s.SupplierID,s.Name

insert into #temp_Data1
select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END

-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections cc 
join Suppliers s on cc.SupplierID = s.SupplierID
where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,  s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc 
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate 
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3 AND CustomerID > 0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Customer Cash Collection Return', @total, 'Customer Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID 
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Retail/Dealer', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID 
		and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Retail/Dealere', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID 
				and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Hire', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID 
		and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Hire', 0, '', 0, 'Header'
	END

------------- -------------------------------------------- Direct Expense--------------------------------------------
set @total =isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)

if (@total) != 0
begin
insert into #temp_Data1
select @StartDate,'Expense', 0, '', 0, 'Header'

insert into #temp_Data1
select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1  AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description

insert into #temp_Data1
select @StartDate,'Total Expense', @total, '', 0, 'Header'

end

		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID and Year(Convert(date, TransactionDate)) = Year(@StartDate)  and  TransactionDate>= @InitailDate
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0 and  TransactionDate>= @InitailDate
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
						where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end


-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0
 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE  SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
 END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END


---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 1 and BT.WFStatus = 2   and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate,'Bank Customer Collections', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	inner join Customers c on BT.CustomerID = c.CustomerID
	where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName, c.CustomerType

	insert into #temp_Data1
	select @StartDate,'Total Bank Customer Collections', @total, '', 0, 'Header'
END
---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Supplier Payment', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Supplier Payment', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Supplier Payment', @total, '', 0, 'Header'
END

---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate,'Bank Fund Out', 0, '', 0, 'Header'
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName
insert into #temp_Data1
select @StartDate,'Total Bank Fund Out ', @total, '', 0, 'Header'
END

				---------------------------------Expens from Bank Expens---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Expense', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Expense)', sum(Amount), 'Bank Expense', 0, 'Cash'

		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Expense ', @total, '', 0, 'Header'


	END
---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Income', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Income (Cr))', sum(Amount), 'Bank Income ', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Income ', @total, '', 0, 'Header'
END

----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'


-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1 and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
  
END
-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1  and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1   and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID  and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0
						and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 AND EX.IsBankTransaction = 0 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

	-----------------------------------Income from Return From Supplier------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from CashCollections EX
						inner join Suppliers  E on E.SupplierID = EX.SupplierID
						where E.ConcernID = @ConcernID and EX.TransactionType = 3 
						AND Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Return From Supplier', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Name, sum(Amount), E.Name
		from CashCollections EX
		inner join Suppliers E on E.SupplierID = EX.SupplierID
		where E.ConcernID = @ConcernID and EX.TransactionType = 3 and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Name
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Total Return From Supplier',@total, 'Header')
	
	end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1   AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
 END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
------------------------------------------------------------------------------------------------------------------------------------------------------

 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE  SIH.ParentId=2  and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END
---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Withdwal', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Withdwal', @total, 'Header'

END
---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Customer Collection', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Customer Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
inner join Customers c on bt.CustomerID=c.CustomerID
where BT.ConcernID = @ConcernID and TransactionType = 3 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Customer Collection', @total, 'Header'

END

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Supplier payment', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Supplier payment', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Supplier payment', @total, 'Header'

END
----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2
select @StartDate,'', 0, 'Bank Fund IN', 0, 'Header'
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

insert into #temp_Data2
select @StartDate,'', 0, 'Total Bank Fund IN', @total, 'Header'

END
---------------------------------Income from Bank Expense as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Expense', 0, 'Header'

		insert into #temp_Data2
		select @StartDate, 'Bank Expense', 0, B.AccountNo + ',' + B.BankName + '(Bank Expense(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Expense', @total, 'Header'

	END
---------------------------------Income from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Income', 0, 'Header'
		insert into #temp_Data2
		select @StartDate, 'Bank Income', 0, B.AccountNo + ',' + B.BankName + '(Bank Income)', sum(Amount), 'Cash'

		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and BT.WFStatus = 2 and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Income', @total, 'Header'		
END


------------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)

set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(YEAR, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)


----------COMMONSOURCE----------
-------------Nahid--------------
----------22-12-2024------------

ALTER TABLE dbo.SystemInformations ADD
	IsBankApprovalEnable int NOT NULL CONSTRAINT DF_SystemInformations_IsBankApprovalEnable DEFAULT ((0))
GO

----------COMMONSOURCE----------
-------------Nahid--------------
----------14-12-2024------------

ALTER TABLE dbo.POrderDetails ADD
	DOrderDetailId int NOT NULL CONSTRAINT DF_POrderDetails_DOrderDetailId DEFAULT ((0))
GO

-------------------------------------------------------------------------------------------------------------------------


CREATE TABLE [dbo].[DOes](
	[DOID] [int] IDENTITY(1,1) NOT NULL,
	[Date] [datetime] NOT NULL,
	[DONo] [varchar](50) NOT NULL,
	[SupplierID] [int] NOT NULL,
	[CustomerID] [int] NOT NULL,
	[Status] [int] NOT NULL,
	[Remarks] [nvarchar](max) NULL,
	[TotalAmt] [decimal](18, 2) NOT NULL,
	[ConcernID] [int] NOT NULL,
	[PaidAmt] [decimal](18, 2) NOT NULL,
	[CreatedBy] [int] NOT NULL,
	[CreateDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NULL,
	[ModifiedDate] [datetime] NULL,
	[NetDiscount] [decimal](18, 2) NOT NULL,
	[GrandTotal] [decimal](18, 2) NOT NULL,
	[FlatDiscount] [decimal](18, 2) NOT NULL,
	[FlatDiscountPer] [decimal](18, 2) NOT NULL,
 CONSTRAINT [PK_DOs] PRIMARY KEY CLUSTERED 
(
	[DOID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

ALTER TABLE [dbo].[DOes] ADD  CONSTRAINT [DF_DOes_SupplierID]  DEFAULT ((0)) FOR [SupplierID]
GO

ALTER TABLE [dbo].[DOes] ADD  CONSTRAINT [DF_DOes_CustomerID]  DEFAULT ((0)) FOR [CustomerID]
GO

ALTER TABLE [dbo].[DOes] ADD  CONSTRAINT [DF_DOs_TotalAmt]  DEFAULT ((0)) FOR [TotalAmt]
GO

ALTER TABLE [dbo].[DOes] ADD  CONSTRAINT [DF_DOes_PaidAmt]  DEFAULT ((0)) FOR [PaidAmt]
GO

ALTER TABLE [dbo].[DOes] ADD  CONSTRAINT [DF_DOs_CreatedBy]  DEFAULT ((1)) FOR [CreatedBy]
GO

ALTER TABLE [dbo].[DOes] ADD  CONSTRAINT [DF_DOes_NetDiscount]  DEFAULT ((0)) FOR [NetDiscount]
GO

ALTER TABLE [dbo].[DOes] ADD  CONSTRAINT [DF_DOes_GrandTotal]  DEFAULT ((0)) FOR [GrandTotal]
GO

ALTER TABLE [dbo].[DOes] ADD  CONSTRAINT [DF_DOes_FlatDiscount]  DEFAULT ((0)) FOR [FlatDiscount]
GO

ALTER TABLE [dbo].[DOes] ADD  CONSTRAINT [DF_DOes_FlatDiscountPer]  DEFAULT ((0)) FOR [FlatDiscountPer]
GO

ALTER TABLE [dbo].[DOes]  WITH CHECK ADD  CONSTRAINT [FK_DOs_SisterConcerns] FOREIGN KEY([ConcernID])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[DOes] CHECK CONSTRAINT [FK_DOs_SisterConcerns]
GO



-------------------------------------------------------------------------------------------------------------------------

CREATE TABLE [dbo].[DODetails](
	[DODID] [int] IDENTITY(1,1) NOT NULL,
	[ProductID] [int] NOT NULL,
	[DOQty] [decimal](18, 2) NOT NULL,
	[GivenQty] [decimal](18, 2) NOT NULL,
	[MRP] [decimal](18, 4) NOT NULL,
	[TotalAmt] [decimal](18, 4) NOT NULL,
	[DOID] [int] NOT NULL,
	[ColorID] [int] NOT NULL,
	[DDLiftingPrice] [decimal](18, 2) NOT NULL,
	[UnitPrice] [decimal](18, 2) NOT NULL,
	[PPDisPercent] [decimal](18, 2) NOT NULL,
	[PPDisAmt] [decimal](18, 2) NOT NULL,
 CONSTRAINT [PK_DODetails] PRIMARY KEY CLUSTERED 
(
	[DODID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[DODetails] ADD  CONSTRAINT [DF_DODetails_DOQty]  DEFAULT ((0)) FOR [DOQty]
GO

ALTER TABLE [dbo].[DODetails] ADD  CONSTRAINT [DF_DODetails_ColorID]  DEFAULT ((0)) FOR [ColorID]
GO

ALTER TABLE [dbo].[DODetails] ADD  CONSTRAINT [DF_DODetails_DDLiftingPrice]  DEFAULT ((0)) FOR [DDLiftingPrice]
GO

ALTER TABLE [dbo].[DODetails] ADD  CONSTRAINT [DF_DODetails_UnitPrice]  DEFAULT ((0)) FOR [UnitPrice]
GO

ALTER TABLE [dbo].[DODetails] ADD  CONSTRAINT [DF_DODetails_PPDisPercent]  DEFAULT ((0)) FOR [PPDisPercent]
GO

ALTER TABLE [dbo].[DODetails] ADD  CONSTRAINT [DF_DODetails_PPDisAmt]  DEFAULT ((0)) FOR [PPDisAmt]
GO

ALTER TABLE [dbo].[DODetails]  WITH CHECK ADD  CONSTRAINT [FK_DODetails_DOs] FOREIGN KEY([DOID])
REFERENCES [dbo].[DOes] ([DOID])
GO

ALTER TABLE [dbo].[DODetails] CHECK CONSTRAINT [FK_DODetails_DOs]
GO

ALTER TABLE [dbo].[DODetails]  WITH CHECK ADD  CONSTRAINT [FK_DODetails_Products] FOREIGN KEY([ProductID])
REFERENCES [dbo].[Products] ([ProductID])
GO

ALTER TABLE [dbo].[DODetails] CHECK CONSTRAINT [FK_DODetails_Products]
GO



-------------------------------------------------------------------------------------------------------------------------

ALTER TABLE dbo.SystemInformations ADD
	IsDOShow int NOT NULL CONSTRAINT DF_SystemInformations_IsDOShow DEFAULT ((0))
GO
-------------------------------------------------------------------------------------------------------------------------

EXEC sys.sp_rename 'dbo.InsertPODetailTable', 'zInsertPODetailTable';
GO

CREATE TYPE [dbo].[InsertPODetailTable] AS TABLE(
	[POrderDetailId] [int] NULL,
	[ProductId] [int] NULL,
	[ColorId] [int] NULL,
	[Status] [int] NULL,
	[Quantity] [decimal](18, 2) NULL,
	[UnitPrice] [decimal](18, 2) NULL,
	[TAmount] [decimal](18, 2) NULL,
	[PPDisPer] [decimal](18, 2) NULL,
	[PPDisAmt] [decimal](18, 2) NULL,
	[MrpRate] [decimal](18, 2) NULL,
	[SalesRate] [decimal](18, 2) NULL,
	[ExtraPPDISPer] [decimal](18, 2) NULL,
	[ExtraPPDISAmt] [decimal](18, 2) NULL,
	[PPOffer] [decimal](18, 2) NULL,
	[CreditSalesRate] [decimal](18, 2) NULL,
	[CRSalesRate12Month] [decimal](18, 2) NULL,
	[CRSalesRate3Month] [decimal](18, 2) NULL,
	[GodownId] [int] NULL,
	[DOrderDetailId] [int] NULL
)
GO

DECLARE @Name NVARCHAR(776);

DECLARE REF_CURSOR CURSOR FOR
SELECT referencing_schema_name + '.' + referencing_entity_name
FROM sys.dm_sql_referencing_entities('dbo.InsertPODetailTable', 'TYPE');

OPEN REF_CURSOR;

FETCH NEXT FROM REF_CURSOR INTO @Name;
WHILE (@@FETCH_STATUS = 0)
BEGIN
    EXEC sys.sp_refreshsqlmodule @name = @Name;
    FETCH NEXT FROM REF_CURSOR INTO @Name;
END;

CLOSE REF_CURSOR;
DEALLOCATE REF_CURSOR;
GO
DROP TYPE dbo.zInsertPODetailTable;
GO

-------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[AddPurchaseOrder] (
	@PurchaseOrder [InsertPurchaseOrderTable] readonly
	,@PODetails [InsertPODetailTable] readonly
	,@POProductDetails [InsertPOProductDetailTable] readonly
	,@Stocks [InsertStockTable] readonly
	,@StockDetails [InsertStockDetailTable] readonly,
	@PorderID int out,
	@Result int Out
	)
AS
DECLARE @PurchaseOrderId INT
DECLARE @GrandTotal DECIMAL(18, 2)
		,@NetDiscount DECIMAL(18, 2)
		,@FlatDis DECIMAL(18, 2)
		,@Adjustment DECIMAL(18, 2)

--***************Product Type*****************
--ExistingBC = 1,
--NoBarcode = 2,
--AutoBC = 3
--***************Product Type*****************

BEGIN TRY
	BEGIN TRANSACTION

	INSERT INTO POrders (
		OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPDisAmt
		,NetDiscount
		,LaborCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,ActionStatus
		,VATPercentage,
		VATAmount
		) (
		SELECT OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPTDisAmt
		,NetDiscount
		,LabourCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,1,
		VatPercentage,
		VatAmount
		 FROM @PurchaseOrder
		)

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue + p.PaymentDue)
	FROM @PurchaseOrder p
	JOIN Suppliers ON Suppliers.SupplierID = p.SupplierId
	WHERE p.IsDamageOrder != 1

	SET @PurchaseOrderId = SCOPE_IDENTITY()
	SET @GrandTotal = ISNULL((
				SELECT GrandTotal
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @NetDiscount = ISNULL((
				SELECT NetDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @FlatDis = ISNULL((
				SELECT TDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
    SET @Adjustment = ISNULL((
				SELECT AdjAmount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)

	INSERT INTO PriceProtections (
		ProductID
		,ColorID
		,PrvPrice
		,ChangePrice
		,POrderID
		,ConcernID
		,SupplierID
		,PrvStockQty
		,PChangeDate
		) (
		SELECT stk.ProductId
		,stk.ColorId
		,stk.MRPPrice
		,stkt.MRPPrice
		,@PurchaseOrderId
		,stk.ConcernID
		,(
			SELECT SupplierId
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,stk.Quantity
		,GETDATE() FROM @Stocks stkt INNER JOIN Stocks stk ON stk.ProductID = stkt.ProductId
		AND stk.ColorID = stkt.ColorId WHERE stk.MRPPrice > stkt.MRPPrice
		)

	INSERT INTO POrderDetails (
		ProductID
		,ColorID
		,Quantity
		,UnitPrice
		,TAmount
		,PPDISPer
		,PPDISAmt
		,MRPRate
		,POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOFFER
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownID
		,DOrderDetailId
		) (
		SELECT ProductId
		,ColorId
		,Quantity
		,UnitPrice
		,TAmount
		,PPDisPer
		,PPDisAmt
		,MrpRate
		,@PurchaseOrderId POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOffer
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownId
		,DOrderDetailId FROM @PODetails
		)

	INSERT INTO POProductDetails (
		ProductID
		,ColorID
		,IMENO
		,POrderDetailID
		,DamagePOPDID
		) (
		SELECT POPD.ProductId
		,POPD.ColorId
		,POPD.IMENo
		,POD.POrderDetailID
		,DamagePOPDID FROM @POProductDetails POPD INNER JOIN POrderDetails POD ON POD.ProductID = POPD.ProductId
		AND POD.ColorID = POPD.ColorId
		AND POD.POrderID = @PurchaseOrderId
		)

	UPDATE POProductDetails
	SET IsDamageReplaced = 1
	FROM @POProductDetails dtPOPD
	JOIN POProductDetails POPD ON dtPOPD.DamagePOPDID = POPD.POPDID

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity + s.Quantity)
		,Stocks.MRPPrice = s.MRPPrice
		,LPPrice = s.LPPrice
		,ModifiedBy = s.CreatedBy
		,ModifiedDate = s.CreateDate
	FROM @Stocks s
	JOIN Stocks ON Stocks.StockID = s.StockID

	INSERT INTO Stocks (
		StockCode
		,EntryDate
		,Quantity
		,ProductID
		,ColorID
		,MRPPrice
		,LPPrice
		,ConcernID
		,CreatedBy
		,CreateDate
		,GodownID
		) (
		SELECT StockCode
		,EntryDate
		,Quantity
		,ProductId
		,ColorId
		,MRPPrice
		,LPPrice
		,ConcernId
		,CreatedBy
		,CreateDate
		,GodownId FROM @Stocks WHERE StockId IS NULL
		)

	--************For Nobarcode*****************
	INSERT INTO StockDetails (
		StockID
		,StockCode
		,ProductID
		,ColorID
		,POrderDetailID
		,IMENO
		,STATUS
		,PRate
		,SRate
		,CreditSRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,Quantity
		,GodownID
		) (
		SELECT stk.StockID
		,stkd.StockCode
		,stkd.ProductId
		,stkd.ColorId
		,POD.POrderDetailID
		,stkd.IMENo
		,stkd.STATUS
		,(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment))))
		,stkd.SalesRate
		,stkd.CreditSRate
		,POD.CRSalesRate12Month
		,POD.CRSalesRate3Month
		,POD.Quantity
		,stkd.GodownId FROM @StockDetails stkd INNER JOIN Stocks stk ON stk.ProductID = stkd.ProductId
		AND stk.ColorID = stkd.ColorID
		AND stk.GodownID = stkd.GodownId INNER JOIN POrderDetails POD ON POD.ProductID = stkd.ProductId
		AND POD.ColorID = stkd.ColorId
		AND POD.GodownID = stkd.GodownID
		AND POD.POrderID = @PurchaseOrderId INNER JOIN Products P ON P.ProductID = stk.ProductID WHERE P.ProductType = 2
		)

	--************For Nobarcode*****************
	--************For barcode*******************
	INSERT INTO StockDetails (
		StockID
		,StockCode
		,ProductID
		,ColorID
		,POrderDetailID
		,IMENO
		,STATUS
		,PRate
		,SRate
		,CreditSRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,Quantity
		,GodownID
		) (
		SELECT stk.StockID
		,stkd.StockCode
		,stkd.ProductId
		,stkd.ColorId
		,POD.POrderDetailID
		,stkd.IMENo
		,stkd.STATUS
		,(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment))))
		,stkd.SalesRate
		,stkd.CreditSRate
		,POD.CRSalesRate12Month
		,POD.CRSalesRate3Month
		,0
		,stkd.GodownId FROM @StockDetails stkd INNER JOIN Stocks stk ON stk.ProductID = stkd.ProductId
		AND stk.ColorID = stkd.ColorID
		AND stk.GodownID = stkd.GodownId INNER JOIN POrderDetails POD ON POD.ProductID = stkd.ProductId
		AND POD.ColorID = stkd.ColorId
		AND POD.GodownID = stkd.GodownId
		AND POD.POrderID = @PurchaseOrderId INNER JOIN Products P ON P.ProductID = stk.ProductID WHERE P.ProductType != 2
		)


	INSERT INTO TransactionPOrders (
		OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPDisAmt
		,NetDiscount
		,LaborCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,ActionStatus
		,POrderID
		) (
		SELECT OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPTDisAmt
		,NetDiscount
		,LabourCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,1
		,@PurchaseOrderId
		 FROM @PurchaseOrder
		)
	INSERT INTO TransactionPOrderDetails (
		ProductID
		,ColorID
		,Quantity
		,UnitPrice
		,TAmount
		,PPDISPer
		,PPDISAmt
		,MRPRate
		,POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOFFER
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownID
		,ActionStatus
		,ActionBy
		,ActionDate
		) (
		SELECT ProductId
		,ColorId
		,Quantity
		,UnitPrice
		,TAmount
		,PPDisPer
		,PPDisAmt
		,MrpRate
		,@PurchaseOrderId POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOffer
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownId
		,1
		,(
			SELECT CreatedBy
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,(
			SELECT CreateDate
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		FROM @PODetails
		)


	---**************Update DO**********************
  update do set GivenQty = GivenQty+sd.Quantity
	  from @PODetails sd 
	  join DODetails do on sd.ProductId = do.ProductID
	  where sd.DOrderDetailId = do.DODID

	--************For barcode*******************
	COMMIT
	SELECT @PorderID=@PurchaseOrderId,@Result=1;
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		ROLLBACK

	SELECT @PorderID=0,@Result=0
	--RETURN 0;
END CATCH


----------COMMONSOURCE----------
-------------Nahid--------------
----------09-12-2024------------

ALTER PROCEDURE [dbo].[sp_ProductWiseBenefitReport] (
	@Fromdate DATETIME,
	@ToDate DATETIME,
	@ConcernID INT
	)
AS
WITH Final_table
AS (
	SELECT P.Code,
		P.ProductID,
		P.ProductName,
		SO.InvoiceDate AS 'SalesDate',
		C.Description AS 'CategoryName',		
		STD.IMENO,
		SOD.Quantity AS 'Quantity',
		(((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity AS 'SalesTotal',
		(SOD.PPDAmount + (((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity AS 'Discount',
		(SOD.PRate * SOD.Quantity) AS 'PurchaseTotal',
		((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity) - (SOD.PRate* SOD.Quantity) AS 'CommisionProfit',
		0.00 AS 'HireProfit',
		0.00 AS 'HireCollection',
		((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity) - (SOD.PRate * SOD.Quantity) AS 'TotalProfit'
	FROM SOrderDetails SOD
	INNER JOIN SOrders SO ON SOD.SOrderID = SO.SOrderID
	INNER JOIN StockDetails STD ON STD.SDetailID = SOD.SDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE SO.STATUS = 1 ANd SO.IsReplacement = 0 AND SO.InvoiceDate >= @Fromdate AND SO.InvoiceDate <= @ToDate AND SO.ConcernID = @ConcernID
	
	UNION ALL
	
	SELECT P.Code,
		P.ProductID,
		P.ProductName,
		SO.ReturnDate AS 'SalesDate',
		C.Description AS 'CategoryName',		
		STD.IMENO,
		(SOD.Quantity) * (-1) AS 'Quantity',
		(SOD.UnitPrice* SOD.Quantity) * (-1) AS 'SalesTotal',
		0 AS 'Discount',
		(STD.PRate * SOD.Quantity) * ( -1) AS 'PurchaseTotal',
		((SOD.UnitPrice* SOD.Quantity) - (STD.PRate*SOD.Quantity ))* -1 AS 'CommisionProfit',
		0.00 AS 'HireProfit',
		0.00 AS 'HireCollection',
		((SOD.UnitPrice* SOD.Quantity) - (STD.PRate*SOD.Quantity ))* -1 AS 'TotalProfit'
	FROM ROrderDetails SOD
	INNER JOIN ROrders SO ON SOD.ROrderID = SO.ROrderID
	INNER JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE SO.ReturnDate >= @Fromdate AND SO.ReturnDate <= @ToDate AND SO.ConcernID = @ConcernID
	
	UNION ALL
	
	SELECT p.Code,
		P.ProductID,
		P.ProductName,
		CS.SalesDate AS 'SalesDate',
		C.Description AS 'CategoryName',	
		STD.IMENO,
		CSP.Quantity AS 'Quantity',
		(((CSP.UnitPrice+CSP.IntTotalAmt)-((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt)) * CSP.Quantity) AS 'SalesTotal',
		((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt) * CSP.Quantity AS 'Discount',
		STD.PRate * CSP.Quantity AS 'PurchaseTotal',
		(((CSP.UnitPrice)-((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt)) * CSP.Quantity) - (STD.PRate * CSP.Quantity) AS 'CommisionProfit',
		(CSP.IntTotalAmt * CSP.Quantity) AS 'HireProfit',
		0 AS 'HireCollection',
		0 AS 'TotalProfit'
	FROM CreditSaleDetails CSP
	INNER JOIN CreditSales CS ON CS.CreditSalesID = CSP.CreditSalesID
	INNER JOIN StockDetails STD ON STD.SDetailID = CSP.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.IsStatus=1
	
	UNION ALL
	
	SELECT P.Code,
		P.ProductID,
		P.ProductName,
		CS.SalesDate AS 'SalesDate',
		C.Description AS 'CategoryName',		
		Std.IMENO,
		0 AS 'Quantity',
		0 AS 'SalesTotal',
		0 AS 'Discount',
		0 AS 'PurchaseTotal',
		0 AS 'CommisionProfit',
		0 AS 'HireProfit',
		SUM(HireValue) AS 'HireCollection',
		SUM(HireValue) AS 'TotalProfit'
	FROM CreditSales CS
	INNER JOIN CreditSaleDetails CSP ON CSP.CreditSalesID = CS.CreditSalesID
	INNER JOIN CreditSalesSchedules CSD ON CSD.CreditSalesID = CS.CreditSalesID
	INNER JOIN StockDetails STD ON STD.SDetailID = CSP.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID AND CS.IsStatus=1
	GROUP BY P.Code,
		P.ProductID,
		P.ProductName,
		CS.SalesDate,
		C.Description,
		Std.IMENO
	)
SELECT Code,
	ProductID,
	ProductName,
	SalesDate,
	CategoryName,	
	IMENO,
	sum(Quantity) AS 'Quantity',
	sum(SalesTotal + Discount) AS 'SalesTotal',
	sum(Discount) AS 'Discount',
	sum(SalesTotal) AS 'NetSales',
	sum(PurchaseTotal) AS 'PurchaseTotal',
	sum(CommisionProfit) AS 'CommisionProfit',
	sum(HireProfit) AS 'HireProfit',
	sum(HireCollection) AS 'HireCollection',
	sum(CommisionProfit) + sum(HireCollection) AS 'TotalProfit'
FROM Final_table
GROUP BY Code,
	ProductID,
	ProductName,
	SalesDate,
	CategoryName,
	IMENO

----------COMMONSOURCE----------
-------------Nahid--------------
----------08-12-2024------------


ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = s.TSQty,
		ActionStatus = ActionStatus + 1
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)

	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId

	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	DECLARE @prevQty DECIMAL(18,2) = (SELECT ISNULL(SUM(s.Quantity), 0) FROM @SODetails s
	INNER JOIN Products P On s.ProductId = p.ProductID
	WHERE s.Status = 4 AND p.ProductType !=2)

	UPDATE st
	SET st.Quantity = ((st.Quantity - sod.Qty) + @prevQty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType !=2

	UPDATE st
	SET st.Quantity = ((st.Quantity - sod.Qty)),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	INNER JOIN Products p ON p.ProductID = st.ProductID
	where p.ProductType =2

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	
-- For No barcode Stock Details out and SOrderDetails Insert
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @GodownID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @SOrderDetailID INT
DECLARE @Quantity decimal(18,2)
DECLARE @StockQty decimal(18,2)
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL FOR
SELECT s.ProductId,
       s.colorid,
       s.Compressor,
       s.quantity,
       sorderdetailid
FROM @SODetails s
JOIN products ON products.productid = s.productid
WHERE products.ProductType = 2 AND s.Status = 3

OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID,
     @ColorID,
     @GodownID,
     @Quantity,
     @SOrderDetailID

WHILE @@FETCH_STATUS = 0
BEGIN
    WHILE (@Quantity != 0)
    BEGIN
        -- Get the first available stock detail
        SET @SDetailID = (
            SELECT MIN(SDetailID)
            FROM stockdetails
            WHERE productid = @ProductID AND colorid = @ColorID
            AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
        )

        -- Get the stock quantity
        SET @StockQty = (
            SELECT quantity
            FROM stockdetails
            WHERE sdetailid = @SDetailID
        )

        IF (@StockQty > @Quantity)
        BEGIN
            -- If stock quantity is greater than the order quantity
            --SET @StockQty = @StockQty - @Quantity

            -- Update stock details
            UPDATE stockdetails
            SET quantity = @StockQty - @Quantity
            WHERE sdetailid = @SDetailID			

            -- Insert into order details
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
        ELSE IF (@StockQty < @Quantity)
        BEGIN
            -- If stock quantity is less than order quantity
            --SET @Quantity = @Quantity - @StockQty

            -- Update stock to 0 and change status to 2 (unavailable)
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

			
            -- Insert into order details for partial quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @StockQty,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3
        END
        ELSE
        BEGIN
            -- If stock quantity equals the order quantity, mark as processed
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

            -- Insert the order detail for the exact quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
    END

    FETCH NEXT
    FROM cur
    INTO @ProductID,
         @ColorID,
         @GodownID,
         @Quantity,
         @SOrderDetailID
END

CLOSE cur
DEALLOCATE cur





	--***************************************
	--SR visit Update**************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0
	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT so.InvoiceDate,
		so.invoiceno,
		so.customerid,
		so.vatpercentage,
		so.vatamount,
		so.grandtotal,
		so.TDPercentage,
		so.TDAmount,
		so.netdiscount,
		so.totalamount,
		so.paymentdue,
		so.RecAmount,
		so.adjamount,
		so.totaldue,
		so.STATUS,
		so.concernid,
		so.createdby,
		so.createdate,
		so.totaloffer,
		so.Remarks,
		so.TramsAndCondition,
		so.CardTypeSetupID,
		so.CardPaidAmount,
		so.DepositChargePercent,
		so.BankTransID,
		so.TSQty,
		so.PrevDue,
		so.ActionStatus,
		so.SOrderID
		FROM SOrders so
		INNER JOIN SOrders s on so.SOrderID = s.SOrderID AND s.SOrderID =  @SalesOrderId
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN0;
ENDCATCH

----------COMMONSOURCE----------
-------------Nahid--------------
----------07-12-2024------------


--exec sp_ProfitandLossAccount '2020-01-01 00:00:00','2020-05-04 23:59:59',1
ALTER PROCEDURE [dbo].[sp_ProfitandLossAccount] (@Fromdate DATETIME, @ToDate DATETIME, @ConcernID INT)
AS
BEGIN
	CREATE TABLE #temp (ID INT identity(1, 1) NOT NULL, DebitParticulars NVARCHAR(MAX), Debit DECIMAL(18, 2), CreditParticulars NVARCHAR(MAX), Credit DECIMAL(18, 2), SerialNum INT)

	DECLARE @TotalIncome DECIMAL(18, 2)
	DECLARE @TotalSalesReturn DECIMAL(18, 2)
	DECLARE @TotalPOReturn DECIMAL(18, 2)
	DECLARE @TotalExpense DECIMAL(18, 2)
	DECLARE @LastPayAdjust DECIMAL(18, 2)
	DECLARE @DebitAdjusment DECIMAL(18, 2)
	DECLARE @CreditAdjusment DECIMAL(18, 2)
	DECLARE @SupplierDebitAdjusment DECIMAL(18, 2)
	DECLARE @SupplierCreditAdjusment DECIMAL(18, 2)


	SET @TotalIncome = 0
	SET @TotalExpense = 0

	SELECT @TotalIncome = ISNULL(SUM(SOD.Quantity * ((SOD.UnitPrice - SOD.PPDAmount) - (((SOD.UnitPrice - SOD.PPDAmount) * (SO.TDAmount + SO.AdjAmount)) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)))), 0),
	@TotalExpense = ISNULL(SUM(SOD.PRate * SOD.Quantity), 0)
	FROM SOrderDetails SOD
	INNER JOIN SOrders SO
		ON SOD.SOrderID = SO.SOrderID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.SDetailID
	WHERE SO.STATUS = 1 AND SO.IsReplacement=0 AND (SO.InvoiceDate >= @Fromdate AND SO.InvoiceDate <= @ToDate) AND SO.ConcernID = @ConcernID

	SELECT @TotalSalesReturn = ISNULL(SUM(SOD.Quantity * SOD.UnitPrice), 0), @TotalPOReturn = ISNULL(SUM(STD.PRate * SOD.Quantity), 0)
	FROM ROrderDetails SOD
	INNER JOIN ROrders SO
		ON SOD.ROrderID = SO.ROrderID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailID
	WHERE (SO.ReturnDate >= @Fromdate AND SO.ReturnDate <= @ToDate) AND SO.ConcernID = @ConcernID

	--Print(Convert(varchar(123),@TotalIncome))
	--Print(Convert(varchar(123),@TotalExpense))
	SELECT @TotalIncome = @TotalIncome + ISNULL(SUM(CSP.Quantity * (CSP.UnitPrice - (CS.Discount * CSP.UnitPrice / CS.TSalesAmt))), 0),
	--+ISNULL(SUM((((((CS.InterestAmount) / (CS.TSalesAmt - CS.InterestAmount)) * (CSP.UnitPrice))) * CSP.Quantity) - (((((CS.Discount) / (CS.TSalesAmt - CS.InterestAmount)) * (CSP.UnitPrice))) * CSP.Quantity)),0), 
	@TotalExpense = @TotalExpense + ISNULL(SUM(STD.PRate * CSP.Quantity), 0)
	FROM CreditSaleDetails CSP
	INNER JOIN CreditSales CS
		ON CS.CreditSalesID = CSP.CreditSalesID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = CSP.StockDetailID
	WHERE CS.IsStatus = 1 AND CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CS.ConcernID = @ConcernID
	--Print(Convert(varchar(123),@TotalIncome))
	SELECT @TotalIncome = @TotalIncome + ISNULL(SUM(HireValue), 0)
	FROM CreditSales CS
	INNER JOIN CreditSaleDetails CSP
		ON CSP.CreditSalesID = CS.CreditSalesID
	INNER JOIN CreditSalesSchedules CSD
		ON CSD.CreditSalesID = CS.CreditSalesID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = CSP.StockDetailID
	WHERE Cs.IsStatus = 1 AND CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Purchase', ISNULL(@TotalExpense, 0), '', 0.00, 1)

	IF(@TotalPOReturn>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Purchase Return', ISNULL(@TotalPOReturn, 0), '', 0.00, 2)

	IF(ISNULL(@TotalExpense - @TotalPOReturn, 0)!=0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Net Purchase', ISNULL(@TotalExpense - @TotalPOReturn, 0), '', 0.00, 3)

	IF(@TotalIncome!=0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Sales', @TotalIncome, 4)

	IF(@TotalSalesReturn>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Sales Return', @TotalSalesReturn, 5)

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Net Sales', (@TotalIncome - @TotalSalesReturn), 6)

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Gross Profit', ISNULL((@TotalIncome - @TotalSalesReturn) - (@TotalExpense - @TotalPOReturn), 0), 7)

	--Last Pay adjustment
	SELECT @LastPayAdjust = ISNULL(SUM(CSD.LastPayAdjust), 0)
	FROM CreditSales CS
	INNER JOIN CreditSalesSchedules CSD
		ON CSD.CreditSalesID = CS.CreditSalesID
	WHERE Cs.IsStatus = 1 AND CSD.PaymentDate >= @Fromdate AND CSD.PaymentDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID

	SELECT @LastPayAdjust = @LastPayAdjust + ISNULL(SUM(CS.AdjustAmt), 0)
	FROM CashCollections CS
	WHERE Cs.TransactionType = 1 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@LastPayAdjust>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Bad Debt.', ISNULL(@LastPayAdjust, 0), '', 0.00, 8)

	-- Customer Rate Adjustment(Customer)
	SELECT @DebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 9 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@DebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Rate Adjustment(Customer)', ISNULL(@DebitAdjusment, 0), '', 0.00, 13)

	-- Customer Price Protection(Customer)
	SELECT @DebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 14 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@DebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Price Protection(Customer)', ISNULL(@DebitAdjusment, 0), '', 0.00, 13)

	-- Customer Promo Offer(Customer)
	SELECT @DebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 15 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@DebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Promo Offer(Customer)', ISNULL(@DebitAdjusment, 0), '', 0.00, 13)

	-- Customer KPI(Customer)
	SELECT @DebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 16 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@DebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('KPI(Customer)', ISNULL(@DebitAdjusment, 0), '', 0.00, 13)

	-- Customer Incentive(Customer)
	SELECT @DebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 17 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@DebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Incentive(Customer)', ISNULL(@DebitAdjusment, 0), '', 0.00, 13)

	-- Customer Debit Adjustment
	SELECT @DebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 7 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0 AND S.IsCCDebitCreditAdjHide = 0
	
	IF(@DebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Customer Adjustment', ISNULL(@DebitAdjusment, 0), '', 0.00, 13)


	-- Supplier Rate Adjustment(Supplier)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 8 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Rate Adjustment(Supplier)', ISNULL(@CreditAdjusment, 0), 15)

	-- Supplier Price Protection(Supplier)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 10 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Price Protection(Supplier)', ISNULL(@CreditAdjusment, 0), 15)

	-- Supplier Promo Offer(Supplier)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 11 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Promo Offer(Supplier)', ISNULL(@CreditAdjusment, 0), 15)

	-- Supplier KPI(Supplier)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 12 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'KPI(Supplier)', ISNULL(@CreditAdjusment, 0), 15)

	-- Supplier Incentive(Supplier)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 13 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Incentive(Supplier)', ISNULL(@CreditAdjusment, 0), 15)
		
	-- Customer Credit Adjustment
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 6 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0 AND S.IsCCDebitCreditAdjHide = 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Customer Adjustment', ISNULL(@CreditAdjusment, 0), 15)

	

	--Supplier Debit Adjustment
	SELECT @SupplierDebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 6 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0 AND S.IsCCDebitCreditAdjHide = 0
	
	IF(@SupplierDebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Supplier Debit Adjustment', ISNULL(@SupplierDebitAdjusment, 0), '', 0.00, 14)

		
	--Supplier Credit Adjustment
	SELECT @SupplierCreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 7 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0 AND S.IsCCDebitCreditAdjHide = 0
	
	IF(@SupplierCreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.00, 'Supplier Credit Adjustment', ISNULL(@SupplierCreditAdjusment, 0), 16)

	---------------------Income----------------------
	set @TotalIncome = ISNULL((	SELECT SUM(ex.Amount)
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 2 and ex.CashInHandReportStatus = 0),0)

	IF(@TotalIncome>0)
	BEGIN
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	SELECT '', 0.00, exi.Description, ex.Amount, 9
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 2 and ex.CashInHandReportStatus = 0

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES('',0.00,'Total Income',@TotalIncome,10)
	END

	-----------------------expense----------------------
	set @TotalExpense = ISNULL((SELECT SUM( ex.Amount)
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 1 AND exi.Description != 'Send cash to head of accounts' and ex.CashInHandReportStatus = 0
    ),0)

	IF(@TotalExpense>0)
	BEGIN
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	SELECT exi.Description, ex.Amount, '', 0.00, 11
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 1 AND exi.Description != 'Send cash to head of accounts' and ex.CashInHandReportStatus = 0

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES('Total Expense',@TotalExpense,'',0.00,12)
	END

	SELECT SerialNum, DebitParticulars, sum(Debit) 'Debit', CreditParticulars, sum(Credit) 'Credit'
	FROM #temp
	GROUP BY DebitParticulars, CreditParticulars, SerialNum
	ORDER BY SerialNum ASC
		--Print(Convert(varchar(123),@TotalIncome))



END

----------COMMONSOURCE----------
-------------Nahid--------------
----------04-12-2024------------

--exec sp_ProfitandLossAccount '2020-01-01 00:00:00','2020-05-04 23:59:59',1
ALTER PROCEDURE [dbo].[sp_ProfitandLossAccount] (@Fromdate DATETIME, @ToDate DATETIME, @ConcernID INT)
AS
BEGIN
	CREATE TABLE #temp (ID INT identity(1, 1) NOT NULL, DebitParticulars NVARCHAR(MAX), Debit DECIMAL(18, 2), CreditParticulars NVARCHAR(MAX), Credit DECIMAL(18, 2), SerialNum INT)

	DECLARE @TotalIncome DECIMAL(18, 2)
	DECLARE @TotalSalesReturn DECIMAL(18, 2)
	DECLARE @TotalPOReturn DECIMAL(18, 2)
	DECLARE @TotalExpense DECIMAL(18, 2)
	DECLARE @LastPayAdjust DECIMAL(18, 2)
	DECLARE @DebitAdjusment DECIMAL(18, 2)
	DECLARE @CreditAdjusment DECIMAL(18, 2)
	DECLARE @SupplierDebitAdjusment DECIMAL(18, 2)
	DECLARE @SupplierCreditAdjusment DECIMAL(18, 2)


	SET @TotalIncome = 0
	SET @TotalExpense = 0

	SELECT @TotalIncome = ISNULL(SUM(SOD.Quantity * ((SOD.UnitPrice - SOD.PPDAmount) - (((SOD.UnitPrice - SOD.PPDAmount) * (SO.TDAmount + SO.AdjAmount)) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)))), 0),
	@TotalExpense = ISNULL(SUM(SOD.PRate * SOD.Quantity), 0)
	FROM SOrderDetails SOD
	INNER JOIN SOrders SO
		ON SOD.SOrderID = SO.SOrderID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.SDetailID
	WHERE SO.STATUS = 1 AND SO.IsReplacement=0 AND (SO.InvoiceDate >= @Fromdate AND SO.InvoiceDate <= @ToDate) AND SO.ConcernID = @ConcernID

	SELECT @TotalSalesReturn = ISNULL(SUM(SOD.Quantity * SOD.UnitPrice), 0), @TotalPOReturn = ISNULL(SUM(STD.PRate * SOD.Quantity), 0)
	FROM ROrderDetails SOD
	INNER JOIN ROrders SO
		ON SOD.ROrderID = SO.ROrderID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailID
	WHERE (SO.ReturnDate >= @Fromdate AND SO.ReturnDate <= @ToDate) AND SO.ConcernID = @ConcernID

	--Print(Convert(varchar(123),@TotalIncome))
	--Print(Convert(varchar(123),@TotalExpense))
	SELECT @TotalIncome = @TotalIncome + ISNULL(SUM(CSP.Quantity * (CSP.UnitPrice - (CS.Discount * CSP.UnitPrice / CS.TSalesAmt))), 0),
	--+ISNULL(SUM((((((CS.InterestAmount) / (CS.TSalesAmt - CS.InterestAmount)) * (CSP.UnitPrice))) * CSP.Quantity) - (((((CS.Discount) / (CS.TSalesAmt - CS.InterestAmount)) * (CSP.UnitPrice))) * CSP.Quantity)),0), 
	@TotalExpense = @TotalExpense + ISNULL(SUM(STD.PRate * CSP.Quantity), 0)
	FROM CreditSaleDetails CSP
	INNER JOIN CreditSales CS
		ON CS.CreditSalesID = CSP.CreditSalesID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = CSP.StockDetailID
	WHERE CS.IsStatus = 1 AND CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CS.ConcernID = @ConcernID
	--Print(Convert(varchar(123),@TotalIncome))
	SELECT @TotalIncome = @TotalIncome + ISNULL(SUM(HireValue), 0)
	FROM CreditSales CS
	INNER JOIN CreditSaleDetails CSP
		ON CSP.CreditSalesID = CS.CreditSalesID
	INNER JOIN CreditSalesSchedules CSD
		ON CSD.CreditSalesID = CS.CreditSalesID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = CSP.StockDetailID
	WHERE Cs.IsStatus = 1 AND CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Purchase', ISNULL(@TotalExpense, 0), '', 0.00, 1)

	IF(@TotalPOReturn>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Purchase Return', ISNULL(@TotalPOReturn, 0), '', 0.00, 2)

	IF(ISNULL(@TotalExpense - @TotalPOReturn, 0)!=0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Net Purchase', ISNULL(@TotalExpense - @TotalPOReturn, 0), '', 0.00, 3)

	IF(@TotalIncome!=0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Sales', @TotalIncome, 4)

	IF(@TotalSalesReturn>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Sales Return', @TotalSalesReturn, 5)

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Net Sales', (@TotalIncome - @TotalSalesReturn), 6)

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Gross Profit', ISNULL((@TotalIncome - @TotalSalesReturn) - (@TotalExpense - @TotalPOReturn), 0), 7)

	--Last Pay adjustment
	SELECT @LastPayAdjust = ISNULL(SUM(CSD.LastPayAdjust), 0)
	FROM CreditSales CS
	INNER JOIN CreditSalesSchedules CSD
		ON CSD.CreditSalesID = CS.CreditSalesID
	WHERE Cs.IsStatus = 1 AND CSD.PaymentDate >= @Fromdate AND CSD.PaymentDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID

	SELECT @LastPayAdjust = @LastPayAdjust + ISNULL(SUM(CS.AdjustAmt), 0)
	FROM CashCollections CS
	WHERE Cs.TransactionType = 1 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@LastPayAdjust>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Bad Debt.', ISNULL(@LastPayAdjust, 0), '', 0.00, 8)


	-- Customer Debit Adjustment
	SELECT @DebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 7 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0 AND S.IsCCDebitCreditAdjHide = 0
	
	IF(@DebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Customer Adjustment', ISNULL(@DebitAdjusment, 0), '', 0.00, 13)


	-- Customer Rate Adjustment(Customer)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 9 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Rate Adjustment(Customer)', ISNULL(@CreditAdjusment, 0), 15)

	-- Customer Price Protection(Customer)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 14 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Price Protection(Customer)', ISNULL(@CreditAdjusment, 0), 15)

	-- Customer Promo Offer(Customer)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 15 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Promo Offer(Customer)', ISNULL(@CreditAdjusment, 0), 15)

	-- Customer KPI(Customer)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 16 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'KPI(Customer)', ISNULL(@CreditAdjusment, 0), 15)

		-- Customer Incentive(Customer)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 17 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Incentive(Customer)', ISNULL(@CreditAdjusment, 0), 15)
		
	-- Customer Credit Adjustment
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 6 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0 AND S.IsCCDebitCreditAdjHide = 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Customer Adjustment', ISNULL(@CreditAdjusment, 0), 15)

	

	--Supplier Debit Adjustment
	SELECT @SupplierDebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 6 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0 AND S.IsCCDebitCreditAdjHide = 0
	
	IF(@SupplierDebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Supplier Debit Adjustment', ISNULL(@SupplierDebitAdjusment, 0), '', 0.00, 14)

		
	--Supplier Credit Adjustment
	SELECT @SupplierCreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 7 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0 AND S.IsCCDebitCreditAdjHide = 0
	
	IF(@SupplierCreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.00, 'Supplier Credit Adjustment', ISNULL(@SupplierCreditAdjusment, 0), 16)

	---------------------Income----------------------
	set @TotalIncome = ISNULL((	SELECT SUM(ex.Amount)
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 2 and ex.CashInHandReportStatus = 0),0)

	IF(@TotalIncome>0)
	BEGIN
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	SELECT '', 0.00, exi.Description, ex.Amount, 9
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 2 and ex.CashInHandReportStatus = 0

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES('',0.00,'Total Income',@TotalIncome,10)
	END

	-----------------------expense----------------------
	set @TotalExpense = ISNULL((SELECT SUM( ex.Amount)
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 1 AND exi.Description != 'Send cash to head of accounts' and ex.CashInHandReportStatus = 0
    ),0)

	IF(@TotalExpense>0)
	BEGIN
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	SELECT exi.Description, ex.Amount, '', 0.00, 11
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 1 AND exi.Description != 'Send cash to head of accounts' and ex.CashInHandReportStatus = 0

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES('Total Expense',@TotalExpense,'',0.00,12)
	END

	SELECT SerialNum, DebitParticulars, sum(Debit) 'Debit', CreditParticulars, sum(Credit) 'Credit'
	FROM #temp
	GROUP BY DebitParticulars, CreditParticulars, SerialNum
	ORDER BY SerialNum ASC
		--Print(Convert(varchar(123),@TotalIncome))



END

----------Ezone----------
-------------Rizve--------------
----------03-12-2024------------
ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = s.TSQty,
		ActionStatus = ActionStatus + 1
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)

	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId

	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = st.Quantity,ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	
-- For No barcode Stock Details out and SOrderDetails Insert
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @GodownID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @SOrderDetailID INT
DECLARE @Quantity decimal(18,2)
DECLARE @StockQty decimal(18,2)
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL FOR
SELECT s.ProductId,
       s.colorid,
       s.Compressor,
       s.quantity,
       sorderdetailid
FROM @SODetails s
JOIN products ON products.productid = s.productid
WHERE products.ProductType = 2 AND s.Status = 3

OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID,
     @ColorID,
     @GodownID,
     @Quantity,
     @SOrderDetailID

WHILE @@FETCH_STATUS = 0
BEGIN
    WHILE (@Quantity != 0)
    BEGIN
        -- Get the first available stock detail
        SET @SDetailID = (
            SELECT MIN(SDetailID)
            FROM stockdetails
            WHERE productid = @ProductID AND colorid = @ColorID
            AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
        )

        -- Get the stock quantity
        SET @StockQty = (
            SELECT quantity
            FROM stockdetails
            WHERE sdetailid = @SDetailID
        )

        IF (@StockQty > @Quantity)
        BEGIN
            -- If stock quantity is greater than the order quantity
            --SET @StockQty = @StockQty - @Quantity

            -- Update stock details
            UPDATE stockdetails
            SET quantity = @StockQty - @Quantity
            WHERE sdetailid = @SDetailID

			UPDATE st
	SET st.Quantity = st.Quantity - @Quantity, ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

            -- Insert into order details
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
        ELSE IF (@StockQty < @Quantity)
        BEGIN
            -- If stock quantity is less than order quantity
            --SET @Quantity = @Quantity - @StockQty

            -- Update stock to 0 and change status to 2 (unavailable)
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

			UPDATE st
	SET st.Quantity = @StockQty, ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

            -- Insert into order details for partial quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @StockQty,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3
        END
        ELSE
        BEGIN
            -- If stock quantity equals the order quantity, mark as processed
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

			UPDATE st
	SET st.Quantity = @StockQty - @Quantity,ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

            -- Insert the order detail for the exact quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
    END

    FETCH NEXT
    FROM cur
    INTO @ProductID,
         @ColorID,
         @GodownID,
         @Quantity,
         @SOrderDetailID
END

CLOSE cur
DEALLOCATE cur





	--***************************************
	--*********SR visit Update***************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0
	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT so.InvoiceDate,
		so.invoiceno,
		so.customerid,
		so.vatpercentage,
		so.vatamount,
		so.grandtotal,
		so.TDPercentage,
		so.TDAmount,
		so.netdiscount,
		so.totalamount,
		so.paymentdue,
		so.RecAmount,
		so.adjamount,
		so.totaldue,
		so.STATUS,
		so.concernid,
		so.createdby,
		so.createdate,
		so.totaloffer,
		so.Remarks,
		so.TramsAndCondition,
		so.CardTypeSetupID,
		so.CardPaidAmount,
		so.DepositChargePercent,
		so.BankTransID,
		so.TSQty,
		so.PrevDue,
		so.ActionStatus,
		so.SOrderID
		FROM SOrders so
		INNER JOIN SOrders s on so.SOrderID = s.SOrderID AND s.SOrderID =  @SalesOrderId
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH
GO



----------COMMONSOURCE----------
-------------Nahid--------------
----------03-12-2024------------


ALTER FUNCTION [dbo].[CheckProductStatusByPOId]
(
  @PurchaseOrderId int
)  
  RETURNS int
AS 
 BEGIN
	DECLARE	@Sold int
    
    SELECT @Sold = COUNT(*)
	FROM StockDetails
	JOIN POrderDetails POD ON POD.POrderDetailID = StockDetails.POrderDetailID 
	join POrders PO on POD.POrderID = PO.POrderID
	JOIN SOrderDetails sod on sod.SDetailID = StockDetails.SDetailID
	join Products p on POD.ProductID = p.ProductID
	WHERE p.ProductType <> 2 AND POD.POrderID = @PurchaseOrderId AND StockDetails.Status = 2
	
	--IF @Sold IS NULL
	--  SET @Sold=0

	IF @Sold IS NULL OR @Sold = 0
		begin
			SET @Sold=0

			set @Sold =  (select ISNULL(COUNT(*), 0) FROM StockDetails sd
			JOIN POrderDetails POD ON POD.POrderDetailID = sd.POrderDetailID 
			join POrders PO on POD.POrderID = PO.POrderID
			JOIN SOrderDetails sod on sod.SDetailID = sd.SDetailID
			join Products p on POD.ProductID = p.ProductID
			WHERE p.ProductType = 2 and POD.POrderID = @PurchaseOrderId)
			--and POD.Quantity != sd.Quantity


		end
	  
	RETURN@Sold
END

----------COMMONSOURCE----------
-------------Nahid--------------
----------25-11-2024------------



ALTER view [dbo].[vw_StockReportWithDays] as
select PO.ChallanNo,CA.Description,P.ProductName,SD.IMENO,Date= PO.OrderDate,
NoOfDate = DATEDIFF(d, OrderDate, GETDATE()),PO.ConcernID,P.ProductID,SD.Status, COM.CompanyID,CA.CategoryID, COM.Name AS CompanyName, CA.Description AS CategoryName
from POrders PO 
Inner Join POrderDetails POD on PO.POrderID=POD.POrderID
Inner Join Products P on P.ProductID=POD.ProductID and P.ConcernID=P.ConcernID
Inner Join Categorys CA on CA.CategoryID=P.CategoryID and CA.ConcernID=P.ConcernID
INNER Join Companies COM on COM.CompanyID=p.CompanyID AND COM.ConcernID = P.ConcernID
Inner Join StockDetails SD on SD.POrderDetailID=POD.POrderDetailID
where SD.Status=1
--PO.ConcernID=1 and
union
select TS.TransferNo,CA.Description,P.ProductName,SD.IMENO,Date= TS.TransferDate,
NoOfDate = DATEDIFF(d, TransferDate, GETDATE()),TS.ToConcernID as ConcernID,P.ProductID,SD.Status, COM.CompanyID,CA.CategoryID, COM.Name AS CompanyName, CA.Description AS CategoryName
from Transfers TS
Inner Join TransferDetails TSD on TS.TransferID=TSD.TransferID
Inner Join Products P on P.ProductID=TSD.ToProductID and P.ConcernID=P.ConcernID
Inner Join Categorys CA on CA.CategoryID=P.CategoryID and CA.ConcernID=P.ConcernID
INNER Join Companies COM on COM.CompanyID=p.CompanyID AND com.ConcernID = P.ConcernID
Inner Join StockDetails SD on SD.TransferDetailID=TSD.TDetailID
where SD.Status=1 and SD.TransferDetailID !=0
--TS.ToConcernID=1 and
GO


----------------------------------------------------------------------------------------------------------------------------------



ALTER PROCEDURE [dbo].[SP_getStockDataWithDays] (
	@concernId int, 
	@productId int,
	@companyId int,
	@categoryId int
)
AS
	IF @productId>0
	BEGIN
	  Select * from vw_StockReportWithDays where ConcernID=@concernId and ProductID=@productId
	END
	IF @companyId> 0
	BEGIN
	  Select * from vw_StockReportWithDays where ConcernID=@concernId and CompanyID =@companyId
	END
	IF @categoryId> 0
	BEGIN
	  Select * from vw_StockReportWithDays where ConcernID=@concernId and CategoryID =@categoryId
	END
	ELSE
	BEGIN
	  Select * from vw_StockReportWithDays where ConcernID=@concernId
	END

--------------------------------
-------------Nahid--------------
----------11-11-2024------------

ALTER TABLE dbo.SystemInformations ADD
	IsCCDebitCreditAdjHide int NOT NULL CONSTRAINT DF_SystemInformations_IsCCDebitCreditAdjHide DEFAULT ((0))
GO

----------------------------------------------------------------------------------------------------------------------------------


--exec sp_ProfitandLossAccount '2020-01-01 00:00:00','2020-05-04 23:59:59',1
ALTER PROCEDURE [dbo].[sp_ProfitandLossAccount] (@Fromdate DATETIME, @ToDate DATETIME, @ConcernID INT)
AS
BEGIN
	CREATE TABLE #temp (ID INT identity(1, 1) NOT NULL, DebitParticulars NVARCHAR(MAX), Debit DECIMAL(18, 2), CreditParticulars NVARCHAR(MAX), Credit DECIMAL(18, 2), SerialNum INT)

	DECLARE @TotalIncome DECIMAL(18, 2)
	DECLARE @TotalSalesReturn DECIMAL(18, 2)
	DECLARE @TotalPOReturn DECIMAL(18, 2)
	DECLARE @TotalExpense DECIMAL(18, 2)
	DECLARE @LastPayAdjust DECIMAL(18, 2)
	DECLARE @DebitAdjusment DECIMAL(18, 2)
	DECLARE @CreditAdjusment DECIMAL(18, 2)
	DECLARE @SupplierDebitAdjusment DECIMAL(18, 2)
	DECLARE @SupplierCreditAdjusment DECIMAL(18, 2)


	SET @TotalIncome = 0
	SET @TotalExpense = 0

	SELECT @TotalIncome = ISNULL(SUM(SOD.Quantity * ((SOD.UnitPrice - SOD.PPDAmount) - (((SOD.UnitPrice - SOD.PPDAmount) * (SO.TDAmount + SO.AdjAmount)) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)))), 0),
	@TotalExpense = ISNULL(SUM(SOD.PRate * SOD.Quantity), 0)
	FROM SOrderDetails SOD
	INNER JOIN SOrders SO
		ON SOD.SOrderID = SO.SOrderID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.SDetailID
	WHERE SO.STATUS = 1 AND SO.IsReplacement=0 AND (SO.InvoiceDate >= @Fromdate AND SO.InvoiceDate <= @ToDate) AND SO.ConcernID = @ConcernID

	SELECT @TotalSalesReturn = ISNULL(SUM(SOD.Quantity * SOD.UnitPrice), 0), @TotalPOReturn = ISNULL(SUM(STD.PRate * SOD.Quantity), 0)
	FROM ROrderDetails SOD
	INNER JOIN ROrders SO
		ON SOD.ROrderID = SO.ROrderID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailID
	WHERE (SO.ReturnDate >= @Fromdate AND SO.ReturnDate <= @ToDate) AND SO.ConcernID = @ConcernID

	--Print(Convert(varchar(123),@TotalIncome))
	--Print(Convert(varchar(123),@TotalExpense))
	SELECT @TotalIncome = @TotalIncome + ISNULL(SUM(CSP.Quantity * (CSP.UnitPrice - (CS.Discount * CSP.UnitPrice / CS.TSalesAmt))), 0),
	--+ISNULL(SUM((((((CS.InterestAmount) / (CS.TSalesAmt - CS.InterestAmount)) * (CSP.UnitPrice))) * CSP.Quantity) - (((((CS.Discount) / (CS.TSalesAmt - CS.InterestAmount)) * (CSP.UnitPrice))) * CSP.Quantity)),0), 
	@TotalExpense = @TotalExpense + ISNULL(SUM(STD.PRate * CSP.Quantity), 0)
	FROM CreditSaleDetails CSP
	INNER JOIN CreditSales CS
		ON CS.CreditSalesID = CSP.CreditSalesID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = CSP.StockDetailID
	WHERE CS.IsStatus = 1 AND CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CS.ConcernID = @ConcernID
	--Print(Convert(varchar(123),@TotalIncome))
	SELECT @TotalIncome = @TotalIncome + ISNULL(SUM(HireValue), 0)
	FROM CreditSales CS
	INNER JOIN CreditSaleDetails CSP
		ON CSP.CreditSalesID = CS.CreditSalesID
	INNER JOIN CreditSalesSchedules CSD
		ON CSD.CreditSalesID = CS.CreditSalesID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = CSP.StockDetailID
	WHERE Cs.IsStatus = 1 AND CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Purchase', ISNULL(@TotalExpense, 0), '', 0.00, 1)

	IF(@TotalPOReturn>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Purchase Return', ISNULL(@TotalPOReturn, 0), '', 0.00, 2)

	IF(ISNULL(@TotalExpense - @TotalPOReturn, 0)!=0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Net Purchase', ISNULL(@TotalExpense - @TotalPOReturn, 0), '', 0.00, 3)

	IF(@TotalIncome!=0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Sales', @TotalIncome, 4)

	IF(@TotalSalesReturn>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Sales Return', @TotalSalesReturn, 5)

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Net Sales', (@TotalIncome - @TotalSalesReturn), 6)

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Gross Profit', ISNULL((@TotalIncome - @TotalSalesReturn) - (@TotalExpense - @TotalPOReturn), 0), 7)

	--Last Pay adjustment
	SELECT @LastPayAdjust = ISNULL(SUM(CSD.LastPayAdjust), 0)
	FROM CreditSales CS
	INNER JOIN CreditSalesSchedules CSD
		ON CSD.CreditSalesID = CS.CreditSalesID
	WHERE Cs.IsStatus = 1 AND CSD.PaymentDate >= @Fromdate AND CSD.PaymentDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID

	SELECT @LastPayAdjust = @LastPayAdjust + ISNULL(SUM(CS.AdjustAmt), 0)
	FROM CashCollections CS
	WHERE Cs.TransactionType = 1 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@LastPayAdjust>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Bad Debt.', ISNULL(@LastPayAdjust, 0), '', 0.00, 8)


	-- Customer Debit Adjustment
	SELECT @DebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 7 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0 AND S.IsCCDebitCreditAdjHide = 0
	
	IF(@DebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Customer Adjustment', ISNULL(@DebitAdjusment, 0), '', 0.00, 13)

		
	-- Customer Credit Adjustment
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 6 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0 AND S.IsCCDebitCreditAdjHide = 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Customer Adjustment', ISNULL(@CreditAdjusment, 0), 15)

	

	--Supplier Debit Adjustment
	SELECT @SupplierDebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 6 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0 AND S.IsCCDebitCreditAdjHide = 0
	
	IF(@SupplierDebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Supplier Debit Adjustment', ISNULL(@SupplierDebitAdjusment, 0), '', 0.00, 14)

		
	--Supplier Credit Adjustment
	SELECT @SupplierCreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	INNER JOIN SystemInformations S ON S.ConcernID = CS.ConcernID
	WHERE Cs.TransactionType = 7 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0 AND S.IsCCDebitCreditAdjHide = 0
	
	IF(@SupplierCreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.00, 'Supplier Credit Adjustment', ISNULL(@SupplierCreditAdjusment, 0), 16)

	---------------------Income----------------------
	set @TotalIncome = ISNULL((	SELECT SUM(ex.Amount)
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 2 and ex.CashInHandReportStatus = 0),0)

	IF(@TotalIncome>0)
	BEGIN
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	SELECT '', 0.00, exi.Description, ex.Amount, 9
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 2 and ex.CashInHandReportStatus = 0

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES('',0.00,'Total Income',@TotalIncome,10)
	END

	-----------------------expense----------------------
	set @TotalExpense = ISNULL((SELECT SUM( ex.Amount)
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 1 AND exi.Description != 'Send cash to head of accounts' and ex.CashInHandReportStatus = 0
    ),0)

	IF(@TotalExpense>0)
	BEGIN
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	SELECT exi.Description, ex.Amount, '', 0.00, 11
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 1 AND exi.Description != 'Send cash to head of accounts' and ex.CashInHandReportStatus = 0

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES('Total Expense',@TotalExpense,'',0.00,12)
	END

	SELECT SerialNum, DebitParticulars, sum(Debit) 'Debit', CreditParticulars, sum(Credit) 'Credit'
	FROM #temp
	GROUP BY DebitParticulars, CreditParticulars, SerialNum
	ORDER BY SerialNum ASC
		--Print(Convert(varchar(123),@TotalIncome))



END

--------------------------------
-------------Nahid--------------
----------08-10-2024------------
----------02-12-2024------------


--exec sp_ProfitandLossAccount '2020-01-01 00:00:00','2020-05-04 23:59:59',1
ALTER PROCEDURE [dbo].[sp_ProfitandLossAccount] (@Fromdate DATETIME, @ToDate DATETIME, @ConcernID INT)
AS
BEGIN
	CREATE TABLE #temp (ID INT identity(1, 1) NOT NULL, DebitParticulars NVARCHAR(MAX), Debit DECIMAL(18, 2), CreditParticulars NVARCHAR(MAX), Credit DECIMAL(18, 2), SerialNum INT)

	DECLARE @TotalIncome DECIMAL(18, 2)
	DECLARE @TotalSalesReturn DECIMAL(18, 2)
	DECLARE @TotalPOReturn DECIMAL(18, 2)
	DECLARE @TotalExpense DECIMAL(18, 2)
	DECLARE @LastPayAdjust DECIMAL(18, 2)
	DECLARE @DebitAdjusment DECIMAL(18, 2)
	DECLARE @CreditAdjusment DECIMAL(18, 2)
	DECLARE @SupplierDebitAdjusment DECIMAL(18, 2)
	DECLARE @SupplierCreditAdjusment DECIMAL(18, 2)


	SET @TotalIncome = 0
	SET @TotalExpense = 0

	SELECT @TotalIncome = ISNULL(SUM(SOD.Quantity * ((SOD.UnitPrice - SOD.PPDAmount) - (((SOD.UnitPrice - SOD.PPDAmount) * (SO.TDAmount + SO.AdjAmount)) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)))), 0),
	@TotalExpense = ISNULL(SUM(SOD.PRate * SOD.Quantity), 0)
	FROM SOrderDetails SOD
	INNER JOIN SOrders SO
		ON SOD.SOrderID = SO.SOrderID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.SDetailID
	WHERE SO.STATUS = 1 AND SO.IsReplacement=0 AND (SO.InvoiceDate >= @Fromdate AND SO.InvoiceDate <= @ToDate) AND SO.ConcernID = @ConcernID

	SELECT @TotalSalesReturn = ISNULL(SUM(SOD.Quantity * SOD.UnitPrice), 0), @TotalPOReturn = ISNULL(SUM(STD.PRate * SOD.Quantity), 0)
	FROM ROrderDetails SOD
	INNER JOIN ROrders SO
		ON SOD.ROrderID = SO.ROrderID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailID
	WHERE (SO.ReturnDate >= @Fromdate AND SO.ReturnDate <= @ToDate) AND SO.ConcernID = @ConcernID

	--Print(Convert(varchar(123),@TotalIncome))
	--Print(Convert(varchar(123),@TotalExpense))
	SELECT @TotalIncome = @TotalIncome + ISNULL(SUM(CSP.Quantity * (CSP.UnitPrice - (CS.Discount * CSP.UnitPrice / CS.TSalesAmt))), 0),
	--+ISNULL(SUM((((((CS.InterestAmount) / (CS.TSalesAmt - CS.InterestAmount)) * (CSP.UnitPrice))) * CSP.Quantity) - (((((CS.Discount) / (CS.TSalesAmt - CS.InterestAmount)) * (CSP.UnitPrice))) * CSP.Quantity)),0), 
	@TotalExpense = @TotalExpense + ISNULL(SUM(STD.PRate * CSP.Quantity), 0)
	FROM CreditSaleDetails CSP
	INNER JOIN CreditSales CS
		ON CS.CreditSalesID = CSP.CreditSalesID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = CSP.StockDetailID
	WHERE CS.IsStatus = 1 AND CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CS.ConcernID = @ConcernID
	--Print(Convert(varchar(123),@TotalIncome))
	SELECT @TotalIncome = @TotalIncome + ISNULL(SUM(HireValue), 0)
	FROM CreditSales CS
	INNER JOIN CreditSaleDetails CSP
		ON CSP.CreditSalesID = CS.CreditSalesID
	INNER JOIN CreditSalesSchedules CSD
		ON CSD.CreditSalesID = CS.CreditSalesID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = CSP.StockDetailID
	WHERE Cs.IsStatus = 1 AND CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Purchase', ISNULL(@TotalExpense, 0), '', 0.00, 1)

	IF(@TotalPOReturn>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Purchase Return', ISNULL(@TotalPOReturn, 0), '', 0.00, 2)

	IF(ISNULL(@TotalExpense - @TotalPOReturn, 0)!=0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Net Purchase', ISNULL(@TotalExpense - @TotalPOReturn, 0), '', 0.00, 3)

	IF(@TotalIncome!=0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Sales', @TotalIncome, 4)

	IF(@TotalSalesReturn>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Sales Return', @TotalSalesReturn, 5)

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Net Sales', (@TotalIncome - @TotalSalesReturn), 6)

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Gross Profit', ISNULL((@TotalIncome - @TotalSalesReturn) - (@TotalExpense - @TotalPOReturn), 0), 7)

	--Last Pay adjustment
	SELECT @LastPayAdjust = ISNULL(SUM(CSD.LastPayAdjust), 0)
	FROM CreditSales CS
	INNER JOIN CreditSalesSchedules CSD
		ON CSD.CreditSalesID = CS.CreditSalesID
	WHERE Cs.IsStatus = 1 AND CSD.PaymentDate >= @Fromdate AND CSD.PaymentDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID

	SELECT @LastPayAdjust = @LastPayAdjust + ISNULL(SUM(CS.AdjustAmt), 0)
	FROM CashCollections CS
	WHERE Cs.TransactionType = 1 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@LastPayAdjust>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Bad Debt.', ISNULL(@LastPayAdjust, 0), '', 0.00, 8)


	-- Customer Debit Adjustment
	SELECT @DebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 7 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@DebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Customer Adjustment', ISNULL(@DebitAdjusment, 0), '', 0.00, 13)

		
	-- Customer Rate Adjustment(Customer)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 9 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Rate Adjustment(Customer)', ISNULL(@CreditAdjusment, 0), 15)

	-- Customer Price Protection(Customer)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 14 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Price Protection(Customer)', ISNULL(@CreditAdjusment, 0), 15)

	-- Customer Promo Offer(Customer)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 15 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Promo Offer(Customer)', ISNULL(@CreditAdjusment, 0), 15)

	-- Customer KPI(Customer)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 16 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'KPI(Customer)', ISNULL(@CreditAdjusment, 0), 15)

		-- Customer Incentive(Customer)
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 17 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Incentive(Customer)', ISNULL(@CreditAdjusment, 0), 15)

	-- Customer Credit Adjustment
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 6 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Customer Adjustment', ISNULL(@CreditAdjusment, 0), 15)	

	--Supplier Debit Adjustment
	SELECT @SupplierDebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 6 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0
	
	IF(@SupplierDebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Supplier Debit Adjustment', ISNULL(@SupplierDebitAdjusment, 0), '', 0.00, 14)

		
	--Supplier Credit Adjustment
	SELECT @SupplierCreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 7 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0
	
	IF(@SupplierCreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.00, 'Supplier Credit Adjustment', ISNULL(@SupplierCreditAdjusment, 0), 16)

	---------------------Income----------------------
	set @TotalIncome = ISNULL((	SELECT SUM(ex.Amount)
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 2 and ex.CashInHandReportStatus = 0),0)

	IF(@TotalIncome>0)
	BEGIN
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	SELECT '', 0.00, exi.Description, ex.Amount, 9
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 2 and ex.CashInHandReportStatus = 0

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES('',0.00,'Total Income',@TotalIncome,10)
	END

	-----------------------expense----------------------
	set @TotalExpense = ISNULL((SELECT SUM( ex.Amount)
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 1 AND exi.Description != 'Send cash to head of accounts' and ex.CashInHandReportStatus = 0
    ),0)

	IF(@TotalExpense>0)
	BEGIN
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	SELECT exi.Description, ex.Amount, '', 0.00, 11
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 1 AND exi.Description != 'Send cash to head of accounts' and ex.CashInHandReportStatus = 0

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES('Total Expense',@TotalExpense,'',0.00,12)
	END

	SELECT SerialNum, DebitParticulars, sum(Debit) 'Debit', CreditParticulars, sum(Credit) 'Credit'
	FROM #temp
	GROUP BY DebitParticulars, CreditParticulars, SerialNum
	ORDER BY SerialNum ASC
		--Print(Convert(varchar(123),@TotalIncome))



END

----------COMMONSOURCE---------
-------------Rizve--------------
----------30-11-2024------------
ALTER FUNCTION [dbo].[CheckProductStatusByPOId]
(
  @PurchaseOrderId int
)  
  RETURNS int
AS 
 BEGIN
	DECLARE	@Sold int
    
    SELECT @Sold = COUNT(*)
	FROM StockDetails
	JOIN POrderDetails POD ON POD.POrderDetailID = StockDetails.POrderDetailID 
	join POrders PO on POD.POrderID = PO.POrderID
	join Products p on POD.ProductID = p.ProductID
	WHERE p.ProductType <> 2 AND POD.POrderID = @PurchaseOrderId AND StockDetails.Status = 2
	
	--IF @Sold IS NULL
	--  SET @Sold=0

	IF @Sold IS NULL OR @Sold = 0
		begin
			SET @Sold=0

			set @Sold =  (select ISNULL(COUNT(*), 0) FROM StockDetails sd
			JOIN POrderDetails POD ON POD.POrderDetailID = sd.POrderDetailID 
			join POrders PO on POD.POrderID = PO.POrderID
			join Products p on POD.ProductID = p.ProductID
			WHERE p.ProductType = 2 and POD.POrderID = @PurchaseOrderId and POD.Quantity != sd.Quantity)


		end
	  
	RETURN@Sold
END



=============================================================================================================





ALTER PROCEDURE [dbo].[AddSalesOrder] (
	@SalesOrder [INSERTSALESORDERTABLE] readonly,
	@SODetails [INSERTSODETAILTABLE] readonly,
	@RemindDate DATE,
	@BankTrans [InsertBankTransTable] readonly,
	@SorderID int out,
	@Result int Out
	)
AS
DECLARE @SalesOrderId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY
	BEGIN TRANSACTION

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @SalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	INSERT INTO sorders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID,
		TSQty,
		PrevDue,
		1 FROM @SalesOrder
		)

	SET @SalesOrderId = Scope_identity()

	INSERT INTO SOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		Warranty
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.TAmount,
		SOD.PPDisPer,
		SOD.PPDisAmt,
		SOD.MrpRate,
		@SalesOrderId SOrderID,
		SOD.StockDetailId,
		SOD.PPOffer,
		(SOD.UnitPrice - SOD.PPDisAmt),
		STD.PRate,
		p.CompressorWarrentyMonth,
		p.PanelWarrentyMonth,
		p.MotorWarrentyMonth,
		p.SparePartsWarrentyMonth,
		p.ServiceWarrentyMonth,
		SOD.Warranty FROM @SODetails SOD INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailId INNER JOIN Products p
		ON STD.ProductID = p.ProductID WHERE P.ProductType = 1 OR p.ProductType = 3
		)

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue),
		reminddate = @RemindDate
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NOT NULL

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue)
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NULL

	--Stock Update 
	CREATE TABLE #tmpStock (
		ProductID INT,
		ColorID INT,
		GodownID INT,
		Qty DECIMAL(18, 2)
		)

	INSERT INTO #tmpStock (
		ProductID,
		ColorID,
		GodownID,
		Qty
		) (
		SELECT s.ProductID,
		s.ColorID,
		s.Compressor,
		SUM(s.Quantity) FROM @SODetails s 
		GROUP BY s.ProductId,
		s.ColorId,
		s.Compressor
		)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st
		ON st.ProductID = sod.ProductID AND st.ColorID = sod.ColorID AND st.GodownID = sod.GodownID

	--For barCode Product 
	UPDATE stockdetails
	SET stockdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN stockdetails
		ON stockdetails.sdetailid = s.stockdetailid
	INNER JOIN products
		ON stockdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	--*****************FIFO for Nobarcode************************** 
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @GodownID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity INT
	DECLARE @SQty INT
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.productid,
		colorid,
		s.Compressor,
		quantity,
		sorderdetailid
	FROM @SODetails s
	INNER JOIN products
		ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity != 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)

			IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity

				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					SOD.Warranty FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.Compressor=@GodownID AND SOD.colorid = @ColorID
					)

				SET @Quantity = 0
			END
			ELSE IF (@SQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @SQty

				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@SQty,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @SQty),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					SOD.Warranty FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					SOD.Warranty FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

	--For barCode Product SRVisit Status update 
	UPDATE srvproductdetails
	SET srvproductdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN srvproductdetails
		ON srvproductdetails.sdetailid = s.stockdetailid AND srvproductdetails.STATUS = 1
	INNER JOIN products
		ON srvproductdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3


	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID,
		TSQty,
		PrevDue,
		1,
		@SalesOrderId FROM @SalesOrder
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT CreatedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT CreateDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	SELECT @SorderID=@SalesOrderId,@Result=1;
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	SELECT @SorderID=0,@Result=0
END CATCH
GO




-----------COMMONSOURCE---------
-------------Nahid--------------
----------28-11-2024------------

CREATE NONCLUSTERED INDEX [IX_StockDetails_ProductIDColorID] ON [dbo].[StockDetails]
(
	[ProductID] ASC,
	[ColorID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
GO



-------------Common-------------
-------------Rizve-------------
-----------26-11-2024----------


ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = s.TSQty,
		ActionStatus = ActionStatus + 1
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)

	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId

	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = st.Quantity,ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	
-- For No barcode Stock Details out and SOrderDetails Insert
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @GodownID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @SOrderDetailID INT
DECLARE @Quantity decimal(18,2)
DECLARE @StockQty decimal(18,2)
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL FOR
SELECT s.ProductId,
       s.colorid,
       s.Compressor,
       s.quantity,
       sorderdetailid
FROM @SODetails s
JOIN products ON products.productid = s.productid
WHERE products.ProductType = 2 AND s.Status = 3

OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID,
     @ColorID,
     @GodownID,
     @Quantity,
     @SOrderDetailID

WHILE @@FETCH_STATUS = 0
BEGIN
    WHILE (@Quantity != 0)
    BEGIN
        -- Get the first available stock detail
        SET @SDetailID = (
            SELECT MIN(SDetailID)
            FROM stockdetails
            WHERE productid = @ProductID AND colorid = @ColorID
            AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
        )

        -- Get the stock quantity
        SET @StockQty = (
            SELECT quantity
            FROM stockdetails
            WHERE sdetailid = @SDetailID
        )

        IF (@StockQty > @Quantity)
        BEGIN
            -- If stock quantity is greater than the order quantity
            SET @StockQty = @StockQty - @Quantity

            -- Update stock details
            UPDATE stockdetails
            SET quantity = @StockQty
            WHERE sdetailid = @SDetailID

            -- Insert into order details
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
        ELSE IF (@StockQty < @Quantity)
        BEGIN
            -- If stock quantity is less than order quantity
            SET @Quantity = @Quantity - @StockQty

            -- Update stock to 0 and change status to 2 (unavailable)
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

            -- Insert into order details for partial quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @StockQty,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3
        END
        ELSE
        BEGIN
            -- If stock quantity equals the order quantity, mark as processed
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

            -- Insert the order detail for the exact quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                (SOD.UnitPrice - SOD.PPDisAmt) * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth
            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
    END

    FETCH NEXT
    FROM cur
    INTO @ProductID,
         @ColorID,
         @GodownID,
         @Quantity,
         @SOrderDetailID
END

CLOSE cur
DEALLOCATE cur





	--***************************************
	--*********SR visit Update***************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0
	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT so.InvoiceDate,
		so.invoiceno,
		so.customerid,
		so.vatpercentage,
		so.vatamount,
		so.grandtotal,
		so.TDPercentage,
		so.TDAmount,
		so.netdiscount,
		so.totalamount,
		so.paymentdue,
		so.RecAmount,
		so.adjamount,
		so.totaldue,
		so.STATUS,
		so.concernid,
		so.createdby,
		so.createdate,
		so.totaloffer,
		so.Remarks,
		so.TramsAndCondition,
		so.CardTypeSetupID,
		so.CardPaidAmount,
		so.DepositChargePercent,
		so.BankTransID,
		so.TSQty,
		so.PrevDue,
		so.ActionStatus,
		so.SOrderID
		FROM SOrders so
		INNER JOIN SOrders s on so.SOrderID = s.SOrderID AND s.SOrderID =  @SalesOrderId
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH
GO




----------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------

ALTER PROCEDURE [dbo].[AddSalesOrder] (
	@SalesOrder [INSERTSALESORDERTABLE] readonly,
	@SODetails [INSERTSODETAILTABLE] readonly,
	@RemindDate DATE,
	@BankTrans [InsertBankTransTable] readonly,
	@SorderID int out,
	@Result int Out
	)
AS
DECLARE @SalesOrderId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY
	BEGIN TRANSACTION

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @SalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	INSERT INTO sorders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID,
		TSQty,
		PrevDue,
		1 FROM @SalesOrder
		)

	SET @SalesOrderId = Scope_identity()

	INSERT INTO SOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		Warranty
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.TAmount,
		SOD.PPDisPer,
		SOD.PPDisAmt,
		SOD.MrpRate,
		@SalesOrderId SOrderID,
		SOD.StockDetailId,
		SOD.PPOffer,
		(SOD.UnitPrice - SOD.PPDisAmt),
		STD.PRate,
		p.CompressorWarrentyMonth,
		p.PanelWarrentyMonth,
		p.MotorWarrentyMonth,
		p.SparePartsWarrentyMonth,
		p.ServiceWarrentyMonth,
		SOD.Warranty FROM @SODetails SOD INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailId INNER JOIN Products p
		ON STD.ProductID = p.ProductID WHERE P.ProductType = 1 OR p.ProductType = 3
		)

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue),
		reminddate = @RemindDate
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NOT NULL

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue)
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NULL

	--Stock Update 
	CREATE TABLE #tmpStock (
		ProductID INT,
		ColorID INT,
		GodownID INT,
		Qty DECIMAL(18, 2)
		)

	INSERT INTO #tmpStock (
		ProductID,
		ColorID,
		GodownID,
		Qty
		) (
		SELECT s.ProductID,
		s.ColorID,
		s.Compressor,
		SUM(s.Quantity) FROM @SODetails s 
		GROUP BY s.ProductId,
		s.ColorId,
		s.Compressor
		)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st
		ON st.ProductID = sod.ProductID AND st.ColorID = sod.ColorID AND st.GodownID = sod.GodownID

	--For barCode Product 
	UPDATE stockdetails
	SET stockdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN stockdetails
		ON stockdetails.sdetailid = s.stockdetailid
	INNER JOIN products
		ON stockdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	--*****************FIFO for Nobarcode************************** 
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @GodownID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity INT
	DECLARE @SQty INT
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.productid,
		colorid,
		s.Compressor,
		quantity,
		sorderdetailid
	FROM @SODetails s
	INNER JOIN products
		ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity != 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)

			IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity

				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					SOD.Warranty FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.Compressor=@GodownID AND SOD.colorid = @ColorID
					)

				SET @Quantity = 0
			END
			ELSE IF (@SQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @SQty

				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@SQty,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					SOD.Warranty FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					SOD.Warranty FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

	--For barCode Product SRVisit Status update 
	UPDATE srvproductdetails
	SET srvproductdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN srvproductdetails
		ON srvproductdetails.sdetailid = s.stockdetailid AND srvproductdetails.STATUS = 1
	INNER JOIN products
		ON srvproductdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3


	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID,
		TSQty,
		PrevDue,
		1,
		@SalesOrderId FROM @SalesOrder
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT CreatedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT CreateDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	SELECT @SorderID=@SalesOrderId,@Result=1;
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	SELECT @SorderID=0,@Result=0
END CATCH
GO









-----------COMMONSOURCE---------
-------------Nahid--------------
----------26-11-2024------------


ALTER FUNCTION [dbo].[CheckProductStatusByPOId]
(
  @PurchaseOrderId int
)  
  RETURNS int
AS 
 BEGIN
	DECLARE	@Sold int
    
    SELECT @Sold = COUNT(*)
	FROM StockDetails
	JOIN POrderDetails POD ON POD.POrderDetailID = StockDetails.POrderDetailID 
	join POrders PO on POD.POrderID = PO.POrderID
	join Products p on POD.ProductID = p.ProductID
	WHERE p.ProductType <> 2 AND POD.POrderID = @PurchaseOrderId AND StockDetails.Status = 2
	
	--IF @Sold IS NULL
	--  SET @Sold=0

	IF @Sold IS NULL OR @Sold = 0
		begin
			SET @Sold=0

			set @Sold =  (select ISNULL(COUNT(*), 0) FROM StockDetails sd
			JOIN POrderDetails POD ON POD.POrderDetailID = sd.POrderDetailID 
			join POrders PO on POD.POrderID = PO.POrderID
			join Products p on POD.ProductID = p.ProductID
			WHERE p.ProductType = 2 and POD.POrderID = @PurchaseOrderId)


		end
	  
	RETURN  @Sold
  END
GO




-----------COMMONSOURCE---------
-------------Nahid--------------
----------21-11-2024------------


ALTER PROC [dbo].[GetDatewiseCustomerDueRpt]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CashCollectionReturnBank, 0)
				--+ ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturn, 0) 
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturnBank,0)
					--+ ISNULL(piv.CashCollectionReturn, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.[CashCollectionReturn], 0) AS DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(((ISNULL(piv.CashCollectionAdjustType + piv.CashCollectionAdjustTypeAdjustment, 0))) AS DECIMAL(18,2)) 'CashCollectionsTypeAdjustment',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CashCollectionReturnBank, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) +
					ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.CrAdjustment, 0)) +
					ISNULL(piv.[Return], 0) + ISNULL(piv.CashCollectionAdjustType, 0) + ISNULL(piv.CashCollectionAdjustTypeAdjustment, 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	--JOIN Customers c ON cc.CustomerID = c.CustomerID
	--WHERE cc.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID 
	--AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND cc.TransactionType IN(1)
	----AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (
	--	(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
	--	OR
	--	(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	--)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionAdjustType' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType IN (9,14,15,16,17) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'CashCollectionAdjustTypeAdjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN (1,9,14,15,16,17)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount,CashCollectionReturnBank,CashCollectionAdjustType,
			CashCollectionAdjustTypeAdjustment

		)
	) piv
 END


----------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[GetDatewiseCustomerDueRptRetail]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturn, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CrAdjustment, 0)
					 --+ ISNULL(piv.CashCollectionReturn, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.[CashCollectionReturn], 0) AS DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(((ISNULL(piv.CashCollectionAdjustType + piv.CashCollectionAdjustTypeAdjustment, 0))) AS DECIMAL(18,2)) 'CashCollectionsTypeAdjustment',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(			(
				
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) +
					ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.CrAdjustment, 0)) +
					ISNULL(piv.[Return], 0) + ISNULL(piv.CashCollectionAdjustType, 0) + ISNULL(piv.CashCollectionAdjustTypeAdjustment, 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 1
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 1
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	--JOIN Customers c ON cc.CustomerID = c.CustomerID
	--WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	--AND c.ConcernID = @ConcernID 
	--AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND cc.TransactionType IN(1)
	----AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (
	--	(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
	--	OR
	--	(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	--)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionAdjustType' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType IN (9,14,15,16,17) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'CashCollectionAdjustTypeAdjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN (1,9,14,15,16,17)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return],CashCollectionReturnBank, CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount,CashCollectionAdjustType,
			CashCollectionAdjustTypeAdjustment


		)
	) piv
 END

----------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[GetDatewiseCustomerDueRptHire]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturn, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CrAdjustment, 0)
					--+ ISNULL(piv.CashCollectionReturn, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.[CashCollectionReturn], 0) AS DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(((ISNULL(piv.CashCollectionAdjustType + piv.CashCollectionAdjustTypeAdjustment, 0))) AS DECIMAL(18,2)) 'CashCollectionsTypeAdjustment',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) +
					ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.CrAdjustment, 0)) +
					ISNULL(piv.[Return], 0) + ISNULL(piv.CashCollectionAdjustType, 0) + ISNULL(piv.CashCollectionAdjustTypeAdjustment, 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 3
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 3
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	--JOIN Customers c ON cc.CustomerID = c.CustomerID
	--WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	--AND c.ConcernID = @ConcernID 
	--AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND cc.TransactionType IN(1)
	----AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (
	--	(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
	--	OR
	--	(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	--)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionAdjustType' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType IN (9,14,15,16,17) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'CashCollectionAdjustTypeAdjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN (1,9,14,15,16,17)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionReturnBank,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount,CashCollectionAdjustType,
			CashCollectionAdjustTypeAdjustment


		)
	) piv
 END

----------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[GetDatewiseCustomerDueRptDealer]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)  + ISNULL(piv.CashCollectionReturn, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0)+ ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CrAdjustment, 0)
					 --+ ISNULL(piv.CashCollectionReturn, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.[CashCollectionReturn], 0) AS DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(((ISNULL(piv.CashCollectionAdjustType + piv.CashCollectionAdjustTypeAdjustment, 0))) AS DECIMAL(18,2)) 'CashCollectionsTypeAdjustment',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) +
					ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.CrAdjustment, 0)) +
					ISNULL(piv.[Return], 0) + ISNULL(piv.CashCollectionAdjustType, 0) + ISNULL(piv.CashCollectionAdjustTypeAdjustment, 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 2
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 2
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	--JOIN Customers c ON cc.CustomerID = c.CustomerID
	--WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	--AND c.ConcernID = @ConcernID 
	--AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND cc.TransactionType IN(1)
	----AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (
	--	(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
	--	OR
	--	(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	--)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionAdjustType' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType IN (9,14,15,16,17) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'CashCollectionAdjustTypeAdjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN (1,9,14,15,16,17)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID



	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn, CashCollectionReturnBank,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount,CashCollectionAdjustType,
			CashCollectionAdjustTypeAdjustment

		)
	) piv
 END

----------------------------------------------------------------------------------------------------------------------------

ALTER PROC [dbo].[GetDatewiseCustomerDueRptBranch]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturn, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CrAdjustment, 0)
					--+ ISNULL(piv.CashCollectionReturn, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.[CashCollectionReturn], 0) AS DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(((ISNULL(piv.CashCollectionAdjustType + piv.CashCollectionAdjustTypeAdjustment, 0))) AS DECIMAL(18,2)) 'CashCollectionsTypeAdjustment',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) +
					ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.CrAdjustment, 0)) +
					ISNULL(piv.[Return], 0) + ISNULL(piv.CashCollectionAdjustType, 0) + ISNULL(piv.CashCollectionAdjustTypeAdjustment, 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 4
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 4
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	--JOIN Customers c ON cc.CustomerID = c.CustomerID
	--WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	--AND c.ConcernID = @ConcernID 
	--AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND cc.TransactionType IN(1)
	----AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (
	--	(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
	--	OR
	--	(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	--)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionAdjustType' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType IN (9,14,15,16,17) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'CashCollectionAdjustTypeAdjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN (1,9,14,15,16,17)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount,CashCollectionAdjustType,
			CashCollectionAdjustTypeAdjustment

		)
	) piv
 END

-----------COMMONSOURCE---------
-------------Nahid--------------
----------19-11-2024------------


ALTER PROC [dbo].[GetCategorywiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT
		,@isOnlyDue BIT
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.HireReturn, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)+ ISNULL(piv.HireReturn, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue',
		ISNULL(piv.InterestAmount, 0) as TInterestAmount,
		ISNULL(piv.CrInterestAmount, 0) as CrInterestAmount



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL



	--start here 



	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	--UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0)) 
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType IN(1,9,14,15,16,17) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0)) 
	AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1,9,14,15,16,17)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'HireReturn', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	 AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return],CashCollectionReturnBank, CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount, HireReturn

		)
	) piv
 END


 --EXEC GetCategorywiseCustomerDue 5213, 0, 1

----------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[GetDatewiseCustomerDueRpt]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CashCollectionReturnBank, 0)
				--+ ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturn, 0) 
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturnBank,0)
					--+ ISNULL(piv.CashCollectionReturn, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.[CashCollectionReturn], 0) AS DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CashCollectionReturnBank, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount,CashCollectionReturnBank

		)
	) piv
 END

----------------------------------------------------------------------------------------------------------------------------

ALTER PROC [dbo].[GetDatewiseCustomerDueRptBranch]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturn, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
					--+ ISNULL(piv.CashCollectionReturn, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.[CashCollectionReturn], 0) AS DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 4
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 4
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END

----------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[GetDatewiseCustomerDueRptDealer]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)  + ISNULL(piv.CashCollectionReturn, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0)+ ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
					 --+ ISNULL(piv.CashCollectionReturn, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.[CashCollectionReturn], 0) AS DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 2
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 2
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID



	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn, CashCollectionReturnBank,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END

----------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[GetDatewiseCustomerDueRptHire]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturn, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
					--+ ISNULL(piv.CashCollectionReturn, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.[CashCollectionReturn], 0) AS DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 3
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 3
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionReturnBank,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
----------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[GetDatewiseCustomerDueRptRetail]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturn, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
					 --+ ISNULL(piv.CashCollectionReturn, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.[CashCollectionReturn], 0) AS DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(			(
				
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 1
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 1
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return],CashCollectionReturnBank, CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
----------------------------------------------------------------------------------------------------------------------------

-----------COMMONSOURCE---------
-------------Nahid--------------
----------18-11-2024------------


ALTER PROCEDURE [dbo].[AddCreditSalesOrder] (
@CSalesOrder [dbo].[INSERTCREDITSALESORDERTABLE] readonly, 
@CSODetails [INSERTCSODETAILTABLE] readonly,
@CSSchedules [INSERTCSSCHEDULESTABLE] readonly,
@BankTrans [InsertBankTransTable] readonly,
@SorderID int out,
@Result int Out)
AS
DECLARE @CreditSalesId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY  
 BEGIN TRANSACTION 

-----------------Card Payment Bank Deposit--------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @CSalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

------------------Card Payment Bank Deposit--------------

INSERT INTO creditsales (invoiceno, customerid, tsalesamt, noofinstallment,
 intallmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamt, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress)
(SELECT
 invoiceno, customerid, tsalesamt, noofinstallment, 
 installmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamount, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,@BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress FROM @CSalesOrder)

UPDATE customers
SET customers.CreditDue = (customers.CreditDue + s.totaldue)
FROM @CSalesOrder s
INNER JOIN customers ON customers.customerid = s.customerid

SET @CreditSalesId = Scope_identity()

INSERT INTO CreditSaleDetails 
( 
ProductID ,UnitPrice, Quantity, UTAmount, CreditSalesID,  
MPRateTotal, MPRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,Compressor,Motor,
Panel,Spareparts,Service, Warranty
) 
( 
Select sd.ProductID ,UnitPrice, Quantity, UTAmount, @CreditSalesId CreditSalesID,  
MPRateTotal, MrpRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,p.CompressorWarrentyMonth,p.MotorWarrentyMonth,
p.PanelWarrentyMonth,p.SparePartsWarrentyMonth,p.ServiceWarrentyMonth, sd.Warranty from @CSODetails sd
join Products p on sd.ProductID=p.ProductID 
where p.ProductType!=2
) 

INSERT INTO dbo.CreditInterestHistories(InterestDate, InterestAmount, HireSaleId, IsFirstTime)
(
	SELECT salesdate, interestamount, @CreditSalesId, 1 FROM @CSalesOrder
)


UPDATE stocks
SET stocks.quantity = (stocks.quantity - s.quantity)
FROM @CSODetails s
INNER JOIN stocks ON stocks.productid = s.productid AND stocks.colorid = s.colorid AND Stocks.GodownID=s.Compressor

UPDATE StockDetails 
SET StockDetails.Status = 2 
from @CSODetails s 
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId 
join Products on StockDetails.ProductID = Products.ProductID 
where Products.ProductType!=2 

--***************FIFO for Nobarcode Product**********************
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @CreditSaleProductsID INT
DECLARE @Quantity INT
DECLARE @SQty INT
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL
FOR
SELECT s.productid, s.colorid, s.quantity, creditsalesdetailsid
-- from   InsertCSODetailTable SOD join CreditSales SO on SO.CreditSalesID=SOD.CreditSalesID where SO.Status=1
FROM @CSODetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.stockdetailid
INNER JOIN products ON stockdetails.productid = products.productid
where Products.ProductType=2 
OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID

WHILE @@FETCH_STATUS = 0
BEGIN
	WHILE @Quantity != 0
	BEGIN
		SET @SDetailID = (
				SELECT Min(sdetailid)
				FROM stockdetails
				WHERE productid = @ProductID AND colorid = @ColorID AND quantity != 0 AND STATUS = 1
				)
		SET @SQty = (
				SELECT quantity
				FROM stockdetails
				WHERE sdetailid = @SDetailID
				)

		IF (@SQty > @Quantity)
		BEGIN
			SET @SQty = @SQty - @Quantity

			UPDATE stockdetails
			SET quantity = @SQty
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service, Warranty)
			 (SELECT sd.productid, unitprice, @Quantity,((unitprice * @Quantity) + inttotalamt), @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID  =@CreditSaleProductsID
			SET @Quantity = 0
		END
		ELSE IF (@SQty < @Quantity)
		BEGIN
			SET @Quantity = @Quantity - @SQty

			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service, Warranty)
			(SELECT sd.productid, unitprice, @SQty, ((unitprice * @SQty) + inttotalamt), @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)
				--update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
		END
		ELSE
		BEGIN
			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (
			productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate,
			 stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service,Warranty
			 ) 
			 (SELECT 
			  sd.productid, unitprice, @SQty, ((unitprice * @SQty) + inttotalamt), @CreditSalesId CreditSalesID, mpratetotal, mrprate,
			  @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, 
			  p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd 
			  INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID
			  )

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
			SET @Quantity = 0
		END
	END

	FETCH NEXT
	FROM cur
	INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID
END

INSERT INTO creditsalesschedules (monthdate, balance, installmentamt, 
paymentdate, creditsalesid, paymentstatus, interestamount, closingbalance,
 scheduleno, remarks, isunexpected, hirevalue, netvalue)
(SELECT monthdate, balance, installmentamt,
 paymentdate, @CreditSalesId CreditSalesID, paymentstatus, interestamount, closingbalance,
  scheduleno, remarks, isunexpected, hirevalue, netvalue FROM @CSSchedules)

COMMIT
--RETURN 1;
SELECT @SorderID=@CreditSalesId,@Result=1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		--RETURN 0;
	SELECT @SorderID=0,@Result=0
END CATCH

-------------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[GetCategorywiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT
		,@isOnlyDue BIT
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.HireReturn, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)+ ISNULL(piv.HireReturn, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue',
		ISNULL(piv.InterestAmount, 0) as TInterestAmount,
		ISNULL(piv.CrInterestAmount, 0) as CrInterestAmount



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL



	--start here 



	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	--UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0)) 
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0)) 
	AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'HireReturn', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	 AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return],CashCollectionReturnBank, CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount, HireReturn

		)
	) piv
 END


 --EXEC GetCategorywiseCustomerDue 5213, 0, 1


=====Rizve====
=====18/11/24==



ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = s.TSQty,
		ActionStatus = ActionStatus + 1
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)

	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId

	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	
-- For No barcode Stock Details out and SOrderDetails Insert
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @GodownID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @SOrderDetailID INT
DECLARE @Quantity decimal(18,2)
DECLARE @StockQty decimal(18,2)
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL FOR
SELECT s.ProductId,
       s.colorid,
       s.Compressor,
       s.quantity,
       sorderdetailid
FROM @SODetails s
JOIN products ON products.productid = s.productid
WHERE products.ProductType = 2 AND s.Status = 3

OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID,
     @ColorID,
     @GodownID,
     @Quantity,
     @SOrderDetailID

WHILE @@FETCH_STATUS = 0
BEGIN
    WHILE (@Quantity != 0)
    BEGIN
        -- Get the first available stock detail
        SET @SDetailID = (
            SELECT MIN(SDetailID)
            FROM stockdetails
            WHERE productid = @ProductID AND colorid = @ColorID
            AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
        )

        -- Get the stock quantity
        SET @StockQty = (
            SELECT quantity
            FROM stockdetails
            WHERE sdetailid = @SDetailID
        )

        IF (@StockQty > @Quantity)
        BEGIN
            -- If stock quantity is greater than the order quantity
            SET @StockQty = @StockQty - @Quantity

            -- Update stock details
            UPDATE stockdetails
            SET quantity = @StockQty
            WHERE sdetailid = @SDetailID

            -- Insert into order details
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                SOD.UnitPrice * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
        ELSE IF (@StockQty < @Quantity)
        BEGIN
            -- If stock quantity is less than order quantity
            SET @Quantity = @Quantity - @StockQty

            -- Update stock to 0 and change status to 2 (unavailable)
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

            -- Insert into order details for partial quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service
            )
            SELECT TOP 1
                SOD.productid,
                @StockQty,
                SOD.unitprice,
                SOD.UnitPrice * @StockQty,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3
        END
        ELSE
        BEGIN
            -- If stock quantity equals the order quantity, mark as processed
            UPDATE stockdetails
            SET quantity = 0,
                STATUS = 2
            WHERE sdetailid = @SDetailID

            -- Insert the order detail for the exact quantity
            INSERT INTO sorderdetails (
                productid,
                quantity,
                unitprice,
                utamount,
                ppdpercentage,
                ppdamount,
                mprate,
                sorderid,
                sdetailid,
                ppoffer,
                srate,
                prate,
                compressor,
                motor,
                panel,
                spareparts,
                service            )
            SELECT TOP 1
                SOD.productid,
                @Quantity,
                SOD.unitprice,
                SOD.UnitPrice * @Quantity,
                SOD.ppdisper,
                SOD.ppdisamt,
                SOD.mrprate,
                @SalesOrderId AS SOrderID,
                @SDetailID,
                SOD.ppoffer,
                (SOD.unitprice - SOD.ppdisamt),
                STD.prate,
                p.compressorwarrentymonth,
                p.panelwarrentymonth,
                p.motorwarrentymonth,
                p.sparepartswarrentymonth,
                p.servicewarrentymonth            FROM @SODetails SOD
            INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
            INNER JOIN products p ON STD.productid = p.productid
            WHERE SOD.productid = @ProductID
              AND SOD.colorid = @ColorID
              AND SOD.Compressor = @GodownID
              AND STD.SDetailID = @SDetailID
              AND SOD.Status = 3

            -- Set quantity to 0 as it's processed
            SET @Quantity = 0
        END
    END

    FETCH NEXT
    FROM cur
    INTO @ProductID,
         @ColorID,
         @GodownID,
         @Quantity,
         @SOrderDetailID
END

CLOSE cur
DEALLOCATE cur





	--***************************************
	--*********SR visit Update***************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0
	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT so.InvoiceDate,
		so.invoiceno,
		so.customerid,
		so.vatpercentage,
		so.vatamount,
		so.grandtotal,
		so.TDPercentage,
		so.TDAmount,
		so.netdiscount,
		so.totalamount,
		so.paymentdue,
		so.RecAmount,
		so.adjamount,
		so.totaldue,
		so.STATUS,
		so.concernid,
		so.createdby,
		so.createdate,
		so.totaloffer,
		so.Remarks,
		so.TramsAndCondition,
		so.CardTypeSetupID,
		so.CardPaidAmount,
		so.DepositChargePercent,
		so.BankTransID,
		so.TSQty,
		so.PrevDue,
		so.ActionStatus,
		so.SOrderID
		FROM SOrders so
		INNER JOIN SOrders s on so.SOrderID = s.SOrderID AND s.SOrderID =  @SalesOrderId
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH
GO





=====Rizve====
=====12/11/24==


ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = s.TSQty,
		ActionStatus = ActionStatus + 1
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)

	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId

	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	--For No barcode Stock Details out and SOrderDetails Insert
--For No barcode Stock Details out and SOrderDetails Insert
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @GodownID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity  decimal(18,2)
	DECLARE @StockQty decimal(18,2)
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.ProductId,
		colorid,
		Compressor,
		s.quantity,
		sorderdetailid
	FROM @SODetails s
    JOIN products ON products.productid = s.productid
	WHERE (products.ProductType = 2 and S.Status=3)

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE (@Quantity != 0)
		BEGIN
			SET @SDetailID = (
					SELECT Min(SDetailID)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID 
					AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @StockQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)
				------------------Debug-------------------------
				--INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
				--VALUES('ProductID: '+Convert(varchar(40),@ProductID)+'Stock Qty:'+Convert(varchar(40),@StockQty),'ColorID: '+Convert(varchar(40),@ColorID)+'GodownID: '+Convert(varchar(40),@GodownID),1,GETDATE())
				----------------------------
			IF (@StockQty > @Quantity)
			BEGIN
				SET @StockQty = @StockQty - @Quantity
			
				UPDATE stockdetails
				SET quantity = @StockQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					rotation
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.UnitPrice * @Quantity,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth
					FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID 
					AND SOD.Compressor = @GodownID AND SOD.Status=3
					--AND STD.SDetailID=@SDetailID 
					)

				SET @Quantity = 0
			END
			ELSE IF (@StockQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @StockQty
			
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@StockQty,
					SOD.unitprice,
					SOD.UnitPrice * @Quantity,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth
					FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID 
					AND SOD.Compressor = @GodownID  AND SOD.Status=3
					--AND STD.SDetailID=@SDetailID
					)
			END
			ELSE
BEGIN
    -- Update stock quantity and mark as unavailable
    UPDATE stockdetails
    SET quantity = 0,
        STATUS = 2
    WHERE sdetailid = @SDetailID;

    -- Only insert a single row for each unique SDetailID
    IF NOT EXISTS (
        SELECT 1
        FROM sorderdetails
        WHERE sorderid = @SalesOrderId
          AND sdetailid = @SDetailID
    )
    BEGIN
        INSERT INTO sorderdetails (
            productid,
            quantity,
            unitprice,
            utamount,
            ppdpercentage,
            ppdamount,
            mprate,
            sorderid,
            sdetailid,
            ppoffer,
            srate,
            prate,
            compressor,
            motor,
            panel,
            spareparts,
            service
        )
        SELECT TOP 1 -- Limit to a single insertion of the same SDetailID
            SOD.productid,
            @Quantity,
            SOD.unitprice,
            SOD.UnitPrice * @Quantity,
            SOD.ppdisper,
            SOD.ppdisamt,
            SOD.mrprate,
            @SalesOrderId AS SOrderID,
            @SDetailID,
            SOD.ppoffer,
            (SOD.unitprice - SOD.ppdisamt),
            STD.prate,
            p.compressorwarrentymonth,
            p.panelwarrentymonth,
            p.motorwarrentymonth,
            p.sparepartswarrentymonth,
            p.servicewarrentymonth
        FROM @SODetails SOD
        INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
        INNER JOIN products p ON STD.productid = p.productid
        WHERE SOD.productid = @ProductID 
          AND SOD.colorid = @ColorID 
          AND SOD.Compressor = @GodownID 
          AND STD.SDetailID = @SDetailID 
          AND SOD.Status = 3;
    END;

    -- Set quantity to zero to indicate its fully processed
    SET @Quantity = 0;
END;




		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

--New Products FIFO END




	--***************************************
	--*********SR visit Update***************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0
	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT so.InvoiceDate,
		so.invoiceno,
		so.customerid,
		so.vatpercentage,
		so.vatamount,
		so.grandtotal,
		so.TDPercentage,
		so.TDAmount,
		so.netdiscount,
		so.totalamount,
		so.paymentdue,
		so.RecAmount,
		so.adjamount,
		so.totaldue,
		so.STATUS,
		so.concernid,
		so.createdby,
		so.createdate,
		so.totaloffer,
		so.Remarks,
		so.TramsAndCondition,
		so.CardTypeSetupID,
		so.CardPaidAmount,
		so.DepositChargePercent,
		so.BankTransID,
		so.TSQty,
		so.PrevDue,
		so.ActionStatus,
		so.SOrderID
		FROM SOrders so
		INNER JOIN SOrders s on so.SOrderID = s.SOrderID AND s.SOrderID =  @SalesOrderId
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH
GO
-------------------------------------------------------------------------------------

ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = s.TSQty,
		ActionStatus = ActionStatus + 1
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)

	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId

	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	--For No barcode Stock Details out and SOrderDetails Insert
--For No barcode Stock Details out and SOrderDetails Insert
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @GodownID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity  decimal(18,2)
	DECLARE @StockQty decimal(18,2)
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.ProductId,
		colorid,
		Compressor,
		s.quantity,
		sorderdetailid
	FROM @SODetails s
    JOIN products ON products.productid = s.productid
	WHERE (products.ProductType = 2 and S.Status=3)

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE (@Quantity != 0)
		BEGIN
			SET @SDetailID = (
					SELECT Min(SDetailID)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID 
					AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @StockQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)
				------------------Debug-------------------------
				--INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
				--VALUES('ProductID: '+Convert(varchar(40),@ProductID)+'Stock Qty:'+Convert(varchar(40),@StockQty),'ColorID: '+Convert(varchar(40),@ColorID)+'GodownID: '+Convert(varchar(40),@GodownID),1,GETDATE())
				----------------------------
			IF (@StockQty > @Quantity)
			BEGIN
				SET @StockQty = @StockQty - @Quantity
			
				UPDATE stockdetails
				SET quantity = @StockQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth
					FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID 
					AND SOD.Compressor = @GodownID AND SOD.Status=3
					--AND STD.SDetailID=@SDetailID 
					)

				SET @Quantity = 0
			END
			ELSE IF (@StockQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @StockQty
			
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@StockQty,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth
					FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID 
					AND SOD.Compressor = @GodownID  AND SOD.Status=3
					--AND STD.SDetailID=@SDetailID
					)
			END
			ELSE
BEGIN
    -- Update stock quantity and mark as unavailable
    UPDATE stockdetails
    SET quantity = 0,
        STATUS = 2
    WHERE sdetailid = @SDetailID;

    -- Only insert a single row for each unique SDetailID
    IF NOT EXISTS (
        SELECT 1
        FROM sorderdetails
        WHERE sorderid = @SalesOrderId
          AND sdetailid = @SDetailID
    )
    BEGIN
        INSERT INTO sorderdetails (
            productid,
            quantity,
            unitprice,
            utamount,
            ppdpercentage,
            ppdamount,
            mprate,
            sorderid,
            sdetailid,
            ppoffer,
            srate,
            prate,
            compressor,
            motor,
            panel,
            spareparts,
            service
        )
        SELECT TOP 1 -- Limit to a single insertion of the same SDetailID
            SOD.productid,
            @Quantity,
            SOD.unitprice,
            SOD.UnitPrice * @Quantity,
            SOD.ppdisper,
            SOD.ppdisamt,
            SOD.mrprate,
            @SalesOrderId AS SOrderID,
            @SDetailID,
            SOD.ppoffer,
            (SOD.unitprice - SOD.ppdisamt),
            STD.prate,
            p.compressorwarrentymonth,
            p.panelwarrentymonth,
            p.motorwarrentymonth,
            p.sparepartswarrentymonth,
            p.servicewarrentymonth
        FROM @SODetails SOD
        INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
        INNER JOIN products p ON STD.productid = p.productid
        WHERE SOD.productid = @ProductID 
          AND SOD.colorid = @ColorID 
          AND SOD.Compressor = @GodownID 
          AND STD.SDetailID = @SDetailID 
          AND SOD.Status = 3;
    END;

    -- Set quantity to zero to indicate its fully processed
    SET @Quantity = 0;
END;




		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

--New Products FIFO END




	--***************************************
	--SR visit Update**************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0
	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT so.InvoiceDate,
		so.invoiceno,
		so.customerid,
		so.vatpercentage,
		so.vatamount,
		so.grandtotal,
		so.TDPercentage,
		so.TDAmount,
		so.netdiscount,
		so.totalamount,
		so.paymentdue,
		so.RecAmount,
		so.adjamount,
		so.totaldue,
		so.STATUS,
		so.concernid,
		so.createdby,
		so.createdate,
		so.totaloffer,
		so.Remarks,
		so.TramsAndCondition,
		so.CardTypeSetupID,
		so.CardPaidAmount,
		so.DepositChargePercent,
		so.BankTransID,
		so.TSQty,
		so.PrevDue,
		so.ActionStatus,
		so.SOrderID
		FROM SOrders so
		INNER JOIN SOrders s on so.SOrderID = s.SOrderID AND s.SOrderID =  @SalesOrderId
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH
GO






---------------------------------------------------------------------------------------
ALTER PROCEDURE [dbo].[sp_AddReturnOrder_New] 
(
    @SalesOrder [InsertDMSReturnOrderTable] readonly,
    @SODetails [InsertDMSReturnOrderDetailTable] readonly
)
AS
BEGIN
    DECLARE @SalesOrderId INT;

    BEGIN TRY
        BEGIN TRANSACTION;

        -- Insert into ROrders table
        INSERT INTO ROrders (InvoiceNo, ReturnDate, GrandTotal, CustomerID, PaidAmount, ConcernID,
                             CreatedBy, CreateDate, ModifiedBy, ModifiedDate)
        SELECT InvoiceNo, InvoiceDate, GrandTotal, CustomerID, RecAmt, ConcernID, 
               CreatedBy, CreateDate, CreatedBy, CreateDate
        FROM @SalesOrder;

        SET @SalesOrderId = SCOPE_IDENTITY();


        -- Insert into ROrderDetails
        INSERT INTO ROrderDetails (ROrderID, ProductID, Quantity, UnitPrice, UTAmount, StockDetailID, ColorID, CheckNo, SQty, Quant, SID)
        SELECT 
            @SalesOrderId, s.ProductId, 
            CASE 
                WHEN p.ProductType = 2 THEN s.Quantity
                ELSE 1
            END AS Quantity,s.UnitPrice, s.TAmount, s.StockDetailId, s.ColorID, 
            CASE 
                WHEN p.ProductType = 2 THEN 1
                ELSE 3
            END AS CheckNo,
            CASE 
                WHEN p.ProductType = 2 THEN  s.dSalesQuantity
                ELSE 1
            END AS SQty, s.Quantity AS Quant, s.dSOrderDetailsId
        FROM @SODetails s
        --INNER JOIN SOrderDetails sod ON s.StockDetailId = sod.SDetailID
        --INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
        INNER JOIN Products p ON s.ProductId = p.ProductID;

        --INSERT INTO ROrderDetails (ROrderID, ProductID, Quantity, UnitPrice, UTAmount, StockDetailID, ColorID, CheckNo, SQty, Quant, SID)
        --SELECT 
        --    @SalesOrderId, s.ProductId, s.Quantity, s.UnitPrice, s.TAmount, s.StockDetailId, s.ColorId, 0, @SQty, 0 , @SID
        --FROM @SODetails s



        -- Handle Product without Barcode (ProductType = 2)
        UPDATE sod
        SET 
            sod.IsProductReturn = CASE 
                                    WHEN sod.Quantity - s.Quantity > 0 THEN 0
                                    ELSE 1 
                                  END,
            sod.RQuantity = sod.RQuantity + s.Quantity
        FROM ROrderDetails s
        INNER JOIN SOrderDetails sod ON s.ProductId = sod.ProductID
        INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
        INNER JOIN Products p ON s.ProductId = p.ProductID
        WHERE p.ProductType = 2 AND sod.IsProductReturn != 1 AND s.ROrderID = @SalesOrderId AND s.SID = sod.SOrderDetailID;

        -- Handle Product with Barcode (ProductType <> 2)
        UPDATE sod
        SET 
            sod.IsProductReturn = 1,
            sod.RQuantity = sod.RQuantity + 1
        FROM ROrderDetails s
        INNER JOIN SOrderDetails sod ON s.StockDetailId = sod.SDetailID
        INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
        INNER JOIN Products p ON s.ProductId = p.ProductID
        WHERE p.ProductType <> 2 AND sod.IsProductReturn != 1 AND s.ROrderID = @SalesOrderId AND s.SID = sod.SOrderDetailID;
		

        -- Update StockDetails
  --      UPDATE StockDetails
  --      SET StockDetails.Quantity = std.Quantity + sd.Quantity, 
		--StockDetails.Status = 1
  --      FROM @SODetails sd
		--INNER JOIN SOrderDetails sod ON sd.dSOrderDetailsId = sod.SOrderDetailID
		--Inner Join StockDetails std On sod.SDetailID = std.SDetailID;

UPDATE st
SET st.Quantity = st.Quantity + s.TotalQuantity, st.Status = 1
FROM (
    SELECT std.SDetailID, SUM(s.Quantity) AS TotalQuantity
    FROM @SODetails s
    INNER JOIN SOrderDetails sod ON s.dSOrderDetailsId = sod.SOrderDetailID
    INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
    GROUP BY std.SDetailID
) s
INNER JOIN StockDetails st ON s.SDetailID = st.SDetailID;
		
        -- Update Stock quantities
  --      UPDATE st
  --      SET st.Quantity = st.Quantity + s.Quantity
  --      FROM @SODetails s
  --      INNER JOIN SOrderDetails sod ON s.dSOrderDetailsId = sod.SOrderDetailID
  --      INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
		--INNER JOIN Stocks st ON std.StockID = st.StockID;

UPDATE st
SET st.Quantity = st.Quantity + s.TotalQuantity
FROM (
    SELECT std.StockID, SUM(s.Quantity) AS TotalQuantity
    FROM @SODetails s
    INNER JOIN SOrderDetails sod ON s.dSOrderDetailsId = sod.SOrderDetailID
    INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
    GROUP BY std.StockID
) s
INNER JOIN Stocks st ON s.StockID = st.StockID;

		 --Update Stock quantities
   --     UPDATE Stocks
   --     SET Stocks.Quantity = Stocks.Quantity + sod.RQuantity
   --     FROM @SODetails s
   --     INNER JOIN SOrderDetails sod ON s.StockDetailId = sod.SDetailID
   --     INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID;



        -- SR Visit updates
        --DECLARE @EmployeeId INT;
        --SET @EmployeeId = (SELECT TOP(1) SRId FROM @SalesOrder);

        -- Update SRVisitDetails for No Barcode
        --UPDATE SRVisitDetails
        --SET SRVisitDetails.SoldQty = (SRVisitDetails.SoldQty - s.Quantity)
        --FROM @SODetails s
        --JOIN SRVisitDetails ON SRVisitDetails.ProductID = s.ProductId AND SRVisitDetails.ColorID = s.ColorId
        --JOIN SRVisits sv ON SRVisitDetails.SRVisitID = sv.SRVisitID
        --JOIN Products p ON s.ProductId = p.ProductID
        --WHERE sv.EmployeeID = @EmployeeId AND p.ProductType = 2;

        -- Update SRVisitDetails for Barcode
        --UPDATE SRVisitDetails
        --SET SRVisitDetails.Quantity = 1
        --FROM @SODetails s
        --JOIN SRVisitDetails ON SRVisitDetails.ProductID = s.ProductId AND SRVisitDetails.ColorID = s.ColorId
        --JOIN SRVisits sv ON SRVisitDetails.SRVisitID = sv.SRVisitID
        --JOIN Products p ON s.ProductId = p.ProductID
        --WHERE sv.EmployeeID = @EmployeeId AND p.ProductType <> 2;

        -- Update SRVProductDetails
        --UPDATE SRVProductDetails
        --SET SRVProductDetails.Status = 1
        --FROM @SODetails s
        --JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
        --WHERE SRVProductDetails.Status = 2;

        -- Update Customer's total due
        UPDATE Customers
        SET Customers.TotalDue = Customers.TotalDue - s.TotalDue
        FROM @SalesOrder s
        INNER JOIN Customers ON Customers.CustomerID = s.CustomerID;

        -- Update EmployeeWiseCustomerDues
        --UPDATE EmployeeWiseCustomerDues
        --SET CustomerDue = CustomerDue - s.TotalDue
        --FROM @SalesOrder s
        --INNER JOIN EmployeeWiseCustomerDues sr ON sr.CustomerID = s.CustomerID
        --WHERE EmployeeID = s.SRId;

        COMMIT;
        RETURN 1;
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK;
        RETURN 0;
    END CATCH;

    -- Nullify RQuantity values
    UPDATE SOrderDetails
    SET RQuantity = 0
    WHERE RQuantity IS NULL;
END;
---------------------

ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = s.TSQty,
		ActionStatus = ActionStatus + 1
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)

	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId

	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	--For No barcode Stock Details out and SOrderDetails Insert
--For No barcode Stock Details out and SOrderDetails Insert
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @GodownID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity  decimal(18,2)
	DECLARE @StockQty decimal(18,2)
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.ProductId,
		colorid,
		Compressor,
		s.quantity,
		sorderdetailid
	FROM @SODetails s
    JOIN products ON products.productid = s.productid
	WHERE (products.ProductType = 2 and S.Status=3)

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE (@Quantity != 0)
		BEGIN
			SET @SDetailID = (
					SELECT Min(SDetailID)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID 
					AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @StockQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)
				------------------Debug-------------------------
				--INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
				--VALUES('ProductID: '+Convert(varchar(40),@ProductID)+'Stock Qty:'+Convert(varchar(40),@StockQty),'ColorID: '+Convert(varchar(40),@ColorID)+'GodownID: '+Convert(varchar(40),@GodownID),1,GETDATE())
				----------------------------
			IF (@StockQty > @Quantity)
			BEGIN
				SET @StockQty = @StockQty - @Quantity
			
				UPDATE stockdetails
				SET quantity = @StockQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth
					
					FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID 
					AND SOD.Compressor = @GodownID AND SOD.Status=3
					--AND STD.SDetailID=@SDetailID 
					)

				SET @Quantity = 0
			END
			ELSE IF (@StockQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @StockQty
			
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@StockQty,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth
				
					FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID 
					AND SOD.Compressor = @GodownID  AND SOD.Status=3
					--AND STD.SDetailID=@SDetailID
					)
			END
			ELSE
BEGIN
    -- Update stock quantity and mark as unavailable
    UPDATE stockdetails
    SET quantity = 0,
        STATUS = 2
    WHERE sdetailid = @SDetailID;

    -- Only insert a single row for each unique SDetailID
    IF NOT EXISTS (
        SELECT 1
        FROM sorderdetails
        WHERE sorderid = @SalesOrderId
          AND sdetailid = @SDetailID
    )
    BEGIN
        INSERT INTO sorderdetails (
            productid,
            quantity,
            unitprice,
            utamount,
            ppdpercentage,
            ppdamount,
            mprate,
            sorderid,
            sdetailid,
            ppoffer,
            srate,
            prate,
            compressor,
            motor,
            panel,
            spareparts,
            service
        )
        SELECT TOP 1 -- Limit to a single insertion of the same SDetailID
            SOD.productid,
            @Quantity,
            SOD.unitprice,
            SOD.tamount,
            SOD.ppdisper,
            SOD.ppdisamt,
            SOD.mrprate,
            @SalesOrderId AS SOrderID,
            @SDetailID,
            SOD.ppoffer,
            (SOD.unitprice - SOD.ppdisamt),
            STD.prate,
            p.compressorwarrentymonth,
            p.panelwarrentymonth,
            p.motorwarrentymonth,
            p.sparepartswarrentymonth,
            p.servicewarrentymonth
           
        FROM @SODetails SOD
        INNER JOIN stockdetails STD ON STD.sdetailid = @SDetailID
        INNER JOIN products p ON STD.productid = p.productid
        WHERE SOD.productid = @ProductID 
          AND SOD.colorid = @ColorID 
          AND SOD.Compressor = @GodownID 
          AND STD.SDetailID = @SDetailID 
          AND SOD.Status = 3;
    END;

    -- Set quantity to zero to indicate its fully processed
    SET @Quantity = 0;
END;




		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

--New Products FIFO END




	--***************************************
	--SR visit Update**************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0
	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT so.InvoiceDate,
		so.invoiceno,
		so.customerid,
		so.vatpercentage,
		so.vatamount,
		so.grandtotal,
		so.TDPercentage,
		so.TDAmount,
		so.netdiscount,
		so.totalamount,
		so.paymentdue,
		so.RecAmount,
		so.adjamount,
		so.totaldue,
		so.STATUS,
		so.concernid,
		so.createdby,
		so.createdate,
		so.totaloffer,
		so.Remarks,
		so.TramsAndCondition,
		so.CardTypeSetupID,
		so.CardPaidAmount,
		so.DepositChargePercent,
		so.BankTransID,
		so.TSQty,
		so.PrevDue,
		so.ActionStatus,
		so.SOrderID
		FROM SOrders so
		INNER JOIN SOrders s on so.SOrderID = s.SOrderID AND s.SOrderID =  @SalesOrderId
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH
GO


-----------COMMONSOURCE---------
-------------Nahid--------------
----------09-11-2024------------


ALTER PROCEDURE [dbo].[sp_AddReturnOrder_New] 
(
    @SalesOrder [InsertDMSReturnOrderTable] readonly,
    @SODetails [InsertDMSReturnOrderDetailTable] readonly
)
AS
BEGIN
    DECLARE @SalesOrderId INT;

    BEGIN TRY
        BEGIN TRANSACTION;

        -- Insert into ROrders table
        INSERT INTO ROrders (InvoiceNo, ReturnDate, GrandTotal, CustomerID, PaidAmount, ConcernID,
                             CreatedBy, CreateDate, ModifiedBy, ModifiedDate)
        SELECT InvoiceNo, InvoiceDate, GrandTotal, CustomerID, RecAmt, ConcernID, 
               CreatedBy, CreateDate, CreatedBy, CreateDate
        FROM @SalesOrder;

        SET @SalesOrderId = SCOPE_IDENTITY();


        -- Insert into ROrderDetails
        INSERT INTO ROrderDetails (ROrderID, ProductID, Quantity, UnitPrice, UTAmount, StockDetailID, ColorID, CheckNo, SQty, Quant, SID)
        SELECT 
            @SalesOrderId, s.ProductId, 
            CASE 
                WHEN p.ProductType = 2 THEN s.Quantity
                ELSE 1
            END AS Quantity,s.UnitPrice, s.TAmount, s.StockDetailId, s.ColorID, 
            CASE 
                WHEN p.ProductType = 2 THEN 1
                ELSE 3
            END AS CheckNo,
            CASE 
                WHEN p.ProductType = 2 THEN  s.dSalesQuantity
                ELSE 1
            END AS SQty, s.Quantity AS Quant, s.dSOrderDetailsId
        FROM @SODetails s
        --INNER JOIN SOrderDetails sod ON s.StockDetailId = sod.SDetailID
        --INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
        INNER JOIN Products p ON s.ProductId = p.ProductID;

        --INSERT INTO ROrderDetails (ROrderID, ProductID, Quantity, UnitPrice, UTAmount, StockDetailID, ColorID, CheckNo, SQty, Quant, SID)
        --SELECT 
        --    @SalesOrderId, s.ProductId, s.Quantity, s.UnitPrice, s.TAmount, s.StockDetailId, s.ColorId, 0, @SQty, 0 , @SID
        --FROM @SODetails s



        -- Handle Product without Barcode (ProductType = 2)
        UPDATE sod
        SET 
            sod.IsProductReturn = CASE 
                                    WHEN sod.Quantity - s.Quantity > 0 THEN 0
                                    ELSE 1 
                                  END,
            sod.RQuantity = sod.RQuantity + s.Quantity
        FROM ROrderDetails s
        INNER JOIN SOrderDetails sod ON s.ProductId = sod.ProductID
        INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
        INNER JOIN Products p ON s.ProductId = p.ProductID
        WHERE p.ProductType = 2 AND sod.IsProductReturn != 1 AND s.ROrderID = @SalesOrderId AND s.SID = sod.SOrderDetailID;

        -- Handle Product with Barcode (ProductType <> 2)
        UPDATE sod
        SET 
            sod.IsProductReturn = 1,
            sod.RQuantity = sod.RQuantity + 1
        FROM ROrderDetails s
        INNER JOIN SOrderDetails sod ON s.StockDetailId = sod.SDetailID
        INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
        INNER JOIN Products p ON s.ProductId = p.ProductID
        WHERE p.ProductType <> 2 AND sod.IsProductReturn != 1 AND s.ROrderID = @SalesOrderId AND s.SID = sod.SOrderDetailID;
		

        -- Update StockDetails
  --      UPDATE StockDetails
  --      SET StockDetails.Quantity = std.Quantity + sd.Quantity, 
		--StockDetails.Status = 1
  --      FROM @SODetails sd
		--INNER JOIN SOrderDetails sod ON sd.dSOrderDetailsId = sod.SOrderDetailID
		--Inner Join StockDetails std On sod.SDetailID = std.SDetailID;

UPDATE st
SET st.Quantity = st.Quantity + s.TotalQuantity
FROM (
    SELECT std.SDetailID, SUM(s.Quantity) AS TotalQuantity
    FROM @SODetails s
    INNER JOIN SOrderDetails sod ON s.dSOrderDetailsId = sod.SOrderDetailID
    INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
    GROUP BY std.SDetailID
) s
INNER JOIN StockDetails st ON s.SDetailID=st.SDetailID;
		
        -- Update Stock quantities
  --      UPDATE st
  --      SET st.Quantity = st.Quantity + s.Quantity
  --      FROM @SODetails s
  --      INNER JOIN SOrderDetails sod ON s.dSOrderDetailsId = sod.SOrderDetailID
  --      INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
		--INNER JOIN Stocks st ON std.StockID = st.StockID;

UPDATE st
SET st.Quantity = st.Quantity + s.TotalQuantity
FROM (
    SELECT std.StockID, SUM(s.Quantity) AS TotalQuantity
    FROM @SODetails s
    INNER JOIN SOrderDetails sod ON s.dSOrderDetailsId = sod.SOrderDetailID
    INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
    GROUP BY std.StockID
) s
INNER JOIN Stocks st ON s.StockID=st.StockID;

		 --Update Stock quantities
   --     UPDATE Stocks
   --     SET Stocks.Quantity = Stocks.Quantity + sod.RQuantity
   --     FROM @SODetails s
   --     INNER JOIN SOrderDetails sod ON s.StockDetailId = sod.SDetailID
   --     INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID;



        -- SR Visit updates
        --DECLARE @EmployeeId INT;
        --SET @EmployeeId = (SELECT TOP(1) SRId FROM @SalesOrder);

        -- Update SRVisitDetails for No Barcode
        --UPDATE SRVisitDetails
        --SET SRVisitDetails.SoldQty = (SRVisitDetails.SoldQty - s.Quantity)
        --FROM @SODetails s
        --JOIN SRVisitDetails ON SRVisitDetails.ProductID = s.ProductId AND SRVisitDetails.ColorID = s.ColorId
        --JOIN SRVisits sv ON SRVisitDetails.SRVisitID = sv.SRVisitID
        --JOIN Products p ON s.ProductId = p.ProductID
        --WHERE sv.EmployeeID = @EmployeeId AND p.ProductType = 2;

        -- Update SRVisitDetails for Barcode
        --UPDATE SRVisitDetails
        --SET SRVisitDetails.Quantity = 1
        --FROM @SODetails s
        --JOIN SRVisitDetails ON SRVisitDetails.ProductID = s.ProductId AND SRVisitDetails.ColorID = s.ColorId
        --JOIN SRVisits sv ON SRVisitDetails.SRVisitID = sv.SRVisitID
        --JOIN Products p ON s.ProductId = p.ProductID
        --WHERE sv.EmployeeID = @EmployeeId AND p.ProductType <> 2;

        -- Update SRVProductDetails
        --UPDATE SRVProductDetails
        --SET SRVProductDetails.Status = 1
        --FROM @SODetails s
        --JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
        --WHERE SRVProductDetails.Status = 2;

        -- Update Customer's total due
        UPDATE Customers
        SET Customers.TotalDue = Customers.TotalDue - s.TotalDue
        FROM @SalesOrder s
        INNER JOIN Customers ON Customers.CustomerID = s.CustomerID;

        -- Update EmployeeWiseCustomerDues
        --UPDATE EmployeeWiseCustomerDues
        --SET CustomerDue = CustomerDue - s.TotalDue
        --FROM @SalesOrder s
        --INNER JOIN EmployeeWiseCustomerDues sr ON sr.CustomerID = s.CustomerID
        --WHERE EmployeeID = s.SRId;

        COMMIT;
        RETURN 1;
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK;
        RETURN 0;
    END CATCH;

    -- Nullify RQuantity values
    UPDATE SOrderDetails
    SET RQuantity = 0
    WHERE RQuantity IS NULL;
END;


-----------COMMONSOURCE---------
-------------Nahid--------------
----------05-11-2024------------


ALTER PROCEDURE [dbo].[UpdatePurchaseOrder] (
	@PurchaseOrderId INT,
	@PurchaseOrder [InsertPurchaseOrderTable] readonly,
	@PODetails [InsertPODetailTable] readonly,
	@POProductDetails [InsertPOProductDetailTable] readonly,
	@Stocks [InsertStockTable] readonly,
	@StockDetails [InsertStockDetailTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

Declare @TPQty decimal(18,2)
DECLARE @GrandTotal DECIMAL(18, 2)
		,@NetDiscount DECIMAL(18, 2)
		,@FlatDis DECIMAL(18, 2)
		,@Adjustment DECIMAL(18, 2)

	SET @GrandTotal = ISNULL((
				SELECT GrandTotal
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @NetDiscount = ISNULL((
				SELECT NetDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @FlatDis = ISNULL((
				SELECT TDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
    SET @Adjustment = ISNULL((
				SELECT AdjAmount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue - p.PaymentDue)
	FROM POrders p
	INNER JOIN Suppliers
		ON Suppliers.SupplierID = p.SupplierId
	WHERE p.POrderID = @PurchaseOrderId AND p.IsDamageOrder != 1

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue + p.PaymentDue)
	FROM @PurchaseOrder p
	INNER JOIN Suppliers
		ON Suppliers.SupplierID = p.SupplierId
	WHERE p.IsDamageOrder != 1

	UPDATE POrders
	SET OrderDate = p.OrderDate,
		ChallanNo = p.ChallanNo,
		SupplierID = p.SupplierID,
		GrandTotal = p.GrandTotal,
		TDiscount = p.TDiscount,
		TotalAmt = p.TotalAmt,
		AdjAmount = p.AdjAmount,
		RecAmt = p.RecAmt,
		PaymentDue = p.PaymentDue,
		TotalDue = p.TotalDue,
		STATUS = p.STATUS,
		PPDisAmt = p.PPTDisAmt,
		NetDiscount = p.NetDiscount,
		LaborCost = p.LabourCost,
		ConcernID = p.ConcernID,
		ModifiedDate = p.CreateDate,
		ModifiedBy = p.CreatedBy,
		IsDamageOrder = p.IsDamageOrder,
		Remarks = p.Remarks,
		InvoiceNo = p.InvoiceNo,
		EditReqStatus = 0,
		TPQty = p.TPQty,
		ActionStatus = ActionStatus + 1
	FROM @PurchaseOrder p
	WHERE POrderID = @PurchaseOrderId

	UPDATE POrderDetails
	SET POrderDetails.ProductID = PODT.ProductId,
		POrderDetails.ColorID = PODT.ColorId,
		POrderDetails.Quantity = PODT.Quantity,
		POrderDetails.UnitPrice = PODT.UnitPrice,
		POrderDetails.TAmount = PODT.TAmount,
		POrderDetails.PPDISPer = PODT.PPDisPer,
		POrderDetails.PPDISAmt = PODT.PPDisAmt,
		POrderDetails.MRPRate = PODT.MrpRate,
		POrderDetails.POrderID = @PurchaseOrderId,
		POrderDetails.SalesRate = PODT.SalesRate,
		POrderDetails.ExtraPPDISPer = PODT.ExtraPPDISPer,
		POrderDetails.ExtraPPDISAmt = PODT.ExtraPPDISAmt,
		PORderDetails.PPOFFER = PODT.PPOffer,
		POrderDetails.CreditSalesRate = PODT.CreditSalesRate,
		POrderDetails.CRSalesRate12Month = PODT.CRSalesRate12Month,
		POrderDetails.CRSalesRate3Month = PODT.CRSalesRate3Month,
		POrderDetails.GodownID = PODT.GodownID
	FROM @PODetails PODT
	INNER JOIN POrderDetails POD
		ON POD.POrderDetailId = PODT.POrderDetailId
	WHERE PODT.STATUS = 4

	INSERT INTO POrderDetails (
		ProductID,
		ColorID,
		Quantity,
		UnitPrice,
		TAmount,
		PPDISPer,
		PPDISAmt,
		MRPRate,
		POrderID,
		SalesRate,
		ExtraPPDISPer,
		ExtraPPDISAmt,
		PPOFFER,
		CreditSalesRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownID
		) (
		SELECT ProductId,
		ColorId,
		Quantity,
		UnitPrice,
		TAmount,
		PPDisPer,
		PPDisAmt,
		MrpRate,
		@PurchaseOrderId POrderID,
		SalesRate,
		ExtraPPDISPer,
		ExtraPPDISAmt,
		PPOffer,
		CreditSalesRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownId FROM @PODetails WHERE STATUS = 3
		)

	DELETE
	FROM POProductDetails
	WHERE POrderDetailID IN (
			SELECT POrderDetailId
			FROM @PODetails
			WHERE STATUS = 4 OR STATUS = 5
			)

	DELETE
	FROM POrderDetails
	WHERE POrderDetailID IN (
			SELECT POrderDetailId
			FROM @PODetails
			WHERE STATUS = 5
			)

	INSERT INTO POProductDetails (
		ProductID,
		ColorID,
		IMENO,
		POrderDetailID,
		DamagePOPDID
		) (
		SELECT POPD.ProductId,
		POPD.ColorId,
		POPD.IMENo,
		POD.POrderDetailID,
		POPD.DamagePOPDID FROM @POProductDetails POPD INNER JOIN POrderDetails POD
		ON POD.ProductID = POPD.ProductId AND POD.ColorID = POPD.ColorId AND POD.POrderID = @PurchaseOrderId
		)

	UPDATE POProductDetails
	SET IsDamageReplaced = 1
	FROM @POProductDetails dtPOPD
	INNER JOIN POProductDetails POPD
		ON dtPOPD.DamagePOPDID = POPD.POPDID

	Set @TPQty=ISNULL((Select sum(Quantity) from POrderDetails where POrderID=@PurchaseOrderId),0)
	Update POrders set TPQty=@TPQty where POrderID=@PurchaseOrderId

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity - s.Quantity),
		Stocks.MRPPrice = s.MRPPrice,
		LPPrice = s.LPPrice,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate
	FROM @Stocks s
	INNER JOIN Stocks
		ON Stocks.StockID = s.StockID
	WHERE s.STATUS = 5

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity + s.Quantity),
		Stocks.MRPPrice = s.MRPPrice,
		LPPrice = s.LPPrice,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate
	FROM @Stocks s
	INNER JOIN Stocks
		ON Stocks.StockID = s.StockID
	WHERE s.STATUS = 3 OR s.STATUS = 4

	INSERT INTO Stocks (
		StockCode,
		ColorId,
		EntryDate,
		Quantity,
		ProductID,
		MRPPrice,
		LPPrice,
		ConcernID,
		CreatedBy,
		CreateDate,
		GodownID
		) (
		SELECT StockCode,
		ColorId,
		EntryDate,
		Quantity,
		ProductId,
		MRPPrice,
		LPPrice,
		ConcernId,
		CreatedBy,
		CreateDate,
		GodownId
		FROM @Stocks WHERE StockId IS NULL
		)

	DELETE
	FROM StockDetails
	WHERE StockDetails.POrderDetailID IN (
			SELECT POrderDetailId
			FROM @PODetails
			WHERE STATUS = 4 OR STATUS = 5
			)

	INSERT INTO StockDetails (
		StockID,
		StockCode,
		ProductID,
		ColorID,
		POrderDetailID,
		IMENO,
		STATUS,
		PRate,
		SRate,
		CreditSRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownID,
		Quantity
		) (
		SELECT stk.StockID,
		stkd.StockCode,
		stkd.ProductId,
		stkd.ColorId,
		POD.POrderDetailID,
		stkd.IMENo,
		stkd.STATUS,
		(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment)))),
		stkd.SalesRate,
		stkd.CreditSRate,
		POD.CRSalesRate12Month,
		POD.CRSalesRate3Month,
		stkd.GodownId,
		POD.Quantity
		FROM @StockDetails stkd INNER JOIN Stocks stk
		ON stk.ProductID = stkd.ProductId AND stk.ColorID = stkd.ColorID AND stk.GodownID = stkd.GodownId
		INNER JOIN POrderDetails POD
		ON POD.ProductID = stkd.ProductId AND POD.ColorID = stkd.ColorId AND POD.GodownID=stkd.GodownId AND POD.POrderID = @PurchaseOrderId
		INNER JOIN Products p on stkd.ProductId = p.ProductID
		where p.ProductType=2
		)

		INSERT INTO StockDetails (
		StockID,
		StockCode,
		ProductID,
		ColorID,
		POrderDetailID,
		IMENO,
		STATUS,
		PRate,
		SRate,
		CreditSRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownID
		) (
		SELECT stk.StockID,
		stkd.StockCode,
		stkd.ProductId,
		stkd.ColorId,
		POD.POrderDetailID,
		stkd.IMENo,
		stkd.STATUS,
		(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment)))),
		stkd.SalesRate,
		stkd.CreditSRate,
		POD.CRSalesRate12Month,
		POD.CRSalesRate3Month,
		stkd.GodownId
		FROM @StockDetails stkd 
		INNER JOIN Stocks stk
		ON stk.ProductID = stkd.ProductId AND stk.ColorID = stkd.ColorID AND stk.GodownID = stkd.GodownId
		INNER JOIN POrderDetails POD
		ON POD.ProductID = stkd.ProductId AND POD.ColorID = stkd.ColorId AND POD.GodownID=stkd.GodownId AND POD.POrderID = @PurchaseOrderId
		INNER JOIN Products p on stkd.ProductId = p.ProductID
		where p.ProductType!=2
		)

	UPDATE StockDetails
	SET PRate = (POD.UnitPrice - (((po.TDiscount + po.AdjAmount) * POD.UnitPrice) / (po.GrandTotal - po.NetDiscount + (po.TDiscount + po.AdjAmount))))
	FROM POrderDetails pod
	INNER JOIN StockDetails sd
		ON pod.POrderDetailID = sd.POrderDetailID
	INNER JOIN POrders po
		ON pod.POrderID = po.POrderID
	WHERE po.POrderID = @PurchaseOrderId



	INSERT INTO TransactionPOrders (
		OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPDisAmt
		,NetDiscount
		,LaborCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,ActionStatus
		,ModifiedBy
		,ModifiedDate
		,POrderID

		) (
		SELECT po.OrderDate
		,po.ChallanNo
		,po.SupplierID
		,po.GrandTotal
		,po.TDiscount
		,po.TotalAmt
		,po.AdjAmount
		,po.RecAmt
		,po.PaymentDue
		,po.TotalDue
		,po.Status
		,po.PPDisAmt
		,po.NetDiscount
		,po.LaborCost
		,po.ConcernID
		,po.CreateDate
		,po.CreatedBy
		,po.IsDamageOrder
		,po.Remarks
		,po.InvoiceNo
		,po.TPQty
		,po.ActionStatus
		,po.ModifiedBy
		,po.ModifiedDate
		,po.POrderID
		 FROM POrders po
		INNER JOIN POrders p on po.POrderID = p.POrderID AND p.POrderID =  @PurchaseOrderId
		)

	INSERT INTO TransactionPOrderDetails (
		ProductID
		,ColorID
		,Quantity
		,UnitPrice
		,TAmount
		,PPDISPer
		,PPDISAmt
		,MRPRate
		,POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOFFER
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownID
		,ActionStatus
		,ActionBy
		,ActionDate
		) (
		SELECT pd.ProductId
		,pd.ColorId
		,pd.Quantity
		,pd.UnitPrice
		,pd.TAmount
		,pd.PPDisPer
		,pd.PPDisAmt
		,pd.MrpRate
		,@PurchaseOrderId POrderID
		,pd.SalesRate
		,pd.ExtraPPDISPer
		,pd.ExtraPPDISAmt
		,pd.PPOffer
		,pd.CreditSalesRate
		,pd.CRSalesRate12Month
		,pd.CRSalesRate3Month
		,pd.GodownId
		,(
			SELECT ActionStatus 
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,(
			SELECT ModifiedBy
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,(
			SELECT ModifiedDate
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		FROM POrderDetails pd
		INNER JOIN POrders p on p.POrderID =  @PurchaseOrderId
		INNER JOIN POrderDetails ppd on pd.POrderDetailID = ppd.POrderDetailID AND ppd.POrderID = @PurchaseOrderId
		)


	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	DECLARE @CreatedDate DATETIME,
		@CreatedBy INT

	SELECT @CreatedBy = CreatedBy,
		@CreatedDate = CreateDate
	FROM @PurchaseOrder

	INSERT INTO Errors (
		Message,
		StackTrace,
		CreatedBy,
		CreateDate
		)
	VALUES (
		ERROR_MESSAGE(),
		ERROR_PROCEDURE() + ':' + CONVERT(VARCHAR(10), ERROR_LINE()) + '-' + ERROR_MESSAGE(),
		@CreatedBy,
		@CreatedDate
		)

	RETURN 0;
END CATCH


-----------------------------------------------------------------------------------------------------------------------------------
-----------COMMONSOURCE---------
-------------Nahid--------------
----------03-11-2024------------


ALTER PROC [dbo].[GetSOForAdvanceSearch]
(
	@IMEI NVARCHAR(MAX),
	@ConcernId INT
)
  
AS 
 BEGIN 
	 
	DECLARE @SDetailID INT = NULL;
	DECLARE @RDetialID INT = NULL;

	SELECT @RDetialID = ROrderDet.RStockDetailId FROM
	(
		SELECT TOP(1) sd.RStockDetailId
			FROM SOrderDetails sd
			WHERE EXISTS (SELECT TOP(1) *
						  FROM StockDetails sd2
						  JOIN SOrders s ON sd.SOrderID = s.SOrderID
						  WHERE sd.RStockDetailId = sd2.SDetailID AND sd2.IMENO= @IMEI AND s.ConcernID = @ConcernId AND sd2.Status IN(2, 4) ORDER BY sd.SOrderDetailID DESC)
	) ROrderDet

	IF @RDetialID IS NULL BEGIN  
    	SELECT @SDetailID = SOrderDet.SDetailID FROM
		(
			SELECT TOP(1) sd.SDetailID
			FROM SOrderDetails sd
			WHERE EXISTS (SELECT TOP(1) *
						  FROM StockDetails sd2
						  JOIN SOrders s ON sd.SOrderID = s.SOrderID
						  WHERE sd.SDetailID = sd2.SDetailID AND sd2.IMENO= @IMEI AND s.ConcernID = @ConcernId AND sd2.Status IN(2, 4) ORDER BY sd.SOrderDetailID DESC)
		) SOrderDet
    END
    



	IF @SDetailID IS NOT NULL OR @RDetialID IS NOT NULL
		BEGIN
			IF @SDetailID IS NOT NULL
				BEGIN
					SELECT P.Code ProductCode, P.ProductName, sd.Quantity,
					(((sd.UnitPrice - (sd.PPOffer + sd.PPDAmount) / sd.Quantity) - ((s.TDAmount + s.AdjAmount) / (s.GrandTotal - s.NetDiscount + s.TDAmount)) * (sd.UnitPrice - (sd.PPOffer + sd.PPDAmount) / sd.Quantity)) * sd.Quantity) SalesRate,
					sd1.IMENO IMEI, c.Code CustomerCode, c.Name CustomerName, s.InvoiceDate SalesDate, s.InvoiceNo

					FROM SOrderDetails sd
					JOIN SOrders s ON sd.SOrderID = s.SOrderID
					JOIN Products p ON sd.ProductID = P.ProductID
					JOIN StockDetails sd1 ON sd.SDetailID = sd1.SDetailID
					LEFT JOIN Customers c ON s.CustomerID = c.CustomerID
					WHERE sd1.SDetailID = @SDetailID AND s.ConcernID = @ConcernId
				END
			ELSE
				BEGIN
					SELECT P.Code ProductCode, P.ProductName, sd.Quantity,
					sd.UnitPrice SalesRate,
					sd1.IMENO IMEI, c.Code CustomerCode, c.Name CustomerName, s.InvoiceDate SalesDate, s.InvoiceNo

					FROM SOrderDetails sd
					JOIN SOrders s ON sd.SOrderID = s.SOrderID
					JOIN Products p ON sd.ProductID = P.ProductID
					JOIN StockDetails sd1 ON sd.RStockDetailId = sd1.SDetailID
					LEFT JOIN Customers c ON s.CustomerID = c.CustomerID
					WHERE sd.RStockDetailId = @RDetialID AND s.ConcernID = @ConcernId
				END
		END
	ELSE
		BEGIN
			DECLARE @CDetailsId INT  = 0;
			SELECT @CDetailsId = csd.StockDetailID
			FROM CreditSaleDetails csd
			WHERE EXISTS (SELECT TOP(1) *
						  FROM StockDetails sd
						  WHERE csd.StockDetailID = sd.SDetailID AND sd.IMENO= @IMEI AND sd.Status IN(2, 4) ORDER BY csd.CreditSaleDetailsID DESC)
		
			SELECT P.Code ProductCode, P.ProductName, csd.Quantity,
			csd.UnitPrice SalesRate,
			sd.IMENO IMEI, c.Code CustomerCode, c.Name CustomerName, cs.IssueDate SalesDate, cs.InvoiceNo

			FROM CreditSaleDetails csd
			JOIN CreditSales cs ON csd.CreditSalesID = cs.CreditSalesID
			JOIN Products p ON csd.ProductID = P.ProductID
			JOIN StockDetails sd ON csd.StockDetailID = sd.SDetailID
			LEFT JOIN Customers c ON cs.CustomerID = c.CustomerID
			WHERE sd.SDetailID = @CDetailsId AND cs.ConcernID = @ConcernId

		END
 END

-- credit sales
--EXEC GetSOForAdvanceSearch '2109151241214913', 3078

-- normal sales
--EXEC GetSOForAdvanceSearch '1440602AL2257', 5126

--EXEC GetSOForAdvanceSearch 'WTR0000016392', 5126

-----------COMMONSOURCE---------
-------------Nahid--------------
----------02-11-2024------------




CREATE FUNCTION [dbo].[CheckTransferProductStatusByPOId]
(
  @PurchaseOrderId int
)  
  RETURNS int
AS 
 BEGIN
	DECLARE	@Sold int
    
    SELECT @Sold = COUNT(*)
	FROM StockDetails
	JOIN POrderDetails POD ON POD.POrderDetailID = StockDetails.POrderDetailID 
	join POrders PO on POD.POrderID = PO.POrderID
	join Products p on POD.ProductID = p.ProductID
	WHERE p.ProductType <> 2 and POD.POrderID = @PurchaseOrderId AND StockDetails.Status = 2


	
	
	IF @Sold IS NULL OR @Sold = 0
		begin
			SET @Sold=0

			set @Sold =  (select ISNULL(COUNT(*), 0) FROM StockDetails sd
			JOIN POrderDetails POD ON POD.POrderDetailID = sd.POrderDetailID 
			join POrders PO on POD.POrderID = PO.POrderID
			JOIN TransferDetails td on td.SDetailID = sd.SDetailID
			join Products p on POD.ProductID = p.ProductID
			WHERE p.ProductType = 2 and POD.POrderID = @PurchaseOrderId)


		end

	  
	  
	RETURN  @Sold
  END

  --select dbo.CheckProductStatusByPOId(76903)
GO


---------------------------------------------------------------------------------------------------------------------


ALTER PROCEDURE [dbo].[sp_AddReturnOrder_New] 
(
    @SalesOrder [InsertDMSReturnOrderTable] readonly,
    @SODetails [InsertDMSReturnOrderDetailTable] readonly
)
AS
BEGIN
    DECLARE @SalesOrderId INT;

    BEGIN TRY
        BEGIN TRANSACTION;

        -- Insert into ROrders table
        INSERT INTO ROrders (InvoiceNo, ReturnDate, GrandTotal, CustomerID, PaidAmount, ConcernID,
                             CreatedBy, CreateDate, ModifiedBy, ModifiedDate)
        SELECT InvoiceNo, InvoiceDate, GrandTotal, CustomerID, RecAmt, ConcernID, 
               CreatedBy, CreateDate, CreatedBy, CreateDate
        FROM @SalesOrder;

        SET @SalesOrderId = SCOPE_IDENTITY();


        -- Insert into ROrderDetails
        INSERT INTO ROrderDetails (ROrderID, ProductID, Quantity, UnitPrice, UTAmount, StockDetailID, ColorID, CheckNo, SQty, Quant, SID)
        SELECT 
            @SalesOrderId, s.ProductId, 
            CASE 
                WHEN p.ProductType = 2 THEN s.Quantity
                ELSE 1
            END AS Quantity,s.UnitPrice, s.TAmount, s.StockDetailId, s.ColorID, 
            CASE 
                WHEN p.ProductType = 2 THEN 1
                ELSE 3
            END AS CheckNo,
            CASE 
                WHEN p.ProductType = 2 THEN  s.dSalesQuantity
                ELSE 1
            END AS SQty, s.Quantity AS Quant, s.dSOrderDetailsId
        FROM @SODetails s
        --INNER JOIN SOrderDetails sod ON s.StockDetailId = sod.SDetailID
        --INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
        INNER JOIN Products p ON s.ProductId = p.ProductID;

        --INSERT INTO ROrderDetails (ROrderID, ProductID, Quantity, UnitPrice, UTAmount, StockDetailID, ColorID, CheckNo, SQty, Quant, SID)
        --SELECT 
        --    @SalesOrderId, s.ProductId, s.Quantity, s.UnitPrice, s.TAmount, s.StockDetailId, s.ColorId, 0, @SQty, 0 , @SID
        --FROM @SODetails s



        -- Handle Product without Barcode (ProductType = 2)
        UPDATE sod
        SET 
            sod.IsProductReturn = CASE 
                                    WHEN sod.Quantity - s.Quantity > 0 THEN 0
                                    ELSE 1 
                                  END,
            sod.RQuantity = sod.RQuantity + s.Quantity
        FROM ROrderDetails s
        INNER JOIN SOrderDetails sod ON s.ProductId = sod.ProductID
        INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
        INNER JOIN Products p ON s.ProductId = p.ProductID
        WHERE p.ProductType = 2 AND sod.IsProductReturn != 1 AND s.ROrderID = @SalesOrderId AND s.SID = sod.SOrderDetailID;

        -- Handle Product with Barcode (ProductType <> 2)
        UPDATE sod
        SET 
            sod.IsProductReturn = 1,
            sod.RQuantity = sod.RQuantity + 1
        FROM ROrderDetails s
        INNER JOIN SOrderDetails sod ON s.StockDetailId = sod.SDetailID
        INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
        INNER JOIN Products p ON s.ProductId = p.ProductID
        WHERE p.ProductType <> 2 AND sod.IsProductReturn != 1 AND s.ROrderID = @SalesOrderId AND s.SID = sod.SOrderDetailID;
		

        -- Update StockDetails
  --      UPDATE StockDetails
  --      SET StockDetails.Quantity = std.Quantity + sd.Quantity, 
		--StockDetails.Status = 1
  --      FROM @SODetails sd
		--INNER JOIN SOrderDetails sod ON sd.dSOrderDetailsId = sod.SOrderDetailID
		--Inner Join StockDetails std On sod.SDetailID = std.SDetailID;

UPDATE st
SET st.Quantity = st.Quantity + s.TotalQuantity, st.Status = 1
FROM (
    SELECT std.SDetailID, SUM(s.Quantity) AS TotalQuantity
    FROM @SODetails s
    INNER JOIN SOrderDetails sod ON s.dSOrderDetailsId = sod.SOrderDetailID
    INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
    GROUP BY std.SDetailID
) s
INNER JOIN StockDetails st ON s.SDetailID=st.SDetailID;
		
        -- Update Stock quantities
  --      UPDATE st
  --      SET st.Quantity = st.Quantity + s.Quantity
  --      FROM @SODetails s
  --      INNER JOIN SOrderDetails sod ON s.dSOrderDetailsId = sod.SOrderDetailID
  --      INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
		--INNER JOIN Stocks st ON std.StockID = st.StockID;

UPDATE st
SET st.Quantity = st.Quantity + s.TotalQuantity
FROM (
    SELECT std.StockID, SUM(s.Quantity) AS TotalQuantity
    FROM @SODetails s
    INNER JOIN SOrderDetails sod ON s.dSOrderDetailsId = sod.SOrderDetailID
    INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
    GROUP BY std.StockID
) s
INNER JOIN Stocks st ON s.StockID=st.StockID;

		 --Update Stock quantities
   --     UPDATE Stocks
   --     SET Stocks.Quantity = Stocks.Quantity + sod.RQuantity
   --     FROM @SODetails s
   --     INNER JOIN SOrderDetails sod ON s.StockDetailId = sod.SDetailID
   --     INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID;



        -- SR Visit updates
        --DECLARE @EmployeeId INT;
        --SET @EmployeeId = (SELECT TOP(1) SRId FROM @SalesOrder);

        -- Update SRVisitDetails for No Barcode
        --UPDATE SRVisitDetails
        --SET SRVisitDetails.SoldQty = (SRVisitDetails.SoldQty - s.Quantity)
        --FROM @SODetails s
        --JOIN SRVisitDetails ON SRVisitDetails.ProductID = s.ProductId AND SRVisitDetails.ColorID = s.ColorId
        --JOIN SRVisits sv ON SRVisitDetails.SRVisitID = sv.SRVisitID
        --JOIN Products p ON s.ProductId = p.ProductID
        --WHERE sv.EmployeeID = @EmployeeId AND p.ProductType = 2;

        -- Update SRVisitDetails for Barcode
        --UPDATE SRVisitDetails
        --SET SRVisitDetails.Quantity = 1
        --FROM @SODetails s
        --JOIN SRVisitDetails ON SRVisitDetails.ProductID = s.ProductId AND SRVisitDetails.ColorID = s.ColorId
        --JOIN SRVisits sv ON SRVisitDetails.SRVisitID = sv.SRVisitID
        --JOIN Products p ON s.ProductId = p.ProductID
        --WHERE sv.EmployeeID = @EmployeeId AND p.ProductType <> 2;

        -- Update SRVProductDetails
        --UPDATE SRVProductDetails
        --SET SRVProductDetails.Status = 1
        --FROM @SODetails s
        --JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
        --WHERE SRVProductDetails.Status = 2;

        -- Update Customer's total due
        UPDATE Customers
        SET Customers.TotalDue = Customers.TotalDue - s.TotalDue
        FROM @SalesOrder s
        INNER JOIN Customers ON Customers.CustomerID = s.CustomerID;

        -- Update EmployeeWiseCustomerDues
        --UPDATE EmployeeWiseCustomerDues
        --SET CustomerDue = CustomerDue - s.TotalDue
        --FROM @SalesOrder s
        --INNER JOIN EmployeeWiseCustomerDues sr ON sr.CustomerID = s.CustomerID
        --WHERE EmployeeID = s.SRId;

        COMMIT;
        RETURN 1;
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK;
        RETURN 0;
    END CATCH;

    -- Nullify RQuantity values
    UPDATE SOrderDetails
    SET RQuantity = 0
    WHERE RQuantity IS NULL;
END;


-------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[UpdateTotalDueForExpenditure]
(
	@ExpenseItemID int,
	@BankDepositId int,
	@BankWithdrawId int,
	@CollectionAmount decimal(18,2),
	@ConcernID int,
	@userId int,
	@Remarks nvarchar(MAX),
	@TranDate DATETIME
)
  
AS 
IF(@ExpenseItemID>0)
BEGIN
--DECLARE @maxExpenseId int;
--Set @maxExpenseId=(Select ExpenditureID from Expenditures)
INSERT INTO [dbo].[Expenditures]
           ([EntryDate],[Purpose],[Amount],[ExpenseItemID]
           ,[VoucherNo],[ConcernID],[CreatedBy],[CreateDate]
           ,[CustomerType],[Remarks],[WFStatus],[CashInHandReportStatus],[IsBankTransaction])
     VALUES
           (@TranDate,@Remarks
           ,@CollectionAmount,@ExpenseItemID,(CONVERT(varchar(100),@ExpenseItemID))
            ,@ConcernID,@userId,GETDATE(),0
           ,'From Bank Transaction',2,0,1)
END
 IF(@BankDepositId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount + @CollectionAmount)
	where BankID=@BankDepositId
END
  
 IF(@BankWithdrawId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount - @CollectionAmount)
	where BankID=@BankWithdrawId
END

RETURN


-------------------------------------------------------------------------------------------------------

UPDATE Expenditures set IsBankTransaction = 1 where Remarks = 'From Bank Transaction'

-------------------------------------------------------------------------------------------------------

ALTER TABLE dbo.SystemInformations ADD
	IsProductTypeHide int NOT NULL CONSTRAINT DF_SystemInformations_IsProductTypeHide DEFAULT ((0))
GO

-----------COMMONSOURCE---------
-------------Nahid--------------
----------31-10-2024------------


CREATE TYPE [dbo].[InsertDMSReturnOrderTable] AS TABLE(
	[InvoiceDate] [datetime] NULL,
	[InvoiceNo] [varchar](150) NULL,
	[VatPercentage] [decimal](18, 2) NULL,
	[VatAmount] [decimal](18, 2) NULL,
	[GrandTotal] [decimal](18, 2) NULL,
	[TDiscountPercentage] [decimal](18, 2) NULL,
	[TDiscountAmount] [decimal](18, 2) NULL,
	[RecAmt] [decimal](18, 2) NULL,
	[PaymentDue] [decimal](18, 2) NULL,
	[TotalAmount] [decimal](18, 2) NULL,
	[TotalDue] [decimal](18, 2) NULL,
	[AdjAmount] [decimal](18, 2) NULL,
	[Status] [int] NULL,
	[CustomerId] [int] NULL,
	[ConcernId] [int] NULL,
	[CreatedBy] [int] NULL,
	[CreateDate] [datetime] NULL,
	[TotalOffer] [decimal](18, 2) NULL,
	[NetDiscount] [decimal](18, 2) NULL,
	[Remarks] [varchar](500) NULL
)
GO

-------------------------------------------------------------------------------------------------------

CREATE TYPE [dbo].[InsertDMSReturnOrderDetailTable] AS TABLE(
	[SOrderDetailID] [int] NULL,
	[ProductId] [int] NULL,
	[StockDetailId] [int] NULL,
	[ColorId] [int] NULL,
	[Status] [int] NULL,
	[Quantity] [decimal](18, 2) NULL,
	[UnitPrice] [decimal](18, 2) NULL,
	[TAmount] [decimal](18, 2) NULL,
	[PPDisPer] [decimal](18, 2) NULL,
	[PPDisAmt] [decimal](18, 2) NULL,
	[MrpRate] [decimal](18, 2) NULL,
	[PPOffer] [decimal](18, 2) NULL,
	[dSalesQuantity] [decimal](18, 2) NULL,
	[dSOrderDetailsId] [int] NULL,
	[StockID] [int] NULL
)
GO

-------------------------------------------------------------------------------------------------------

CREATE PROCEDURE [dbo].[sp_AddReturnOrder_New] 
(
    @SalesOrder [InsertDMSReturnOrderTable] readonly,
    @SODetails [InsertDMSReturnOrderDetailTable] readonly
)
AS
BEGIN
    DECLARE @SalesOrderId INT;

    BEGIN TRY
        BEGIN TRANSACTION;

        -- Insert into ROrders table
        INSERT INTO ROrders (InvoiceNo, ReturnDate, GrandTotal, CustomerID, PaidAmount, ConcernID,
                             CreatedBy, CreateDate, ModifiedBy, ModifiedDate)
        SELECT InvoiceNo, InvoiceDate, GrandTotal, CustomerID, RecAmt, ConcernID, 
               CreatedBy, CreateDate, CreatedBy, CreateDate
        FROM @SalesOrder;

        SET @SalesOrderId = SCOPE_IDENTITY();


        -- Insert into ROrderDetails
        INSERT INTO ROrderDetails (ROrderID, ProductID, Quantity, UnitPrice, UTAmount, StockDetailID, ColorID, CheckNo, SQty, Quant, SID)
        SELECT 
            @SalesOrderId, s.ProductId, 
            CASE 
                WHEN p.ProductType = 2 THEN s.Quantity
                ELSE 1
            END AS Quantity,s.UnitPrice, s.TAmount, s.StockDetailId, s.ColorID, 
            CASE 
                WHEN p.ProductType = 2 THEN 1
                ELSE 3
            END AS CheckNo,
            CASE 
                WHEN p.ProductType = 2 THEN  s.dSalesQuantity
                ELSE 1
            END AS SQty, s.Quantity AS Quant, s.dSOrderDetailsId
        FROM @SODetails s
        --INNER JOIN SOrderDetails sod ON s.StockDetailId = sod.SDetailID
        --INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
        INNER JOIN Products p ON s.ProductId = p.ProductID;

        --INSERT INTO ROrderDetails (ROrderID, ProductID, Quantity, UnitPrice, UTAmount, StockDetailID, ColorID, CheckNo, SQty, Quant, SID)
        --SELECT 
        --    @SalesOrderId, s.ProductId, s.Quantity, s.UnitPrice, s.TAmount, s.StockDetailId, s.ColorId, 0, @SQty, 0 , @SID
        --FROM @SODetails s



        -- Handle Product without Barcode (ProductType = 2)
        UPDATE sod
        SET 
            sod.IsProductReturn = CASE 
                                    WHEN sod.Quantity - s.Quantity > 0 THEN 0
                                    ELSE 1 
                                  END,
            sod.RQuantity = sod.RQuantity + s.Quantity
        FROM ROrderDetails s
        INNER JOIN SOrderDetails sod ON s.ProductId = sod.ProductID
        INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
        INNER JOIN Products p ON s.ProductId = p.ProductID
        WHERE p.ProductType = 2 AND sod.IsProductReturn != 1 AND s.ROrderID = @SalesOrderId AND s.SID = sod.SOrderDetailID;

        -- Handle Product with Barcode (ProductType <> 2)
        UPDATE sod
        SET 
            sod.IsProductReturn = 1,
            sod.RQuantity = sod.RQuantity + 1
        FROM ROrderDetails s
        INNER JOIN SOrderDetails sod ON s.StockDetailId = sod.SDetailID
        INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
        INNER JOIN Products p ON s.ProductId = p.ProductID
        WHERE p.ProductType <> 2 AND sod.IsProductReturn != 1 AND s.ROrderID = @SalesOrderId AND s.SID = sod.SOrderDetailID;
		

        -- Update StockDetails
  --      UPDATE StockDetails
  --      SET StockDetails.Quantity = std.Quantity + sd.Quantity, 
		--StockDetails.Status = 1
  --      FROM @SODetails sd
		--INNER JOIN SOrderDetails sod ON sd.dSOrderDetailsId = sod.SOrderDetailID
		--Inner Join StockDetails std On sod.SDetailID = std.SDetailID;

UPDATE st
SET st.Quantity = st.Quantity + s.TotalQuantity
FROM (
    SELECT std.SDetailID, SUM(s.Quantity) AS TotalQuantity
    FROM @SODetails s
    INNER JOIN SOrderDetails sod ON s.dSOrderDetailsId = sod.SOrderDetailID
    INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
    GROUP BY std.SDetailID
) s
INNER JOIN StockDetails st ON s.SDetailID=st.SDetailID;
		
        -- Update Stock quantities
  --      UPDATE st
  --      SET st.Quantity = st.Quantity + s.Quantity
  --      FROM @SODetails s
  --      INNER JOIN SOrderDetails sod ON s.dSOrderDetailsId = sod.SOrderDetailID
  --      INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
		--INNER JOIN Stocks st ON std.StockID = st.StockID;

UPDATE st
SET st.Quantity = st.Quantity + s.TotalQuantity
FROM (
    SELECT std.StockID, SUM(s.Quantity) AS TotalQuantity
    FROM @SODetails s
    INNER JOIN SOrderDetails sod ON s.dSOrderDetailsId = sod.SOrderDetailID
    INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID
    GROUP BY std.StockID
) s
INNER JOIN Stocks st ON s.StockID=st.StockID;

		 --Update Stock quantities
   --     UPDATE Stocks
   --     SET Stocks.Quantity = Stocks.Quantity + sod.RQuantity
   --     FROM @SODetails s
   --     INNER JOIN SOrderDetails sod ON s.StockDetailId = sod.SDetailID
   --     INNER JOIN StockDetails std ON sod.SDetailID = std.SDetailID;



        -- SR Visit updates
        --DECLARE @EmployeeId INT;
        --SET @EmployeeId = (SELECT TOP(1) SRId FROM @SalesOrder);

        -- Update SRVisitDetails for No Barcode
        --UPDATE SRVisitDetails
        --SET SRVisitDetails.SoldQty = (SRVisitDetails.SoldQty - s.Quantity)
        --FROM @SODetails s
        --JOIN SRVisitDetails ON SRVisitDetails.ProductID = s.ProductId AND SRVisitDetails.ColorID = s.ColorId
        --JOIN SRVisits sv ON SRVisitDetails.SRVisitID = sv.SRVisitID
        --JOIN Products p ON s.ProductId = p.ProductID
        --WHERE sv.EmployeeID = @EmployeeId AND p.ProductType = 2;

        -- Update SRVisitDetails for Barcode
        --UPDATE SRVisitDetails
        --SET SRVisitDetails.Quantity = 1
        --FROM @SODetails s
        --JOIN SRVisitDetails ON SRVisitDetails.ProductID = s.ProductId AND SRVisitDetails.ColorID = s.ColorId
        --JOIN SRVisits sv ON SRVisitDetails.SRVisitID = sv.SRVisitID
        --JOIN Products p ON s.ProductId = p.ProductID
        --WHERE sv.EmployeeID = @EmployeeId AND p.ProductType <> 2;

        -- Update SRVProductDetails
        --UPDATE SRVProductDetails
        --SET SRVProductDetails.Status = 1
        --FROM @SODetails s
        --JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
        --WHERE SRVProductDetails.Status = 2;

        -- Update Customer's total due
        UPDATE Customers
        SET Customers.TotalDue = Customers.TotalDue - s.TotalDue
        FROM @SalesOrder s
        INNER JOIN Customers ON Customers.CustomerID = s.CustomerID;

        -- Update EmployeeWiseCustomerDues
        --UPDATE EmployeeWiseCustomerDues
        --SET CustomerDue = CustomerDue - s.TotalDue
        --FROM @SalesOrder s
        --INNER JOIN EmployeeWiseCustomerDues sr ON sr.CustomerID = s.CustomerID
        --WHERE EmployeeID = s.SRId;

        COMMIT;
        RETURN 1;
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK;
        RETURN 0;
    END CATCH;

    -- Nullify RQuantity values
    UPDATE SOrderDetails
    SET RQuantity = 0
    WHERE RQuantity IS NULL;
END;


-------------------------------------------------------------------------------------------------------


-----------COMMONSOURCE----------
-------------Nahid--------------
----------19-10-2024------------




ALTER view [dbo].[vw_ProductPicker] as
Select P.Code'ProductCode',P.ProductName,G.Name'GodownName', CL.Name'ColorName', CA.Description'CategoryName', SD.IMENO, SD.SRate'MRPRate',P.ConcernID,P.ProductID,S.ColorID,S.GodownID,P.CategoryID,P.CompanyID,SD.SDetailID'StockDetailsId',S.StockID,CM.Name'CompanyName', SD.PRate'PRate',SD.Quantity'PreStock', p.ProductType, p.ServiceWarrentyMonth'Service'
From Products P
Inner Join Companies CM on CM.CompanyID=P.CompanyID and P.ConcernID=CM.ConcernID
Inner Join Categorys CA on CA.CategoryID=P.CategoryID and CA.ConcernID=P.ConcernID
Inner Join StockDetails SD on SD.ProductID=P.ProductID
Inner join Stocks S on S.StockID = SD.StockID and P.ConcernID = S.ConcernID
Inner Join Godowns G on SD.GodownID = G.GodownID and G.ConcernID = S.ConcernID
Inner Join Colors CL on CL.ColorID = SD.ColorID and CL.ConcernID = S.ConcernID
where SD.Status=1
--and S.ConcernID = 5126 Order By CA.CategoryID
GO




-------------------------------------------------------------------------------------------------------



--exec sp_ProfitandLossAccount '2020-01-01 00:00:00','2020-05-04 23:59:59',1
ALTER PROCEDURE [dbo].[sp_ProfitandLossAccount] (@Fromdate DATETIME, @ToDate DATETIME, @ConcernID INT)
AS
BEGIN
	CREATE TABLE #temp (ID INT identity(1, 1) NOT NULL, DebitParticulars NVARCHAR(MAX), Debit DECIMAL(18, 2), CreditParticulars NVARCHAR(MAX), Credit DECIMAL(18, 2), SerialNum INT)

	DECLARE @TotalIncome DECIMAL(18, 2)
	DECLARE @TotalSalesReturn DECIMAL(18, 2)
	DECLARE @TotalPOReturn DECIMAL(18, 2)
	DECLARE @TotalExpense DECIMAL(18, 2)
	DECLARE @LastPayAdjust DECIMAL(18, 2)
	DECLARE @DebitAdjusment DECIMAL(18, 2)
	DECLARE @CreditAdjusment DECIMAL(18, 2)
	DECLARE @SupplierDebitAdjusment DECIMAL(18, 2)
	DECLARE @SupplierCreditAdjusment DECIMAL(18, 2)


	SET @TotalIncome = 0
	SET @TotalExpense = 0

	SELECT @TotalIncome = ISNULL(SUM(SOD.Quantity * ((SOD.UnitPrice - SOD.PPDAmount) - (((SOD.UnitPrice - SOD.PPDAmount) * (SO.TDAmount + SO.AdjAmount)) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)))), 0),
	@TotalExpense = ISNULL(SUM(SOD.PRate * SOD.Quantity), 0)
	FROM SOrderDetails SOD
	INNER JOIN SOrders SO
		ON SOD.SOrderID = SO.SOrderID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.SDetailID
	WHERE SO.STATUS = 1 AND SO.IsReplacement=0 AND (SO.InvoiceDate >= @Fromdate AND SO.InvoiceDate <= @ToDate) AND SO.ConcernID = @ConcernID

	SELECT @TotalSalesReturn = ISNULL(SUM(SOD.Quantity * SOD.UnitPrice), 0), @TotalPOReturn = ISNULL(SUM(STD.PRate * SOD.Quantity), 0)
	FROM ROrderDetails SOD
	INNER JOIN ROrders SO
		ON SOD.ROrderID = SO.ROrderID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailID
	WHERE (SO.ReturnDate >= @Fromdate AND SO.ReturnDate <= @ToDate) AND SO.ConcernID = @ConcernID

	--Print(Convert(varchar(123),@TotalIncome))
	--Print(Convert(varchar(123),@TotalExpense))
	SELECT @TotalIncome = @TotalIncome + ISNULL(SUM(CSP.Quantity * (CSP.UnitPrice - (CS.Discount * CSP.UnitPrice / CS.TSalesAmt))), 0),
	--+ISNULL(SUM((((((CS.InterestAmount) / (CS.TSalesAmt - CS.InterestAmount)) * (CSP.UnitPrice))) * CSP.Quantity) - (((((CS.Discount) / (CS.TSalesAmt - CS.InterestAmount)) * (CSP.UnitPrice))) * CSP.Quantity)),0), 
	@TotalExpense = @TotalExpense + ISNULL(SUM(STD.PRate * CSP.Quantity), 0)
	FROM CreditSaleDetails CSP
	INNER JOIN CreditSales CS
		ON CS.CreditSalesID = CSP.CreditSalesID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = CSP.StockDetailID
	WHERE CS.IsStatus = 1 AND CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CS.ConcernID = @ConcernID
	--Print(Convert(varchar(123),@TotalIncome))
	SELECT @TotalIncome = @TotalIncome + ISNULL(SUM(HireValue), 0)
	FROM CreditSales CS
	INNER JOIN CreditSaleDetails CSP
		ON CSP.CreditSalesID = CS.CreditSalesID
	INNER JOIN CreditSalesSchedules CSD
		ON CSD.CreditSalesID = CS.CreditSalesID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = CSP.StockDetailID
	WHERE Cs.IsStatus = 1 AND CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Purchase', ISNULL(@TotalExpense, 0), '', 0.00, 1)

	IF(@TotalPOReturn>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Purchase Return', ISNULL(@TotalPOReturn, 0), '', 0.00, 2)

	IF(ISNULL(@TotalExpense - @TotalPOReturn, 0)!=0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Net Purchase', ISNULL(@TotalExpense - @TotalPOReturn, 0), '', 0.00, 3)

	IF(@TotalIncome!=0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Sales', @TotalIncome, 4)

	IF(@TotalSalesReturn>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Sales Return', @TotalSalesReturn, 5)

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Net Sales', (@TotalIncome - @TotalSalesReturn), 6)

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Gross Profit', ISNULL((@TotalIncome - @TotalSalesReturn) - (@TotalExpense - @TotalPOReturn), 0), 7)

	--Last Pay adjustment
	SELECT @LastPayAdjust = ISNULL(SUM(CSD.LastPayAdjust), 0)
	FROM CreditSales CS
	INNER JOIN CreditSalesSchedules CSD
		ON CSD.CreditSalesID = CS.CreditSalesID
	WHERE Cs.IsStatus = 1 AND CSD.PaymentDate >= @Fromdate AND CSD.PaymentDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID

	SELECT @LastPayAdjust = @LastPayAdjust + ISNULL(SUM(CS.AdjustAmt), 0)
	FROM CashCollections CS
	WHERE Cs.TransactionType = 1 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@LastPayAdjust>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Bad Debt.', ISNULL(@LastPayAdjust, 0), '', 0.00, 8)


	-- Customer Debit Adjustment
	SELECT @DebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 7 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@DebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Customer Adjustment', ISNULL(@DebitAdjusment, 0), '', 0.00, 13)

		
	-- Customer Credit Adjustment
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 6 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Customer Adjustment', ISNULL(@CreditAdjusment, 0), 15)

	

	--Supplier Debit Adjustment
	SELECT @SupplierDebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 6 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0
	
	IF(@SupplierDebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Supplier Debit Adjustment', ISNULL(@SupplierDebitAdjusment, 0), '', 0.00, 14)

		
	--Supplier Credit Adjustment
	SELECT @SupplierCreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 7 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0
	
	IF(@SupplierCreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.00, 'Supplier Credit Adjustment', ISNULL(@SupplierCreditAdjusment, 0), 16)

	---------------------Income----------------------
	set @TotalIncome = ISNULL((	SELECT SUM(ex.Amount)
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 2 and ex.CashInHandReportStatus = 0),0)

	IF(@TotalIncome>0)
	BEGIN
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	SELECT '', 0.00, exi.Description, ex.Amount, 9
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 2 and ex.CashInHandReportStatus = 0

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES('',0.00,'Total Income',@TotalIncome,10)
	END

	-----------------------expense----------------------
	set @TotalExpense = ISNULL((SELECT SUM( ex.Amount)
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 1 AND exi.Description != 'Send cash to head of accounts' and ex.CashInHandReportStatus = 0
    ),0)

	IF(@TotalExpense>0)
	BEGIN
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	SELECT exi.Description, ex.Amount, '', 0.00, 11
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 1 AND exi.Description != 'Send cash to head of accounts' and ex.CashInHandReportStatus = 0

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES('Total Expense',@TotalExpense,'',0.00,12)
	END

	SELECT SerialNum, DebitParticulars, sum(Debit) 'Debit', CreditParticulars, sum(Credit) 'Credit'
	FROM #temp
	GROUP BY DebitParticulars, CreditParticulars, SerialNum
	ORDER BY SerialNum ASC
		--Print(Convert(varchar(123),@TotalIncome))



END


-----------ECOMCOMBINE----------
-------------Nahid--------------
----------28-09-2024------------

ALTER TABLE dbo.Banks ADD
	CreatedBy int NOT NULL CONSTRAINT DF_Banks_CreatedBy DEFAULT ((0)),
	CreateDate datetime NOT NULL CONSTRAINT DF_Banks_CreateDate DEFAULT (getdate()),
	ModifiedBy int NULL,
	ModifiedDate datetime NULL
GO

-----------ECOMCOMBINE----------
-------------Nahid--------------
----------25-09-2024------------
ALTER TABLE dbo.BankTransactions ADD
	CreatedBy int NOT NULL CONSTRAINT DF_BankTransactions_CreatedBy DEFAULT ((0)),
	CreateDate datetime NOT NULL CONSTRAINT DF_BankTransactions_CreateDate DEFAULT (getdate()),
	ModifiedBy int NULL,
	ModifiedDate datetime NULL
GO



-----------ECOMCOMBINE----------
-------------Nahid--------------
----------24-09-2024------------

ALTER TABLE dbo.SystemInformations ADD
	ShowPurchasePrice int NOT NULL CONSTRAINT DF_SystemInformations_ShowPurchasePrice DEFAULT ((0)),
	VatRegNo nvarchar(MAX) NULL,
	IsEcomputerShow int NOT NULL CONSTRAINT DF_SystemInformations_IsEcomputerShow DEFAULT ((0))
GO

--------EMOBILECOMBINE----------
-------------Nahid--------------
----------24-08-2024------------

ALTER TABLE dbo.CreditSaleDetails ADD
	Warranty varchar(200) NULL
GO
---------------------------------------------------------------------------------------------------------------------------------

EXEC sys.sp_rename 'dbo.InsertCSODetailTable', 'zInsertCSODetailTable';
GO
CREATE TYPE [dbo].[InsertCSODetailTable] AS TABLE(
	[ProductId] [int] NULL,
	[StockDetailId] [int] NULL,
	[ColorId] [int] NULL,
	[Quantity] [decimal](18, 2) NULL,
	[UnitPrice] [decimal](18, 2) NULL,
	[UTAmount] [decimal](18, 2) NULL,
	[MpRateTotal] [decimal](18, 2) NULL,
	[MrpRate] [decimal](18, 2) NULL,
	[PPOffer] [decimal](18, 2) NULL,
	[IntPercentage] [decimal](18, 2) NULL,
	[IntTotalAmt] [decimal](18, 2) NULL,
	[Compressor] [int] NULL,
	[Motor] [int] NULL,
	[Panel] [int] NULL,
	[Spareparts] [int] NULL,
	[Service] [int] NULL,
	[CreditSalesDetailsId] [int] NULL,
	[Warranty] [varchar](200) NULL
)
GO

DECLARE @Name NVARCHAR(776);

DECLARE REF_CURSOR CURSOR FOR
SELECT referencing_schema_name + '.' + referencing_entity_name
FROM sys.dm_sql_referencing_entities('dbo.InsertCSODetailTable', 'TYPE');

OPEN REF_CURSOR;

FETCH NEXT FROM REF_CURSOR INTO @Name;
WHILE (@@FETCH_STATUS = 0)
BEGIN
    EXEC sys.sp_refreshsqlmodule @name = @Name;
    FETCH NEXT FROM REF_CURSOR INTO @Name;
END;

CLOSE REF_CURSOR;
DEALLOCATE REF_CURSOR;
GO
DROP TYPE dbo.zInsertCSODetailTable;
GO

---------------------------------------------------------------------------------------------------------------------------------


ALTER PROCEDURE [dbo].[AddCreditSalesOrder] (
@CSalesOrder [dbo].[INSERTCREDITSALESORDERTABLE] readonly, 
@CSODetails [INSERTCSODETAILTABLE] readonly,
@CSSchedules [INSERTCSSCHEDULESTABLE] readonly,
@BankTrans [InsertBankTransTable] readonly,
@SorderID int out,
@Result int Out)
AS
DECLARE @CreditSalesId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY  
 BEGIN TRANSACTION 

-----------------Card Payment Bank Deposit--------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @CSalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

------------------Card Payment Bank Deposit--------------

INSERT INTO creditsales (invoiceno, customerid, tsalesamt, noofinstallment,
 intallmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamt, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress)
(SELECT
 invoiceno, customerid, tsalesamt, noofinstallment, 
 installmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamount, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,@BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress FROM @CSalesOrder)

UPDATE customers
SET customers.CreditDue = (customers.CreditDue + s.totaldue)
FROM @CSalesOrder s
INNER JOIN customers ON customers.customerid = s.customerid

SET @CreditSalesId = Scope_identity()

INSERT INTO CreditSaleDetails 
( 
ProductID ,UnitPrice, Quantity, UTAmount, CreditSalesID,  
MPRateTotal, MPRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,Compressor,Motor,
Panel,Spareparts,Service, Warranty
) 
( 
Select sd.ProductID ,UnitPrice, Quantity, UTAmount, @CreditSalesId CreditSalesID,  
MPRateTotal, MrpRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,p.CompressorWarrentyMonth,p.MotorWarrentyMonth,
p.PanelWarrentyMonth,p.SparePartsWarrentyMonth,p.ServiceWarrentyMonth, sd.Warranty from @CSODetails sd
join Products p on sd.ProductID=p.ProductID 
where p.ProductType!=2
) 

INSERT INTO dbo.CreditInterestHistories(InterestDate, InterestAmount, HireSaleId, IsFirstTime)
(
	SELECT salesdate, interestamount, @CreditSalesId, 1 FROM @CSalesOrder
)


UPDATE stocks
SET stocks.quantity = (stocks.quantity - s.quantity)
FROM @CSODetails s
INNER JOIN stocks ON stocks.productid = s.productid AND stocks.colorid = s.colorid AND Stocks.GodownID=s.Compressor

UPDATE StockDetails 
SET StockDetails.Status = 2 
from @CSODetails s 
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId 
join Products on StockDetails.ProductID = Products.ProductID 
where Products.ProductType!=2 

--***************FIFO for Nobarcode Product**********************
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @CreditSaleProductsID INT
DECLARE @Quantity INT
DECLARE @SQty INT
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL
FOR
SELECT s.productid, s.colorid, s.quantity, creditsalesdetailsid
-- from   InsertCSODetailTable SOD join CreditSales SO on SO.CreditSalesID=SOD.CreditSalesID where SO.Status=1
FROM @CSODetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.stockdetailid
INNER JOIN products ON stockdetails.productid = products.productid
where Products.ProductType=2 
OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID

WHILE @@FETCH_STATUS = 0
BEGIN
	WHILE @Quantity != 0
	BEGIN
		SET @SDetailID = (
				SELECT Min(sdetailid)
				FROM stockdetails
				WHERE productid = @ProductID AND colorid = @ColorID AND quantity != 0 AND STATUS = 1
				)
		SET @SQty = (
				SELECT quantity
				FROM stockdetails
				WHERE sdetailid = @SDetailID
				)

		IF (@SQty > @Quantity)
		BEGIN
			SET @SQty = @SQty - @Quantity

			UPDATE stockdetails
			SET quantity = @SQty
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service, Warranty)
			 (SELECT sd.productid, unitprice, @Quantity, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID  =@CreditSaleProductsID
			SET @Quantity = 0
		END
		ELSE IF (@SQty < @Quantity)
		BEGIN
			SET @Quantity = @Quantity - @SQty

			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service, Warranty) (SELECT sd.productid, unitprice, @SQty, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)
				--update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
		END
		ELSE
		BEGIN
			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (
			productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate,
			 stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service,Warranty
			 ) 
			 (SELECT 
			  sd.productid, unitprice, @SQty, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate,
			  @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, 
			  p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth, sd.Warranty FROM @CSODetails sd 
			  INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID
			  )

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
			SET @Quantity = 0
		END
	END

	FETCH NEXT
	FROM cur
	INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID
END

INSERT INTO creditsalesschedules (monthdate, balance, installmentamt, 
paymentdate, creditsalesid, paymentstatus, interestamount, closingbalance,
 scheduleno, remarks, isunexpected, hirevalue, netvalue)
(SELECT monthdate, balance, installmentamt,
 paymentdate, @CreditSalesId CreditSalesID, paymentstatus, interestamount, closingbalance,
  scheduleno, remarks, isunexpected, hirevalue, netvalue FROM @CSSchedules)

COMMIT
--RETURN 1;
SELECT @SorderID=@CreditSalesId,@Result=1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		--RETURN 0;
	SELECT @SorderID=0,@Result=0
END CATCH

--------EMOBILECOMBINE----------
-------------Nahid--------------
----------21-08-2024------------
ALTER TABLE dbo.SOrderDetails ADD
	Warranty nvarchar(200) NULL
GO

---------------------------------------------------------------------------------------------------------------------------------


EXEC sys.sp_rename 'dbo.InsertSODetailTable', 'zInsertSODetailTable';
GO
CREATE TYPE [dbo].[InsertSODetailTable] AS TABLE(
	[SOrderDetailID] [int] NULL,
	[ProductId] [int] NULL,
	[StockDetailId] [int] NULL,
	[ColorId] [int] NULL,
	[Status] [int] NULL,
	[Quantity] [decimal](18, 2) NULL,
	[UnitPrice] [decimal](18, 2) NULL,
	[TAmount] [decimal](18, 2) NULL,
	[PPDisPer] [decimal](18, 4) NULL,
	[PPDisAmt] [decimal](18, 2) NULL,
	[MrpRate] [decimal](18, 2) NULL,
	[PPOffer] [decimal](18, 2) NULL,
	[Compressor] [int] NULL,
	[Motor] [int] NULL,
	[Panel] [int] NULL,
	[Spareparts] [int] NULL,
	[Service] [int] NULL,
	[Warranty] [varchar](200) NULL
)
GO

DECLARE @Name NVARCHAR(776);

DECLARE REF_CURSOR CURSOR FOR
SELECT referencing_schema_name + '.' + referencing_entity_name
FROM sys.dm_sql_referencing_entities('dbo.InsertSODetailTable', 'TYPE');

OPEN REF_CURSOR;

FETCH NEXT FROM REF_CURSOR INTO @Name;
WHILE (@@FETCH_STATUS = 0)
BEGIN
    EXEC sys.sp_refreshsqlmodule @name = @Name;
    FETCH NEXT FROM REF_CURSOR INTO @Name;
END;

CLOSE REF_CURSOR;
DEALLOCATE REF_CURSOR;
GO
DROP TYPE dbo.zInsertSODetailTable;
GO



---------------------------------------------------------------------------------------------------------------------------------



ALTER PROCEDURE [dbo].[AddSalesOrder] (
	@SalesOrder [INSERTSALESORDERTABLE] readonly,
	@SODetails [INSERTSODETAILTABLE] readonly,
	@RemindDate DATE,
	@BankTrans [InsertBankTransTable] readonly,
	@SorderID int out,
	@Result int Out
	)
AS
DECLARE @SalesOrderId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY
	BEGIN TRANSACTION

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @SalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	INSERT INTO sorders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID,
		TSQty,
		PrevDue,
		1 FROM @SalesOrder
		)

	SET @SalesOrderId = Scope_identity()

	INSERT INTO SOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		Warranty
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.TAmount,
		SOD.PPDisPer,
		SOD.PPDisAmt,
		SOD.MrpRate,
		@SalesOrderId SOrderID,
		SOD.StockDetailId,
		SOD.PPOffer,
		(SOD.UnitPrice - SOD.PPDisAmt),
		STD.PRate,
		p.CompressorWarrentyMonth,
		p.PanelWarrentyMonth,
		p.MotorWarrentyMonth,
		p.SparePartsWarrentyMonth,
		p.ServiceWarrentyMonth,
		SOD.Warranty FROM @SODetails SOD INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailId INNER JOIN Products p
		ON STD.ProductID = p.ProductID WHERE P.ProductType = 1 OR p.ProductType = 3
		)

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue),
		reminddate = @RemindDate
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NOT NULL

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue)
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NULL

	--Stock Update 
	CREATE TABLE #tmpStock (
		ProductID INT,
		ColorID INT,
		GodownID INT,
		Qty DECIMAL(18, 2)
		)

	INSERT INTO #tmpStock (
		ProductID,
		ColorID,
		GodownID,
		Qty
		) (
		SELECT s.ProductID,
		s.ColorID,
		s.Compressor,
		SUM(s.Quantity) FROM @SODetails s 
		GROUP BY s.ProductId,
		s.ColorId,
		s.Compressor
		)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st
		ON st.ProductID = sod.ProductID AND st.ColorID = sod.ColorID AND st.GodownID = sod.GodownID

	--For barCode Product 
	UPDATE stockdetails
	SET stockdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN stockdetails
		ON stockdetails.sdetailid = s.stockdetailid
	INNER JOIN products
		ON stockdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	--*****************FIFO for Nobarcode************************** 
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @GodownID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity INT
	DECLARE @SQty INT
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.productid,
		colorid,
		s.Compressor,
		quantity,
		sorderdetailid
	FROM @SODetails s
	INNER JOIN products
		ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity != 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)

			IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity

				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					SOD.Warranty FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.Compressor=@GodownID AND SOD.colorid = @ColorID
					)

				SET @Quantity = 0
			END
			ELSE IF (@SQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @SQty

				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@SQty,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @SQty),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					SOD.Warranty FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					SOD.Warranty FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

	--For barCode Product SRVisit Status update 
	UPDATE srvproductdetails
	SET srvproductdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN srvproductdetails
		ON srvproductdetails.sdetailid = s.stockdetailid AND srvproductdetails.STATUS = 1
	INNER JOIN products
		ON srvproductdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3


	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID,
		TSQty,
		PrevDue,
		1,
		@SalesOrderId FROM @SalesOrder
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT CreatedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT CreateDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	SELECT @SorderID=@SalesOrderId,@Result=1;
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	SELECT @SorderID=0,@Result=0
END CATCH

---------------------------------------------------------------------------------------------------------------------------------


ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = s.TSQty,
		ActionStatus = ActionStatus + 1
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate,
		sod.Warranty = SD.Warranty
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service, Warranty) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth, SOD.Warranty FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)

	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId

	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	--For No barcode Stock Details out and SOrderDetails Insert
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @GodownID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity  decimal(18,2)
	DECLARE @StockQty decimal(18,2)
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.ProductId,
		colorid,
		Compressor,
		s.quantity,
		sorderdetailid
	FROM @SODetails s
    JOIN products ON products.productid = s.productid
	WHERE (products.ProductType = 2 and S.Status=3)

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE (@Quantity != 0)
		BEGIN
			SET @SDetailID = (
					SELECT Min(SDetailID)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @StockQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)
				------------------Debug-------------------------
				--INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
				--VALUES('ProductID: '+Convert(varchar(40),@ProductID)+'Stock Qty:'+Convert(varchar(40),@StockQty),'ColorID: '+Convert(varchar(40),@ColorID)+'GodownID: '+Convert(varchar(40),@GodownID),1,GETDATE())
				----------------------------
			IF (@StockQty > @Quantity)
			BEGIN
				SET @StockQty = @StockQty - @Quantity
			
				UPDATE stockdetails
				SET quantity = @StockQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					Warranty FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)

				SET @Quantity = 0
			END
			ELSE IF (@StockQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @StockQty
			
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@StockQty,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					SOD.Warranty FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID
				
				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service,
					Warranty
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth,
					SOD.Warranty FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

--New Products FIFO END




	--***************************************
	--*********SR visit Update***************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0
	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT so.InvoiceDate,
		so.invoiceno,
		so.customerid,
		so.vatpercentage,
		so.vatamount,
		so.grandtotal,
		so.TDPercentage,
		so.TDAmount,
		so.netdiscount,
		so.totalamount,
		so.paymentdue,
		so.RecAmount,
		so.adjamount,
		so.totaldue,
		so.STATUS,
		so.concernid,
		so.createdby,
		so.createdate,
		so.totaloffer,
		so.Remarks,
		so.TramsAndCondition,
		so.CardTypeSetupID,
		so.CardPaidAmount,
		so.DepositChargePercent,
		so.BankTransID,
		so.TSQty,
		so.PrevDue,
		so.ActionStatus,
		so.SOrderID
		FROM SOrders so
		INNER JOIN SOrders s on so.SOrderID = s.SOrderID AND s.SOrderID =  @SalesOrderId
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH

--------EMOBILECOMBINE----------
-------------Nahid--------------
----------19-08-2024------------

ALTER TABLE dbo.POrders ADD
	VATPercentage decimal(18, 2) NOT NULL CONSTRAINT DF_POrders_VATPercentage DEFAULT ((0.00)),
	VATAmount decimal(18, 2) NOT NULL CONSTRAINT DF_POrders_VATAmount DEFAULT ((0.00))
GO

---------------------------------------------------------------------------------------------------------------------------------


EXEC sys.sp_rename 'dbo.InsertPurchaseOrderTable', 'zInsertPurchaseOrderTable';
GO

CREATE TYPE [dbo].[InsertPurchaseOrderTable] AS TABLE(
	[OrderDate] [datetime] NULL,
	[ChallanNo] [varchar](150) NULL,
	[SupplierId] [int] NULL,
	[GrandTotal] [decimal](18, 2) NULL,
	[TDiscount] [decimal](18, 2) NULL,
	[TotalAmt] [decimal](18, 2) NULL,
	[RecAmt] [decimal](18, 2) NULL,
	[PaymentDue] [decimal](18, 2) NULL,
	[TotalDue] [decimal](18, 2) NULL,
	[AdjAmount] [decimal](18, 2) NULL,
	[Status] [int] NULL,
	[PPTDisAmt] [decimal](18, 2) NULL,
	[NetDiscount] [decimal](18, 2) NULL,
	[LabourCost] [decimal](18, 2) NULL,
	[ConcernId] [int] NULL,
	[CreateDate] [datetime] NULL,
	[CreatedBy] [int] NULL,
	[IsDamageOrder] [int] NULL,
	[Remarks] [varchar](150) NULL,
	[InvoiceNo] [varchar](150) NULL,
	[TPQty] [varchar](150) NULL,
	[Field1] [nvarchar](max) NULL,
	[Field2] [nvarchar](max) NULL,
	[Field3] [decimal](18, 2) NULL,
	[Field4] [decimal](18, 2) NULL,
	[Field5] [int] NULL,
	[Field6] [int] NULL,
	[VatPercentage] [decimal](18, 2) NULL,
	[VatAmount] [decimal](18, 2) NULL
)
GO

DECLARE @Name NVARCHAR(776);

DECLARE REF_CURSOR CURSOR FOR
SELECT referencing_schema_name + '.' + referencing_entity_name
FROM sys.dm_sql_referencing_entities('dbo.InsertPurchaseOrderTable', 'TYPE');

OPEN REF_CURSOR;

FETCH NEXT FROM REF_CURSOR INTO @Name;
WHILE (@@FETCH_STATUS = 0)
BEGIN
    EXEC sys.sp_refreshsqlmodule @name = @Name;
    FETCH NEXT FROM REF_CURSOR INTO @Name;
END;

CLOSE REF_CURSOR;
DEALLOCATE REF_CURSOR;
GO
DROP TYPE dbo.zInsertPurchaseOrderTable;
GO



---------------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[AddPurchaseOrder] (
	@PurchaseOrder [InsertPurchaseOrderTable] readonly
	,@PODetails [InsertPODetailTable] readonly
	,@POProductDetails [InsertPOProductDetailTable] readonly
	,@Stocks [InsertStockTable] readonly
	,@StockDetails [InsertStockDetailTable] readonly,
	@PorderID int out,
	@Result int Out
	)
AS
DECLARE @PurchaseOrderId INT
DECLARE @GrandTotal DECIMAL(18, 2)
		,@NetDiscount DECIMAL(18, 2)
		,@FlatDis DECIMAL(18, 2)
		,@Adjustment DECIMAL(18, 2)

--***************Product Type*****************
--ExistingBC = 1,
--NoBarcode = 2,
--AutoBC = 3
--***************Product Type*****************

BEGIN TRY
	BEGIN TRANSACTION

	INSERT INTO POrders (
		OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPDisAmt
		,NetDiscount
		,LaborCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,ActionStatus
		,VATPercentage,
		VATAmount
		) (
		SELECT OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPTDisAmt
		,NetDiscount
		,LabourCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,1,
		VatPercentage,
		VatAmount
		 FROM @PurchaseOrder
		)

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue + p.PaymentDue)
	FROM @PurchaseOrder p
	JOIN Suppliers ON Suppliers.SupplierID = p.SupplierId
	WHERE p.IsDamageOrder != 1

	SET @PurchaseOrderId = SCOPE_IDENTITY()
	SET @GrandTotal = ISNULL((
				SELECT GrandTotal
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @NetDiscount = ISNULL((
				SELECT NetDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @FlatDis = ISNULL((
				SELECT TDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
    SET @Adjustment = ISNULL((
				SELECT AdjAmount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)

	INSERT INTO PriceProtections (
		ProductID
		,ColorID
		,PrvPrice
		,ChangePrice
		,POrderID
		,ConcernID
		,SupplierID
		,PrvStockQty
		,PChangeDate
		) (
		SELECT stk.ProductId
		,stk.ColorId
		,stk.MRPPrice
		,stkt.MRPPrice
		,@PurchaseOrderId
		,stk.ConcernID
		,(
			SELECT SupplierId
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,stk.Quantity
		,GETDATE() FROM @Stocks stkt INNER JOIN Stocks stk ON stk.ProductID = stkt.ProductId
		AND stk.ColorID = stkt.ColorId WHERE stk.MRPPrice > stkt.MRPPrice
		)

	INSERT INTO POrderDetails (
		ProductID
		,ColorID
		,Quantity
		,UnitPrice
		,TAmount
		,PPDISPer
		,PPDISAmt
		,MRPRate
		,POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOFFER
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownID
		) (
		SELECT ProductId
		,ColorId
		,Quantity
		,UnitPrice
		,TAmount
		,PPDisPer
		,PPDisAmt
		,MrpRate
		,@PurchaseOrderId POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOffer
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownId FROM @PODetails
		)

	INSERT INTO POProductDetails (
		ProductID
		,ColorID
		,IMENO
		,POrderDetailID
		,DamagePOPDID
		) (
		SELECT POPD.ProductId
		,POPD.ColorId
		,POPD.IMENo
		,POD.POrderDetailID
		,DamagePOPDID FROM @POProductDetails POPD INNER JOIN POrderDetails POD ON POD.ProductID = POPD.ProductId
		AND POD.ColorID = POPD.ColorId
		AND POD.POrderID = @PurchaseOrderId
		)

	UPDATE POProductDetails
	SET IsDamageReplaced = 1
	FROM @POProductDetails dtPOPD
	JOIN POProductDetails POPD ON dtPOPD.DamagePOPDID = POPD.POPDID

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity + s.Quantity)
		,Stocks.MRPPrice = s.MRPPrice
		,LPPrice = s.LPPrice
		,ModifiedBy = s.CreatedBy
		,ModifiedDate = s.CreateDate
	FROM @Stocks s
	JOIN Stocks ON Stocks.StockID = s.StockID

	INSERT INTO Stocks (
		StockCode
		,EntryDate
		,Quantity
		,ProductID
		,ColorID
		,MRPPrice
		,LPPrice
		,ConcernID
		,CreatedBy
		,CreateDate
		,GodownID
		) (
		SELECT StockCode
		,EntryDate
		,Quantity
		,ProductId
		,ColorId
		,MRPPrice
		,LPPrice
		,ConcernId
		,CreatedBy
		,CreateDate
		,GodownId FROM @Stocks WHERE StockId IS NULL
		)

	--************For Nobarcode*****************
	INSERT INTO StockDetails (
		StockID
		,StockCode
		,ProductID
		,ColorID
		,POrderDetailID
		,IMENO
		,STATUS
		,PRate
		,SRate
		,CreditSRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,Quantity
		,GodownID
		) (
		SELECT stk.StockID
		,stkd.StockCode
		,stkd.ProductId
		,stkd.ColorId
		,POD.POrderDetailID
		,stkd.IMENo
		,stkd.STATUS
		,(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment))))
		,stkd.SalesRate
		,stkd.CreditSRate
		,POD.CRSalesRate12Month
		,POD.CRSalesRate3Month
		,POD.Quantity
		,stkd.GodownId FROM @StockDetails stkd INNER JOIN Stocks stk ON stk.ProductID = stkd.ProductId
		AND stk.ColorID = stkd.ColorID
		AND stk.GodownID = stkd.GodownId INNER JOIN POrderDetails POD ON POD.ProductID = stkd.ProductId
		AND POD.ColorID = stkd.ColorId
		AND POD.GodownID = stkd.GodownID
		AND POD.POrderID = @PurchaseOrderId INNER JOIN Products P ON P.ProductID = stk.ProductID WHERE P.ProductType = 2
		)

	--************For Nobarcode*****************
	--************For barcode*******************
	INSERT INTO StockDetails (
		StockID
		,StockCode
		,ProductID
		,ColorID
		,POrderDetailID
		,IMENO
		,STATUS
		,PRate
		,SRate
		,CreditSRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,Quantity
		,GodownID
		) (
		SELECT stk.StockID
		,stkd.StockCode
		,stkd.ProductId
		,stkd.ColorId
		,POD.POrderDetailID
		,stkd.IMENo
		,stkd.STATUS
		,(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment))))
		,stkd.SalesRate
		,stkd.CreditSRate
		,POD.CRSalesRate12Month
		,POD.CRSalesRate3Month
		,0
		,stkd.GodownId FROM @StockDetails stkd INNER JOIN Stocks stk ON stk.ProductID = stkd.ProductId
		AND stk.ColorID = stkd.ColorID
		AND stk.GodownID = stkd.GodownId INNER JOIN POrderDetails POD ON POD.ProductID = stkd.ProductId
		AND POD.ColorID = stkd.ColorId
		AND POD.GodownID = stkd.GodownId
		AND POD.POrderID = @PurchaseOrderId INNER JOIN Products P ON P.ProductID = stk.ProductID WHERE P.ProductType != 2
		)


	INSERT INTO TransactionPOrders (
		OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPDisAmt
		,NetDiscount
		,LaborCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,ActionStatus
		,POrderID
		) (
		SELECT OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPTDisAmt
		,NetDiscount
		,LabourCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,1
		,@PurchaseOrderId
		 FROM @PurchaseOrder
		)
	INSERT INTO TransactionPOrderDetails (
		ProductID
		,ColorID
		,Quantity
		,UnitPrice
		,TAmount
		,PPDISPer
		,PPDISAmt
		,MRPRate
		,POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOFFER
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownID
		,ActionStatus
		,ActionBy
		,ActionDate
		) (
		SELECT ProductId
		,ColorId
		,Quantity
		,UnitPrice
		,TAmount
		,PPDisPer
		,PPDisAmt
		,MrpRate
		,@PurchaseOrderId POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOffer
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownId
		,1
		,(
			SELECT CreatedBy
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,(
			SELECT CreateDate
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		FROM @PODetails
		)

	--************For barcode*******************
	COMMIT
	SELECT @PorderID=@PurchaseOrderId,@Result=1;
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		ROLLBACK

	SELECT @PorderID=0,@Result=0
	--RETURN 0;
END CATCH
-----------------For bKash--------------------------------------------
-----------------20-09-2024-------------------------------------------
ALTER TABLE dbo.ServiceChargeDetails ADD
	ConcernName nvarchar(500) NULL			

ALTER TABLE dbo.SMSPaymentMasterDetails ADD
	ConcernName nvarchar(500) NULL	
--------------------------------
-------------Nahid--------------
----------02-09-2024------------


ALTER PROCEDURE [dbo].[sp_ProductWiseBenefitReport] (
	@Fromdate DATETIME,
	@ToDate DATETIME,
	@ConcernID INT
	)
AS
WITH Final_table
AS (
	SELECT P.Code,
		P.ProductID,
		P.ProductName,
		SO.InvoiceDate AS 'SalesDate',
		C.Description AS 'CategoryName',
		STD.IMENO,
		(((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity AS 'SalesTotal',
		(SOD.PPDAmount + (((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity AS 'Discount',
		(SOD.PRate * SOD.Quantity) AS 'PurchaseTotal',
		((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity) - (SOD.PRate* SOD.Quantity) AS 'CommisionProfit',
		0.00 AS 'HireProfit',
		0.00 AS 'HireCollection',
		((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity) - (SOD.PRate * SOD.Quantity) AS 'TotalProfit'
	FROM SOrderDetails SOD
	INNER JOIN SOrders SO ON SOD.SOrderID = SO.SOrderID
	INNER JOIN StockDetails STD ON STD.SDetailID = SOD.SDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE SO.STATUS = 1 ANd SO.IsReplacement = 0 AND SO.InvoiceDate >= @Fromdate AND SO.InvoiceDate <= @ToDate AND SO.ConcernID = @ConcernID
	
	UNION ALL
	
	SELECT P.Code,
		P.ProductID,
		P.ProductName,
		SO.ReturnDate AS 'SalesDate',
		C.Description AS 'CategoryName',
		STD.IMENO,
		(SOD.UnitPrice* SOD.Quantity) * (-1) AS 'SalesTotal',
		0 AS 'Discount',
		(STD.PRate * SOD.Quantity) * ( -1) AS 'PurchaseTotal',
		((SOD.UnitPrice* SOD.Quantity) - (STD.PRate*SOD.Quantity ))* -1 AS 'CommisionProfit',
		0.00 AS 'HireProfit',
		0.00 AS 'HireCollection',
		((SOD.UnitPrice* SOD.Quantity) - (STD.PRate*SOD.Quantity ))* -1 AS 'TotalProfit'
	FROM ROrderDetails SOD
	INNER JOIN ROrders SO ON SOD.ROrderID = SO.ROrderID
	INNER JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE SO.ReturnDate >= @Fromdate AND SO.ReturnDate <= @ToDate AND SO.ConcernID = @ConcernID
	
	UNION ALL
	
	SELECT p.Code,
		P.ProductID,
		P.ProductName,
		CS.SalesDate AS 'SalesDate',
		C.Description AS 'CategoryName',
		STD.IMENO,
		(((CSP.UnitPrice+CSP.IntTotalAmt)-((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt)) * CSP.Quantity) AS 'SalesTotal',
		((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt) * CSP.Quantity AS 'Discount',
		STD.PRate * CSP.Quantity AS 'PurchaseTotal',
		(((CSP.UnitPrice)-((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt)) * CSP.Quantity) - (STD.PRate * CSP.Quantity) AS 'CommisionProfit',
		(CSP.IntTotalAmt * CSP.Quantity) AS 'HireProfit',
		0 AS 'HireCollection',
		0 AS 'TotalProfit'
	FROM CreditSaleDetails CSP
	INNER JOIN CreditSales CS ON CS.CreditSalesID = CSP.CreditSalesID
	INNER JOIN StockDetails STD ON STD.SDetailID = CSP.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.IsStatus=1
	
	UNION ALL
	
	SELECT P.Code,
		P.ProductID,
		P.ProductName,
		CS.SalesDate AS 'SalesDate',
		C.Description AS 'CategoryName',
		Std.IMENO,
		0 AS 'SalesTotal',
		0 AS 'Discount',
		0 AS 'PurchaseTotal',
		0 AS 'CommisionProfit',
		0 AS 'HireProfit',
		SUM(HireValue) AS 'HireCollection',
		SUM(HireValue) AS 'TotalProfit'
	FROM CreditSales CS
	INNER JOIN CreditSaleDetails CSP ON CSP.CreditSalesID = CS.CreditSalesID
	INNER JOIN CreditSalesSchedules CSD ON CSD.CreditSalesID = CS.CreditSalesID
	INNER JOIN StockDetails STD ON STD.SDetailID = CSP.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID AND CS.IsStatus=1
	GROUP BY P.Code,
		P.ProductID,
		P.ProductName,
		CS.SalesDate,
		C.Description,
		Std.IMENO
	)
SELECT Code,
	ProductID,
	ProductName,
	SalesDate,
	CategoryName,
	IMENO,
	sum(SalesTotal + Discount) AS 'SalesTotal',
	sum(Discount) AS 'Discount',
	sum(SalesTotal) AS 'NetSales',
	sum(PurchaseTotal) AS 'PurchaseTotal',
	sum(CommisionProfit) AS 'CommisionProfit',
	sum(HireProfit) AS 'HireProfit',
	sum(HireCollection) AS 'HireCollection',
	sum(CommisionProfit) + sum(HireCollection) AS 'TotalProfit'
FROM Final_table
GROUP BY Code,
	ProductID,
	ProductName,
	SalesDate,
	CategoryName,
	IMENO

-------------------------------------------------------------------------------------------------------------------------------


ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID
		--TSQty = @TQty
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)

	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId

	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)
	DECLARE @prevQty DECIMAL(18,2) = (SELECT ISNULL(SUM(s.Quantity), 0) FROM @SODetails s WHERE s.Status = 4)


	UPDATE st
	SET st.Quantity = ((st.Quantity - sod.Qty)+ @prevQty) ,ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	--For No barcode Stock Details out and SOrderDetails Insert
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @GodownID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity  decimal(18,2)
	DECLARE @StockQty decimal(18,2)
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.ProductId,
		colorid,
		Compressor,
		s.quantity,
		sorderdetailid
	FROM @SODetails s
    JOIN products ON products.productid = s.productid
	WHERE (products.ProductType = 2 and S.Status=3)

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE (@Quantity != 0)
		BEGIN
			SET @SDetailID = (
					SELECT Min(SDetailID)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @StockQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)
				------------------Debug-------------------------
				--INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
				--VALUES('ProductID: '+Convert(varchar(40),@ProductID)+'Stock Qty:'+Convert(varchar(40),@StockQty),'ColorID: '+Convert(varchar(40),@ColorID)+'GodownID: '+Convert(varchar(40),@GodownID),1,GETDATE())
				----------------------------
			IF (@StockQty > @Quantity)
			BEGIN
				SET @StockQty = @StockQty - @Quantity
			
				UPDATE stockdetails
				SET quantity = @StockQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)

				SET @Quantity = 0
			END
			ELSE IF (@StockQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @StockQty
			
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@StockQty,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID
				
				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

--New Products FIFO END




	--***************************************
	--*********SR visit Update***************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0


	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH
--------------------------------
-------------Mostafizur---------
----------27-08-2024------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER FUNCTION [dbo].[CheckProductStatusByPOId]
(
  @PurchaseOrderId int
)  
  RETURNS int
AS 
 BEGIN
	DECLARE	@Sold int
    
    SELECT @Sold = COUNT(*)
	FROM StockDetails
	JOIN POrderDetails POD ON POD.POrderDetailID = StockDetails.POrderDetailID 
	join POrders PO on POD.POrderID = PO.POrderID
	join Products p on POD.ProductID = p.ProductID
	WHERE p.ProductType <> 2 and POD.POrderID = @PurchaseOrderId AND StockDetails.Status = 2


	
	
	IF @Sold IS NULL OR @Sold = 0
		begin
			SET @Sold=0

			set @Sold =  (select ISNULL(COUNT(*), 0) FROM StockDetails sd
			JOIN POrderDetails POD ON POD.POrderDetailID = sd.POrderDetailID 
			join POrders PO on POD.POrderID = PO.POrderID
			JOIN SOrderDetails sod on sod.SDetailID = sd.SDetailID
			join Products p on POD.ProductID = p.ProductID
			WHERE p.ProductType = 2 and POD.POrderID = @PurchaseOrderId)


		end
	  

	  IF @Sold IS NULL OR @Sold = 0
		begin
			SET @Sold=0

			set @Sold =  (select ISNULL(COUNT(*), 0) FROM StockDetails sd
			JOIN POrderDetails POD ON POD.POrderDetailID = sd.POrderDetailID 
			join POrders PO on POD.POrderID = PO.POrderID
			JOIN CreditSaleDetails csod on csod.StockDetailID = sd.SDetailID
			join Products p on POD.ProductID = p.ProductID
			WHERE p.ProductType = 2 and POD.POrderID = @PurchaseOrderId)


		end
	  
	RETURN  @Sold
  END

  --select dbo.CheckProductStatusByPOId(76903)


--------------------------------
-------------Nahid--------------
----------15-08-2024------------

ALTER TABLE dbo.SystemInformations ADD
	IsEmobileCustomerView int NOT NULL CONSTRAINT DF_SystemInformations_IsEmobileCustomerView DEFAULT ((0))
GO

--------------------------------
-------------Nahid--------------
----------08-06-2024------------

ALTER TABLE dbo.SystemInformations ADD
	IsParentCateShow int NOT NULL CONSTRAINT DF_SystemInformations_IsParentCateShow DEFAULT ((1))
GO

---------------------------------------------------------------------------------------------------------------------------------
ALTER TABLE dbo.Products ADD
	RP decimal(18, 2) NOT NULL CONSTRAINT DF_Products_RP DEFAULT ((0))
GO

---------------------------------------------------------------------------------------------------------------------------------
ALTER TABLE dbo.SystemInformations ADD
	IsRPRateShow int NOT NULL CONSTRAINT DF_SystemInformations_IsRPRateShow DEFAULT ((0))
GO


---------------------------------------------------------------------------------------------------------------------------------

--------------------------------
-------------Rizve--------------
----------12-05-2024------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnbank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnbank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue',
		ISNULL(piv.InterestAmount, 0) as TInterestAmount,
		ISNULL(piv.CrInterestAmount, 0) as CrInterestAmount



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL



	--start here 



	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 1 
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND css.PaymentStatus = 'Paid'
	AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cc.TransactionType IN(1)
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (c.CreditDue + c.TotalDue  != 0)
	AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnbank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	 AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND c.CreditDue + c.TotalDue  != 0
	AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return],CashCollectionReturnbank, CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END


 --EXEC GetDatewiseCustomerDue 5213, 0, '2023-10-23'
GO



====================================================================================================

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseBankBalance]
(
		@concernId INT,
		@BankId INT,
		@asOnDate datetime,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.BankID,
		(
			(
				ISNULL(piv.FundIN, 0) 
				+ ISNULL(piv.AnotherFundIN, 0) + ISNULL(piv.OpeningDue, 0)
			)
			-
			(
				ISNULL(piv.FundOut, 0)
			)
		) 'TotalDue'

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningBalance, 0)) PrevSales, 'OpeningDue' Id, c.BankID FROM Banks c 
	WHERE c.ConcernID = @ConcernID
	AND (@BankId = 0 OR c.BankID = @BankId)
	GROUP BY c.BankID, c.BankName
	UNION ALL
	--start here 
	

	-- end here
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.BankID  FROM
	(
	SELECT bt.Amount PrevSales, 'FundIN' Id, bt.BankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.BankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN(1, 3, 9, 7, 10)
	AND (@BankId = 0 OR bt.BankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.BankID, bt.Amount, bt.TransactionNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.BankID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.AnotherBankID  FROM
	(
	SELECT bt.Amount PrevSales, 'AnotherFundIN' Id, bt.AnotherBankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.AnotherBankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN(5)
	AND (@BankId = 0 OR bt.AnotherBankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.AnotherBankID, bt.Amount, bt.TransactionNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.AnotherBankID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.BankID  FROM
	(
	SELECT bt.Amount PrevSales, 'FundOut' Id, bt.BankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.BankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN (2, 4, 8, 6, 5, 11)
	AND (@BankId = 0 OR bt.BankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.BankID, bt.Amount, bt.TransactionNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.BankID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			FundIN, FundOut, AnotherFundIN,OpeningDue

		)
	) piv
 END
GO


====================================================================================================



SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetCategorywiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT
		,@isOnlyDue BIT
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.HireReturn, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)+ ISNULL(piv.HireReturn, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue',
		ISNULL(piv.InterestAmount, 0) as TInterestAmount,
		ISNULL(piv.CrInterestAmount, 0) as CrInterestAmount



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL



	--start here 



	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	--UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0)) 
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0)) 
	AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'HireReturn', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	 AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return],CashCollectionReturnBank, CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount, HireReturn

		)
	) piv
 END


 --EXEC GetCategorywiseCustomerDue 5213, 0, 1
GO

--------------------------------
-------------Rizve--------------
----------08-05-2024------------


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[GetDatewiseCustomerDueRptRetail]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(			(
				
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 1
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 1
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return],CashCollectionReturnBank, CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END

----------------------------------------------------------------------

/****** Object:  StoredProcedure [dbo].[GetDatewiseCustomerDueRpt]    Script Date: 5/8/2024 2:28:13 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseCustomerDueRpt]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CashCollectionReturnBank, 0)
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturnBank,0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CashCollectionReturnBank, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount,CashCollectionReturnBank

		)
	) piv
 END
GO





-----------------------------------------------------------------------------------

/****** Object:  StoredProcedure [dbo].[GetDatewiseCustomerDueRptDealer]    Script Date: 5/8/2024 4:22:21 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseCustomerDueRptDealer]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0)+ ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 2
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 2
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID



	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn, CashCollectionReturnBank,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
GO





---------------------------------------------------------------------------------------------

/****** Object:  StoredProcedure [dbo].[GetDatewiseCustomerDueRptHire]    Script Date: 5/8/2024 4:56:11 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseCustomerDueRptHire]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 3
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 3
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionReturnBank,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
GO







------------------------------------------------------------------------------------------




/****** Object:  StoredProcedure [dbo].[GetDatewiseCustomerDueRptBranch]    Script Date: 5/8/2024 4:59:48 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseCustomerDueRptBranch]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 4
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 4
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
GO


-------------Nahid--------------
----------04-05-2024------------
--------------------------------

CREATE PROC [dbo].[UpdateTotalDueCustomerPaymentReturn]
(
	@CusId int,
	@BankDepositId int,
	@BankWithdrawId int,
	@CollectionAmount decimal(18,2)
)
  
AS 

 IF(@CusId>0)
BEGIN
	UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + @CollectionAmount)
	where CustomerID=@CusId
END


 IF(@BankDepositId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount + @CollectionAmount)
	where BankID=@BankDepositId
END
  
 IF(@BankWithdrawId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount - @CollectionAmount)
	where BankID=@BankWithdrawId
END

RETURN
----------------------------------------------------------------------------------------------------------------------------------

ALTER PROC [dbo].[sp_BankTransReportNew]
(
@FromDate datetime,
@ToDate datetime,
@BankID int,
@ConcernId INT
)
as

Create table #temp (
ConcernID int,ConcernName varchar(250),BankID int,BankName varchar(250),AccountNO varchar(250),
AccountName varchar(250),TransDate DATETIME,TransactionNo varchar(250),ChecqueNo varchar(250),Amount decimal(18,2),
FromTOAccountNo varchar(250),Remarks varchar(250),TransType varchar(250))

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5,
--Bank Expense =6,
--Bank Income = 7,
--LiaPay = 8,
--LiaRec =9,
--Return From Supplier = 10

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Deposit' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=1 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Withdraw' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=2  and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
c.Name as FromTOAccountNo,bt.Remarks,'Cash Collection' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Customers c on bt.CustomerID = c.CustomerID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=3 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
sup.Name as FromTOAccountNo,bt.Remarks,'Cash Delivery' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Suppliers sup on bt.SupplierID = sup.SupplierID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=4 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
ab.AccountName+' ('+ab.AccountNo+')' as FromTOAccountNo,bt.Remarks,'Fund In' from Banks b 
join BankTransactions bt on b.BankID = bt.AnotherBankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Banks ab on bt.BankID = ab.BankID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=5 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
ab.AccountName+' ('+ab.AccountNo+')' as FromTOAccountNo,bt.Remarks,'Fund Out' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Banks ab on bt.AnotherBankID = ab.BankID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=5 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Bank Expense' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=6 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Bank Income' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=7 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Liability Pay' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=8 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Liability Receive' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=9 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
sup.Name as FromTOAccountNo,bt.Remarks,'Retrun from Supplier' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Suppliers sup on bt.SupplierID = sup.SupplierID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=10 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)



insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
c.Name as FromTOAccountNo,bt.Remarks,'Customer Collection Return' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Customers c on bt.CustomerID = c.CustomerID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=11 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

select * from #temp order by TransDate desc

---------------------------------------------------------------------------------------------------------------------------------------

-------------Nahid--------------
----------02-05-2024------------
--------------------------------
CREATE PROC [dbo].[UpdateTotalDueWhenEditReturnType]
(
	@CusId int,
	@SupId int,
	@CashCollectionID int,
	@NewCollectionAmount DECIMAL(18,2)
)
  
AS 
Declare @Amount decimal
Declare @PreviousCustomerID int,
		@TransactionType INT

BEGIN TRY
BEGIN TRANSACTION

IF(@CusId>0)
BEGIN
    Select @Amount=(Amount+AdjustAmt) from CashCollections where CashCollectionID=@CashCollectionID
	Select @PreviousCustomerID=CustomerID from CashCollections where CashCollectionID=@CashCollectionID
	SELECT @TransactionType = TransactionType from CashCollections where CashCollectionID=@CashCollectionID
	BEGIN
		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue - @Amount)
		where CustomerID=@PreviousCustomerID



		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + @NewCollectionAmount)
		where CustomerID=@CusId
	END

	
END
ELSE IF(@SupId>0)
BEGIN
    Select @Amount=(Amount+AdjustAmt) from CashCollections where CashCollectionID=@CashCollectionID
    Select @PreviousCustomerID=SupplierID from CashCollections where CashCollectionID=@CashCollectionID
	SELECT @TransactionType = TransactionType from CashCollections where CashCollectionID=@CashCollectionID

	BEGIN
		UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - @Amount)
		where SupplierID=@PreviousCustomerID



		UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue + @NewCollectionAmount)
		where SupplierID=@SupId
	END
END

COMMIT

RETURN 1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		RETURN 0;
END CATCH

--------------------------------
----------Mostafizur------------
----------10-08-2024------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[GetDatewiseCustomerDueRptHire]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',


			CAST((
			(
			ISNULL(piv.CashCollectionReturn, 0) 
			)
		) AS  DECIMAL(18,2)) 'CollectionReturnAmt',


		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 3
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 3
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionReturnBank,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END

--------------------------------
----------Mostafizur------------
----------10-08-2024------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[GetDatewiseCustomerDueRptDealer]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0)  + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',

				CAST((
			(				
				 ISNULL(piv.CashCollectionReturn, 0) 
			)
		) AS  DECIMAL(18,2)) 'CollectionReturnAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0)  + ISNULL(piv.CashCollectionReturnBank, 0)+ ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 2
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 2
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID



	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn, CashCollectionReturnBank,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END

--------------------------------
----------Mostafizur------------
----------10-08-2024------------


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[GetDatewiseCustomerDueRptRetail]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0)  + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',



			CAST((
			(
				 ISNULL(piv.CashCollectionReturn, 0) 
			)
		) AS  DECIMAL(18,2)) 'CollectionReturnAmt',


		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0)  + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',


		CAST((
			(			
				ISNULL(piv.CashCollectionReturn, 0)
			)
		) AS DECIMAL(18,2)) 'TotalCollectionReturn',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(			(
				
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'




	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 1 and cc.TransactionType !=3
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 1
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1 
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1 and cc.TransactionType = 3
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return],CashCollectionReturnBank, CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END


--------------------------------
----------Mostafizur------------
----------10-08-2024------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[GetDatewiseCustomerDueRptRetail]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',


			CAST((
			(
				 ISNULL(piv.CashCollectionReturn, 0) 
			)
		) AS  DECIMAL(18,2)) 'CollectionReturnAmt',


		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0)  + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',


		CAST((
			(			
				ISNULL(piv.CashCollectionReturn, 0)
			)
		) AS DECIMAL(18,2)) 'TotalCollectionReturn',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(			(
				
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'




	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 1 and cc.TransactionType !=3
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 1
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1 
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1 and cc.TransactionType = 3
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return],CashCollectionReturnBank, CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END

--------------------------------
----------Mostafizur------------
----------10-08-2024------------


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[GetDatewiseCustomerDueRpt]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0)  + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CashCollectionReturnBank, 0)
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',

				CAST((
			(			
			 ISNULL(piv.CashCollectionReturn, 0) 
			 )
			
		) AS  DECIMAL(18,2)) 'CollectionReturnAmt',


		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturnBank,0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',


		CAST((
			(
				(
					 ISNULL(piv.CashCollectionReturn, 0)
				)	
			) 
		) AS DECIMAL(18,2)) 'TotalCollectionReturn',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CashCollectionReturnBank, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount,CashCollectionReturnBank

		)
	) piv
 END



--------------------------------
----------Mostafizur------------
----------10-08-2024------------

--SET ANSI_NULLS ON
--GO
--SET QUOTED_IDENTIFIER ON
--GO
--ALTER PROCEDURE [dbo].[sp_ProductWiseBenefitReport] (
--	@Fromdate DATETIME,
--	@ToDate DATETIME,
--	@ConcernID INT
--	)
--AS
--WITH Final_table
--AS (
--	SELECT P.Code,
--		P.ProductID,
--		P.ProductName,
--		SO.InvoiceDate AS 'SalesDate',
--		C.Description AS 'CategoryName',
--		STD.IMENO,
--		(((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity AS 'SalesTotal',
--		(SOD.PPDAmount + (((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity AS 'Discount',
--		(SOD.PRate * SOD.Quantity) AS 'PurchaseTotal',
--		((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity) - (SOD.PRate* SOD.Quantity) AS 'CommisionProfit',
--		0.00 AS 'HireProfit',
--		0.00 AS 'HireCollection',
--		((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity) - (SOD.PRate * SOD.Quantity) AS 'TotalProfit'
--	FROM SOrderDetails SOD
--	INNER JOIN SOrders SO ON SOD.SOrderID = SO.SOrderID
--	INNER JOIN StockDetails STD ON STD.SDetailID = SOD.SDetailID
--	INNER JOIN Products P ON P.ProductID = STD.ProductID
--	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
--	WHERE SO.STATUS = 1 AND SO.InvoiceDate >= @Fromdate AND SO.InvoiceDate <= @ToDate AND SO.ConcernID = @ConcernID
	
--	UNION ALL
	
--	SELECT P.Code,
--		P.ProductID,
--		P.ProductName,
--		SO.ReturnDate AS 'SalesDate',
--		C.Description AS 'CategoryName',
--		STD.IMENO,
--		(SOD.UnitPrice* SOD.Quantity) * (-1) AS 'SalesTotal',
--		0 AS 'Discount',
--		(STD.PRate * SOD.Quantity) * ( -1) AS 'PurchaseTotal',
--		((SOD.UnitPrice* SOD.Quantity) - (STD.PRate*SOD.Quantity ))* -1 AS 'CommisionProfit',
--		0.00 AS 'HireProfit',
--		0.00 AS 'HireCollection',
--		((SOD.UnitPrice* SOD.Quantity) - (STD.PRate*SOD.Quantity ))* -1 AS 'TotalProfit'
--	FROM ROrderDetails SOD
--	INNER JOIN ROrders SO ON SOD.ROrderID = SO.ROrderID
--	INNER JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailID
--	INNER JOIN Products P ON P.ProductID = STD.ProductID
--	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
--	WHERE SO.ReturnDate >= @Fromdate AND SO.ReturnDate <= @ToDate AND SO.ConcernID = @ConcernID
	
--	UNION ALL
	
--	SELECT p.Code,
--		P.ProductID,
--		P.ProductName,
--		CS.SalesDate AS 'SalesDate',
--		C.Description AS 'CategoryName',
--		STD.IMENO,
--		(((CSP.UnitPrice+CSP.IntTotalAmt)-((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt)) * CSP.Quantity) AS 'SalesTotal',
--		((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt) * CSP.Quantity AS 'Discount',
--		STD.PRate * CSP.Quantity AS 'PurchaseTotal',
--		(((CSP.UnitPrice)-((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt)) * CSP.Quantity) - (STD.PRate * CSP.Quantity) AS 'CommisionProfit',
--		(CSP.IntTotalAmt * CSP.Quantity) AS 'HireProfit',
--		0 AS 'HireCollection',
--		0 AS 'TotalProfit'
--	FROM CreditSaleDetails CSP
--	INNER JOIN CreditSales CS ON CS.CreditSalesID = CSP.CreditSalesID
--	INNER JOIN StockDetails STD ON STD.SDetailID = CSP.StockDetailID
--	INNER JOIN Products P ON P.ProductID = STD.ProductID
--	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
--	WHERE CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.IsStatus=1
	
--	UNION ALL
	
--	SELECT P.Code,
--		P.ProductID,
--		P.ProductName,
--		CS.SalesDate AS 'SalesDate',
--		C.Description AS 'CategoryName',
--		Std.IMENO,
--		0 AS 'SalesTotal',
--		0 AS 'Discount',
--		0 AS 'PurchaseTotal',
--		0 AS 'CommisionProfit',
--		0 AS 'HireProfit',
--		SUM(HireValue) AS 'HireCollection',
--		SUM(HireValue) AS 'TotalProfit'
--	FROM CreditSales CS
--	INNER JOIN CreditSaleDetails CSP ON CSP.CreditSalesID = CS.CreditSalesID
--	INNER JOIN CreditSalesSchedules CSD ON CSD.CreditSalesID = CS.CreditSalesID
--	INNER JOIN StockDetails STD ON STD.SDetailID = CSP.StockDetailID
--	INNER JOIN Products P ON P.ProductID = STD.ProductID
--	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
--	WHERE CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID AND CS.IsStatus=1
--	GROUP BY P.Code,
--		P.ProductID,
--		P.ProductName,
--		CS.SalesDate,
--		C.Description,
--		Std.IMENO
--	)
--SELECT Code,
--	ProductID,
--	ProductName,
--	SalesDate,
--	CategoryName,
--	IMENO,
--	sum(SalesTotal + Discount) AS 'SalesTotal',
--	sum(Discount) AS 'Discount',
--	sum(SalesTotal) AS 'NetSales',
--	sum(PurchaseTotal) AS 'PurchaseTotal',
--	sum(CommisionProfit) AS 'CommisionProfit',
--	sum(HireProfit) AS 'HireProfit',
--	sum(HireCollection) AS 'HireCollection',
--	sum(CommisionProfit) + sum(HireCollection) AS 'TotalProfit'
--FROM Final_table
--GROUP BY Code,
--	ProductID,
--	ProductName,
--	SalesDate,
--	CategoryName,
--	IMENO





SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[sp_ProductWiseBenefitReport] (
    @Fromdate DATETIME,
    @ToDate DATETIME,
    @ConcernID INT
)
AS
WITH Final_table
AS (
    SELECT P.Code,
        P.ProductID,
        P.ProductName,
        SO.InvoiceDate AS 'SalesDate',
        C.Description AS 'CategoryName',
        STD.IMENO,
        COALESCE((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / NULLIF((SO.GrandTotal - SO.NetDiscount + SO.TDAmount), 0)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity, 0) AS 'SalesTotal',
        COALESCE((SOD.PPDAmount + (((SO.TDAmount + SO.AdjAmount) / NULLIF((SO.GrandTotal - SO.NetDiscount + SO.TDAmount), 0)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity, 0) AS 'Discount',
        COALESCE((SOD.PRate * SOD.Quantity), 0) AS 'PurchaseTotal',
        COALESCE(((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / NULLIF((SO.GrandTotal - SO.NetDiscount + SO.TDAmount), 0)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity) - (SOD.PRate * SOD.Quantity), 0) AS 'CommisionProfit',
        0.00 AS 'HireProfit',
        0.00 AS 'HireCollection',
        COALESCE(((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / NULLIF((SO.GrandTotal - SO.NetDiscount + SO.TDAmount), 0)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity) - (SOD.PRate * SOD.Quantity), 0) AS 'TotalProfit'
    FROM SOrderDetails SOD
    INNER JOIN SOrders SO ON SOD.SOrderID = SO.SOrderID
    INNER JOIN StockDetails STD ON STD.SDetailID = SOD.SDetailID
    INNER JOIN Products P ON P.ProductID = STD.ProductID
    INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
    WHERE SO.STATUS = 1 AND SO.InvoiceDate >= @Fromdate AND SO.InvoiceDate <= @ToDate AND SO.ConcernID = @ConcernID
    
    UNION ALL
    
    SELECT P.Code,
        P.ProductID,
        P.ProductName,
        SO.ReturnDate AS 'SalesDate',
        C.Description AS 'CategoryName',
        STD.IMENO,
        COALESCE((SOD.UnitPrice * SOD.Quantity) * (-1), 0) AS 'SalesTotal',
        0 AS 'Discount',
        COALESCE((STD.PRate * SOD.Quantity) * (-1), 0) AS 'PurchaseTotal',
        COALESCE(((SOD.UnitPrice * SOD.Quantity) - (STD.PRate * SOD.Quantity)) * -1, 0) AS 'CommisionProfit',
        0.00 AS 'HireProfit',
        0.00 AS 'HireCollection',
        COALESCE(((SOD.UnitPrice * SOD.Quantity) - (STD.PRate * SOD.Quantity)) * -1, 0) AS 'TotalProfit'
    FROM ROrderDetails SOD
    INNER JOIN ROrders SO ON SOD.ROrderID = SO.ROrderID
    INNER JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailID
    INNER JOIN Products P ON P.ProductID = STD.ProductID
    INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
    WHERE SO.ReturnDate >= @Fromdate AND SO.ReturnDate <= @ToDate AND SO.ConcernID = @ConcernID
    
    UNION ALL
    
    SELECT P.Code,
        P.ProductID,
        P.ProductName,
        CS.SalesDate AS 'SalesDate',
        C.Description AS 'CategoryName',
        STD.IMENO,
        COALESCE((((CSP.UnitPrice + CSP.IntTotalAmt) - ((LastPayAdjAmt + Discount) * (CSP.UnitPrice + CSP.IntTotalAmt) / NULLIF(TSalesAmt, 0))) * CSP.Quantity), 0) AS 'SalesTotal',
        COALESCE(((LastPayAdjAmt + Discount) * (CSP.UnitPrice + CSP.IntTotalAmt) / NULLIF(TSalesAmt, 0)) * CSP.Quantity, 0) AS 'Discount',
        COALESCE((STD.PRate * CSP.Quantity), 0) AS 'PurchaseTotal',
        COALESCE((((CSP.UnitPrice) - ((LastPayAdjAmt + Discount) * (CSP.UnitPrice + CSP.IntTotalAmt) / NULLIF(TSalesAmt, 0))) * CSP.Quantity) - (STD.PRate * CSP.Quantity), 0) AS 'CommisionProfit',
        COALESCE((CSP.IntTotalAmt * CSP.Quantity), 0) AS 'HireProfit',
        0 AS 'HireCollection',
        0 AS 'TotalProfit'
    FROM CreditSaleDetails CSP
    INNER JOIN CreditSales CS ON CS.CreditSalesID = CSP.CreditSalesID
    INNER JOIN StockDetails STD ON STD.SDetailID = CSP.StockDetailID
    INNER JOIN Products P ON P.ProductID = STD.ProductID
    INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
    WHERE CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.IsStatus = 1
    
    UNION ALL
    
    SELECT P.Code,
        P.ProductID,
        P.ProductName,
        CS.SalesDate AS 'SalesDate',
        C.Description AS 'CategoryName',
        Std.IMENO,
        0 AS 'SalesTotal',
        0 AS 'Discount',
        0 AS 'PurchaseTotal',
        0 AS 'CommisionProfit',
        0 AS 'HireProfit',
        COALESCE(SUM(HireValue), 0) AS 'HireCollection',
        COALESCE(SUM(HireValue), 0) AS 'TotalProfit'
    FROM CreditSales CS
    INNER JOIN CreditSaleDetails CSP ON CSP.CreditSalesID = CS.CreditSalesID
    INNER JOIN CreditSalesSchedules CSD ON CSD.CreditSalesID = CS.CreditSalesID
    INNER JOIN StockDetails STD ON STD.SDetailID = CSP.StockDetailID
    INNER JOIN Products P ON P.ProductID = STD.ProductID
    INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
    WHERE CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID AND CS.IsStatus = 1
    GROUP BY P.Code,
        P.ProductID,
        P.ProductName,
        CS.SalesDate,
        C.Description,
        Std.IMENO
)
SELECT Code,
    ProductID,
    ProductName,
    SalesDate,
    CategoryName,
    IMENO,
    COALESCE(SUM(SalesTotal + Discount), 0) AS 'SalesTotal',
    COALESCE(SUM(Discount), 0) AS 'Discount',
    COALESCE(SUM(SalesTotal), 0) AS 'NetSales',
    COALESCE(SUM(PurchaseTotal), 0) AS 'PurchaseTotal',
    COALESCE(SUM(CommisionProfit), 0) AS 'CommisionProfit',
    COALESCE(SUM(HireProfit), 0) AS 'HireProfit',
    COALESCE(SUM(HireCollection), 0) AS 'HireCollection',
    COALESCE(SUM(CommisionProfit) + SUM(HireCollection), 0) AS 'TotalProfit'
FROM Final_table
GROUP BY Code,
    ProductID,
    ProductName,
    SalesDate,
    CategoryName,
    IMENO


--------------------------------
-------------Rizve--------------
----------8-08-2024------------
ALTER PROC [dbo].[sp_AddReplacementOrder]
(
    @SalesOrder [InsertReplaceOrderTable] readonly,
    @SODetails [InsertRODetailTable] readonly
)
AS
DECLARE @SalesOrderId INT;
DECLARE @ProductType INT;
DECLARE @Quantity DECIMAL(18, 2);
DECLARE @StockDetailId INT;

BEGIN TRY
    BEGIN TRANSACTION;

    -- Insert into SOrders
    INSERT INTO SOrders
    (
        InvoiceDate, InvoiceNo, CustomerID, VATPercentage, VATAmount, GrandTotal, TDPercentage, TDAmount, NetDiscount,
        TotalAmount, PaymentDue, RecAmount, AdjAmount, TotalDue, Status, ConcernID, CreatedBy, CreateDate, TotalOffer, IsReplacement
    )
    SELECT InvoiceDate, InvoiceNo, CustomerID, VATPercentage, VATAmount, GrandTotal, TDiscountPercentage, TDiscountAmount, NetDiscount,
           TotalAmount, PaymentDue, RecAmt, AdjAmount, TotalDue, Status, ConcernID, CreatedBy, CreateDate, TotalOffer, IsReplacement
    FROM @SalesOrder;

    -- Update Customer's TotalDue
    UPDATE Customers
    SET Customers.TotalDue = (Customers.TotalDue + s.TotalDue)
    FROM @SalesOrder s
    JOIN Customers ON Customers.CustomerID = s.CustomerID;

    -- Capture the new SalesOrderId
    SET @SalesOrderId = SCOPE_IDENTITY();

    -- Update SOrderDetails with the new values
    UPDATE SOrderDetails
    SET RStockDetailId = s.RStockDetailId,
        RepOrderID = @SalesOrderId,
        RepUnitPrice = s.UnitPrice,
        Remarks = s.Remarks,
        RQuantity = (RQuantity + s.Quantity),
        ReplaceProductType = s.IsDamage
    FROM @SODetails s
    JOIN SOrderDetails SOD ON SOD.SDetailID = s.StockDetailId
    JOIN SOrders SO ON SOD.SOrderID = SO.SOrderID
    WHERE SOD.SDetailId IN (SELECT StockDetailId FROM @SODetails)
      AND SO.Status != 4
      AND SOD.IsProductReturn != 1;

    -- Insert new SOrderDetails
    INSERT INTO SOrderDetails
    (
        ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, PPDAmount, MPRate, SOrderID, SDetailID, PPOffer, Remarks
    )
    SELECT ProductId, Quantity, UnitPrice, TAmount, PPDisPer, PPDisAmt, MrpRate, @SalesOrderId SOrderID, RStockDetailId, PPOffer, Remarks
    FROM @SODetails;

    -- Stock Decrease for New Product
    UPDATE Stocks
    SET Stocks.Quantity = (Stocks.Quantity - s.Quantity)
    FROM @SODetails s
    JOIN Stocks ON Stocks.ProductID = s.ProductId AND Stocks.ColorID = s.ColorId;

    --**************************************************************
    --*********************not damage*******************************
    UPDATE Stocks
    SET Stocks.Quantity = (Stocks.Quantity + s.Quantity)
    FROM @SODetails s
    JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
    JOIN Stocks ON Stocks.StockID = StockDetails.StockID
    WHERE s.IsDamage = 2;

    UPDATE StockDetails
    SET StockDetails.Quantity = (StockDetails.Quantity + s.Quantity), StockDetails.Status = 1
    FROM @SODetails s
    JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
    WHERE s.IsDamage = 2;

    --**************************************************************
    --*********************damage***********************************
    -- Cursor to handle damaged products
    DECLARE cur_damaged CURSOR LOCAL FOR
    SELECT p.ProductType, s.Quantity, s.StockDetailId
    FROM @SODetails s
    JOIN Products p ON s.ProductId = p.ProductID
    WHERE s.IsDamage = 1;

    OPEN cur_damaged;

    FETCH NEXT FROM cur_damaged INTO @ProductType, @Quantity, @StockDetailId;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        IF (@ProductType = 2) -- No Barcode Product
        BEGIN
            -- Insert a new row with Status = 4 for the damaged product
            INSERT INTO StockDetails
            (
                StockCode, ProductID, IMENO, StockID, Status, ColorID, POrderDetailID, PRate, SRate, CreditSRate, 
                CRSalesRate12Month, CRSalesRate3Month, Quantity, GodownID, TransferDetailID, UsedStockStatus, UsedSaleRate, UsedPurchaseRate
            )
            SELECT StockCode, ProductID, IMENO, StockID, 4, ColorID, POrderDetailID, PRate, SRate, CreditSRate, 
                   CRSalesRate12Month, CRSalesRate3Month, @Quantity, GodownID, TransferDetailID, UsedStockStatus, UsedSaleRate, UsedPurchaseRate
            FROM StockDetails
            WHERE SDetailID = @StockDetailId;

           
        END
        ELSE
        BEGIN
            -- For other product types, just update the status to 4
            UPDATE StockDetails
            SET StockDetails.Status = 4
            WHERE StockDetails.SDetailID = @StockDetailId;
        END;

        FETCH NEXT FROM cur_damaged INTO @ProductType, @Quantity, @StockDetailId;
    END;

    -- Close and deallocate cursor
    CLOSE cur_damaged;
    DEALLOCATE cur_damaged;

    -- Update the status in SRVProductDetails for damaged products
    UPDATE SRVProductDetails
    SET SRVProductDetails.Status = 2
    FROM @SODetails s
    JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.RStockDetailId
    WHERE SRVProductDetails.Status = 1;

    COMMIT

    RETURN 1;

END TRY
BEGIN CATCH
    IF @@TRANCOUNT > 0
        ROLLBACK

    RETURN 0;
END CATCH
GO



--------------------------------
-------------Rizve--------------
----------30-07-2024------------

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[AddPurchaseOrder] (
	@PurchaseOrder [InsertPurchaseOrderTable] readonly
	,@PODetails [InsertPODetailTable] readonly
	,@POProductDetails [InsertPOProductDetailTable] readonly
	,@Stocks [InsertStockTable] readonly
	,@StockDetails [InsertStockDetailTable] readonly,
	@PorderID int out,
	@Result int Out
	)
AS
DECLARE @PurchaseOrderId INT
DECLARE @GrandTotal DECIMAL(18, 2)
		,@NetDiscount DECIMAL(18, 2)
		,@FlatDis DECIMAL(18, 2)
		,@Adjustment DECIMAL(18, 2)

--***************Product Type*****************
--ExistingBC = 1,
--NoBarcode = 2,
--AutoBC = 3
--***************Product Type*****************

BEGIN TRY
	BEGIN TRANSACTION

	INSERT INTO POrders (
		OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPDisAmt
		,NetDiscount
		,LaborCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		) (
		SELECT OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPTDisAmt
		,NetDiscount
		,LabourCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		 FROM @PurchaseOrder
		)

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue + p.PaymentDue)
	FROM @PurchaseOrder p
	JOIN Suppliers ON Suppliers.SupplierID = p.SupplierId
	WHERE p.IsDamageOrder != 1

	SET @PurchaseOrderId = SCOPE_IDENTITY()
	SET @GrandTotal = ISNULL((
				SELECT GrandTotal
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @NetDiscount = ISNULL((
				SELECT NetDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @FlatDis = ISNULL((
				SELECT TDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
    SET @Adjustment = ISNULL((
				SELECT AdjAmount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)

	INSERT INTO PriceProtections (
		ProductID
		,ColorID
		,PrvPrice
		,ChangePrice
		,POrderID
		,ConcernID
		,SupplierID
		,PrvStockQty
		,PChangeDate
		) (
		SELECT stk.ProductId
		,stk.ColorId
		,stk.MRPPrice
		,stkt.MRPPrice
		,@PurchaseOrderId
		,stk.ConcernID
		,(
			SELECT SupplierId
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,stk.Quantity
		,GETDATE() FROM @Stocks stkt INNER JOIN Stocks stk ON stk.ProductID = stkt.ProductId
		AND stk.ColorID = stkt.ColorId WHERE stk.MRPPrice > stkt.MRPPrice
		)

	INSERT INTO POrderDetails (
		ProductID
		,ColorID
		,Quantity
		,UnitPrice
		,TAmount
		,PPDISPer
		,PPDISAmt
		,MRPRate
		,POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOFFER
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownID
		) (
		SELECT ProductId
		,ColorId
		,Quantity
		,UnitPrice
		,TAmount
		,PPDisPer
		,PPDisAmt
		,MrpRate
		,@PurchaseOrderId POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOffer
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownId FROM @PODetails
		)

	INSERT INTO POProductDetails (
		ProductID
		,ColorID
		,IMENO
		,POrderDetailID
		,DamagePOPDID
		) (
		SELECT POPD.ProductId
		,POPD.ColorId
		,POPD.IMENo
		,POD.POrderDetailID
		,DamagePOPDID FROM @POProductDetails POPD INNER JOIN POrderDetails POD ON POD.ProductID = POPD.ProductId
		AND POD.ColorID = POPD.ColorId
		AND POD.POrderID = @PurchaseOrderId
		)

	UPDATE POProductDetails
	SET IsDamageReplaced = 1
	FROM @POProductDetails dtPOPD
	JOIN POProductDetails POPD ON dtPOPD.DamagePOPDID = POPD.POPDID

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity + s.Quantity)
		,Stocks.MRPPrice = s.MRPPrice
		,LPPrice = s.LPPrice
		,ModifiedBy = s.CreatedBy
		,ModifiedDate = s.CreateDate
	FROM @Stocks s
	JOIN Stocks ON Stocks.StockID = s.StockID

	INSERT INTO Stocks (
		StockCode
		,EntryDate
		,Quantity
		,ProductID
		,ColorID
		,MRPPrice
		,LPPrice
		,ConcernID
		,CreatedBy
		,CreateDate
		,GodownID
		) (
		SELECT StockCode
		,EntryDate
		,Quantity
		,ProductId
		,ColorId
		,MRPPrice
		,LPPrice
		,ConcernId
		,CreatedBy
		,CreateDate
		,GodownId FROM @Stocks WHERE StockId IS NULL
		)

	--************For Nobarcode*****************
	--INSERT INTO StockDetails (
	--	StockID
	--	,StockCode
	--	,ProductID
	--	,ColorID
	--	,POrderDetailID
	--	,IMENO
	--	,STATUS
	--	,PRate
	--	,SRate
	--	,CreditSRate
	--	,CRSalesRate12Month
	--	,CRSalesRate3Month
	--	,Quantity
	--	,GodownID
	--	) (
	--	SELECT stk.StockID
	--	,stkd.StockCode
	--	,stkd.ProductId
	--	,stkd.ColorId
	--	,POD.POrderDetailID
	--	,stkd.IMENo
	--	,stkd.STATUS
	--	,(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment))))
	--	,stkd.SalesRate
	--	,stkd.CreditSRate
	--	,POD.CRSalesRate12Month
	--	,POD.CRSalesRate3Month
	--	,POD.Quantity
	--	,stkd.GodownId FROM @StockDetails stkd INNER JOIN Stocks stk ON stk.ProductID = stkd.ProductId
	--	AND stk.ColorID = stkd.ColorID
	--	AND stk.GodownID = stkd.GodownId INNER JOIN POrderDetails POD ON POD.ProductID = stkd.ProductId
	--	AND POD.ColorID = stkd.ColorId
	--	AND POD.GodownID = stkd.GodownID
	--	AND POD.POrderID = @PurchaseOrderId INNER JOIN Products P ON P.ProductID = stk.ProductID WHERE P.ProductType = 2
	--	)

INSERT INTO StockDetails (
    StockID,
    StockCode,
    ProductID,
    ColorID,
    POrderDetailID,
    IMENO,
    STATUS,
    PRate,
    SRate,
    CreditSRate,
    CRSalesRate12Month,
    CRSalesRate3Month,
    Quantity,
    GodownID
)
SELECT 
    stk.StockID,
    stkd.StockCode,
    stkd.ProductId,
    stkd.ColorId,
    POD.POrderDetailID,
    stkd.IMENo,
    stkd.STATUS,
    (
        POD.UnitPrice - 
        (
            (@FlatDis + @Adjustment) * (POD.UnitPrice * POD.Quantity) / 
            NULLIF(@GrandTotal, 0)
        ) / NULLIF(POD.Quantity, 0)
    ) AS PRate,
    stkd.SalesRate,
    stkd.CreditSRate,
    POD.CRSalesRate12Month,
    POD.CRSalesRate3Month,
    POD.Quantity,
    stkd.GodownId 
FROM @StockDetails stkd 
INNER JOIN Stocks stk 
    ON stk.ProductID = stkd.ProductId
    AND stk.ColorID = stkd.ColorID
    AND stk.GodownID = stkd.GodownId 
INNER JOIN POrderDetails POD 
    ON POD.ProductID = stkd.ProductId
    AND POD.ColorID = stkd.ColorId
    AND POD.GodownID = stkd.GodownId
    AND POD.POrderID = @PurchaseOrderId 
INNER JOIN Products P 
    ON P.ProductID = stk.ProductID 
WHERE P.ProductType = 2;




	--************For Nobarcode*****************
	--************For barcode*******************
	INSERT INTO StockDetails (
    StockID,
    StockCode,
    ProductID,
    ColorID,
    POrderDetailID,
    IMENO,
    STATUS,
    PRate,
    SRate,
    CreditSRate,
    CRSalesRate12Month,
    CRSalesRate3Month,
    Quantity,
    GodownID
)
SELECT 
    stk.StockID,
    stkd.StockCode,
    stkd.ProductId,
    stkd.ColorId,
    POD.POrderDetailID,
    stkd.IMENo,
    stkd.STATUS,
    (
        POD.UnitPrice - 
        (
            (@FlatDis + @Adjustment) * (POD.UnitPrice * POD.Quantity) / 
            NULLIF(@GrandTotal, 0)
        ) / NULLIF(POD.Quantity, 0)
    ) AS PRate,
    stkd.SalesRate,
    stkd.CreditSRate,
    POD.CRSalesRate12Month,
    POD.CRSalesRate3Month,
    POD.Quantity,
    stkd.GodownId 
FROM @StockDetails stkd 
INNER JOIN Stocks stk 
    ON stk.ProductID = stkd.ProductId
    AND stk.ColorID = stkd.ColorID
    AND stk.GodownID = stkd.GodownId 
INNER JOIN POrderDetails POD 
    ON POD.ProductID = stkd.ProductId
    AND POD.ColorID = stkd.ColorId
    AND POD.GodownID = stkd.GodownId
    AND POD.POrderID = @PurchaseOrderId 
INNER JOIN Products P 
    ON P.ProductID = stk.ProductID 
WHERE P.ProductType != 2;

	--************For barcode*******************
	COMMIT
	SELECT @PorderID=@PurchaseOrderId,@Result=1;
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		ROLLBACK

	SELECT @PorderID=0,@Result=0
	--RETURN 0;
END CATCH
GO






--------------------------------
-------------Nahid--------------
----------04-09-2024------------


--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_MonthlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0


if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-06-09'
set @CashInHand=26500
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(MONTH, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate)
and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

insert into #temp_Data1
select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
from POrders po
join Suppliers s on po.SupplierID = s.SupplierID
where po.ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate)
and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate and po.RecAmt>0
group by s.SupplierID,s.Name

insert into #temp_Data1
select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 1  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank collections', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Customer Collection(Cr))', sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Cash Delivery', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 4 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END

---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Income', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Income (Cr))', sum(Amount), 'Bank Income ', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Income ', @total, '', 0, 'Header'
END

---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections cc 
join Suppliers s on cc.SupplierID = s.SupplierID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) 
and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(cc.amount), 'Due Collection', 0, 'Cash'
		from CashCollections cc 
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) 
		and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
	-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3 AND CustomerID > 0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Customer Cash Collection Return', @total, 'Customer Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'
END
------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID 
				and  Month(Convert(date, InvoiceDate)) = Month(@StartDate)
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Retail/Dealer', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID 
	and  Month(Convert(date, InvoiceDate)) = Month(@StartDate)
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Retail/Dealere', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID 
			    and  Month(Convert(date, SalesDate)) = Month(@StartDate)
				and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Hire', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID 
	    and  Month(Convert(date, SalesDate)) = Month(@StartDate)
		and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Hire', 0, '', 0, 'Header'
	END
------------- -------------------------------------------- Direct Expense--------------------------------------------
set @total=isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)

if(@total) != 0
begin
	insert into #temp_Data1
	select @StartDate,'Expense', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
	from Expenditures EX
	inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
	where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
	group by E.Description

	insert into #temp_Data1
	select @StartDate,'Total Expense', @total, '', 0, 'Header'
end
		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID  and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate)  and  TransactionDate>= @InitailDate
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0 and  TransactionDate>= @InitailDate
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
					    where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end


-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2 AND    SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
 END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END

----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1  and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
  
  END
---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

				---------------------------------Income from Bank Expense as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Expense as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Bank Expense(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1 and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1  and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0
						and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

	-----------------------------------Income from Return From Supplier------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from CashCollections EX
						inner join Suppliers  E on E.SupplierID = EX.SupplierID
						where E.ConcernID = @ConcernID and EX.TransactionType = 3 
						and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Return From Supplier', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Name, sum(Amount), E.Name
		from CashCollections EX
		inner join Suppliers E on E.SupplierID = EX.SupplierID
		where E.ConcernID = @ConcernID and EX.TransactionType = 3 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Name
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Total Return From Supplier',@total, 'Header')
	
	end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name

 insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')

 END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
------------------------------------------------------------------------------------------------------------------------------------------------------

 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END
 ------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(MONTH, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

--------------------------------------------------------------------------------------------------------------------------------------


--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_YearlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-02-09'


if (@ConcernID = 1)
	set @CashInHand = 1263.00
else if (@ConcernID = 5)
	set @CashInHand = 8755.00
else if (@ConcernID = 6)
	set @CashInHand = - 2.00
else if (@ConcernID = 4)
	set @CashInHand = 65000.00
else if (@ConcernID = 20)
BEGIN
	set @CashInHand = 137340.00
	set @StartDate = '2020-03-12'
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END


set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(YEAR, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

insert into #temp_Data1
select @StartDate, s.Name, sum(po.recAmt), 'Cash Sales', 0, 'Order'
from POrders po
join Suppliers s on po.SupplierID = s.SupplierID
where po.ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
 and po.RecAmt>0
group by s.SupplierID,s.Name

insert into #temp_Data1
select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 1   and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate,'Bank collections', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Customer Collection(Cr))', sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 3  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Cash Delivery', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 4  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END

---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Income', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Income (Cr))', sum(Amount), 'Bank Income ', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Income ', @total, '', 0, 'Header'
END
---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections cc 
join Suppliers s on cc.SupplierID = s.SupplierID
where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,  s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc 
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate 
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3 AND CustomerID > 0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Customer Cash Collection Return', @total, 'Customer Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID 
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Retail/Dealer', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID 
		and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Retail/Dealere', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID 
				and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Hire', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID 
		and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Hire', 0, '', 0, 'Header'
	END

------------- -------------------------------------------- Direct Expense--------------------------------------------
set @total =isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)

if (@total) != 0
begin
insert into #temp_Data1
select @StartDate,'Expense', 0, '', 0, 'Header'

insert into #temp_Data1
select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description

insert into #temp_Data1
select @StartDate,'Total Expense', @total, '', 0, 'Header'

end

		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID and Year(Convert(date, TransactionDate)) = Year(@StartDate)  and  TransactionDate>= @InitailDate
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0 and  TransactionDate>= @InitailDate
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
						where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end


-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0
 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE  SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
 END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END


----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1  and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')

END
---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName
				---------------------------------Income from Bank Expens as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Expense as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Bank Expense(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1  and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1   and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID  and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0
						and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

	-----------------------------------Income from Return From Supplier------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from CashCollections EX
						inner join Suppliers  E on E.SupplierID = EX.SupplierID
						where E.ConcernID = @ConcernID and EX.TransactionType = 3 
						AND Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Return From Supplier', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Name, sum(Amount), E.Name
		from CashCollections EX
		inner join Suppliers E on E.SupplierID = EX.SupplierID
		where E.ConcernID = @ConcernID and EX.TransactionType = 3 and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Name
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Total Return From Supplier',@total, 'Header')
	
	end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1   AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
 END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
------------------------------------------------------------------------------------------------------------------------------------------------------

 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE  SIH.ParentId=2  and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END
------------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)

set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(YEAR, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

--------------------------------
-------------Nahid--------------
----------10-08-2024------------


ALTER PROC [dbo].[AddPurchaseOrder] (
	@PurchaseOrder [InsertPurchaseOrderTable] readonly
	,@PODetails [InsertPODetailTable] readonly
	,@POProductDetails [InsertPOProductDetailTable] readonly
	,@Stocks [InsertStockTable] readonly
	,@StockDetails [InsertStockDetailTable] readonly,
	@PorderID int out,
	@Result int Out
	)
AS
DECLARE @PurchaseOrderId INT
DECLARE @GrandTotal DECIMAL(18, 2)
		,@NetDiscount DECIMAL(18, 2)
		,@FlatDis DECIMAL(18, 2)
		,@Adjustment DECIMAL(18, 2)

--***************Product Type*****************
--ExistingBC = 1,
--NoBarcode = 2,
--AutoBC = 3
--***************Product Type*****************

BEGIN TRY
	BEGIN TRANSACTION

	INSERT INTO POrders (
		OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPDisAmt
		,NetDiscount
		,LaborCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,ActionStatus
		) (
		SELECT OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPTDisAmt
		,NetDiscount
		,LabourCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,1
		 FROM @PurchaseOrder
		)

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue + p.PaymentDue)
	FROM @PurchaseOrder p
	JOIN Suppliers ON Suppliers.SupplierID = p.SupplierId
	WHERE p.IsDamageOrder != 1

	SET @PurchaseOrderId = SCOPE_IDENTITY()
	SET @GrandTotal = ISNULL((
				SELECT GrandTotal
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @NetDiscount = ISNULL((
				SELECT NetDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @FlatDis = ISNULL((
				SELECT TDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
    SET @Adjustment = ISNULL((
				SELECT AdjAmount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)

	INSERT INTO PriceProtections (
		ProductID
		,ColorID
		,PrvPrice
		,ChangePrice
		,POrderID
		,ConcernID
		,SupplierID
		,PrvStockQty
		,PChangeDate
		) (
		SELECT stk.ProductId
		,stk.ColorId
		,stk.MRPPrice
		,stkt.MRPPrice
		,@PurchaseOrderId
		,stk.ConcernID
		,(
			SELECT SupplierId
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,stk.Quantity
		,GETDATE() FROM @Stocks stkt INNER JOIN Stocks stk ON stk.ProductID = stkt.ProductId
		AND stk.ColorID = stkt.ColorId WHERE stk.MRPPrice > stkt.MRPPrice
		)

	INSERT INTO POrderDetails (
		ProductID
		,ColorID
		,Quantity
		,UnitPrice
		,TAmount
		,PPDISPer
		,PPDISAmt
		,MRPRate
		,POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOFFER
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownID
		) (
		SELECT ProductId
		,ColorId
		,Quantity
		,UnitPrice
		,TAmount
		,PPDisPer
		,PPDisAmt
		,MrpRate
		,@PurchaseOrderId POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOffer
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownId FROM @PODetails
		)

	INSERT INTO POProductDetails (
		ProductID
		,ColorID
		,IMENO
		,POrderDetailID
		,DamagePOPDID
		) (
		SELECT POPD.ProductId
		,POPD.ColorId
		,POPD.IMENo
		,POD.POrderDetailID
		,DamagePOPDID FROM @POProductDetails POPD INNER JOIN POrderDetails POD ON POD.ProductID = POPD.ProductId
		AND POD.ColorID = POPD.ColorId
		AND POD.POrderID = @PurchaseOrderId
		)

	UPDATE POProductDetails
	SET IsDamageReplaced = 1
	FROM @POProductDetails dtPOPD
	JOIN POProductDetails POPD ON dtPOPD.DamagePOPDID = POPD.POPDID

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity + s.Quantity)
		,Stocks.MRPPrice = s.MRPPrice
		,LPPrice = s.LPPrice
		,ModifiedBy = s.CreatedBy
		,ModifiedDate = s.CreateDate
	FROM @Stocks s
	JOIN Stocks ON Stocks.StockID = s.StockID

	INSERT INTO Stocks (
		StockCode
		,EntryDate
		,Quantity
		,ProductID
		,ColorID
		,MRPPrice
		,LPPrice
		,ConcernID
		,CreatedBy
		,CreateDate
		,GodownID
		) (
		SELECT StockCode
		,EntryDate
		,Quantity
		,ProductId
		,ColorId
		,MRPPrice
		,LPPrice
		,ConcernId
		,CreatedBy
		,CreateDate
		,GodownId FROM @Stocks WHERE StockId IS NULL
		)

	--************For Nobarcode*****************
	INSERT INTO StockDetails (
		StockID
		,StockCode
		,ProductID
		,ColorID
		,POrderDetailID
		,IMENO
		,STATUS
		,PRate
		,SRate
		,CreditSRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,Quantity
		,GodownID
		) (
		SELECT stk.StockID
		,stkd.StockCode
		,stkd.ProductId
		,stkd.ColorId
		,POD.POrderDetailID
		,stkd.IMENo
		,stkd.STATUS
		,(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment))))
		,stkd.SalesRate
		,stkd.CreditSRate
		,POD.CRSalesRate12Month
		,POD.CRSalesRate3Month
		,POD.Quantity
		,stkd.GodownId FROM @StockDetails stkd INNER JOIN Stocks stk ON stk.ProductID = stkd.ProductId
		AND stk.ColorID = stkd.ColorID
		AND stk.GodownID = stkd.GodownId INNER JOIN POrderDetails POD ON POD.ProductID = stkd.ProductId
		AND POD.ColorID = stkd.ColorId
		AND POD.GodownID = stkd.GodownID
		AND POD.POrderID = @PurchaseOrderId INNER JOIN Products P ON P.ProductID = stk.ProductID WHERE P.ProductType = 2
		)

	--************For Nobarcode*****************
	--************For barcode*******************
	INSERT INTO StockDetails (
		StockID
		,StockCode
		,ProductID
		,ColorID
		,POrderDetailID
		,IMENO
		,STATUS
		,PRate
		,SRate
		,CreditSRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,Quantity
		,GodownID
		) (
		SELECT stk.StockID
		,stkd.StockCode
		,stkd.ProductId
		,stkd.ColorId
		,POD.POrderDetailID
		,stkd.IMENo
		,stkd.STATUS
		,(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment))))
		,stkd.SalesRate
		,stkd.CreditSRate
		,POD.CRSalesRate12Month
		,POD.CRSalesRate3Month
		,0
		,stkd.GodownId FROM @StockDetails stkd INNER JOIN Stocks stk ON stk.ProductID = stkd.ProductId
		AND stk.ColorID = stkd.ColorID
		AND stk.GodownID = stkd.GodownId INNER JOIN POrderDetails POD ON POD.ProductID = stkd.ProductId
		AND POD.ColorID = stkd.ColorId
		AND POD.GodownID = stkd.GodownId
		AND POD.POrderID = @PurchaseOrderId INNER JOIN Products P ON P.ProductID = stk.ProductID WHERE P.ProductType != 2
		)


	INSERT INTO TransactionPOrders (
		OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPDisAmt
		,NetDiscount
		,LaborCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,ActionStatus
		,POrderID
		) (
		SELECT OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPTDisAmt
		,NetDiscount
		,LabourCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,1
		,@PurchaseOrderId
		 FROM @PurchaseOrder
		)
	INSERT INTO TransactionPOrderDetails (
		ProductID
		,ColorID
		,Quantity
		,UnitPrice
		,TAmount
		,PPDISPer
		,PPDISAmt
		,MRPRate
		,POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOFFER
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownID
		,ActionStatus
		,ActionBy
		,ActionDate
		) (
		SELECT ProductId
		,ColorId
		,Quantity
		,UnitPrice
		,TAmount
		,PPDisPer
		,PPDisAmt
		,MrpRate
		,@PurchaseOrderId POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOffer
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownId
		,1
		,(
			SELECT CreatedBy
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,(
			SELECT CreateDate
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		FROM @PODetails
		)

	--************For barcode*******************
	COMMIT
	SELECT @PorderID=@PurchaseOrderId,@Result=1;
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		ROLLBACK

	SELECT @PorderID=0,@Result=0
	--RETURN 0;
END CATCH

----------------------------------------------------------------------------------------------------------------------------


ALTER PROCEDURE [dbo].[UpdatePurchaseOrder] (
	@PurchaseOrderId INT,
	@PurchaseOrder [InsertPurchaseOrderTable] readonly,
	@PODetails [InsertPODetailTable] readonly,
	@POProductDetails [InsertPOProductDetailTable] readonly,
	@Stocks [InsertStockTable] readonly,
	@StockDetails [InsertStockDetailTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

Declare @TPQty decimal(18,2)

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue - p.PaymentDue)
	FROM POrders p
	INNER JOIN Suppliers
		ON Suppliers.SupplierID = p.SupplierId
	WHERE p.POrderID = @PurchaseOrderId AND p.IsDamageOrder != 1

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue + p.PaymentDue)
	FROM @PurchaseOrder p
	INNER JOIN Suppliers
		ON Suppliers.SupplierID = p.SupplierId
	WHERE p.IsDamageOrder != 1

	UPDATE POrders
	SET OrderDate = p.OrderDate,
		ChallanNo = p.ChallanNo,
		SupplierID = p.SupplierID,
		GrandTotal = p.GrandTotal,
		TDiscount = p.TDiscount,
		TotalAmt = p.TotalAmt,
		AdjAmount = p.AdjAmount,
		RecAmt = p.RecAmt,
		PaymentDue = p.PaymentDue,
		TotalDue = p.TotalDue,
		STATUS = p.STATUS,
		PPDisAmt = p.PPTDisAmt,
		NetDiscount = p.NetDiscount,
		LaborCost = p.LabourCost,
		ConcernID = p.ConcernID,
		ModifiedDate = p.CreateDate,
		ModifiedBy = p.CreatedBy,
		IsDamageOrder = p.IsDamageOrder,
		Remarks = p.Remarks,
		InvoiceNo = p.InvoiceNo,
		EditReqStatus = 0,
		TPQty = p.TPQty,
		ActionStatus = ActionStatus + 1
	FROM @PurchaseOrder p
	WHERE POrderID = @PurchaseOrderId

	UPDATE POrderDetails
	SET POrderDetails.ProductID = PODT.ProductId,
		POrderDetails.ColorID = PODT.ColorId,
		POrderDetails.Quantity = PODT.Quantity,
		POrderDetails.UnitPrice = PODT.UnitPrice,
		POrderDetails.TAmount = PODT.TAmount,
		POrderDetails.PPDISPer = PODT.PPDisPer,
		POrderDetails.PPDISAmt = PODT.PPDisAmt,
		POrderDetails.MRPRate = PODT.MrpRate,
		POrderDetails.POrderID = @PurchaseOrderId,
		POrderDetails.SalesRate = PODT.SalesRate,
		POrderDetails.ExtraPPDISPer = PODT.ExtraPPDISPer,
		POrderDetails.ExtraPPDISAmt = PODT.ExtraPPDISAmt,
		PORderDetails.PPOFFER = PODT.PPOffer,
		POrderDetails.CreditSalesRate = PODT.CreditSalesRate,
		POrderDetails.CRSalesRate12Month = PODT.CRSalesRate12Month,
		POrderDetails.CRSalesRate3Month = PODT.CRSalesRate3Month,
		POrderDetails.GodownID = PODT.GodownID
	FROM @PODetails PODT
	INNER JOIN POrderDetails POD
		ON POD.POrderDetailId = PODT.POrderDetailId
	WHERE PODT.STATUS = 4

	INSERT INTO POrderDetails (
		ProductID,
		ColorID,
		Quantity,
		UnitPrice,
		TAmount,
		PPDISPer,
		PPDISAmt,
		MRPRate,
		POrderID,
		SalesRate,
		ExtraPPDISPer,
		ExtraPPDISAmt,
		PPOFFER,
		CreditSalesRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownID
		) (
		SELECT ProductId,
		ColorId,
		Quantity,
		UnitPrice,
		TAmount,
		PPDisPer,
		PPDisAmt,
		MrpRate,
		@PurchaseOrderId POrderID,
		SalesRate,
		ExtraPPDISPer,
		ExtraPPDISAmt,
		PPOffer,
		CreditSalesRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownId FROM @PODetails WHERE STATUS = 3
		)

	DELETE
	FROM POProductDetails
	WHERE POrderDetailID IN (
			SELECT POrderDetailId
			FROM @PODetails
			WHERE STATUS = 4 OR STATUS = 5
			)

	DELETE
	FROM POrderDetails
	WHERE POrderDetailID IN (
			SELECT POrderDetailId
			FROM @PODetails
			WHERE STATUS = 5
			)

	INSERT INTO POProductDetails (
		ProductID,
		ColorID,
		IMENO,
		POrderDetailID,
		DamagePOPDID
		) (
		SELECT POPD.ProductId,
		POPD.ColorId,
		POPD.IMENo,
		POD.POrderDetailID,
		POPD.DamagePOPDID FROM @POProductDetails POPD INNER JOIN POrderDetails POD
		ON POD.ProductID = POPD.ProductId AND POD.ColorID = POPD.ColorId AND POD.POrderID = @PurchaseOrderId
		)

	UPDATE POProductDetails
	SET IsDamageReplaced = 1
	FROM @POProductDetails dtPOPD
	INNER JOIN POProductDetails POPD
		ON dtPOPD.DamagePOPDID = POPD.POPDID

	Set @TPQty=ISNULL((Select sum(Quantity) from POrderDetails where POrderID=@PurchaseOrderId),0)
	Update POrders set TPQty=@TPQty where POrderID=@PurchaseOrderId

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity - s.Quantity),
		Stocks.MRPPrice = s.MRPPrice,
		LPPrice = s.LPPrice,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate
	FROM @Stocks s
	INNER JOIN Stocks
		ON Stocks.StockID = s.StockID
	WHERE s.STATUS = 5

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity + s.Quantity),
		Stocks.MRPPrice = s.MRPPrice,
		LPPrice = s.LPPrice,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate
	FROM @Stocks s
	INNER JOIN Stocks
		ON Stocks.StockID = s.StockID
	WHERE s.STATUS = 3 OR s.STATUS = 4

	INSERT INTO Stocks (
		StockCode,
		ColorId,
		EntryDate,
		Quantity,
		ProductID,
		MRPPrice,
		LPPrice,
		ConcernID,
		CreatedBy,
		CreateDate,
		GodownID
		) (
		SELECT StockCode,
		ColorId,
		EntryDate,
		Quantity,
		ProductId,
		MRPPrice,
		LPPrice,
		ConcernId,
		CreatedBy,
		CreateDate,
		GodownId
		FROM @Stocks WHERE StockId IS NULL
		)

	DELETE
	FROM StockDetails
	WHERE StockDetails.POrderDetailID IN (
			SELECT POrderDetailId
			FROM @PODetails
			WHERE STATUS = 4 OR STATUS = 5
			)

	INSERT INTO StockDetails (
		StockID,
		StockCode,
		ProductID,
		ColorID,
		POrderDetailID,
		IMENO,
		STATUS,
		PRate,
		SRate,
		CreditSRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownID,
		Quantity
		) (
		SELECT stk.StockID,
		stkd.StockCode,
		stkd.ProductId,
		stkd.ColorId,
		POD.POrderDetailID,
		stkd.IMENo,
		stkd.STATUS,
		POD.UnitPrice,
		stkd.SalesRate,
		stkd.CreditSRate,
		POD.CRSalesRate12Month,
		POD.CRSalesRate3Month,
		stkd.GodownId,
		POD.Quantity
		FROM @StockDetails stkd INNER JOIN Stocks stk
		ON stk.ProductID = stkd.ProductId AND stk.ColorID = stkd.ColorID AND stk.GodownID = stkd.GodownId
		INNER JOIN POrderDetails POD
		ON POD.ProductID = stkd.ProductId AND POD.ColorID = stkd.ColorId AND POD.GodownID=stkd.GodownId AND POD.POrderID = @PurchaseOrderId
		INNER JOIN Products p on stkd.ProductId = p.ProductID
		where p.ProductType=2
		)

		INSERT INTO StockDetails (
		StockID,
		StockCode,
		ProductID,
		ColorID,
		POrderDetailID,
		IMENO,
		STATUS,
		PRate,
		SRate,
		CreditSRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownID
		) (
		SELECT stk.StockID,
		stkd.StockCode,
		stkd.ProductId,
		stkd.ColorId,
		POD.POrderDetailID,
		stkd.IMENo,
		stkd.STATUS,
		POD.UnitPrice,
		stkd.SalesRate,
		stkd.CreditSRate,
		POD.CRSalesRate12Month,
		POD.CRSalesRate3Month,
		stkd.GodownId
		FROM @StockDetails stkd 
		INNER JOIN Stocks stk
		ON stk.ProductID = stkd.ProductId AND stk.ColorID = stkd.ColorID AND stk.GodownID = stkd.GodownId
		INNER JOIN POrderDetails POD
		ON POD.ProductID = stkd.ProductId AND POD.ColorID = stkd.ColorId AND POD.GodownID=stkd.GodownId AND POD.POrderID = @PurchaseOrderId
		INNER JOIN Products p on stkd.ProductId = p.ProductID
		where p.ProductType!=2
		)

	UPDATE StockDetails
	SET PRate = (POD.UnitPrice - (((po.TDiscount + po.AdjAmount) * POD.UnitPrice) / (po.GrandTotal - po.NetDiscount + (po.TDiscount + po.AdjAmount))))
	FROM POrderDetails pod
	INNER JOIN StockDetails sd
		ON pod.POrderDetailID = sd.POrderDetailID
	INNER JOIN POrders po
		ON pod.POrderID = po.POrderID
	WHERE po.POrderID = @PurchaseOrderId



	INSERT INTO TransactionPOrders (
		OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPDisAmt
		,NetDiscount
		,LaborCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		,ActionStatus
		,ModifiedBy
		,ModifiedDate
		,POrderID

		) (
		SELECT po.OrderDate
		,po.ChallanNo
		,po.SupplierID
		,po.GrandTotal
		,po.TDiscount
		,po.TotalAmt
		,po.AdjAmount
		,po.RecAmt
		,po.PaymentDue
		,po.TotalDue
		,po.Status
		,po.PPDisAmt
		,po.NetDiscount
		,po.LaborCost
		,po.ConcernID
		,po.CreateDate
		,po.CreatedBy
		,po.IsDamageOrder
		,po.Remarks
		,po.InvoiceNo
		,po.TPQty
		,po.ActionStatus
		,po.ModifiedBy
		,po.ModifiedDate
		,po.POrderID
		 FROM POrders po
		INNER JOIN POrders p on po.POrderID = p.POrderID AND p.POrderID =  @PurchaseOrderId
		)

	INSERT INTO TransactionPOrderDetails (
		ProductID
		,ColorID
		,Quantity
		,UnitPrice
		,TAmount
		,PPDISPer
		,PPDISAmt
		,MRPRate
		,POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOFFER
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownID
		,ActionStatus
		,ActionBy
		,ActionDate
		) (
		SELECT pd.ProductId
		,pd.ColorId
		,pd.Quantity
		,pd.UnitPrice
		,pd.TAmount
		,pd.PPDisPer
		,pd.PPDisAmt
		,pd.MrpRate
		,@PurchaseOrderId POrderID
		,pd.SalesRate
		,pd.ExtraPPDISPer
		,pd.ExtraPPDISAmt
		,pd.PPOffer
		,pd.CreditSalesRate
		,pd.CRSalesRate12Month
		,pd.CRSalesRate3Month
		,pd.GodownId
		,(
			SELECT ActionStatus 
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,(
			SELECT ModifiedBy
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,(
			SELECT ModifiedDate
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		FROM POrderDetails pd
		INNER JOIN POrders p on p.POrderID =  @PurchaseOrderId
		INNER JOIN POrderDetails ppd on pd.POrderDetailID = ppd.POrderDetailID AND ppd.POrderID = @PurchaseOrderId
		)


	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	DECLARE @CreatedDate DATETIME,
		@CreatedBy INT

	SELECT @CreatedBy = CreatedBy,
		@CreatedDate = CreateDate
	FROM @PurchaseOrder

	INSERT INTO Errors (
		Message,
		StackTrace,
		CreatedBy,
		CreateDate
		)
	VALUES (
		ERROR_MESSAGE(),
		ERROR_PROCEDURE() + ':' + CONVERT(VARCHAR(10), ERROR_LINE()) + '-' + ERROR_MESSAGE(),
		@CreatedBy,
		@CreatedDate
		)

	RETURN 0;
END CATCH


----------------------------------------------------------------------------------------------------------------------------


ALTER PROCEDURE [dbo].[AddSalesOrder] (
	@SalesOrder [INSERTSALESORDERTABLE] readonly,
	@SODetails [INSERTSODETAILTABLE] readonly,
	@RemindDate DATE,
	@BankTrans [InsertBankTransTable] readonly,
	@SorderID int out,
	@Result int Out
	)
AS
DECLARE @SalesOrderId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY
	BEGIN TRANSACTION

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @SalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	INSERT INTO sorders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID,
		TSQty,
		PrevDue,
		1 FROM @SalesOrder
		)

	SET @SalesOrderId = Scope_identity()

	INSERT INTO SOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.TAmount,
		SOD.PPDisPer,
		SOD.PPDisAmt,
		SOD.MrpRate,
		@SalesOrderId SOrderID,
		SOD.StockDetailId,
		SOD.PPOffer,
		(SOD.UnitPrice - SOD.PPDisAmt),
		STD.PRate,
		p.CompressorWarrentyMonth,
		p.PanelWarrentyMonth,
		p.MotorWarrentyMonth,
		p.SparePartsWarrentyMonth,
		p.ServiceWarrentyMonth FROM @SODetails SOD INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailId INNER JOIN Products p
		ON STD.ProductID = p.ProductID WHERE P.ProductType = 1 OR p.ProductType = 3
		)

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue),
		reminddate = @RemindDate
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NOT NULL

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue)
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NULL

	--Stock Update 
	CREATE TABLE #tmpStock (
		ProductID INT,
		ColorID INT,
		GodownID INT,
		Qty DECIMAL(18, 2)
		)

	INSERT INTO #tmpStock (
		ProductID,
		ColorID,
		GodownID,
		Qty
		) (
		SELECT s.ProductID,
		s.ColorID,
		s.Compressor,
		SUM(s.Quantity) FROM @SODetails s 
		GROUP BY s.ProductId,
		s.ColorId,
		s.Compressor
		)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st
		ON st.ProductID = sod.ProductID AND st.ColorID = sod.ColorID AND st.GodownID = sod.GodownID

	--For barCode Product 
	UPDATE stockdetails
	SET stockdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN stockdetails
		ON stockdetails.sdetailid = s.stockdetailid
	INNER JOIN products
		ON stockdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	--*****************FIFO for Nobarcode************************** 
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @GodownID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity INT
	DECLARE @SQty INT
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.productid,
		colorid,
		s.Compressor,
		quantity,
		sorderdetailid
	FROM @SODetails s
	INNER JOIN products
		ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity != 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)

			IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity

				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.Compressor=@GodownID AND SOD.colorid = @ColorID
					)

				SET @Quantity = 0
			END
			ELSE IF (@SQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @SQty

				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@SQty,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @SQty),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

	--For barCode Product SRVisit Status update 
	UPDATE srvproductdetails
	SET srvproductdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN srvproductdetails
		ON srvproductdetails.sdetailid = s.stockdetailid AND srvproductdetails.STATUS = 1
	INNER JOIN products
		ON srvproductdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3


	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID,
		TSQty,
		PrevDue,
		1,
		@SalesOrderId FROM @SalesOrder
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT CreatedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT CreateDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	SELECT @SorderID=@SalesOrderId,@Result=1;
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	SELECT @SorderID=0,@Result=0
END CATCH
----------------------------------------------------------------------------------------------------------------------------

ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = s.TSQty,
		ActionStatus = ActionStatus + 1
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)

	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId

	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	--For No barcode Stock Details out and SOrderDetails Insert
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @GodownID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity  decimal(18,2)
	DECLARE @StockQty decimal(18,2)
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.ProductId,
		colorid,
		Compressor,
		s.quantity,
		sorderdetailid
	FROM @SODetails s
    JOIN products ON products.productid = s.productid
	WHERE (products.ProductType = 2 and S.Status=3)

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE (@Quantity != 0)
		BEGIN
			SET @SDetailID = (
					SELECT Min(SDetailID)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @StockQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)
				------------------Debug-------------------------
				--INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
				--VALUES('ProductID: '+Convert(varchar(40),@ProductID)+'Stock Qty:'+Convert(varchar(40),@StockQty),'ColorID: '+Convert(varchar(40),@ColorID)+'GodownID: '+Convert(varchar(40),@GodownID),1,GETDATE())
				----------------------------
			IF (@StockQty > @Quantity)
			BEGIN
				SET @StockQty = @StockQty - @Quantity
			
				UPDATE stockdetails
				SET quantity = @StockQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)

				SET @Quantity = 0
			END
			ELSE IF (@StockQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @StockQty
			
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@StockQty,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID
				
				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

--New Products FIFO END




	--***************************************
	--*********SR visit Update***************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0
	INSERT INTO TransactionSOrders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue,
		ActionStatus,
		SOrderID
		) (
		SELECT so.InvoiceDate,
		so.invoiceno,
		so.customerid,
		so.vatpercentage,
		so.vatamount,
		so.grandtotal,
		so.TDPercentage,
		so.TDAmount,
		so.netdiscount,
		so.totalamount,
		so.paymentdue,
		so.RecAmount,
		so.adjamount,
		so.totaldue,
		so.STATUS,
		so.concernid,
		so.createdby,
		so.createdate,
		so.totaloffer,
		so.Remarks,
		so.TramsAndCondition,
		so.CardTypeSetupID,
		so.CardPaidAmount,
		so.DepositChargePercent,
		so.BankTransID,
		so.TSQty,
		so.PrevDue,
		so.ActionStatus,
		so.SOrderID
		FROM SOrders so
		INNER JOIN SOrders s on so.SOrderID = s.SOrderID AND s.SOrderID =  @SalesOrderId
		)

	INSERT INTO TransactionSOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service,
		ActionStatus,
		ActionBy,
		ActionDate
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.UTAmount,
		SOD.PPDPercentage,
		SOD.PPDAmount,
		SOD.MPRate,
		@SalesOrderId SOrderID,
		SOD.SDetailID,
		SOD.PPOffer,
		SOD.SRate,
		SOD.PRate,
		SOD.Compressor,
		SOD.Motor,
		SOD.Panel,
		SOD.Spareparts,
		SOD.Service,
		(
			SELECT ActionStatus 
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedBy
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		,(
			SELECT s.ModifiedDate
			FROM SOrders
			WHERE SOrderID = @SalesOrderId
			)
		FROM SOrderDetails SOD
		INNER JOIN SOrders s on s.SOrderID =  @SalesOrderId
		INNER JOIN SOrderDetails sd on SOD.SOrderDetailID = sd.SOrderDetailID AND sd.SOrderID = @SalesOrderId
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH




--------------------------------
-------------Nahid--------------
----------08-08-2024------------

ALTER TABLE dbo.POrders ADD
	ActionStatus int NOT NULL CONSTRAINT DF_POrders_ActionStatus DEFAULT ((1))
GO

----------------------------------------------------------------------------------------------------------------------------

ALTER TABLE dbo.SOrders ADD
	ActionStatus int NOT NULL CONSTRAINT DF_SOrders_ActionStatus DEFAULT ((1))
GO


----------------------------------------------------------------------------------------------------------------------------

CREATE TABLE [dbo].[TransactionPOrders](
	[TransPOrderID] [int] IDENTITY(1,1) NOT NULL,
	[OrderDate] [datetime] NOT NULL,
	[ChallanNo] [varchar](150) NOT NULL,
	[SupplierID] [int] NOT NULL,
	[GrandTotal] [decimal](18, 2) NOT NULL,
	[TDiscount] [decimal](18, 2) NOT NULL,
	[TotalAmt] [decimal](18, 2) NOT NULL,
	[RecAmt] [decimal](18, 2) NOT NULL,
	[PaymentDue] [decimal](18, 2) NOT NULL,
	[TotalDue] [decimal](18, 2) NOT NULL,
	[Status] [int] NOT NULL,
	[PPDisAmt] [decimal](18, 2) NOT NULL,
	[NetDiscount] [decimal](18, 2) NOT NULL,
	[LaborCost] [decimal](18, 2) NOT NULL,
	[AdjAmount] [decimal](18, 2) NOT NULL,
	[ConcernID] [int] NOT NULL,
	[CreatedBy] [int] NOT NULL,
	[CreateDate] [datetime] NULL,
	[ModifiedBy] [int] NULL,
	[ModifiedDate] [datetime] NULL,
	[IsDamageOrder] [int] NULL,
	[Remarks] [nvarchar](max) NULL,
	[InvoiceNo] [varchar](150) NULL,
	[TPQty] [decimal](18, 2) NOT NULL,
	[EditReqStatus] [int] NOT NULL,
	[ActionStatus] [int] NOT NULL,
	[POrderID] [int] NOT NULL,
 CONSTRAINT [PK_TransactionPOrders] PRIMARY KEY CLUSTERED 
(
	[TransPOrderID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

ALTER TABLE [dbo].[TransactionPOrders] ADD  CONSTRAINT [DF_TransactionPOrders_Stattus]  DEFAULT ((0)) FOR [Status]
GO

ALTER TABLE [dbo].[TransactionPOrders] ADD  CONSTRAINT [DF_TransactionPOrders_PPDisAmt]  DEFAULT ((0)) FOR [PPDisAmt]
GO

ALTER TABLE [dbo].[TransactionPOrders] ADD  CONSTRAINT [DF_TransactionPOrders_NetDiscount]  DEFAULT ((0)) FOR [NetDiscount]
GO

ALTER TABLE [dbo].[TransactionPOrders] ADD  CONSTRAINT [DF_TransactionPOrders_LaborCost]  DEFAULT ((0)) FOR [LaborCost]
GO

ALTER TABLE [dbo].[TransactionPOrders] ADD  CONSTRAINT [DF_TransactionPOrders_CreatedBy]  DEFAULT ((1)) FOR [CreatedBy]
GO

ALTER TABLE [dbo].[TransactionPOrders] ADD  CONSTRAINT [DF_TransactionPOrders_TPQty]  DEFAULT ((0)) FOR [TPQty]
GO

ALTER TABLE [dbo].[TransactionPOrders] ADD  CONSTRAINT [DF_TransactionPOrders_EditReqStatus]  DEFAULT ((0)) FOR [EditReqStatus]
GO

ALTER TABLE [dbo].[TransactionPOrders] ADD  CONSTRAINT [DF_TransactionPOrders_ActionStatus]  DEFAULT ((0)) FOR [ActionStatus]
GO

ALTER TABLE [dbo].[TransactionPOrders] ADD  CONSTRAINT [DF_TransactionPOrders_POrderID]  DEFAULT ((0)) FOR [POrderID]
GO

ALTER TABLE [dbo].[TransactionPOrders]  WITH CHECK ADD  CONSTRAINT [FK_TransactionPOrders_SisterConcerns] FOREIGN KEY([ConcernID])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[TransactionPOrders] CHECK CONSTRAINT [FK_TransactionPOrders_SisterConcerns]
GO

ALTER TABLE [dbo].[TransactionPOrders]  WITH CHECK ADD  CONSTRAINT [FK_TransactionPOrders_Suppliers] FOREIGN KEY([SupplierID])
REFERENCES [dbo].[Suppliers] ([SupplierID])
GO

ALTER TABLE [dbo].[TransactionPOrders] CHECK CONSTRAINT [FK_TransactionPOrders_Suppliers]
GO



----------------------------------------------------------------------------------------------------------------------------



CREATE TABLE [dbo].[TransactionPOrderDetails](
	[TransPOrderDetailID] [int] IDENTITY(1,1) NOT NULL,
	[ProductID] [int] NOT NULL,
	[Quantity] [decimal](18, 2) NOT NULL,
	[UnitPrice] [decimal](18, 2) NOT NULL,
	[TAmount] [decimal](18, 2) NOT NULL,
	[POrderID] [int] NOT NULL,
	[PPDISPer] [decimal](18, 2) NOT NULL,
	[PPDISAmt] [decimal](18, 2) NOT NULL,
	[MRPRate] [decimal](18, 2) NOT NULL,
	[ColorID] [int] NULL,
	[SalesRate] [decimal](18, 0) NOT NULL,
	[ExtraPPDISPer] [decimal](18, 2) NOT NULL,
	[ExtraPPDISAmt] [decimal](18, 2) NOT NULL,
	[PPOFFER] [decimal](18, 2) NOT NULL,
	[CreditSalesRate] [decimal](18, 2) NOT NULL,
	[CRSalesRate12Month] [decimal](18, 2) NOT NULL,
	[CRSalesRate3Month] [decimal](18, 2) NOT NULL,
	[GodownID] [int] NOT NULL,
	[ActionStatus] [int] NOT NULL,
	[ActionBy] [int] NOT NULL,
	[ActionDate] [datetime] NULL,
 CONSTRAINT [PK_TransactionPOrderDetails] PRIMARY KEY CLUSTERED 
(
	[TransPOrderDetailID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[TransactionPOrderDetails] ADD  CONSTRAINT [DF_TransactionPOrderDetails_PPDISPer]  DEFAULT ((0)) FOR [PPDISPer]
GO

ALTER TABLE [dbo].[TransactionPOrderDetails] ADD  CONSTRAINT [DF_TransactionPOrderDetails_PPDISAmt]  DEFAULT ((0)) FOR [PPDISAmt]
GO

ALTER TABLE [dbo].[TransactionPOrderDetails] ADD  CONSTRAINT [DF_TransactionPOrderDetails_MRPRate]  DEFAULT ((0)) FOR [MRPRate]
GO

ALTER TABLE [dbo].[TransactionPOrderDetails] ADD  CONSTRAINT [DF_TransactionPOrderDetails_SalesRate]  DEFAULT ((0)) FOR [SalesRate]
GO

ALTER TABLE [dbo].[TransactionPOrderDetails] ADD  CONSTRAINT [DF_TransactionPOrderDetails_ExtraPPDISPer]  DEFAULT ((0)) FOR [ExtraPPDISPer]
GO

ALTER TABLE [dbo].[TransactionPOrderDetails] ADD  CONSTRAINT [DF_TransactionPOrderDetails_PPDISAmt1]  DEFAULT ((0)) FOR [ExtraPPDISAmt]
GO

ALTER TABLE [dbo].[TransactionPOrderDetails] ADD  CONSTRAINT [DF_TransactionPOrderDetails_ExtraPPDISAmt1]  DEFAULT ((0)) FOR [PPOFFER]
GO

ALTER TABLE [dbo].[TransactionPOrderDetails] ADD  CONSTRAINT [DF_TransactionPOrderDetails_ExtraPPDISAmt1_1]  DEFAULT ((0)) FOR [CreditSalesRate]
GO

ALTER TABLE [dbo].[TransactionPOrderDetails] ADD  CONSTRAINT [DF_TransactionPOrderDetails_CRSalesRate12Month]  DEFAULT ((0)) FOR [CRSalesRate12Month]
GO

ALTER TABLE [dbo].[TransactionPOrderDetails] ADD  CONSTRAINT [DF_TransactionPOrderDetails_CRSalesRate3Month]  DEFAULT ((0)) FOR [CRSalesRate3Month]
GO

ALTER TABLE [dbo].[TransactionPOrderDetails] ADD  CONSTRAINT [DF_TransactionPOrderDetails_ActionStatus]  DEFAULT ((0)) FOR [ActionStatus]
GO

ALTER TABLE [dbo].[TransactionPOrderDetails] ADD  CONSTRAINT [DF_TransactionPOrderDetails_ActionBy]  DEFAULT ((0)) FOR [ActionBy]
GO



----------------------------------------------------------------------------------------------------------------------------



CREATE TABLE [dbo].[TransactionSOrders](
	[TransSOrderID] [int] IDENTITY(1,1) NOT NULL,
	[InvoiceNo] [varchar](150) NOT NULL,
	[InvoiceDate] [datetime] NOT NULL,
	[VATPercentage] [decimal](18, 2) NOT NULL,
	[VATAmount] [decimal](18, 2) NOT NULL,
	[GrandTotal] [decimal](18, 2) NOT NULL,
	[TDPercentage] [decimal](18, 4) NOT NULL,
	[TDAmount] [decimal](18, 2) NOT NULL,
	[TotalAmount] [decimal](18, 2) NOT NULL,
	[PaymentDue] [decimal](18, 2) NOT NULL,
	[RecAmount] [decimal](18, 2) NULL,
	[NetDiscount] [decimal](18, 2) NULL,
	[Remarks] [varchar](350) NULL,
	[CustomerID] [int] NOT NULL,
	[AdjAmount] [decimal](18, 2) NOT NULL,
	[TotalDue] [decimal](18, 2) NOT NULL,
	[Status] [int] NOT NULL,
	[ConcernID] [int] NOT NULL,
	[CreatedBy] [int] NOT NULL,
	[CreateDate] [datetime] NULL,
	[ModifiedBy] [int] NULL,
	[ModifiedDate] [datetime] NULL,
	[TotalOffer] [decimal](18, 2) NOT NULL,
	[PGrandTotal] [decimal](18, 2) NOT NULL,
	[IsReplacement] [int] NOT NULL,
	[BankTransID] [int] NOT NULL,
	[CardPaidAmount] [decimal](18, 2) NOT NULL,
	[CardTypeSetupID] [int] NOT NULL,
	[DepositChargePercent] [decimal](18, 2) NOT NULL,
	[TSQty] [decimal](18, 2) NOT NULL,
	[PrevDue] [decimal](18, 2) NOT NULL,
	[IsEditApprovalStatus] [int] NOT NULL,
	[TramsAndCondition] [nvarchar](max) NULL,
	[EditReqStatus] [int] NOT NULL,
	[ActionStatus] [int] NOT NULL,
	[SOrderID] [int] NOT NULL,
 CONSTRAINT [PK_TransactionSOrders] PRIMARY KEY CLUSTERED 
(
	[TransSOrderID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_TDPercentage]  DEFAULT ((0)) FOR [TDPercentage]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_TotalDue]  DEFAULT ((0)) FOR [TotalDue]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_Status]  DEFAULT ((0)) FOR [Status]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_CreatedBy]  DEFAULT ((1)) FOR [CreatedBy]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_TotalOffer]  DEFAULT ((0)) FOR [TotalOffer]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_PGrandTotal]  DEFAULT ((0)) FOR [PGrandTotal]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_IsReplacement]  DEFAULT ((0)) FOR [IsReplacement]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_BankTransID]  DEFAULT ((0)) FOR [BankTransID]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_CardPaidAmount]  DEFAULT ((0)) FOR [CardPaidAmount]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_CardTypeSetupID]  DEFAULT ((0)) FOR [CardTypeSetupID]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_DepositChargePercent]  DEFAULT ((0)) FOR [DepositChargePercent]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_TSQty]  DEFAULT ((1)) FOR [TSQty]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_PrevDue]  DEFAULT ((0)) FOR [PrevDue]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_IsEditApprovalStatus]  DEFAULT ((2)) FOR [IsEditApprovalStatus]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_EditReqStatus]  DEFAULT ((0)) FOR [EditReqStatus]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_ActionStatus]  DEFAULT ((0)) FOR [ActionStatus]
GO

ALTER TABLE [dbo].[TransactionSOrders] ADD  CONSTRAINT [DF_TransactionSOrders_SOrderID]  DEFAULT ((0)) FOR [SOrderID]
GO

ALTER TABLE [dbo].[TransactionSOrders]  WITH CHECK ADD  CONSTRAINT [FK_TransactionSOrders_Customers] FOREIGN KEY([CustomerID])
REFERENCES [dbo].[Customers] ([CustomerID])
GO

ALTER TABLE [dbo].[TransactionSOrders] CHECK CONSTRAINT [FK_TransactionSOrders_Customers]
GO

ALTER TABLE [dbo].[TransactionSOrders]  WITH CHECK ADD  CONSTRAINT [FK_TransactionSOrders_SisterConcerns] FOREIGN KEY([ConcernID])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[TransactionSOrders] CHECK CONSTRAINT [FK_TransactionSOrders_SisterConcerns]
GO



----------------------------------------------------------------------------------------------------------------------------


CREATE TABLE [dbo].[TransactionSOrderDetails](
	[TransSOrderDetailID] [int] IDENTITY(1,1) NOT NULL,
	[ProductID] [int] NOT NULL,
	[UnitPrice] [decimal](18, 2) NOT NULL,
	[PPDPercentage] [decimal](18, 4) NOT NULL,
	[PPDAmount] [decimal](18, 2) NOT NULL,
	[Quantity] [decimal](18, 2) NOT NULL,
	[UTAmount] [decimal](18, 2) NOT NULL,
	[SOrderID] [int] NOT NULL,
	[MPRate] [decimal](18, 2) NOT NULL,
	[SDetailID] [int] NOT NULL,
	[PPOffer] [decimal](18, 2) NOT NULL,
	[SRate] [decimal](18, 2) NOT NULL,
	[PRate] [decimal](18, 2) NOT NULL,
	[RStockDetailId] [int] NULL,
	[RepOrderID] [int] NULL,
	[RepUnitPrice] [decimal](18, 2) NULL,
	[Remarks] [varchar](500) NULL,
	[IsProductReturn] [int] NOT NULL,
	[Compressor] [varchar](200) NULL,
	[Motor] [varchar](200) NULL,
	[Panel] [varchar](200) NULL,
	[Spareparts] [varchar](200) NULL,
	[Service] [varchar](200) NULL,
	[RQuantity] [decimal](18, 2) NOT NULL,
	[ReplaceProductType] [int] NOT NULL,
	[ActionStatus] [int] NOT NULL,
	[ActionBy] [int] NOT NULL,
	[ActionDate] [datetime] NULL,
 CONSTRAINT [PK_TransactionSOrderDetails] PRIMARY KEY CLUSTERED 
(
	[TransSOrderDetailID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[TransactionSOrderDetails] ADD  CONSTRAINT [DF_TransactionSOrderDetails_PPDPercentage]  DEFAULT ((0)) FOR [PPDPercentage]
GO

ALTER TABLE [dbo].[TransactionSOrderDetails] ADD  CONSTRAINT [DF_TransactionSOrderDetails_SOrderID]  DEFAULT ((0)) FOR [SOrderID]
GO

ALTER TABLE [dbo].[TransactionSOrderDetails] ADD  CONSTRAINT [DF_TransactionSOrderDetails_SDetailID]  DEFAULT ((0)) FOR [SDetailID]
GO

ALTER TABLE [dbo].[TransactionSOrderDetails] ADD  CONSTRAINT [DF_TransactionSOrderDetails_PPOffer]  DEFAULT ((0)) FOR [PPOffer]
GO

ALTER TABLE [dbo].[TransactionSOrderDetails] ADD  CONSTRAINT [DF_TransactionSOrderDetails_SRate]  DEFAULT ((0)) FOR [SRate]
GO

ALTER TABLE [dbo].[TransactionSOrderDetails] ADD  CONSTRAINT [DF_TransactionSOrderDetails_PRate]  DEFAULT ((0)) FOR [PRate]
GO

ALTER TABLE [dbo].[TransactionSOrderDetails] ADD  CONSTRAINT [DF_TransactionSOrderDetails_Remarks]  DEFAULT ('') FOR [Remarks]
GO

ALTER TABLE [dbo].[TransactionSOrderDetails] ADD  CONSTRAINT [DF_TransactionSOrderDetails_IsProductReturn]  DEFAULT ((0)) FOR [IsProductReturn]
GO

ALTER TABLE [dbo].[TransactionSOrderDetails] ADD  CONSTRAINT [DF_TransactionSOrderDetails_RQuantity]  DEFAULT ((0)) FOR [RQuantity]
GO

ALTER TABLE [dbo].[TransactionSOrderDetails] ADD  CONSTRAINT [DF_TransactionSOrderDetails_ReplaceProductType]  DEFAULT ((0)) FOR [ReplaceProductType]
GO

ALTER TABLE [dbo].[TransactionSOrderDetails] ADD  CONSTRAINT [DF_TransactionSOrderDetails_ActionStatus]  DEFAULT ((0)) FOR [ActionStatus]
GO

ALTER TABLE [dbo].[TransactionSOrderDetails] ADD  CONSTRAINT [DF_TransactionSOrderDetails_ActionBy]  DEFAULT ((0)) FOR [ActionBy]
GO

ALTER TABLE [dbo].[TransactionSOrderDetails]  WITH CHECK ADD  CONSTRAINT [FK_TransactionSOrderDetails_Products] FOREIGN KEY([ProductID])
REFERENCES [dbo].[Products] ([ProductID])
GO

ALTER TABLE [dbo].[TransactionSOrderDetails] CHECK CONSTRAINT [FK_TransactionSOrderDetails_Products]
GO

ALTER TABLE [dbo].[TransactionSOrderDetails]  WITH CHECK ADD  CONSTRAINT [FK_TransactionSOrderDetails_SOrders] FOREIGN KEY([SOrderID])
REFERENCES [dbo].[SOrders] ([SOrderID])
GO

ALTER TABLE [dbo].[TransactionSOrderDetails] CHECK CONSTRAINT [FK_TransactionSOrderDetails_SOrders]
GO



--------------------------------
-------------Nahid--------------
----------23-07-2024------------


CREATE TABLE [dbo].[CashCollTranHistories](
	[CashCollTranHisID] [int] IDENTITY(1,1) NOT NULL,
	[CashCollectionID] [int] NOT NULL,
	[ReceiptNo] [varchar](50) NOT NULL,
	[CreateOrEdit] [varchar](50) NOT NULL,
	[Value] [varchar](1000) NULL,
	[ConcernID] [int] NOT NULL,
	[CreateOrEditBy] [int] NOT NULL,
	[HistoryDate] [datetime] NOT NULL,
 CONSTRAINT [PK_CashCollTranHistories] PRIMARY KEY CLUSTERED 
(
	[CashCollTranHisID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO


--------------------------------
-------------Nahid--------------
----------22-07-2024------------

ALTER TABLE dbo.POrders ADD
	EditReqStatus int NOT NULL CONSTRAINT DF_POrders_EditReqStatus DEFAULT ((0))
GO

----------------------------------------------------------------------------------------------------------------------------


ALTER PROCEDURE [dbo].[UpdatePurchaseOrder] (
	@PurchaseOrderId INT,
	@PurchaseOrder [InsertPurchaseOrderTable] readonly,
	@PODetails [InsertPODetailTable] readonly,
	@POProductDetails [InsertPOProductDetailTable] readonly,
	@Stocks [InsertStockTable] readonly,
	@StockDetails [InsertStockDetailTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue - p.PaymentDue)
	FROM POrders p
	INNER JOIN Suppliers
		ON Suppliers.SupplierID = p.SupplierId
	WHERE p.POrderID = @PurchaseOrderId AND p.IsDamageOrder != 1

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue + p.PaymentDue)
	FROM @PurchaseOrder p
	INNER JOIN Suppliers
		ON Suppliers.SupplierID = p.SupplierId
	WHERE p.IsDamageOrder != 1

	UPDATE POrders
	SET OrderDate = p.OrderDate,
		ChallanNo = p.ChallanNo,
		SupplierID = p.SupplierID,
		GrandTotal = p.GrandTotal,
		TDiscount = p.TDiscount,
		TotalAmt = p.TotalAmt,
		AdjAmount = p.AdjAmount,
		RecAmt = p.RecAmt,
		PaymentDue = p.PaymentDue,
		TotalDue = p.TotalDue,
		STATUS = p.STATUS,
		PPDisAmt = p.PPTDisAmt,
		NetDiscount = p.NetDiscount,
		LaborCost = p.LabourCost,
		ConcernID = p.ConcernID,
		ModifiedDate = p.CreateDate,
		ModifiedBy = p.CreatedBy,
		IsDamageOrder = p.IsDamageOrder,
		Remarks = p.Remarks,
		InvoiceNo = p.InvoiceNo,
		EditReqStatus = 0,
		TPQty = p.TPQty
	FROM @PurchaseOrder p
	WHERE POrderID = @PurchaseOrderId

	UPDATE POrderDetails
	SET POrderDetails.ProductID = PODT.ProductId,
		POrderDetails.ColorID = PODT.ColorId,
		POrderDetails.Quantity = PODT.Quantity,
		POrderDetails.UnitPrice = PODT.UnitPrice,
		POrderDetails.TAmount = PODT.TAmount,
		POrderDetails.PPDISPer = PODT.PPDisPer,
		POrderDetails.PPDISAmt = PODT.PPDisAmt,
		POrderDetails.MRPRate = PODT.MrpRate,
		POrderDetails.POrderID = @PurchaseOrderId,
		POrderDetails.SalesRate = PODT.SalesRate,
		POrderDetails.ExtraPPDISPer = PODT.ExtraPPDISPer,
		POrderDetails.ExtraPPDISAmt = PODT.ExtraPPDISAmt,
		PORderDetails.PPOFFER = PODT.PPOffer,
		POrderDetails.CreditSalesRate = PODT.CreditSalesRate,
		POrderDetails.CRSalesRate12Month = PODT.CRSalesRate12Month,
		POrderDetails.CRSalesRate3Month = PODT.CRSalesRate3Month,
		POrderDetails.GodownID = PODT.GodownID
	FROM @PODetails PODT
	INNER JOIN POrderDetails POD
		ON POD.POrderDetailId = PODT.POrderDetailId
	WHERE PODT.STATUS = 4

	INSERT INTO POrderDetails (
		ProductID,
		ColorID,
		Quantity,
		UnitPrice,
		TAmount,
		PPDISPer,
		PPDISAmt,
		MRPRate,
		POrderID,
		SalesRate,
		ExtraPPDISPer,
		ExtraPPDISAmt,
		PPOFFER,
		CreditSalesRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownID
		) (
		SELECT ProductId,
		ColorId,
		Quantity,
		UnitPrice,
		TAmount,
		PPDisPer,
		PPDisAmt,
		MrpRate,
		@PurchaseOrderId POrderID,
		SalesRate,
		ExtraPPDISPer,
		ExtraPPDISAmt,
		PPOffer,
		CreditSalesRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownId FROM @PODetails WHERE STATUS = 3
		)

	DELETE
	FROM POProductDetails
	WHERE POrderDetailID IN (
			SELECT POrderDetailId
			FROM @PODetails
			WHERE STATUS = 4 OR STATUS = 5
			)

	DELETE
	FROM POrderDetails
	WHERE POrderDetailID IN (
			SELECT POrderDetailId
			FROM @PODetails
			WHERE STATUS = 5
			)

	INSERT INTO POProductDetails (
		ProductID,
		ColorID,
		IMENO,
		POrderDetailID,
		DamagePOPDID
		) (
		SELECT POPD.ProductId,
		POPD.ColorId,
		POPD.IMENo,
		POD.POrderDetailID,
		POPD.DamagePOPDID FROM @POProductDetails POPD INNER JOIN POrderDetails POD
		ON POD.ProductID = POPD.ProductId AND POD.ColorID = POPD.ColorId AND POD.POrderID = @PurchaseOrderId
		)

	UPDATE POProductDetails
	SET IsDamageReplaced = 1
	FROM @POProductDetails dtPOPD
	INNER JOIN POProductDetails POPD
		ON dtPOPD.DamagePOPDID = POPD.POPDID

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity - s.Quantity),
		Stocks.MRPPrice = s.MRPPrice,
		LPPrice = s.LPPrice,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate
	FROM @Stocks s
	INNER JOIN Stocks
		ON Stocks.StockID = s.StockID
	WHERE s.STATUS = 5

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity + s.Quantity),
		Stocks.MRPPrice = s.MRPPrice,
		LPPrice = s.LPPrice,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate
	FROM @Stocks s
	INNER JOIN Stocks
		ON Stocks.StockID = s.StockID
	WHERE s.STATUS = 3 OR s.STATUS = 4

	INSERT INTO Stocks (
		StockCode,
		ColorId,
		EntryDate,
		Quantity,
		ProductID,
		MRPPrice,
		LPPrice,
		ConcernID,
		CreatedBy,
		CreateDate,
		GodownID
		) (
		SELECT StockCode,
		ColorId,
		EntryDate,
		Quantity,
		ProductId,
		MRPPrice,
		LPPrice,
		ConcernId,
		CreatedBy,
		CreateDate,
		GodownId
		FROM @Stocks WHERE StockId IS NULL
		)

	DELETE
	FROM StockDetails
	WHERE StockDetails.POrderDetailID IN (
			SELECT POrderDetailId
			FROM @PODetails
			WHERE STATUS = 4 OR STATUS = 5
			)

	INSERT INTO StockDetails (
		StockID,
		StockCode,
		ProductID,
		ColorID,
		POrderDetailID,
		IMENO,
		STATUS,
		PRate,
		SRate,
		CreditSRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownID,
		Quantity
		) (
		SELECT stk.StockID,
		stkd.StockCode,
		stkd.ProductId,
		stkd.ColorId,
		POD.POrderDetailID,
		stkd.IMENo,
		stkd.STATUS,
		POD.UnitPrice,
		stkd.SalesRate,
		stkd.CreditSRate,
		POD.CRSalesRate12Month,
		POD.CRSalesRate3Month,
		stkd.GodownId,
		POD.Quantity
		FROM @StockDetails stkd INNER JOIN Stocks stk
		ON stk.ProductID = stkd.ProductId AND stk.ColorID = stkd.ColorID AND stk.GodownID = stkd.GodownId
		INNER JOIN POrderDetails POD
		ON POD.ProductID = stkd.ProductId AND POD.ColorID = stkd.ColorId AND POD.GodownID=stkd.GodownId AND POD.POrderID = @PurchaseOrderId
		INNER JOIN Products p on stkd.ProductId = p.ProductID
		where p.ProductType=2
		)

		INSERT INTO StockDetails (
		StockID,
		StockCode,
		ProductID,
		ColorID,
		POrderDetailID,
		IMENO,
		STATUS,
		PRate,
		SRate,
		CreditSRate,
		CRSalesRate12Month,
		CRSalesRate3Month,
		GodownID
		) (
		SELECT stk.StockID,
		stkd.StockCode,
		stkd.ProductId,
		stkd.ColorId,
		POD.POrderDetailID,
		stkd.IMENo,
		stkd.STATUS,
		POD.UnitPrice,
		stkd.SalesRate,
		stkd.CreditSRate,
		POD.CRSalesRate12Month,
		POD.CRSalesRate3Month,
		stkd.GodownId
		FROM @StockDetails stkd 
		INNER JOIN Stocks stk
		ON stk.ProductID = stkd.ProductId AND stk.ColorID = stkd.ColorID AND stk.GodownID = stkd.GodownId
		INNER JOIN POrderDetails POD
		ON POD.ProductID = stkd.ProductId AND POD.ColorID = stkd.ColorId AND POD.GodownID=stkd.GodownId AND POD.POrderID = @PurchaseOrderId
		INNER JOIN Products p on stkd.ProductId = p.ProductID
		where p.ProductType!=2
		)

	UPDATE StockDetails
	SET PRate = (POD.UnitPrice - (((po.TDiscount + po.AdjAmount) * POD.UnitPrice) / (po.GrandTotal - po.NetDiscount + (po.TDiscount + po.AdjAmount))))
	FROM POrderDetails pod
	INNER JOIN StockDetails sd
		ON pod.POrderDetailID = sd.POrderDetailID
	INNER JOIN POrders po
		ON pod.POrderID = po.POrderID
	WHERE po.POrderID = @PurchaseOrderId

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	DECLARE @CreatedDate DATETIME,
		@CreatedBy INT

	SELECT @CreatedBy = CreatedBy,
		@CreatedDate = CreateDate
	FROM @PurchaseOrder

	INSERT INTO Errors (
		Message,
		StackTrace,
		CreatedBy,
		CreateDate
		)
	VALUES (
		ERROR_MESSAGE(),
		ERROR_PROCEDURE() + ':' + CONVERT(VARCHAR(10), ERROR_LINE()) + '-' + ERROR_MESSAGE(),
		@CreatedBy,
		@CreatedDate
		)

	RETURN 0;
END CATCH

--------------------------------
-------------Nahid--------------
----------21-07-2024------------
ALTER TABLE dbo.SystemInformations ADD
	IsEditReqPermission int NOT NULL CONSTRAINT DF_SystemInformations_IsEditReqPermission DEFAULT ((0))
GO

----------------------------------------------------------------------------------------------------------------------------

ALTER TABLE dbo.SOrders ADD
	EditReqStatus int NOT NULL CONSTRAINT DF_SOrders_EditReqStatus DEFAULT ((0))
GO

----------------------------------------------------------------------------------------------------------------------------

ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID,
		EditReqStatus = 0,
		TSQty = @TQty
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)

	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId

	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	--For No barcode Stock Details out and SOrderDetails Insert
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @GodownID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity  decimal(18,2)
	DECLARE @StockQty decimal(18,2)
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.ProductId,
		colorid,
		Compressor,
		s.quantity,
		sorderdetailid
	FROM @SODetails s
    JOIN products ON products.productid = s.productid
	WHERE (products.ProductType = 2 and S.Status=3)

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE (@Quantity != 0)
		BEGIN
			SET @SDetailID = (
					SELECT Min(SDetailID)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @StockQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)
				------------------Debug-------------------------
				--INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
				--VALUES('ProductID: '+Convert(varchar(40),@ProductID)+'Stock Qty:'+Convert(varchar(40),@StockQty),'ColorID: '+Convert(varchar(40),@ColorID)+'GodownID: '+Convert(varchar(40),@GodownID),1,GETDATE())
				----------------------------
			IF (@StockQty > @Quantity)
			BEGIN
				SET @StockQty = @StockQty - @Quantity
			
				UPDATE stockdetails
				SET quantity = @StockQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)

				SET @Quantity = 0
			END
			ELSE IF (@StockQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @StockQty
			
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@StockQty,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID
				
				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

--New Products FIFO END




	--***************************************
	--*********SR visit Update***************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0


	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH

--------------------------------
-------------Rizve--------------
----------08-05-2024------------


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[GetDatewiseCustomerDueRptRetail]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(			(
				
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 1
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 1
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return],CashCollectionReturnBank, CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END

----------------------------------------------------------------------

/****** Object:  StoredProcedure [dbo].[GetDatewiseCustomerDueRpt]    Script Date: 5/8/2024 2:28:13 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseCustomerDueRpt]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CashCollectionReturnBank, 0)
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturnBank,0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CashCollectionReturnBank, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount,CashCollectionReturnBank

		)
	) piv
 END
GO





-----------------------------------------------------------------------------------

/****** Object:  StoredProcedure [dbo].[GetDatewiseCustomerDueRptDealer]    Script Date: 5/8/2024 4:22:21 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseCustomerDueRptDealer]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0)+ ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 2
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 2
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID



	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn, CashCollectionReturnBank,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
GO





---------------------------------------------------------------------------------------------

/****** Object:  StoredProcedure [dbo].[GetDatewiseCustomerDueRptHire]    Script Date: 5/8/2024 4:56:11 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseCustomerDueRptHire]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 3
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 3
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionReturnBank,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
GO







------------------------------------------------------------------------------------------




/****** Object:  StoredProcedure [dbo].[GetDatewiseCustomerDueRptBranch]    Script Date: 5/8/2024 4:59:48 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseCustomerDueRptBranch]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 4
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 4
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
GO


--------------------------------
-------------Rizve--------------
----------12-05-2024------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnbank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnbank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue',
		ISNULL(piv.InterestAmount, 0) as TInterestAmount,
		ISNULL(piv.CrInterestAmount, 0) as CrInterestAmount



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL



	--start here 



	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 1 
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND css.PaymentStatus = 'Paid'
	AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cc.TransactionType IN(1)
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (c.CreditDue + c.TotalDue  != 0)
	AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnbank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	 AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND c.CreditDue + c.TotalDue  != 0
	AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return],CashCollectionReturnbank, CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END


 --EXEC GetDatewiseCustomerDue 5213, 0, '2023-10-23'
GO



====================================================================================================

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseBankBalance]
(
		@concernId INT,
		@BankId INT,
		@asOnDate datetime,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.BankID,
		(
			(
				ISNULL(piv.FundIN, 0) 
				+ ISNULL(piv.AnotherFundIN, 0) + ISNULL(piv.OpeningDue, 0)
			)
			-
			(
				ISNULL(piv.FundOut, 0)
			)
		) 'TotalDue'

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningBalance, 0)) PrevSales, 'OpeningDue' Id, c.BankID FROM Banks c 
	WHERE c.ConcernID = @ConcernID
	AND (@BankId = 0 OR c.BankID = @BankId)
	GROUP BY c.BankID, c.BankName
	UNION ALL
	--start here 
	

	-- end here
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.BankID  FROM
	(
	SELECT bt.Amount PrevSales, 'FundIN' Id, bt.BankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.BankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN(1, 3, 9, 7, 10)
	AND (@BankId = 0 OR bt.BankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.BankID, bt.Amount, bt.TransactionNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.BankID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.AnotherBankID  FROM
	(
	SELECT bt.Amount PrevSales, 'AnotherFundIN' Id, bt.AnotherBankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.AnotherBankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN(5)
	AND (@BankId = 0 OR bt.AnotherBankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.AnotherBankID, bt.Amount, bt.TransactionNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.AnotherBankID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.BankID  FROM
	(
	SELECT bt.Amount PrevSales, 'FundOut' Id, bt.BankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.BankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN (2, 4, 8, 6, 5, 11)
	AND (@BankId = 0 OR bt.BankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.BankID, bt.Amount, bt.TransactionNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.BankID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			FundIN, FundOut, AnotherFundIN,OpeningDue

		)
	) piv
 END
GO


====================================================================================================



SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetCategorywiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT
		,@isOnlyDue BIT
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.HireReturn, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)+ ISNULL(piv.HireReturn, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue',
		ISNULL(piv.InterestAmount, 0) as TInterestAmount,
		ISNULL(piv.CrInterestAmount, 0) as CrInterestAmount



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL



	--start here 



	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	--UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0)) 
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0)) 
	AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'HireReturn', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	 AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return],CashCollectionReturnBank, CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount, HireReturn

		)
	) piv
 END


 --EXEC GetCategorywiseCustomerDue 5213, 0, 1
GO

--------------------------------
-------------Rizve--------------
----------08-05-2024------------


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[GetDatewiseCustomerDueRptRetail]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(			(
				
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 1
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 1
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return],CashCollectionReturnBank, CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END

----------------------------------------------------------------------

/****** Object:  StoredProcedure [dbo].[GetDatewiseCustomerDueRpt]    Script Date: 5/8/2024 2:28:13 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseCustomerDueRpt]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CashCollectionReturnBank, 0)
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0) + ISNULL(piv.CashCollectionReturnBank,0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CashCollectionReturnBank, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount,CashCollectionReturnBank

		)
	) piv
 END
GO





-----------------------------------------------------------------------------------

/****** Object:  StoredProcedure [dbo].[GetDatewiseCustomerDueRptDealer]    Script Date: 5/8/2024 4:22:21 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseCustomerDueRptDealer]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0)+ ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 2
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 2
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturnBank' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID



	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn, CashCollectionReturnBank,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
GO





---------------------------------------------------------------------------------------------

/****** Object:  StoredProcedure [dbo].[GetDatewiseCustomerDueRptHire]    Script Date: 5/8/2024 4:56:11 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseCustomerDueRptHire]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0)+ ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionReturnBank, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 3
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 3
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM BankTransactions cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(11) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionReturnBank,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
GO







------------------------------------------------------------------------------------------




/****** Object:  StoredProcedure [dbo].[GetDatewiseCustomerDueRptBranch]    Script Date: 5/8/2024 4:59:48 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[GetDatewiseCustomerDueRptBranch]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 4
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 4
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.TransactionDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
GO


-------------Nahid--------------
----------04-05-2024------------
--------------------------------

CREATE PROC [dbo].[UpdateTotalDueCustomerPaymentReturn]
(
	@CusId int,
	@BankDepositId int,
	@BankWithdrawId int,
	@CollectionAmount decimal(18,2)
)
  
AS 

 IF(@CusId>0)
BEGIN
	UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + @CollectionAmount)
	where CustomerID=@CusId
END


 IF(@BankDepositId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount + @CollectionAmount)
	where BankID=@BankDepositId
END
  
 IF(@BankWithdrawId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount - @CollectionAmount)
	where BankID=@BankWithdrawId
END

RETURN
----------------------------------------------------------------------------------------------------------------------------------

ALTER PROC [dbo].[sp_BankTransReportNew]
(
@FromDate datetime,
@ToDate datetime,
@BankID int,
@ConcernId INT
)
as

Create table #temp (
ConcernID int,ConcernName varchar(250),BankID int,BankName varchar(250),AccountNO varchar(250),
AccountName varchar(250),TransDate DATETIME,TransactionNo varchar(250),ChecqueNo varchar(250),Amount decimal(18,2),
FromTOAccountNo varchar(250),Remarks varchar(250),TransType varchar(250))

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5,
--Bank Expense =6,
--Bank Income = 7,
--LiaPay = 8,
--LiaRec =9,
--Return From Supplier = 10

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Deposit' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=1 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Withdraw' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=2  and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
c.Name as FromTOAccountNo,bt.Remarks,'Cash Collection' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Customers c on bt.CustomerID = c.CustomerID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=3 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
sup.Name as FromTOAccountNo,bt.Remarks,'Cash Delivery' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Suppliers sup on bt.SupplierID = sup.SupplierID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=4 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
ab.AccountName+' ('+ab.AccountNo+')' as FromTOAccountNo,bt.Remarks,'Fund In' from Banks b 
join BankTransactions bt on b.BankID = bt.AnotherBankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Banks ab on bt.BankID = ab.BankID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=5 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
ab.AccountName+' ('+ab.AccountNo+')' as FromTOAccountNo,bt.Remarks,'Fund Out' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Banks ab on bt.AnotherBankID = ab.BankID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=5 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Bank Expense' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=6 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Bank Income' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=7 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Liability Pay' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=8 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Liability Receive' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=9 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
sup.Name as FromTOAccountNo,bt.Remarks,'Retrun from Supplier' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Suppliers sup on bt.SupplierID = sup.SupplierID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=10 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)



insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
c.Name as FromTOAccountNo,bt.Remarks,'Customer Collection Return' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Customers c on bt.CustomerID = c.CustomerID
where (@ConcernId = 0 OR bt.ConcernID = @ConcernId) AND
(@BankID = 0 OR b.BankID=@BankID) and bt.TransactionType=11 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

select * from #temp order by TransDate desc

---------------------------------------------------------------------------------------------------------------------------------------

-------------Nahid--------------
----------02-05-2024------------
--------------------------------
CREATE PROC [dbo].[UpdateTotalDueWhenEditReturnType]
(
	@CusId int,
	@SupId int,
	@CashCollectionID int,
	@NewCollectionAmount DECIMAL(18,2)
)
  
AS 
Declare @Amount decimal
Declare @PreviousCustomerID int,
		@TransactionType INT

BEGIN TRY
BEGIN TRANSACTION

IF(@CusId>0)
BEGIN
    Select @Amount=(Amount+AdjustAmt) from CashCollections where CashCollectionID=@CashCollectionID
	Select @PreviousCustomerID=CustomerID from CashCollections where CashCollectionID=@CashCollectionID
	SELECT @TransactionType = TransactionType from CashCollections where CashCollectionID=@CashCollectionID
	BEGIN
		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue - @Amount)
		where CustomerID=@PreviousCustomerID



		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + @NewCollectionAmount)
		where CustomerID=@CusId
	END

	
END
ELSE IF(@SupId>0)
BEGIN
    Select @Amount=(Amount+AdjustAmt) from CashCollections where CashCollectionID=@CashCollectionID
    Select @PreviousCustomerID=SupplierID from CashCollections where CashCollectionID=@CashCollectionID
	SELECT @TransactionType = TransactionType from CashCollections where CashCollectionID=@CashCollectionID

	BEGIN
		UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - @Amount)
		where SupplierID=@PreviousCustomerID



		UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue + @NewCollectionAmount)
		where SupplierID=@SupId
	END
END

COMMIT

RETURN 1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		RETURN 0;
END CATCH

-------------Nahid--------------
----------19-02-2024------------
--------------------------------

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	BackDateEntry int NULL
GO
ALTER TABLE dbo.SystemInformations ADD CONSTRAINT
	DF_SystemInformations_BackDateEntry DEFAULT ((7)) FOR BackDateEntry
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT



-------------Nahid--------------
----------13-02-2024------------
--------------------------------

ALTER TABLE dbo.POrders ADD
	TPQty decimal(18, 2) NOT NULL CONSTRAINT DF_POrders_TPQty DEFAULT ((0))
GO

---------------------------------------------------------------------------------------------------------------------------


EXEC sys.sp_rename 'dbo.InsertPurchaseOrderTable', 'zInsertPurchaseOrderTable';
GO

CREATE TYPE [dbo].[InsertPurchaseOrderTable] AS TABLE(
	[OrderDate] [datetime] NULL,
	[ChallanNo] [varchar](150) NULL,
	[SupplierId] [int] NULL,
	[GrandTotal] [decimal](18, 2) NULL,
	[TDiscount] [decimal](18, 2) NULL,
	[TotalAmt] [decimal](18, 2) NULL,
	[RecAmt] [decimal](18, 2) NULL,
	[PaymentDue] [decimal](18, 2) NULL,
	[TotalDue] [decimal](18, 2) NULL,
	[AdjAmount] [decimal](18, 2) NULL,
	[Status] [int] NULL,
	[PPTDisAmt] [decimal](18, 2) NULL,
	[NetDiscount] [decimal](18, 2) NULL,
	[LabourCost] [decimal](18, 2) NULL,
	[ConcernId] [int] NULL,
	[CreateDate] [datetime] NULL,
	[CreatedBy] [int] NULL,
	[IsDamageOrder] [int] NULL,
	[Remarks] [varchar](150) NULL,
	[InvoiceNo] [varchar](150) NULL,
	[TPQty] [varchar](150) NULL,
	[Field1] [nvarchar](max) NULL,
	[Field2] [nvarchar](max) NULL,
	[Field3] [decimal](18, 2) NULL,
	[Field4] [decimal](18, 2) NULL,
	[Field5] [int] NULL,
	[Field6] [int] NULL
)
GO

DECLARE @Name NVARCHAR(776);

DECLARE REF_CURSOR CURSOR FOR
SELECT referencing_schema_name + '.' + referencing_entity_name
FROM sys.dm_sql_referencing_entities('dbo.InsertPurchaseOrderTable', 'TYPE');

OPEN REF_CURSOR;

FETCH NEXT FROM REF_CURSOR INTO @Name;
WHILE (@@FETCH_STATUS = 0)
BEGIN
    EXEC sys.sp_refreshsqlmodule @name = @Name;
    FETCH NEXT FROM REF_CURSOR INTO @Name;
END;

CLOSE REF_CURSOR;
DEALLOCATE REF_CURSOR;
GO
DROP TYPE dbo.zInsertPurchaseOrderTable;
GO


-----------------------------------------------------------------------------------------------------------------------------------

ALTER PROC [dbo].[AddPurchaseOrder] (
	@PurchaseOrder [InsertPurchaseOrderTable] readonly
	,@PODetails [InsertPODetailTable] readonly
	,@POProductDetails [InsertPOProductDetailTable] readonly
	,@Stocks [InsertStockTable] readonly
	,@StockDetails [InsertStockDetailTable] readonly,
	@PorderID int out,
	@Result int Out
	)
AS
DECLARE @PurchaseOrderId INT
DECLARE @GrandTotal DECIMAL(18, 2)
		,@NetDiscount DECIMAL(18, 2)
		,@FlatDis DECIMAL(18, 2)
		,@Adjustment DECIMAL(18, 2)

--***************Product Type*****************
--ExistingBC = 1,
--NoBarcode = 2,
--AutoBC = 3
--***************Product Type*****************

BEGIN TRY
	BEGIN TRANSACTION

	INSERT INTO POrders (
		OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPDisAmt
		,NetDiscount
		,LaborCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		) (
		SELECT OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPTDisAmt
		,NetDiscount
		,LabourCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks
		,InvoiceNo
		,TPQty
		 FROM @PurchaseOrder
		)

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue + p.PaymentDue)
	FROM @PurchaseOrder p
	JOIN Suppliers ON Suppliers.SupplierID = p.SupplierId
	WHERE p.IsDamageOrder != 1

	SET @PurchaseOrderId = SCOPE_IDENTITY()
	SET @GrandTotal = ISNULL((
				SELECT GrandTotal
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @NetDiscount = ISNULL((
				SELECT NetDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @FlatDis = ISNULL((
				SELECT TDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
    SET @Adjustment = ISNULL((
				SELECT AdjAmount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)

	INSERT INTO PriceProtections (
		ProductID
		,ColorID
		,PrvPrice
		,ChangePrice
		,POrderID
		,ConcernID
		,SupplierID
		,PrvStockQty
		,PChangeDate
		) (
		SELECT stk.ProductId
		,stk.ColorId
		,stk.MRPPrice
		,stkt.MRPPrice
		,@PurchaseOrderId
		,stk.ConcernID
		,(
			SELECT SupplierId
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,stk.Quantity
		,GETDATE() FROM @Stocks stkt INNER JOIN Stocks stk ON stk.ProductID = stkt.ProductId
		AND stk.ColorID = stkt.ColorId WHERE stk.MRPPrice > stkt.MRPPrice
		)

	INSERT INTO POrderDetails (
		ProductID
		,ColorID
		,Quantity
		,UnitPrice
		,TAmount
		,PPDISPer
		,PPDISAmt
		,MRPRate
		,POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOFFER
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownID
		) (
		SELECT ProductId
		,ColorId
		,Quantity
		,UnitPrice
		,TAmount
		,PPDisPer
		,PPDisAmt
		,MrpRate
		,@PurchaseOrderId POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOffer
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownId FROM @PODetails
		)

	INSERT INTO POProductDetails (
		ProductID
		,ColorID
		,IMENO
		,POrderDetailID
		,DamagePOPDID
		) (
		SELECT POPD.ProductId
		,POPD.ColorId
		,POPD.IMENo
		,POD.POrderDetailID
		,DamagePOPDID FROM @POProductDetails POPD INNER JOIN POrderDetails POD ON POD.ProductID = POPD.ProductId
		AND POD.ColorID = POPD.ColorId
		AND POD.POrderID = @PurchaseOrderId
		)

	UPDATE POProductDetails
	SET IsDamageReplaced = 1
	FROM @POProductDetails dtPOPD
	JOIN POProductDetails POPD ON dtPOPD.DamagePOPDID = POPD.POPDID

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity + s.Quantity)
		,Stocks.MRPPrice = s.MRPPrice
		,LPPrice = s.LPPrice
		,ModifiedBy = s.CreatedBy
		,ModifiedDate = s.CreateDate
	FROM @Stocks s
	JOIN Stocks ON Stocks.StockID = s.StockID

	INSERT INTO Stocks (
		StockCode
		,EntryDate
		,Quantity
		,ProductID
		,ColorID
		,MRPPrice
		,LPPrice
		,ConcernID
		,CreatedBy
		,CreateDate
		,GodownID
		) (
		SELECT StockCode
		,EntryDate
		,Quantity
		,ProductId
		,ColorId
		,MRPPrice
		,LPPrice
		,ConcernId
		,CreatedBy
		,CreateDate
		,GodownId FROM @Stocks WHERE StockId IS NULL
		)

	--************For Nobarcode*****************
	INSERT INTO StockDetails (
		StockID
		,StockCode
		,ProductID
		,ColorID
		,POrderDetailID
		,IMENO
		,STATUS
		,PRate
		,SRate
		,CreditSRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,Quantity
		,GodownID
		) (
		SELECT stk.StockID
		,stkd.StockCode
		,stkd.ProductId
		,stkd.ColorId
		,POD.POrderDetailID
		,stkd.IMENo
		,stkd.STATUS
		,(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment))))
		,stkd.SalesRate
		,stkd.CreditSRate
		,POD.CRSalesRate12Month
		,POD.CRSalesRate3Month
		,POD.Quantity
		,stkd.GodownId FROM @StockDetails stkd INNER JOIN Stocks stk ON stk.ProductID = stkd.ProductId
		AND stk.ColorID = stkd.ColorID
		AND stk.GodownID = stkd.GodownId INNER JOIN POrderDetails POD ON POD.ProductID = stkd.ProductId
		AND POD.ColorID = stkd.ColorId
		AND POD.GodownID = stkd.GodownID
		AND POD.POrderID = @PurchaseOrderId INNER JOIN Products P ON P.ProductID = stk.ProductID WHERE P.ProductType = 2
		)

	--************For Nobarcode*****************
	--************For barcode*******************
	INSERT INTO StockDetails (
		StockID
		,StockCode
		,ProductID
		,ColorID
		,POrderDetailID
		,IMENO
		,STATUS
		,PRate
		,SRate
		,CreditSRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,Quantity
		,GodownID
		) (
		SELECT stk.StockID
		,stkd.StockCode
		,stkd.ProductId
		,stkd.ColorId
		,POD.POrderDetailID
		,stkd.IMENo
		,stkd.STATUS
		,(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment))))
		,stkd.SalesRate
		,stkd.CreditSRate
		,POD.CRSalesRate12Month
		,POD.CRSalesRate3Month
		,0
		,stkd.GodownId FROM @StockDetails stkd INNER JOIN Stocks stk ON stk.ProductID = stkd.ProductId
		AND stk.ColorID = stkd.ColorID
		AND stk.GodownID = stkd.GodownId INNER JOIN POrderDetails POD ON POD.ProductID = stkd.ProductId
		AND POD.ColorID = stkd.ColorId
		AND POD.GodownID = stkd.GodownId
		AND POD.POrderID = @PurchaseOrderId INNER JOIN Products P ON P.ProductID = stk.ProductID WHERE P.ProductType != 2
		)

	--************For barcode*******************
	COMMIT
	SELECT @PorderID=@PurchaseOrderId,@Result=1;
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		ROLLBACK

	SELECT @PorderID=0,@Result=0
	--RETURN 0;
END CATCH

-------------Nahid--------------
----------17-01-2024------------
--------------------------------


--EXEC sp_DailyCashInHand  '11 MAY 2021 12:00:00 AM','11 MAY 2021 11:59:59 PM',16
ALTER procedure [dbo].[sp_DailyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-08-01'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)



create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(DAY, 1, Convert(date, GetDate()))
begin
	print @StartDate

	delete
	from #temp_Data1

	delete
	from #temp_Data2

	--	DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
	--	DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
	------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
	insert into #temp_Data1
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
				and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
		from POrders po
		join Suppliers s on po.SupplierID = s.SupplierID
		where po.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
		and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and po.RecAmt>0
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
	---------------------------------Expense from Bank Deposit--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

	END

	---------------------------------Expense from Bank Loan--------------------
	set @total = isnull((
				SELECT SUM(ISNULL(BC.CollectionAmount, 0) + ISNULL(BC.SDPS, 0) + ISNULL(BC.Savings,0)) FROM dbo.BankLoanCollections BC
				JOIN dbo.BankLoanDetails BLD ON BC.Id = BLD.LoanCollectionId
				JOIN  dbo.BankLoans BL ON BLD.BankLoanId = BL.Id
				JOIN dbo.Banks B ON BL.BankId = B.BankID
				where BL.ConcernID = @ConcernID AND BLD.LoanCollectionId IS NOT NULL
				AND CAST(BC.CollectionDate AS DATE) = CAST(@StartDate AS DATE)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Loan Payment', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ', ' + B.BankName, SUM(ISNULL(BC.CollectionAmount, 0) + ISNULL(BC.SDPS, 0) + ISNULL(BC.Savings,0)), 'Bank Loan', 0, 'Cash'
		FROM dbo.BankLoanCollections BC
		JOIN dbo.BankLoanDetails BLD ON BC.Id = BLD.LoanCollectionId
		JOIN  dbo.BankLoans BL ON BLD.BankLoanId = BL.Id
		JOIN dbo.Banks B ON BL.BankId = B.BankID
		where BL.ConcernID = @ConcernID AND BLD.LoanCollectionId IS NOT NULL
		AND CAST(BC.CollectionDate AS DATE) = CAST(@StartDate AS DATE)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Loan Payment', @total, '', 0, 'Header'

	END
	---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------


	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Collections', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	inner join Customers c on BT.CustomerID = c.CustomerID
	where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
	group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	insert into #temp_Data1
	select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
	---------------------------------Expens from Bank Cash Delivery---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Cash Delivery', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END

---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Income', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Income (Cr))', sum(Amount), 'Bank Income ', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Income ', @total, '', 0, 'Header'
END


	---------------------------------Expense from Fund Out---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections cc
				join Suppliers s on cc.SupplierID = s.SupplierID
				where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
				and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
		and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
	------------------------------------------------------Expense in Product return----------------------------------
	set @total = isnull((
				select sum(PaidAmount)
				from ROrders
				where ConcernID = @ConcernID and DAY(Convert(date, ReturnDate)) = DAY(@StartDate) and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

END

	-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3 AND CustomerID > 0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Customer Cash Collection Return', @total, 'Customer Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

	------------- -------------------------------------------- Direct Expense--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' and EX.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' and EX.CashInHandReportStatus = 0
		and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description

		insert into #temp_Data1
		select @StartDate,'Total Expense', @total, '', 0, 'Header'
	end

		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID  and DAY(Convert(date, TransactionDate)) = DAY(@StartDate)
				and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and DAY(Convert(date, TransactionDate)) = DAY(@StartDate)
		and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
	------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
						where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end



	-- ----------------------------Expens from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=3  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END
	----------------------------------------------Opening Cash In Hand in Income Table--------------------------------------------------------------- 
	insert into #temp_Data2
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	-----------------------------------------------Income in Sales Order-------------------------------------------
	set @total = isnull((
				select sum(RecAmount)
				from SOrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount,Convert(varchar(10),c.CustomerType)+'Order' from SOrders so
		join Customers c on so.CustomerID = c.CustomerID
		where so.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
	    insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
   
   END
	---------------------------------Income from Bank Withdwal--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

				---------------------------------Income from Bank Expens as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Expens as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Bank Expens(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Loan--------------------
	set @total = ISNULL((
				SELECT SUM(BL.PrincipleLoanAmount) FROM dbo.BankLoans BL
				JOIN dbo.Banks B ON BL.BankId = B.BankID
				WHERE BL.ConcernId = @ConcernID
				AND CAST(BL.LoanDate AS DATE) = CAST(@StartDate AS DATE)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Loan', 0, 'Header'

		insert into #temp_Data2
		select @StartDate, '', 0, B.AccountNo + ',' + B.BankName, SUM(BL.PrincipleLoanAmount), 'Cash'
		FROM dbo.BankLoans BL
		JOIN dbo.Banks B ON BL.BankId = B.BankID
		where BL.ConcernID = @ConcernID
		AND CAST(BL.LoanDate AS DATE) = CAST(@StartDate AS DATE)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Loan', @total, 'Header'

	END


	---------------------------------Income from Bank Cash Collection---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
		('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on bt.CustomerID=c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	----------------------------------------Income from Fund IN------------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.AnotherBankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.AnotherBankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-- ---------------------------------------Income from Cash Collection from Customer-------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
				), 0)

	if (@total != 0)
	BEGIN
	insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, Convert(varchar(10),c.CustomerType)+'Cash'
		from CashCollections cc
		join Customers c on cc.CustomerID = c.CustomerID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
	    insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')
		
		END
	-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
	set @total = isnull((
				select isnull(sum(DownPayment), 0)
				from CreditSales
				where ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
		from CreditSales cs
		join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')
	
	END
	--------------------------------------Income in Purchase Product return----------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and DAY(Convert(date, OrderDate)) = DAY(@StartDate) and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and status = 5
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Purchase Return Cash'

	-------------------------------Income Installment Collection from Creditsales------------------
	set @total = isnull((
				select sum(InstallmentAmt)
				from CreditSalesSchedules css
				inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
				where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
		from CreditSalesSchedules css
		inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
		inner join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
	  
	  insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')
	
	END
	-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Description, sum(Amount), E.Description
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 2 and  EX.CashInHandReportStatus = 0 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')
	
	end

	-----------------------------------Income from Return From Supplier------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from CashCollections EX
						inner join Suppliers  E on E.SupplierID = EX.SupplierID
						where E.ConcernID = @ConcernID and EX.TransactionType = 3 
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Return From Supplier', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Name, sum(Amount), E.Name
		from CashCollections EX
		inner join Suppliers E on E.SupplierID = EX.SupplierID
		where E.ConcernID = @ConcernID and EX.TransactionType = 3  and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Name
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Total Return From Supplier',@total, 'Header')
	
	end

	-- ----------------------------Income from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
	END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
	-----------------------------------------------------------------------------------------------------------------------------------
	   SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)
	IF (@total != 0)
	BEGIN
		INSERT INTO #temp_Data2
		SELECT @StartDate, '', 0.00,SIH.Name+'(Current Asset)',  sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name

		insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')
	END

	insert into #temp_Data3
	select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), '', 0.00,  ''
	from #temp_Data1 T1
	UNION ALL
	select @StartDate, 0,  '', 0, isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
	from #temp_Data2 T2

	declare @a decimal(18, 2)
	declare @b decimal(18, 2)
	declare @ExpenseWithinDate decimal(18, 2)
	declare @IncomeWithinDate decimal(18, 2)
	declare @CashInHandWithinDate decimal(18, 2)

	set @a = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @b = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @ExpenseWithinDate = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @IncomeWithinDate = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
	set @CashInHand = @CashInHand + (@b - @a)

	insert into #temp_Data3
	values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

	insert into #temp_Data3
	values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

	insert into #temp_Data3
	values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

	set @StartDate = DATEADD(DAY, 1, @StartDate)
	--select *From #temp_Data1
	--select *From #temp_Data2
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

-------------------------------------------------------------------------------------------------------------------------------------


--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_MonthlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0


if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-06-09'
set @CashInHand=26500
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(MONTH, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate)
and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

insert into #temp_Data1
select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
from POrders po
join Suppliers s on po.SupplierID = s.SupplierID
where po.ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate)
and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate and po.RecAmt>0
group by s.SupplierID,s.Name

insert into #temp_Data1
select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 1  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank collections', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Customer Collection(Cr))', sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Cash Delivery', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 4 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END
---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections cc 
join Suppliers s on cc.SupplierID = s.SupplierID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) 
and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(cc.amount), 'Due Collection', 0, 'Cash'
		from CashCollections cc 
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) 
		and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
	-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3 AND CustomerID > 0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Customer Cash Collection Return', @total, 'Customer Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'
END
------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID 
				and  Month(Convert(date, InvoiceDate)) = Month(@StartDate)
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Retail/Dealer', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID 
	and  Month(Convert(date, InvoiceDate)) = Month(@StartDate)
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Retail/Dealere', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID 
			    and  Month(Convert(date, SalesDate)) = Month(@StartDate)
				and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Hire', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID 
	    and  Month(Convert(date, SalesDate)) = Month(@StartDate)
		and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Hire', 0, '', 0, 'Header'
	END
------------- -------------------------------------------- Direct Expense--------------------------------------------
set @total=isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)

if(@total) != 0
begin
	insert into #temp_Data1
	select @StartDate,'Expense', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
	from Expenditures EX
	inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
	where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
	group by E.Description

	insert into #temp_Data1
	select @StartDate,'Total Expense', @total, '', 0, 'Header'
end
		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID  and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate)  and  TransactionDate>= @InitailDate
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0 and  TransactionDate>= @InitailDate
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
					    where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end


-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2 AND    SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
 END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END

----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1  and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
  
  END
---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1 and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1  and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0
						and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

	-----------------------------------Income from Return From Supplier------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from CashCollections EX
						inner join Suppliers  E on E.SupplierID = EX.SupplierID
						where E.ConcernID = @ConcernID and EX.TransactionType = 3 
						and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Return From Supplier', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Name, sum(Amount), E.Name
		from CashCollections EX
		inner join Suppliers E on E.SupplierID = EX.SupplierID
		where E.ConcernID = @ConcernID and EX.TransactionType = 3 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Name
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Total Return From Supplier',@total, 'Header')
	
	end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name

 insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')

 END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
------------------------------------------------------------------------------------------------------------------------------------------------------

 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END
 ------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(MONTH, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

-------------------------------------------------------------------------------------------------------------------------------------


--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_YearlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-02-09'


if (@ConcernID = 1)
	set @CashInHand = 1263.00
else if (@ConcernID = 5)
	set @CashInHand = 8755.00
else if (@ConcernID = 6)
	set @CashInHand = - 2.00
else if (@ConcernID = 4)
	set @CashInHand = 65000.00
else if (@ConcernID = 20)
BEGIN
	set @CashInHand = 137340.00
	set @StartDate = '2020-03-12'
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END


set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(YEAR, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

insert into #temp_Data1
select @StartDate, s.Name, sum(po.recAmt), 'Cash Sales', 0, 'Order'
from POrders po
join Suppliers s on po.SupplierID = s.SupplierID
where po.ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
 and po.RecAmt>0
group by s.SupplierID,s.Name

insert into #temp_Data1
select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 1   and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate,'Bank collections', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Customer Collection(Cr))', sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 3  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Cash Delivery', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 4  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END
---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections cc 
join Suppliers s on cc.SupplierID = s.SupplierID
where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,  s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc 
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate 
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3 AND CustomerID > 0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Customer Cash Collection Return', @total, 'Customer Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID 
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Retail/Dealer', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID 
		and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Retail/Dealere', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID 
				and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Hire', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID 
		and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Hire', 0, '', 0, 'Header'
	END

------------- -------------------------------------------- Direct Expense--------------------------------------------
set @total =isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)

if (@total) != 0
begin
insert into #temp_Data1
select @StartDate,'Expense', 0, '', 0, 'Header'

insert into #temp_Data1
select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description

insert into #temp_Data1
select @StartDate,'Total Expense', @total, '', 0, 'Header'

end

		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID and Year(Convert(date, TransactionDate)) = Year(@StartDate)  and  TransactionDate>= @InitailDate
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0 and  TransactionDate>= @InitailDate
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
						where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end


-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0
 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE  SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
 END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END


----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1  and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')

END
---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1  and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1   and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID  and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0
						and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

	-----------------------------------Income from Return From Supplier------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from CashCollections EX
						inner join Suppliers  E on E.SupplierID = EX.SupplierID
						where E.ConcernID = @ConcernID and EX.TransactionType = 3 
						AND Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Return From Supplier', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Name, sum(Amount), E.Name
		from CashCollections EX
		inner join Suppliers E on E.SupplierID = EX.SupplierID
		where E.ConcernID = @ConcernID and EX.TransactionType = 3 and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Name
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Total Return From Supplier',@total, 'Header')
	
	end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1   AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
 END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
------------------------------------------------------------------------------------------------------------------------------------------------------

 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE  SIH.ParentId=2  and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END
------------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)

set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(YEAR, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)
-------------------------------------------------------------------------------------------------------------------------------------
-------------Nahid--------------
----------16-01-2024------------
--------------------------------

ALTER PROC [dbo].[GetDatewiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue',
		ISNULL(piv.InterestAmount, 0) as TInterestAmount,
		ISNULL(piv.CrInterestAmount, 0) as CrInterestAmount



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL



	--start here 



	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 1 
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND css.PaymentStatus = 'Paid'
	AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cc.TransactionType IN(1)
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	UNION ALL
	SELECT ISNULL(SUM(r.AdjDue), 0), 'Return', c.CustomerID FROM HireSalesReturnCustomerDueAdjustment r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (c.CreditDue + c.TotalDue  != 0)
	AND CAST(r.TransactionDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	 AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND c.CreditDue + c.TotalDue  != 0
	AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END


 --EXEC GetDatewiseCustomerDue 5213, 0, '2023-10-23'

-------------------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[GetDatewiseFixedAssestBalance]
(
		@concernId INT,
		@FixedHeadId INT,
		@asOnDate datetime,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.SIHID,
		(
			(
				ISNULL(piv.AddFixedAssestAmt, 0) + ISNULL(piv.OpeningDue, 0)
			)
		) 'TotalDue'

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningBalance, 0)) PrevSales, 'OpeningDue' Id, c.SIHID FROM ShareInvestmentHeads c 
	WHERE c.ConcernID = @ConcernID AND c.Balance  != 0 AND c.ParentId = 1
	AND (@FixedHeadId = 0 OR c.SIHID = @FixedHeadId)
	GROUP BY c.SIHID, c.Name
	UNION ALL
	--start here 
	

	-- end here
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SIHID  FROM
	(
	SELECT bt.Amount PrevSales, 'AddFixedAssestAmt' Id, bt.SIHID FROM dbo.ShareInvestments bt
	JOIN ShareInvestmentHeads b ON bt.SIHID = b.SIHID
	WHERE bt.ConcernID = @concernId AND b.ParentId = 1 AND
	bt.TransactionType IN(1) AND bt.LiabilityType = 0
	AND (@FixedHeadId = 0 OR bt.SIHID = @FixedHeadId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.SIHID, bt.Amount, bt.SIID, bt.Purpose
	) tblPO
	GROUP BY tblPO.Id, tblPO.SIHID


	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			AddFixedAssestAmt,OpeningDue

		)
	) piv
 END
-------------------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[GetDatewiseSecurityBalance]
(
		@concernId INT,
		@SceHeadId INT,
		@asOnDate datetime,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.SIHID,
		(
			(
				ISNULL(piv.TakeSecurity, 0) 
			)
			-
			(
				ISNULL(piv.GiveSecurity, 0) + ISNULL(piv.OpeningDue, 0)
			)
		) 'TotalDue'

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningBalance, 0)) PrevSales, 'OpeningDue' Id, c.SIHID FROM ShareInvestmentHeads c 
	WHERE c.ConcernID = @ConcernID AND c.ParentId = 6
	AND (@SceHeadId = 0 OR c.SIHID = @SceHeadId)
	GROUP BY c.SIHID, c.Name
	UNION ALL
	--start here 
	

	-- end here
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SIHID  FROM
	(
	SELECT bt.Amount PrevSales, 'TakeSecurity' Id, bt.SIHID FROM dbo.ShareInvestments bt
	JOIN ShareInvestmentHeads b ON bt.SIHID = b.SIHID
	WHERE bt.ConcernID = @concernId AND b.ParentId = 6 AND
	bt.TransactionType IN(1) AND bt.LiabilityType = 9
	AND (@SceHeadId = 0 OR bt.SIHID = @SceHeadId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.SIHID, bt.Amount, bt.SIID, bt.Purpose
	) tblPO
	GROUP BY tblPO.Id, tblPO.SIHID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SIHID  FROM
	(
	SELECT bt.Amount PrevSales, 'GiveSecurity' Id, bt.SIHID FROM dbo.ShareInvestments bt
	JOIN ShareInvestmentHeads b ON bt.SIHID = b.SIHID
	WHERE bt.ConcernID = @concernId AND b.ParentId = 6 AND
	bt.TransactionType IN(2) AND bt.LiabilityType = 10
	AND (@SceHeadId = 0 OR bt.SIHID = @SceHeadId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.SIHID, bt.Amount, bt.SIID, bt.Purpose
	) tblPO
	GROUP BY tblPO.Id, tblPO.SIHID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			TakeSecurity, GiveSecurity,OpeningDue

		)
	) piv
 END
-------------------------------------------------------------------------------------------------------------------------------------


--EXEC sp_DailyCashInHand  '11 MAY 2021 12:00:00 AM','11 MAY 2021 11:59:59 PM',16
ALTER procedure [dbo].[sp_DailyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-08-01'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)



create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(DAY, 1, Convert(date, GetDate()))
begin
	print @StartDate

	delete
	from #temp_Data1

	delete
	from #temp_Data2

	--	DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
	--	DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
	------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
	insert into #temp_Data1
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
				and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
		from POrders po
		join Suppliers s on po.SupplierID = s.SupplierID
		where po.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
		and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and po.RecAmt>0
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
	---------------------------------Expense from Bank Deposit--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

	END

	---------------------------------Expense from Bank Loan--------------------
	set @total = isnull((
				SELECT SUM(ISNULL(BC.CollectionAmount, 0) + ISNULL(BC.SDPS, 0) + ISNULL(BC.Savings,0)) FROM dbo.BankLoanCollections BC
				JOIN dbo.BankLoanDetails BLD ON BC.Id = BLD.LoanCollectionId
				JOIN  dbo.BankLoans BL ON BLD.BankLoanId = BL.Id
				JOIN dbo.Banks B ON BL.BankId = B.BankID
				where BL.ConcernID = @ConcernID AND BLD.LoanCollectionId IS NOT NULL
				AND CAST(BC.CollectionDate AS DATE) = CAST(@StartDate AS DATE)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Loan Payment', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ', ' + B.BankName, SUM(ISNULL(BC.CollectionAmount, 0) + ISNULL(BC.SDPS, 0) + ISNULL(BC.Savings,0)), 'Bank Loan', 0, 'Cash'
		FROM dbo.BankLoanCollections BC
		JOIN dbo.BankLoanDetails BLD ON BC.Id = BLD.LoanCollectionId
		JOIN  dbo.BankLoans BL ON BLD.BankLoanId = BL.Id
		JOIN dbo.Banks B ON BL.BankId = B.BankID
		where BL.ConcernID = @ConcernID AND BLD.LoanCollectionId IS NOT NULL
		AND CAST(BC.CollectionDate AS DATE) = CAST(@StartDate AS DATE)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Loan Payment', @total, '', 0, 'Header'

	END
	---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------


	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Collections', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	inner join Customers c on BT.CustomerID = c.CustomerID
	where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
	group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	insert into #temp_Data1
	select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
	---------------------------------Expens from Bank Cash Delivery---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Cash Delivery', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END

---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Income', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Income (Cr))', sum(Amount), 'Bank Income ', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Income ', @total, '', 0, 'Header'
END


	---------------------------------Expense from Fund Out---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections cc
				join Suppliers s on cc.SupplierID = s.SupplierID
				where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
				and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
		and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
	------------------------------------------------------Expense in Product return----------------------------------
	set @total = isnull((
				select sum(PaidAmount)
				from ROrders
				where ConcernID = @ConcernID and DAY(Convert(date, ReturnDate)) = DAY(@StartDate) and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

END

	-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Cash Collection Return', @total, 'Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

	------------- -------------------------------------------- Direct Expense--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' and EX.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' and EX.CashInHandReportStatus = 0
		and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description

		insert into #temp_Data1
		select @StartDate,'Total Expense', @total, '', 0, 'Header'
	end

		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID  and DAY(Convert(date, TransactionDate)) = DAY(@StartDate)
				and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and DAY(Convert(date, TransactionDate)) = DAY(@StartDate)
		and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
	------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
						where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end



	-- ----------------------------Expens from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=3  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END
	----------------------------------------------Opening Cash In Hand in Income Table--------------------------------------------------------------- 
	insert into #temp_Data2
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	-----------------------------------------------Income in Sales Order-------------------------------------------
	set @total = isnull((
				select sum(RecAmount)
				from SOrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount,Convert(varchar(10),c.CustomerType)+'Order' from SOrders so
		join Customers c on so.CustomerID = c.CustomerID
		where so.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
	    insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
   
   END
	---------------------------------Income from Bank Withdwal--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

				---------------------------------Income from Bank Expens as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Expens as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Bank Expens(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Loan--------------------
	set @total = ISNULL((
				SELECT SUM(BL.PrincipleLoanAmount) FROM dbo.BankLoans BL
				JOIN dbo.Banks B ON BL.BankId = B.BankID
				WHERE BL.ConcernId = @ConcernID
				AND CAST(BL.LoanDate AS DATE) = CAST(@StartDate AS DATE)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Loan', 0, 'Header'

		insert into #temp_Data2
		select @StartDate, '', 0, B.AccountNo + ',' + B.BankName, SUM(BL.PrincipleLoanAmount), 'Cash'
		FROM dbo.BankLoans BL
		JOIN dbo.Banks B ON BL.BankId = B.BankID
		where BL.ConcernID = @ConcernID
		AND CAST(BL.LoanDate AS DATE) = CAST(@StartDate AS DATE)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Loan', @total, 'Header'

	END


	---------------------------------Income from Bank Cash Collection---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
		('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on bt.CustomerID=c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	----------------------------------------Income from Fund IN------------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.AnotherBankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.AnotherBankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-- ---------------------------------------Income from Cash Collection from Customer-------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
				), 0)

	if (@total != 0)
	BEGIN
	insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, Convert(varchar(10),c.CustomerType)+'Cash'
		from CashCollections cc
		join Customers c on cc.CustomerID = c.CustomerID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
	    insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')
		
		END
	-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
	set @total = isnull((
				select isnull(sum(DownPayment), 0)
				from CreditSales
				where ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
		from CreditSales cs
		join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')
	
	END
	--------------------------------------Income in Purchase Product return----------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and DAY(Convert(date, OrderDate)) = DAY(@StartDate) and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and status = 5
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Purchase Return Cash'

	-------------------------------Income Installment Collection from Creditsales------------------
	set @total = isnull((
				select sum(InstallmentAmt)
				from CreditSalesSchedules css
				inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
				where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
		from CreditSalesSchedules css
		inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
		inner join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
	  
	  insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')
	
	END
	-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Description, sum(Amount), E.Description
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 2 and  EX.CashInHandReportStatus = 0 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')
	
	end

	-----------------------------------Income from Return From Supplier------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from CashCollections EX
						inner join Suppliers  E on E.SupplierID = EX.SupplierID
						where E.ConcernID = @ConcernID and EX.TransactionType = 3 
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Return From Supplier', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Name, sum(Amount), E.Name
		from CashCollections EX
		inner join Suppliers E on E.SupplierID = EX.SupplierID
		where E.ConcernID = @ConcernID and EX.TransactionType = 3  and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Name
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Total Return From Supplier',@total, 'Header')
	
	end

	-- ----------------------------Income from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
	END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
	-----------------------------------------------------------------------------------------------------------------------------------
	   SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)
	IF (@total != 0)
	BEGIN
		INSERT INTO #temp_Data2
		SELECT @StartDate, '', 0.00,SIH.Name+'(Current Asset)',  sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name

		insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')
	END

	insert into #temp_Data3
	select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), '', 0.00,  ''
	from #temp_Data1 T1
	UNION ALL
	select @StartDate, 0,  '', 0, isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
	from #temp_Data2 T2

	declare @a decimal(18, 2)
	declare @b decimal(18, 2)
	declare @ExpenseWithinDate decimal(18, 2)
	declare @IncomeWithinDate decimal(18, 2)
	declare @CashInHandWithinDate decimal(18, 2)

	set @a = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @b = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @ExpenseWithinDate = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @IncomeWithinDate = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
	set @CashInHand = @CashInHand + (@b - @a)

	insert into #temp_Data3
	values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

	insert into #temp_Data3
	values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

	insert into #temp_Data3
	values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

	set @StartDate = DATEADD(DAY, 1, @StartDate)
	--select *From #temp_Data1
	--select *From #temp_Data2
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

-------------------------------------------------------------------------------------------------------------------------------------



--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_MonthlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0


if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-06-09'
set @CashInHand=26500
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(MONTH, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate)
and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

insert into #temp_Data1
select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
from POrders po
join Suppliers s on po.SupplierID = s.SupplierID
where po.ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate)
and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate and po.RecAmt>0
group by s.SupplierID,s.Name

insert into #temp_Data1
select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 1  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank collections', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Customer Collection(Cr))', sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Cash Delivery', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 4 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END
---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections cc 
join Suppliers s on cc.SupplierID = s.SupplierID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) 
and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(cc.amount), 'Due Collection', 0, 'Cash'
		from CashCollections cc 
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) 
		and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'
END
------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID 
				and  Month(Convert(date, InvoiceDate)) = Month(@StartDate)
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Retail/Dealer', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID 
	and  Month(Convert(date, InvoiceDate)) = Month(@StartDate)
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Retail/Dealere', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID 
			    and  Month(Convert(date, SalesDate)) = Month(@StartDate)
				and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Hire', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID 
	    and  Month(Convert(date, SalesDate)) = Month(@StartDate)
		and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Hire', 0, '', 0, 'Header'
	END
------------- -------------------------------------------- Direct Expense--------------------------------------------
set @total=isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)

if(@total) != 0
begin
	insert into #temp_Data1
	select @StartDate,'Expense', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
	from Expenditures EX
	inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
	where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
	group by E.Description

	insert into #temp_Data1
	select @StartDate,'Total Expense', @total, '', 0, 'Header'
end
		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID  and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate)  and  TransactionDate>= @InitailDate
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0 and  TransactionDate>= @InitailDate
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
					    where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end


-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2 AND    SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
 END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END

----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1  and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
  
  END
---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1 and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1  and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0
						and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

	-----------------------------------Income from Return From Supplier------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from CashCollections EX
						inner join Suppliers  E on E.SupplierID = EX.SupplierID
						where E.ConcernID = @ConcernID and EX.TransactionType = 3 
						and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Return From Supplier', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Name, sum(Amount), E.Name
		from CashCollections EX
		inner join Suppliers E on E.SupplierID = EX.SupplierID
		where E.ConcernID = @ConcernID and EX.TransactionType = 3 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Name
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Total Return From Supplier',@total, 'Header')
	
	end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name

 insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')

 END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
------------------------------------------------------------------------------------------------------------------------------------------------------

 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END
 ------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(MONTH, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)
-------------------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[sp_TrialBalance]
(
  @FromDate datetime,
  @ToDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int)



--****************************************************
--***************Debit Start**************************
--****************************************************

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Cash at Banks', ISNULL(sum(TotalAmount),0.0),0.00,1 from Banks
--where ConcernID=@ConcernID

------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)
--set @OpeningBalance = ISNULL((select sum(Amount)from ShareInvestments i
--JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
--JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
--where i.ConcernID=@ConcernID AND ih.Name LIKE 'Opening%' AND (p.Name='Current Asset' OR p.Name='Fixed Asset')),0.00)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

----direct expense
--set @TotalExpense =ISNULL((
--select SUM(Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1),0)

----cash delivery
--set @TotalExpense =@TotalExpense+ISNULL((
--select sum(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

----sales return
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4
--),0)

-----cash purchase
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID
--),0)

----cash deposite
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID
--),0)

-------------------Income----------------

----cash collection
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

----installment collections
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(css.InstallmentAmt) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

----direct income
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(ex.Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2
--),0)

----hire sales downpayment
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

----cash sales
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1
--),0)

----cash withdraw from bank
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)
DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in hand',@TotalCashInHand,0.00,1)

-------------------------------------------Cash in the bank--------------------------------------------
--set @TotalIncome=0
--set @TotalExpense=0
----Deposit
--set @TotalIncome= @TotalIncome + ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
----Collection from Customer
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)

----Withdraw
--set @TotalExpense= ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)

----Delivery to suppliers
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)
----Fund Transfer Out
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=5 and bt.ConcernID=@ConcernID and bt.BankID!=0
--),0)
----Fund Transfer In
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=5 and bt.ConcernID=@ConcernID and bt.AnotherBankID!=0
--),0)

----Bank Expense
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=6 and bt.ConcernID=@ConcernID and bt.ExpenseItemID!=0
--),0)

----Bank Income
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=7 and bt.ConcernID=@ConcernID and bt.ExpenseItemID!=0
--),0)

----Lia. Pay
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=8 and bt.ConcernID=@ConcernID and bt.SIHID!=0
--),0)

----Lia. Rec
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=9 and bt.ConcernID=@ConcernID and bt.SIHID!=0
--),0)

----Return From Supplier
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=10 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)

--declare @allBankOpening DECIMAL(18,2) = (SELECT ISNULL(SUM(OpeningBalance), 0) FROM Banks WHERE ConcernID = @ConcernID)

--IF(@TotalIncome-@TotalExpense!=0)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash at Bank',(@TotalIncome-@TotalExpense) + @allBankOpening, 0.00,2)


-- Summary---
--declare @BankBalance decimal(18,2)


--SET @BankBalance = (SELECT SUM(ISNULL(TotalAmount, 0)) FROM dbo.Banks WHERE @ConcernID = ConcernID)
--DECLARE @payBL INT = 8;
--IF(@BankBalance != 0)
--	BEGIN
--		create table #tmpBankBalance(BankID INT, TotalAmount DECIMAL(18,2))


--		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
--			EXEC dbo.GetDatewiseBankBalance @ConcernID, 0, @ToDate, @ToDate, @ToDate

--		SET @BankBalance = (SELECT SUM(TotalAmount) FROM #tmpBankBalance)
--		drop TABLE #tmpBankBalance
--		SET @BankBalance = @BankBalance

--		Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash at Bank',@BankBalance, 0.00,2)
--	END

----------------------------------------
declare @BankBalance decimal(18,2)
DECLARE @HoqueConcern INT

SET @HoqueConcern = (SELECT ConcernID FROM SisterConcerns  WHERE Name = 'HOQUE ELECTRONICS' AND @ConcernID = ConcernID)

SET @BankBalance = (SELECT SUM(ISNULL(TotalAmount, 0)) FROM dbo.Banks WHERE @ConcernID = ConcernID)
DECLARE @payBL INT = 8;
IF(@BankBalance != 0)
	BEGIN
		create table #tmpBankBalance(BankID INT, TotalAmount DECIMAL(18,2))

IF(@HoqueConcern = @ConcernID)
BEGIN
		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
			EXEC dbo.GetDatewiseBankBalanceHoque @ConcernID, 0, @ToDate, @ToDate, @ToDate
END

ELSE
BEGIN
		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
			EXEC dbo.GetDatewiseBankBalance @ConcernID, 0, @ToDate, @ToDate, @ToDate
END


		SET @BankBalance = (SELECT SUM(TotalAmount) FROM #tmpBankBalance)
		drop TABLE #tmpBankBalance
		SET @BankBalance = @BankBalance


		Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash at Bank',@BankBalance, 0.00,2)
	END

--------------------------------------------Direct Expense-----------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select exi.Description,Amount,0.00,8 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1

---------------------------------------------Purchase----------------------------------------
DECLARE @CashCollection decimal(18,2)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Purchase',po.GrandTotal,0.00,3 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID

---------------------------------------Transfer In and Transfer Receivables--------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer In',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4


--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Receivables',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

----------------------------------------Adjustment------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',cc.AdjustAmt,0.0,8 from CashCollections cc
where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',css.LastPayAdjust,0.0,8 from CreditSales so
join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.LastPayAdjust>0 and css.PaymentStatus='Paid')

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',so.AdjAmount,0.0,8 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.AdjAmount>0

------------------------------------------Discount Given---------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.Discount,0.0,5 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.Discount>0


Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.NetDiscount,0.0,5 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0

declare @disAmt DECIMAL(18,2) = (select SUM(so.NetDiscount) from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0)

print(@disAmt)

------------------------------------------Sales Return------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Return',so.TotalAmount,0.0,6 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4

----------------------------------------------Customer Due---------------------------------
Declare @TotalSaleAmt  decimal(18,2)

--Set @TotalSaleAmt= ISNULL((
--select SUM(so.TotalAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and  so.InvoiceDate<=@ToDate) and so.Status=1),0)

----Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
----select SUM(so.OpeningDue) from Customers so
----where so.ConcernID=@ConcernID and (so.CreatedDate<=@ToDate)),0)

--Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
--select SUM(so.NetAmount) from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos = ISNULL((
--select SUM(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.RecAmount>0),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.PaymentDue) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4 and so.PaymentDue>0),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(css.InstallmentAmt+css.LastPayAdjust) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((select SUM(cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and  cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)
--IF(@TotalSaleAmt-@CashInHandPos!=0)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values ('Customer Due',0,0,2) --amount will come from another sp, follow c# method


----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

--set  @TotalPOAmt=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0.00)

--set  @TotalPOAmt=@TotalPOAmt+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4),0.00)

--set  @TotalPOReturn=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0.00)



--set @TotalSales=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=1),0)

--set  @TotalSales=@TotalSales+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4),0.00)

--set @TotalSalesReturn=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=4),0)

--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Stock',(@TotalPOAmt+@TotalSalesReturn-@TotalPOReturn-@TotalSales),0.00,7)

---------------------------------------Stock Value End-------------------------------



--****************************************************
--***************Debit End****************************
--****************************************************



--****************************************************
--***************Credit Start*************************
--****************************************************


-----------------------------------Transfer Out and Transfer Payable---------------------------------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Out',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Payable',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4

------------------Investment-----------------------------------------------------
declare @Liability decimal(18,2)

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Lia. Receive',0.00,@Liability,3)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
INSERT INTO #crTemp(Particulars, Debit, Credit, SerialNum) values('Lia. Receive',0.00,@Liability,7)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,7)
END

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=2 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
END

---Asset
set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Current Asset' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
END
-------------------------------------Direct Income-------------------------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select exi.Description,0.00,ex.Amount,5 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2

-------------------------------------Retail and hire Sales----------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.GrandTotal,1 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.NetAmount,1 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1

--------------------------------------Purchase Discount------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Discount',0.00,po.NetDiscount,3 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID and po.NetDiscount>0

-----------------------------------------Hire Interest--------------------------
--Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
--select 'Hire Interest',0.00,so.InterestAmount,12 from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.InterestAmount>0

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
SELECT 'Hire Extend Interest',0.00,csi.InterestAmount,12 from dbo.CreditInterestHistories csi
JOIN dbo.CreditSales cs ON csi.HireSaleId = cs.CreditSalesID
WHERE cs.ConcernID = @ConcernID and cs.IsStatus=1 AND csi.IsFirstTime = 0
AND CAST(csi.InterestDate AS DATE) BETWEEN CAST(@FromDate AS DATE) AND CAST(@ToDate AS DATE)



----------------------------------------Supplier Due----------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)


SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)

--IF(@SupplierDue-@CashDelivery!=0)
--	Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue-@CashDelivery,5)
IF(@SupplierDue != 0)
	BEGIN
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @ToDate, @ToDate, @ToDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		drop TABLE #tmpSupplierDue

		--DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue

		--SET @SupplierDue = @SupplierDue + @totalOpeningDue


		Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,4)
	END


-----------------------------Purchase Return---------------------------

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Return',0.00,po.TotalAmt,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID

--****************************************************
--***************Credit End***************************
--****************************************************
--INSERT INTO #fTemp(ID,DebitParticular, Debit, CreditPaticular, Credit, SerialNum)
--SELECT ISNULL(T1.ID, 3), ISNULL(T1.Particulars, ''), ISNULL(T1.Debit, 0), '', 0.00, T1.SerialNum FROM #temp T1
--UNION ALL
--SELECT 0, '', 0, ISNULL(T2.Particulars, ''), ISNULL(T2.Credit, 0), T2.SerialNum FROM #crTemp T2


-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit, SerialNum as SL from #fTemp
GROUP BY DebitParticular, CreditParticular, SerialNum
order by SL




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--exec sp_TrialBalance  '01 Oct 2020 12:00:00 AM','02 Oct 2023 11:59:59 PM',5212

-------------------------------------------------------------------------------------------------------------------------------------


--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_YearlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-02-09'


if (@ConcernID = 1)
	set @CashInHand = 1263.00
else if (@ConcernID = 5)
	set @CashInHand = 8755.00
else if (@ConcernID = 6)
	set @CashInHand = - 2.00
else if (@ConcernID = 4)
	set @CashInHand = 65000.00
else if (@ConcernID = 20)
BEGIN
	set @CashInHand = 137340.00
	set @StartDate = '2020-03-12'
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END


set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(YEAR, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

insert into #temp_Data1
select @StartDate, s.Name, sum(po.recAmt), 'Cash Sales', 0, 'Order'
from POrders po
join Suppliers s on po.SupplierID = s.SupplierID
where po.ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
 and po.RecAmt>0
group by s.SupplierID,s.Name

insert into #temp_Data1
select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 1   and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate,'Bank collections', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Customer Collection(Cr))', sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 3  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Cash Delivery', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 4  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END
---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections cc 
join Suppliers s on cc.SupplierID = s.SupplierID
where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,  s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc 
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate 
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID 
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Retail/Dealer', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID 
		and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Retail/Dealere', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID 
				and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Hire', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID 
		and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Hire', 0, '', 0, 'Header'
	END

------------- -------------------------------------------- Direct Expense--------------------------------------------
set @total =isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)

if (@total) != 0
begin
insert into #temp_Data1
select @StartDate,'Expense', 0, '', 0, 'Header'

insert into #temp_Data1
select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description

insert into #temp_Data1
select @StartDate,'Total Expense', @total, '', 0, 'Header'

end

		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID and Year(Convert(date, TransactionDate)) = Year(@StartDate)  and  TransactionDate>= @InitailDate
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0 and  TransactionDate>= @InitailDate
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
						where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end


-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0
 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE  SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
 END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END


----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1  and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')

END
---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1  and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1   and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID  and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0
						and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

	-----------------------------------Income from Return From Supplier------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from CashCollections EX
						inner join Suppliers  E on E.SupplierID = EX.SupplierID
						where E.ConcernID = @ConcernID and EX.TransactionType = 3 
						AND Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Return From Supplier', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Name, sum(Amount), E.Name
		from CashCollections EX
		inner join Suppliers E on E.SupplierID = EX.SupplierID
		where E.ConcernID = @ConcernID and EX.TransactionType = 3 and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Name
	    insert into #temp_Data2 values(@StartDate, 'Return From Supplier', 0.00, 'Total Return From Supplier',@total, 'Header')
	
	end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1   AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
 END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
------------------------------------------------------------------------------------------------------------------------------------------------------

 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE  SIH.ParentId=2  and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END
------------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)

set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(YEAR, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

-------------------------------------------------------------------------------------------------------------------------------------
-------------Nahid--------------
----------15-01-2024------------
--------------------------------

ALTER TABLE dbo.SystemInformations ADD
	IsBankBalanceShow int NOT NULL CONSTRAINT DF_SystemInformations_IsBankBalanceShow DEFAULT ((0))
GO

-------------------------------------------------------------------------------------------------------------------------------------

Create PROC [dbo].[GetDatewiseBankBalanceHoque]
(
		@concernId INT,
		@BankId INT,
		@asOnDate datetime,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.BankID,
		(
			(
				ISNULL(piv.FundIN, 0) 
				+ ISNULL(piv.AnotherFundIN, 0) + ISNULL(piv.OpeningDue, 0)
			)
			-
			(
				ISNULL(piv.FundOut, 0)
			)
		) 'TotalDue'

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningBalance, 0)) PrevSales, 'OpeningDue' Id, c.BankID FROM Banks c 
	WHERE c.ConcernID = @ConcernID
	AND (@BankId = 0 OR c.BankID = @BankId)
	GROUP BY c.BankID, c.BankName
	UNION ALL

	--start here 
	

	-- end here
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.BankID  FROM
	(
	SELECT bt.Amount PrevSales, 'FundIN' Id, bt.BankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.BankID = b.BankID
	WHERE bt.ConcernID IN (SELECT ConcernID FROM SisterConcerns sc WHERE sc.ParentID = @concernId) AND 
	bt.TransactionType IN(1, 3, 9, 7, 10)
	AND (@BankId = 0 OR bt.BankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.BankID, bt.Amount, bt.TransactionNo,bt.BankTranID
	) tblPO
	GROUP BY tblPO.Id, tblPO.BankID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.AnotherBankID  FROM
	(
	SELECT bt.Amount PrevSales, 'AnotherFundIN' Id, bt.AnotherBankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.AnotherBankID = b.BankID
	WHERE bt.ConcernID IN (SELECT ConcernID FROM SisterConcerns sc WHERE sc.ParentID = @concernId) AND 
	bt.TransactionType IN(5)
	AND (@BankId = 0 OR bt.AnotherBankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.AnotherBankID, bt.Amount, bt.TransactionNo,bt.BankTranID
	) tblPO
	GROUP BY tblPO.Id, tblPO.AnotherBankID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.BankID  FROM
	(
	SELECT bt.Amount PrevSales, 'FundOut' Id, bt.BankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.BankID = b.BankID
	WHERE bt.ConcernID IN (SELECT ConcernID FROM SisterConcerns sc WHERE sc.ParentID = @concernId) AND 
	bt.TransactionType IN (2, 4, 8, 6, 5)
	AND (@BankId = 0 OR bt.BankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.BankID, bt.Amount, bt.TransactionNo,bt.BankTranID
	) tblPO
	GROUP BY tblPO.Id, tblPO.BankID

	UNION ALL

	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.BankID  FROM
	(
	SELECT bt.Amount PrevSales, 'FundIN' Id, bt.BankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.BankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN(1, 3, 9, 7, 10)
	AND (@BankId = 0 OR bt.BankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.BankID, bt.Amount, bt.TransactionNo,bt.BankTranID
	) tblPO
	GROUP BY tblPO.Id, tblPO.BankID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.AnotherBankID  FROM
	(
	SELECT bt.Amount PrevSales, 'AnotherFundIN' Id, bt.AnotherBankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.AnotherBankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN(5)
	AND (@BankId = 0 OR bt.AnotherBankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.AnotherBankID, bt.Amount, bt.TransactionNo,bt.BankTranID
	) tblPO
	GROUP BY tblPO.Id, tblPO.AnotherBankID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.BankID  FROM
	(
	SELECT bt.Amount PrevSales, 'FundOut' Id, bt.BankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.BankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN (2, 4, 8, 6, 5)
	AND (@BankId = 0 OR bt.BankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.BankID, bt.Amount, bt.TransactionNo,bt.BankTranID
	) tblPO
	GROUP BY tblPO.Id, tblPO.BankID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			FundIN, FundOut, AnotherFundIN,OpeningDue

		)
	) piv
 END

-------------------------------------------------------------------------------------------------------------------------------------

ALTER PROC [dbo].[sp_BalanceSheetNew]
(
  @AsOnDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int, IsHeader BIT)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int, IsHeader BIT)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int, IsHeader BIT)


------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@AsOnDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@AsOnDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Cash in hand',0.00,@TotalCashInHand,7, 0)

-------------------------------------------Cash at the bank--------------------------------------------
--set @TotalIncome=0
--set @TotalExpense=0
----Deposit
--DECLARE @payBL INT = 8;
--set @TotalIncome= @TotalIncome + ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
----Collection from Customer
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)

----Withdraw
--set @TotalExpense= ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)

----Delivery to suppliers
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)
---- Fund Transfer Out
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=5 and bt.ConcernID=@ConcernID and bt.BankID!=0
--),0)
---- Fund Transfer In
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=5 and bt.ConcernID=@ConcernID and bt.AnotherBankID!=0
--),0)

---- Bank Expense
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=6 and bt.ConcernID=@ConcernID and bt.ExpenseItemID!=0
--),0)

---- Bank Income
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=7 and bt.ConcernID=@ConcernID and bt.ExpenseItemID!=0
--),0)

---- Lia. Pay
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=8 and bt.ConcernID=@ConcernID and bt.SIHID!=0
--),0)

---- Lia. Rec
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=9 and bt.ConcernID=@ConcernID and bt.SIHID!=0
--),0)

---- Return From Supplier
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=10 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)
--declare @allBankOpening DECIMAL(18,2) = (SELECT ISNULL(SUM(OpeningBalance), 0) FROM Banks WHERE ConcernID = @ConcernID)



--IF(@TotalIncome-@TotalExpense!=0)
--Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Cash at Bank',0.00, (@TotalIncome-@TotalExpense) + @allBankOpening,@payBL, 0)


----------------------------------------Bank Balance Summary----------------------------
declare @BankBalance decimal(18,2)
DECLARE @HoqueConcern INT

SET @HoqueConcern = (SELECT ConcernID FROM SisterConcerns  WHERE Name = 'HOQUE ELECTRONICS' AND @ConcernID = ConcernID)

SET @BankBalance = (SELECT SUM(ISNULL(TotalAmount, 0)) FROM dbo.Banks WHERE @ConcernID = ConcernID)
DECLARE @payBL INT = 8;
IF(@BankBalance != 0)
	BEGIN
		create table #tmpBankBalance(BankID INT, TotalAmount DECIMAL(18,2))

IF(@HoqueConcern = @ConcernID)
BEGIN
		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
			EXEC dbo.GetDatewiseBankBalanceHoque @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate
END

ELSE
BEGIN
		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
			EXEC dbo.GetDatewiseBankBalance @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate
END


		SET @BankBalance = (SELECT SUM(TotalAmount) FROM #tmpBankBalance)
		drop TABLE #tmpBankBalance
		SET @BankBalance = @BankBalance


		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Bank Balance',0,@BankBalance,@payBL, 0)
	END
-----------------------Bank Balance Indiviual------------------------
--declare @BankBalance decimal(18,2)


--SET @BankBalance = (SELECT SUM(ISNULL(TotalAmount, 0)) FROM dbo.Banks WHERE @ConcernID = ConcernID)
--DECLARE @payBL INT = 8;
--IF(@BankBalance != 0)
--	BEGIN
--		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Bank Balance',0,0,@payBL, 1)
--		create table #tmpBankBalance (BankID INT, TotalAmount DECIMAL(18,2))


--		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
--			EXEC dbo.GetDatewiseBankBalance  @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

--		SET @BankBalance = (SELECT SUM(TotalAmount) FROM #tmpBankBalance)
		

--		--DECLARE @totalBankOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningBalance, 0)) FROM dbo.Banks WHERE ConcernID = @ConcernID)

--		SET @BankBalance = @BankBalance

--		INSERT INTO #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader)
--		SELECT s.BankName, 0, (tb.TotalAmount), @payBL + 1, 0 FROM #tmpBankBalance tb
--		JOIN dbo.Banks s ON tb.BankID = s.BankID
--		WHERE tb.TotalAmount != 0

--		SET @payBL = @payBL + (SELECT COUNT(BankID) FROM #tmpBankBalance) + 1;

--		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Bank Balance',0,@BankBalance,@payBL, 1)
--		drop TABLE #tmpBankBalance
--	END
-----------------------Fixed Assest Indiviual------------------------
declare @FixAssestBalance decimal(18,2)


SET @FixAssestBalance = (SELECT SUM(ISNULL(Balance, 0)) FROM dbo.ShareInvestmentHeads WHERE @ConcernID = ConcernID AND ParentId = 1)
DECLARE @payFBL INT = @payBL + 1;
IF(@FixAssestBalance != 0)
	BEGIN
		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Fixed Asset',0,0,@payFBL, 1)
		create table #tmpFixAsBalance (SIHID INT, Balance DECIMAL(18,2))


		INSERT INTO #tmpFixAsBalance(SIHID, Balance)
			EXEC dbo.GetDatewiseFixedAssestBalance  @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @FixAssestBalance = (SELECT SUM(Balance) FROM #tmpFixAsBalance)
		

		--DECLARE @totalFixAsOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningBalance, 0)) FROM dbo.ShareInvestmentHeads WHERE ConcernID = @ConcernID AND ParentId = 1)

		SET @FixAssestBalance = @FixAssestBalance

		INSERT INTO #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.Name, 0, (tb.Balance), @payFBL + 1, 0 FROM #tmpFixAsBalance tb
		JOIN dbo.ShareInvestmentHeads s ON tb.SIHID = s.SIHID
		WHERE tb.Balance != 0

		SET @payFBL = @payFBL + (SELECT COUNT(SIHID) FROM #tmpFixAsBalance) + 1;

		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Fixed Asset',0,@FixAssestBalance,@payFBL, 1)
		drop TABLE #tmpFixAsBalance
	END

-----------------------Liability Received Last Balance------------------------
declare @LiaHeadBalance decimal(18,2)


SET @LiaHeadBalance = (SELECT SUM(ISNULL(Balance, 0)) FROM dbo.ShareInvestmentHeads WHERE @ConcernID = ConcernID AND ParentId = 3 AND Balance < 0)
DECLARE @payLBL INT = @payFBL + 1;
IF(@LiaHeadBalance < 0)
	BEGIN
		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Investment Received',0,0,@payLBL, 1)
		create table #tmpLiaDue (SIHID INT, Balance DECIMAL(18,2))

		INSERT INTO #tmpLiaDue(SIHID, Balance)
			EXEC dbo.GetDatewiseLiabilityBalance @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @LiaHeadBalance = (SELECT SUM(ts.Balance) FROM #tmpLiaDue ts WHERE ts.Balance < 0)
		

		--DECLARE @totalLiaMinusOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningBalance, 0)) FROM dbo.ShareInvestmentHeads WHERE ConcernID = @ConcernID AND ParentId = 3 AND Balance < 0)

		SET @LiaHeadBalance = @LiaHeadBalance

		INSERT INTO #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.Name, 0, -(ts.Balance), @payLBL + 1, 0 FROM #tmpLiaDue ts
		JOIN dbo.ShareInvestmentHeads s ON ts.SIHID = s.SIHID
		WHERE ts.Balance < 0

		SET @payLBL = @payLBL + (SELECT COUNT(SIHID) FROM #tmpLiaDue) + 1;

		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Investment Received',0, -(@LiaHeadBalance),@payLBL, 1)
		drop TABLE #tmpLiaDue
	END

-----------------------Security Last Balance------------------------
declare @SecHeadBalance decimal(18,2)



SET @SecHeadBalance = (SELECT SUM(ISNULL(Balance, 0)) FROM dbo.ShareInvestmentHeads WHERE @ConcernID = ConcernID AND ParentId = 6)
DECLARE @paySHL INT = @payLBL + 1;
IF(@SecHeadBalance != 0)
	BEGIN
		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Security',0,0,@paySHL, 1)
		create table #tmpSecDue (SIHID INT, Balance DECIMAL(18,2))


		INSERT INTO #tmpSecDue(SIHID, Balance)
			EXEC dbo.GetDatewiseSecurityBalance @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @SecHeadBalance = (SELECT SUM(Balance) FROM #tmpSecDue)
		

		--DECLARE @totalSecOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningBalance, 0)) FROM dbo.ShareInvestmentHeads WHERE ConcernID = @ConcernID AND ParentId = 6)

		SET @SecHeadBalance = @SecHeadBalance

		INSERT INTO #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.Name, 0, -(ts.Balance), @paySHL + 1, 0 FROM #tmpSecDue ts
		JOIN dbo.ShareInvestmentHeads s ON ts.SIHID = s.SIHID
		WHERE ts.Balance != 0

		SET @paySHL = @paySHL + (SELECT COUNT(SIHID) FROM #tmpSecDue) + 1;

		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Security',0, -(@SecHeadBalance),@paySHL, 1)
		drop TABLE #tmpSecDue

	END



-----------------------Supplier Due------------------------
--declare @SupplierDue decimal(18,2)
--declare @CashDelivery decimal(18,2)


--SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)
--DECLARE @paySL INT = 2;
--IF(@SupplierDue != 0)
--	BEGIN
--		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Account Payable',0,0,@paySL, 1)
--		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


--		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
--			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

--		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		

--		--DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

--		SET @SupplierDue = @SupplierDue

--		INSERT INTO #temp(Particulars,Debit,Credit,SerialNum, IsHeader)
--		SELECT s.Name, (ts.TotalDue), 0, @paySL + 1, 0 FROM #tmpSupplierDue ts
--		JOIN dbo.Suppliers s ON ts.SupplierID = s.SupplierID
--		WHERE ts.TotalDue != 0

--		SET @paySL = @paySL + (SELECT COUNT(SupplierID) FROM #tmpSupplierDue) + 1;

--		--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,4)
--		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Account Payable',@SupplierDue,0,@paySL, 1)
--		drop TABLE #tmpSupplierDue
--	END

----------------------------------------Supplier Due Summary----------------------------
declare @SupplierSummayDue decimal(18,2)


SET @SupplierSummayDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)
DECLARE @paySL INT = 2;
IF(@SupplierSummayDue != 0)
	BEGIN
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @SupplierSummayDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		drop TABLE #tmpSupplierDue
		SET @SupplierSummayDue = @SupplierSummayDue



		Insert Into #temp(Particulars,Debit,Credit,SerialNum,IsHeader) values ('Account Payable',@SupplierSummayDue,0,@paySL,0)
	END
-----------------------Liability Pay Last Balance------------------------
declare @LiaHeadPayBalance decimal(18,2)


SET @LiaHeadPayBalance = (SELECT SUM(ISNULL(Balance, 0)) FROM dbo.ShareInvestmentHeads WHERE @ConcernID = ConcernID AND ParentId = 3 and Balance > 0)
DECLARE @payLHL INT = @paySL + 1;
IF(@LiaHeadPayBalance > 0)
	BEGIN
		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Investment Pay',0,0,@payLHL, 1)
		create table #tmpLiaPlusDue(SIHID INT, Balance DECIMAL(18,2))

		INSERT INTO #tmpLiaPlusDue(SIHID, Balance)
		EXEC dbo.GetDatewiseLiabilityBalance @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @LiaHeadPayBalance = (SELECT SUM(ts.Balance) FROM #tmpLiaPlusDue ts WHERE ts.Balance > 0)
		

		--DECLARE @totalLiaOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningBalance, 0)) FROM dbo.ShareInvestmentHeads WHERE ConcernID = @ConcernID AND ParentId = 3 and Balance > 0)

		SET @LiaHeadPayBalance = @LiaHeadPayBalance 
		--+ @totalLiaOpeningDue

		INSERT INTO #temp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.Name, (ts.Balance), 0, @payLHL + 1, 0 FROM #tmpLiaPlusDue ts
		--SELECT s.Name, (ts.Balance + s.OpeningBalance), 0, @payLHL + 1, 0 FROM #tmpLiaPlusDue ts
		JOIN dbo.ShareInvestmentHeads s ON ts.SIHID = s.SIHID
		WHERE ts.Balance > 0

		SET @payLHL = @payLHL + (SELECT COUNT(SIHID) FROM #tmpLiaPlusDue) + 1;

		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Investment Pay',@LiaHeadPayBalance,0,@payLHL, 1)
		drop TABLE #tmpLiaPlusDue

	END




----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Inventory',0,0,2, 0) --amount will come from another sp, follow c# method

----------------------------------------Customer Due----------------------------



Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Account Receivable',0,0,2, 0) --amount will come from another sp, follow c# method



-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum, IsHeader)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum,
	t.IsHeader
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum, IsHeader)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum,
	t.IsHeader
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit, SerialNum as SL, IsHeader from #fTemp
GROUP BY DebitParticular, CreditParticular, SerialNum, IsHeader
order by SL




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--EXEC sp_BalanceSheetNew  '2023-11-07', 5213

-------------------------------------------------------------------------------------------------------------------------------------


-------------Nahid--------------
----------08-01-2024------------
--------------------------------

ALTER view [dbo].[vw_ProductPicker] as
Select P.Code'ProductCode',P.ProductName,G.Name'GodownName', CL.Name'ColorName', CA.Description'CategoryName', SD.IMENO, SD.SRate'MRPRate',P.ConcernID,P.ProductID,S.ColorID,S.GodownID,P.CategoryID,P.CompanyID,SD.SDetailID'StockDetailsId',S.StockID,CM.Name'CompanyName', SD.PRate'PRate',SD.Quantity'PreStock', p.ProductType
From Products P
Inner Join Companies CM on CM.CompanyID=P.CompanyID and P.ConcernID=CM.ConcernID
Inner Join Categorys CA on CA.CategoryID=P.CategoryID and CA.ConcernID=P.ConcernID
Inner Join StockDetails SD on SD.ProductID=P.ProductID
Inner join Stocks S on S.StockID = SD.StockID and P.ConcernID = S.ConcernID
Inner Join Godowns G on SD.GodownID = G.GodownID and G.ConcernID = S.ConcernID
Inner Join Colors CL on CL.ColorID = SD.ColorID and CL.ConcernID = S.ConcernID
where SD.Status=1
--and S.ConcernID = 5126 Order By CA.CategoryID
GO




------------------------------------------------------------------------------------------------------------------------
ALTER PROC [dbo].[GetDatewiseBankBalance]
(
		@concernId INT,
		@BankId INT,
		@asOnDate datetime,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.BankID,
		(
			(
				ISNULL(piv.FundIN, 0) 
				+ ISNULL(piv.AnotherFundIN, 0) + ISNULL(piv.OpeningDue, 0)
			)
			-
			(
				ISNULL(piv.FundOut, 0)
			)
		) 'TotalDue'

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningBalance, 0)) PrevSales, 'OpeningDue' Id, c.BankID FROM Banks c 
	WHERE c.ConcernID = @ConcernID
	AND (@BankId = 0 OR c.BankID = @BankId)
	GROUP BY c.BankID, c.BankName
	UNION ALL
	--start here 
	

	-- end here
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.BankID  FROM
	(
	SELECT bt.Amount PrevSales, 'FundIN' Id, bt.BankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.BankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN(1, 3, 9, 7)
	AND (@BankId = 0 OR bt.BankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.BankID, bt.Amount, bt.TransactionNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.BankID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.AnotherBankID  FROM
	(
	SELECT bt.Amount PrevSales, 'AnotherFundIN' Id, bt.AnotherBankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.AnotherBankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN(5)
	AND (@BankId = 0 OR bt.AnotherBankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.AnotherBankID, bt.Amount, bt.TransactionNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.AnotherBankID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.BankID  FROM
	(
	SELECT bt.Amount PrevSales, 'FundOut' Id, bt.BankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.BankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN (2, 4, 8, 6, 5)
	AND (@BankId = 0 OR bt.BankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.BankID, bt.Amount, bt.TransactionNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.BankID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			FundIN, FundOut, AnotherFundIN,OpeningDue

		)
	) piv
 END


-------------------------------------------------------------------------------------------------------------------
ALTER PROC [dbo].[GetDatewiseLiabilityBalance]
(
		@concernId INT,
		@LiaHeadId INT,
		@asOnDate datetime,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.SIHID,
		(
			(
				ISNULL(piv.OpeningDue, 0) + ISNULL(piv.LoanPlus, 0) + ISNULL(piv.BankLoanPlus, 0)
			)
			-
			(
				ISNULL(piv.LoanMinus, 0) + ISNULL(piv.BankLoanMinus, 0)
			)
		) 'TotalDue'

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningBalance, 0)) PrevSales, 'OpeningDue' Id, c.SIHID FROM ShareInvestmentHeads c 
	WHERE c.ConcernID = @ConcernID AND c.ParentId = 3
	AND (@LiaHeadId = 0 OR c.SIHID = @LiaHeadId)
	GROUP BY c.SIHID, c.Name
	UNION ALL
	--start here 
	

	-- end here
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SIHID  FROM
	(
	SELECT bt.Amount PrevSales, 'LoanPlus' Id, bt.SIHID FROM dbo.ShareInvestments bt
	JOIN ShareInvestmentHeads b ON bt.SIHID = b.SIHID
	WHERE bt.ConcernID = @concernId AND b.ParentId = 3 AND
	bt.TransactionType IN(1) AND bt.LiabilityType IN (1,2)
	AND (@LiaHeadId = 0 OR bt.SIHID = @LiaHeadId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.SIHID, bt.Amount, bt.SIID
	) tblPO
	GROUP BY tblPO.Id, tblPO.SIHID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SIHID  FROM
	(
	SELECT bt.Amount PrevSales, 'LoanMinus' Id, bt.SIHID FROM dbo.ShareInvestments bt
	JOIN ShareInvestmentHeads b ON bt.SIHID = b.SIHID
	WHERE bt.ConcernID = @concernId AND b.ParentId = 3 AND
	bt.TransactionType IN(2) AND bt.LiabilityType IN (3,4)
	AND (@LiaHeadId = 0 OR bt.SIHID = @LiaHeadId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.SIHID, bt.Amount, bt.SIID
	) tblPO
	GROUP BY tblPO.Id, tblPO.SIHID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SIHID  FROM
	(
	SELECT bt.Amount PrevSales, 'BankLoanPlus' Id, bt.SIHID FROM dbo.BankTransactions bt
	JOIN ShareInvestmentHeads b ON bt.SIHID = b.SIHID
	WHERE bt.ConcernID = @concernId AND b.ParentId = 3 AND
	bt.TransactionType IN(9)
	AND (@LiaHeadId = 0 OR bt.SIHID = @LiaHeadId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.SIHID, bt.Amount, bt.TransactionNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.SIHID

	UNION ALL

	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SIHID  FROM
	(
	SELECT bt.Amount PrevSales, 'BankLoanMinus' Id, bt.SIHID FROM dbo.BankTransactions bt
	JOIN ShareInvestmentHeads b ON bt.SIHID = b.SIHID
	WHERE bt.ConcernID = @concernId AND b.ParentId = 3 AND
	bt.TransactionType IN(8)
	AND (@LiaHeadId = 0 OR bt.SIHID = @LiaHeadId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.SIHID, bt.Amount, bt.TransactionNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.SIHID


	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			LoanPlus, LoanMinus,OpeningDue, BankLoanPlus, BankLoanMinus

		)
	) piv
 END

-------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[sp_BalanceSheetNew]
(
  @AsOnDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int, IsHeader BIT)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int, IsHeader BIT)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int, IsHeader BIT)


------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@AsOnDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@AsOnDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Cash in hand',0.00,@TotalCashInHand,7, 0)

-------------------------------------------Cash at the bank--------------------------------------------
--set @TotalIncome=0
--set @TotalExpense=0
----Deposit
--set @TotalIncome= @TotalIncome + ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
----Collection from Customer
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)

----Withdraw
--set @TotalExpense= ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)

----Delivery to suppliers
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)

--declare @allBankOpening DECIMAL(18,2) = (SELECT ISNULL(SUM(OpeningBalance), 0) FROM Banks WHERE ConcernID = @ConcernID)



--IF(@TotalIncome-@TotalExpense!=0)
--Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Cash at Bank',0.00, (@TotalIncome-@TotalExpense) + @allBankOpening,8, 0)



-----------------------Bank Balance Indiviual------------------------
declare @BankBalance decimal(18,2)


SET @BankBalance = (SELECT SUM(ISNULL(TotalAmount, 0)) FROM dbo.Banks WHERE @ConcernID = ConcernID)
DECLARE @payBL INT = 8;
IF(@BankBalance != 0)
	BEGIN
		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Bank Balance',0,0,@payBL, 1)
		create table #tmpBankBalance (BankID INT, TotalAmount DECIMAL(18,2))


		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
			EXEC dbo.GetDatewiseBankBalance  @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @BankBalance = (SELECT SUM(TotalAmount) FROM #tmpBankBalance)
		

		--DECLARE @totalBankOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningBalance, 0)) FROM dbo.Banks WHERE ConcernID = @ConcernID)

		SET @BankBalance = @BankBalance

		INSERT INTO #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.BankName, 0, (tb.TotalAmount), @payBL + 1, 0 FROM #tmpBankBalance tb
		JOIN dbo.Banks s ON tb.BankID = s.BankID
		WHERE tb.TotalAmount != 0

		SET @payBL = @payBL + (SELECT COUNT(BankID) FROM #tmpBankBalance) + 1;

		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Bank Balance',0,@BankBalance,@payBL, 1)
		drop TABLE #tmpBankBalance
	END
-----------------------Fixed Assest Indiviual------------------------
declare @FixAssestBalance decimal(18,2)


SET @FixAssestBalance = (SELECT SUM(ISNULL(Balance, 0)) FROM dbo.ShareInvestmentHeads WHERE @ConcernID = ConcernID AND ParentId = 1)
DECLARE @payFBL INT = @payBL + 1;
IF(@FixAssestBalance != 0)
	BEGIN
		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Fixed Asset',0,0,@payFBL, 1)
		create table #tmpFixAsBalance (SIHID INT, Balance DECIMAL(18,2))


		INSERT INTO #tmpFixAsBalance(SIHID, Balance)
			EXEC dbo.GetDatewiseFixedAssestBalance  @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @FixAssestBalance = (SELECT SUM(Balance) FROM #tmpFixAsBalance)
		

		--DECLARE @totalFixAsOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningBalance, 0)) FROM dbo.ShareInvestmentHeads WHERE ConcernID = @ConcernID AND ParentId = 1)

		SET @FixAssestBalance = @FixAssestBalance

		INSERT INTO #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.Name, 0, (tb.Balance), @payFBL + 1, 0 FROM #tmpFixAsBalance tb
		JOIN dbo.ShareInvestmentHeads s ON tb.SIHID = s.SIHID
		WHERE tb.Balance != 0

		SET @payFBL = @payFBL + (SELECT COUNT(SIHID) FROM #tmpFixAsBalance) + 1;

		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Fixed Asset',0,@FixAssestBalance,@payFBL, 1)
		drop TABLE #tmpFixAsBalance
	END

-----------------------Liability Received Last Balance------------------------
declare @LiaHeadBalance decimal(18,2)


SET @LiaHeadBalance = (SELECT SUM(ISNULL(Balance, 0)) FROM dbo.ShareInvestmentHeads WHERE @ConcernID = ConcernID AND ParentId = 3 AND Balance < 0)
DECLARE @payLBL INT = @payFBL + 1;
IF(@LiaHeadBalance < 0)
	BEGIN
		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Investment Received',0,0,@payLBL, 1)
		create table #tmpLiaDue (SIHID INT, Balance DECIMAL(18,2))

		INSERT INTO #tmpLiaDue(SIHID, Balance)
			EXEC dbo.GetDatewiseLiabilityBalance @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @LiaHeadBalance = (SELECT SUM(ts.Balance) FROM #tmpLiaDue ts WHERE ts.Balance < 0)
		

		--DECLARE @totalLiaMinusOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningBalance, 0)) FROM dbo.ShareInvestmentHeads WHERE ConcernID = @ConcernID AND ParentId = 3 AND Balance < 0)

		SET @LiaHeadBalance = @LiaHeadBalance

		INSERT INTO #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.Name, 0, -(ts.Balance), @payLBL + 1, 0 FROM #tmpLiaDue ts
		JOIN dbo.ShareInvestmentHeads s ON ts.SIHID = s.SIHID
		WHERE ts.Balance < 0

		SET @payLBL = @payLBL + (SELECT COUNT(SIHID) FROM #tmpLiaDue) + 1;

		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Investment Received',0, -(@LiaHeadBalance),@payLBL, 1)
		drop TABLE #tmpLiaDue
	END




-----------------------Supplier Due------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)


SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)
DECLARE @paySL INT = 2;
IF(@SupplierDue != 0)
	BEGIN
		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Account Payable',0,0,@paySL, 1)
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		

		--DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue

		INSERT INTO #temp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.Name, (ts.TotalDue), 0, @paySL + 1, 0 FROM #tmpSupplierDue ts
		JOIN dbo.Suppliers s ON ts.SupplierID = s.SupplierID
		WHERE ts.TotalDue != 0

		SET @paySL = @paySL + (SELECT COUNT(SupplierID) FROM #tmpSupplierDue) + 1;

		--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,4)
		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Account Payable',@SupplierDue,0,@paySL, 1)
		drop TABLE #tmpSupplierDue
	END

-----------------------Security Last Balance------------------------
declare @SecHeadBalance decimal(18,2)



SET @SecHeadBalance = (SELECT SUM(ISNULL(Balance, 0)) FROM dbo.ShareInvestmentHeads WHERE @ConcernID = ConcernID AND ParentId = 6)
DECLARE @paySHL INT = @paySL + 1;
IF(@SecHeadBalance != 0)
	BEGIN
		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Security',0,0,@paySHL, 1)
		create table #tmpSecDue(SIHID INT, Balance DECIMAL(18,2))


		INSERT INTO #tmpSecDue(SIHID, Balance)
			EXEC dbo.GetDatewiseSecurityBalance @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @SecHeadBalance = (SELECT SUM(Balance) FROM #tmpSecDue)
		

		--DECLARE @totalSecOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningBalance, 0)) FROM dbo.ShareInvestmentHeads WHERE ConcernID = @ConcernID AND ParentId = 6)

		SET @SecHeadBalance = @SecHeadBalance

		INSERT INTO #temp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.Name, -(ts.Balance), 0, @paySHL + 1, 0 FROM #tmpSecDue ts
		JOIN dbo.ShareInvestmentHeads s ON ts.SIHID = s.SIHID
		WHERE ts.Balance != 0

		SET @paySHL = @paySHL + (SELECT COUNT(SIHID) FROM #tmpSecDue) + 1;

		--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,4)
		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Security', -(@SecHeadBalance),0,@paySHL, 1)
		drop TABLE #tmpSecDue
	END

-----------------------Liability Pay Last Balance------------------------
declare @LiaHeadPayBalance decimal(18,2)


SET @LiaHeadPayBalance = (SELECT SUM(ISNULL(Balance, 0)) FROM dbo.ShareInvestmentHeads WHERE @ConcernID = ConcernID AND ParentId = 3 and Balance > 0)
DECLARE @payLHL INT = @paySHL + 1;
IF(@LiaHeadPayBalance > 0)
	BEGIN
		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Investment Pay',0,0,@payLHL, 1)
		create table #tmpLiaPlusDue(SIHID INT, Balance DECIMAL(18,2))

		INSERT INTO #tmpLiaPlusDue(SIHID, Balance)
		EXEC dbo.GetDatewiseLiabilityBalance @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @LiaHeadPayBalance = (SELECT SUM(ts.Balance) FROM #tmpLiaPlusDue ts WHERE ts.Balance > 0)
		

		--DECLARE @totalLiaOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningBalance, 0)) FROM dbo.ShareInvestmentHeads WHERE ConcernID = @ConcernID AND ParentId = 3 and Balance > 0)

		SET @LiaHeadPayBalance = @LiaHeadPayBalance 
		--+ @totalLiaOpeningDue

		INSERT INTO #temp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.Name, (ts.Balance), 0, @payLHL + 1, 0 FROM #tmpLiaPlusDue ts
		--SELECT s.Name, (ts.Balance + s.OpeningBalance), 0, @payLHL + 1, 0 FROM #tmpLiaPlusDue ts
		JOIN dbo.ShareInvestmentHeads s ON ts.SIHID = s.SIHID
		WHERE ts.Balance > 0

		SET @payLHL = @payLHL + (SELECT COUNT(SIHID) FROM #tmpLiaPlusDue) + 1;

		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Investment Pay',@LiaHeadPayBalance,0,@payLHL, 1)
		drop TABLE #tmpLiaPlusDue

	END




----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Inventory',0,0,2, 0) --amount will come from another sp, follow c# method

----------------------------------------Customer Due----------------------------



Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Account Receivable',0,0,2, 0) --amount will come from another sp, follow c# method



-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum, IsHeader)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum,
	t.IsHeader
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum, IsHeader)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum,
	t.IsHeader
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit, SerialNum as SL, IsHeader from #fTemp
GROUP BY DebitParticular, CreditParticular, SerialNum, IsHeader
order by SL




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--EXEC sp_BalanceSheetNew  '2023-11-07', 5213

-------------Mostafizur---------
----------28-02-2024------------
-------------------------------

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	smsCharge decimal(18, 2) NOT NULL CONSTRAINT DF_SystemInformations_smsCharge DEFAULT ((0))
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT



-------------Mostafizur---------
----------05-02-2024------------
-------------------------------

select * from SystemInformations where SMSServiceEnable=1 and SMSProviderID=0
--update SystemInformations set SMSProviderID=4 where SMSServiceEnable=1 and SMSProviderID=0


--INSERT INTO [dbo].[SMSPaymentMasters]([OpeningBalance],[TotalRecAmt],[ConcernID],[ParentID],[IsMasking],[PerSMSCharge],[CreatedBy],[CreateDate])
Select 0 OpeningBalance,0 TotalRecAmt,SI.ConcernID,SC.ParentID,SI.SMSProviderID,
CASE WHEN SI.SMSProviderID = 4 THEN 0.45 WHEN SI.SMSProviderID = 5 THEN 0.70
WHEN (SI.SMSProviderID!=4 and SI.SMSProviderID!=5) THEN 0.45
END PerSMSCharge
,U.Id,GETDATE() CreatedDate
from SystemInformations SI
Inner Join SisterConcerns SC on SC.ConcernID=SI.ConcernID
Inner Join Users U on SI.ConcernID=U.ConcernID and SI.SMSServiceEnable=1
Inner Join UserRoles UR on UR.UserId=U.Id and UR.RoleId=1
order by ConcernID

--SMSProviderID=5 for Musking
--SMSProviderID=4 for Non Musking


-------------Mostafizur---------
----------05-02-2024------------
-------------------------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[SMSPaymentMasters](
	[SMSPaymentMasterID] [int] IDENTITY(1,1) NOT NULL,
	[OpeningBalance] [decimal](18, 2) NOT NULL,
	[TotalRecAmt] [decimal](18, 2) NOT NULL,
	[ConcernID] [int] NOT NULL,
	[ParentID] [int] NOT NULL,
	[IsMasking] [int] NOT NULL,
	[PerSMSCharge] [decimal](18, 2) NOT NULL,
	[CreatedBy] [int] NOT NULL,
	[CreateDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NULL,
	[ModifiedDate] [datetime] NULL,
 CONSTRAINT [PK_SMSPaymentMasters] PRIMARY KEY CLUSTERED 
(
	[SMSPaymentMasterID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[SMSPaymentMasters] ADD  CONSTRAINT [DF_SMSPaymentMasters_OpeningBalance]  DEFAULT ((0)) FOR [OpeningBalance]
GO

ALTER TABLE [dbo].[SMSPaymentMasters] ADD  CONSTRAINT [DF_SMSPaymentMasters_ParentID]  DEFAULT ((0)) FOR [ParentID]
GO

ALTER TABLE [dbo].[SMSPaymentMasters] ADD  CONSTRAINT [DF_SMSPaymentMasters_IsMasking]  DEFAULT ((0)) FOR [IsMasking]
GO

ALTER TABLE [dbo].[SMSPaymentMasters] ADD  CONSTRAINT [DF_SMSPaymentMasters_PerSMSCharge]  DEFAULT ((0)) FOR [PerSMSCharge]
GO

ALTER TABLE [dbo].[SMSPaymentMasters]  WITH CHECK ADD  CONSTRAINT [FK_SMSPaymentMasters_SisterConcerns] FOREIGN KEY([ConcernID])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[SMSPaymentMasters] CHECK CONSTRAINT [FK_SMSPaymentMasters_SisterConcerns]
GO

ALTER TABLE [dbo].[SMSPaymentMasters]  WITH CHECK ADD  CONSTRAINT [FK_SMSPaymentMasters_Users] FOREIGN KEY([CreatedBy])
REFERENCES [dbo].[Users] ([Id])
GO

ALTER TABLE [dbo].[SMSPaymentMasters] CHECK CONSTRAINT [FK_SMSPaymentMasters_Users]
GO




-------------Mostafizur---------
----------05-02-2024------------
-------------------------------


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[SMSPaymentMasterDetails](
	[SMSPaymentDetailsID] [int] IDENTITY(1,1) NOT NULL,
	[SMSPaymentMasterID] [int] NOT NULL,
	[ReceiptNo] [varchar](150) NOT NULL,
	[RecAmount] [decimal](18, 2) NOT NULL,
	[RecDate] [datetime] NOT NULL,
	[PaymentMobNo] [nvarchar](50) NULL,
	[TransactionId] [nvarchar](250) NULL,
	[TransactionStatus] [nvarchar](100) NULL,
	[StatusMessage] [nvarchar](100) NULL,
	[ErrorCocde] [nvarchar](50) NULL,
	[ErrorMessage] [nvarchar](500) NULL,
	[PaymentId] [nvarchar](150) NULL,
	[PaymentReference] [nvarchar](150) NULL,
	[CreatedBy] [int] NOT NULL,
	[CreateDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NULL,
	[ModifiedDate] [datetime] NULL,
 CONSTRAINT [PK_SMSPaymentMasterDetails] PRIMARY KEY CLUSTERED 
(
	[SMSPaymentDetailsID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[SMSPaymentMasterDetails] ADD  CONSTRAINT [DF_SMSPaymentMasterDetails_RecAmount]  DEFAULT ((0)) FOR [RecAmount]
GO

ALTER TABLE [dbo].[SMSPaymentMasterDetails]  WITH CHECK ADD  CONSTRAINT [FK_SMSPaymentMasterDetails_SMSPaymentMasters] FOREIGN KEY([SMSPaymentMasterID])
REFERENCES [dbo].[SMSPaymentMasters] ([SMSPaymentMasterID])
GO

ALTER TABLE [dbo].[SMSPaymentMasterDetails] CHECK CONSTRAINT [FK_SMSPaymentMasterDetails_SMSPaymentMasters]
GO

ALTER TABLE [dbo].[SMSPaymentMasterDetails]  WITH CHECK ADD  CONSTRAINT [FK_SMSPaymentMasterDetails_Users] FOREIGN KEY([CreatedBy])
REFERENCES [dbo].[Users] ([Id])
GO

ALTER TABLE [dbo].[SMSPaymentMasterDetails] CHECK CONSTRAINT [FK_SMSPaymentMasterDetails_Users]
GO


-------------Nahid--------------
----------28-12-2023------------
------------2nd Phase-----------

Create PROC [dbo].[GetDatewiseSecurityBalance]
(
		@concernId INT,
		@SceHeadId INT,
		@asOnDate datetime,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.SIHID,
		(
			(
				ISNULL(piv.TakeSecurity, 0)
			)
			-
			(
				ISNULL(piv.GiveSecurity, 0)
			)
		) 'TotalDue'

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningBalance, 0)) PrevSales, 'OpeningDue' Id, c.SIHID FROM ShareInvestmentHeads c 
	WHERE c.ConcernID = @ConcernID AND c.Balance  != 0 AND c.ParentId = 6
	AND (@SceHeadId = 0 OR c.SIHID = @SceHeadId)
	GROUP BY c.SIHID, c.Name
	UNION ALL
	--start here 
	

	-- end here
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SIHID  FROM
	(
	SELECT bt.Amount PrevSales, 'TakeSecurity' Id, bt.SIHID FROM dbo.ShareInvestments bt
	JOIN ShareInvestmentHeads b ON bt.SIHID = b.SIHID
	WHERE bt.ConcernID = @concernId AND b.ParentId = 6 AND
	bt.TransactionType IN(1) AND bt.LiabilityType = 9
	AND (@SceHeadId = 0 OR bt.SIHID = @SceHeadId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.SIHID, bt.Amount
	) tblPO
	GROUP BY tblPO.Id, tblPO.SIHID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SIHID  FROM
	(
	SELECT bt.Amount PrevSales, 'GiveSecurity' Id, bt.SIHID FROM dbo.ShareInvestments bt
	JOIN ShareInvestmentHeads b ON bt.SIHID = b.SIHID
	WHERE bt.ConcernID = @concernId AND b.ParentId = 6 AND
	bt.TransactionType IN(2) AND bt.LiabilityType = 10
	AND (@SceHeadId = 0 OR bt.SIHID = @SceHeadId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.SIHID, bt.Amount
	) tblPO
	GROUP BY tblPO.Id, tblPO.SIHID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			TakeSecurity, GiveSecurity,OpeningDue

		)
	) piv
 END


-------------------------------------------------------------------------------------------------------------------------

Create PROC [dbo].[GetDatewiseFixedAssestBalance]
(
		@concernId INT,
		@FixedHeadId INT,
		@asOnDate datetime,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.SIHID,
		(
			(
				ISNULL(piv.AddFixedAssestAmt, 0)
			)
		) 'TotalDue'

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningBalance, 0)) PrevSales, 'OpeningDue' Id, c.SIHID FROM ShareInvestmentHeads c 
	WHERE c.ConcernID = @ConcernID AND c.Balance  != 0 AND c.ParentId = 1
	AND (@FixedHeadId = 0 OR c.SIHID = @FixedHeadId)
	GROUP BY c.SIHID, c.Name
	UNION ALL
	--start here 
	

	-- end here
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SIHID  FROM
	(
	SELECT bt.Amount PrevSales, 'AddFixedAssestAmt' Id, bt.SIHID FROM dbo.ShareInvestments bt
	JOIN ShareInvestmentHeads b ON bt.SIHID = b.SIHID
	WHERE bt.ConcernID = @concernId AND b.ParentId = 1 AND
	bt.TransactionType IN(1) AND bt.LiabilityType = 0
	AND (@FixedHeadId = 0 OR bt.SIHID = @FixedHeadId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.SIHID, bt.Amount
	) tblPO
	GROUP BY tblPO.Id, tblPO.SIHID


	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			AddFixedAssestAmt,OpeningDue

		)
	) piv
 END
-------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[sp_BalanceSheetNew]
(
  @AsOnDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int, IsHeader BIT)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int, IsHeader BIT)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int, IsHeader BIT)


------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@AsOnDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@AsOnDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Cash in hand',0.00,@TotalCashInHand,7, 0)

-------------------------------------------Cash at the bank--------------------------------------------
--set @TotalIncome=0
--set @TotalExpense=0
----Deposit
--set @TotalIncome= @TotalIncome + ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
----Collection from Customer
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)

----Withdraw
--set @TotalExpense= ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)

----Delivery to suppliers
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)

--declare @allBankOpening DECIMAL(18,2) = (SELECT ISNULL(SUM(OpeningBalance), 0) FROM Banks WHERE ConcernID = @ConcernID)



--IF(@TotalIncome-@TotalExpense!=0)
--Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Cash at Bank',0.00, (@TotalIncome-@TotalExpense) + @allBankOpening,8, 0)



-----------------------Bank Balance Indiviual------------------------
declare @BankBalance decimal(18,2)


SET @BankBalance = (SELECT SUM(ISNULL(TotalAmount, 0)) FROM dbo.Banks WHERE @ConcernID = ConcernID)
DECLARE @payBL INT = 8;
IF(@BankBalance != 0)
	BEGIN
		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Bank Balance',0,0,@payBL, 1)
		create table #tmpBankBalance (BankID INT, TotalAmount DECIMAL(18,2))


		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
			EXEC dbo.GetDatewiseBankBalance  @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @BankBalance = (SELECT SUM(TotalAmount) FROM #tmpBankBalance)
		

		DECLARE @totalBankOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningBalance, 0)) FROM dbo.Banks WHERE ConcernID = @ConcernID)

		SET @BankBalance = @BankBalance + @totalBankOpeningDue

		INSERT INTO #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.BankName, 0, (tb.TotalAmount + s.OpeningBalance), @payBL + 1, 0 FROM #tmpBankBalance tb
		JOIN dbo.Banks s ON tb.BankID = s.BankID
		WHERE tb.TotalAmount != 0

		SET @payBL = @payBL + (SELECT COUNT(BankID) FROM #tmpBankBalance) + 1;

		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Bank Balance',0,@BankBalance,@payBL, 1)
		drop TABLE #tmpBankBalance
	END
-----------------------Fixed Assest Indiviual------------------------
declare @FixAssestBalance decimal(18,2)


SET @FixAssestBalance = (SELECT SUM(ISNULL(Balance, 0)) FROM dbo.ShareInvestmentHeads WHERE @ConcernID = ConcernID AND ParentId = 1)
DECLARE @payFBL INT = @payBL + 1;
IF(@FixAssestBalance != 0)
	BEGIN
		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Fixed Asset',0,0,@payFBL, 1)
		create table #tmpFixAsBalance (SIHID INT, Balance DECIMAL(18,2))


		INSERT INTO #tmpFixAsBalance(SIHID, Balance)
			EXEC dbo.GetDatewiseFixedAssestBalance  @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @FixAssestBalance = (SELECT SUM(Balance) FROM #tmpFixAsBalance)
		

		DECLARE @totalFixAsOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningBalance, 0)) FROM dbo.ShareInvestmentHeads WHERE ConcernID = @ConcernID AND ParentId = 1)

		SET @FixAssestBalance = @FixAssestBalance + @totalFixAsOpeningDue

		INSERT INTO #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.Name, 0, (tb.Balance + s.OpeningBalance), @payFBL + 1, 0 FROM #tmpFixAsBalance tb
		JOIN dbo.ShareInvestmentHeads s ON tb.SIHID = s.SIHID
		WHERE tb.Balance != 0

		SET @payFBL = @payFBL + (SELECT COUNT(SIHID) FROM #tmpFixAsBalance) + 1;

		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Fixed Asset',0,@FixAssestBalance,@payFBL, 1)
		drop TABLE #tmpFixAsBalance
	END
-----------------------Supplier Due------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)


SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)
DECLARE @paySL INT = 2;
IF(@SupplierDue != 0)
	BEGIN
		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Account Payable',0,0,@paySL, 1)
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		

		DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue + @totalOpeningDue

		INSERT INTO #temp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.Name, (ts.TotalDue + s.OpeningDue), 0, @paySL + 1, 0 FROM #tmpSupplierDue ts
		JOIN dbo.Suppliers s ON ts.SupplierID = s.SupplierID
		WHERE ts.TotalDue != 0

		SET @paySL = @paySL + (SELECT COUNT(SupplierID) FROM #tmpSupplierDue) + 1;

		--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,4)
		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Account Payable',@SupplierDue,0,@paySL, 1)
		drop TABLE #tmpSupplierDue
	END

-----------------------Security Last Balance------------------------
declare @SecHeadBalance decimal(18,2)



SET @SecHeadBalance = (SELECT SUM(ISNULL(Balance, 0)) FROM dbo.ShareInvestmentHeads WHERE @ConcernID = ConcernID AND ParentId = 6)
DECLARE @paySHL INT = @paySL + 1;
IF(@SecHeadBalance != 0)
	BEGIN
		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Security',0,0,@paySHL, 1)
		create table #tmpSecDue(SIHID INT, Balance DECIMAL(18,2))


		INSERT INTO #tmpSecDue(SIHID, Balance)
			EXEC dbo.GetDatewiseSecurityBalance @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @SecHeadBalance = (SELECT SUM(Balance) FROM #tmpSecDue)
		

		DECLARE @totalSecOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningBalance, 0)) FROM dbo.ShareInvestmentHeads WHERE ConcernID = @ConcernID)

		SET @SecHeadBalance = @SecHeadBalance + @totalSecOpeningDue

		INSERT INTO #temp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.Name, (ts.Balance + s.OpeningBalance), 0, @paySHL + 1, 0 FROM #tmpSecDue ts
		JOIN dbo.ShareInvestmentHeads s ON ts.SIHID = s.SIHID
		WHERE ts.Balance != 0

		SET @paySHL = @paySHL + (SELECT COUNT(SIHID) FROM #tmpSecDue) + 1;

		--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,4)
		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Security',@SecHeadBalance,0,@paySHL, 1)
		drop TABLE #tmpSecDue
	END




----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Inventory',0,0,2, 0) --amount will come from another sp, follow c# method

----------------------------------------Customer Due----------------------------



Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Account Receivable',0,0,2, 0) --amount will come from another sp, follow c# method



-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum, IsHeader)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum,
	t.IsHeader
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum, IsHeader)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum,
	t.IsHeader
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit, SerialNum as SL, IsHeader from #fTemp
GROUP BY DebitParticular, CreditParticular, SerialNum, IsHeader
order by SL




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--EXEC sp_BalanceSheetNew  '2023-11-07', 5213



-------------Nahid--------------
----------28-12-2023------------
--------------------------------

/****** Object:  StoredProcedure [dbo].[GetDatewiseBankBalance]    Script Date: 28-Dec-23 03:22:01 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- exec GetDatewiseBankBalance 5275,0,  '28 Dec 2023 12:00:00 AM','28 Dec 2023 12:00:00 AM','28 Dec 2023 12:00:00 AM'

Create PROC [dbo].[GetDatewiseBankBalance]
(
		@concernId INT,
		@BankId INT,
		@asOnDate datetime,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.BankID,
		(
			(
				ISNULL(piv.FundIN, 0) 
				+ ISNULL(piv.AnotherFundIN, 0)
			)
			-
			(
				ISNULL(piv.FundOut, 0)
			)
		) 'TotalDue'

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningBalance, 0)) PrevSales, 'OpeningDue' Id, c.BankID FROM Banks c 
	WHERE c.ConcernID = @ConcernID AND c.TotalAmount  != 0 
	AND (@BankId = 0 OR c.BankID = @BankId)
	GROUP BY c.BankID, c.BankName
	UNION ALL
	--start here 
	

	-- end here
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.BankID  FROM
	(
	SELECT bt.Amount PrevSales, 'FundIN' Id, bt.BankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.BankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN(1, 3, 9, 7)
	AND (@BankId = 0 OR bt.BankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.BankID, bt.Amount, bt.TransactionNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.BankID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.BankID  FROM
	(
	SELECT bt.Amount PrevSales, 'AnotherFundIN' Id, bt.BankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.BankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN(5)
	AND (@BankId = 0 OR bt.BankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.BankID, bt.Amount, bt.TransactionNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.BankID

	UNION ALL
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.BankID  FROM
	(
	SELECT bt.Amount PrevSales, 'FundOut' Id, bt.BankID FROM dbo.BankTransactions bt
	JOIN Banks b ON bt.BankID = b.BankID
	WHERE bt.ConcernID = @concernId AND 
	bt.TransactionType IN (2, 4, 8, 6, 5)
	AND (@BankId = 0 OR bt.BankID = @BankId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY bt.BankID, bt.Amount, bt.TransactionNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.BankID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			FundIN, FundOut, AnotherFundIN,OpeningDue

		)
	) piv
 END


---------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[sp_BalanceSheetNew]
(
  @AsOnDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int, IsHeader BIT)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int, IsHeader BIT)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int, IsHeader BIT)


------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@AsOnDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@AsOnDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Cash in hand',0.00,@TotalCashInHand,7, 0)

-------------------------------------------Cash at the bank--------------------------------------------
--set @TotalIncome=0
--set @TotalExpense=0
----Deposit
--set @TotalIncome= @TotalIncome + ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
----Collection from Customer
--set @TotalIncome=@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)

----Withdraw
--set @TotalExpense= ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)

----Delivery to suppliers
--set @TotalExpense=@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)

--declare @allBankOpening DECIMAL(18,2) = (SELECT ISNULL(SUM(OpeningBalance), 0) FROM Banks WHERE ConcernID = @ConcernID)



--IF(@TotalIncome-@TotalExpense!=0)
--Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Cash at Bank',0.00, (@TotalIncome-@TotalExpense) + @allBankOpening,8, 0)



-----------------------Bank Balance Indiviual------------------------
declare @BankBalance decimal(18,2)


SET @BankBalance = (SELECT SUM(ISNULL(TotalAmount, 0)) FROM dbo.Banks WHERE @ConcernID = ConcernID)
DECLARE @payBL INT = 8;
IF(@BankBalance != 0)
	BEGIN
		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Bank Balance',0,0,@payBL, 1)
		create table #tmpBankBalance (BankID INT, TotalAmount DECIMAL(18,2))


		INSERT INTO #tmpBankBalance(BankID, TotalAmount)
			EXEC dbo.GetDatewiseBankBalance  @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @BankBalance = (SELECT SUM(TotalAmount) FROM #tmpBankBalance)
		

		DECLARE @totalBankOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningBalance, 0)) FROM dbo.Banks WHERE ConcernID = @ConcernID)

		SET @BankBalance = @BankBalance + @totalBankOpeningDue

		INSERT INTO #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.BankName, 0, (tb.TotalAmount + s.OpeningBalance), @payBL + 1, 0 FROM #tmpBankBalance tb
		JOIN dbo.Banks s ON tb.BankID = s.BankID
		WHERE tb.TotalAmount != 0

		SET @payBL = @payBL + (SELECT COUNT(BankID) FROM #tmpBankBalance) + 1;

		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Bank Balance',0,@BankBalance,@payBL, 1)
		drop TABLE #tmpBankBalance
	END

-----------------------Supplier Due------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)


SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)
DECLARE @paySL INT = 2;
IF(@SupplierDue != 0)
	BEGIN
		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Account Payable',0,0,@paySL, 1)
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		

		DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue + @totalOpeningDue

		INSERT INTO #temp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.Name, (ts.TotalDue + s.OpeningDue), 0, @paySL + 1, 0 FROM #tmpSupplierDue ts
		JOIN dbo.Suppliers s ON ts.SupplierID = s.SupplierID
		WHERE ts.TotalDue != 0

		SET @paySL = @paySL + (SELECT COUNT(SupplierID) FROM #tmpSupplierDue) + 1;

		--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,4)
		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Account Payable',@SupplierDue,0,@paySL, 1)
		drop TABLE #tmpSupplierDue
	END




----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Inventory',0,0,2, 0) --amount will come from another sp, follow c# method

----------------------------------------Customer Due----------------------------



Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Account Receivable',0,0,2, 0) --amount will come from another sp, follow c# method



-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum, IsHeader)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum,
	t.IsHeader
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum, IsHeader)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum,
	t.IsHeader
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit, SerialNum as SL, IsHeader from #fTemp
GROUP BY DebitParticular, CreditParticular, SerialNum, IsHeader
order by SL




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--EXEC sp_BalanceSheetNew  '2023-11-07', 5213

-------------Mostafizur---------
----------14-12-2023------------
--------------------------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[UpdateTotalDuePaymentReturn]
(
	@SupId int,
	@BankDepositId int,
	@BankWithdrawId int,
	@CollectionAmount decimal(18,2)
)
  
AS 

 IF(@SupId>0)
BEGIN
	UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue + @CollectionAmount)
	where SupplierID=@SupId
END


 IF(@BankDepositId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount + @CollectionAmount)
	where BankID=@BankDepositId
END
  
 IF(@BankWithdrawId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount + @CollectionAmount)
	where BankID=@BankWithdrawId
END

RETURN






GO

-------------Mostafizur---------
----------28-11-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_ProfitandLossAccount '2020-01-01 00:00:00','2020-05-04 23:59:59',1
ALTER PROCEDURE [dbo].[sp_ProfitandLossAccount] (@Fromdate DATETIME, @ToDate DATETIME, @ConcernID INT)
AS
BEGIN
	CREATE TABLE #temp (ID INT identity(1, 1) NOT NULL, DebitParticulars NVARCHAR(MAX), Debit DECIMAL(18, 2), CreditParticulars NVARCHAR(MAX), Credit DECIMAL(18, 2), SerialNum INT)

	DECLARE @TotalIncome DECIMAL(18, 2)
	DECLARE @TotalSalesReturn DECIMAL(18, 2)
	DECLARE @TotalPOReturn DECIMAL(18, 2)
	DECLARE @TotalExpense DECIMAL(18, 2)
	DECLARE @LastPayAdjust DECIMAL(18, 2)
	DECLARE @DebitAdjusment DECIMAL(18, 2)
	DECLARE @CreditAdjusment DECIMAL(18, 2)
	DECLARE @SupplierDebitAdjusment DECIMAL(18, 2)
	DECLARE @SupplierCreditAdjusment DECIMAL(18, 2)


	SET @TotalIncome = 0
	SET @TotalExpense = 0

	SELECT @TotalIncome = ISNULL(SUM(SOD.Quantity * ((SOD.UnitPrice - SOD.PPDAmount) - (((SOD.UnitPrice - SOD.PPDAmount) * (SO.TDAmount + SO.AdjAmount)) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)))), 0),
	@TotalExpense = ISNULL(SUM(SOD.PRate * SOD.Quantity), 0)
	FROM SOrderDetails SOD
	INNER JOIN SOrders SO
		ON SOD.SOrderID = SO.SOrderID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.SDetailID
	WHERE SO.STATUS = 1 AND SO.IsReplacement=0 AND (SO.InvoiceDate >= @Fromdate AND SO.InvoiceDate <= @ToDate) AND SO.ConcernID = @ConcernID

	SELECT @TotalSalesReturn = ISNULL(SUM(SOD.Quantity * SOD.UnitPrice), 0), @TotalPOReturn = ISNULL(SUM(STD.PRate * SOD.Quantity), 0)
	FROM ROrderDetails SOD
	INNER JOIN ROrders SO
		ON SOD.ROrderID = SO.ROrderID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailID
	WHERE (SO.ReturnDate >= @Fromdate AND SO.ReturnDate <= @ToDate) AND SO.ConcernID = @ConcernID

	--Print(Convert(varchar(123),@TotalIncome))
	--Print(Convert(varchar(123),@TotalExpense))
	SELECT @TotalIncome = @TotalIncome + ISNULL(SUM(CSP.Quantity * (CSP.UnitPrice - (CS.Discount * CSP.UnitPrice / CS.TSalesAmt))), 0),
	--+ISNULL(SUM((((((CS.InterestAmount) / (CS.TSalesAmt - CS.InterestAmount)) * (CSP.UnitPrice))) * CSP.Quantity) - (((((CS.Discount) / (CS.TSalesAmt - CS.InterestAmount)) * (CSP.UnitPrice))) * CSP.Quantity)),0), 
	@TotalExpense = @TotalExpense + ISNULL(SUM(STD.PRate * CSP.Quantity), 0)
	FROM CreditSaleDetails CSP
	INNER JOIN CreditSales CS
		ON CS.CreditSalesID = CSP.CreditSalesID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = CSP.StockDetailID
	WHERE CS.IsStatus = 1 AND CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CS.ConcernID = @ConcernID
	--Print(Convert(varchar(123),@TotalIncome))
	SELECT @TotalIncome = @TotalIncome + ISNULL(SUM(HireValue), 0)
	FROM CreditSales CS
	INNER JOIN CreditSaleDetails CSP
		ON CSP.CreditSalesID = CS.CreditSalesID
	INNER JOIN CreditSalesSchedules CSD
		ON CSD.CreditSalesID = CS.CreditSalesID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = CSP.StockDetailID
	WHERE Cs.IsStatus = 1 AND CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Purchase', ISNULL(@TotalExpense, 0), '', 0.00, 1)

	IF(@TotalPOReturn>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Purchase Return', ISNULL(@TotalPOReturn, 0), '', 0.00, 2)

	IF(ISNULL(@TotalExpense - @TotalPOReturn, 0)!=0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Net Purchase', ISNULL(@TotalExpense - @TotalPOReturn, 0), '', 0.00, 3)

	IF(@TotalIncome!=0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Sales', @TotalIncome, 4)

	IF(@TotalSalesReturn>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Sales Return', @TotalSalesReturn, 5)

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Net Sales', (@TotalIncome - @TotalSalesReturn), 6)

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Gross Profit', ISNULL((@TotalIncome - @TotalSalesReturn) - (@TotalExpense - @TotalPOReturn), 0), 7)

	--Last Pay adjustment
	SELECT @LastPayAdjust = ISNULL(SUM(CSD.LastPayAdjust), 0)
	FROM CreditSales CS
	INNER JOIN CreditSalesSchedules CSD
		ON CSD.CreditSalesID = CS.CreditSalesID
	WHERE Cs.IsStatus = 1 AND CSD.PaymentDate >= @Fromdate AND CSD.PaymentDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID

	SELECT @LastPayAdjust = @LastPayAdjust + ISNULL(SUM(CS.AdjustAmt), 0)
	FROM CashCollections CS
	WHERE Cs.TransactionType = 1 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@LastPayAdjust>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Adjustment', ISNULL(@LastPayAdjust, 0), '', 0.00, 8)


	--Debit Adjustment
	SELECT @DebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 7 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@DebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Customer Debit Adjustment', ISNULL(@DebitAdjusment, 0), '', 0.00, 13)

		
	--Credit Adjustment
	SELECT @CreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 6 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@CreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)	
	VALUES ('', 0.00, 'Customer Credit Adjustment', ISNULL(@CreditAdjusment, 0), 15)

	

	--Supplier Debit Adjustment
	SELECT @SupplierDebitAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 6 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0
	
	IF(@SupplierDebitAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Supplier Debit Adjustment', ISNULL(@SupplierDebitAdjusment, 0), '', 0.00, 14)

		
	--Supplier Credit Adjustment
	SELECT @SupplierCreditAdjusment = ISNULL(SUM(CS.Amount), 0)
	FROM CashCollections CS	
	WHERE Cs.TransactionType = 7 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.SupplierID > 0
	
	IF(@SupplierCreditAdjusment>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.00, 'Supplier Credit Adjustment', ISNULL(@SupplierCreditAdjusment, 0), 16)

	---------------------Income----------------------
	set @TotalIncome = ISNULL((	SELECT SUM(ex.Amount)
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 2 and ex.CashInHandReportStatus = 0),0)

	IF(@TotalIncome>0)
	BEGIN
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	SELECT '', 0.00, exi.Description, ex.Amount, 9
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 2 and ex.CashInHandReportStatus = 0

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES('',0.00,'Total Income',@TotalIncome,10)
	END

	-----------------------expense----------------------
	set @TotalExpense = ISNULL((SELECT SUM( ex.Amount)
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 1 AND exi.Description != 'Send cash to head of accounts' and ex.CashInHandReportStatus = 0
    ),0)

	IF(@TotalExpense>0)
	BEGIN
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	SELECT exi.Description, ex.Amount, '', 0.00, 11
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 1 AND exi.Description != 'Send cash to head of accounts' and ex.CashInHandReportStatus = 0

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES('Total Expense',@TotalExpense,'',0.00,12)
	END

	SELECT SerialNum, DebitParticulars, sum(Debit) 'Debit', CreditParticulars, sum(Credit) 'Credit'
	FROM #temp
	GROUP BY DebitParticulars, CreditParticulars, SerialNum
	ORDER BY SerialNum ASC
		--Print(Convert(varchar(123),@TotalIncome))



END


-------------Mostafizur---------
----------27-11-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int
Declare @TQty decimal(18,2)

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate,
		Remarks = s.Remarks,
		TramsAndCondition = s.TramsAndCondition,
		CardTypeSetupID=s.CardTypeSetupID,
		CardPaidAmount=s.CardPaidAmount,
		DepositChargePercent=s.DepositChargePercent,
		BankTransID=@BankTransID
		--TSQty = @TQty
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)

	Set @TQty=ISNULL((Select sum(Quantity) from SOrderDetails where SOrderID=@SalesOrderId),0)
	Update SOrders set TSQty=@TQty where SOrderID=@SalesOrderId

	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	--For No barcode Stock Details out and SOrderDetails Insert
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @GodownID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity  decimal(18,2)
	DECLARE @StockQty decimal(18,2)
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.ProductId,
		colorid,
		Compressor,
		s.quantity,
		sorderdetailid
	FROM @SODetails s
    JOIN products ON products.productid = s.productid
	WHERE (products.ProductType = 2 and S.Status=3)

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE (@Quantity != 0)
		BEGIN
			SET @SDetailID = (
					SELECT Min(SDetailID)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @StockQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)
				------------------Debug-------------------------
				--INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
				--VALUES('ProductID: '+Convert(varchar(40),@ProductID)+'Stock Qty:'+Convert(varchar(40),@StockQty),'ColorID: '+Convert(varchar(40),@ColorID)+'GodownID: '+Convert(varchar(40),@GodownID),1,GETDATE())
				----------------------------
			IF (@StockQty > @Quantity)
			BEGIN
				SET @StockQty = @StockQty - @Quantity
			
				UPDATE stockdetails
				SET quantity = @StockQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)

				SET @Quantity = 0
			END
			ELSE IF (@StockQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @StockQty
			
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@StockQty,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID
				
				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

--New Products FIFO END




	--***************************************
	--*********SR visit Update***************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0


	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH

------------------------------------------------------


-------------Mostafizur---------
----------27-11-2023------------
--------------------------------


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[AddSalesOrder] (
	@SalesOrder [INSERTSALESORDERTABLE] readonly,
	@SODetails [INSERTSODETAILTABLE] readonly,
	@RemindDate DATE,
	@BankTrans [InsertBankTransTable] readonly,
	@SorderID int out,
	@Result int Out
	)
AS
DECLARE @SalesOrderId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY
	BEGIN TRANSACTION

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @SalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	INSERT INTO sorders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		TramsAndCondition,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID,
		TSQty,
		PrevDue FROM @SalesOrder
		)

	SET @SalesOrderId = Scope_identity()

	INSERT INTO SOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.TAmount,
		SOD.PPDisPer,
		SOD.PPDisAmt,
		SOD.MrpRate,
		@SalesOrderId SOrderID,
		SOD.StockDetailId,
		SOD.PPOffer,
		(SOD.UnitPrice - SOD.PPDisAmt),
		STD.PRate,
		p.CompressorWarrentyMonth,
		p.PanelWarrentyMonth,
		p.MotorWarrentyMonth,
		p.SparePartsWarrentyMonth,
		p.ServiceWarrentyMonth FROM @SODetails SOD INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailId INNER JOIN Products p
		ON STD.ProductID = p.ProductID WHERE P.ProductType = 1 OR p.ProductType = 3
		)

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue),
		reminddate = @RemindDate
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NOT NULL

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue)
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NULL

	--Stock Update 
	CREATE TABLE #tmpStock (
		ProductID INT,
		ColorID INT,
		GodownID INT,
		Qty DECIMAL(18, 2)
		)

	INSERT INTO #tmpStock (
		ProductID,
		ColorID,
		GodownID,
		Qty
		) (
		SELECT s.ProductID,
		s.ColorID,
		s.Compressor,
		SUM(s.Quantity) FROM @SODetails s 
		GROUP BY s.ProductId,
		s.ColorId,
		s.Compressor
		)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st
		ON st.ProductID = sod.ProductID AND st.ColorID = sod.ColorID AND st.GodownID = sod.GodownID

	--For barCode Product 
	UPDATE stockdetails
	SET stockdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN stockdetails
		ON stockdetails.sdetailid = s.stockdetailid
	INNER JOIN products
		ON stockdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	--*****************FIFO for Nobarcode************************** 
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @GodownID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity INT
	DECLARE @SQty INT
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.productid,
		colorid,
		s.Compressor,
		quantity,
		sorderdetailid
	FROM @SODetails s
	INNER JOIN products
		ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity != 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)

			IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity

				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.Compressor=@GodownID AND SOD.colorid = @ColorID
					)

				SET @Quantity = 0
			END
			ELSE IF (@SQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @SQty

				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@SQty,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @SQty),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

	--For barCode Product SRVisit Status update 
	UPDATE srvproductdetails
	SET srvproductdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN srvproductdetails
		ON srvproductdetails.sdetailid = s.stockdetailid AND srvproductdetails.STATUS = 1
	INNER JOIN products
		ON srvproductdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	COMMIT

	SELECT @SorderID=@SalesOrderId,@Result=1;
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	SELECT @SorderID=0,@Result=0
END CATCH

-------------Mostafizur---------
----------27-11-2023------------
--------------------------------

EXEC sys.sp_rename 'dbo.InsertSalesOrderTable', 'zInsertSalesOrderTable';
GO

CREATE TYPE [dbo].[InsertSalesOrderTable] AS TABLE(
	[InvoiceDate] [datetime] NULL,
	[InvoiceNo] [varchar](150) NULL,
	[VatPercentage] [decimal](18, 2) NULL,
	[VatAmount] [decimal](18, 2) NULL,
	[GrandTotal] [decimal](18, 2) NULL,
	[TDiscountPercentage] [decimal](18, 4) NULL,
	[TDiscountAmount] [decimal](18, 2) NULL,
	[RecAmt] [decimal](18, 2) NULL,
	[PaymentDue] [decimal](18, 2) NULL,
	[TotalAmount] [decimal](18, 2) NULL,
	[TotalDue] [decimal](18, 2) NULL,
	[AdjAmount] [decimal](18, 2) NULL,
	[Status] [int] NULL,
	[CustomerId] [int] NULL,
	[ConcernId] [int] NULL,
	[CreatedBy] [int] NULL,
	[CreateDate] [datetime] NULL,
	[TotalOffer] [decimal](18, 2) NULL,
	[NetDiscount] [decimal](18, 2) NULL,
	[Remarks] [varchar](150) NULL,
	[TramsAndCondition] [varchar](Max) NULL,
	[CardPaidAmount] [decimal](18, 2) NULL,
	[CardTypeSetupID] [int] NULL,
	[DepositChargePercent] [decimal](18, 2) NULL,
	[TSQty] [decimal](18, 2) NULL,
	[PrevDue] [decimal](18, 2) NULL
)
GO

DECLARE @Name NVARCHAR(776);

DECLARE REF_CURSOR CURSOR FOR
SELECT referencing_schema_name + '.' + referencing_entity_name
FROM sys.dm_sql_referencing_entities('dbo.InsertSalesOrderTable', 'TYPE');

OPEN REF_CURSOR;

FETCH NEXT FROM REF_CURSOR INTO @Name;
WHILE (@@FETCH_STATUS = 0)
BEGIN
    EXEC sys.sp_refreshsqlmodule @name = @Name;
    FETCH NEXT FROM REF_CURSOR INTO @Name;
END;

CLOSE REF_CURSOR;
DEALLOCATE REF_CURSOR;
GO
DROP TYPE dbo.zInsertSalesOrderTable;
GO


-------------Mostafizur---------
----------27-11-2023------------
--------------------------------

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	TramsAndCondition bit NOT NULL CONSTRAINT DF_SystemInformations_TramsAndCondition DEFAULT ((0))
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

-------------Mostafizur---------
----------27-11-2023------------
--------------------------------

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SOrders ADD
	TramsAndCondition nvarchar(MAX) NULL
GO
ALTER TABLE dbo.SOrders SET (LOCK_ESCALATION = TABLE)
GO
COMMIT


-------------Nahid--------------
----------23-11-2023------------
--------------------------------

Create PROC [dbo].[GetDatewiseCustomerDueRptRetail]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 1
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 1
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 1
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
GO


-------------------------------------------------------------------------------------------------------------------------------


Create PROC [dbo].[GetDatewiseCustomerDueRptDealer]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 2
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 2
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 2
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 2
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
GO

-------------------------------------------------------------------------------------------------------------------------------


Create PROC [dbo].[GetDatewiseCustomerDueRptHire]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 3
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 3
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 3
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 3
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
GO

-------------------------------------------------------------------------------------------------------------------------------


Create PROC [dbo].[GetDatewiseCustomerDueRptBranch]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1 and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID and c.CustomerType = 4
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID  and c.CustomerType = 4
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID 
	WHERE cs.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID and c.CustomerType = 4
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID  and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID  and c.CustomerType = 4
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END
GO



-------------Nahid--------------
----------20-11-2023------------
--------------------------------

ALTER PROC [dbo].[GetDatewiseSupplierDue]
(
		@concernId INT
		,@SupplierId INT,
		@asOnDate datetime,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.SupplierID,
		(
			(
				ISNULL(piv.TotalAmt, 0) 
				+ ISNULL(piv.TotalReturnRecAmt, 0) + ISNULL(piv.CashCollectionIntAmt, 0) + ISNULL(piv.CashCollectionDebitAdjAmt, 0)
			)
			-
			(
				ISNULL(piv.TotalRecAmt, 0) 
				+ ISNULL(piv.TotalReturnAmt, 0) + ISNULL(piv.CashCollectionAmt, 0) + ISNULL(piv.BankTransaction, 0) + ISNULL(piv.CashCollectionCreditAdjAmt, 0) 
			)
		) 'TotalDue'

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.SupplierID FROM Suppliers c 
	WHERE c.ConcernID = @ConcernID AND c.TotalDue  != 0 
	AND (@SupplierId = 0 OR c.SupplierID = @SupplierId)
	GROUP BY c.SupplierID, c.Address
	UNION ALL
	--start here 
	

	-- end here
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SupplierID  FROM
	(
	SELECT po.TotalAmt PrevSales, 'TotalAmt' Id, po.SupplierID FROM dbo.POrders po
	JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
	JOIN dbo.Products p ON p.ProductID = pd.ProductID
	WHERE po.ConcernID = @concernId
	AND po.Status = 1
	AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY po.SupplierID, po.TotalAmt, po.ChallanNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.SupplierID

	UNION ALL

	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SupplierID  FROM
	(
	SELECT po.RecAmt PrevSales, 'TotalRecAmt' Id, po.SupplierID FROM dbo.POrders po
	JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
	JOIN dbo.Products p ON p.ProductID = pd.ProductID
	WHERE po.ConcernID = @concernId
	AND po.Status = 1
	AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY po.SupplierID, po.RecAmt, po.ChallanNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.SupplierID
	
	UNION ALL
	SELECT SUM(tblReturn.PrevSales) PrevSales, tblReturn.Id, tblReturn.SupplierID FROM
	(
		SELECT po.TotalAmt PrevSales, 'TotalReturnAmt' Id, po.SupplierID FROM dbo.POrders po
		JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
		JOIN dbo.Products p ON p.ProductID = pd.ProductID
		WHERE po.ConcernID = @concernId
		AND po.Status = 5
		AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
		AND (
			(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
				OR
			(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
		)
		GROUP BY po.SupplierID, po.TotalAmt, po.ChallanNo
	) tblReturn
	GROUP BY tblReturn.Id, tblReturn.SupplierID
	UNION ALL

		SELECT SUM(tblReturn.PrevSales) PrevSales, tblReturn.Id, tblReturn.SupplierID FROM
	(
		SELECT po.RecAmt PrevSales, 'TotalReturnRecAmt' Id, po.SupplierID FROM dbo.POrders po
		JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
		JOIN dbo.Products p ON p.ProductID = pd.ProductID
		WHERE po.ConcernID = @concernId
		AND po.Status = 5
		AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
		AND (
			(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
				OR
			(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
		)
		GROUP BY po.SupplierID, po.RecAmt, po.ChallanNo
	) tblReturn
	GROUP BY tblReturn.Id, tblReturn.SupplierID

	UNION ALL

	SELECT SUM(ISNULL(cc.InterestAmt, 0)), 'CashCollectionIntAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY cc.SupplierID
	
	UNION ALL

	SELECT SUM(ISNULL(cc.Amount, 0) + ISNULL(cc.AdjustAmt, 0)), 'CashCollectionAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId AND cc.TransactionType IN(2)
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY cc.SupplierID

	UNION ALL

	SELECT SUM(ISNULL(cc.Amount, 0) + ISNULL(cc.AdjustAmt, 0)), 'CashCollectionDebitAdjAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId AND cc.TransactionType IN(6)
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY cc.SupplierID

	UNION ALL

	SELECT SUM(ISNULL(cc.Amount, 0) + ISNULL(cc.AdjustAmt, 0)), 'CashCollectionCreditAdjAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId AND cc.TransactionType IN(7)
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY cc.SupplierID
	UNION ALL

	SELECT SUM(ISNULL(bt.Amount, 0)), 'BankTransaction', bt.SupplierID FROM dbo.BankTransactions bt
	WHERE bt.ConcernID = @concernId
	AND bt.SupplierID <> 0
	AND (@SupplierId = 0 OR bt.SupplierID = @SupplierId)
		AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY bt.SupplierID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			TotalAmt, TotalRecAmt, TotalReturnAmt, TotalReturnRecAmt, CashCollectionIntAmt, CashCollectionAmt, BankTransaction,CashCollectionDebitAdjAmt,CashCollectionCreditAdjAmt,OpeningDue

		)
	) piv
 END

-------------Nahid--------------
----------19-11-2023------------
--------------------------------
ALTER PROC [dbo].[GetDatewiseSupplierDue]
(
		@concernId INT
		,@SupplierId INT,
		@asOnDate datetime,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.SupplierID,
		(
			(
				ISNULL(piv.TotalAmt, 0) 
				+ ISNULL(piv.TotalReturnRecAmt, 0) + ISNULL(piv.CashCollectionIntAmt, 0) + ISNULL(piv.CashCollectionDebitAdjAmt, 0)+ ISNULL(piv.OpeningDue, 0)
			)
			-
			(
				ISNULL(piv.TotalRecAmt, 0) 
				+ ISNULL(piv.TotalReturnAmt, 0) + ISNULL(piv.CashCollectionAmt, 0) + ISNULL(piv.BankTransaction, 0) + ISNULL(piv.CashCollectionCreditAdjAmt, 0)
			)
		) 'TotalDue'

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.SupplierID FROM Suppliers c 
	WHERE c.ConcernID = @ConcernID AND c.TotalDue  != 0 
	AND (@SupplierId = 0 OR c.SupplierID = @SupplierId)
	GROUP BY c.SupplierID, c.Address
	UNION ALL
	--start here 
	

	-- end here
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SupplierID  FROM
	(
	SELECT po.TotalAmt PrevSales, 'TotalAmt' Id, po.SupplierID FROM dbo.POrders po
	JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
	JOIN dbo.Products p ON p.ProductID = pd.ProductID
	WHERE po.ConcernID = @concernId
	AND po.Status = 1
	AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY po.SupplierID, po.TotalAmt, po.ChallanNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.SupplierID

	UNION ALL

	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SupplierID  FROM
	(
	SELECT po.RecAmt PrevSales, 'TotalRecAmt' Id, po.SupplierID FROM dbo.POrders po
	JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
	JOIN dbo.Products p ON p.ProductID = pd.ProductID
	WHERE po.ConcernID = @concernId
	AND po.Status = 1
	AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY po.SupplierID, po.RecAmt, po.ChallanNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.SupplierID
	
	UNION ALL
	SELECT SUM(tblReturn.PrevSales) PrevSales, tblReturn.Id, tblReturn.SupplierID FROM
	(
		SELECT po.TotalAmt PrevSales, 'TotalReturnAmt' Id, po.SupplierID FROM dbo.POrders po
		JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
		JOIN dbo.Products p ON p.ProductID = pd.ProductID
		WHERE po.ConcernID = @concernId
		AND po.Status = 5
		AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
		AND (
			(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
				OR
			(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
		)
		GROUP BY po.SupplierID, po.TotalAmt, po.ChallanNo
	) tblReturn
	GROUP BY tblReturn.Id, tblReturn.SupplierID
	UNION ALL

		SELECT SUM(tblReturn.PrevSales) PrevSales, tblReturn.Id, tblReturn.SupplierID FROM
	(
		SELECT po.RecAmt PrevSales, 'TotalReturnRecAmt' Id, po.SupplierID FROM dbo.POrders po
		JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
		JOIN dbo.Products p ON p.ProductID = pd.ProductID
		WHERE po.ConcernID = @concernId
		AND po.Status = 5
		AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
		AND (
			(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
				OR
			(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
		)
		GROUP BY po.SupplierID, po.RecAmt, po.ChallanNo
	) tblReturn
	GROUP BY tblReturn.Id, tblReturn.SupplierID

	UNION ALL

	SELECT SUM(ISNULL(cc.InterestAmt, 0)), 'CashCollectionIntAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY cc.SupplierID
	
	UNION ALL

	SELECT SUM(ISNULL(cc.Amount, 0) + ISNULL(cc.AdjustAmt, 0)), 'CashCollectionAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY cc.SupplierID

	UNION ALL

	SELECT SUM(ISNULL(cc.Amount, 0) + ISNULL(cc.AdjustAmt, 0)), 'CashCollectionDebitAdjAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId AND cc.TransactionType IN(6)
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY cc.SupplierID

	UNION ALL

	SELECT SUM(ISNULL(cc.Amount, 0) + ISNULL(cc.AdjustAmt, 0)), 'CashCollectionCreditAdjAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId AND cc.TransactionType IN(7)
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY cc.SupplierID
	UNION ALL

	SELECT SUM(ISNULL(bt.Amount, 0)), 'BankTransaction', bt.SupplierID FROM dbo.BankTransactions bt
	WHERE bt.ConcernID = @concernId
	AND bt.SupplierID <> 0
	AND (@SupplierId = 0 OR bt.SupplierID = @SupplierId)
		AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY bt.SupplierID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			TotalAmt, TotalRecAmt, TotalReturnAmt, TotalReturnRecAmt, CashCollectionIntAmt, CashCollectionAmt, BankTransaction,CashCollectionDebitAdjAmt,CashCollectionCreditAdjAmt,OpeningDue

		)
	) piv
 END

-------------Nahid--------------
----------14-11-2023------------
--------------------------------

--EXEC sp_DailyCashInHand  '11 MAY 2021 12:00:00 AM','11 MAY 2021 11:59:59 PM',16
ALTER procedure [dbo].[sp_DailyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-08-01'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)



create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(DAY, 1, Convert(date, GetDate()))
begin
	print @StartDate

	delete
	from #temp_Data1

	delete
	from #temp_Data2

	--	DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
	--	DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
	------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
	insert into #temp_Data1
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
				and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
		from POrders po
		join Suppliers s on po.SupplierID = s.SupplierID
		where po.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
		and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and po.RecAmt>0
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
	---------------------------------Expense from Bank Deposit--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

	END

	---------------------------------Expense from Bank Loan--------------------
	set @total = isnull((
				SELECT SUM(ISNULL(BC.CollectionAmount, 0) + ISNULL(BC.SDPS, 0) + ISNULL(BC.Savings,0)) FROM dbo.BankLoanCollections BC
				JOIN dbo.BankLoanDetails BLD ON BC.Id = BLD.LoanCollectionId
				JOIN  dbo.BankLoans BL ON BLD.BankLoanId = BL.Id
				JOIN dbo.Banks B ON BL.BankId = B.BankID
				where BL.ConcernID = @ConcernID AND BLD.LoanCollectionId IS NOT NULL
				AND CAST(BC.CollectionDate AS DATE) = CAST(@StartDate AS DATE)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Loan Payment', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ', ' + B.BankName, SUM(ISNULL(BC.CollectionAmount, 0) + ISNULL(BC.SDPS, 0) + ISNULL(BC.Savings,0)), 'Bank Loan', 0, 'Cash'
		FROM dbo.BankLoanCollections BC
		JOIN dbo.BankLoanDetails BLD ON BC.Id = BLD.LoanCollectionId
		JOIN  dbo.BankLoans BL ON BLD.BankLoanId = BL.Id
		JOIN dbo.Banks B ON BL.BankId = B.BankID
		where BL.ConcernID = @ConcernID AND BLD.LoanCollectionId IS NOT NULL
		AND CAST(BC.CollectionDate AS DATE) = CAST(@StartDate AS DATE)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Loan Payment', @total, '', 0, 'Header'

	END
	---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------


	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank collections', @total, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	inner join Customers c on BT.CustomerID = c.CustomerID
	where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
	group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	insert into #temp_Data1
	select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
	---------------------------------Expens from Bank Cash Delivery---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Cash Delivery', @total, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END

---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Income', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Income (Cr))', sum(Amount), 'Bank Income ', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Income ', @total, '', 0, 'Header'
END


	---------------------------------Expense from Fund Out---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections cc
				join Suppliers s on cc.SupplierID = s.SupplierID
				where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
				and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
		and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
	------------------------------------------------------Expense in Product return----------------------------------
	set @total = isnull((
				select sum(PaidAmount)
				from ROrders
				where ConcernID = @ConcernID and DAY(Convert(date, ReturnDate)) = DAY(@StartDate) and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

END

	-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Cash Collection Return', @total, 'Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

	------------- -------------------------------------------- Direct Expense--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' and EX.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' and EX.CashInHandReportStatus = 0
		and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description

		insert into #temp_Data1
		select @StartDate,'Total Expense', @total, '', 0, 'Header'
	end

		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID  and DAY(Convert(date, TransactionDate)) = DAY(@StartDate)
				and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and DAY(Convert(date, TransactionDate)) = DAY(@StartDate)
		and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
	------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
						where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end



	-- ----------------------------Expens from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=3  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END
	----------------------------------------------Opening Cash In Hand in Income Table--------------------------------------------------------------- 
	insert into #temp_Data2
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	-----------------------------------------------Income in Sales Order-------------------------------------------
	set @total = isnull((
				select sum(RecAmount)
				from SOrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount,Convert(varchar(10),c.CustomerType)+'Order' from SOrders so
		join Customers c on so.CustomerID = c.CustomerID
		where so.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
	    insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
   
   END
	---------------------------------Income from Bank Withdwal--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

				---------------------------------Income from Bank Expens as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Expens as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Bank Expens(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Loan--------------------
	set @total = ISNULL((
				SELECT SUM(BL.PrincipleLoanAmount) FROM dbo.BankLoans BL
				JOIN dbo.Banks B ON BL.BankId = B.BankID
				WHERE BL.ConcernId = @ConcernID
				AND CAST(BL.LoanDate AS DATE) = CAST(@StartDate AS DATE)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Loan', 0, 'Header'

		insert into #temp_Data2
		select @StartDate, '', 0, B.AccountNo + ',' + B.BankName, SUM(BL.PrincipleLoanAmount), 'Cash'
		FROM dbo.BankLoans BL
		JOIN dbo.Banks B ON BL.BankId = B.BankID
		where BL.ConcernID = @ConcernID
		AND CAST(BL.LoanDate AS DATE) = CAST(@StartDate AS DATE)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Loan', @total, 'Header'

	END


	---------------------------------Income from Bank Cash Collection---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
		('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on bt.CustomerID=c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	----------------------------------------Income from Fund IN------------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.AnotherBankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.AnotherBankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-- ---------------------------------------Income from Cash Collection from Customer-------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
				), 0)

	if (@total != 0)
	BEGIN
	insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, Convert(varchar(10),c.CustomerType)+'Cash'
		from CashCollections cc
		join Customers c on cc.CustomerID = c.CustomerID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
	    insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')
		
		END
	-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
	set @total = isnull((
				select isnull(sum(DownPayment), 0)
				from CreditSales
				where ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
		from CreditSales cs
		join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')
	
	END
	--------------------------------------Income in Purchase Product return----------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and DAY(Convert(date, OrderDate)) = DAY(@StartDate) and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and status = 5
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Purchase Return Cash'

	-------------------------------Income Installment Collection from Creditsales------------------
	set @total = isnull((
				select sum(InstallmentAmt)
				from CreditSalesSchedules css
				inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
				where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
		from CreditSalesSchedules css
		inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
		inner join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
	  
	  insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')
	
	END
	-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Description, sum(Amount), E.Description
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 2 and  EX.CashInHandReportStatus = 0 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')
	
	end

	-- ----------------------------Income from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
	END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
	-----------------------------------------------------------------------------------------------------------------------------------
	   SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)
	IF (@total != 0)
	BEGIN
		INSERT INTO #temp_Data2
		SELECT @StartDate, '', 0.00,SIH.Name+'(Current Asset)',  sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name

		insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')
	END

	insert into #temp_Data3
	select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), '', 0.00,  ''
	from #temp_Data1 T1
	UNION ALL
	select @StartDate, 0,  '', 0, isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
	from #temp_Data2 T2

	declare @a decimal(18, 2)
	declare @b decimal(18, 2)
	declare @ExpenseWithinDate decimal(18, 2)
	declare @IncomeWithinDate decimal(18, 2)
	declare @CashInHandWithinDate decimal(18, 2)

	set @a = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @b = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @ExpenseWithinDate = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @IncomeWithinDate = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
	set @CashInHand = @CashInHand + (@b - @a)

	insert into #temp_Data3
	values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

	insert into #temp_Data3
	values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

	insert into #temp_Data3
	values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

	set @StartDate = DATEADD(DAY, 1, @StartDate)
	--select *From #temp_Data1
	--select *From #temp_Data2
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

---------------------------------------------------------------------------------------------------------------------------------

--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_MonthlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0


if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-06-09'
set @CashInHand=26500
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(MONTH, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate)
and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

insert into #temp_Data1
select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
from POrders po
join Suppliers s on po.SupplierID = s.SupplierID
where po.ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate)
and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate and po.RecAmt>0
group by s.SupplierID,s.Name

insert into #temp_Data1
select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 1  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank collections', @total, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Customer Collection(Cr))', sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Cash Delivery', @total, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 4 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END
---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections cc 
join Suppliers s on cc.SupplierID = s.SupplierID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) 
and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(cc.amount), 'Due Collection', 0, 'Cash'
		from CashCollections cc 
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) 
		and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'
END
------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID 
				and  Month(Convert(date, InvoiceDate)) = Month(@StartDate)
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Retail/Dealer', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID 
	and  Month(Convert(date, InvoiceDate)) = Month(@StartDate)
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Retail/Dealere', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID 
			    and  Month(Convert(date, SalesDate)) = Month(@StartDate)
				and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Hire', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID 
	    and  Month(Convert(date, SalesDate)) = Month(@StartDate)
		and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Hire', 0, '', 0, 'Header'
	END
------------- -------------------------------------------- Direct Expense--------------------------------------------
set @total=isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)

if(@total) != 0
begin
	insert into #temp_Data1
	select @StartDate,'Expense', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
	from Expenditures EX
	inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
	where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
	group by E.Description

	insert into #temp_Data1
	select @StartDate,'Total Expense', @total, '', 0, 'Header'
end
		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID  and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate)  and  TransactionDate>= @InitailDate
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0 and  TransactionDate>= @InitailDate
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
					    where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end


-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2 AND    SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
 END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END

----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1  and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
  
  END
---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1 and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1  and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0
						and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name

 insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')

 END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0  AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
------------------------------------------------------------------------------------------------------------------------------------------------------

 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END
 ------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(MONTH, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

---------------------------------------------------------------------------------------------------------------------------------

--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_YearlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-02-09'


if (@ConcernID = 1)
	set @CashInHand = 1263.00
else if (@ConcernID = 5)
	set @CashInHand = 8755.00
else if (@ConcernID = 6)
	set @CashInHand = - 2.00
else if (@ConcernID = 4)
	set @CashInHand = 65000.00
else if (@ConcernID = 20)
BEGIN
	set @CashInHand = 137340.00
	set @StartDate = '2020-03-12'
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END


set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(YEAR, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

insert into #temp_Data1
select @StartDate, s.Name, sum(po.recAmt), 'Cash Sales', 0, 'Order'
from POrders po
join Suppliers s on po.SupplierID = s.SupplierID
where po.ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
 and po.RecAmt>0
group by s.SupplierID,s.Name

insert into #temp_Data1
select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 1   and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate,'Bank collections', @total, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Customer Collection(Cr))', sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 3  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Cash Delivery', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 4  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END
---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections cc 
join Suppliers s on cc.SupplierID = s.SupplierID
where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,  s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc 
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate 
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID 
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Retail/Dealer', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID 
		and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Retail/Dealere', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID 
				and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Hire', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID 
		and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Hire', 0, '', 0, 'Header'
	END

------------- -------------------------------------------- Direct Expense--------------------------------------------
set @total =isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)

if (@total) != 0
begin
insert into #temp_Data1
select @StartDate,'Expense', 0, '', 0, 'Header'

insert into #temp_Data1
select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description

insert into #temp_Data1
select @StartDate,'Total Expense', @total, '', 0, 'Header'

end

		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID and Year(Convert(date, TransactionDate)) = Year(@StartDate)  and  TransactionDate>= @InitailDate
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0 and  TransactionDate>= @InitailDate
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
						where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end


-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0
 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE  SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2  AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
 END
	-- ----------------------------Expens from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'PF Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(PF Pay)', sum(Amount), 'PF Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=4  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total PF Pay', @total, '', 0, 'Header'
END
	-- ----------------------------Expens from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'FDR Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(FDR Pay)', sum(Amount), 'FDR Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=5  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total FDR Pay', @total, '', 0, 'Header'
END

	-- ----------------------------Expens from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Security Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Security Pay)', sum(Amount), 'Security Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=6  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0  AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Security Pay', @total, '', 0, 'Header'
END


----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1  and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')

END
---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1  and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1   and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID  and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0
						and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1  AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1   AND  SI.CashInHandReportStatus = 0 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
 END
	-- ----------------------------Income from PF ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'PF Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'PF Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=4 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'PF Received', 0.00, 'Total PF Received',@total, 'Header')
	END

	-- ----------------------------Income from FDR ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'FDR Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'FDR Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=5 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'FDR Received', 0.00, 'Total FDR Received',@total, 'Header')
	END

	-- ----------------------------Income from Security ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Security Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Security Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=6 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND Year(Convert(DATE, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Security Received', 0.00, 'Total Security Received',@total, 'Header')
	END
------------------------------------------------------------------------------------------------------------------------------------------------------

 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE  SIH.ParentId=2  and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END
------------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)

set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(YEAR, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

-------------Nahid--------------
----------13-11-2023------------
--------------------------------


ALTER PROC [dbo].[UpdateTotalDueWhenEditNew]
(
	@CusId int,
	@SupId int,
	@CashCollectionID int,
	@NewCollectionAmount DECIMAL(18,2)
)
  
AS 
Declare @Amount decimal
Declare @PreviousCustomerID int,
		@TransactionType INT

BEGIN TRY
BEGIN TRANSACTION

IF(@CusId>0)
BEGIN
    Select @Amount=(Amount+AdjustAmt) from CashCollections where CashCollectionID=@CashCollectionID
	Select @PreviousCustomerID=CustomerID from CashCollections where CashCollectionID=@CashCollectionID
	SELECT @TransactionType = TransactionType from CashCollections where CashCollectionID=@CashCollectionID

	IF @TransactionType = 3 
	BEGIN
		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue - @Amount)
		where CustomerID=@PreviousCustomerID



		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + @NewCollectionAmount)
		where CustomerID=@CusId
	END
	IF @TransactionType = 6
	BEGIN
		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue - @Amount)
		where CustomerID=@PreviousCustomerID



		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + @NewCollectionAmount)
		where CustomerID=@CusId
	END
	ELSE
	BEGIN
		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + @Amount)
		where CustomerID=@PreviousCustomerID

		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue - @NewCollectionAmount)
		where CustomerID=@CusId
	END

	
END
ELSE IF(@SupId>0)
BEGIN
    Select @Amount=(Amount+AdjustAmt) from CashCollections where CashCollectionID=@CashCollectionID
    Select @PreviousCustomerID=SupplierID from CashCollections where CashCollectionID=@CashCollectionID
	SELECT @TransactionType = TransactionType from CashCollections where CashCollectionID=@CashCollectionID

	IF @TransactionType = 6
	BEGIN
		UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - @Amount)
		where SupplierID=@PreviousCustomerID



		UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue + @NewCollectionAmount)
		where SupplierID=@SupId
	END
	ELSE
	BEGIN
		UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue + @Amount)
		where SupplierID=@PreviousCustomerID

		UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - @NewCollectionAmount)
		where SupplierID=@SupId
	END
	--UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue + @Amount)
	--where SupplierID=@PreviousCustomerID

	--UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - @NewCollectionAmount)
	--where SupplierID=@SupId
END

COMMIT

RETURN 1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		RETURN 0;
END CATCH

-------------Rakib--------------
----------28-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[sp_BalanceSheetNew]
(
  @AsOnDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int, IsHeader BIT)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int, IsHeader BIT)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int, IsHeader BIT)


------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@AsOnDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@AsOnDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Cash in hand',0.00,@TotalCashInHand,7, 0)

-------------------------------------------Cash at the bank--------------------------------------------
set @TotalIncome=0
set @TotalExpense=0
--Deposit
set @TotalIncome= @TotalIncome + ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
--Collection from Customer
set @TotalIncome=@TotalIncome+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
),0)

--Withdraw
set @TotalExpense= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
),0)

--Delivery to suppliers
set @TotalExpense=@TotalExpense+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
),0)

declare @allBankOpening DECIMAL(18,2) = (SELECT ISNULL(SUM(OpeningBalance), 0) FROM Banks WHERE ConcernID = @ConcernID)



IF(@TotalIncome-@TotalExpense!=0)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Cash at Bank',0.00, (@TotalIncome-@TotalExpense) + @allBankOpening,8, 0)


-----------------------Supplier Due------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)


SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)
DECLARE @paySL INT = 2;
IF(@SupplierDue != 0)
	BEGIN
		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Account Payable',0,0,@paySL, 1)
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		

		DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue + @totalOpeningDue

		INSERT INTO #temp(Particulars,Debit,Credit,SerialNum, IsHeader)
		SELECT s.Name, (ts.TotalDue + s.OpeningDue), 0, @paySL + 1, 0 FROM #tmpSupplierDue ts
		JOIN dbo.Suppliers s ON ts.SupplierID = s.SupplierID
		WHERE ts.TotalDue != 0

		SET @paySL = @paySL + (SELECT COUNT(SupplierID) FROM #tmpSupplierDue) + 1;

		--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,4)
		Insert Into #temp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Total Account Payable',@SupplierDue,0,@paySL, 1)
		drop TABLE #tmpSupplierDue
	END




----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

----------------------------------------Customer Due----------------------------



Insert Into #crTemp(Particulars,Debit,Credit,SerialNum, IsHeader) values ('Account Receivable',0,0,2, 0) --amount will come from another sp, follow c# method



-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum, IsHeader)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum,
	t.IsHeader
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum, IsHeader)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum,
	t.IsHeader
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit, SerialNum as SL, IsHeader from #fTemp
GROUP BY DebitParticular, CreditParticular, SerialNum, IsHeader
order by SL




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--EXEC sp_BalanceSheetNew  '2023-11-07', 5213


-------------Rakib--------------
----------28-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[sp_BalanceSheetNew]
(
  @AsOnDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int)


------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@AsOnDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@AsOnDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in hand',@TotalCashInHand,0.00,1)

-------------------------------------------Cash at the bank--------------------------------------------
set @TotalIncome=0
set @TotalExpense=0
--Deposit
set @TotalIncome= @TotalIncome + ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
--Collection from Customer
set @TotalIncome=@TotalIncome+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
),0)

--Withdraw
set @TotalExpense= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
),0)

--Delivery to suppliers
set @TotalExpense=@TotalExpense+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where CAST(bt.TranDate as DATE) <= CAST(@AsOnDate as DATE) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
),0)

declare @allBankOpening DECIMAL(18,2) = (SELECT ISNULL(SUM(OpeningBalance), 0) FROM Banks WHERE ConcernID = @ConcernID)



IF(@TotalIncome-@TotalExpense!=0)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash at Bank',(@TotalIncome-@TotalExpense) + @allBankOpening, 0.00,2)


-----------------------Supplier Due------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)


SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)

IF(@SupplierDue != 0)
	BEGIN
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @AsOnDate, @AsOnDate, @AsOnDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		drop TABLE #tmpSupplierDue

		DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue + @totalOpeningDue



		--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,4)
		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values ('Account Payable',0,@SupplierDue,1)
	END




----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

----------------------------------------Customer Due----------------------------



Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Account Receivable',0,0,3) --amount will come from another sp, follow c# method



-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit, SerialNum as SL from #fTemp
GROUP BY DebitParticular, CreditParticular, SerialNum
order by SL




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--EXEC sp_BalanceSheetNew  '2023-10-28', 5213



-------------Rakib--------------
----------22-10-2023------------
--------------------------------


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_TrialBalance  '01 Oct 2023 12:00:00 AM','09 Oct 2023 11:59:59 PM',5213
ALTER PROC [dbo].[sp_TrialBalance]
(
  @FromDate datetime,
  @ToDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int)



--****************************************************
--***************Debit Start**************************
--****************************************************

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Cash at Banks', ISNULL(sum(TotalAmount),0.0),0.00,1 from Banks
--where ConcernID=@ConcernID

------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)
--set @OpeningBalance = ISNULL((select sum(Amount)from ShareInvestments i
--JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
--JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
--where i.ConcernID=@ConcernID AND ih.Name LIKE 'Opening%' AND (p.Name='Current Asset' OR p.Name='Fixed Asset')),0.00)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

----direct expense
--set @TotalExpense =ISNULL((
--select SUM(Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1),0)

----cash delivery
--set @TotalExpense =@TotalExpense+ISNULL((
--select sum(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

----sales return
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4
--),0)

-----cash purchase
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID
--),0)

----cash deposite
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID
--),0)

-------------------Income----------------

----cash collection
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

----installment collections
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(css.InstallmentAmt) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

----direct income
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(ex.Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2
--),0)

----hire sales downpayment
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

----cash sales
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1
--),0)

----cash withdraw from bank
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)
DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in hand',@TotalCashInHand,0.00,1)

-------------------------------------------Cash in the bank--------------------------------------------
set @TotalIncome=0
set @TotalExpense=0
--Deposit
set @TotalIncome= @TotalIncome + ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
--Collection from Customer
set @TotalIncome=@TotalIncome+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
),0)

--Withdraw
set @TotalExpense= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
),0)

--Delivery to suppliers
set @TotalExpense=@TotalExpense+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where CAST(bt.TranDate as DATE) <= CAST(@ToDate as DATE) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
),0)

declare @allBankOpening DECIMAL(18,2) = (SELECT ISNULL(SUM(OpeningBalance), 0) FROM Banks WHERE ConcernID = @ConcernID)

IF(@TotalIncome-@TotalExpense!=0)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash at Bank',(@TotalIncome-@TotalExpense) + @allBankOpening, 0.00,2)

--------------------------------------------Direct Expense-----------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select exi.Description,Amount,0.00,8 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1

---------------------------------------------Purchase----------------------------------------
DECLARE @CashCollection decimal(18,2)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Purchase',po.GrandTotal,0.00,3 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID

---------------------------------------Transfer In and Transfer Receivables--------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer In',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4


--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Receivables',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

----------------------------------------Adjustment------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',cc.AdjustAmt,0.0,8 from CashCollections cc
where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',css.LastPayAdjust,0.0,8 from CreditSales so
join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.LastPayAdjust>0 and css.PaymentStatus='Paid')

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',so.AdjAmount,0.0,8 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.AdjAmount>0

------------------------------------------Discount Given---------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.Discount,0.0,5 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.Discount>0


Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.NetDiscount,0.0,5 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0

declare @disAmt DECIMAL(18,2) = (select SUM(so.NetDiscount) from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0)

print(@disAmt)

------------------------------------------Sales Return------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Return',so.TotalAmount,0.0,6 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4

----------------------------------------------Customer Due---------------------------------
Declare @TotalSaleAmt  decimal(18,2)

--Set @TotalSaleAmt= ISNULL((
--select SUM(so.TotalAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and  so.InvoiceDate<=@ToDate) and so.Status=1),0)

----Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
----select SUM(so.OpeningDue) from Customers so
----where so.ConcernID=@ConcernID and (so.CreatedDate<=@ToDate)),0)

--Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
--select SUM(so.NetAmount) from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos = ISNULL((
--select SUM(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.RecAmount>0),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.PaymentDue) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4 and so.PaymentDue>0),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(css.InstallmentAmt+css.LastPayAdjust) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((select SUM(cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and  cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)
--IF(@TotalSaleAmt-@CashInHandPos!=0)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values ('Customer Due',0,0,2) --amount will come from another sp, follow c# method


----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

--set  @TotalPOAmt=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0.00)

--set  @TotalPOAmt=@TotalPOAmt+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4),0.00)

--set  @TotalPOReturn=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0.00)



--set @TotalSales=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=1),0)

--set  @TotalSales=@TotalSales+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4),0.00)

--set @TotalSalesReturn=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=4),0)

--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Stock',(@TotalPOAmt+@TotalSalesReturn-@TotalPOReturn-@TotalSales),0.00,7)

---------------------------------------Stock Value End-------------------------------



--****************************************************
--***************Debit End****************************
--****************************************************



--****************************************************
--***************Credit Start*************************
--****************************************************


-----------------------------------Transfer Out and Transfer Payable---------------------------------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Out',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Payable',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4

------------------Investment-----------------------------------------------------
declare @Liability decimal(18,2)

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Lia. Receive',0.00,@Liability,3)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
INSERT INTO #crTemp(Particulars, Debit, Credit, SerialNum) values('Lia. Receive',0.00,@Liability,3)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
END

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=2 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
END

---Asset
set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Current Asset' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
END
-------------------------------------Direct Income-------------------------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select exi.Description,0.00,ex.Amount,5 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2

-------------------------------------Retail and hire Sales----------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.GrandTotal,1 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.NetAmount,1 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1

--------------------------------------Purchase Discount------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Discount',0.00,po.NetDiscount,3 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID and po.NetDiscount>0

-----------------------------------------Hire Interest--------------------------
--Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
--select 'Hire Interest',0.00,so.InterestAmount,12 from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.InterestAmount>0

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
SELECT 'Hire Extend Interest',0.00,csi.InterestAmount,12 from dbo.CreditInterestHistories csi
JOIN dbo.CreditSales cs ON csi.HireSaleId = cs.CreditSalesID
WHERE cs.ConcernID = @ConcernID and cs.IsStatus=1 AND csi.IsFirstTime = 0
AND CAST(csi.InterestDate AS DATE) BETWEEN CAST(@FromDate AS DATE) AND CAST(@ToDate AS DATE)



----------------------------------------Supplier Due----------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)


SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)

--IF(@SupplierDue-@CashDelivery!=0)
--	Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue-@CashDelivery,5)
IF(@SupplierDue != 0)
	BEGIN
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @ToDate, @ToDate, @ToDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		drop TABLE #tmpSupplierDue

		DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue + @totalOpeningDue



		Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,4)
	END


-----------------------------Purchase Return---------------------------

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Return',0.00,po.TotalAmt,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID

--****************************************************
--***************Credit End***************************
--****************************************************
--INSERT INTO #fTemp(ID,DebitParticular, Debit, CreditPaticular, Credit, SerialNum)
--SELECT ISNULL(T1.ID, 3), ISNULL(T1.Particulars, ''), ISNULL(T1.Debit, 0), '', 0.00, T1.SerialNum FROM #temp T1
--UNION ALL
--SELECT 0, '', 0, ISNULL(T2.Particulars, ''), ISNULL(T2.Credit, 0), T2.SerialNum FROM #crTemp T2


-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit, SerialNum as SL from #fTemp
GROUP BY DebitParticular, CreditParticular, SerialNum
order by SL




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--exec sp_TrialBalance  '01 Oct 2020 12:00:00 AM','02 Oct 2023 11:59:59 PM',5212


-------------Rakib--------------
----------17-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_TrialBalance  '01 Oct 2023 12:00:00 AM','09 Oct 2023 11:59:59 PM',5213
ALTER PROC [dbo].[sp_TrialBalance]
(
  @FromDate datetime,
  @ToDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int)



--****************************************************
--***************Debit Start**************************
--****************************************************

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Cash at Banks', ISNULL(sum(TotalAmount),0.0),0.00,1 from Banks
--where ConcernID=@ConcernID

------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)
--set @OpeningBalance = ISNULL((select sum(Amount)from ShareInvestments i
--JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
--JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
--where i.ConcernID=@ConcernID AND ih.Name LIKE 'Opening%' AND (p.Name='Current Asset' OR p.Name='Fixed Asset')),0.00)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

----direct expense
--set @TotalExpense =ISNULL((
--select SUM(Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1),0)

----cash delivery
--set @TotalExpense =@TotalExpense+ISNULL((
--select sum(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

----sales return
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4
--),0)

-----cash purchase
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID
--),0)

----cash deposite
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID
--),0)

-------------------Income----------------

----cash collection
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

----installment collections
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(css.InstallmentAmt) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

----direct income
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(ex.Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2
--),0)

----hire sales downpayment
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

----cash sales
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1
--),0)

----cash withdraw from bank
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)
DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in hand',@TotalCashInHand,0.00,1)

-------------------------------------------Cash in the bank--------------------------------------------
set @TotalIncome=0
set @TotalExpense=0
--Deposit
set @TotalIncome= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
--Collection from Customer
set @TotalIncome=@TotalIncome+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
),0)

--Withdraw
set @TotalExpense= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
),0)

--Delivery to suppliers
set @TotalExpense=@TotalExpense+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
),0)

IF(@TotalIncome-@TotalExpense!=0)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash at bank',@TotalIncome-@TotalExpense,0.00,2)

--------------------------------------------Direct Expense-----------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select exi.Description,Amount,0.00,8 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1

---------------------------------------------Purchase----------------------------------------
DECLARE @CashCollection decimal(18,2)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Purchase',po.GrandTotal,0.00,3 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID

---------------------------------------Transfer In and Transfer Receivables--------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer In',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4


--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Receivables',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

----------------------------------------Adjustment------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',cc.AdjustAmt,0.0,8 from CashCollections cc
where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',css.LastPayAdjust,0.0,8 from CreditSales so
join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.LastPayAdjust>0 and css.PaymentStatus='Paid')

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',so.AdjAmount,0.0,8 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.AdjAmount>0

------------------------------------------Discount Given---------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.Discount,0.0,5 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.Discount>0


Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.NetDiscount,0.0,5 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0

declare @disAmt DECIMAL(18,2) = (select SUM(so.NetDiscount) from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0)

print(@disAmt)

------------------------------------------Sales Return------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Return',so.TotalAmount,0.0,6 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4

----------------------------------------------Customer Due---------------------------------
Declare @TotalSaleAmt  decimal(18,2)

--Set @TotalSaleAmt= ISNULL((
--select SUM(so.TotalAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and  so.InvoiceDate<=@ToDate) and so.Status=1),0)

----Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
----select SUM(so.OpeningDue) from Customers so
----where so.ConcernID=@ConcernID and (so.CreatedDate<=@ToDate)),0)

--Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
--select SUM(so.NetAmount) from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos = ISNULL((
--select SUM(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.RecAmount>0),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.PaymentDue) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4 and so.PaymentDue>0),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(css.InstallmentAmt+css.LastPayAdjust) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((select SUM(cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and  cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)
--IF(@TotalSaleAmt-@CashInHandPos!=0)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values ('Customer Due',0,0,2) --amount will come from another sp, follow c# method


----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

--set  @TotalPOAmt=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0.00)

--set  @TotalPOAmt=@TotalPOAmt+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4),0.00)

--set  @TotalPOReturn=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0.00)



--set @TotalSales=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=1),0)

--set  @TotalSales=@TotalSales+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4),0.00)

--set @TotalSalesReturn=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=4),0)

--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Stock',(@TotalPOAmt+@TotalSalesReturn-@TotalPOReturn-@TotalSales),0.00,7)

---------------------------------------Stock Value End-------------------------------



--****************************************************
--***************Debit End****************************
--****************************************************



--****************************************************
--***************Credit Start*************************
--****************************************************


-----------------------------------Transfer Out and Transfer Payable---------------------------------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Out',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Payable',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4

------------------Investment-----------------------------------------------------
declare @Liability decimal(18,2)

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Lia. Receive',0.00,@Liability,3)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
INSERT INTO #crTemp(Particulars, Debit, Credit, SerialNum) values('Lia. Receive',0.00,@Liability,3)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
END

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=2 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
END

---Asset
set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Current Asset' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
END
-------------------------------------Direct Income-------------------------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select exi.Description,0.00,ex.Amount,5 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2

-------------------------------------Retail and hire Sales----------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.GrandTotal,1 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.NetAmount,1 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1

--------------------------------------Purchase Discount------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Discount',0.00,po.NetDiscount,3 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID and po.NetDiscount>0

-----------------------------------------Hire Interest--------------------------
--Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
--select 'Hire Interest',0.00,so.InterestAmount,12 from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.InterestAmount>0

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
SELECT 'Hire Extend Interest',0.00,csi.InterestAmount,12 from dbo.CreditInterestHistories csi
JOIN dbo.CreditSales cs ON csi.HireSaleId = cs.CreditSalesID
WHERE cs.ConcernID = @ConcernID and cs.IsStatus=1 AND csi.IsFirstTime = 0
AND CAST(csi.InterestDate AS DATE) BETWEEN CAST(@FromDate AS DATE) AND CAST(@ToDate AS DATE)



----------------------------------------Supplier Due----------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)


SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)

--IF(@SupplierDue-@CashDelivery!=0)
--	Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue-@CashDelivery,5)
IF(@SupplierDue != 0)
	BEGIN
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @ToDate, @ToDate, @ToDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		drop TABLE #tmpSupplierDue

		DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue + @totalOpeningDue



		Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,4)
	END


-----------------------------Purchase Return---------------------------

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Return',0.00,po.TotalAmt,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID

--****************************************************
--***************Credit End***************************
--****************************************************
--INSERT INTO #fTemp(ID,DebitParticular, Debit, CreditPaticular, Credit, SerialNum)
--SELECT ISNULL(T1.ID, 3), ISNULL(T1.Particulars, ''), ISNULL(T1.Debit, 0), '', 0.00, T1.SerialNum FROM #temp T1
--UNION ALL
--SELECT 0, '', 0, ISNULL(T2.Particulars, ''), ISNULL(T2.Credit, 0), T2.SerialNum FROM #crTemp T2


-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit, SerialNum as SL from #fTemp
GROUP BY DebitParticular, CreditParticular, SerialNum
order by SL




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--exec sp_TrialBalance  '01 Oct 2020 12:00:00 AM','02 Oct 2023 11:59:59 PM',5212


-------------Rakib--------------
----------16-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[GetDatewiseCustomerDueRpt]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				--(
				--	(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
				--	ISNULL(piv.InterestAmount, 0) +
				--	ISNULL(piv.CrInterestAmount, 0)
				--) -
				--(
				--	(
				--		(
				--			ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				--		) + 
				--		--(
				--			ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--		--)

				--	) +
				--	ISNULL(piv.InstallmentCollection, 0)
				--	+
				--	ISNULL(piv.RecAmount, 0)
				--) -
				--ISNULL(piv.[Return], 0)

				--(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
				(ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))

				 + 
				(
					((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
					(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
				)
				+
				ISNULL(piv.InterestAmount, 0)
				+
				ISNULL(piv.CrInterestAmount, 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END


-------------Rakib--------------
----------16-10-2023------------
--------------------------------

ALTER TABLE [dbo].[ShareInvestmentHeads] ADD
[OpeningType] [nvarchar](15) NULL


-------------Rakib--------------
----------15-10-2023------------
--------------------------------


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[GetDatewiseCustomerDueRpt]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) + 
			--(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) 
				--+ ISNULL(piv.CrAdjustment, 0)
			--)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) + 
				--(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				--)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				(
					(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
					ISNULL(piv.InterestAmount, 0) +
					ISNULL(piv.CrInterestAmount, 0)
				) -
				(
					(
						(
							ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
						) + 
						--(
							ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
						--)

					) +
					ISNULL(piv.InstallmentCollection, 0)
					+
					ISNULL(piv.RecAmount, 0)
				) -
				ISNULL(piv.[Return], 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END


 --EXEC GetDatewiseCustomerDueRpt 5213, 215168, NULL, 0, '2023-10-15', '2023-10-15'


-------------Rakib--------------
----------15-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_TrialBalance  '01 Oct 2023 12:00:00 AM','09 Oct 2023 11:59:59 PM',5213
ALTER PROC [dbo].[sp_TrialBalance]
(
  @FromDate datetime,
  @ToDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int)



--****************************************************
--***************Debit Start**************************
--****************************************************

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Cash at Banks', ISNULL(sum(TotalAmount),0.0),0.00,1 from Banks
--where ConcernID=@ConcernID

------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)
--set @OpeningBalance = ISNULL((select sum(Amount)from ShareInvestments i
--JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
--JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
--where i.ConcernID=@ConcernID AND ih.Name LIKE 'Opening%' AND (p.Name='Current Asset' OR p.Name='Fixed Asset')),0.00)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

----direct expense
--set @TotalExpense =ISNULL((
--select SUM(Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1),0)

----cash delivery
--set @TotalExpense =@TotalExpense+ISNULL((
--select sum(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

----sales return
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4
--),0)

-----cash purchase
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID
--),0)

----cash deposite
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID
--),0)

-------------------Income----------------

----cash collection
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

----installment collections
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(css.InstallmentAmt) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

----direct income
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(ex.Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2
--),0)

----hire sales downpayment
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

----cash sales
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1
--),0)

----cash withdraw from bank
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)
DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in hand',@TotalCashInHand,0.00,1)

-------------------------------------------Cash in the bank--------------------------------------------
set @TotalIncome=0
set @TotalExpense=0
--Deposit
set @TotalIncome= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
--Collection from Customer
set @TotalIncome=@TotalIncome+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
),0)

--Withdraw
set @TotalExpense= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
),0)

--Delivery to suppliers
set @TotalExpense=@TotalExpense+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
),0)

IF(@TotalIncome-@TotalExpense!=0)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in bank',@TotalIncome-@TotalExpense,0.00,2)

--------------------------------------------Direct Expense-----------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select exi.Description,Amount,0.00,3 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1

---------------------------------------------Purchase----------------------------------------
DECLARE @CashCollection decimal(18,2)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Purchase',po.GrandTotal,0.00,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID

---------------------------------------Transfer In and Transfer Receivables--------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer In',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4


--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Receivables',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

----------------------------------------Adjustment------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',cc.AdjustAmt,0.0,8 from CashCollections cc
where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',css.LastPayAdjust,0.0,8 from CreditSales so
join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.LastPayAdjust>0 and css.PaymentStatus='Paid')

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',so.AdjAmount,0.0,8 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.AdjAmount>0

------------------------------------------Discount Given---------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.Discount,0.0,7 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.Discount>0


Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.NetDiscount,0.0,7 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0

declare @disAmt DECIMAL(18,2) = (select SUM(so.NetDiscount) from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0)

print(@disAmt)

------------------------------------------Sales Return------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Return',so.TotalAmount,0.0,7 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4

----------------------------------------------Customer Due---------------------------------
Declare @TotalSaleAmt  decimal(18,2)

--Set @TotalSaleAmt= ISNULL((
--select SUM(so.TotalAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and  so.InvoiceDate<=@ToDate) and so.Status=1),0)

----Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
----select SUM(so.OpeningDue) from Customers so
----where so.ConcernID=@ConcernID and (so.CreatedDate<=@ToDate)),0)

--Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
--select SUM(so.NetAmount) from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos = ISNULL((
--select SUM(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.RecAmount>0),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.PaymentDue) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4 and so.PaymentDue>0),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(css.InstallmentAmt+css.LastPayAdjust) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((select SUM(cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and  cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)
--IF(@TotalSaleAmt-@CashInHandPos!=0)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values ('Customer Due',0,0,4) --amount will come from another sp, follow c# method


----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

--set  @TotalPOAmt=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0.00)

--set  @TotalPOAmt=@TotalPOAmt+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4),0.00)

--set  @TotalPOReturn=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0.00)



--set @TotalSales=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=1),0)

--set  @TotalSales=@TotalSales+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4),0.00)

--set @TotalSalesReturn=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=4),0)

--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Stock',(@TotalPOAmt+@TotalSalesReturn-@TotalPOReturn-@TotalSales),0.00,7)

---------------------------------------Stock Value End-------------------------------



--****************************************************
--***************Debit End****************************
--****************************************************



--****************************************************
--***************Credit Start*************************
--****************************************************


-----------------------------------Transfer Out and Transfer Payable---------------------------------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Out',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Payable',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4

------------------Investment-----------------------------------------------------
declare @Liability decimal(18,2)

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Lia. Receive',0.00,@Liability,3)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
INSERT INTO #crTemp(Particulars, Debit, Credit, SerialNum) values('Lia. Receive',0.00,@Liability,3)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
END

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=2 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
END

---Asset
set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Current Asset' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
END
-------------------------------------Direct Income-------------------------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select exi.Description,0.00,ex.Amount,3 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2

-------------------------------------Retail and hire Sales----------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.GrandTotal,6 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.NetAmount,6 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1

--------------------------------------Purchase Discount------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Discount',0.00,po.NetDiscount,5 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID and po.NetDiscount>0

-----------------------------------------Hire Interest--------------------------
--Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
--select 'Hire Interest',0.00,so.InterestAmount,12 from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.InterestAmount>0

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
SELECT 'Hire Extend Interest',0.00,csi.InterestAmount,12 from dbo.CreditInterestHistories csi
JOIN dbo.CreditSales cs ON csi.HireSaleId = cs.CreditSalesID
WHERE cs.ConcernID = @ConcernID and cs.IsStatus=1 AND csi.IsFirstTime = 0
AND CAST(csi.InterestDate AS DATE) BETWEEN CAST(@FromDate AS DATE) AND CAST(@ToDate AS DATE)



----------------------------------------Supplier Due----------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)


SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)

--IF(@SupplierDue-@CashDelivery!=0)
--	Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue-@CashDelivery,5)
IF(@SupplierDue != 0)
	BEGIN
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @ToDate, @ToDate, @ToDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		drop TABLE #tmpSupplierDue

		DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue + @totalOpeningDue



		Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,7)
	END


-----------------------------Purchase Return---------------------------

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Return',0.00,po.TotalAmt,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID

--****************************************************
--***************Credit End***************************
--****************************************************
--INSERT INTO #fTemp(ID,DebitParticular, Debit, CreditPaticular, Credit, SerialNum)
--SELECT ISNULL(T1.ID, 3), ISNULL(T1.Particulars, ''), ISNULL(T1.Debit, 0), '', 0.00, T1.SerialNum FROM #temp T1
--UNION ALL
--SELECT 0, '', 0, ISNULL(T2.Particulars, ''), ISNULL(T2.Credit, 0), T2.SerialNum FROM #crTemp T2


-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit from #fTemp
GROUP BY DebitParticular, CreditParticular




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--exec sp_TrialBalance  '01 Oct 2020 12:00:00 AM','02 Oct 2023 11:59:59 PM',5212


-------------Rakib--------------
----------15-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[AddCreditSalesOrder] (
@CSalesOrder [dbo].[INSERTCREDITSALESORDERTABLE] readonly, 
@CSODetails [INSERTCSODETAILTABLE] readonly,
@CSSchedules [INSERTCSSCHEDULESTABLE] readonly,
@BankTrans [InsertBankTransTable] readonly,
@SorderID int out,
@Result int Out)
AS
DECLARE @CreditSalesId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY  
 BEGIN TRANSACTION 

-----------------Card Payment Bank Deposit--------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @CSalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

------------------Card Payment Bank Deposit--------------

INSERT INTO creditsales (invoiceno, customerid, tsalesamt, noofinstallment,
 intallmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamt, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress)
(SELECT
 invoiceno, customerid, tsalesamt, noofinstallment, 
 installmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamount, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,@BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress FROM @CSalesOrder)

UPDATE customers
SET customers.CreditDue = (customers.CreditDue + s.totaldue)
FROM @CSalesOrder s
INNER JOIN customers ON customers.customerid = s.customerid

SET @CreditSalesId = Scope_identity()

INSERT INTO CreditSaleDetails 
( 
ProductID ,UnitPrice, Quantity, UTAmount, CreditSalesID,  
MPRateTotal, MPRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,Compressor,Motor,
Panel,Spareparts,Service
) 
( 
Select sd.ProductID ,UnitPrice, Quantity, UTAmount, @CreditSalesId CreditSalesID,  
MPRateTotal, MrpRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,p.CompressorWarrentyMonth,p.MotorWarrentyMonth,
p.PanelWarrentyMonth,p.SparePartsWarrentyMonth,p.ServiceWarrentyMonth from @CSODetails sd
join Products p on sd.ProductID=p.ProductID 
where p.ProductType!=2
) 

INSERT INTO dbo.CreditInterestHistories(InterestDate, InterestAmount, HireSaleId, IsFirstTime)
(
	SELECT salesdate, interestamount, @CreditSalesId, 1 FROM @CSalesOrder
)


UPDATE stocks
SET stocks.quantity = (stocks.quantity - s.quantity)
FROM @CSODetails s
INNER JOIN stocks ON stocks.productid = s.productid AND stocks.colorid = s.colorid AND Stocks.GodownID=s.Compressor

UPDATE StockDetails 
SET StockDetails.Status = 2 
from @CSODetails s 
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId 
join Products on StockDetails.ProductID = Products.ProductID 
where Products.ProductType!=2 

--***************FIFO for Nobarcode Product**********************
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @CreditSaleProductsID INT
DECLARE @Quantity INT
DECLARE @SQty INT
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL
FOR
SELECT s.productid, s.colorid, s.quantity, creditsalesdetailsid
-- from   InsertCSODetailTable SOD join CreditSales SO on SO.CreditSalesID=SOD.CreditSalesID where SO.Status=1
FROM @CSODetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.stockdetailid
INNER JOIN products ON stockdetails.productid = products.productid
where Products.ProductType=2 
OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID

WHILE @@FETCH_STATUS = 0
BEGIN
	WHILE @Quantity != 0
	BEGIN
		SET @SDetailID = (
				SELECT Min(sdetailid)
				FROM stockdetails
				WHERE productid = @ProductID AND colorid = @ColorID AND quantity != 0 AND STATUS = 1
				)
		SET @SQty = (
				SELECT quantity
				FROM stockdetails
				WHERE sdetailid = @SDetailID
				)

		IF (@SQty > @Quantity)
		BEGIN
			SET @SQty = @SQty - @Quantity

			UPDATE stockdetails
			SET quantity = @SQty
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service)
			 (SELECT sd.productid, unitprice, @Quantity, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID  =@CreditSaleProductsID
			SET @Quantity = 0
		END
		ELSE IF (@SQty < @Quantity)
		BEGIN
			SET @Quantity = @Quantity - @SQty

			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service) (SELECT sd.productid, unitprice, @SQty, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)
				--update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
		END
		ELSE
		BEGIN
			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (
			productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate,
			 stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service
			 ) 
			 (SELECT 
			  sd.productid, unitprice, @SQty, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate,
			  @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, 
			  p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd 
			  INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID
			  )

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
			SET @Quantity = 0
		END
	END

	FETCH NEXT
	FROM cur
	INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID
END

INSERT INTO creditsalesschedules (monthdate, balance, installmentamt, 
paymentdate, creditsalesid, paymentstatus, interestamount, closingbalance,
 scheduleno, remarks, isunexpected, hirevalue, netvalue)
(SELECT monthdate, balance, installmentamt,
 paymentdate, @CreditSalesId CreditSalesID, paymentstatus, interestamount, closingbalance,
  scheduleno, remarks, isunexpected, hirevalue, netvalue FROM @CSSchedules)

COMMIT
--RETURN 1;
SELECT @SorderID=@CreditSalesId,@Result=1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		--RETURN 0;
	SELECT @SorderID=0,@Result=0
END CATCH


-------------Rakib--------------
----------15-10-2023------------
--------------------------------

ALTER TABLE CreditInterestHistories
ADD IsFirstTime BIT NOT NULL DEFAULT 0

-------------Rakib--------------
----------11-10-2023------------
--------------------------------


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[AddCreditSalesOrder] (
@CSalesOrder [dbo].[INSERTCREDITSALESORDERTABLE] readonly, 
@CSODetails [INSERTCSODETAILTABLE] readonly,
@CSSchedules [INSERTCSSCHEDULESTABLE] readonly,
@BankTrans [InsertBankTransTable] readonly,
@SorderID int out,
@Result int Out)
AS
DECLARE @CreditSalesId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY  
 BEGIN TRANSACTION 

-----------------Card Payment Bank Deposit--------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @CSalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

------------------Card Payment Bank Deposit--------------

INSERT INTO creditsales (invoiceno, customerid, tsalesamt, noofinstallment,
 intallmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamt, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress)
(SELECT
 invoiceno, customerid, tsalesamt, noofinstallment, 
 installmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamount, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,@BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress FROM @CSalesOrder)

UPDATE customers
SET customers.CreditDue = (customers.CreditDue + s.totaldue)
FROM @CSalesOrder s
INNER JOIN customers ON customers.customerid = s.customerid

SET @CreditSalesId = Scope_identity()

INSERT INTO CreditSaleDetails 
( 
ProductID ,UnitPrice, Quantity, UTAmount, CreditSalesID,  
MPRateTotal, MPRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,Compressor,Motor,
Panel,Spareparts,Service
) 
( 
Select sd.ProductID ,UnitPrice, Quantity, UTAmount, @CreditSalesId CreditSalesID,  
MPRateTotal, MrpRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,p.CompressorWarrentyMonth,p.MotorWarrentyMonth,
p.PanelWarrentyMonth,p.SparePartsWarrentyMonth,p.ServiceWarrentyMonth from @CSODetails sd
join Products p on sd.ProductID=p.ProductID 
where p.ProductType!=2
) 

INSERT INTO dbo.CreditInterestHistories(InterestDate, InterestAmount, HireSaleId)
(
	SELECT salesdate, interestamount, @CreditSalesId FROM @CSalesOrder
)


UPDATE stocks
SET stocks.quantity = (stocks.quantity - s.quantity)
FROM @CSODetails s
INNER JOIN stocks ON stocks.productid = s.productid AND stocks.colorid = s.colorid AND Stocks.GodownID=s.Compressor

UPDATE StockDetails 
SET StockDetails.Status = 2 
from @CSODetails s 
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId 
join Products on StockDetails.ProductID = Products.ProductID 
where Products.ProductType!=2 

--***************FIFO for Nobarcode Product**********************
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @CreditSaleProductsID INT
DECLARE @Quantity INT
DECLARE @SQty INT
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL
FOR
SELECT s.productid, s.colorid, s.quantity, creditsalesdetailsid
-- from   InsertCSODetailTable SOD join CreditSales SO on SO.CreditSalesID=SOD.CreditSalesID where SO.Status=1
FROM @CSODetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.stockdetailid
INNER JOIN products ON stockdetails.productid = products.productid
where Products.ProductType=2 
OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID

WHILE @@FETCH_STATUS = 0
BEGIN
	WHILE @Quantity != 0
	BEGIN
		SET @SDetailID = (
				SELECT Min(sdetailid)
				FROM stockdetails
				WHERE productid = @ProductID AND colorid = @ColorID AND quantity != 0 AND STATUS = 1
				)
		SET @SQty = (
				SELECT quantity
				FROM stockdetails
				WHERE sdetailid = @SDetailID
				)

		IF (@SQty > @Quantity)
		BEGIN
			SET @SQty = @SQty - @Quantity

			UPDATE stockdetails
			SET quantity = @SQty
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service)
			 (SELECT sd.productid, unitprice, @Quantity, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID  =@CreditSaleProductsID
			SET @Quantity = 0
		END
		ELSE IF (@SQty < @Quantity)
		BEGIN
			SET @Quantity = @Quantity - @SQty

			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service) (SELECT sd.productid, unitprice, @SQty, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)
				--update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
		END
		ELSE
		BEGIN
			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (
			productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate,
			 stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service
			 ) 
			 (SELECT 
			  sd.productid, unitprice, @SQty, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate,
			  @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, 
			  p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd 
			  INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID
			  )

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
			SET @Quantity = 0
		END
	END

	FETCH NEXT
	FROM cur
	INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID
END

INSERT INTO creditsalesschedules (monthdate, balance, installmentamt, 
paymentdate, creditsalesid, paymentstatus, interestamount, closingbalance,
 scheduleno, remarks, isunexpected, hirevalue, netvalue)
(SELECT monthdate, balance, installmentamt,
 paymentdate, @CreditSalesId CreditSalesID, paymentstatus, interestamount, closingbalance,
  scheduleno, remarks, isunexpected, hirevalue, netvalue FROM @CSSchedules)

COMMIT
--RETURN 1;
SELECT @SorderID=@CreditSalesId,@Result=1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		--RETURN 0;
	SELECT @SorderID=0,@Result=0
END CATCH


-------------Rakib--------------
----------11-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_TrialBalance  '01 Oct 2023 12:00:00 AM','09 Oct 2023 11:59:59 PM',5213
ALTER PROC [dbo].[sp_TrialBalance]
(
  @FromDate datetime,
  @ToDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int)



--****************************************************
--***************Debit Start**************************
--****************************************************

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Cash at Banks', ISNULL(sum(TotalAmount),0.0),0.00,1 from Banks
--where ConcernID=@ConcernID

------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)
--set @OpeningBalance = ISNULL((select sum(Amount)from ShareInvestments i
--JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
--JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
--where i.ConcernID=@ConcernID AND ih.Name LIKE 'Opening%' AND (p.Name='Current Asset' OR p.Name='Fixed Asset')),0.00)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

----direct expense
--set @TotalExpense =ISNULL((
--select SUM(Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1),0)

----cash delivery
--set @TotalExpense =@TotalExpense+ISNULL((
--select sum(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

----sales return
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4
--),0)

-----cash purchase
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID
--),0)

----cash deposite
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID
--),0)

-------------------Income----------------

----cash collection
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

----installment collections
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(css.InstallmentAmt) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

----direct income
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(ex.Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2
--),0)

----hire sales downpayment
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

----cash sales
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1
--),0)

----cash withdraw from bank
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)
DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in hand',@TotalCashInHand,0.00,1)

-------------------------------------------Cash in the bank--------------------------------------------
set @TotalIncome=0
set @TotalExpense=0
--Deposit
set @TotalIncome= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
--Collection from Customer
set @TotalIncome=@TotalIncome+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
),0)

--Withdraw
set @TotalExpense= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
),0)

--Delivery to suppliers
set @TotalExpense=@TotalExpense+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
),0)

IF(@TotalIncome-@TotalExpense!=0)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in bank',@TotalIncome-@TotalExpense,0.00,2)

--------------------------------------------Direct Expense-----------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select exi.Description,Amount,0.00,3 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1

---------------------------------------------Purchase----------------------------------------
DECLARE @CashCollection decimal(18,2)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Purchase',po.GrandTotal,0.00,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID

---------------------------------------Transfer In and Transfer Receivables--------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer In',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4


--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Receivables',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

----------------------------------------Adjustment------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',cc.AdjustAmt,0.0,8 from CashCollections cc
where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',css.LastPayAdjust,0.0,8 from CreditSales so
join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.LastPayAdjust>0 and css.PaymentStatus='Paid')

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',so.AdjAmount,0.0,8 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.AdjAmount>0

------------------------------------------Discount Given---------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.Discount,0.0,7 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.Discount>0


Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.NetDiscount,0.0,7 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0

declare @disAmt DECIMAL(18,2) = (select SUM(so.NetDiscount) from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0)

print(@disAmt)

------------------------------------------Sales Return------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Return',so.TotalAmount,0.0,7 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4

----------------------------------------------Customer Due---------------------------------
Declare @TotalSaleAmt  decimal(18,2)

--Set @TotalSaleAmt= ISNULL((
--select SUM(so.TotalAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and  so.InvoiceDate<=@ToDate) and so.Status=1),0)

----Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
----select SUM(so.OpeningDue) from Customers so
----where so.ConcernID=@ConcernID and (so.CreatedDate<=@ToDate)),0)

--Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
--select SUM(so.NetAmount) from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos = ISNULL((
--select SUM(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.RecAmount>0),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.PaymentDue) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4 and so.PaymentDue>0),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(css.InstallmentAmt+css.LastPayAdjust) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((select SUM(cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and  cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)
--IF(@TotalSaleAmt-@CashInHandPos!=0)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values ('Customer Due',0,0,4) --amount will come from another sp, follow c# method


----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

--set  @TotalPOAmt=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0.00)

--set  @TotalPOAmt=@TotalPOAmt+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4),0.00)

--set  @TotalPOReturn=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0.00)



--set @TotalSales=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=1),0)

--set  @TotalSales=@TotalSales+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4),0.00)

--set @TotalSalesReturn=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=4),0)

--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Stock',(@TotalPOAmt+@TotalSalesReturn-@TotalPOReturn-@TotalSales),0.00,7)

---------------------------------------Stock Value End-------------------------------



--****************************************************
--***************Debit End****************************
--****************************************************



--****************************************************
--***************Credit Start*************************
--****************************************************


-----------------------------------Transfer Out and Transfer Payable---------------------------------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Out',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Payable',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4

------------------Investment-----------------------------------------------------
declare @Liability decimal(18,2)

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Lia. Receive',0.00,@Liability,3)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
INSERT INTO #crTemp(Particulars, Debit, Credit, SerialNum) values('Lia. Receive',0.00,@Liability,3)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
END

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=2 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
END

---Asset
set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Current Asset' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
END
-------------------------------------Direct Income-------------------------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select exi.Description,0.00,ex.Amount,3 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2

-------------------------------------Retail and hire Sales----------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.GrandTotal,6 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.NetAmount-so.InterestAmount,6 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1

--------------------------------------Purchase Discount------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Discount',0.00,po.NetDiscount,5 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID and po.NetDiscount>0

-----------------------------------------Hire Interest--------------------------
--Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
--select 'Hire Interest',0.00,so.InterestAmount,12 from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.InterestAmount>0

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
SELECT 'Hire Interest',0.00,csi.InterestAmount,12 from dbo.CreditInterestHistories csi
JOIN dbo.CreditSales cs ON csi.HireSaleId = cs.CreditSalesID
WHERE cs.ConcernID = @ConcernID and cs.IsStatus=1
AND CAST(csi.InterestDate AS DATE) BETWEEN CAST(@FromDate AS DATE) AND CAST(@ToDate AS DATE)



----------------------------------------Supplier Due----------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)


SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)

--IF(@SupplierDue-@CashDelivery!=0)
--	Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue-@CashDelivery,5)
IF(@SupplierDue != 0)
	BEGIN
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @ToDate, @ToDate, @ToDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		drop TABLE #tmpSupplierDue

		DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue + @totalOpeningDue



		Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,7)
	END


-----------------------------Purchase Return---------------------------

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Return',0.00,po.TotalAmt,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID

--****************************************************
--***************Credit End***************************
--****************************************************
--INSERT INTO #fTemp(ID,DebitParticular, Debit, CreditPaticular, Credit, SerialNum)
--SELECT ISNULL(T1.ID, 3), ISNULL(T1.Particulars, ''), ISNULL(T1.Debit, 0), '', 0.00, T1.SerialNum FROM #temp T1
--UNION ALL
--SELECT 0, '', 0, ISNULL(T2.Particulars, ''), ISNULL(T2.Credit, 0), T2.SerialNum FROM #crTemp T2


-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit from #fTemp
GROUP BY DebitParticular, CreditParticular




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--exec sp_TrialBalance  '01 Oct 2020 12:00:00 AM','02 Oct 2023 11:59:59 PM',5212


-------------Rakib--------------
----------11-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[CreditInterestHistories](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[InterestDate] [datetime] NOT NULL,
	[InterestAmount] [decimal](18, 2) NOT NULL,
	[HireSaleId] [int] NOT NULL,
 CONSTRAINT [PK_CreditInterestHistories] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[CreditInterestHistories]  WITH CHECK ADD  CONSTRAINT [FK_CreditInterestHistories_CreditSales] FOREIGN KEY([HireSaleId])
REFERENCES [dbo].[CreditSales] ([CreditSalesID])
GO

ALTER TABLE [dbo].[CreditInterestHistories] CHECK CONSTRAINT [FK_CreditInterestHistories_CreditSales]
GO

-------------Rakib--------------
----------10-10-2023------------
--------------------------------


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_TrialBalance  '01 Oct 2023 12:00:00 AM','09 Oct 2023 11:59:59 PM',5213
ALTER PROC [dbo].[sp_TrialBalance]
(
  @FromDate datetime,
  @ToDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int)



--****************************************************
--***************Debit Start**************************
--****************************************************

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Cash at Banks', ISNULL(sum(TotalAmount),0.0),0.00,1 from Banks
--where ConcernID=@ConcernID

------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)
--set @OpeningBalance = ISNULL((select sum(Amount)from ShareInvestments i
--JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
--JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
--where i.ConcernID=@ConcernID AND ih.Name LIKE 'Opening%' AND (p.Name='Current Asset' OR p.Name='Fixed Asset')),0.00)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

----direct expense
--set @TotalExpense =ISNULL((
--select SUM(Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1),0)

----cash delivery
--set @TotalExpense =@TotalExpense+ISNULL((
--select sum(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

----sales return
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4
--),0)

-----cash purchase
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID
--),0)

----cash deposite
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID
--),0)

-------------------Income----------------

----cash collection
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

----installment collections
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(css.InstallmentAmt) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

----direct income
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(ex.Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2
--),0)

----hire sales downpayment
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

----cash sales
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1
--),0)

----cash withdraw from bank
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)
DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in hand',@TotalCashInHand,0.00,1)

-------------------------------------------Cash in the bank--------------------------------------------
set @TotalIncome=0
set @TotalExpense=0
--Deposit
set @TotalIncome= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
--Collection from Customer
set @TotalIncome=@TotalIncome+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
),0)

--Withdraw
set @TotalExpense= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
),0)

--Delivery to suppliers
set @TotalExpense=@TotalExpense+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
),0)

IF(@TotalIncome-@TotalExpense!=0)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in bank',@TotalIncome-@TotalExpense,0.00,2)

--------------------------------------------Direct Expense-----------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select exi.Description,Amount,0.00,3 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1

---------------------------------------------Purchase----------------------------------------
DECLARE @CashCollection decimal(18,2)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Purchase',po.GrandTotal,0.00,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID

---------------------------------------Transfer In and Transfer Receivables--------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer In',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4


--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Receivables',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

----------------------------------------Adjustment------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',cc.AdjustAmt,0.0,8 from CashCollections cc
where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',css.LastPayAdjust,0.0,8 from CreditSales so
join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.LastPayAdjust>0 and css.PaymentStatus='Paid')

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',so.AdjAmount,0.0,8 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.AdjAmount>0

------------------------------------------Discount Given---------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.Discount,0.0,7 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.Discount>0


Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.NetDiscount,0.0,7 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0

declare @disAmt DECIMAL(18,2) = (select SUM(so.NetDiscount) from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0)

print(@disAmt)

------------------------------------------Sales Return------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Return',so.TotalAmount,0.0,7 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4

----------------------------------------------Customer Due---------------------------------
Declare @TotalSaleAmt  decimal(18,2)

--Set @TotalSaleAmt= ISNULL((
--select SUM(so.TotalAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and  so.InvoiceDate<=@ToDate) and so.Status=1),0)

----Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
----select SUM(so.OpeningDue) from Customers so
----where so.ConcernID=@ConcernID and (so.CreatedDate<=@ToDate)),0)

--Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
--select SUM(so.NetAmount) from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos = ISNULL((
--select SUM(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.RecAmount>0),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.PaymentDue) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4 and so.PaymentDue>0),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(css.InstallmentAmt+css.LastPayAdjust) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((select SUM(cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and  cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)
--IF(@TotalSaleAmt-@CashInHandPos!=0)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values ('Customer Due',0,0,4) --amount will come from another sp, follow c# method


----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

--set  @TotalPOAmt=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0.00)

--set  @TotalPOAmt=@TotalPOAmt+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4),0.00)

--set  @TotalPOReturn=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0.00)



--set @TotalSales=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=1),0)

--set  @TotalSales=@TotalSales+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4),0.00)

--set @TotalSalesReturn=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=4),0)

--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Stock',(@TotalPOAmt+@TotalSalesReturn-@TotalPOReturn-@TotalSales),0.00,7)

---------------------------------------Stock Value End-------------------------------



--****************************************************
--***************Debit End****************************
--****************************************************



--****************************************************
--***************Credit Start*************************
--****************************************************


-----------------------------------Transfer Out and Transfer Payable---------------------------------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Out',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Payable',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4

------------------Investment-----------------------------------------------------
declare @Liability decimal(18,2)

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Lia. Receive',0.00,@Liability,3)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
INSERT INTO #crTemp(Particulars, Debit, Credit, SerialNum) values('Lia. Receive',0.00,@Liability,3)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
END

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=2 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
END

---Asset
set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Current Asset' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
END
-------------------------------------Direct Income-------------------------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select exi.Description,0.00,ex.Amount,3 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2

-------------------------------------Retail and hire Sales----------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.GrandTotal,6 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.NetAmount-so.InterestAmount,6 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1

--------------------------------------Purchase Discount------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Discount',0.00,po.NetDiscount,5 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID and po.NetDiscount>0

-----------------------------------------Hire Interest--------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Hire Interest',0.00,so.InterestAmount,12 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.InterestAmount>0


----------------------------------------Supplier Due----------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)


SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)

--IF(@SupplierDue-@CashDelivery!=0)
--	Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue-@CashDelivery,5)
IF(@SupplierDue != 0)
	BEGIN
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @ToDate, @ToDate, @ToDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		drop TABLE #tmpSupplierDue

		DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue + @totalOpeningDue



		Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',@SupplierDue,0,7)
	END


-----------------------------Purchase Return---------------------------

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Return',0.00,po.TotalAmt,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID

--****************************************************
--***************Credit End***************************
--****************************************************
--INSERT INTO #fTemp(ID,DebitParticular, Debit, CreditPaticular, Credit, SerialNum)
--SELECT ISNULL(T1.ID, 3), ISNULL(T1.Particulars, ''), ISNULL(T1.Debit, 0), '', 0.00, T1.SerialNum FROM #temp T1
--UNION ALL
--SELECT 0, '', 0, ISNULL(T2.Particulars, ''), ISNULL(T2.Credit, 0), T2.SerialNum FROM #crTemp T2


-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit from #fTemp
GROUP BY DebitParticular, CreditParticular




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--exec sp_TrialBalance  '01 Oct 2020 12:00:00 AM','02 Oct 2023 11:59:59 PM',5212



-------------Rakib--------------
----------09-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_TrialBalance  '01 Oct 2023 12:00:00 AM','09 Oct 2023 11:59:59 PM',5213
ALTER PROC [dbo].[sp_TrialBalance]
(
  @FromDate datetime,
  @ToDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int)



--****************************************************
--***************Debit Start**************************
--****************************************************

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Cash at Banks', ISNULL(sum(TotalAmount),0.0),0.00,1 from Banks
--where ConcernID=@ConcernID

------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)
--set @OpeningBalance = ISNULL((select sum(Amount)from ShareInvestments i
--JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
--JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
--where i.ConcernID=@ConcernID AND ih.Name LIKE 'Opening%' AND (p.Name='Current Asset' OR p.Name='Fixed Asset')),0.00)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

----direct expense
--set @TotalExpense =ISNULL((
--select SUM(Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1),0)

----cash delivery
--set @TotalExpense =@TotalExpense+ISNULL((
--select sum(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

----sales return
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4
--),0)

-----cash purchase
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID
--),0)

----cash deposite
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID
--),0)

-------------------Income----------------

----cash collection
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

----installment collections
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(css.InstallmentAmt) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

----direct income
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(ex.Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2
--),0)

----hire sales downpayment
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

----cash sales
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1
--),0)

----cash withdraw from bank
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)
DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in hand',@TotalCashInHand,0.00,1)

-------------------------------------------Cash in the bank--------------------------------------------
set @TotalIncome=0
set @TotalExpense=0
--Deposit
set @TotalIncome= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
--Collection from Customer
set @TotalIncome=@TotalIncome+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
),0)

--Withdraw
set @TotalExpense= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
),0)

--Delivery to suppliers
set @TotalExpense=@TotalExpense+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
),0)

IF(@TotalIncome-@TotalExpense!=0)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in bank',@TotalIncome-@TotalExpense,0.00,2)

--------------------------------------------Direct Expense-----------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select exi.Description,Amount,0.00,3 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1

---------------------------------------------Purchase----------------------------------------
DECLARE @CashCollection decimal(18,2)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Purchase',po.GrandTotal,0.00,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID

---------------------------------------Transfer In and Transfer Receivables--------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer In',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4


--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Receivables',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

----------------------------------------Adjustment------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',cc.AdjustAmt,0.0,8 from CashCollections cc
where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',css.LastPayAdjust,0.0,8 from CreditSales so
join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.LastPayAdjust>0 and css.PaymentStatus='Paid')

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',so.AdjAmount,0.0,8 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.AdjAmount>0

------------------------------------------Discount Given---------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.Discount,0.0,7 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.Discount>0


Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Discount',so.NetDiscount,0.0,7 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0

declare @disAmt DECIMAL(18,2) = (select SUM(so.NetDiscount) from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0)

print(@disAmt)

------------------------------------------Sales Return------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Return',so.TotalAmount,0.0,7 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4

----------------------------------------------Customer Due---------------------------------
Declare @TotalSaleAmt  decimal(18,2)

--Set @TotalSaleAmt= ISNULL((
--select SUM(so.TotalAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and  so.InvoiceDate<=@ToDate) and so.Status=1),0)

----Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
----select SUM(so.OpeningDue) from Customers so
----where so.ConcernID=@ConcernID and (so.CreatedDate<=@ToDate)),0)

--Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
--select SUM(so.NetAmount) from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos = ISNULL((
--select SUM(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.RecAmount>0),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.PaymentDue) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4 and so.PaymentDue>0),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(css.InstallmentAmt+css.LastPayAdjust) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((select SUM(cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and  cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)
--IF(@TotalSaleAmt-@CashInHandPos!=0)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Customer Due',0,0,7) --amount will come from another sp, follow c# method


----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

--set  @TotalPOAmt=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0.00)

--set  @TotalPOAmt=@TotalPOAmt+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4),0.00)

--set  @TotalPOReturn=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0.00)



--set @TotalSales=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=1),0)

--set  @TotalSales=@TotalSales+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4),0.00)

--set @TotalSalesReturn=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=4),0)

--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Stock',(@TotalPOAmt+@TotalSalesReturn-@TotalPOReturn-@TotalSales),0.00,7)

---------------------------------------Stock Value End-------------------------------



--****************************************************
--***************Debit End****************************
--****************************************************



--****************************************************
--***************Credit Start*************************
--****************************************************


-----------------------------------Transfer Out and Transfer Payable---------------------------------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Out',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Payable',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4

------------------Investment-----------------------------------------------------
declare @Liability decimal(18,2)

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Lia. Receive',0.00,@Liability,3)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
INSERT INTO #crTemp(Particulars, Debit, Credit, SerialNum) values('Lia. Receive',0.00,@Liability,3)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
END

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=2 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
END

---Asset
set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Current Asset' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
END
-------------------------------------Direct Income-------------------------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select exi.Description,0.00,ex.Amount,3 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2

-------------------------------------Retail and hire Sales----------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.GrandTotal,6 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.NetAmount-so.InterestAmount,6 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1

--------------------------------------Purchase Discount------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Discount',0.00,po.NetDiscount,5 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID and po.NetDiscount>0

-----------------------------------------Hire Interest--------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Hire Interest',0.00,so.InterestAmount,12 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.InterestAmount>0


----------------------------------------Supplier Due----------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)

--set @SupplierDue = ISNULL((
--select Sum(po.TotalAmt) From POrders po
--where po.Status=1 and po.ConcernID=@ConcernID and (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate)),0)

----set @SupplierDue =@SupplierDue+ ISNULL((
----select Sum(po.OpeningDue) From Suppliers po
----where (po.ConcernID=@ConcernID)),0)

--set @CashDelivery =ISNULL((
--select sum(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

--set @CashDelivery =@CashDelivery+ ISNULL((
--select Sum(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0)

--set @CashDelivery =@CashDelivery+ ISNULL((
--select Sum(po.PaymentDue) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0)

--set @CashDelivery=@CashDelivery+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)

SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)

--IF(@SupplierDue-@CashDelivery!=0)
--	Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue-@CashDelivery,5)
IF(@SupplierDue != 0)
	BEGIN
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @ToDate, @ToDate, @ToDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		drop TABLE #tmpSupplierDue

		DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue + @totalOpeningDue



		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue,5)
	END


-----------------------------Purchase Return---------------------------

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Return',0.00,po.TotalAmt,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID

--****************************************************
--***************Credit End***************************
--****************************************************
--INSERT INTO #fTemp(ID,DebitParticular, Debit, CreditPaticular, Credit, SerialNum)
--SELECT ISNULL(T1.ID, 3), ISNULL(T1.Particulars, ''), ISNULL(T1.Debit, 0), '', 0.00, T1.SerialNum FROM #temp T1
--UNION ALL
--SELECT 0, '', 0, ISNULL(T2.Particulars, ''), ISNULL(T2.Credit, 0), T2.SerialNum FROM #crTemp T2


-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    '',
    0,
    t.SerialNum
FROM #temp t


-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    '' AS DebitParticular,
    0 AS Debit,
    t.Particulars AS CreditParticular,
    t.Credit,
    t.SerialNum
FROM #crTemp t


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit from #fTemp
GROUP BY DebitParticular, CreditParticular




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--exec sp_TrialBalance  '01 Oct 2020 12:00:00 AM','02 Oct 2023 11:59:59 PM',5212



-------------Rakib--------------
----------08-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--EXEC sp_DailyCashInHand  '11 MAY 2021 12:00:00 AM','11 MAY 2021 11:59:59 PM',16
ALTER procedure [dbo].[sp_DailyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-08-01'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)



create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(DAY, 1, Convert(date, GetDate()))
begin
	print @StartDate

	delete
	from #temp_Data1

	delete
	from #temp_Data2

	--	DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
	--	DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
	------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
	insert into #temp_Data1
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
				and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
		from POrders po
		join Suppliers s on po.SupplierID = s.SupplierID
		where po.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
		and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and po.RecAmt>0
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
	---------------------------------Expense from Bank Deposit--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

	END

	---------------------------------Expense from Bank Loan--------------------
	set @total = isnull((
				SELECT SUM(ISNULL(BC.CollectionAmount, 0) + ISNULL(BC.SDPS, 0) + ISNULL(BC.Savings,0)) FROM dbo.BankLoanCollections BC
				JOIN dbo.BankLoanDetails BLD ON BC.Id = BLD.LoanCollectionId
				JOIN  dbo.BankLoans BL ON BLD.BankLoanId = BL.Id
				JOIN dbo.Banks B ON BL.BankId = B.BankID
				where BL.ConcernID = @ConcernID AND BLD.LoanCollectionId IS NOT NULL
				AND CAST(BC.CollectionDate AS DATE) = CAST(@StartDate AS DATE)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Loan Payment', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ', ' + B.BankName, SUM(ISNULL(BC.CollectionAmount, 0) + ISNULL(BC.SDPS, 0) + ISNULL(BC.Savings,0)), 'Bank Loan', 0, 'Cash'
		FROM dbo.BankLoanCollections BC
		JOIN dbo.BankLoanDetails BLD ON BC.Id = BLD.LoanCollectionId
		JOIN  dbo.BankLoans BL ON BLD.BankLoanId = BL.Id
		JOIN dbo.Banks B ON BL.BankId = B.BankID
		where BL.ConcernID = @ConcernID AND BLD.LoanCollectionId IS NOT NULL
		AND CAST(BC.CollectionDate AS DATE) = CAST(@StartDate AS DATE)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Loan Payment', @total, '', 0, 'Header'

	END
	---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------


	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank collections', @total, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	inner join Customers c on BT.CustomerID = c.CustomerID
	where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
	group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	insert into #temp_Data1
	select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
	---------------------------------Expens from Bank Cash Delivery---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Cash Delivery', @total, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END

---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Income', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Income (Cr))', sum(Amount), 'Bank Income ', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Income ', @total, '', 0, 'Header'
END


	---------------------------------Expense from Fund Out---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections cc
				join Suppliers s on cc.SupplierID = s.SupplierID
				where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
				and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
		and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
	------------------------------------------------------Expense in Product return----------------------------------
	set @total = isnull((
				select sum(PaidAmount)
				from ROrders
				where ConcernID = @ConcernID and DAY(Convert(date, ReturnDate)) = DAY(@StartDate) and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

END

	-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Cash Collection Return', @total, 'Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

	------------- -------------------------------------------- Direct Expense--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' and EX.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' and EX.CashInHandReportStatus = 0
		and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description

		insert into #temp_Data1
		select @StartDate,'Total Expense', @total, '', 0, 'Header'
	end

		--------------- --------------------------------------------Expense From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernId = @ConcernID  and DAY(Convert(date, TransactionDate)) = DAY(@StartDate)
				and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernId = @ConcernID and DAY(Convert(date, TransactionDate)) = DAY(@StartDate)
		and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
	------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
						where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end



	-- ----------------------------Expens from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=3  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
END

	----------------------------------------------Opening Cash In Hand in Income Table--------------------------------------------------------------- 
	insert into #temp_Data2
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	-----------------------------------------------Income in Sales Order-------------------------------------------
	set @total = isnull((
				select sum(RecAmount)
				from SOrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount,Convert(varchar(10),c.CustomerType)+'Order' from SOrders so
		join Customers c on so.CustomerID = c.CustomerID
		where so.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
	    insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
   
   END
	---------------------------------Income from Bank Withdwal--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

				---------------------------------Income from Bank Expens as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Expens as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Bank Expens(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Loan--------------------
	set @total = ISNULL((
				SELECT SUM(BL.PrincipleLoanAmount) FROM dbo.BankLoans BL
				JOIN dbo.Banks B ON BL.BankId = B.BankID
				WHERE BL.ConcernId = @ConcernID
				AND CAST(BL.LoanDate AS DATE) = CAST(@StartDate AS DATE)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2
		select @StartDate,'', 0, 'Bank Loan', 0, 'Header'

		insert into #temp_Data2
		select @StartDate, '', 0, B.AccountNo + ',' + B.BankName, SUM(BL.PrincipleLoanAmount), 'Cash'
		FROM dbo.BankLoans BL
		JOIN dbo.Banks B ON BL.BankId = B.BankID
		where BL.ConcernID = @ConcernID
		AND CAST(BL.LoanDate AS DATE) = CAST(@StartDate AS DATE)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data2
		select @StartDate,'', 0, 'Total Bank Loan', @total, 'Header'

	END


	---------------------------------Income from Bank Cash Collection---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
		('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on bt.CustomerID=c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	----------------------------------------Income from Fund IN------------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.AnotherBankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.AnotherBankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-- ---------------------------------------Income from Cash Collection from Customer-------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
				), 0)

	if (@total != 0)
	BEGIN
	insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, Convert(varchar(10),c.CustomerType)+'Cash'
		from CashCollections cc
		join Customers c on cc.CustomerID = c.CustomerID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
	    insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')
		
		END
	-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
	set @total = isnull((
				select isnull(sum(DownPayment), 0)
				from CreditSales
				where ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
		from CreditSales cs
		join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')
	
	END
	--------------------------------------Income in Purchase Product return----------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and DAY(Convert(date, OrderDate)) = DAY(@StartDate) and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and status = 5
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Purchase Return Cash'

	-------------------------------Income Installment Collection from Creditsales------------------
	set @total = isnull((
				select sum(InstallmentAmt)
				from CreditSalesSchedules css
				inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
				where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
		from CreditSalesSchedules css
		inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
		inner join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
	  
	  insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')
	
	END
	-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Description, sum(Amount), E.Description
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 2 and  EX.CashInHandReportStatus = 0 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')
	
	end

	-- ----------------------------Income from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
	END

	   SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)
	IF (@total != 0)
	BEGIN
		INSERT INTO #temp_Data2
		SELECT @StartDate, '', 0.00,SIH.Name+'(Current Asset)',  sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name

		insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')
	END

	insert into #temp_Data3
	select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), '', 0.00,  ''
	from #temp_Data1 T1
	UNION ALL
	select @StartDate, 0,  '', 0, isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
	from #temp_Data2 T2

	declare @a decimal(18, 2)
	declare @b decimal(18, 2)
	declare @ExpenseWithinDate decimal(18, 2)
	declare @IncomeWithinDate decimal(18, 2)
	declare @CashInHandWithinDate decimal(18, 2)

	set @a = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @b = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @ExpenseWithinDate = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @IncomeWithinDate = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
	set @CashInHand = @CashInHand + (@b - @a)

	insert into #temp_Data3
	values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

	insert into #temp_Data3
	values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

	insert into #temp_Data3
	values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

	set @StartDate = DATEADD(DAY, 1, @StartDate)
	--select *From #temp_Data1
	--select *From #temp_Data2
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)


-------------Rakib--------------
----------07-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_TrialBalance  '01 Oct 2020 12:00:00 AM','02 Oct 2023 11:59:59 PM',5212
ALTER PROC [dbo].[sp_TrialBalance]
(
  @FromDate datetime,
  @ToDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int)



--****************************************************
--***************Debit Start**************************
--****************************************************

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Cash at Banks', ISNULL(sum(TotalAmount),0.0),0.00,1 from Banks
--where ConcernID=@ConcernID

------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)
--set @OpeningBalance = ISNULL((select sum(Amount)from ShareInvestments i
--JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
--JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
--where i.ConcernID=@ConcernID AND ih.Name LIKE 'Opening%' AND (p.Name='Current Asset' OR p.Name='Fixed Asset')),0.00)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

----direct expense
--set @TotalExpense =ISNULL((
--select SUM(Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1),0)

----cash delivery
--set @TotalExpense =@TotalExpense+ISNULL((
--select sum(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

----sales return
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4
--),0)

-----cash purchase
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID
--),0)

----cash deposite
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID
--),0)

-------------------Income----------------

----cash collection
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

----installment collections
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(css.InstallmentAmt) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

----direct income
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(ex.Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2
--),0)

----hire sales downpayment
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

----cash sales
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1
--),0)

----cash withdraw from bank
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)
DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in hand',@TotalCashInHand,0.00,1)

-------------------------------------------Cash in the bank--------------------------------------------
set @TotalIncome=0
set @TotalExpense=0
--Deposit
set @TotalIncome= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
--Collection from Customer
set @TotalIncome=@TotalIncome+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
),0)

--Withdraw
set @TotalExpense= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
),0)

--Delivery to suppliers
set @TotalExpense=@TotalExpense+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
),0)

IF(@TotalIncome-@TotalExpense!=0)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in bank',@TotalIncome-@TotalExpense,0.00,2)

--------------------------------------------Direct Expense-----------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select exi.Description,Amount,0.00,3 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1

---------------------------------------------Purchase----------------------------------------
DECLARE @CashCollection decimal(18,2)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Purchase',po.GrandTotal,0.00,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID

---------------------------------------Transfer In and Transfer Receivables--------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer In',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4


--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Receivables',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

----------------------------------------Adjustment------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',cc.AdjustAmt,0.0,8 from CashCollections cc
where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',css.LastPayAdjust,0.0,8 from CreditSales so
join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.LastPayAdjust>0 and css.PaymentStatus='Paid')

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',so.AdjAmount,0.0,8 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.AdjAmount>0

------------------------------------------Discount Given---------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Discount Given',so.Discount,0.0,7 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.Discount>0

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Discount Given',so.NetDiscount,0.0,7 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0

------------------------------------------Sales Return------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Return',so.TotalAmount,0.0,7 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4

----------------------------------------------Customer Due---------------------------------
Declare @TotalSaleAmt  decimal(18,2)

--Set @TotalSaleAmt= ISNULL((
--select SUM(so.TotalAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and  so.InvoiceDate<=@ToDate) and so.Status=1),0)

----Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
----select SUM(so.OpeningDue) from Customers so
----where so.ConcernID=@ConcernID and (so.CreatedDate<=@ToDate)),0)

--Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
--select SUM(so.NetAmount) from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos = ISNULL((
--select SUM(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.RecAmount>0),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.PaymentDue) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4 and so.PaymentDue>0),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(css.InstallmentAmt+css.LastPayAdjust) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((select SUM(cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and  cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)
--IF(@TotalSaleAmt-@CashInHandPos!=0)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Customer Due',0,0,7) --amount will come from another sp, follow c# method


----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

--set  @TotalPOAmt=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0.00)

--set  @TotalPOAmt=@TotalPOAmt+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4),0.00)

--set  @TotalPOReturn=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0.00)



--set @TotalSales=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=1),0)

--set  @TotalSales=@TotalSales+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4),0.00)

--set @TotalSalesReturn=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=4),0)

--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Stock',(@TotalPOAmt+@TotalSalesReturn-@TotalPOReturn-@TotalSales),0.00,7)

---------------------------------------Stock Value End-------------------------------



--****************************************************
--***************Debit End****************************
--****************************************************



--****************************************************
--***************Credit Start*************************
--****************************************************


-----------------------------------Transfer Out and Transfer Payable---------------------------------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Out',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Payable',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4

------------------Investment-----------------------------------------------------
declare @Liability decimal(18,2)

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Lia. Receive',0.00,@Liability,3)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
INSERT INTO #crTemp(Particulars, Debit, Credit, SerialNum) values('Lia. Receive',0.00,@Liability,3)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
END

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=2 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
END

---Asset
set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Current Asset' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
END
-------------------------------------Direct Income-------------------------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select exi.Description,0.00,ex.Amount,3 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2

-------------------------------------Retail and hire Sales----------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.GrandTotal,6 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.NetAmount-so.InterestAmount,6 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1

--------------------------------------Purchase Discount------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Discount',0.00,po.NetDiscount,5 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID and po.NetDiscount>0

-----------------------------------------Hire Interest--------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Hire Interest',0.00,so.InterestAmount,12 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.InterestAmount>0


----------------------------------------Supplier Due----------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)

--set @SupplierDue = ISNULL((
--select Sum(po.TotalAmt) From POrders po
--where po.Status=1 and po.ConcernID=@ConcernID and (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate)),0)

----set @SupplierDue =@SupplierDue+ ISNULL((
----select Sum(po.OpeningDue) From Suppliers po
----where (po.ConcernID=@ConcernID)),0)

--set @CashDelivery =ISNULL((
--select sum(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

--set @CashDelivery =@CashDelivery+ ISNULL((
--select Sum(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0)

--set @CashDelivery =@CashDelivery+ ISNULL((
--select Sum(po.PaymentDue) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0)

--set @CashDelivery=@CashDelivery+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)

SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)

--IF(@SupplierDue-@CashDelivery!=0)
--	Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue-@CashDelivery,5)
IF(@SupplierDue != 0)
	BEGIN
		create table #tmpSupplierDue(SupplierID INT, TotalDue DECIMAL(18,2))


		INSERT INTO #tmpSupplierDue(SupplierID, TotalDue)
			EXEC dbo.GetDatewiseSupplierDue @ConcernID, 0, @ToDate, @ToDate, @ToDate

		SET @SupplierDue = (SELECT SUM(TotalDue) FROM #tmpSupplierDue)
		drop TABLE #tmpSupplierDue

		DECLARE @totalOpeningDue DECIMAL(18,2) = (SELECT SUM(ISNULL(OpeningDue, 0)) FROM dbo.Suppliers WHERE ConcernID = @ConcernID)

		SET @SupplierDue = @SupplierDue + @totalOpeningDue



		Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue,5)
	END


-----------------------------Purchase Return---------------------------

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Return',0.00,po.TotalAmt,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID

--****************************************************
--***************Credit End***************************
--****************************************************
--INSERT INTO #fTemp(ID,DebitParticular, Debit, CreditPaticular, Credit, SerialNum)
--SELECT ISNULL(T1.ID, 3), ISNULL(T1.Particulars, ''), ISNULL(T1.Debit, 0), '', 0.00, T1.SerialNum FROM #temp T1
--UNION ALL
--SELECT 0, '', 0, ISNULL(T2.Particulars, ''), ISNULL(T2.Credit, 0), T2.SerialNum FROM #crTemp T2


-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    ct.Particulars AS CreditParticular,
    ct.Credit,
    t.SerialNum
FROM #temp t
LEFT JOIN #crTemp ct ON t.ID = ct.ID

-- Insert data from #temp that doesn't have a matching ID in #crTemp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    NULL AS CreditParticular,
    NULL AS Credit,
    t.SerialNum
FROM #temp t
WHERE t.ID NOT IN (SELECT ID FROM #crTemp)

-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    ct.ID,
    NULL AS DebitParticular,
    NULL AS Debit,
    ct.Particulars AS CreditParticular,
    ct.Credit,
    ct.SerialNum
FROM #crTemp ct
WHERE ct.ID NOT IN (SELECT ID FROM #temp)


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit from #fTemp
GROUP BY DebitParticular, CreditParticular




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--exec sp_TrialBalance  '01 Oct 2020 12:00:00 AM','02 Oct 2023 11:59:59 PM',5212


-------------Rakib--------------
----------07-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[GetDatewiseSupplierDue]
(
		@concernId INT
		,@SupplierId INT,
		@asOnDate datetime,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.SupplierID,
		(
			(
				ISNULL(piv.TotalAmt, 0) 
				+ ISNULL(piv.TotalReturnRecAmt, 0) + ISNULL(piv.CashCollectionIntAmt, 0)
			)
			-
			(
				ISNULL(piv.TotalRecAmt, 0) 
				+ ISNULL(piv.TotalReturnAmt, 0) + ISNULL(piv.CashCollectionAmt, 0) + ISNULL(piv.BankTransaction, 0)
			)
		) 'TotalDue'

	FROM
	(

	--start here 
	

	-- end here
	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SupplierID  FROM
	(
	SELECT po.TotalAmt PrevSales, 'TotalAmt' Id, po.SupplierID FROM dbo.POrders po
	JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
	JOIN dbo.Products p ON p.ProductID = pd.ProductID
	WHERE po.ConcernID = @concernId
	AND po.Status = 1
	AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY po.SupplierID, po.TotalAmt, po.ChallanNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.SupplierID

	UNION ALL

	SELECT SUM(tblPO.PrevSales) PrevSales, tblPO.Id, tblPO.SupplierID  FROM
	(
	SELECT po.RecAmt PrevSales, 'TotalRecAmt' Id, po.SupplierID FROM dbo.POrders po
	JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
	JOIN dbo.Products p ON p.ProductID = pd.ProductID
	WHERE po.ConcernID = @concernId
	AND po.Status = 1
	AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY po.SupplierID, po.RecAmt, po.ChallanNo
	) tblPO
	GROUP BY tblPO.Id, tblPO.SupplierID
	
	UNION ALL
	SELECT SUM(tblReturn.PrevSales) PrevSales, tblReturn.Id, tblReturn.SupplierID FROM
	(
		SELECT po.TotalAmt PrevSales, 'TotalReturnAmt' Id, po.SupplierID FROM dbo.POrders po
		JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
		JOIN dbo.Products p ON p.ProductID = pd.ProductID
		WHERE po.ConcernID = @concernId
		AND po.Status = 5
		AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
		AND (
			(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
				OR
			(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
		)
		GROUP BY po.SupplierID, po.TotalAmt, po.ChallanNo
	) tblReturn
	GROUP BY tblReturn.Id, tblReturn.SupplierID
	UNION ALL

		SELECT SUM(tblReturn.PrevSales) PrevSales, tblReturn.Id, tblReturn.SupplierID FROM
	(
		SELECT po.RecAmt PrevSales, 'TotalReturnRecAmt' Id, po.SupplierID FROM dbo.POrders po
		JOIN dbo.POrderDetails pd ON po.POrderID = pd.POrderID
		JOIN dbo.Products p ON p.ProductID = pd.ProductID
		WHERE po.ConcernID = @concernId
		AND po.Status = 5
		AND (@SupplierId = 0 OR po.SupplierID = @SupplierId)
		AND (
			(@asOnDate IS NOT NULL AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE))
				OR
			(@asOnDate IS NULL AND CAST(po.OrderDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
		)
		GROUP BY po.SupplierID, po.RecAmt, po.ChallanNo
	) tblReturn
	GROUP BY tblReturn.Id, tblReturn.SupplierID

	UNION ALL

	SELECT SUM(ISNULL(cc.InterestAmt, 0)), 'CashCollectionIntAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	GROUP BY cc.SupplierID
	
	UNION ALL

	SELECT SUM(ISNULL(cc.Amount, 0) + ISNULL(cc.AdjustAmt, 0)), 'CashCollectionAmt' Id, cc.SupplierID FROM dbo.CashCollections cc
	WHERE cc.ConcernID = @concernId
	AND cc.SupplierID <> 0
	AND (@SupplierId = 0 OR cc.SupplierID = @SupplierId)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY cc.SupplierID

	UNION ALL

	SELECT SUM(ISNULL(bt.Amount, 0)), 'BankTransaction', bt.SupplierID FROM dbo.BankTransactions bt
	WHERE bt.ConcernID = @concernId
	AND bt.SupplierID <> 0
	AND (@SupplierId = 0 OR bt.SupplierID = @SupplierId)
		AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
			OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)

	GROUP BY bt.SupplierID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			TotalAmt, TotalRecAmt, TotalReturnAmt, TotalReturnRecAmt, CashCollectionIntAmt, CashCollectionAmt, BankTransaction

		)
	) piv
 END




-------------Rakib--------------
----------04-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[GetDatewiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue',
		ISNULL(piv.InterestAmount, 0) as TInterestAmount,
		ISNULL(piv.CrInterestAmount, 0) as CrInterestAmount



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL



	--start here 



	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 1 
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND css.PaymentStatus = 'Paid'
	AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cc.TransactionType IN(1)
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	 AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND c.CreditDue + c.TotalDue  != 0
	AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END


 --EXEC GetDatewiseCustomerDue 5213, 0, '2023-10-23'


-------------Rakib--------------
----------04-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[GetCategorywiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT
		,@isOnlyDue BIT
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue',
		ISNULL(piv.InterestAmount, 0) as TInterestAmount,
		ISNULL(piv.CrInterestAmount, 0) as CrInterestAmount



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL



	--start here 



	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	--UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0)) 
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0)) 
	AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	 AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END


 --EXEC GetCategorywiseCustomerDue 5213, 0, 1


-------------Rakib--------------
----------04-10-2023------------
--------------------------------


--EXEC GetDatewiseCustomerDueRpt 5213, 0, null, 0, '2010-08-05', '2023-10-05'

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[GetDatewiseCustomerDueRpt]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime,
		@isOnlyDue BIT,
		@fromDate datetime,
		@toDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		
		CAST(((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0))) AS DECIMAL(18,2)) 'Sales',
		CAST(ISNULL(piv.InterestAmount, 0) as DECIMAL(18,2)) as CashCollectionInterestAmt,
		CAST(ISNULL(piv.CrInterestAmount, 0) as DECIMAL(18,2)) as HireIntestrestAmt,

		CAST((
			(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
			ISNULL(piv.InterestAmount, 0) +
			ISNULL(piv.CrInterestAmount, 0)
			) AS DECIMAL(18,2)
		) 'TotalAmt',
		CAST(ISNULL(piv.RecAmount, 0) as DECIMAL(18,2)) 'SalesReceive',
		CAST((
			(
				ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
			) - 
			(
				ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) + ISNULL(piv.CrAdjustment, 0)
			)
		) AS  DECIMAL(18,2)) 'CollectionAmt',
		CAST(ISNULL(piv.InstallmentCollection, 0) AS DECIMAL(18,2)) InstallmentCollection,
		CAST((
			(
				(
					ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
				) - 
				(
					ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
				)

			) +
			ISNULL(piv.InstallmentCollection, 0)
			+
			ISNULL(piv.RecAmount, 0)
		) AS DECIMAL(18,2)) 'TotalCollection',
		CAST(ISNULL(piv.[Return], 0) AS DECIMAL(18,2)) 'SaleReturn',
		CAST(ISNULL(piv.OpeningDue, 0) AS DECIMAL(18,2)) 'OpeningDue',
		CAST(
			(
				(
					(ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) +
					ISNULL(piv.InterestAmount, 0) +
					ISNULL(piv.CrInterestAmount, 0)
				) -
				(
					(
						(
							ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0)
						) - 
						(
							ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)
						)

					) +
					ISNULL(piv.InstallmentCollection, 0)
					+
					ISNULL(piv.RecAmount, 0)
				) -
				ISNULL(piv.[Return], 0)
			)
			AS DECIMAL(18,2)
		) 'ClosingDue'



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	UNION ALL



	--start here 
	

	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	--UNION ALL
	--SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	--JOIN Customers c ON s.CustomerID = c.CustomerID
	--WHERE s.ConcernID = @ConcernID 
	--AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	----AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	--AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	--GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cs.IsStatus = 1 
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND (@isOnlyDue = 0 OR (c.CreditDue + c.TotalDue  != 0))
	--AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (
		(@asOnDate IS NOT NULL AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE))
		OR
		(@asOnDate IS NULL AND CAST(Cri.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@toDate AS DATE))
	)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END


 --EXEC GetDatewiseCustomerDueRpt 5213, 0, null, 0, '2010-08-05', '2023-10-05'

-------------Rakib--------------
----------03-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[GetDatewiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT,
		@asOnDate datetime
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.SalesReturn, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) - ISNULL(piv.SalesReturn, 0)) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue',
		ISNULL(piv.InterestAmount, 0) as TInterestAmount,
		ISNULL(piv.CrInterestAmount, 0) as CrInterestAmount



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL



	--start here 



	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 4 
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 1 
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(bt.TranDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(s.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND css.PaymentStatus = 'Paid'
	AND CAST(css.PaymentDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cc.TransactionType IN(1)
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	 AND c.CreditDue + c.TotalDue  != 0
	AND CAST(cc.EntryDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND c.CreditDue + c.TotalDue  != 0
	AND CAST(Cri.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, SalesReturn, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END


 --EXEC GetDatewiseCustomerDue 5212, 0, '2023-10-23'



-------------Rakib--------------
----------02-10-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--exec sp_TrialBalance  '01 Oct 2020 12:00:00 AM','02 Oct 2023 11:59:59 PM',5212
ALTER PROC [dbo].[sp_TrialBalance]
(
  @FromDate datetime,
  @ToDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #crTemp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)
Create table #fTemp(ID int null,DebitParticular nvarchar(MAX),Debit decimal(18,2),CreditParticular nvarchar(MAX),Credit decimal(18,2),SerialNum int)



--****************************************************
--***************Debit Start**************************
--****************************************************

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Cash at Banks', ISNULL(sum(TotalAmount),0.0),0.00,1 from Banks
--where ConcernID=@ConcernID

------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)
--set @OpeningBalance = ISNULL((select sum(Amount)from ShareInvestments i
--JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
--JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
--where i.ConcernID=@ConcernID AND ih.Name LIKE 'Opening%' AND (p.Name='Current Asset' OR p.Name='Fixed Asset')),0.00)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

----direct expense
--set @TotalExpense =ISNULL((
--select SUM(Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1),0)

----cash delivery
--set @TotalExpense =@TotalExpense+ISNULL((
--select sum(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

----sales return
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4
--),0)

-----cash purchase
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID
--),0)

----cash deposite
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID
--),0)

-------------------Income----------------

----cash collection
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

----installment collections
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(css.InstallmentAmt) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

----direct income
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(ex.Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2
--),0)

----hire sales downpayment
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

----cash sales
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1
--),0)

----cash withdraw from bank
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)
DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in hand',@TotalCashInHand,0.00,1)

-------------------------------------------Cash in the bank--------------------------------------------
set @TotalIncome=0
set @TotalExpense=0
--Deposit
set @TotalIncome= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
--Collection from Customer
set @TotalIncome=@TotalIncome+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
),0)

--Withdraw
set @TotalExpense= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
),0)

--Delivery to suppliers
set @TotalExpense=@TotalExpense+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
),0)

IF(@TotalIncome-@TotalExpense!=0)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in bank',@TotalIncome-@TotalExpense,0.00,2)

--------------------------------------------Direct Expense-----------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select exi.Description,Amount,0.00,3 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1

---------------------------------------------Purchase----------------------------------------
DECLARE @CashCollection decimal(18,2)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Purchase',po.GrandTotal,0.00,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID

---------------------------------------Transfer In and Transfer Receivables--------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer In',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4


--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Receivables',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

----------------------------------------Adjustment------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',cc.AdjustAmt,0.0,8 from CashCollections cc
where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',css.LastPayAdjust,0.0,8 from CreditSales so
join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.LastPayAdjust>0 and css.PaymentStatus='Paid')

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',so.AdjAmount,0.0,8 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.AdjAmount>0

------------------------------------------Discount Given---------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Discount Given',so.Discount,0.0,7 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.Discount>0

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Discount Given',so.NetDiscount,0.0,7 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0

------------------------------------------Sales Return------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Return',so.TotalAmount,0.0,7 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4

----------------------------------------------Customer Due---------------------------------
Declare @TotalSaleAmt  decimal(18,2)

--Set @TotalSaleAmt= ISNULL((
--select SUM(so.TotalAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and  so.InvoiceDate<=@ToDate) and so.Status=1),0)

----Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
----select SUM(so.OpeningDue) from Customers so
----where so.ConcernID=@ConcernID and (so.CreatedDate<=@ToDate)),0)

--Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
--select SUM(so.NetAmount) from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos = ISNULL((
--select SUM(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.RecAmount>0),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.PaymentDue) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4 and so.PaymentDue>0),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(css.InstallmentAmt+css.LastPayAdjust) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((select SUM(cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and  cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)
--IF(@TotalSaleAmt-@CashInHandPos!=0)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Customer Due',0,0,7) --amount will come from another sp, follow c# method


----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

--set  @TotalPOAmt=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0.00)

--set  @TotalPOAmt=@TotalPOAmt+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4),0.00)

--set  @TotalPOReturn=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0.00)



--set @TotalSales=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=1),0)

--set  @TotalSales=@TotalSales+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4),0.00)

--set @TotalSalesReturn=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=4),0)

--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Stock',(@TotalPOAmt+@TotalSalesReturn-@TotalPOReturn-@TotalSales),0.00,7)

---------------------------------------Stock Value End-------------------------------



--****************************************************
--***************Debit End****************************
--****************************************************



--****************************************************
--***************Credit Start*************************
--****************************************************


-----------------------------------Transfer Out and Transfer Payable---------------------------------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Out',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Payable',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4

------------------Investment-----------------------------------------------------
declare @Liability decimal(18,2)

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Lia. Receive',0.00,@Liability,3)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
INSERT INTO #crTemp(Particulars, Debit, Credit, SerialNum) values('Lia. Receive',0.00,@Liability,3)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
END

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=2 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
END

---Asset
set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Current Asset' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
END
-------------------------------------Direct Income-------------------------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select exi.Description,0.00,ex.Amount,3 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2

-------------------------------------Retail and hire Sales----------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.GrandTotal,6 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.NetAmount-so.InterestAmount,6 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1

--------------------------------------Purchase Discount------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Discount',0.00,po.NetDiscount,5 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID and po.NetDiscount>0

-----------------------------------------Hire Interest--------------------------
Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Hire Interest',0.00,so.InterestAmount,12 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.InterestAmount>0


----------------------------------------Supplier Due----------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)

--set @SupplierDue = ISNULL((
--select Sum(po.TotalAmt) From POrders po
--where po.Status=1 and po.ConcernID=@ConcernID and (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate)),0)

----set @SupplierDue =@SupplierDue+ ISNULL((
----select Sum(po.OpeningDue) From Suppliers po
----where (po.ConcernID=@ConcernID)),0)

--set @CashDelivery =ISNULL((
--select sum(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

--set @CashDelivery =@CashDelivery+ ISNULL((
--select Sum(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0)

--set @CashDelivery =@CashDelivery+ ISNULL((
--select Sum(po.PaymentDue) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0)

--set @CashDelivery=@CashDelivery+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)

SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers WHERE @ConcernID = ConcernID)

--IF(@SupplierDue-@CashDelivery!=0)
--	Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue-@CashDelivery,5)
IF(@SupplierDue != 0)
	Insert Into #crTemp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue,5)


-----------------------------Purchase Return---------------------------

Insert Into #crTemp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Return',0.00,po.TotalAmt,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID

--****************************************************
--***************Credit End***************************
--****************************************************
--INSERT INTO #fTemp(ID,DebitParticular, Debit, CreditPaticular, Credit, SerialNum)
--SELECT ISNULL(T1.ID, 3), ISNULL(T1.Particulars, ''), ISNULL(T1.Debit, 0), '', 0.00, T1.SerialNum FROM #temp T1
--UNION ALL
--SELECT 0, '', 0, ISNULL(T2.Particulars, ''), ISNULL(T2.Credit, 0), T2.SerialNum FROM #crTemp T2


-- Insert data from #temp and #crTemp into #fTemp when the ID matches
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    ct.Particulars AS CreditParticular,
    ct.Credit,
    t.SerialNum
FROM #temp t
LEFT JOIN #crTemp ct ON t.ID = ct.ID

-- Insert data from #temp that doesn't have a matching ID in #crTemp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    t.ID,
    t.Particulars AS DebitParticular,
    t.Debit,
    NULL AS CreditParticular,
    NULL AS Credit,
    t.SerialNum
FROM #temp t
WHERE t.ID NOT IN (SELECT ID FROM #crTemp)

-- Insert data from #crTemp that doesn't have a matching ID in #temp
INSERT INTO #fTemp (ID, DebitParticular, Debit, CreditParticular, Credit, SerialNum)
SELECT
    ct.ID,
    NULL AS DebitParticular,
    NULL AS Debit,
    ct.Particulars AS CreditParticular,
    ct.Credit,
    ct.SerialNum
FROM #crTemp ct
WHERE ct.ID NOT IN (SELECT ID FROM #temp)


select DebitParticular,SUM(Debit) as Debit,CreditParticular, SUM(Credit) as Credit from #fTemp
GROUP BY DebitParticular, CreditParticular




DROP TABLE #temp
DROP TABLE #crTemp
DROP TABLE #fTemp
END

--exec sp_TrialBalance  '01 Oct 2020 12:00:00 AM','02 Oct 2023 11:59:59 PM',5212


-------------Rakib--------------
----------25-09-2023------------
--------------------------------

ALTER TABLE dbo.ShareInvestmentHeads
ADD OpeningBalance DECIMAL(18,2) NOT NULL DEFAULT 0

-------------Rakib--------------
----------24-09-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[DeleteLoanCollection]
(
	@BankLoanCollectionId int
)
  
AS 
 
BEGIN TRY
 BEGIN TRANSACTION 

 DECLARE @BankLoanId INT = ( SELECT BL.Id FROM BankLoanCollections BC
 JOIN BankLoanDetails BLD ON BC.Id = BLD.LoanCollectionId
 JOIN BankLoans BL ON BLD.BankLoanId = BL.Id
 WHERE BC.Id = @BankLoanCollectionId)

 UPDATE BankLoans SET IsPaid = 0 WHERE Id = @BankLoanId

 DECLARE @BankLoanDetailsId INT = ( SELECT BLD.Id FROM BankLoanCollections BC
 JOIN BankLoanDetails BLD ON BC.Id = BLD.LoanCollectionId
 JOIN BankLoans BL ON BLD.BankLoanId = BL.Id
 WHERE BC.Id = @BankLoanCollectionId)

 UPDATE BankLoanDetails SET InstallmentAmount = ExpectedInstallmentAmount, Status = 'Due', PaymentDate = NULL
 , LastPayAdjustment = 0, LoanCollectionId = NULL
 WHERE Id = @BankLoanDetailsId

 DELETE BankLoanCollections WHERE Id = @BankLoanCollectionId

COMMIT

RETURN 1

END TRY

BEGIN CATCH
  IF(@@TRANCOUNT>0)
    ROLLBACK
	RETURN 0
END CATCH

-------------Rakib--------------
----------24-09-2023------------
--------------------------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[BankLoanPenaltyDetails](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[LoanDetailsId] [int] NOT NULL,
	[PenaltyPercentage] [decimal](18, 2) NOT NULL,
	[PenaltyAmount] [decimal](18, 2) NOT NULL,
	[PenaltyDate] [datetime] NOT NULL,
	[CreatedBy] [int] NOT NULL,
	[CreateDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NULL,
	[ModifiedDate] [datetime] NULL,
 CONSTRAINT [PK_BankLoanPenaltyDetails] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[BankLoanPenaltyDetails]  WITH CHECK ADD  CONSTRAINT [FK_BankLoanPenaltyDetails_BankLoanDetails] FOREIGN KEY([LoanDetailsId])
REFERENCES [dbo].[BankLoanDetails] ([Id])
GO

ALTER TABLE [dbo].[BankLoanPenaltyDetails] CHECK CONSTRAINT [FK_BankLoanPenaltyDetails_BankLoanDetails]
GO


-------------Rakib--------------
----------24-09-2023------------
--------------------------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[BankLoanCollections](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[CollectionDate] [datetime] NOT NULL,
	[CollectionAmount] [decimal](18, 2) NOT NULL,
	[ConcernId] [int] NOT NULL,
	[Code] [nvarchar](20) NOT NULL,
	[CreatedBy] [int] NOT NULL,
	[CreateDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NULL,
	[ModifiedDate] [datetime] NULL,
	[CCLoanId] [int] NULL,
	[IsOnlyInterest] [bit] NOT NULL,
	[CollectionType] [int] NOT NULL,
	[PrevTotalGivenAmount] [decimal](18, 2) NOT NULL,
	[TotalGivenAmount] [decimal](18, 2) NOT NULL,
	[PrevTotalInterestAmount] [decimal](18, 2) NOT NULL,
	[TotalInterestAmount] [decimal](18, 2) NOT NULL,
	[SDPS] [decimal](18, 2) NOT NULL,
	[Savings] [decimal](18, 2) NOT NULL,
 CONSTRAINT [PK_BankLoanCollections] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[BankLoanCollections] ADD  DEFAULT ((0)) FOR [IsOnlyInterest]
GO

ALTER TABLE [dbo].[BankLoanCollections] ADD  DEFAULT ((1)) FOR [CollectionType]
GO

ALTER TABLE [dbo].[BankLoanCollections] ADD  DEFAULT ((0)) FOR [PrevTotalGivenAmount]
GO

ALTER TABLE [dbo].[BankLoanCollections] ADD  DEFAULT ((0)) FOR [TotalGivenAmount]
GO

ALTER TABLE [dbo].[BankLoanCollections] ADD  DEFAULT ((0)) FOR [PrevTotalInterestAmount]
GO

ALTER TABLE [dbo].[BankLoanCollections] ADD  DEFAULT ((0)) FOR [TotalInterestAmount]
GO

ALTER TABLE [dbo].[BankLoanCollections] ADD  DEFAULT ((0)) FOR [SDPS]
GO

ALTER TABLE [dbo].[BankLoanCollections] ADD  DEFAULT ((0)) FOR [Savings]
GO


ALTER TABLE [dbo].[BankLoanCollections]  WITH CHECK ADD  CONSTRAINT [FK_BankLoanCollections_SisterConcerns] FOREIGN KEY([ConcernId])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[BankLoanCollections] CHECK CONSTRAINT [FK_BankLoanCollections_SisterConcerns]
GO


-------------Rakib--------------
----------24-09-2023------------
--------------------------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[BankLoanDetails](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[BankLoanId] [int] NOT NULL,
	[Status] [nvarchar](10) NOT NULL,
	[InstallmentDate] [datetime] NOT NULL,
	[OpeningBalance] [decimal](18, 2) NOT NULL,
	[ClosingBalance] [decimal](18, 2) NOT NULL,
	[InstallmentAmount] [decimal](18, 2) NOT NULL,
	[ExpectedInstallmentAmount] [decimal](18, 2) NOT NULL,
	[PenaltyChargeAmount] [decimal](18, 2) NOT NULL,
	[PaymentDate] [datetime] NULL,
	[InterestAmount] [decimal](18, 2) NOT NULL,
	[ScheduleNo] [int] NOT NULL,
	[Remarks] [nvarchar](500) NULL,
	[LastPayAdjustment] [decimal](18, 2) NOT NULL,
	[LoanCollectionId] [int] NULL,
 CONSTRAINT [PK_BankLoanDetails] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[BankLoanDetails]  WITH CHECK ADD  CONSTRAINT [FK_BankLoanDetails_BankLoans] FOREIGN KEY([BankLoanId])
REFERENCES [dbo].[BankLoans] ([Id])
GO

ALTER TABLE [dbo].[BankLoanDetails] CHECK CONSTRAINT [FK_BankLoanDetails_BankLoans]
GO

-------------Rakib--------------
----------24-09-2023------------
--------------------------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[BankLoans](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[Code] [nvarchar](15) NOT NULL,
	[LoanDate] [datetime] NOT NULL,
	[PrincipleLoanAmount] [decimal](18, 2) NOT NULL,
	[InterestPercentage] [decimal](18, 2) NOT NULL,
	[ProcessingFeePercentage] [decimal](18, 2) NOT NULL,
	[TotalLoanAmount] [decimal](18, 2) NOT NULL,
	[NoOfInstallment] [int] NOT NULL,
	[InstallmentSize] [decimal](18, 2) NOT NULL,
	[PenaltyChargePercentage] [decimal](18, 2) NOT NULL,
	[ConcernId] [int] NOT NULL,
	[BankId] [int] NOT NULL,
	[CreatedBy] [int] NOT NULL,
	[CreateDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NULL,
	[ModifiedDate] [datetime] NULL,
	[IsPaid] [bit] NOT NULL,
	[SDPS] [decimal](18, 2) NOT NULL,
	[Savings] [decimal](18, 2) NOT NULL,
 CONSTRAINT [PK_BankLoans] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[BankLoans] ADD  DEFAULT ((0)) FOR [IsPaid]
GO

ALTER TABLE [dbo].[BankLoans] ADD  DEFAULT ((0)) FOR [SDPS]
GO

ALTER TABLE [dbo].[BankLoans] ADD  DEFAULT ((0)) FOR [Savings]
GO

ALTER TABLE [dbo].[BankLoans]  WITH CHECK ADD  CONSTRAINT [FK_BankLoans_Banks] FOREIGN KEY([BankId])
REFERENCES [dbo].[Banks] ([BankID])
GO

ALTER TABLE [dbo].[BankLoans] CHECK CONSTRAINT [FK_BankLoans_Banks]
GO

ALTER TABLE [dbo].[BankLoans]  WITH CHECK ADD  CONSTRAINT [FK_BankLoans_SisterConcerns] FOREIGN KEY([ConcernId])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[BankLoans] CHECK CONSTRAINT [FK_BankLoans_SisterConcerns]
GO

-------------Rakib--------------
----------23-09-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--exec sp_TrialBalance  '01 Dec 2019 12:00:00 AM','31 Dec 2019 11:59:59 PM',1
ALTER PROC [dbo].[sp_TrialBalance]
(
  @FromDate datetime,
  @ToDate datetime,
  @ConcernID int
)
AS
BEGIN
DECLARE @CashInHandNeg decimal(18,2)
DECLARE @CashInHandPos decimal(18,2)

Create table #temp(ID int identity(1,1) not null,Particulars nvarchar(MAX),Debit decimal(18,2),Credit decimal(18,2),SerialNum int)

--****************************************************
--***************Debit Start**************************
--****************************************************

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Cash at Banks', ISNULL(sum(TotalAmount),0.0),0.00,1 from Banks
--where ConcernID=@ConcernID

------------------Investment-----------------------------------------------------
declare @OpeningBalance decimal(18,2)
--set @OpeningBalance = ISNULL((select sum(Amount)from ShareInvestments i
--JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
--JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
--where i.ConcernID=@ConcernID AND ih.Name LIKE 'Opening%' AND (p.Name='Current Asset' OR p.Name='Fixed Asset')),0.00)


-------------------------------------------Cash In Hand--------------------------------------------
Declare @TotalIncome decimal(18,2)

Declare @TotalExpense decimal(18,2)
set @TotalIncome=0
set @TotalExpense=0

----direct expense
--set @TotalExpense =ISNULL((
--select SUM(Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1),0)

----cash delivery
--set @TotalExpense =@TotalExpense+ISNULL((
--select sum(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

----sales return
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4
--),0)

-----cash purchase
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID
--),0)

----cash deposite
--set @TotalExpense =@TotalExpense+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID
--),0)

-------------------Income----------------

----cash collection
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(cc.Amount) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

----installment collections
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(css.InstallmentAmt) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

----direct income
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(ex.Amount) from Expenditures ex
--join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
--where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2
--),0)

----hire sales downpayment
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

----cash sales
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1
--),0)

----cash withdraw from bank
--set @TotalIncome =@TotalIncome+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
--),0)
DECLARE
	@TotalCashInHand DECIMAL(18,2) = 0,
	@CashCount INT = (select COUNT(Amount) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE))

	IF(@CashCount > 0)
	BEGIN
		SET @TotalCashInHand = (select ISNULL(Amount, 0) from dbo.PrevBalances WHERE CAST(Date AS DATE) = CAST(@ToDate AS DATE) AND ConcernID = @ConcernID)
	END

Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in hand',@TotalCashInHand,0.00,1)

-------------------------------------------Cash in the bank--------------------------------------------
set @TotalIncome=0
set @TotalExpense=0
--Deposit
set @TotalIncome= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=1 and bt.ConcernID=@ConcernID),0)
--Collection from Customer
set @TotalIncome=@TotalIncome+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
),0)

--Withdraw
set @TotalExpense= ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=2 and bt.ConcernID=@ConcernID
),0)

--Delivery to suppliers
set @TotalExpense=@TotalExpense+ ISNULL((
select SUM(bt.Amount) From BankTransactions bt
where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
),0)

IF(@TotalIncome-@TotalExpense!=0)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Cash in bank',@TotalIncome-@TotalExpense,0.00,2)

--------------------------------------------Direct Expense-----------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select exi.Description,Amount,0.00,3 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=1

---------------------------------------------Purchase----------------------------------------
DECLARE @CashCollection decimal(18,2)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Purchase',po.GrandTotal,0.00,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID

---------------------------------------Transfer In and Transfer Receivables--------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer In',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4


--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Receivables',(td.Quantity*td.PRate),0.00,4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

----------------------------------------Adjustment------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',cc.AdjustAmt,0.0,8 from CashCollections cc
where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',css.LastPayAdjust,0.0,8 from CreditSales so
join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.LastPayAdjust>0 and css.PaymentStatus='Paid')

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Adjustment',so.AdjAmount,0.0,8 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.AdjAmount>0

------------------------------------------Discount Given---------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Discount Given',so.Discount,0.0,7 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.Discount>0

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Discount Given',so.NetDiscount,0.0,7 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.NetDiscount>0

------------------------------------------Sales Return------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales Return',so.TotalAmount,0.0,7 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4

----------------------------------------------Customer Due---------------------------------
Declare @TotalSaleAmt  decimal(18,2)

--Set @TotalSaleAmt= ISNULL((
--select SUM(so.TotalAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and  so.InvoiceDate<=@ToDate) and so.Status=1),0)

----Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
----select SUM(so.OpeningDue) from Customers so
----where so.ConcernID=@ConcernID and (so.CreatedDate<=@ToDate)),0)

--Set @TotalSaleAmt=@TotalSaleAmt+ ISNULL((
--select SUM(so.NetAmount) from CreditSales so
--where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos = ISNULL((
--select SUM(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.RecAmount) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1 and so.RecAmount>0),0)

--Set @CashInHandPos=@CashInHandPos+  ISNULL((
--select SUM(so.PaymentDue) from SOrders so
--where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=4 and so.PaymentDue>0),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(so.DownPayment) from CreditSales so
--where so.ConcernID=@ConcernID and ( so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1),0)

--set @CashInHandPos =@CashInHandPos+ ISNULL((
--select SUM(css.InstallmentAmt+css.LastPayAdjust) from CreditSales so
--join CreditSalesSchedules css on so.CreditSalesID=css.CreditSalesID
--where so.ConcernID=@ConcernID and (css.PaymentDate>=@FromDate and css.PaymentDate<=@ToDate) and so.IsStatus=1 and (css.InstallmentAmt>0 and css.PaymentStatus='Paid')),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((select SUM(cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and cc.AdjustAmt>0 and (cc.EntryDate>=@FromDate and  cc.EntryDate<=@ToDate) and (cc.TransactionType=1 and cc.CustomerID!=0)),0)

--set @CashInHandPos = @CashInHandPos+ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=3 and bt.CustomerID!=0 and bt.ConcernID=@ConcernID
--),0)
--IF(@TotalSaleAmt-@CashInHandPos!=0)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Customer Due',0,0,7) --amount will come from another sp, follow c# method


----------------------------------------Stock Value Start------------------------------------------
declare @TotalPOAmt decimal(18,2)
declare @TotalPOReturn decimal(18,2)
declare @TotalSales decimal(18,2)
declare @TotalSalesReturn decimal(18,2)

--set  @TotalPOAmt=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0.00)

--set  @TotalPOAmt=@TotalPOAmt+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4),0.00)

--set  @TotalPOReturn=ISNULL((select Sum(pod.Quantity*pod.UnitPrice) From POrders po
--join POrderDetails pod on po.POrderID = pod.POrderID
--where (po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0.00)



--set @TotalSales=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=1),0)

--set  @TotalSales=@TotalSales+ISNULL((select Sum(td.Quantity*td.PRate) From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.TransferDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4),0.00)

--set @TotalSalesReturn=ISNULL((select Sum(st.PRate*sod.Quantity) from SOrders so
--join SOrderDetails sod on so.SOrderID = sod.SOrderID
--join StockDetails st on sod.SDetailID = st.SDetailID
--where so.ConcernID=@ConcernID and (so.InvoiceDate<=@ToDate) and so.Status=4),0)

--Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Stock',(@TotalPOAmt+@TotalSalesReturn-@TotalPOReturn-@TotalSales),0.00,7)

---------------------------------------Stock Value End-------------------------------



--****************************************************
--***************Debit End****************************
--****************************************************



--****************************************************
--***************Credit Start*************************
--****************************************************


-----------------------------------Transfer Out and Transfer Payable---------------------------------------------
--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Out',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.FromConcernID=@ConcernID and t.WFStatus=4

--Insert Into #temp(Particulars,Debit,Credit,SerialNum)
--select 'Transfer Payable',0.00,(td.Quantity*td.PRate),4 From Transfers t
--join TransferDetails td on t.TransferID = td.TransferID
--where (t.ApprovedDate>=@FromDate and t.ApprovedDate<=@ToDate) and t.Status=1 and t.ToConcernID=@ConcernID and t.WFStatus=4

------------------Investment-----------------------------------------------------
declare @Liability decimal(18,2)

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Lia. Receive',0.00,@Liability,3)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash In for Lia. Receive',@Liability,0.00,4)
END

set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Liability' AND i.TransactionType=2 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Liability Pay',@Liability,0.00,5)
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Cash Out for Lia. Pay',-@Liability,0.00,5)
END

---Asset
set @Liability =  ISNULL((select sum(Amount) from ShareInvestments i
JOIN ShareInvestmentHeads ih ON i.SIHID = ih.SIHID
JOIN ShareInvestmentHeads p ON ih.ParentId = p.SIHID
where i.ConcernID=@ConcernID AND p.Name='Current Asset' AND i.TransactionType=1 AND (i.EntryDate>=@FromDate and i.EntryDate<=@ToDate)
),0.00)

if(@Liability!=0)
BEGIN
Insert Into #temp(Particulars,Debit,Credit,SerialNum) values('Current Asset',@Liability,0.00,5)
END
-------------------------------------Direct Income-------------------------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select exi.Description,0.00,ex.Amount,3 from Expenditures ex
join ExpenseItems exi on ex.ExpenseItemID = exi.ExpenseItemID
where ex.ConcernID=@ConcernID and (ex.EntryDate>=@FromDate and ex.EntryDate<=@ToDate) and exi.Status=2

-------------------------------------Retail and hire Sales----------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.GrandTotal,6 from SOrders so
where so.ConcernID=@ConcernID and (so.InvoiceDate>=@FromDate and so.InvoiceDate<=@ToDate) and so.Status=1

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Sales',0.00,so.NetAmount-so.InterestAmount,6 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1

--------------------------------------Purchase Discount------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Discount',0.00,po.NetDiscount,5 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID and po.NetDiscount>0

-----------------------------------------Hire Interest--------------------------
Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Hire Interest',0.00,so.InterestAmount,12 from CreditSales so
where so.ConcernID=@ConcernID and (so.SalesDate>=@FromDate and so.SalesDate<=@ToDate) and so.IsStatus=1 and so.InterestAmount>0


----------------------------------------Supplier Due----------------------------
declare @SupplierDue decimal(18,2)
declare @CashDelivery decimal(18,2)

--set @SupplierDue = ISNULL((
--select Sum(po.TotalAmt) From POrders po
--where po.Status=1 and po.ConcernID=@ConcernID and (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate)),0)

----set @SupplierDue =@SupplierDue+ ISNULL((
----select Sum(po.OpeningDue) From Suppliers po
----where (po.ConcernID=@ConcernID)),0)

--set @CashDelivery =ISNULL((
--select sum(cc.Amount+cc.AdjustAmt) from CashCollections cc
--where cc.ConcernID=@ConcernID and (cc.EntryDate>=@FromDate and cc.EntryDate<=@ToDate) and (cc.TransactionType=2 and cc.SupplierID!=0)),0)

--set @CashDelivery =@CashDelivery+ ISNULL((
--select Sum(po.RecAmt) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=1 and po.ConcernID=@ConcernID),0)

--set @CashDelivery =@CashDelivery+ ISNULL((
--select Sum(po.PaymentDue) From POrders po
--where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID),0)

--set @CashDelivery=@CashDelivery+ ISNULL((
--select SUM(bt.Amount) From BankTransactions bt
--where (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate) and bt.TransactionType=4 and bt.ConcernID=@ConcernID and bt.SupplierID!=0
--),0)

SET @SupplierDue = (SELECT SUM(ISNULL(TotalDue, 0)) FROM dbo.Suppliers)

--IF(@SupplierDue-@CashDelivery!=0)
--	Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue-@CashDelivery,5)
IF(@SupplierDue != 0)
	Insert Into #temp(Particulars,Debit,Credit,SerialNum) values ('Supplier Due',0,@SupplierDue,5)


-----------------------------Purchase Return---------------------------

Insert Into #temp(Particulars,Debit,Credit,SerialNum)
select 'Purchase Return',0.00,po.TotalAmt,4 From POrders po
where (po.OrderDate>=@FromDate and po.OrderDate<=@ToDate) and po.Status=5 and po.ConcernID=@ConcernID

--****************************************************
--***************Credit End***************************
--****************************************************

select SerialNum, Particulars,sum(Debit) 'Debit',sum(Credit) 'Credit' from #temp
group by Particulars,SerialNum
order by SerialNum asc
END


-------------Rakib--------------
----------20-09-2023------------
--------------------------------

ALTER TABLE dbo.SystemInformations
ADD IsCommonBank BIT NOT NULL DEFAULT 0


-------------Nahid--------------
----------21-08-2023------------
--------------------------------

ALTER PROCEDURE [dbo].[AddCreditSalesOrder] (
@CSalesOrder [dbo].[INSERTCREDITSALESORDERTABLE] readonly, 
@CSODetails [INSERTCSODETAILTABLE] readonly,
@CSSchedules [INSERTCSSCHEDULESTABLE] readonly,
@BankTrans [InsertBankTransTable] readonly,
@SorderID int out,
@Result int Out)
AS
DECLARE @CreditSalesId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY  
 BEGIN TRANSACTION 

-----------------Card Payment Bank Deposit--------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @CSalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

------------------Card Payment Bank Deposit--------------

INSERT INTO creditsales (invoiceno, customerid, tsalesamt, noofinstallment,
 intallmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamt, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress)
(SELECT
 invoiceno, customerid, tsalesamt, noofinstallment, 
 installmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamount, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,@BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress FROM @CSalesOrder)

UPDATE customers
SET customers.CreditDue = (customers.CreditDue + s.totaldue)
FROM @CSalesOrder s
INNER JOIN customers ON customers.customerid = s.customerid

SET @CreditSalesId = Scope_identity()

INSERT INTO CreditSaleDetails 
( 
ProductID ,UnitPrice, Quantity, UTAmount, CreditSalesID,  
MPRateTotal, MPRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,Compressor,Motor,
Panel,Spareparts,Service
) 
( 
Select sd.ProductID ,UnitPrice, Quantity, UTAmount, @CreditSalesId CreditSalesID,  
MPRateTotal, MrpRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,p.CompressorWarrentyMonth,p.MotorWarrentyMonth,
p.PanelWarrentyMonth,p.SparePartsWarrentyMonth,p.ServiceWarrentyMonth from @CSODetails sd
join Products p on sd.ProductID=p.ProductID 
where p.ProductType!=2
) 

UPDATE stocks
SET stocks.quantity = (stocks.quantity - s.quantity)
FROM @CSODetails s
INNER JOIN stocks ON stocks.productid = s.productid AND stocks.colorid = s.colorid AND Stocks.GodownID=s.Compressor

UPDATE StockDetails 
SET StockDetails.Status = 2 
from @CSODetails s 
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId 
join Products on StockDetails.ProductID = Products.ProductID 
where Products.ProductType!=2 

--***************FIFO for Nobarcode Product**********************
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @CreditSaleProductsID INT
DECLARE @Quantity INT
DECLARE @SQty INT
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL
FOR
SELECT s.productid, s.colorid, s.quantity, creditsalesdetailsid
-- from   InsertCSODetailTable SOD join CreditSales SO on SO.CreditSalesID=SOD.CreditSalesID where SO.Status=1
FROM @CSODetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.stockdetailid
INNER JOIN products ON stockdetails.productid = products.productid
where Products.ProductType=2 
OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID

WHILE @@FETCH_STATUS = 0
BEGIN
	WHILE @Quantity != 0
	BEGIN
		SET @SDetailID = (
				SELECT Min(sdetailid)
				FROM stockdetails
				WHERE productid = @ProductID AND colorid = @ColorID AND quantity != 0 AND STATUS = 1
				)
		SET @SQty = (
				SELECT quantity
				FROM stockdetails
				WHERE sdetailid = @SDetailID
				)

		IF (@SQty > @Quantity)
		BEGIN
			SET @SQty = @SQty - @Quantity

			UPDATE stockdetails
			SET quantity = @SQty
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service)
			 (SELECT sd.productid, unitprice, @Quantity, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID  =@CreditSaleProductsID
			SET @Quantity = 0
		END
		ELSE IF (@SQty < @Quantity)
		BEGIN
			SET @Quantity = @Quantity - @SQty

			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service) (SELECT sd.productid, unitprice, @SQty, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)
				--update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
		END
		ELSE
		BEGIN
			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (
			productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate,
			 stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service
			 ) 
			 (SELECT 
			  sd.productid, unitprice, @SQty, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate,
			  @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, 
			  p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd 
			  INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID
			  )

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
			SET @Quantity = 0
		END
	END

	FETCH NEXT
	FROM cur
	INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID
END

INSERT INTO creditsalesschedules (monthdate, balance, installmentamt, 
paymentdate, creditsalesid, paymentstatus, interestamount, closingbalance,
 scheduleno, remarks, isunexpected, hirevalue, netvalue)
(SELECT monthdate, balance, installmentamt,
 paymentdate, @CreditSalesId CreditSalesID, paymentstatus, interestamount, closingbalance,
  scheduleno, remarks, isunexpected, hirevalue, netvalue FROM @CSSchedules)

COMMIT
--RETURN 1;
SELECT @SorderID=@CreditSalesId,@Result=1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		--RETURN 0;
	SELECT @SorderID=0,@Result=0
END CATCH

----------------------------------------------------------------------------------------------------------------------------------

ALTER PROCEDURE [dbo].[AddPendingCreditSalesOrder] (
	@CSalesOrder [dbo].[INSERTCREDITSALESORDERTABLE] readonly,
	@CSODetails [INSERTCSODETAILTABLE] readonly,
	@CSSchedules [INSERTCSSCHEDULESTABLE] readonly,
	@SorderID int out,
	@Result int Out
	)
AS
DECLARE @CreditSalesId INT

BEGIN TRY
	BEGIN TRANSACTION

	INSERT INTO creditsales (
		invoiceno,
		customerid,
		tsalesamt,
		noofinstallment,
		intallmentprinciple,
		issuedate,
		username,
		remaining,
		interestrate,
		interestamount,
		salesdate,
		downpayment,
		winterestamt,
		fixedamt,
		isstatus,
		unexinstallment,
		quantity,
		discount,
		netamount,
		isunexpected,
		remarks,
		vatpercentage,
		vatamount,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		installmentperiod,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		IsWeekly
		
		) (
		SELECT invoiceno,
		customerid,
		tsalesamt,
		noofinstallment,
		installmentprinciple,
		issuedate,
		username,
		remaining,
		interestrate,
		interestamount,
		salesdate,
		downpayment,
		winterestamt,
		fixedamount,
		5,---pending status
		unexinstallment,
		quantity,
		discount,
		netamount,
		isunexpected,
		remarks,
		vatpercentage,
		vatamount,
		Status,
		concernid,
		createdby,
		createdate,
		totaloffer,
		installmentperiod,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		IsWeekly
		
		FROM @CSalesOrder
		)

	SET @CreditSalesId = Scope_identity()

	INSERT INTO CreditSaleDetails (
		ProductID,
		UnitPrice,
		Quantity,
		UTAmount,
		CreditSalesID,
		MPRateTotal,
		MPRate,
		StockDetailID,
		PPOffer,
		IntPercentage,
		IntTotalAmt,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service
		
		) (
		SELECT sd.ProductID,
		UnitPrice,
		Quantity,
		UTAmount,
		@CreditSalesId CreditSalesID,
		MPRateTotal,
		MrpRate,
		StockDetailID,
		PPOffer,
		IntPercentage,
		IntTotalAmt,
		p.CompressorWarrentyMonth,
		p.MotorWarrentyMonth,
		p.PanelWarrentyMonth,
		p.SparePartsWarrentyMonth,
		p.ServiceWarrentyMonth
		
		 FROM @CSODetails sd INNER JOIN Products p ON sd.ProductID = p.ProductID 
		--WHERE p.ProductType != 2
		)

	INSERT INTO creditsalesschedules (
		monthdate,
		balance,
		installmentamt,
		paymentdate,
		creditsalesid,
		paymentstatus,
		interestamount,
		closingbalance,
		scheduleno,
		remarks,
		isunexpected,
		hirevalue,
		netvalue
		
		) (
		SELECT monthdate,
		balance,
		installmentamt,
		paymentdate,
		@CreditSalesId CreditSalesID,
		paymentstatus,
		interestamount,
		closingbalance,
		scheduleno,
		remarks,
		isunexpected,
		hirevalue,
		netvalue
		FROM @CSSchedules
		)

	COMMIT

	--RETURN 1;
	SELECT @SorderID=@CreditSalesId,@Result=1

END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	--RETURN 0;
	SELECT @SorderID=0,@Result=0
END CATCH
----------------------------------------------------------------------------------------------------------------------------------

ALTER PROC [dbo].[AddPurchaseOrder] (
	@PurchaseOrder [InsertPurchaseOrderTable] readonly
	,@PODetails [InsertPODetailTable] readonly
	,@POProductDetails [InsertPOProductDetailTable] readonly
	,@Stocks [InsertStockTable] readonly
	,@StockDetails [InsertStockDetailTable] readonly,
	@PorderID int out,
	@Result int Out
	)
AS
DECLARE @PurchaseOrderId INT
DECLARE @GrandTotal DECIMAL(18, 2)
		,@NetDiscount DECIMAL(18, 2)
		,@FlatDis DECIMAL(18, 2)
		,@Adjustment DECIMAL(18, 2)

--***************Product Type*****************
--ExistingBC = 1,
--NoBarcode = 2,
--AutoBC = 3
--***************Product Type*****************

BEGIN TRY
	BEGIN TRANSACTION

	INSERT INTO POrders (
		OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPDisAmt
		,NetDiscount
		,LaborCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks,
		InvoiceNo
		) (
		SELECT OrderDate
		,ChallanNo
		,SupplierID
		,GrandTotal
		,TDiscount
		,TotalAmt
		,AdjAmount
		,RecAmt
		,PaymentDue
		,TotalDue
		,STATUS
		,PPTDisAmt
		,NetDiscount
		,LabourCost
		,ConcernID
		,CreateDate
		,CreatedBy
		,IsDamageOrder
		,Remarks,
		 InvoiceNo
		 FROM @PurchaseOrder
		)

	UPDATE Suppliers
	SET Suppliers.TotalDue = (Suppliers.TotalDue + p.PaymentDue)
	FROM @PurchaseOrder p
	JOIN Suppliers ON Suppliers.SupplierID = p.SupplierId
	WHERE p.IsDamageOrder != 1

	SET @PurchaseOrderId = SCOPE_IDENTITY()
	SET @GrandTotal = ISNULL((
				SELECT GrandTotal
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @NetDiscount = ISNULL((
				SELECT NetDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
	SET @FlatDis = ISNULL((
				SELECT TDiscount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)
    SET @Adjustment = ISNULL((
				SELECT AdjAmount
				FROM POrders
				WHERE POrderID = @PurchaseOrderId
				), 0)

	INSERT INTO PriceProtections (
		ProductID
		,ColorID
		,PrvPrice
		,ChangePrice
		,POrderID
		,ConcernID
		,SupplierID
		,PrvStockQty
		,PChangeDate
		) (
		SELECT stk.ProductId
		,stk.ColorId
		,stk.MRPPrice
		,stkt.MRPPrice
		,@PurchaseOrderId
		,stk.ConcernID
		,(
			SELECT SupplierId
			FROM POrders
			WHERE POrderID = @PurchaseOrderId
			)
		,stk.Quantity
		,GETDATE() FROM @Stocks stkt INNER JOIN Stocks stk ON stk.ProductID = stkt.ProductId
		AND stk.ColorID = stkt.ColorId WHERE stk.MRPPrice > stkt.MRPPrice
		)

	INSERT INTO POrderDetails (
		ProductID
		,ColorID
		,Quantity
		,UnitPrice
		,TAmount
		,PPDISPer
		,PPDISAmt
		,MRPRate
		,POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOFFER
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownID
		) (
		SELECT ProductId
		,ColorId
		,Quantity
		,UnitPrice
		,TAmount
		,PPDisPer
		,PPDisAmt
		,MrpRate
		,@PurchaseOrderId POrderID
		,SalesRate
		,ExtraPPDISPer
		,ExtraPPDISAmt
		,PPOffer
		,CreditSalesRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,GodownId FROM @PODetails
		)

	INSERT INTO POProductDetails (
		ProductID
		,ColorID
		,IMENO
		,POrderDetailID
		,DamagePOPDID
		) (
		SELECT POPD.ProductId
		,POPD.ColorId
		,POPD.IMENo
		,POD.POrderDetailID
		,DamagePOPDID FROM @POProductDetails POPD INNER JOIN POrderDetails POD ON POD.ProductID = POPD.ProductId
		AND POD.ColorID = POPD.ColorId
		AND POD.POrderID = @PurchaseOrderId
		)

	UPDATE POProductDetails
	SET IsDamageReplaced = 1
	FROM @POProductDetails dtPOPD
	JOIN POProductDetails POPD ON dtPOPD.DamagePOPDID = POPD.POPDID

	UPDATE Stocks
	SET Stocks.Quantity = (Stocks.Quantity + s.Quantity)
		,Stocks.MRPPrice = s.MRPPrice
		,LPPrice = s.LPPrice
		,ModifiedBy = s.CreatedBy
		,ModifiedDate = s.CreateDate
	FROM @Stocks s
	JOIN Stocks ON Stocks.StockID = s.StockID

	INSERT INTO Stocks (
		StockCode
		,EntryDate
		,Quantity
		,ProductID
		,ColorID
		,MRPPrice
		,LPPrice
		,ConcernID
		,CreatedBy
		,CreateDate
		,GodownID
		) (
		SELECT StockCode
		,EntryDate
		,Quantity
		,ProductId
		,ColorId
		,MRPPrice
		,LPPrice
		,ConcernId
		,CreatedBy
		,CreateDate
		,GodownId FROM @Stocks WHERE StockId IS NULL
		)

	--************For Nobarcode*****************
	INSERT INTO StockDetails (
		StockID
		,StockCode
		,ProductID
		,ColorID
		,POrderDetailID
		,IMENO
		,STATUS
		,PRate
		,SRate
		,CreditSRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,Quantity
		,GodownID
		) (
		SELECT stk.StockID
		,stkd.StockCode
		,stkd.ProductId
		,stkd.ColorId
		,POD.POrderDetailID
		,stkd.IMENo
		,stkd.STATUS
		,(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment))))
		,stkd.SalesRate
		,stkd.CreditSRate
		,POD.CRSalesRate12Month
		,POD.CRSalesRate3Month
		,POD.Quantity
		,stkd.GodownId FROM @StockDetails stkd INNER JOIN Stocks stk ON stk.ProductID = stkd.ProductId
		AND stk.ColorID = stkd.ColorID
		AND stk.GodownID = stkd.GodownId INNER JOIN POrderDetails POD ON POD.ProductID = stkd.ProductId
		AND POD.ColorID = stkd.ColorId
		AND POD.GodownID = stkd.GodownID
		AND POD.POrderID = @PurchaseOrderId INNER JOIN Products P ON P.ProductID = stk.ProductID WHERE P.ProductType = 2
		)

	--************For Nobarcode*****************
	--************For barcode*******************
	INSERT INTO StockDetails (
		StockID
		,StockCode
		,ProductID
		,ColorID
		,POrderDetailID
		,IMENO
		,STATUS
		,PRate
		,SRate
		,CreditSRate
		,CRSalesRate12Month
		,CRSalesRate3Month
		,Quantity
		,GodownID
		) (
		SELECT stk.StockID
		,stkd.StockCode
		,stkd.ProductId
		,stkd.ColorId
		,POD.POrderDetailID
		,stkd.IMENo
		,stkd.STATUS
		,(POD.UnitPrice-(((@FlatDis+@Adjustment)*POD.UnitPrice)/(@GrandTotal-@NetDiscount+(@FlatDis+@Adjustment))))
		,stkd.SalesRate
		,stkd.CreditSRate
		,POD.CRSalesRate12Month
		,POD.CRSalesRate3Month
		,0
		,stkd.GodownId FROM @StockDetails stkd INNER JOIN Stocks stk ON stk.ProductID = stkd.ProductId
		AND stk.ColorID = stkd.ColorID
		AND stk.GodownID = stkd.GodownId INNER JOIN POrderDetails POD ON POD.ProductID = stkd.ProductId
		AND POD.ColorID = stkd.ColorId
		AND POD.GodownID = stkd.GodownId
		AND POD.POrderID = @PurchaseOrderId INNER JOIN Products P ON P.ProductID = stk.ProductID WHERE P.ProductType != 2
		)

	--************For barcode*******************
	COMMIT
	SELECT @PorderID=@PurchaseOrderId,@Result=1;
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		ROLLBACK

	SELECT @PorderID=0,@Result=0
	--RETURN 0;
END CATCH

-------------Nahid--------------
----------20-08-2023------------
--------------------------------

CREATE TABLE [dbo].[SessionMasters](
	[SessionID] [int] IDENTITY(1,1) NOT NULL,
	[UserID] [int] NOT NULL,
	[ConcernID] [int] NOT NULL,
	[SessionStartDT] [datetime] NOT NULL,
	[SessionEndDT] [datetime] NULL,
	[IPAddress] [nvarchar](max) NULL,
 CONSTRAINT [PK_SessionMasters] PRIMARY KEY CLUSTERED 
(
	[SessionID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

ALTER TABLE [dbo].[SessionMasters]  WITH CHECK ADD  CONSTRAINT [FK_SessionMasters_SisterConcerns] FOREIGN KEY([ConcernID])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[SessionMasters] CHECK CONSTRAINT [FK_SessionMasters_SisterConcerns]
GO

ALTER TABLE [dbo].[SessionMasters]  WITH CHECK ADD  CONSTRAINT [FK_SessionMasters_Users] FOREIGN KEY([UserID])
REFERENCES [dbo].[Users] ([Id])
GO

ALTER TABLE [dbo].[SessionMasters] CHECK CONSTRAINT [FK_SessionMasters_Users]
GO

---------------------------------------------------------------------------------------------------------------------

CREATE TABLE [dbo].[UserAuditDetails](
	[AuditID] [int] IDENTITY(1,1) NOT NULL,
	[SessionID] [int] NOT NULL,
	[ConcernID] [int] NOT NULL,
	[ObjectID] [int] NOT NULL,
	[ObjectType] [int] NOT NULL,
	[ActionPerformedRole] [int] NOT NULL,
	[ActivityDtTime] [datetime] NOT NULL,
	[ActivityURL] [nvarchar](max) NULL,
	[ActionType] [int] NOT NULL,
 CONSTRAINT [PK_UserAuditDetails] PRIMARY KEY CLUSTERED 
(
	[AuditID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

ALTER TABLE [dbo].[UserAuditDetails]  WITH CHECK ADD  CONSTRAINT [FK_UserAuditDetails_SessionMasters] FOREIGN KEY([SessionID])
REFERENCES [dbo].[SessionMasters] ([SessionID])
GO

ALTER TABLE [dbo].[UserAuditDetails] CHECK CONSTRAINT [FK_UserAuditDetails_SessionMasters]
GO

ALTER TABLE [dbo].[UserAuditDetails]  WITH CHECK ADD  CONSTRAINT [FK_UserAuditDetails_SisterConcerns] FOREIGN KEY([ConcernID])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[UserAuditDetails] CHECK CONSTRAINT [FK_UserAuditDetails_SisterConcerns]
GO



---------------------------------------------------------------------------------------------------------------------

ALTER PROCEDURE [dbo].[AddSalesOrder] (
	@SalesOrder [INSERTSALESORDERTABLE] readonly,
	@SODetails [INSERTSODETAILTABLE] readonly,
	@RemindDate DATE,
	@BankTrans [InsertBankTransTable] readonly,
	@SorderID int out,
	@Result int Out
	)
AS
DECLARE @SalesOrderId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY
	BEGIN TRANSACTION

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @SalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	INSERT INTO sorders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID,
		TSQty,
		PrevDue FROM @SalesOrder
		)

	SET @SalesOrderId = Scope_identity()

	INSERT INTO SOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.TAmount,
		SOD.PPDisPer,
		SOD.PPDisAmt,
		SOD.MrpRate,
		@SalesOrderId SOrderID,
		SOD.StockDetailId,
		SOD.PPOffer,
		(SOD.UnitPrice - SOD.PPDisAmt),
		STD.PRate,
		p.CompressorWarrentyMonth,
		p.PanelWarrentyMonth,
		p.MotorWarrentyMonth,
		p.SparePartsWarrentyMonth,
		p.ServiceWarrentyMonth FROM @SODetails SOD INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailId INNER JOIN Products p
		ON STD.ProductID = p.ProductID WHERE P.ProductType = 1 OR p.ProductType = 3
		)

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue),
		reminddate = @RemindDate
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NOT NULL

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue)
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NULL

	--Stock Update 
	CREATE TABLE #tmpStock (
		ProductID INT,
		ColorID INT,
		GodownID INT,
		Qty DECIMAL(18, 2)
		)

	INSERT INTO #tmpStock (
		ProductID,
		ColorID,
		GodownID,
		Qty
		) (
		SELECT s.ProductID,
		s.ColorID,
		s.Compressor,
		SUM(s.Quantity) FROM @SODetails s 
		GROUP BY s.ProductId,
		s.ColorId,
		s.Compressor
		)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st
		ON st.ProductID = sod.ProductID AND st.ColorID = sod.ColorID AND st.GodownID = sod.GodownID

	--For barCode Product 
	UPDATE stockdetails
	SET stockdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN stockdetails
		ON stockdetails.sdetailid = s.stockdetailid
	INNER JOIN products
		ON stockdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	--*****************FIFO for Nobarcode************************** 
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @GodownID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity INT
	DECLARE @SQty INT
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.productid,
		colorid,
		s.Compressor,
		quantity,
		sorderdetailid
	FROM @SODetails s
	INNER JOIN products
		ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity != 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)

			IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity

				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.Compressor=@GodownID AND SOD.colorid = @ColorID
					)

				SET @Quantity = 0
			END
			ELSE IF (@SQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @SQty

				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@SQty,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @SQty),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

	--For barCode Product SRVisit Status update 
	UPDATE srvproductdetails
	SET srvproductdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN srvproductdetails
		ON srvproductdetails.sdetailid = s.stockdetailid AND srvproductdetails.STATUS = 1
	INNER JOIN products
		ON srvproductdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	COMMIT

	SELECT @SorderID=@SalesOrderId,@Result=1;
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	SELECT @SorderID=0,@Result=0
END CATCH
---------------------------------------------------------------------------------------------------------------------

ALTER PROCEDURE [dbo].[AddPendingSalesOrder] (
	@SalesOrder [INSERTSALESORDERTABLE] readonly,
	@SODetails [INSERTSODETAILTABLE] readonly,
	@RemindDate DATE,
	@SorderID int out,
	@Result int Out
	
	)
AS
DECLARE @SalesOrderId INT


BEGIN TRY
	BEGIN TRANSACTION

	
	INSERT INTO sorders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		TSQty
		
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		5, --for pending status
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		TSQty
		 FROM @SalesOrder
		)

	SET @SalesOrderId = Scope_identity()

	INSERT INTO SOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.TAmount,
		SOD.PPDisPer,
		SOD.PPDisAmt,
		SOD.MrpRate,
		@SalesOrderId SOrderID,
		SOD.StockDetailId,
		SOD.PPOffer,
		(SOD.UnitPrice - SOD.PPDisAmt),
		STD.PRate,
		p.CompressorWarrentyMonth,
		p.PanelWarrentyMonth,
		p.MotorWarrentyMonth,
		p.SparePartsWarrentyMonth,
		p.ServiceWarrentyMonth FROM @SODetails SOD INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailId INNER JOIN Products p
		ON STD.ProductID = p.ProductID )--WHERE P.ProductType = 1 OR p.ProductType = 3
		

	

	

COMMIT
	SELECT @SorderID=@SalesOrderId,@Result=1
	--RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	DECLARE @CreatedBy INT
	DECLARE @CreatedDate DATETIME

	SELECT @CreatedBy = CreatedBy,
		@CreatedDate = CreateDate
	FROM @SalesOrder

	INSERT INTO Errors (
		Message,
		StackTrace,
		CreatedBy,
		CreateDate
		)
	VALUES (
		ERROR_MESSAGE(),
		ERROR_PROCEDURE() + ':' + CONVERT(VARCHAR(10), ERROR_LINE()) + '-' + ERROR_MESSAGE(),
		@CreatedBy,
		@CreatedDate
		)

	
	SELECT @SorderID=0,@Result=0
	--RETURN 0;

END CATCH

---------------------------------------------------------------------------------------------------------------------
-------------Nahid--------------
----------02-09-2023------------
--------------------------------

ALTER TABLE dbo.SystemInformations ADD
	IsEditApprovalSystemEnable int NOT NULL CONSTRAINT DF_SystemInformations_IsEditApprovalSystemEnable DEFAULT ((0))
GO

---------------------------------------------------------------------------------------------------------------------------------

ALTER TABLE dbo.SOrders ADD
	IsEditApprovalStatus int NOT NULL CONSTRAINT DF_SOrders_IsEditApprovalStatus DEFAULT ((2))
GO

-------------Nahid--------------
----------08-08-2023------------
--------------------------------

ALTER PROCEDURE [dbo].[sp_ProductWiseBenefitReport] (
	@Fromdate DATETIME,
	@ToDate DATETIME,
	@ConcernID INT
	)
AS
WITH Final_table
AS (
	SELECT P.Code,
		P.ProductID,
		P.ProductName,
		SO.InvoiceDate AS 'SalesDate',
		C.Description AS 'CategoryName',
		STD.IMENO,
		(((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity AS 'SalesTotal',
		(SOD.PPDAmount + (((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity AS 'Discount',
		(SOD.PRate * SOD.Quantity) AS 'PurchaseTotal',
		((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity) - (SOD.PRate* SOD.Quantity) AS 'CommisionProfit',
		0.00 AS 'HireProfit',
		0.00 AS 'HireCollection',
		((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity) - (SOD.PRate * SOD.Quantity) AS 'TotalProfit'
	FROM SOrderDetails SOD
	INNER JOIN SOrders SO ON SOD.SOrderID = SO.SOrderID
	INNER JOIN StockDetails STD ON STD.SDetailID = SOD.SDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE SO.STATUS = 1 AND SO.InvoiceDate >= @Fromdate AND SO.InvoiceDate <= @ToDate AND SO.ConcernID = @ConcernID
	
	UNION ALL
	
	SELECT P.Code,
		P.ProductID,
		P.ProductName,
		SO.ReturnDate AS 'SalesDate',
		C.Description AS 'CategoryName',
		STD.IMENO,
		(SOD.UnitPrice* SOD.Quantity) * (-1) AS 'SalesTotal',
		0 AS 'Discount',
		(STD.PRate * SOD.Quantity) * ( -1) AS 'PurchaseTotal',
		((SOD.UnitPrice* SOD.Quantity) - (STD.PRate*SOD.Quantity ))* -1 AS 'CommisionProfit',
		0.00 AS 'HireProfit',
		0.00 AS 'HireCollection',
		((SOD.UnitPrice* SOD.Quantity) - (STD.PRate*SOD.Quantity ))* -1 AS 'TotalProfit'
	FROM ROrderDetails SOD
	INNER JOIN ROrders SO ON SOD.ROrderID = SO.ROrderID
	INNER JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE SO.ReturnDate >= @Fromdate AND SO.ReturnDate <= @ToDate AND SO.ConcernID = @ConcernID
	
	UNION ALL
	
	SELECT p.Code,
		P.ProductID,
		P.ProductName,
		CS.SalesDate AS 'SalesDate',
		C.Description AS 'CategoryName',
		STD.IMENO,
		(((CSP.UnitPrice+CSP.IntTotalAmt)-((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt)) * CSP.Quantity) AS 'SalesTotal',
		((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt) * CSP.Quantity AS 'Discount',
		STD.PRate * CSP.Quantity AS 'PurchaseTotal',
		(((CSP.UnitPrice)-((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt)) * CSP.Quantity) - (STD.PRate * CSP.Quantity) AS 'CommisionProfit',
		(CSP.IntTotalAmt * CSP.Quantity) AS 'HireProfit',
		0 AS 'HireCollection',
		0 AS 'TotalProfit'
	FROM CreditSaleDetails CSP
	INNER JOIN CreditSales CS ON CS.CreditSalesID = CSP.CreditSalesID
	INNER JOIN StockDetails STD ON STD.SDetailID = CSP.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.IsStatus=1
	
	UNION ALL
	
	SELECT P.Code,
		P.ProductID,
		P.ProductName,
		CS.SalesDate AS 'SalesDate',
		C.Description AS 'CategoryName',
		Std.IMENO,
		0 AS 'SalesTotal',
		0 AS 'Discount',
		0 AS 'PurchaseTotal',
		0 AS 'CommisionProfit',
		0 AS 'HireProfit',
		SUM(HireValue) AS 'HireCollection',
		SUM(HireValue) AS 'TotalProfit'
	FROM CreditSales CS
	INNER JOIN CreditSaleDetails CSP ON CSP.CreditSalesID = CS.CreditSalesID
	INNER JOIN CreditSalesSchedules CSD ON CSD.CreditSalesID = CS.CreditSalesID
	INNER JOIN StockDetails STD ON STD.SDetailID = CSP.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID AND CS.IsStatus=1
	GROUP BY P.Code,
		P.ProductID,
		P.ProductName,
		CS.SalesDate,
		C.Description,
		Std.IMENO
	)
SELECT Code,
	ProductID,
	ProductName,
	SalesDate,
	CategoryName,
	IMENO,
	sum(SalesTotal + Discount) AS 'SalesTotal',
	sum(Discount) AS 'Discount',
	sum(SalesTotal) AS 'NetSales',
	sum(PurchaseTotal) AS 'PurchaseTotal',
	sum(CommisionProfit) AS 'CommisionProfit',
	sum(HireProfit) AS 'HireProfit',
	sum(HireCollection) AS 'HireCollection',
	sum(CommisionProfit) + sum(HireCollection) AS 'TotalProfit'
FROM Final_table
GROUP BY Code,
	ProductID,
	ProductName,
	SalesDate,
	CategoryName,
	IMENO

-------------Nahid--------------
----------05-07-2023------------
--------------------------------

ALTER PROC [dbo].[GetCategorywiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0) - ISNULL(piv.SalesReturn, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0) + ISNULL(piv.CashCollectionDebitAdj, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) - ISNULL(piv.SalesReturn, 0)) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.CashCollectionCreditAdj, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue',
		ISNULL(piv.InterestAmount, 0) as TInterestAmount,
		ISNULL(piv.CrInterestAmount, 0) as CrInterestAmount



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL



	--start here 



	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionDebitAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(6) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionCreditAdj' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(7) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 



	 AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, SalesReturn, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn,CashCollectionDebitAdj, CashCollectionCreditAdj, InterestAmount, CrInterestAmount

		)
	) piv
 END


 --EXEC GetCategorywiseCustomerDue 0, 16


-----------------------------------------------------------------------------------------------------------------------------------------


ALTER PROC [dbo].[AddHireSalesReturn]
(
	@CustomerDue [InsertHireSaleReturnCustomerDueable] readonly,
	@CreditDetails [CreditDetailsTable] readonly,
	@SalePrice decimal(18,2),
	@PurchasePrice decimal(18,2)

)
  
AS 

 BEGIN TRY  
 BEGIN TRANSACTION 

 DECLARE @CRSalesId INT
 DECLARE @StockID INT

 SET @CRSalesId = (SELECT TOP(1) CreditSalesId FROM @CustomerDue)

INSERT INTO dbo.HireSalesReturnCustomerDueAdjustment
(
AdjDue, TotalRemainingDue, TransactionDate, CreditSalesId, CustomerId,ConcernID, ToCustomerPayAmt, Remarks, MemoNo
)
(
Select AdjDue, TotalRemainingDue, TransactionDate, CreditSalesId, CustomerId, ConcernID, ToCustomerPayAmt, Remarks, MemoNo from @CustomerDue)

UPDATE dbo.Customers SET CreditDue = CreditDue - (SELECT TOP(1) AdjDue FROM @CustomerDue) WHERE CustomerID = (SELECT TOP(1) CustomerID FROM @CustomerDue)


UPDATE dbo.CreditSales SET IsReturn = 1, ReturnDate = (SELECT TOP(1) TransactionDate FROM @CustomerDue) 
WHERE CreditSalesID = @CRSalesId

UPDATE cd SET cd.IsProductReturn = 1
FROM CreditSaleDetails cd
JOIN @CreditDetails cdt ON cd.CreditSaleDetailsID = cdt.CreditSaleDetailsId

WHERE cd.CreditSalesID = @CRSalesId


UPDATE sd
SET sd.UsedStockStatus = 1, sd.SRate = cdt.SalePrice, sd.PRate = cdt.PurchasePrice, sd.Status = 1
FROM StockDetails sd
JOIN CreditSaleDetails cd ON sd.SDetailID = cd.StockDetailID
JOIN @CreditDetails cdt ON cd.CreditSaleDetailsID = cdt.CreditSaleDetailsId
WHERE cd.CreditSalesID = @CRSalesId
--WHERE SDetailID = (SELECT TOP(1) StockDetailID FROM dbo.CreditSaleDetails WHERE CreditSalesID = @CRSalesId)

------------------------------------------------Changes -NE- ----------------------------------------------------------

--SET @StockID = (
--SELECT min(StockID)
--FROM StockDetails
--WHERE SDetailID = (SELECT TOP(1) StockDetailID FROM dbo.CreditSaleDetails WHERE CreditSalesID = @CRSalesId)
--)

--UPDATE Stocks
--SET Quantity = Quantity + 1
--WHERE StockID = @StockID

UPDATE st SET st.Quantity = st.Quantity + 1
FROM Stocks st
JOIN StockDetails sd ON st.StockID = sd.StockID
JOIN CreditSaleDetails cd ON sd.SDetailID = cd.StockDetailID
JOIN @CreditDetails cdt ON cd.CreditSaleDetailsID = cdt.CreditSaleDetailsId
WHERE cd.CreditSalesID = @CRSalesId

----------------------------------------------------------------------------------------------------------------


COMMIT

RETURN 1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		RETURN 0;
END CATCH

-------------Nahid--------------
----------26-06-2023------------
--------------------------------

ALTER PROC [dbo].[UpdateTotalDueWhenEditNew]
(
	@CusId int,
	@SupId int,
	@CashCollectionID int,
	@NewCollectionAmount DECIMAL(18,2)
)
  
AS 
Declare @Amount decimal
Declare @PreviousCustomerID int,
		@TransactionType INT

BEGIN TRY
BEGIN TRANSACTION

IF(@CusId>0)
BEGIN
    Select @Amount=(Amount+AdjustAmt) from CashCollections where CashCollectionID=@CashCollectionID
	Select @PreviousCustomerID=CustomerID from CashCollections where CashCollectionID=@CashCollectionID
	SELECT @TransactionType = TransactionType from CashCollections where CashCollectionID=@CashCollectionID

	IF @TransactionType = 3 
	BEGIN
		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue - @Amount)
		where CustomerID=@PreviousCustomerID



		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + @NewCollectionAmount)
		where CustomerID=@CusId
	END
	IF @TransactionType = 6
	BEGIN
		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue - @Amount)
		where CustomerID=@PreviousCustomerID



		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + @NewCollectionAmount)
		where CustomerID=@CusId
	END
	ELSE
	BEGIN
		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + @Amount)
		where CustomerID=@PreviousCustomerID

		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue - @NewCollectionAmount)
		where CustomerID=@CusId
	END

	
END
ELSE IF(@SupId>0)
BEGIN
    Select @Amount=(Amount+AdjustAmt) from CashCollections where CashCollectionID=@CashCollectionID
    Select @PreviousCustomerID=SupplierID from CashCollections where CashCollectionID=@CashCollectionID

	UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue + @Amount)
	where SupplierID=@PreviousCustomerID

	UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - @NewCollectionAmount)
	where SupplierID=@SupId
END

COMMIT

RETURN 1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		RETURN 0;
END CATCH

---------------------------------------------------------------------------------------------------------------------------------------

--EXEC sp_DailyCashInHand  '11 MAY 2021 12:00:00 AM','11 MAY 2021 11:59:59 PM',16
ALTER procedure [dbo].[sp_DailyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-08-01'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)



create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(DAY, 1, Convert(date, GetDate()))
begin
	print @StartDate

	delete
	from #temp_Data1

	delete
	from #temp_Data2

	--	DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
	--	DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
	------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
	insert into #temp_Data1
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
				and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
		from POrders po
		join Suppliers s on po.SupplierID = s.SupplierID
		where po.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
		and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and po.RecAmt>0
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
	---------------------------------Expense from Bank Deposit--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

	END
	---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank collections', @total, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	inner join Customers c on BT.CustomerID = c.CustomerID
	where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
	group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	insert into #temp_Data1
	select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
	---------------------------------Expens from Bank Cash Delivery---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Cash Delivery', @total, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END

---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Income', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Income (Cr))', sum(Amount), 'Bank Income ', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Income ', @total, '', 0, 'Header'
END


	---------------------------------Expense from Fund Out---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections cc
				join Suppliers s on cc.SupplierID = s.SupplierID
				where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
				and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
		and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
	------------------------------------------------------Expense in Product return----------------------------------
	set @total = isnull((
				select sum(PaidAmount)
				from ROrders
				where ConcernID = @ConcernID and DAY(Convert(date, ReturnDate)) = DAY(@StartDate) and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

END

	-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Cash Collection Return', @total, 'Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

	------------- -------------------------------------------- Direct Expense--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' and EX.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' and EX.CashInHandReportStatus = 0
		and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description

		insert into #temp_Data1
		select @StartDate,'Total Expense', @total, '', 0, 'Header'
	end

		--------------- -------------------------------------------- From Hire Sales Return Order-------------------------------------------------------------
	set @total = isnull((
				select sum(ToCustomerPayAmt)
				from HireSalesReturnCustomerDueAdjustment
				where ConcernID = @ConcernID  and DAY(Convert(date, TransactionDate)) = DAY(@StartDate)
				and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Hire Sale Return Pay', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, cus.Name, sum(csr.ToCustomerPayAmt), 'Hire Sale Return Pay', 0, 'Order'
		from HireSalesReturnCustomerDueAdjustment csr
		join Customers cus on csr.CustomerId = cus.CustomerID
		where csr.ConcernID = @ConcernID and DAY(Convert(date, TransactionDate)) = DAY(@StartDate)
		and Month(Convert(date, TransactionDate)) = Month(@StartDate) and Year(Convert(date, TransactionDate)) = Year(@StartDate) and csr.ToCustomerPayAmt>0
		group by cus.CustomerID,cus.Name

		insert into #temp_Data1
		select @StartDate, 'Total Hire Sale Return Pay', @total, '', 0, 'Header'

END 
	------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
						where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end



	-- ----------------------------Expens from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=3  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
END

	----------------------------------------------Opening Cash In Hand in Income Table--------------------------------------------------------------- 
	insert into #temp_Data2
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	-----------------------------------------------Income in Sales Order-------------------------------------------
	set @total = isnull((
				select sum(RecAmount)
				from SOrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount,Convert(varchar(10),c.CustomerType)+'Order' from SOrders so
		join Customers c on so.CustomerID = c.CustomerID
		where so.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
	    insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
   
   END
	---------------------------------Income from Bank Withdwal--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

				---------------------------------Income from Bank Expens as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Expens as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Bank Expens(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName


	---------------------------------Income from Bank Cash Collection---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
		('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on bt.CustomerID=c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	----------------------------------------Income from Fund IN------------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.AnotherBankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.AnotherBankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-- ---------------------------------------Income from Cash Collection from Customer-------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
				), 0)

	if (@total != 0)
	BEGIN
	insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, Convert(varchar(10),c.CustomerType)+'Cash'
		from CashCollections cc
		join Customers c on cc.CustomerID = c.CustomerID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
	    insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')
		
		END
	-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
	set @total = isnull((
				select isnull(sum(DownPayment), 0)
				from CreditSales
				where ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
		from CreditSales cs
		join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')
	
	END
	--------------------------------------Income in Purchase Product return----------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and DAY(Convert(date, OrderDate)) = DAY(@StartDate) and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and status = 5
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Purchase Return Cash'

	-------------------------------Income Installment Collection from Creditsales------------------
	set @total = isnull((
				select sum(InstallmentAmt)
				from CreditSalesSchedules css
				inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
				where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
		from CreditSalesSchedules css
		inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
		inner join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
	  
	  insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')
	
	END
	-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Description, sum(Amount), E.Description
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 2 and  EX.CashInHandReportStatus = 0 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')
	
	end

	-- ----------------------------Income from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
	END

	   SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)
	IF (@total != 0)
	BEGIN
		INSERT INTO #temp_Data2
		SELECT @StartDate, '', 0.00,SIH.Name+'(Current Asset)',  sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name

		insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')
	END

	insert into #temp_Data3
	select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), '', 0.00,  ''
	from #temp_Data1 T1
	UNION ALL
	select @StartDate, 0,  '', 0, isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
	from #temp_Data2 T2

	declare @a decimal(18, 2)
	declare @b decimal(18, 2)
	declare @ExpenseWithinDate decimal(18, 2)
	declare @IncomeWithinDate decimal(18, 2)
	declare @CashInHandWithinDate decimal(18, 2)

	set @a = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @b = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @ExpenseWithinDate = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @IncomeWithinDate = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
	set @CashInHand = @CashInHand + (@b - @a)

	insert into #temp_Data3
	values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

	insert into #temp_Data3
	values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

	insert into #temp_Data3
	values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

	set @StartDate = DATEADD(DAY, 1, @StartDate)
	--select *From #temp_Data1
	--select *From #temp_Data2
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)


-------------Nahid--------------
----------25-06-2023------------
--------------------------------
CREATE TABLE [dbo].[HireSalesReturnCustomerDueAdjustment](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[AdjDue] [decimal](18, 2) NOT NULL,
	[TotalRemainingDue] [decimal](18, 2) NOT NULL,
	[TransactionDate] [datetime] NOT NULL,
	[CreditSalesId] [int] NOT NULL,
	[CustomerId] [int] NOT NULL,
	[ConcernId] [int] NOT NULL,
	[ToCustomerPayAmt] [decimal](18, 2) NOT NULL,
	[Remarks] [nvarchar](max) NULL,
	[MemoNo] [nvarchar](max) NULL,
 CONSTRAINT [PK_HireSalesReturnCustomerDueAdjustment] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

ALTER TABLE [dbo].[HireSalesReturnCustomerDueAdjustment] ADD  CONSTRAINT [DF_HireSalesReturnCustomerDueAdjustment_ToCustomerPayAmt]  DEFAULT ((0)) FOR [ToCustomerPayAmt]
GO

ALTER TABLE [dbo].[HireSalesReturnCustomerDueAdjustment]  WITH CHECK ADD  CONSTRAINT [FK_HireSalesReturnCustomerDueAdjustment_CreditSales] FOREIGN KEY([CreditSalesId])
REFERENCES [dbo].[CreditSales] ([CreditSalesID])
GO

ALTER TABLE [dbo].[HireSalesReturnCustomerDueAdjustment] CHECK CONSTRAINT [FK_HireSalesReturnCustomerDueAdjustment_CreditSales]
GO

ALTER TABLE [dbo].[HireSalesReturnCustomerDueAdjustment]  WITH CHECK ADD  CONSTRAINT [FK_HireSalesReturnCustomerDueAdjustment_Customers] FOREIGN KEY([CustomerId])
REFERENCES [dbo].[Customers] ([CustomerID])
GO

ALTER TABLE [dbo].[HireSalesReturnCustomerDueAdjustment] CHECK CONSTRAINT [FK_HireSalesReturnCustomerDueAdjustment_Customers]
GO

ALTER TABLE [dbo].[HireSalesReturnCustomerDueAdjustment]  WITH CHECK ADD  CONSTRAINT [FK_HireSalesReturnCustomerDueAdjustment_SisterConcerns] FOREIGN KEY([ConcernId])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[HireSalesReturnCustomerDueAdjustment] CHECK CONSTRAINT [FK_HireSalesReturnCustomerDueAdjustment_SisterConcerns]
GO

----------------------------------------------------------------------------------------------------------------------------------

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.StockDetails ADD
	UsedStockStatus int NOT NULL CONSTRAINT DF_StockDetails_UsedStockStatus DEFAULT ((2)),
	UsedSaleRate int NOT NULL CONSTRAINT DF_StockDetails_UsedSaleRate DEFAULT ((0)),
	UsedPurchaseRate int NOT NULL CONSTRAINT DF_StockDetails_UsedPurchaseRate DEFAULT ((0))
GO
ALTER TABLE dbo.StockDetails SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
----------------------------------------------------------------------------------------------------------------------------------

CREATE TYPE [dbo].[InsertHireSaleReturnCustomerDueable] AS TABLE(
	[AdjDue] [decimal](18, 2) NULL,
	[TotalRemainingDue] [decimal](18, 2) NULL,
	[TransactionDate] [datetime] NULL,
	[CreditSalesId] [int] NULL,
	[CustomerId] [int] NULL,
	[ConcernId] [int] NULL,
	[ToCustomerPayAmt] [decimal](18, 2) NULL,
	[Remarks] [varchar](max) NULL,
	[MemoNo] [varchar](max) NULL
)
GO
------------------------------------------------------------------------------------------------------------
CREATE TYPE [dbo].[CreditDetailsTable] AS TABLE(
	[CreditSaleDetailsId] [int] NULL,
	[SalePrice] [decimal](18, 2) NULL,
	[PurchasePrice] [decimal](18, 2) NULL,
	[CreditSalesId] [int] NULL
)
GO
-----------------------------------------------------------------------------------------------------------

Create PROC [dbo].[AddHireSalesReturn]
(
	@CustomerDue [InsertHireSaleReturnCustomerDueable] readonly,
	@CreditDetails [CreditDetailsTable] readonly,
	@SalePrice decimal(18,2),
	@PurchasePrice decimal(18,2)

)
  
AS 

 BEGIN TRY  
 BEGIN TRANSACTION 

 DECLARE @CRSalesId INT
 DECLARE @StockID INT

 SET @CRSalesId = (SELECT TOP(1) CreditSalesId FROM @CustomerDue)

INSERT INTO dbo.HireSalesReturnCustomerDueAdjustment
(
AdjDue, TotalRemainingDue, TransactionDate, CreditSalesId, CustomerId,ConcernID, ToCustomerPayAmt, Remarks, MemoNo
)
(
Select AdjDue, TotalRemainingDue, TransactionDate, CreditSalesId, CustomerId, ConcernID, ToCustomerPayAmt, Remarks, MemoNo from @CustomerDue)

UPDATE dbo.Customers SET CreditDue = CreditDue - (SELECT TOP(1) AdjDue FROM @CustomerDue) WHERE CustomerID = (SELECT TOP(1) CustomerID FROM @CustomerDue)


UPDATE dbo.CreditSales SET IsReturn = 1, ReturnDate = (SELECT TOP(1) TransactionDate FROM @CustomerDue) 
WHERE CreditSalesID = @CRSalesId

UPDATE cd SET cd.IsProductReturn = 1
FROM CreditSaleDetails cd
JOIN @CreditDetails cdt ON cd.CreditSaleDetailsID = cdt.CreditSaleDetailsId

WHERE cd.CreditSalesID = @CRSalesId


UPDATE sd
SET sd.UsedStockStatus = 1, sd.UsedSaleRate = cdt.SalePrice, sd.UsedPurchaseRate = cdt.PurchasePrice, sd.Status = 1
FROM StockDetails sd
JOIN CreditSaleDetails cd ON sd.SDetailID = cd.StockDetailID
JOIN @CreditDetails cdt ON cd.CreditSaleDetailsID = cdt.CreditSaleDetailsId
WHERE cd.CreditSalesID = @CRSalesId
--WHERE SDetailID = (SELECT TOP(1) StockDetailID FROM dbo.CreditSaleDetails WHERE CreditSalesID = @CRSalesId)

------------------------------------------------Changes -NE- ----------------------------------------------------------

--SET @StockID = (
--SELECT min(StockID)
--FROM StockDetails
--WHERE SDetailID = (SELECT TOP(1) StockDetailID FROM dbo.CreditSaleDetails WHERE CreditSalesID = @CRSalesId)
--)

--UPDATE Stocks
--SET Quantity = Quantity + 1
--WHERE StockID = @StockID

UPDATE st SET st.Quantity = st.Quantity + 1
FROM Stocks st
JOIN StockDetails sd ON st.StockID = sd.StockID
JOIN CreditSaleDetails cd ON sd.SDetailID = cd.StockDetailID
JOIN @CreditDetails cdt ON cd.CreditSaleDetailsID = cdt.CreditSaleDetailsId
WHERE cd.CreditSalesID = @CRSalesId

COMMIT

RETURN 1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		RETURN 0;
END CATCH
------------------------------------------------------------------------------------------------------------------------

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SOrders ADD
	PrevDue decimal(18, 2) NOT NULL CONSTRAINT DF_SOrders_PrevDue DEFAULT ((0))
GO
ALTER TABLE dbo.SOrders SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

------------------------------------------------------------------------------------------------------------


EXEC sys.sp_rename 'dbo.InsertSalesOrderTable', 'zInsertSalesOrderTable';
GO

CREATE TYPE [dbo].[InsertSalesOrderTable] AS TABLE(
	[InvoiceDate] [datetime] NULL,
	[InvoiceNo] [varchar](150) NULL,
	[VatPercentage] [decimal](18, 2) NULL,
	[VatAmount] [decimal](18, 2) NULL,
	[GrandTotal] [decimal](18, 2) NULL,
	[TDiscountPercentage] [decimal](18, 4) NULL,
	[TDiscountAmount] [decimal](18, 2) NULL,
	[RecAmt] [decimal](18, 2) NULL,
	[PaymentDue] [decimal](18, 2) NULL,
	[TotalAmount] [decimal](18, 2) NULL,
	[TotalDue] [decimal](18, 2) NULL,
	[AdjAmount] [decimal](18, 2) NULL,
	[Status] [int] NULL,
	[CustomerId] [int] NULL,
	[ConcernId] [int] NULL,
	[CreatedBy] [int] NULL,
	[CreateDate] [datetime] NULL,
	[TotalOffer] [decimal](18, 2) NULL,
	[NetDiscount] [decimal](18, 2) NULL,
	[Remarks] [varchar](150) NULL,
	[CardPaidAmount] [decimal](18, 2) NULL,
	[CardTypeSetupID] [int] NULL,
	[DepositChargePercent] [decimal](18, 2) NULL,
	[TSQty] [decimal](18, 2) NULL,
	[PrevDue] [decimal](18, 2) NULL
)
GO

DECLARE @Name NVARCHAR(776);

DECLARE REF_CURSOR CURSOR FOR
SELECT referencing_schema_name + '.' + referencing_entity_name
FROM sys.dm_sql_referencing_entities('dbo.InsertSalesOrderTable', 'TYPE');

OPEN REF_CURSOR;

FETCH NEXT FROM REF_CURSOR INTO @Name;
WHILE (@@FETCH_STATUS = 0)
BEGIN
    EXEC sys.sp_refreshsqlmodule @name = @Name;
    FETCH NEXT FROM REF_CURSOR INTO @Name;
END;

CLOSE REF_CURSOR;
DEALLOCATE REF_CURSOR;
GO
DROP TYPE dbo.zInsertSalesOrderTable;
GO



------------------------------------------------------------------------------------------------------------

ALTER PROCEDURE [dbo].[AddSalesOrder] (
	@SalesOrder [INSERTSALESORDERTABLE] readonly,
	@SODetails [INSERTSODETAILTABLE] readonly,
	@RemindDate DATE,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
DECLARE @SalesOrderId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY
	BEGIN TRANSACTION

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @SalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	INSERT INTO sorders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty,
		PrevDue
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID,
		TSQty,
		PrevDue FROM @SalesOrder
		)

	SET @SalesOrderId = Scope_identity()

	INSERT INTO SOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.TAmount,
		SOD.PPDisPer,
		SOD.PPDisAmt,
		SOD.MrpRate,
		@SalesOrderId SOrderID,
		SOD.StockDetailId,
		SOD.PPOffer,
		(SOD.UnitPrice - SOD.PPDisAmt),
		STD.PRate,
		p.CompressorWarrentyMonth,
		p.PanelWarrentyMonth,
		p.MotorWarrentyMonth,
		p.SparePartsWarrentyMonth,
		p.ServiceWarrentyMonth FROM @SODetails SOD INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailId INNER JOIN Products p
		ON STD.ProductID = p.ProductID WHERE P.ProductType = 1 OR p.ProductType = 3
		)

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue),
		reminddate = @RemindDate
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NOT NULL

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue)
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NULL

	--Stock Update 
	CREATE TABLE #tmpStock (
		ProductID INT,
		ColorID INT,
		GodownID INT,
		Qty DECIMAL(18, 2)
		)

	INSERT INTO #tmpStock (
		ProductID,
		ColorID,
		GodownID,
		Qty
		) (
		SELECT s.ProductID,
		s.ColorID,
		s.Compressor,
		SUM(s.Quantity) FROM @SODetails s 
		GROUP BY s.ProductId,
		s.ColorId,
		s.Compressor
		)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st
		ON st.ProductID = sod.ProductID AND st.ColorID = sod.ColorID AND st.GodownID = sod.GodownID

	--For barCode Product 
	UPDATE stockdetails
	SET stockdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN stockdetails
		ON stockdetails.sdetailid = s.stockdetailid
	INNER JOIN products
		ON stockdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	--*****************FIFO for Nobarcode************************** 
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @GodownID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity INT
	DECLARE @SQty INT
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.productid,
		colorid,
		s.Compressor,
		quantity,
		sorderdetailid
	FROM @SODetails s
	INNER JOIN products
		ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity != 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)

			IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity

				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.Compressor=@GodownID AND SOD.colorid = @ColorID
					)

				SET @Quantity = 0
			END
			ELSE IF (@SQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @SQty

				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@SQty,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @SQty),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

	--For barCode Product SRVisit Status update 
	UPDATE srvproductdetails
	SET srvproductdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN srvproductdetails
		ON srvproductdetails.sdetailid = s.stockdetailid AND srvproductdetails.STATUS = 1
	INNER JOIN products
		ON srvproductdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	RETURN 0;
END CATCH
-------------Rakib--------------
----------26-06-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[ReturnSalesOrder]
(
	@SalesOrderId int,
	@UserId int
)
  
AS 
BEGIN TRY
 BEGIN TRANSACTION

 --ExistingBC = 1,
 --NoBarcode = 2,
 --AutoBC = 3  
 Create table #temp(Id int identity(1,1),ProductID int,ColorID int ,GodownID int,Qty decimal(18,2))
 Insert Into #temp(ProductID,ColorID,GodownID,Qty)
 select sod.ProductID,ColorID,GodownID,sum(sod.Quantity) from SOrderDetails sod
 join StockDetails sd on sod.SDetailID = sd.SDetailID
 where sod.SOrderID=@SalesOrderId
 group by sod.ProductID,sd.ColorID,sd.GodownID

UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity + d.Qty), ModifiedBy = @UserId, ModifiedDate = GETDATE()
FROM #temp d
JOIN Stocks ON Stocks.ProductID = d.ProductID and Stocks.ColorID=d.ColorID and Stocks.GodownID=d.GodownID

----Update StockDetails---------------------------------------------

--UPDATE StockDetails
--SET StockDetails.Status = 1, Quantity=StockDetails.Quantity+d.Quantity
--FROM SOrderDetails d
--JOIN StockDetails ON StockDetails.SDetailID = d.SDetailID
--JOIN Products ON Products.ProductID= StockDetails.ProductID
--WHERE d.SOrderID = @SalesOrderId and Products.ProductType=2

 Create table #temp2(Id int identity(1,1),ProductID int,ColorID int ,GodownID int,Qty decimal(18,2), SDetailId INT)
 Insert Into #temp2(ProductID,ColorID,GodownID,Qty, SDetailId)
 select sod.ProductID,ColorID,GodownID,sum(sod.Quantity), sd.SDetailID SDetailId from SOrderDetails sod
 join StockDetails sd on sod.SDetailID = sd.SDetailID
 where sod.SOrderID=@SalesOrderId
 group by sod.ProductID,sd.ColorID,sd.GodownID, sd.SDetailID

UPDATE sd
SET sd.Status = 1, sd.Quantity= (sd.Quantity+d.Qty)
FROM #temp2 d
JOIN Products ON Products.ProductID= d.ProductID
JOIN dbo.StockDetails sd ON sd.ProductID = d.ProductID and sd.ColorID=d.ColorID and sd.GodownID=d.GodownID AND sd.SDetailID = d.SDetailId
WHERE Products.ProductType=2


UPDATE StockDetails
SET StockDetails.Status = 1
FROM SOrderDetails d
JOIN StockDetails ON StockDetails.SDetailID = d.SDetailID
JOIN Products ON Products.ProductID= StockDetails.ProductID
WHERE d.SOrderID = @SalesOrderId and Products.ProductType!=2
--------------------------------------------------------------------------------------------

UPDATE SRVProductDetails
SET SRVProductDetails.Status = 3
from SOrderDetails s
JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.SDetailID
where SRVProductDetails.Status=2


UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
FROM SOrders s
JOIN Customers ON Customers.CustomerID = s.CustomerID
WHERE s.SOrderID = @SalesOrderId

--DELETE FROM SOrderDetails WHERE SOrderID = @SalesOrderId
Update SOrders Set Status = 2,ModifiedBy=@UserId,ModifiedDate=GETDATE() Where SOrderID = @SalesOrderId

Declare @BankTransID int
Declare @BankID int

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END


COMMIT
RETURN 1

END TRY

BEGIN CATCH
 IF(@@TRANCOUNT>0)
   ROLLBACK
   RETURN 0
END CATCH



-------------Rakib--------------
----------25-06-2023------------
--------------------------------


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[ReturnCreditSalesOrder]
(
	@SalesOrderId int,
	@UserId int
)
  
AS 
BEGIN TRY
 BEGIN TRANSACTION 

  Create table #temp(Id int identity(1,1),ProductID int,ColorID int ,GodownID int,Qty decimal(18,2))

  Insert Into #temp(ProductID,ColorID,GodownID,Qty)
 select sod.ProductID,ColorID,GodownID,sum(sod.Quantity) from CreditSaleDetails sod
 join StockDetails sd on sod.StockDetailID = sd.SDetailID
 where sod.CreditSalesID=@SalesOrderId
  group by sod.ProductID,sd.ColorID,sd.GodownID

  UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity + d.Qty), ModifiedBy = @UserId, ModifiedDate = GETDATE()
FROM #temp d
JOIN Stocks ON Stocks.ProductID = d.ProductID and Stocks.ColorID=d.ColorID and Stocks.GodownID=d.GodownID

-- UPDATE Stocks
--SET Stocks.Quantity = (Stocks.Quantity + d.Quantity), ModifiedBy = @UserId, ModifiedDate = GETDATE()
--FROM CreditSaleDetails d
--JOIN Stocks ON Stocks.ProductID = d.ProductID
--WHERE Stocks.ColorID IN
--(SELECT ColorID FROM StockDetails JOIN CreditSaleDetails ON StockDetails.SDetailID = CreditSaleDetails.StockDetailID WHERE CreditSaleDetails.CreditSalesID = @SalesOrderId)
--AND d.CreditSalesID = @SalesOrderId


----Update StockDetails
UPDATE StockDetails
SET StockDetails.Status = 1,Quantity=StockDetails.Quantity+d.Quantity
FROM CreditSaleDetails d
JOIN StockDetails ON StockDetails.SDetailID = d.StockDetailId
JOIN Products ON Products.ProductID= StockDetails.ProductID
WHERE d.CreditSalesID = @SalesOrderId and Products.ProductType=2


UPDATE StockDetails
SET StockDetails.Status = 1
FROM CreditSaleDetails d
JOIN StockDetails ON StockDetails.SDetailID = d.StockDetailId
JOIN Products ON Products.ProductID= StockDetails.ProductID
WHERE d.CreditSalesID = @SalesOrderId and Products.ProductType!=2

------------------------------------------------------------------------------------------

UPDATE SRVProductDetails SET SRVProductDetails.Status = 3
from CreditSaleDetails s
JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
where SRVProductDetails.Status=2

UPDATE Customers Set Customers.CreditDue = (Customers.CreditDue- s.Remaining)
FROM CreditSales s
JOIN Customers ON Customers.CustomerID = s.CustomerID
WHERE s.CreditSalesID = @SalesOrderId

UPDATE CreditSales SET IsStatus = 2,ModifiedBy=@UserId,ModifiedDate=GETDATE() WHERE CreditSalesID = @SalesOrderId

Declare @BankTransID int
Declare @BankID int

set @BankTransID = ISNULL((Select BankTransID from CreditSales where CreditSalesID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END
COMMIT

RETURN 1

END TRY

BEGIN CATCH
  IF(@@TRANCOUNT>0)
    ROLLBACK
	RETURN 0
END CATCH


-------------Rakib--------------
----------24-06-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[AddSalesOrder] (
	@SalesOrder [INSERTSALESORDERTABLE] readonly,
	@SODetails [INSERTSODETAILTABLE] readonly,
	@RemindDate DATE,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
DECLARE @SalesOrderId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY
	BEGIN TRANSACTION

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @SalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	INSERT INTO sorders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID,
		TSQty
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID,
		TSQty FROM @SalesOrder
		)

	SET @SalesOrderId = Scope_identity()

	INSERT INTO SOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.TAmount,
		SOD.PPDisPer,
		SOD.PPDisAmt,
		SOD.MrpRate,
		@SalesOrderId SOrderID,
		SOD.StockDetailId,
		SOD.PPOffer,
		(SOD.UnitPrice - SOD.PPDisAmt),
		STD.PRate,
		p.CompressorWarrentyMonth,
		p.PanelWarrentyMonth,
		p.MotorWarrentyMonth,
		p.SparePartsWarrentyMonth,
		p.ServiceWarrentyMonth FROM @SODetails SOD INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailId INNER JOIN Products p
		ON STD.ProductID = p.ProductID WHERE P.ProductType = 1 OR p.ProductType = 3
		)

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue),
		reminddate = @RemindDate
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NOT NULL

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue)
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NULL

	--Stock Update 
	CREATE TABLE #tmpStock (
		ProductID INT,
		ColorID INT,
		GodownID INT,
		Qty DECIMAL(18, 2)
		)

	INSERT INTO #tmpStock (
		ProductID,
		ColorID,
		GodownID,
		Qty
		) (
		SELECT s.ProductID,
		s.ColorID,
		s.Compressor,
		SUM(s.Quantity) FROM @SODetails s 
		GROUP BY s.ProductId,
		s.ColorId,
		s.Compressor
		)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st
		ON st.ProductID = sod.ProductID AND st.ColorID = sod.ColorID AND st.GodownID = sod.GodownID

	--For barCode Product 
	UPDATE stockdetails
	SET stockdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN stockdetails
		ON stockdetails.sdetailid = s.stockdetailid
	INNER JOIN products
		ON stockdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	--*****************FIFO for Nobarcode************************** 
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @GodownID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity INT
	DECLARE @SQty INT
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.productid,
		colorid,
		s.Compressor,
		quantity,
		sorderdetailid
	FROM @SODetails s
	INNER JOIN products
		ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity != 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)

			IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity

				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.Compressor=@GodownID AND SOD.colorid = @ColorID
					)

				SET @Quantity = 0
			END
			ELSE IF (@SQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @SQty

				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@SQty,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @SQty),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					--SOD.tamount,
					((SOD.unitprice - SOD.ppdisamt) * @Quantity),
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

	--For barCode Product SRVisit Status update 
	UPDATE srvproductdetails
	SET srvproductdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN srvproductdetails
		ON srvproductdetails.sdetailid = s.stockdetailid AND srvproductdetails.STATUS = 1
	INNER JOIN products
		ON srvproductdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	RETURN 0;
END CATCH



-------------Nahid--------------
----------27-05-2023------------
--------------------------------


ALTER PROC [dbo].[UpdateTotalDueForExpenditure]
(
	@ExpenseItemID int,
	@BankDepositId int,
	@BankWithdrawId int,
	@CollectionAmount decimal(18,2),
	@ConcernID int,
	@userId int,
	@Remarks nvarchar(MAX),
	@TranDate DATETIME
)
  
AS 
IF(@ExpenseItemID>0)
BEGIN
--DECLARE @maxExpenseId int;
--Set @maxExpenseId=(Select ExpenditureID from Expenditures)
INSERT INTO [dbo].[Expenditures]
           ([EntryDate],[Purpose],[Amount],[ExpenseItemID]
           ,[VoucherNo],[ConcernID],[CreatedBy],[CreateDate]
           ,[CustomerType],[Remarks],[WFStatus],[CashInHandReportStatus])
     VALUES
           (@TranDate,@Remarks
           ,@CollectionAmount,@ExpenseItemID,(CONVERT(varchar(100),@ExpenseItemID))
            ,@ConcernID,@userId,GETDATE(),0
           ,'From Bank Transaction',2,0)
END
 IF(@BankDepositId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount + @CollectionAmount)
	where BankID=@BankDepositId
END
  
 IF(@BankWithdrawId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount - @CollectionAmount)
	where BankID=@BankWithdrawId
END

RETURN

------------------------------------------------------------------------------------------------------------------

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.CreditSalesSchedules ADD
	CreatedBy int NOT NULL CONSTRAINT DF_CreditSalesSchedules_CreatedBy DEFAULT ((0))
GO
ALTER TABLE dbo.CreditSalesSchedules SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

------------------------------------------------------------------------------------------------------------------



EXEC sys.sp_rename 'dbo.InsertCSSchedulesTable', 'zInsertCSSchedulesTable';
GO

CREATE TYPE [dbo].[InsertCSSchedulesTable] AS TABLE(
	[MonthDate] [datetime] NULL,
	[Balance] [money] NULL,
	[InstallmentAmt] [money] NULL,
	[PaymentDate] [datetime] NULL,
	[PaymentStatus] [nvarchar](150) NULL,
	[InterestAmount] [money] NULL,
	[ClosingBalance] [money] NULL,
	[ScheduleNo] [int] NULL,
	[Remarks] [nvarchar](max) NULL,
	[IsUnExpected] [int] NULL,
	[HireValue] [decimal](18, 2) NULL,
	[NetValue] [decimal](18, 2) NULL,
	[ExpectedInstallment] [decimal](18, 2) NULL,
	[CardPaidAmount] [decimal](18, 2) NULL,
	[CardTypeSetupID] [int] NULL,
	[DepositChargePercent] [decimal](18, 2) NULL,
	[BankTransID] [int] NULL,
	[CreatedBy] [int] NULL
)
GO

DECLARE @Name NVARCHAR(776);

DECLARE REF_CURSOR CURSOR FOR
SELECT referencing_schema_name + '.' + referencing_entity_name
FROM sys.dm_sql_referencing_entities('dbo.InsertCSSchedulesTable', 'TYPE');

OPEN REF_CURSOR;

FETCH NEXT FROM REF_CURSOR INTO @Name;
WHILE (@@FETCH_STATUS = 0)
BEGIN
    EXEC sys.sp_refreshsqlmodule @name = @Name;
    FETCH NEXT FROM REF_CURSOR INTO @Name;
END;

CLOSE REF_CURSOR;
DEALLOCATE REF_CURSOR;
GO
DROP TYPE dbo.zInsertCSSchedulesTable;
GO

------------------------------------------------------------------------------------------------------------------


--EXEC sp_DailyCashInHand  '11 MAY 2021 12:00:00 AM','11 MAY 2021 11:59:59 PM',16
ALTER procedure [dbo].[sp_DailyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-08-01'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)



create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(DAY, 1, Convert(date, GetDate()))
begin
	print @StartDate

	delete
	from #temp_Data1

	delete
	from #temp_Data2

	--	DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
	--	DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
	------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
	insert into #temp_Data1
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
				and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
		from POrders po
		join Suppliers s on po.SupplierID = s.SupplierID
		where po.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
		and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and po.RecAmt>0
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
	---------------------------------Expense from Bank Deposit--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

	END
	---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank collections', @total, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	inner join Customers c on BT.CustomerID = c.CustomerID
	where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
	group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	insert into #temp_Data1
	select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
	---------------------------------Expens from Bank Cash Delivery---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Cash Delivery', @total, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END

---------------------------------Expens from Bank Income ---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 7 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Income', 0, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Income (Cr))', sum(Amount), 'Bank Income ', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 7 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Income ', @total, '', 0, 'Header'
END


	---------------------------------Expense from Fund Out---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections cc
				join Suppliers s on cc.SupplierID = s.SupplierID
				where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
				and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
		and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
	------------------------------------------------------Expense in Product return----------------------------------
	set @total = isnull((
				select sum(PaidAmount)
				from ROrders
				where ConcernID = @ConcernID and DAY(Convert(date, ReturnDate)) = DAY(@StartDate) and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

END

	-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Cash Collection Return', @total, 'Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

	------------- -------------------------------------------- Direct Expense--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' and EX.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' and EX.CashInHandReportStatus = 0
		and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description

		insert into #temp_Data1
		select @StartDate,'Total Expense', @total, '', 0, 'Header'
	end

	------------- -------------------------------------------- Expense from Advance Salary--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from AdvanceSalaries Ads
						inner join Employees E on E.EmployeeID = Ads.EmployeeID
						where Ads.ConcernID = @ConcernID and Ads.SalaryType = 1 and Ads.IsAdvanceLoanPay = 0
						and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Employee Salary Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Name , sum(Amount), '', 0, 'Ads'
		from AdvanceSalaries Ads
		inner join Employees E on E.EmployeeID = Ads.EmployeeID
		where Ads.ConcernID = @ConcernID
		and DAY(Convert(date, CreatedDate)) = DAY(@StartDate) and Month(Convert(date, CreatedDate)) = Month(@StartDate) and Year(Convert(date, CreatedDate)) = Year(@StartDate)
		group by E.Name

		insert into #temp_Data1
		select @StartDate,'Total Employee Salary Expense', @total, '', 0, 'Header'
	end



	-- ----------------------------Expens from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND SI.CashInHandReportStatus = 0  AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=3  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2  AND SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
END

	----------------------------------------------Opening Cash In Hand in Income Table--------------------------------------------------------------- 
	insert into #temp_Data2
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	-----------------------------------------------Income in Sales Order-------------------------------------------
	set @total = isnull((
				select sum(RecAmount)
				from SOrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount,Convert(varchar(10),c.CustomerType)+'Order' from SOrders so
		join Customers c on so.CustomerID = c.CustomerID
		where so.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
	    insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
   
   END
	---------------------------------Income from Bank Withdwal--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

				---------------------------------Income from Bank Expens as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 6 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Expens as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Bank Expens(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 6 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName


	---------------------------------Income from Bank Cash Collection---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
		('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on bt.CustomerID=c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	----------------------------------------Income from Fund IN------------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.AnotherBankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.AnotherBankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-- ---------------------------------------Income from Cash Collection from Customer-------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
				), 0)

	if (@total != 0)
	BEGIN
	insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, Convert(varchar(10),c.CustomerType)+'Cash'
		from CashCollections cc
		join Customers c on cc.CustomerID = c.CustomerID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
	    insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')
		
		END
	-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
	set @total = isnull((
				select isnull(sum(DownPayment), 0)
				from CreditSales
				where ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
		from CreditSales cs
		join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')
	
	END
	--------------------------------------Income in Purchase Product return----------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and DAY(Convert(date, OrderDate)) = DAY(@StartDate) and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and status = 5
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Purchase Return Cash'

	-------------------------------Income Installment Collection from Creditsales------------------
	set @total = isnull((
				select sum(InstallmentAmt)
				from CreditSalesSchedules css
				inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
				where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
		from CreditSalesSchedules css
		inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
		inner join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
	  
	  insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')
	
	END
	-----------------------------------Income from Direct Income------------------------------------------------
set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and EX.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Description, sum(Amount), E.Description
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 2 and  EX.CashInHandReportStatus = 0 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')
	
	end

	-- ----------------------------Income from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND  SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND   SI.CashInHandReportStatus = 0 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
	END

	   SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)
	IF (@total != 0)
	BEGIN
		INSERT INTO #temp_Data2
		SELECT @StartDate, '', 0.00,SIH.Name+'(Current Asset)',  sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name

		insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')
	END

	insert into #temp_Data3
	select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), '', 0.00,  ''
	from #temp_Data1 T1
	UNION ALL
	select @StartDate, 0,  '', 0, isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
	from #temp_Data2 T2

	declare @a decimal(18, 2)
	declare @b decimal(18, 2)
	declare @ExpenseWithinDate decimal(18, 2)
	declare @IncomeWithinDate decimal(18, 2)
	declare @CashInHandWithinDate decimal(18, 2)

	set @a = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @b = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @ExpenseWithinDate = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @IncomeWithinDate = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
	set @CashInHand = @CashInHand + (@b - @a)

	insert into #temp_Data3
	values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

	insert into #temp_Data3
	values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

	insert into #temp_Data3
	values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

	set @StartDate = DATEADD(DAY, 1, @StartDate)
	--select *From #temp_Data1
	--select *From #temp_Data2
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

-------------Nahid--------------
----------13-05-2023------------
--------------------------------

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.CreditSales ADD
	GuarName nvarchar(MAX) NULL,
	GuarContactNo nvarchar(MAX) NULL,
	GuarAddress nvarchar(MAX) NULL
GO
ALTER TABLE dbo.CreditSales SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

--------------------------------------------------------------------------------------------------------------------

EXEC sys.sp_rename 'dbo.InsertCreditSalesOrderTable', 'zInsertCreditSalesOrderTable';
GO

CREATE TYPE [dbo].[InsertCreditSalesOrderTable] AS TABLE(
	[InvoiceNo] [varchar](150) NULL,
	[CustomerID] [int] NULL,
	[TSalesAmt] [money] NULL,
	[NoOfInstallment] [int] NULL,
	[InstallmentPrinciple] [money] NULL,
	[IssueDate] [datetime] NULL,
	[UserName] [varchar](250) NULL,
	[Remaining] [money] NULL,
	[InterestRate] [decimal](6, 2) NULL,
	[InterestAmount] [decimal](18, 2) NULL,
	[SalesDate] [datetime] NULL,
	[DownPayment] [money] NULL,
	[WInterestAmt] [money] NULL,
	[FixedAmount] [money] NULL,
	[IsStatus] [int] NULL,
	[UnExInstallment] [int] NULL,
	[Quantity] [int] NULL,
	[Discount] [money] NULL,
	[NetAmount] [money] NULL,
	[IsUnExpected] [bit] NULL,
	[Remarks] [varchar](max) NULL,
	[Status] [bit] NULL,
	[VatPercentage] [decimal](18, 2) NULL,
	[VatAmount] [decimal](18, 2) NULL,
	[TotalDue] [money] NULL,
	[ConcernId] [int] NULL,
	[CreatedBy] [int] NULL,
	[CreateDate] [datetime] NULL,
	[TotalOffer] [decimal](18, 2) NULL,
	[InstallmentPeriod] [varchar](max) NULL,
	[CardPaidAmount] [decimal](18, 2) NULL,
	[CardTypeSetupID] [int] NULL,
	[DepositChargePercent] [decimal](18, 2) NULL,
	[IsWeekly] [int] NOT NULL,
	[GuarName] [varchar](max) NULL,
	[GuarContactNo] [varchar](max) NULL,
	[GuarAddress] [varchar](max) NULL
)
GO

DECLARE @Name NVARCHAR(776);

DECLARE REF_CURSOR CURSOR FOR
SELECT referencing_schema_name + '.' + referencing_entity_name
FROM sys.dm_sql_referencing_entities('dbo.InsertCreditSalesOrderTable', 'TYPE');

OPEN REF_CURSOR;

FETCH NEXT FROM REF_CURSOR INTO @Name;
WHILE (@@FETCH_STATUS = 0)
BEGIN
    EXEC sys.sp_refreshsqlmodule @name = @Name;
    FETCH NEXT FROM REF_CURSOR INTO @Name;
END;

CLOSE REF_CURSOR;
DEALLOCATE REF_CURSOR;
GO
DROP TYPE dbo.zInsertCreditSalesOrderTable;
GO

--------------------------------------------------------------------------------------------------------

ALTER PROCEDURE [dbo].[AddCreditSalesOrder] (
@CSalesOrder [dbo].[INSERTCREDITSALESORDERTABLE] readonly, 
@CSODetails [INSERTCSODETAILTABLE] readonly,
@CSSchedules [INSERTCSSCHEDULESTABLE] readonly,
@BankTrans [InsertBankTransTable] readonly)
AS
DECLARE @CreditSalesId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY  
 BEGIN TRANSACTION 

-----------------Card Payment Bank Deposit--------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @CSalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

------------------Card Payment Bank Deposit--------------

INSERT INTO creditsales (invoiceno, customerid, tsalesamt, noofinstallment,
 intallmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamt, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress)
(SELECT
 invoiceno, customerid, tsalesamt, noofinstallment, 
 installmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamount, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,@BankTransID, IsWeekly, GuarName, GuarContactNo, GuarAddress FROM @CSalesOrder)

UPDATE customers
SET customers.CreditDue = (customers.CreditDue + s.totaldue)
FROM @CSalesOrder s
INNER JOIN customers ON customers.customerid = s.customerid

SET @CreditSalesId = Scope_identity()

INSERT INTO CreditSaleDetails 
( 
ProductID ,UnitPrice, Quantity, UTAmount, CreditSalesID,  
MPRateTotal, MPRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,Compressor,Motor,
Panel,Spareparts,Service
) 
( 
Select sd.ProductID ,UnitPrice, Quantity, UTAmount, @CreditSalesId CreditSalesID,  
MPRateTotal, MrpRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,p.CompressorWarrentyMonth,p.MotorWarrentyMonth,
p.PanelWarrentyMonth,p.SparePartsWarrentyMonth,p.ServiceWarrentyMonth from @CSODetails sd
join Products p on sd.ProductID=p.ProductID 
where p.ProductType!=2
) 

UPDATE stocks
SET stocks.quantity = (stocks.quantity - s.quantity)
FROM @CSODetails s
INNER JOIN stocks ON stocks.productid = s.productid AND stocks.colorid = s.colorid AND Stocks.GodownID=s.Compressor

UPDATE StockDetails 
SET StockDetails.Status = 2 
from @CSODetails s 
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId 
join Products on StockDetails.ProductID = Products.ProductID 
where Products.ProductType!=2 

--***************FIFO for Nobarcode Product**********************
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @CreditSaleProductsID INT
DECLARE @Quantity INT
DECLARE @SQty INT
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL
FOR
SELECT s.productid, s.colorid, s.quantity, creditsalesdetailsid
-- from   InsertCSODetailTable SOD join CreditSales SO on SO.CreditSalesID=SOD.CreditSalesID where SO.Status=1
FROM @CSODetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.stockdetailid
INNER JOIN products ON stockdetails.productid = products.productid
where Products.ProductType=2 
OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID

WHILE @@FETCH_STATUS = 0
BEGIN
	WHILE @Quantity != 0
	BEGIN
		SET @SDetailID = (
				SELECT Min(sdetailid)
				FROM stockdetails
				WHERE productid = @ProductID AND colorid = @ColorID AND quantity != 0 AND STATUS = 1
				)
		SET @SQty = (
				SELECT quantity
				FROM stockdetails
				WHERE sdetailid = @SDetailID
				)

		IF (@SQty > @Quantity)
		BEGIN
			SET @SQty = @SQty - @Quantity

			UPDATE stockdetails
			SET quantity = @SQty
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service)
			 (SELECT sd.productid, unitprice, @Quantity, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID  =@CreditSaleProductsID
			SET @Quantity = 0
		END
		ELSE IF (@SQty < @Quantity)
		BEGIN
			SET @Quantity = @Quantity - @SQty

			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service) (SELECT sd.productid, unitprice, @SQty, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)
				--update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
		END
		ELSE
		BEGIN
			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (
			productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate,
			 stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service
			 ) 
			 (SELECT 
			  sd.productid, unitprice, @SQty, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate,
			  @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, 
			  p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd 
			  INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID
			  )

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
			SET @Quantity = 0
		END
	END

	FETCH NEXT
	FROM cur
	INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID
END

INSERT INTO creditsalesschedules (monthdate, balance, installmentamt, 
paymentdate, creditsalesid, paymentstatus, interestamount, closingbalance,
 scheduleno, remarks, isunexpected, hirevalue, netvalue)
(SELECT monthdate, balance, installmentamt,
 paymentdate, @CreditSalesId CreditSalesID, paymentstatus, interestamount, closingbalance,
  scheduleno, remarks, isunexpected, hirevalue, netvalue FROM @CSSchedules)

COMMIT
RETURN 1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		RETURN 0;
END CATCH


-------------Nahid--------------
----------09-05-2023------------
--------------------------------
ALTER PROC [dbo].[GetCategorywiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) - ISNULL(piv.SalesReturn, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales - piv.TotalCrSalesINT, 0)) - ISNULL(piv.SalesReturn, 0)) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue',
		ISNULL(piv.InterestAmount, 0) as TInterestAmount,
		ISNULL(piv.CrInterestAmount, 0) as CrInterestAmount



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL



	--start here 



	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(csd.IntTotalAmt, 0)), 0) PrevSales, 'TotalCrSalesINT' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID 
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 



	 AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales,TotalCrSalesINT, SalesReturn, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn, InterestAmount, CrInterestAmount

		)
	) piv
 END


 --EXEC GetCategorywiseCustomerDue 0, 16


-----------Mostafizur-----------
----------04-05-2023------------
--------------------------------

/****** Object:  StoredProcedure [dbo].[SP_ServiceCharge]    Script Date: 15-May-23 11:04:42 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--exec SP_ServiceCharge 4
Create PROCEDURE [dbo].[SP_ServiceCharge] 
	@Month int,
	@Year int
AS
BEGIN
	select scs.Name as 'ConcernName',scd.TransactionDate,scd.PaymentMobNo as 'PaymentMobNo',scd.ExpectedServiceCharge as 'ServiceCharge' 
	from ServiceCharges sc
	Inner Join ServiceChargeDetails scd on sc.Id=scd.ServiceChargeId
	Inner Join SisterConcerns scs on scs.ConcernID=sc.ConcernId
	where Month=@Month and IsPaid=1 and TransactionId is Not Null and sc.ServiceYear=@Year
END

-------------Raihan--------------
----------04-05-2023------------
--------------------------------
GO
/****** Object:  StoredProcedure [dbo].[SP_ServiceCharge]    Script Date: 04-May-23 12:17:14 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[SP_ServiceCharge] 
	@Month int
AS
BEGIN
	select scs.Name,scd.TransactionDate,scd.PaymentMobNo as 'FromMobileNo.',scd.ExpectedServiceCharge as 'ServiceCharge' from ServiceCharges sc
	Inner Join ServiceChargeDetails scd on sc.Id=scd.ServiceChargeId
	Inner Join SisterConcerns scs on scs.ConcernID=sc.ConcernId
	where Month=@Month and IsPaid=1 and TransactionId is Not Null
END


-------------Mostafizur--------------
----------03-04-2023------------
--------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	CustomerSmsWithCustomerName int NOT NULL CONSTRAINT DF_SystemInformations_CustomerSmsWithCustomerName DEFAULT ((0))
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

-------------Rakib--------------
----------25-03-2023------------
--------------------------------

ALTER Table SisterConcerns ADD
SmsContactNo Nvarchar(20) NULL


-------------Rakib--------------
----------22-03-2023------------
--------------------------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[ServiceChargeDetails](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[Month] [int] NOT NULL,
	[ExpectedServiceCharge] [decimal](18, 2) NOT NULL,
	[PaidServiceCharge] [decimal](18, 2) NOT NULL,
	[IsPaid] [bit] NOT NULL,
	[TransactionId] [nvarchar](250) NULL,
	[TransactionDate] [datetime] NULL,
	[PaymentMobNo] [nvarchar](50) NULL,
	[InvoiceNo] [nvarchar](50) NULL,
	[PaymentId] [nvarchar](150) NULL,
	[PaymentReference] [nvarchar](150) NULL,
	[TransactionStatus] [nvarchar](100) NULL,
	[Currency] [nvarchar](10) NULL,
	[Intent] [nvarchar](20) NULL,
	[StatusCode] [nvarchar](30) NULL,
	[StatusMessage] [nvarchar](500) NULL,
	[ErrorCocde] [nvarchar](30) NULL,
	[ErrorMessage] [nvarchar](500) NULL,
	[ServiceChargeId] [int] NOT NULL,
 CONSTRAINT [PK_ServiceChargeDetails] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[ServiceChargeDetails]  WITH CHECK ADD  CONSTRAINT [FK_ServiceChargeDetails_ServiceCharges] FOREIGN KEY([ServiceChargeId])
REFERENCES [dbo].[ServiceCharges] ([Id])
GO

ALTER TABLE [dbo].[ServiceChargeDetails] CHECK CONSTRAINT [FK_ServiceChargeDetails_ServiceCharges]
GO


-------------Rakib--------------
----------22-03-2023------------
--------------------------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[ServiceCharges](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[ConcernId] [int] NOT NULL,
	[TotalServiceCollection] [decimal](18, 2) NOT NULL,
	[ServiceYear] [int] NOT NULL,
	[CreatedBy] [int] NOT NULL,
	[CreateDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NULL,
	[ModifiedDate] [datetime] NULL,
 CONSTRAINT [PK_ServiceCharges] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[ServiceCharges]  WITH CHECK ADD  CONSTRAINT [FK_ServiceCharges_SisterConcerns] FOREIGN KEY([ConcernId])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[ServiceCharges] CHECK CONSTRAINT [FK_ServiceCharges_SisterConcerns]
GO


-------------Rakib--------------
----------22-03-2023------------
--------------------------------

ALTER Table SisterConcerns
ADD ServiceCharge DECIMAL(18,2) NOT NULL DEFAULT 500

-------------Mostafizur--------------
----------25-02-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER FUNCTION [dbo].[CheckTransProductStatusByTransDId]
(
  @TransferID int
)  
  RETURNS int
AS 
 BEGIN
	DECLARE	@Sold int
    
    SELECT @Sold = COUNT(*)
	FROM StockDetails
	JOIN TransferDetails TFD ON TFD.TDetailID = StockDetails.TransferDetailID 
	--join Transfers TF on TFD.TransferID = TF.TransferID
	join Products p on TFD.ProductID = p.ProductID
	WHERE p.ProductType = 2 OR p.ProductType = 1 OR p.ProductType = 3 and TFD.TransferID = @TransferID  AND StockDetails.Status = 2


	IF @Sold IS NULL OR @Sold = 0
		begin
			SET @Sold=0

			set @Sold =  (select ISNULL(COUNT(*), 0) FROM StockDetails sd
			JOIN TransferDetails TFD ON TFD.TDetailID = sd.TransferDetailID 
		--	join Transfers TF on TFD.TransferID = TF.TransferID
		--	JOIN SOrderDetails sod on sod.SDetailID = sd.SDetailID
			join Products p on TFD.ProductID = p.ProductID
			WHERE p.ProductID = 2 and  TFD.TransferID = @TransferID AND sd.Status = 2) 


		end
	  
	  
	RETURN  @Sold
  END

  --select dbo.CheckTransProductStatusByTransDId(44468)


-------------NAHID--------------
----------16-02-2023------------
--------------------------------
ALTER PROC [dbo].[GetLoanPayableAndReceivable]
(
	@asOnDate DATETIME,
	@ConcernID INT

)
  
AS 
BEGIN
	DECLARE @AllTakeLoan DECIMAL(18,2) = NULL,
		@AllLoanPayment DECIMAL(18,2) = NULL,
		@AllGivenLoan  DECIMAL(18,2) = NULL,
		@AllLoanCollection DECIMAL(18,2) = NULL,
	    @AllBankLoanPayment DECIMAL(18,2) = NULL,
	    @AllBankLoanCollection DECIMAL(18,2) = NULL

	SET @AllTakeLoan = (
							SELECT SUM(Amount) FROM ShareInvestments WHERE LiabilityType = 1 
							AND ConcernID = @ConcernID
							AND CAST(EntryDate as DATE) <= CAST(@asOnDate AS DATE)
					   )

	SET @AllLoanPayment = (
							SELECT SUM(Amount) FROM ShareInvestments WHERE LiabilityType = 4 
							AND ConcernID = @ConcernID
							AND CAST(EntryDate as DATE) <= CAST(@asOnDate AS DATE)
						)

	SET @AllGivenLoan = (
							SELECT SUM(Amount) FROM ShareInvestments WHERE LiabilityType = 3 
							AND ConcernID = @ConcernID
							AND CAST(EntryDate as DATE) <= CAST(@asOnDate AS DATE)
						)

	SET @AllLoanCollection = (
								SELECT SUM(Amount) FROM ShareInvestments WHERE LiabilityType = 2 
								AND ConcernID = @ConcernID
								AND CAST(EntryDate as DATE) <= CAST(@asOnDate AS DATE)
							)

	SET @AllBankLoanPayment = (
							SELECT SUM(Amount) FROM BankTransactions WHERE TransactionType = 8 
							AND ConcernID = @ConcernID
							AND CAST(TranDate as DATE) <= CAST(@asOnDate AS DATE)
						)

	SET @AllBankLoanCollection = (
							SELECT SUM(Amount) FROM BankTransactions WHERE TransactionType = 9 
							AND ConcernID = @ConcernID
							AND CAST(TranDate as DATE) <= CAST(@asOnDate AS DATE)
						)

	SELECT (ISNULL(@AllTakeLoan, 0) - ISNULL(@AllLoanPayment, 0) - ISNULL(@AllBankLoanPayment, 0)) AS TotalPayable, (ISNULL(@AllGivenLoan, 0) - ISNULL(@AllLoanCollection, 0) - ISNULL(@AllBankLoanCollection, 0)) AS TotalReceivable
END


--EXEC GetLoanPayableAndReceivable '2022-10-11', 5126

-------------NAHID--------------
----------14-02-2023------------
--------------------------------


ALTER PROC [dbo].[GetStockValue]
(
	@asOnDate DATETIME,
	@ConcernID INT

)
  
AS 
BEGIN
	SELECT CAST((piv.PO + piv.POReturn + piv.TransferIn + piv.TransferOut + piv.SO + piv.CrSO + piv.SOReturn + piv.Replacement) AS DECIMAL(18,2)) FROM
(

	SELECT ISNULL(SUM(po.PurchaseRate), 0) PurchaseRate, 'PO' Id FROM
	(
		SELECT 
		SUM((POD.UnitPrice - ((PO.TDiscount + PO.AdjAmount) * POD.UnitPrice) / (PO.GrandTotal - PO.NetDiscount + PO.TDiscount)) * pod.Quantity) PurchaseRate
		--ISNULL(SUM(sd.PRate), 0) PurchaseRate, ISNULL(SUM(pod.Quantity), 0) Quantity 
		
		FROM POrderDetails pod
		JOIN POrders po ON pod.POrderID = po.POrderID
		JOIN Products p ON pod.ProductID = p.ProductID
		JOIN Categorys cat ON p.CategoryID = cat.CategoryID
		JOIN Companies com ON p.CompanyID = com.CompanyID
		JOIN Colors clr ON pod.ColorID = clr.ColorID

		WHERE po.ConcernID = @ConcernID AND po.Status = 1 AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE)
		GROUP BY pod.ProductID, pod.ColorID
	) po

	UNION ALL

	SELECT ISNULL(SUM(por.PurchaseRate), 0) PurchaseRate, 'POReturn' Id FROM
	(
		SELECT 
		SUM(ISNULL(pod.UnitPrice, 0) * ISNULL(-pod.Quantity, 0)) PurchaseRate 
		FROM POrderDetails pod
		JOIN POrders po ON pod.POrderID = po.POrderID
		JOIN Products p ON pod.ProductID = p.ProductID
		JOIN Categorys cat ON p.CategoryID = cat.CategoryID
		JOIN Companies com ON p.CompanyID = com.CompanyID
		JOIN Colors clr ON pod.ColorID = clr.ColorID

		WHERE po.ConcernID = @ConcernID AND po.Status = 5 AND CAST(po.OrderDate AS DATE) <= CAST(@asOnDate AS DATE)
		GROUP BY pod.ProductID, pod.ColorID
	) por

	UNION ALL

	SELECT ISNULL(SUM(tr.PurchaseRate), 0) PurchaseRate, 'TransferIn' Id FROM
	(
		SELECT 
		SUM(ISNULL(td.PRate, 0) * ISNULL(td.Quantity, 0)) PurchaseRate FROM Transfers t
		JOIN TransferDetails td ON t.TransferID = td.TransferID
		JOIN Products p ON td.ToProductID = p.ProductID
		JOIN Colors c ON td.ToColorID = c.ColorID

		WHERE t.ToConcernID = @ConcernID AND t.Status = 1 AND CAST(t.TransferDate AS DATE) <= CAST(@asOnDate AS DATE)
		GROUP BY P.ProductID, c.ColorID
	) tr

	UNION ALL

	SELECT ISNULL(SUM(trO.PurchaseRate), 0) PurchaseRate, 'TransferOut' Id FROM
	(
		SELECT 
		SUM(ISNULL(td.PRate, 0) * ISNULL(-td.Quantity, 0)) PurchaseRate FROM Transfers t
		JOIN TransferDetails td ON t.TransferID = td.TransferID
		JOIN Products p ON td.ProductID = p.ProductID
		JOIN StockDetails sd1 ON td.SDetailID = sd1.SDetailID
		JOIN Colors c ON sd1.ColorID = c.ColorID

		WHERE t.FromConcernID = @ConcernID AND t.Status = 1 AND CAST(t.TransferDate AS DATE) <= CAST(@asOnDate AS DATE)
		GROUP BY P.ProductID, c.ColorID
	) trO

	UNION ALL

	SELECT ISNULL(SUM(so.PurchaseRate), 0) PurchaseRate, 'SO' Id FROM
	(
		SELECT 
		SUM(ISNULL(sd.PRate, 0) * ISNULL(-sod.Quantity, 0))  PurchaseRate FROM SOrders so
		JOIN SOrderDetails sod ON so.SOrderID = sod.SOrderID
		JOIN StockDetails sd ON sod.SDetailID = sd.SDetailID

		WHERE so.ConcernID = @ConcernID AND so.Status = 1 AND CAST(so.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
		GROUP BY sd.ProductID, sd.ColorID
	) so

	UNION ALL

	SELECT ISNULL(SUM(crso.PurchaseRate), 0) PurchaseRate, 'CrSO' Id FROM
	(
		SELECT 
		SUM(ISNULL(sd.PRate, 0) * ISNULL(-csd.Quantity, 0)) PurchaseRate FROM CreditSales cs
		JOIN CreditSaleDetails csd ON cs.CreditSalesID = csd.CreditSalesID
		JOIN StockDetails sd ON csd.StockDetailID = sd.SDetailID

		WHERE cs.ConcernID = @ConcernID AND cs.IsStatus = 1 AND CAST(cs.SalesDate AS DATE) <= CAST(@asOnDate AS DATE)
		GROUP BY sd.ProductID, sd.ColorID
	) crso

	UNION ALL

	SELECT ISNULL(SUM(sor.PurchaseRate), 0) PurchaseRate, 'SOReturn' Id FROM
	(
		SELECT 
		SUM(ISNULL(sd.PRate, 0) * ISNULL(rd.Quantity, 0))  PurchaseRate FROM ROrders r
		JOIN ROrderDetails rd ON r.ROrderID = rd.ROrderID
		JOIN StockDetails sd ON rd.StockDetailID = sd.SDetailID

		WHERE r.ConcernID = @ConcernID AND CAST(r.ReturnDate AS DATE) <= CAST(@asOnDate AS DATE)
		GROUP BY sd.ProductID, sd.ColorID
	) sor

	UNION ALL

	SELECT ISNULL(SUM(rep.PurchaseRate), 0) PurchaseRate, 'Replacement' Id FROM
	(
		SELECT 
		SUM(ISNULL(-sd.PRate, 0) * ISNULL(-sod.Quantity, 0)) PurchaseRate FROM SOrders so
		JOIN SOrderDetails sod ON so.SOrderID = sod.SOrderID
		JOIN StockDetails sd ON sod.SDetailID = sd.SDetailID

		WHERE so.ConcernID = @ConcernID AND so.Status = 1 AND sod.RStockDetailId > 0 AND sod.RepOrderID > 0 AND CAST(so.InvoiceDate AS DATE) <= CAST(@asOnDate AS DATE)
		GROUP BY sd.ProductID, sd.ColorID
	) rep

) t1

PIVOT(
		SUM(t1.PurchaseRate)
		FOR t1.Id IN(PO, POReturn, TransferIn, TransferOut, SO, CrSO, SOReturn, Replacement
		)
	) piv
END


--EXEC GetStockValue '2022-08-18', 5126

-------------RAKIB--------------
----------07-02-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[UpdateTotalDueWhenEditNew]
(
	@CusId int,
	@SupId int,
	@CashCollectionID int,
	@NewCollectionAmount DECIMAL(18,2)
)
  
AS 
Declare @Amount decimal
Declare @PreviousCustomerID int,
		@TransactionType INT

BEGIN TRY
BEGIN TRANSACTION

IF(@CusId>0)
BEGIN
    Select @Amount=(Amount+AdjustAmt) from CashCollections where CashCollectionID=@CashCollectionID
	Select @PreviousCustomerID=CustomerID from CashCollections where CashCollectionID=@CashCollectionID
	SELECT @TransactionType = TransactionType from CashCollections where CashCollectionID=@CashCollectionID

	IF @TransactionType = 3
	BEGIN
		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue - @Amount)
		where CustomerID=@PreviousCustomerID



		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + @NewCollectionAmount)
		where CustomerID=@CusId
	END
	ELSE
	BEGIN
		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + @Amount)
		where CustomerID=@PreviousCustomerID

		UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue - @NewCollectionAmount)
		where CustomerID=@CusId
	END

	
END
ELSE IF(@SupId>0)
BEGIN
    Select @Amount=(Amount+AdjustAmt) from CashCollections where CashCollectionID=@CashCollectionID
    Select @PreviousCustomerID=SupplierID from CashCollections where CashCollectionID=@CashCollectionID

	UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue + @Amount)
	where SupplierID=@PreviousCustomerID

	UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - @NewCollectionAmount)
	where SupplierID=@SupId
END

COMMIT

RETURN 1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		RETURN 0;
END CATCH

-------------RAKIB--------------
----------07-02-2023------------
--------------END---------------

-------------RAKIB--------------
----------04-02-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[UpdateTotalDueWhenEditNew]
(
	@CusId int,
	@SupId int,
	@CashCollectionID int,
	@NewCollectionAmount DECIMAL(18,2)
)
  
AS 
Declare @Amount decimal
Declare @PreviousCustomerID int

BEGIN TRY
BEGIN TRANSACTION

IF(@CusId>0)
BEGIN
    Select @Amount=(Amount+AdjustAmt) from CashCollections where CashCollectionID=@CashCollectionID
	Select @PreviousCustomerID=CustomerID from CashCollections where CashCollectionID=@CashCollectionID

	UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue - @Amount)
	where CustomerID=@PreviousCustomerID



	UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + @NewCollectionAmount)
	where CustomerID=@CusId

	
END
ELSE IF(@SupId>0)
BEGIN
    Select @Amount=(Amount+AdjustAmt) from CashCollections where CashCollectionID=@CashCollectionID
    Select @PreviousCustomerID=SupplierID from CashCollections where CashCollectionID=@CashCollectionID

	UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue + @Amount)
	where SupplierID=@PreviousCustomerID

	UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - @NewCollectionAmount)
	where SupplierID=@SupId
END

COMMIT

RETURN 1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		RETURN 0;
END CATCH


-------------RAKIB--------------
----------04-02-2023------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[sp_AddTransferOrder]
(
	@dtTransferOrder ADDTransferTable readonly,
	@dtTransferDetails ADDTransferDetailsTable readonly,
	@dtTransferFromStock InsertTransferStockTable readonly,
	@dtTransferToStock InsertTransferStockTable readonly,
	@ReturnResult int output,
	@ReturnTransferID int Output
)
  
AS 

BEGIN TRY  
 BEGIN TRANSACTION 

 Declare @TransferID int
 Declare @ToConcernID int
 Declare @CreatedBy int
 Declare @CreatedDate Datetime

INSERT INTO Transfers
(
TransferDate,TransferNo,ConcernID,CreateDate,FromConcernID,Remarks,Status,ToConcernID,TotalAmount,CreatedBy
)
(Select TransferDate,TransferNo,ConcernID,CreateDate,FromConcernID,Remarks,Status,ToConcernID,TotalAmount,CreatedBy from @dtTransferOrder)

set  @TransferID = SCOPE_IDENTITY()

set @CreatedBy =ISNULL((select CreatedBy from @dtTransferOrder),0)
set @CreatedDate =ISNULL((select CreateDate from @dtTransferOrder),GETDATE())
set @ToConcernID =ISNULL((select ToConcernID from @dtTransferOrder),0)

INSERT INTO TransferDetails
(
 PRate,ProductID,Quantity,SDetailID,ToColorID,ToGodownID,ToProductID,UTAmount,TransferID,IMEI
)
(
select  UnitPrice,ProductID,Quantity,SDetailID,ToColorID,ToGodownID,ToProductID,UTAmount,@TransferID,IMEI from @dtTransferDetails
)
--*******************Decrease From Godown stocks****************
UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity - t.Quantity),ModifiedDate =  @CreatedDate,ModifiedBy=@CreatedBy
from @dtTransferFromStock t
INNER JOIN Stocks ON Stocks.ProductID =t.ProductID and Stocks.ColorID=t.ColorID and Stocks.GodownID = t.GodownID

UPDATE stockdetails
SET stockdetails.STATUS = 2
FROM @dtTransferDetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.SDetailID
INNER JOIN products ON stockdetails.productid = products.productid
WHERE products.producttype = 1 OR products.producttype = 3

--No barcode product quantity update
--UPDATE stockdetails
--SET Quantity=stockdetails.Quantity-s.Quantity
--FROM @dtTransferDetails s
--INNER JOIN stockdetails ON stockdetails.sdetailid = s.SDetailID
--INNER JOIN products ON stockdetails.productid = products.productid
--WHERE products.producttype = 2


DECLARE @ProductID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @GodownID INT
DECLARE @Quantity DECIMAL(18,2)
DECLARE @SQty DECIMAL(18,2)

DECLARE cur CURSOR LOCAL
FOR
SELECT s.ProductID,
		s.ColorID,
		s.GodownID,
		s.Quantity,
		s.SDetailID
	FROM @dtTransferDetails s
	INNER JOIN products
		ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity > 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)


		IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity
				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				SET @Quantity = 0
			END

			ELSE IF (@SQty < @Quantity)
			BEGIN
				print(@Quantity)
				SET @Quantity = @Quantity - @SQty
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

			END

			ELSE
			BEGIN

				print(@Quantity)
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				SET @Quantity = 0

			END

		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SDetailID

	END


--No barcode product status update
--UPDATE stockdetails
--SET StockDetails.Status=2
--FROM @dtTransferDetails s
--INNER JOIN stockdetails ON stockdetails.sdetailid = s.SDetailID
--INNER JOIN products ON stockdetails.productid = products.productid
--WHERE products.producttype = 2 and StockDetails.Quantity=0

--*******************Decrease From Godown stocks****************

--********************Increase To Godown Stocks******************

UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity + t.Quantity),ModifiedDate = @CreatedDate ,ModifiedBy=@CreatedBy
from @dtTransferToStock t
JOIN Stocks ON Stocks.ProductID =t.ProductID and Stocks.ColorID=t.ColorID and Stocks.GodownID = t.GodownID

INSERT INTO Stocks
(
StockCode, EntryDate, Quantity, ProductID,ColorID,
GodownID,MRPPrice, LPPrice,CreatedBy,CreateDate,ConcernID
)
(Select 
Max(t.StockCode), @CreatedDate,Sum(t.Quantity), t.ToProductID,t.ToColorID,
t.ToGodownID,  Max(t.UnitPrice), Max(t.UnitPrice), @CreatedBy,@CreatedDate,@ToConcernID
from @dtTransferDetails t 
group by t.ToProductID,ToColorID,ToGodownID
having Min(t.StockId)=0
)

INSERT INTO StockDetails
(
StockCode, Quantity, ProductID,ColorID,IMENO,
GodownID,PRate,Status,SRate,CRSalesRate3Month,CreditSRate,CRSalesRate12Month,TransferDetailID,StockID,POrderDetailID
)
(Select 
t.StockCode,t.Quantity, t.ToProductID,t.ToColorID,t.IMEI,
t.ToGodownID,t.UnitPrice,1,t.SRate,t.SRate,t.SRate,t.SRate,td.TDetailID,s.StockID,0
from @dtTransferDetails t 
INNER join Stocks s on s.ProductID = t.ToProductID and s.ColorID=t.ToColorID and s.GodownID = t.ToGodownID
INNER join TransferDetails td on t.ToProductID=td.ToProductID and t.ToColorID=td.ToColorID and t.ToGodownID = td.ToGodownID and td.TransferID=@TransferID and t.IMEI=td.IMEI
)

--********************Increase To Godown Stocks******************
COMMIT

set @ReturnResult= 1;
set @ReturnTransferID= @TransferID;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		set @ReturnResult= 0;
        set @ReturnTransferID= 0;
END CATCH
-------------RAKIB--------------
----------04-02-2023------------
---------------END--------------


-------------Mostafizur---------
----------24-01-2023------------
--------------------------------

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	ConcernNameB nvarchar(MAX) NULL
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

-------------Mostafizur--------------
----------24-01-2023------------
--------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	IsBanglaSmsEnable int NOT NULL CONSTRAINT DF_SystemInformations_IsBanglaSmsEnable DEFAULT ((0))
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

-------------Mostafizur--------------
----------07-01-2023------------
--------------------------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[CheckTransProductStatusByTransDId]
(
  @TransferID int
)  
  RETURNS int
AS 
 BEGIN
	DECLARE	@Sold int
    
    SELECT @Sold = COUNT(*)
	FROM StockDetails
	JOIN TransferDetails TFD ON TFD.TDetailID = StockDetails.TransferDetailID 
	--join Transfers TF on TFD.TransferID = TF.TransferID
	join Products p on TFD.ProductID = p.ProductID
	WHERE p.ProductType <> 2 and TFD.TransferID = @TransferID  AND StockDetails.Status = 2


	IF @Sold IS NULL OR @Sold = 0
		begin
			SET @Sold=0

			set @Sold =  (select ISNULL(COUNT(*), 0) FROM StockDetails sd
			JOIN TransferDetails TFD ON TFD.TDetailID = sd.TransferDetailID 
		--	join Transfers TF on TFD.TransferID = TF.TransferID
		--	JOIN SOrderDetails sod on sod.SDetailID = sd.SDetailID
			join Products p on TFD.ProductID = p.ProductID
			WHERE p.ProductID = 2 and  TFD.TransferID = @TransferID AND sd.Status = 2) 


		end
	  
	  
	RETURN  @Sold
  END

  --select dbo.CheckTransProductStatusByTransDId(44468)
GO





-------------Biplob--------------
----------04-01-2023------------
--------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	IsExpenseHeadEnable int NOT NULL CONSTRAINT DF_SystemInformations_IsExpenseHeadEnable DEFAULT ((0)),
	IsBankEnable int NOT NULL CONSTRAINT DF_SystemInformations_IsBankEnable DEFAULT ((0)),
	IsColorEnable int NOT NULL CONSTRAINT DF_SystemInformations_IsColorEnable DEFAULT ((0))
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

-------------Nahid--------------
----------04-01-2023------------
--------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.CreditInterestPercentages ADD
	EffectDate datetime NULL
GO
ALTER TABLE dbo.CreditInterestPercentages SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

---------------------------------------------------------------------------------------------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec CreditSalesPenaltySchedules 5126

ALTER PROCEDURE [dbo].[CreditSalesPenaltySchedules]
(
@ConcernID int
)
AS
declare @CreditSalesID int
declare @CustomerID int
declare @Status int
declare @StockDetailID int
declare @LastDueScheduleDate Datetime
declare @LastScheduleDate Datetime
declare @DateDiff int
declare @RemainingAmount decimal(18,2)
declare @NoOfInstallment decimal(18,2)
declare @LastPaidScheduleNo decimal(18,2)
declare @PenaltyInterest decimal(18,2)
declare @SalesDate Datetime
declare @ProductRate decimal(18,2)
declare @PrevRemaining decimal(18,2)
declare @PresentRemaining decimal(18,2)
declare @upto Decimal(18,2)
declare @InstallmentAmount Decimal(18,2)
declare @id INT

declare @IntDate Datetime
SET @IntDate = (select EffectDate from CreditInterestPercentages where ConcernID = @ConcernID)

--declare cur CURSOR LOCAL for  select CreditSalesID,SalesDate,Remaining,CustomerID,Status from CreditSales  
-- where ConcernID=@ConcernID and IsStatus=1  and Remaining>0  and Status<2--and CreditSalesID=30912

--open cur
declare cur CURSOR LOCAL for
SELECT t1.CreditSalesID, t1.SalesDate, t1.Remaining, t1.CustomerID, t1.Status FROM
(
	select cs.CreditSalesID,cs.SalesDate,cs.Remaining,cs.CustomerID, Status, css.MonthDate
	, RANK() OVER (PARTITION BY cs.CreditSalesID ORDER BY css.MonthDate DESC) dest_rank
	from CreditSales cs
	join CreditSalesSchedules css on cs.CreditSalesID = css.CreditSalesID
	 where cs.ConcernID=ConcernID and cs.IsStatus=1  and cs.Remaining>0  and cs.Status<2 and css.MonthDate > @IntDate
) t1
WHERE t1.dest_rank =1

open cur

            fetch next from cur into @CreditSalesID,@SalesDate,@RemainingAmount,@CustomerID,@Status

while @@FETCH_STATUS = 0
 BEGIN
 set @PenaltyInterest=0
 set @DateDiff =0
--SET @NoOfInstallment=(Select NoOfInstallment from CreditSales where CreditSalesID=@CreditSalesID)	

set @NoOfInstallment = ISNULL((SELECT SUBSTRING(InstallmentPeriod, 1, CASE CHARINDEX(' ', InstallmentPeriod)
            WHEN 0
                THEN LEN(InstallmentPeriod)
            ELSE CHARINDEX(' ', InstallmentPeriod) - 1
            END) 
FROM CreditSales where CreditSalesID=@CreditSalesID),0)

--Declare @FirstDueScheduleDate date

--SET @LastDueScheduleDate=(Select MAX(MonthDate) from CreditSalesSchedules where CreditSalesID=@CreditSalesID and PaymentStatus='Due')
--SET @FirstDueScheduleDate=DATEADD(MONTH,-1,(Select MIN(MonthDate) from CreditSalesSchedules where CreditSalesID=@CreditSalesID and PaymentStatus='Due'))

--set @DateDiff = ISNULL((SELECT DATEDIFF(DAY,@LastDueScheduleDate,GETDATE())),0)			
--set @LastPaidScheduleNo = ISNULL((select MAX(ScheduleNo) from CreditSalesSchedules where CreditSalesID=@CreditSalesID and PaymentStatus='Paid'),0.00)

-- print (@DateDiff)
SET @LastDueScheduleDate=(Select MAX(MonthDate) from CreditSalesSchedules where CreditSalesID=@CreditSalesID and PaymentStatus='Due')

SET @LastScheduleDate=(Select MAX(MonthDate) from CreditSalesSchedules where CreditSalesID=@CreditSalesID)
IF(@Status=1 and @NoOfInstallment=3) 
BEGIN
 set @LastDueScheduleDate=DATEADD(MOnth,3,@LastDueScheduleDate)
END	
IF(@Status=1 and @NoOfInstallment=12)
BEGIN
 set @LastDueScheduleDate=DATEADD(MOnth,6,@LastDueScheduleDate)
END	
set @DateDiff = ISNULL((SELECT DATEDIFF(DAY,@LastDueScheduleDate, GETDATE())),0)-15				
set @LastPaidScheduleNo = ISNULL((select MAX(ScheduleNo) from CreditSalesSchedules where CreditSalesID=@CreditSalesID and PaymentStatus='Paid'),0.00)

IF(@DateDiff>0)
BEGIN
----------------------cur_GetPenaltyInterest start-----------------------------------------
	declare cur_GetPenaltyInterest CURSOR LOCAL for  select CreditSalesID from CreditSaleDetails 
	where CreditSalesID=@CreditSalesID
	open cur_GetPenaltyInterest
				fetch next from cur_GetPenaltyInterest into @CreditSalesID
	while @@FETCH_STATUS = 0
	 BEGIN
	    declare @ReAmt decimal(18,2)
	    SET @ReAmt = ISNULL((select Remaining from CreditSales where CreditSalesID = @CreditSalesID),0.00)
		declare @IntPer decimal(18,2)
	    SET @IntPer = ISNULL((select Percentage from CreditInterestPercentages where ConcernID = @ConcernID),0.00)
		--PRINT('MRP')
		PRINT(@ReAmt)
		--IF(@Status=0)
		--BEGIN
		--	set @PenaltyInterest +=(10*@ReAmt)/100
		--END
	 --   ELSE IF(@Status=1)
		--BEGIN
		--	set @PenaltyInterest +=(10*@ReAmt)/100
		--END
		IF((@NoOfInstallment=3 OR @NoOfInstallment=12) and @Status=0)
		BEGIN
			set @PenaltyInterest +=(@IntPer*@ReAmt)/100
		END
	    ELSE IF((@NoOfInstallment=6  and @Status=0) OR(@NoOfInstallment=3  and @Status=1))
		BEGIN
			set @PenaltyInterest +=(@IntPer*@ReAmt)/100
		END
		ELSE IF(@NoOfInstallment=6  and @Status=1)
		BEGIN
			set @PenaltyInterest +=(@IntPer*@ReAmt)/100
		END
		fetch next from cur_GetPenaltyInterest into @CreditSalesID
	END
	  close cur_GetPenaltyInterest
      deallocate cur_GetPenaltyInterest
----------------------cur_GetPenaltyInterest end-----------------------------------------
	set @PrevRemaining = ISNULL((select Remaining from CreditSales where CreditSalesID=@CreditSalesID),0.00);
	set @PresentRemaining = (@PrevRemaining + @PenaltyInterest)
	declare @DueInstallmentCount int
	SET @DueInstallmentCount = (select ISNULL(count(*),0) from CreditSalesSchedules where CreditSalesID=@CreditSalesID and PaymentStatus='Due')
	Set @Upto=3+@DueInstallmentCount
	Set @InstallmentAmount=Convert(Decimal,ISNULL(@PresentRemaining,0.0))/@Upto
	Set @id=1
       delete from CreditSalesSchedules where CreditSalesID=@CreditSalesID and PaymentStatus='Due'
		WHILE @id<= @Upto
		BEGIN

		insert into CreditSalesSchedules(MonthDate,Balance,InstallmentAmt,PaymentDate,CreditSalesID,PaymentStatus,InterestAmount,ClosingBalance,ScheduleNo,Remarks,IsUnExpected) VAlues
		(DATEADD(month,@id, @LastDueScheduleDate),@InstallmentAmount*(@Upto-(@id-1)),@InstallmentAmount,DATEADD(month,@id, @LastDueScheduleDate),@CreditSalesID,'Due',ISNUll(0,0.0),@InstallmentAmount*(@Upto-(@id-1))-@InstallmentAmount,@LastPaidScheduleNo+@id,'Penalty amount added by System',1)
									
		set @id=@id+1;

		END

		update CreditSales set PenaltyInterest=PenaltyInterest+	Convert(decimal,ISNULL(@PenaltyInterest,0)) where CreditSalesID=@CreditSalesID
		update CreditSales set Status=Status+1,Remaining=@PresentRemaining where CreditSalesID=@CreditSalesID
		Update Customers set CreditDue=(CreditDue-@PrevRemaining)+@PresentRemaining where CustomerID= @CustomerID
		
		--print ('============Success CreditSID: '+Convert(varchar,@CreditSalesID)+'=============')
	 --   print (@DateDiff)
		--print (@PenaltyInterest)
		--print (@PrevRemaining)
		--print (@PresentRemaining)
		--print (@NoOfInstallment)
END
  fetch next from cur into @CreditSalesID,@SalesDate,@RemainingAmount,@CustomerID,@Status
 END

-------------Nahid--------------
----------27-12-2022------------
--------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	IsAutoCreditInterestPer int NOT NULL CONSTRAINT DF_SystemInformations_IsAutoCreditInterestPer DEFAULT ((0))
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

------------------------------------------------------------------------------------------


/****** Object:  Table [dbo].[CreditInterestPercentages]    Script Date: 27-Dec-22 01:56:42 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[CreditInterestPercentages](
	[IntPercentageID] [int] IDENTITY(1,1) NOT NULL,
	[Code] [varchar](50) NOT NULL,
	[Percentage] [decimal](18, 2) NOT NULL,
	[ConcernID] [int] NOT NULL,
 CONSTRAINT [PK_CreditInterestPercentages] PRIMARY KEY CLUSTERED 
(
	[IntPercentageID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[CreditInterestPercentages] ADD  CONSTRAINT [DF_CreditInterestPercentages_Percentage]  DEFAULT ((0)) FOR [Percentage]
GO

ALTER TABLE [dbo].[CreditInterestPercentages]  WITH CHECK ADD  CONSTRAINT [FK_CreditInterestPercentages_SisterConcerns] FOREIGN KEY([ConcernID])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[CreditInterestPercentages] CHECK CONSTRAINT [FK_CreditInterestPercentages_SisterConcerns]
GO




-------------Biplob--------------
--------11-10-2022-------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER FUNCTION [dbo].[CheckProductStatusByPOId]
(
  @PurchaseOrderId int
)  
  RETURNS int
AS 
 BEGIN
	DECLARE	@Sold int
    
    SELECT @Sold = COUNT(*)
	FROM StockDetails
	JOIN POrderDetails POD ON POD.POrderDetailID = StockDetails.POrderDetailID 
	join POrders PO on POD.POrderID = PO.POrderID
	join Products p on POD.ProductID = p.ProductID
	WHERE p.ProductType <> 2 and POD.POrderID = @PurchaseOrderId AND StockDetails.Status = 2


	
	
	IF @Sold IS NULL OR @Sold = 0
		begin
			SET @Sold=0

			set @Sold =  (select ISNULL(COUNT(*), 0) FROM StockDetails sd
			JOIN POrderDetails POD ON POD.POrderDetailID = sd.POrderDetailID 
			join POrders PO on POD.POrderID = PO.POrderID
			JOIN SOrderDetails sod on sod.SDetailID = sd.SDetailID
			join Products p on POD.ProductID = p.ProductID
			WHERE p.ProductType = 2 and POD.POrderID = @PurchaseOrderId)


		end
	  
	  
	RETURN  @Sold
  END

  --select dbo.CheckProductStatusByPOId(76903)

-------------Biplob--------------
--------11-10-2022-------------
--------------------------------
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[GetCategorywiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) - ISNULL(piv.SalesReturn, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales, 0)) - ISNULL(piv.SalesReturn, 0)) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue',
		ISNULL(piv.InterestAmount, 0) as TInterestAmount,
		ISNULL(piv.CrInterestAmount, 0) as CrInterestAmount



	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL



	--start here 



	-- end here

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL




	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 



	 AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(Cri.InterestAmount, 0)), 0) PrevSales, 'CrInterestAmount' Id, c.CustomerID FROM CreditSales Cri
	JOIN Customers c ON Cri.CustomerID = c.CustomerID
	WHERE Cri.ConcernID = @ConcernID 
	AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales, SalesReturn, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn, InterestAmount, CrInterestAmount

		)
	) piv
 END


 --EXEC GetCategorywiseCustomerDue 16, 165540

-------------Biplob--------------
--------11-10-2022-------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[GetCategorywiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) - ISNULL(piv.SalesReturn, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales, 0)) - ISNULL(piv.SalesReturn, 0)) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue',
		piv.InterestAmount as TInterestAmount

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.InterestAmt, 0)), 0) PrevSales, 'InterestAmount' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(1) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales, SalesReturn, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn, InterestAmount

		)
	) piv
 END


 --EXEC GetCategorywiseCustomerDue 16, 152589



-------------Rakib--------------
--------11-10-2022-------------
--------------------------------

ALTER Table CREDITSales Add
ReturnDate Datetime NULL
--------------------------------
--------11-10-2022-------------
-----------END------------------

--------------------------------
--------11-10-2022-------------
--------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--------------------------------------------------------------------------------------------------------------------

CREATE PROC [dbo].[GetLoanPayableAndReceivable]
(
	@asOnDate DATETIME,
	@ConcernID INT

)
  
AS 
BEGIN
	DECLARE @AllTakeLoan DECIMAL(18,2) = NULL,
		@AllLoanPayment DECIMAL(18,2) = NULL,
		@AllGivenLoan  DECIMAL(18,2) = NULL,
		@AllLoanCollection DECIMAL(18,2) = NULL

	SET @AllTakeLoan = (
							SELECT SUM(Amount) FROM ShareInvestments WHERE LiabilityType = 1 
							AND ConcernID = @ConcernID
							AND CAST(EntryDate as DATE) <= CAST(@asOnDate AS DATE)
					   )

	SET @AllLoanPayment = (
							SELECT SUM(Amount) FROM ShareInvestments WHERE LiabilityType = 4 
							AND ConcernID = @ConcernID
							AND CAST(EntryDate as DATE) <= CAST(@asOnDate AS DATE)
						)

	SET @AllGivenLoan = (
							SELECT SUM(Amount) FROM ShareInvestments WHERE LiabilityType = 3 
							AND ConcernID = @ConcernID
							AND CAST(EntryDate as DATE) <= CAST(@asOnDate AS DATE)
						)

	SET @AllLoanCollection = (
								SELECT SUM(Amount) FROM ShareInvestments WHERE LiabilityType = 2 
								AND ConcernID = @ConcernID
								AND CAST(EntryDate as DATE) <= CAST(@asOnDate AS DATE)
							)

	SELECT (ISNULL(@AllTakeLoan, 0) - ISNULL(@AllLoanPayment, 0)) AS TotalPayable, (ISNULL(@AllGivenLoan, 0) - ISNULL(@AllLoanCollection, 0)) AS TotalReceivable
END


--EXEC GetLoanPayableAndReceivable '2022-10-11', 5126


--------------------------------
--------10-10-2022-------------
--------------------------------
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROC [dbo].[GetCategorywiseCustomerDue]
(
		@concernId INT
		,@CustomerID INT
)
  
AS 
 BEGIN 
	 SELECT 
		piv.CustomerID,
		(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.TotalSales, 0) + ISNULL(piv.CashCollectionReturn, 0) - ISNULL(piv.SalesReturn, 0)) - (ISNULL(piv.CashCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + ISNULL(piv.Adjustment, 0) + ISNULL(piv.[Return], 0)) 'SalesDue',
		ISNULL(piv.TotalCrSales, 0) - (ISNULL(piv.DownPayment, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.CrAdjustment, 0)) 'HireDue',
		
		CAST((
			(ISNULL(piv.OpeningDue, 0) + ISNULL(piv.CashCollectionReturn, 0))
			 + 
			(
				((ISNULL(piv.TotalSales, 0) + ISNULL(piv.TotalCrSales, 0)) - ISNULL(piv.SalesReturn, 0)) - 
				(ISNULL(piv.DownPayment, 0) + ISNULL(piv.CashCollection, 0) + ISNULL(piv.InstallmentCollection, 0) + ISNULL(piv.BankCollection, 0) + ISNULL(piv.RecAmount, 0) - ISNULL(piv.SalesReturnCashBack, 0) + (ISNULL(piv.Adjustment, 0) + ISNULL(piv.CrAdjustment, 0)) + ISNULL(piv.[Return], 0))
			)
		) AS DECIMAL(18, 2)) 'TotalDue'

	FROM
	(
	SELECT SUM(ISNULL(c.OpeningDue, 0)) PrevSales, 'OpeningDue' Id, c.CustomerID FROM Customers c 
	WHERE c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID, c.Address
	UNION ALL

	SELECT SUM(ISNULL(s.TotalAmount, 0)) PrevSales, 'TotalSales' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 1
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID
	
	UNION ALL
	SELECT SUM(ISNULL(cs.NetAmount, 0)) PrevSales, 'TotalCrSales' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(s.TotalAmount, 0)), 'SalesReturn' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 4 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)) PrevSales, 'RecAmount' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	AND s.Status = 1 
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cs.DownPayment, 0)), 0) PrevSales, 'DownPayment' Id, c.CustomerID FROM CreditSales cs
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1
	--AND CAST(cs.SalesDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollection' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID
	AND cc.TransactionType =1 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.InstallmentAmt, 0)), 0) PrevSales, 'InstallmentCollection' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cs.IsStatus = 1 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(bt.Amount, 0)), 0) PrevSales, 'BankCollection' Id, c.CustomerID FROM BankTransactions bt
	JOIN Customers c ON bt.CustomerID = c.CustomerID
	WHERE bt.ConcernID = @ConcernID 
	AND bt.TransactionType = 3 AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(bt.TranDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL

	SELECT SUM(ISNULL(s.RecAmount, 0)), 'SalesReturnCashBack' Id, c.CustomerID FROM SOrders s
	JOIN Customers c ON s.CustomerID = c.CustomerID
	WHERE s.ConcernID = @ConcernID AND s.Status = 4 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(s.InvoiceDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(css.LastPayAdjust, 0)), 0) PrevSales, 'CrAdjustment' Id, c.CustomerID FROM CreditSales cs
	JOIN CreditSalesSchedules css ON cs.CreditSalesID = css.CreditSalesID
	JOIN Customers c ON cs.CustomerID = c.CustomerID
	WHERE cs.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND css.PaymentStatus = 'Paid'
	--AND CAST(css.PaymentDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT SUM(ISNULL(cc.AdjustAmt, 0)) PrevSales, 'Adjustment' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0 AND cc.TransactionType IN(1)
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(r.GrandTotal - r.PaidAmount), 0), 'Return', c.CustomerID FROM ROrders r
	JOIN Customers c ON r.CustomerID = c.CustomerID
	WHERE r.ConcernID = @ConcernID
	AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(r.ReturnDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID

	UNION ALL
	SELECT ISNULL(SUM(ISNULL(cc.Amount, 0)), 0) PrevSales, 'CashCollectionReturn' Id, c.CustomerID FROM CashCollections cc
	JOIN Customers c ON cc.CustomerID = c.CustomerID
	WHERE cc.ConcernID = @ConcernID 
	AND cc.TransactionType IN(3) AND c.ConcernID = @ConcernID AND c.CreditDue + c.TotalDue  != 0
	--AND CAST(cc.EntryDate AS DATE) BETWEEN CAST(@fromDate AS DATE) AND CAST(@asOnDate AS DATE)
	AND (@CustomerID = 0 OR c.CustomerID = @CustomerID)
	GROUP BY c.CustomerID


	) t1

	PIVOT(
		SUM(t1.PrevSales)
		FOR t1.Id 
		IN(
			OpeningDue,TotalSales, TotalCrSales, SalesReturn, RecAmount, DownPayment, CashCollection, 
			InstallmentCollection, BankCollection, SalesReturnCashBack, CrAdjustment, Adjustment,
			[Return], CashCollectionReturn

		)
	) piv
 END


 --EXEC GetCategorywiseCustomerDue 5126, 74266


--------------------------------
--------10-10-2022-------------
--------------------------------

ALTER TABLE CashCollections
ALTER COLUMN Amount DECIMAL(18,2)

--------------END---------------
--------10-10-2022-------------
--------------------------------


--------------------------------
--------20-Sep-2022-------------
--------------------------------

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	CompanyURL nvarchar(MAX) NULL
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
--------------------------------
--------25-Jul-2022-------------
--------------------------------

/****** Object:  View [dbo].[vw_ProductPicker]    Script Date: 25-Jul-22 11:06:46 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

Alter view [dbo].[vw_ProductPicker] as
Select P.Code'ProductCode',P.ProductName,G.Name'GodownName', CL.Name'ColorName', CA.Description'CategoryName', SD.IMENO, SD.SRate'MRPRate',P.ConcernID,P.ProductID,S.ColorID,S.GodownID,P.CategoryID,P.CompanyID,SD.SDetailID'StockDetailsId',S.StockID,CM.Name'CompanyName', SD.PRate'PRate',SD.Quantity'PreStock'
From Products P
Inner Join Companies CM on CM.CompanyID=P.CompanyID and P.ConcernID=CM.ConcernID
Inner Join Categorys CA on CA.CategoryID=P.CategoryID and CA.ConcernID=P.ConcernID
Inner Join StockDetails SD on SD.ProductID=P.ProductID
Inner join Stocks S on S.StockID = SD.StockID and P.ConcernID = S.ConcernID
Inner Join Godowns G on SD.GodownID = G.GodownID and G.ConcernID = S.ConcernID
Inner Join Colors CL on CL.ColorID = SD.ColorID and CL.ConcernID = S.ConcernID
where SD.Status=1
--and S.ConcernID = 5126 Order By CA.CategoryID
GO



--------------------------------
--------15-Jun- 2021-------------
--------------------------------


SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

Create view [dbo].[vw_StockReportWithDays] as
select PO.ChallanNo,CA.Description,P.ProductName,SD.IMENO,Date= PO.OrderDate,
NoOfDate = DATEDIFF(d, OrderDate, GETDATE()),PO.ConcernID,P.ProductID,SD.Status
from POrders PO 
Inner Join POrderDetails POD on PO.POrderID=POD.POrderID
Inner Join Products P on P.ProductID=POD.ProductID and P.ConcernID=P.ConcernID
Inner Join Categorys CA on CA.CategoryID=P.CategoryID and CA.ConcernID=P.ConcernID
Inner Join StockDetails SD on SD.POrderDetailID=POD.POrderDetailID
where SD.Status=1
--PO.ConcernID=1 and
union
select TS.TransferNo,CA.Description,P.ProductName,SD.IMENO,Date= TS.TransferDate,
NoOfDate = DATEDIFF(d, TransferDate, GETDATE()),TS.ToConcernID as ConcernID,P.ProductID,SD.Status
from Transfers TS
Inner Join TransferDetails TSD on TS.TransferID=TSD.TransferID
Inner Join Products P on P.ProductID=TSD.ToProductID and P.ConcernID=P.ConcernID
Inner Join Categorys CA on CA.CategoryID=P.CategoryID and CA.ConcernID=P.ConcernID
Inner Join StockDetails SD on SD.TransferDetailID=TSD.TDetailID
where SD.Status=1 and SD.TransferDetailID !=0
--TS.ToConcernID=1 and 
GO




--------------------------------
--------15-Jun- 2021-------------
--------------------------------
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

Create PROCEDURE [dbo].[SP_getStockDataWithDays] (
	@concernId int, 
	@productId int
)
AS
	IF @productId>0
	BEGIN
	  Select * from vw_StockReportWithDays where ConcernID=@concernId and ProductID=@productId
	END
	ELSE
	BEGIN
	  Select * from vw_StockReportWithDays where ConcernID=@concernId
	END
GO




--------------------------------
--------30-Mar-2021-------------
--------------------------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

--exec SP_StockForcastingReportProductWise '1 Jan 2021 12:00:00 AM','31 Dec 2021 11:59:59 PM','202'
CREATE PROCEDURE [dbo].[SP_StockForcastingReportProductWise](@FromDate DATETIME, @ToDate DATETIME, @ProductID INT)
AS
BEGIN


Create Table #temp (ID INT identity(1, 1) NOT NULL,ConcernName NVARCHAR(MAX), ProductName NVARCHAR(MAX), ProductID INT, SMonth INT, MonthSalesQty DECIMAL(18, 2), AverageSalesQty DECIMAL(18, 2), PresentStockQty DECIMAL(18, 2), NeedSalesQty DECIMAL(18, 2), CompanyID INT, CategoryID INT, SYear INT)

Insert Into #temp (ConcernName, ProductName,ProductID,SMonth,MonthSalesQty,AverageSalesQty,PresentStockQty,NeedSalesQty,CompanyID,CategoryID, SYear)
--Select * from
(select  SC.Name, P.ProductName,SOD.ProductID,Month(SO.InvoiceDate) as SMonth,sum(SOD.Quantity) as MonthSalesQty,0.00,0.00,0.00,P.CompanyID,P.CategoryID,YEAR(InvoiceDate) as SYear from SOrders SO
inner join SOrderDetails SOD on SO.SOrderID=SOD.SOrderID
inner join Products P on P.ProductID=SOD.ProductID
inner join SisterConcerns SC on SC.ConcernID=SO.ConcernID
where SO.InvoiceDate >= @FromDate and SO.InvoiceDate <=@ToDate and SOD.ProductID IN
(select ProductID from Products where ProductName in(select ProductName from Products where ProductID=@ProductID))
group by SC.Name, P.ProductName,SOD.ProductID,Month(SO.InvoiceDate),P.CompanyID, P.CategoryID, Year(SO.InvoiceDate))
--T
--order by T.ConcernID,T.SMonth asc


	SELECT ConcernName, ProductName,ProductID,SMonth,MonthSalesQty,AverageSalesQty,PresentStockQty,NeedSalesQty,CompanyID,CategoryID, SYear
	FROM #temp



END
GO




--------------------------------
--------30-Mar-2021-------------
--------------------------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

--exec SP_StockForcastingReport '1 Apr 2021 12:00:00 AM','1 Mar 2022 11:59:59 PM','5'
CREATE PROCEDURE [dbo].[SP_StockForcastingReport](@FromDate DATETIME, @ToDate DATETIME, @ConcernID INT)
AS
BEGIN


Create Table #temp (ID INT identity(1, 1) NOT NULL, CategoryName NVARCHAR(MAX),ProductName NVARCHAR(MAX), ProductID INT, SMonth INT, MonthSalesQty DECIMAL(18, 2), AverageSalesQty DECIMAL(18, 2), PresentStockQty DECIMAL(18, 2), NeedSalesQty DECIMAL(18, 2), CompanyID INT, CategoryID INT, SYear INT)

Insert Into #temp (CategoryName,ProductName,ProductID,SMonth,MonthSalesQty,AverageSalesQty,PresentStockQty,NeedSalesQty,CompanyID,CategoryID, SYear)
--Select * from
(select C.Description as CategoryName,P.ProductName,SOD.ProductID,Month(SO.InvoiceDate) as SMonth,sum(SOD.Quantity) as MonthSalesQty,0.00,0.00,0.00,P.CompanyID,P.CategoryID,YEAR(InvoiceDate) as SYear  from SOrders SO
inner join SOrderDetails SOD on SO.SOrderID=SOD.SOrderID
inner join Products P on P.ProductID=SOD.ProductID
inner join Categorys C on C.CategoryID=P.CategoryID
inner join Companies CP on CP.CompanyID = P.CompanyID
where SO.ConcernID=@ConcernID and SO.InvoiceDate >= @FromDate and SO.InvoiceDate <=@ToDate
group by C.Description,P.ProductName,SOD.ProductID,Month(SO.InvoiceDate),P.CompanyID, P.CategoryID,Year(SO.InvoiceDate))
--T
--order by T.ProductID,T.SMonth asc


	SELECT CategoryName,ProductName,ProductID,SMonth,MonthSalesQty,AverageSalesQty,PresentStockQty,NeedSalesQty,CompanyID,CategoryID, SYear
	FROM #temp



END
GO



--------------------------------
--------30-Mar-2021-------------
--------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.CreditSales ADD
	IsWeekly int NOT NULL CONSTRAINT DF_CreditSales_IsWeekly DEFAULT ((0))
GO
ALTER TABLE dbo.CreditSales SET (LOCK_ESCALATION = TABLE)
GO
COMMIT


----------------------------------------------------------
/****** Object:  UserDefinedTableType [dbo].[InsertCreditSalesOrderTable]    Script Date: 29-Mar-22 06:36:49 PM ******/
CREATE TYPE [dbo].[InsertCreditSalesOrderTable] AS TABLE(
	[InvoiceNo] [varchar](150) NULL,
	[CustomerID] [int] NULL,
	[TSalesAmt] [money] NULL,
	[NoOfInstallment] [int] NULL,
	[InstallmentPrinciple] [money] NULL,
	[IssueDate] [datetime] NULL,
	[UserName] [varchar](250) NULL,
	[Remaining] [money] NULL,
	[InterestRate] [decimal](6, 2) NULL,
	[InterestAmount] [decimal](18, 2) NULL,
	[SalesDate] [datetime] NULL,
	[DownPayment] [money] NULL,
	[WInterestAmt] [money] NULL,
	[FixedAmount] [money] NULL,
	[IsStatus] [int] NULL,
	[UnExInstallment] [int] NULL,
	[Quantity] [int] NULL,
	[Discount] [money] NULL,
	[NetAmount] [money] NULL,
	[IsUnExpected] [bit] NULL,
	[Remarks] [varchar](max) NULL,
	[Status] [bit] NULL,
	[VatPercentage] [decimal](18, 2) NULL,
	[VatAmount] [decimal](18, 2) NULL,
	[TotalDue] [money] NULL,
	[ConcernId] [int] NULL,
	[CreatedBy] [int] NULL,
	[CreateDate] [datetime] NULL,
	[TotalOffer] [decimal](18, 2) NULL,
	[InstallmentPeriod] [varchar](max) NULL,
	[CardPaidAmount] [decimal](18, 2) NULL,
	[CardTypeSetupID] [int] NULL,
	[DepositChargePercent] [decimal](18, 2) NULL,
	[IsWeekly] [int] Not NULL
)
GO

Drop Type InsertCreditSalesOrderTable

Drop Proc AddCreditSalesOrder

Drop Proc AddPendingCreditSalesOrder

Drop Proc ApprovedCreditSalesOrder

---------------------------------------------------------------

/****** Object:  StoredProcedure [dbo].[AddCreditSalesOrder]    Script Date: 30-Mar-22 04:32:48 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

------------------------------------------------------
Create PROCEDURE [dbo].[AddCreditSalesOrder] (
@CSalesOrder [dbo].[INSERTCREDITSALESORDERTABLE] readonly, 
@CSODetails [INSERTCSODETAILTABLE] readonly,
@CSSchedules [INSERTCSSCHEDULESTABLE] readonly,
@BankTrans [InsertBankTransTable] readonly)
AS
DECLARE @CreditSalesId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY  
 BEGIN TRANSACTION 

-----------------Card Payment Bank Deposit--------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @CSalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

------------------Card Payment Bank Deposit--------------

INSERT INTO creditsales (invoiceno, customerid, tsalesamt, noofinstallment,
 intallmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamt, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,BankTransID, IsWeekly)
(SELECT
 invoiceno, customerid, tsalesamt, noofinstallment, 
 installmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamount, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,@BankTransID, IsWeekly FROM @CSalesOrder)

UPDATE customers
SET customers.CreditDue = (customers.CreditDue + s.totaldue)
FROM @CSalesOrder s
INNER JOIN customers ON customers.customerid = s.customerid

SET @CreditSalesId = Scope_identity()

INSERT INTO CreditSaleDetails 
( 
ProductID ,UnitPrice, Quantity, UTAmount, CreditSalesID,  
MPRateTotal, MPRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,Compressor,Motor,
Panel,Spareparts,Service
) 
( 
Select sd.ProductID ,UnitPrice, Quantity, UTAmount, @CreditSalesId CreditSalesID,  
MPRateTotal, MrpRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,p.CompressorWarrentyMonth,p.MotorWarrentyMonth,
p.PanelWarrentyMonth,p.SparePartsWarrentyMonth,p.ServiceWarrentyMonth from @CSODetails sd
join Products p on sd.ProductID=p.ProductID 
where p.ProductType!=2
) 

UPDATE stocks
SET stocks.quantity = (stocks.quantity - s.quantity)
FROM @CSODetails s
INNER JOIN stocks ON stocks.productid = s.productid AND stocks.colorid = s.colorid AND Stocks.GodownID=s.Compressor

UPDATE StockDetails 
SET StockDetails.Status = 2 
from @CSODetails s 
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId 
join Products on StockDetails.ProductID = Products.ProductID 
where Products.ProductType!=2 

--***************FIFO for Nobarcode Product**********************
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @CreditSaleProductsID INT
DECLARE @Quantity INT
DECLARE @SQty INT
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL
FOR
SELECT s.productid, s.colorid, s.quantity, creditsalesdetailsid
-- from   InsertCSODetailTable SOD join CreditSales SO on SO.CreditSalesID=SOD.CreditSalesID where SO.Status=1
FROM @CSODetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.stockdetailid
INNER JOIN products ON stockdetails.productid = products.productid
where Products.ProductType=2 
OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID

WHILE @@FETCH_STATUS = 0
BEGIN
	WHILE @Quantity != 0
	BEGIN
		SET @SDetailID = (
				SELECT Min(sdetailid)
				FROM stockdetails
				WHERE productid = @ProductID AND colorid = @ColorID AND quantity != 0 AND STATUS = 1
				)
		SET @SQty = (
				SELECT quantity
				FROM stockdetails
				WHERE sdetailid = @SDetailID
				)

		IF (@SQty > @Quantity)
		BEGIN
			SET @SQty = @SQty - @Quantity

			UPDATE stockdetails
			SET quantity = @SQty
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service)
			 (SELECT sd.productid, unitprice, @Quantity, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID  =@CreditSaleProductsID
			SET @Quantity = 0
		END
		ELSE IF (@SQty < @Quantity)
		BEGIN
			SET @Quantity = @Quantity - @SQty

			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service) (SELECT sd.productid, unitprice, @SQty, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)
				--update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
		END
		ELSE
		BEGIN
			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (
			productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate,
			 stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service
			 ) 
			 (SELECT 
			  sd.productid, unitprice, @SQty, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate,
			  @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, 
			  p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd 
			  INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID
			  )

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
			SET @Quantity = 0
		END
	END

	FETCH NEXT
	FROM cur
	INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID
END

INSERT INTO creditsalesschedules (monthdate, balance, installmentamt, 
paymentdate, creditsalesid, paymentstatus, interestamount, closingbalance,
 scheduleno, remarks, isunexpected, hirevalue, netvalue)
(SELECT monthdate, balance, installmentamt,
 paymentdate, @CreditSalesId CreditSalesID, paymentstatus, interestamount, closingbalance,
  scheduleno, remarks, isunexpected, hirevalue, netvalue FROM @CSSchedules)

COMMIT
RETURN 1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		RETURN 0;
END CATCH

----------------------------------------------------------------------------------------------------------


/****** Object:  StoredProcedure [dbo].[AddPendingCreditSalesOrder]    Script Date: 30-Mar-22 04:32:42 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
Create PROCEDURE [dbo].[AddPendingCreditSalesOrder] (
	@CSalesOrder [dbo].[INSERTCREDITSALESORDERTABLE] readonly,
	@CSODetails [INSERTCSODETAILTABLE] readonly,
	@CSSchedules [INSERTCSSCHEDULESTABLE] readonly
	)
AS
DECLARE @CreditSalesId INT

BEGIN TRY
	BEGIN TRANSACTION

	INSERT INTO creditsales (
		invoiceno,
		customerid,
		tsalesamt,
		noofinstallment,
		intallmentprinciple,
		issuedate,
		username,
		remaining,
		interestrate,
		interestamount,
		salesdate,
		downpayment,
		winterestamt,
		fixedamt,
		isstatus,
		unexinstallment,
		quantity,
		discount,
		netamount,
		isunexpected,
		remarks,
		vatpercentage,
		vatamount,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		installmentperiod,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		IsWeekly
		
		) (
		SELECT invoiceno,
		customerid,
		tsalesamt,
		noofinstallment,
		installmentprinciple,
		issuedate,
		username,
		remaining,
		interestrate,
		interestamount,
		salesdate,
		downpayment,
		winterestamt,
		fixedamount,
		5,---pending status
		unexinstallment,
		quantity,
		discount,
		netamount,
		isunexpected,
		remarks,
		vatpercentage,
		vatamount,
		Status,
		concernid,
		createdby,
		createdate,
		totaloffer,
		installmentperiod,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		IsWeekly
		
		FROM @CSalesOrder
		)

	SET @CreditSalesId = Scope_identity()

	INSERT INTO CreditSaleDetails (
		ProductID,
		UnitPrice,
		Quantity,
		UTAmount,
		CreditSalesID,
		MPRateTotal,
		MPRate,
		StockDetailID,
		PPOffer,
		IntPercentage,
		IntTotalAmt,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service
		
		) (
		SELECT sd.ProductID,
		UnitPrice,
		Quantity,
		UTAmount,
		@CreditSalesId CreditSalesID,
		MPRateTotal,
		MrpRate,
		StockDetailID,
		PPOffer,
		IntPercentage,
		IntTotalAmt,
		p.CompressorWarrentyMonth,
		p.MotorWarrentyMonth,
		p.PanelWarrentyMonth,
		p.SparePartsWarrentyMonth,
		p.ServiceWarrentyMonth
		
		 FROM @CSODetails sd INNER JOIN Products p ON sd.ProductID = p.ProductID 
		--WHERE p.ProductType != 2
		)

	INSERT INTO creditsalesschedules (
		monthdate,
		balance,
		installmentamt,
		paymentdate,
		creditsalesid,
		paymentstatus,
		interestamount,
		closingbalance,
		scheduleno,
		remarks,
		isunexpected,
		hirevalue,
		netvalue
		
		) (
		SELECT monthdate,
		balance,
		installmentamt,
		paymentdate,
		@CreditSalesId CreditSalesID,
		paymentstatus,
		interestamount,
		closingbalance,
		scheduleno,
		remarks,
		isunexpected,
		hirevalue,
		netvalue
		FROM @CSSchedules
		)

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	RETURN 0;
END CATCH

---------------------------------------------------------------------------------------------------


/****** Object:  StoredProcedure [dbo].[ApprovedCreditSalesOrder]    Script Date: 30-Mar-22 04:33:38 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
Create PROCEDURE [dbo].[ApprovedCreditSalesOrder] (
	@CSalesOrder [dbo].[INSERTCREDITSALESORDERTABLE] readonly,
	@CSODetails [INSERTCSODETAILTABLE] readonly,
	@CSSchedules [INSERTCSSCHEDULESTABLE] readonly,
	@BankTrans [InsertBankTransTable] readonly,
	@CreditSalesId int 
	)
AS
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY
	BEGIN TRANSACTION

	-----------------Card Payment Bank Deposit--------------
	SET @BankTransID=0
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM CreditSales where CreditSalesID=@CreditSalesId
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
			INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

	------------------Card Payment Bank Deposit--------------
	DECLARE @ModifiedDate DATETIME
	DECLARE @ModifiedBy INT

	SET @ModifiedDate = ISNULL((
				SELECT CreateDate
				FROM @CSalesOrder
				), GETDATE())
	SET @ModifiedBy = ISNULL((
				SELECT CreatedBy
				FROM @CSalesOrder
				), 0)

	UPDATE CreditSales
	SET IsSTATUS = 1,
		BankTransID=@BankTransID,
		ModifiedDate = @ModifiedDate,
		ModifiedBy = @ModifiedBy
	WHERE CreditSalesID = @CreditSalesId and  IsSTATUS = 5

	UPDATE customers
	SET customers.CreditDue = (customers.CreditDue + s.Remaining)
	FROM @CSalesOrder s
	INNER JOIN customers ON customers.customerid = s.customerid

   --Delete Only Nobarcode products
	DELETE  sod
	from CreditSaleDetails sod
	join Products p on sod.ProductID = p.ProductID
	WHERE CreditSalesID = @CreditSalesId and P.ProductType = 2

	--Stock Update 
	CREATE TABLE #tmpStock (
		ProductID INT,
		ColorID INT,
		GodownID INT,
		Qty DECIMAL(18, 2)
		)

	INSERT INTO #tmpStock (
		ProductID,
		ColorID,
		GodownID,
		Qty
		) (
		SELECT s.ProductID,
		s.ColorID,
		s.Compressor,
		SUM(s.Quantity) FROM @CSODetails s 
		GROUP BY s.ProductId,
		s.ColorId,
		s.Compressor
		)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st
		ON st.ProductID = sod.ProductID AND st.ColorID = sod.ColorID AND st.GodownID = sod.GodownID


	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @CSODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON StockDetails.ProductID = Products.ProductID
	WHERE Products.ProductType != 2

	--***************FIFO for Nobarcode Product**********************
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @CreditSaleProductsID INT
	DECLARE @Quantity INT
	DECLARE @SQty INT
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.productid,
		s.colorid,
		s.quantity,
		creditsalesdetailsid
	-- from   InsertCSODetailTable SOD join CreditSales SO on SO.CreditSalesID=SOD.CreditSalesID where SO.Status=1
	FROM @CSODetails s
	INNER JOIN stockdetails ON stockdetails.sdetailid = s.stockdetailid
	INNER JOIN products ON stockdetails.productid = products.productid
	WHERE Products.ProductType = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@Quantity,
		@CreditSaleProductsID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity != 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND quantity != 0 AND STATUS = 1
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)

			IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity

				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				INSERT INTO creditsaledetails (
					productid,
					unitprice,
					quantity,
					utamount,
					creditsalesid,
					mpratetotal,
					mprate,
					stockdetailid,
					ppoffer,
					intpercentage,
					inttotalamt,
					compressor,
					motor,
					panel,
					spareparts,
					service
					
					) (
					SELECT sd.productid,
					unitprice,
					@Quantity,
					utamount,
					@CreditSalesId CreditSalesID,
					mpratetotal,
					mrprate,
					@SDetailID,
					ppoffer,
					intpercentage,
					inttotalamt,
					p.compressorwarrentymonth,
					p.motorwarrentymonth,
					p.panelwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth

					FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID
					)

				-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID  =@CreditSaleProductsID
				SET @Quantity = 0
			END
			ELSE IF (@SQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @SQty

				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO creditsaledetails (
					productid,
					unitprice,
					quantity,
					utamount,
					creditsalesid,
					mpratetotal,
					mprate,
					stockdetailid,
					ppoffer,
					intpercentage,
					inttotalamt,
					compressor,
					motor,
					panel,
					spareparts,
					service
					
					) (
					SELECT sd.productid,
					unitprice,
					@SQty,
					utamount,
					@CreditSalesId CreditSalesID,
					mpratetotal,
					mrprate,
					@SDetailID,
					ppoffer,
					intpercentage,
					inttotalamt,
					p.compressorwarrentymonth,
					p.motorwarrentymonth,
					p.panelwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth
					
					 FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO creditsaledetails (
					productid,
					unitprice,
					quantity,
					utamount,
					creditsalesid,
					mpratetotal,
					mprate,
					stockdetailid,
					ppoffer,
					intpercentage,
					inttotalamt,
					compressor,
					motor,
					panel,
					spareparts,
					service
					
					) (
					SELECT sd.productid,
					unitprice,
					@SQty,
					utamount,
					@CreditSalesId CreditSalesID,
					mpratetotal,
					mrprate,
					@SDetailID,
					ppoffer,
					intpercentage,
					inttotalamt,
					p.compressorwarrentymonth,
					p.motorwarrentymonth,
					p.panelwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth
					
					 FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@Quantity,
			@CreditSaleProductsID
	END

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	RETURN 0;
END CATCH

-------------------------
----6 March,2022--------
-----------------------


/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.Customers ADD
	MemberID varchar(50) NULL
GO
ALTER TABLE dbo.Customers ADD CONSTRAINT
	DF_Customers_MemberID DEFAULT ((0)) FOR MemberID
GO
ALTER TABLE dbo.Customers SET (LOCK_ESCALATION = TABLE)
GO
COMMIT



-------------------------
----02 Feb,2022--------
-----------------------
/****** Object:  StoredProcedure [dbo].[sp_AddReturnPurchaseOrder]    Script Date: 02-Feb-22 12:40:13 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROC [dbo].[sp_AddReturnPurchaseOrder]
(
	@PurchaseOrder [InsertPurchaseOrderTable] readonly,
	@PODetails [InsertPODetailTable] readonly,
	@POProductDetails [InsertReturnPOProductDetailTable] readonly,
	@Result INT OUTPUT,
	@OutPOrderID INT OUTPUT
)
  
AS 
DECLARE @PurchaseOrderId int

BEGIN TRY  
 BEGIN TRANSACTION 
  
INSERT INTO POrders
(
OrderDate, ChallanNo, SupplierID, GrandTotal, TDiscount, TotalAmt, AdjAmount, RecAmt, PaymentDue, TotalDue,
Status, PPDisAmt, NetDiscount, LaborCost, ConcernID, CreateDate, CreatedBy,IsDamageOrder,Remarks
)
(
Select OrderDate, ChallanNo, SupplierID, GrandTotal, TDiscount, TotalAmt, AdjAmount, RecAmt, PaymentDue, TotalDue,
Status, PPTDisAmt, NetDiscount, LabourCost, ConcernID, CreateDate, CreatedBy,IsDamageOrder, Remarks from @PurchaseOrder)

UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - p.PaymentDue)
from @PurchaseOrder p
JOIN Suppliers ON Suppliers.SupplierID = p.SupplierId
where p.IsDamageOrder!=1

SET @PurchaseOrderId = SCOPE_IDENTITY()


INSERT INTO POrderDetails
(
ProductID, ColorID, Quantity, UnitPrice, TAmount, PPDISPer, PPDISAmt, MRPRate, POrderID,SalesRate,ExtraPPDISPer,ExtraPPDISAmt,PPOFFER,CreditSalesRate,GodownID
)
(
Select ProductId, ColorId, Quantity, UnitPrice, TAmount,  PPDisPer,
PPDisAmt, MrpRate, @PurchaseOrderId POrderID,SalesRate,ExtraPPDISPer,ExtraPPDISAmt,PPOffer,CreditSalesRate,GodownId  from @PODetails)

INSERT INTO POProductDetails
(
ProductID, ColorID, IMENO, POrderDetailID,ReturnSDetailID,ReturnQty
)
(
Select POPD.ProductId, POPD.ColorId, POPD.IMENo, POD.POrderDetailID,POPD.ReturnSDetailID,POPD.ReturnQty from @POProductDetails POPD
INNER JOIN POrderDetails POD ON POD.ProductID = POPD.ProductId AND POD.ColorID = POPD.ColorId AND POD.POrderID = @PurchaseOrderId
)

-----------------------------Delete IMEI----------------------------------
declare @POrderID int
declare @SupplierID int
declare @ProductID int
declare @ColorID int
declare @ProductType int
declare @StockID int
declare @SDetailID int
declare @POrderDetailID int
declare @TotalDue decimal(18,2)
declare @GrandTotal decimal(18,2)
declare @TotalAmount decimal(18,2)
declare @NetDiscount decimal(18,2)
declare @PPDISAmt decimal(18,2)
declare @PaymentDue decimal(18,2)
declare @MRPRate decimal(18,2)
declare @UnitPrice decimal(18,2)
declare @PPDISPer decimal(18,2)
declare @IMEI varchar(300)
declare @POPDID int
declare @Quantity decimal(18,2)

declare cur CURSOR LOCAL 
for  select  sd.StockID,SDetailID,POrderDetailID,sd.ProductID,sd.IMENO,st.ReturnQty,p.ProductType,sd.ColorID
     from @POProductDetails st
     join StockDetails sd on st.ReturnSDetailID =sd.SDetailID
	 join Products p on sd.ProductID = p.ProductID
     where sd.Status=1
open cur
         fetch next from cur into @StockID,@SDetailID,@POrderDetailID,@ProductID,@IMEI,@Quantity,@ProductType,@ColorID
         
while @@FETCH_STATUS = 0
BEGIN


----Update stock Start
update Stocks set Quantity=Quantity-@Quantity where StockID=@StockID

IF(@ProductType=2)
BEGIN
update StockDetails set Quantity=Quantity-@Quantity where SDetailID=@SDetailID
update StockDetails set Status=3 where SDetailID=@SDetailID and Quantity=0
END
ELSE
update StockDetails set Status=3 where SDetailID=@SDetailID

delete [dbo].[SRVProductDetails] where SDetailID=@SDetailID


  fetch next from cur into @StockID,@SDetailID,@POrderDetailID,@ProductID,@IMEI,@Quantity,@ProductType,@ColorID
END


COMMIT

SET @Result=1
SET @OutPOrderID=@PurchaseOrderId

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

	SET @Result=0
    SET @OutPOrderID=0

END CATCH



-----------------------------
----11 Dec, 2021------------
-----------------------------
/****** Object:  StoredProcedure [dbo].[UpdateTotalDueForExpenditure]    Script Date: 11-Dec-21 01:36:45 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[UpdateTotalDueForExpenditure]
(
	@ExpenseItemID int,
	@BankDepositId int,
	@BankWithdrawId int,
	@CollectionAmount decimal(18,2),
	@ConcernID int,
	@userId int,
	@Remarks nvarchar(MAX)
)
  
AS 
IF(@ExpenseItemID>0)
BEGIN
--DECLARE @maxExpenseId int;
--Set @maxExpenseId=(Select ExpenditureID from Expenditures)
INSERT INTO [dbo].[Expenditures]
           ([EntryDate],[Purpose],[Amount],[ExpenseItemID]
           ,[VoucherNo],[ConcernID],[CreatedBy],[CreateDate]
           ,[CustomerType],[Remarks],[WFStatus],[CashInHandReportStatus])
     VALUES
           (GETDATE(),@Remarks
           ,@CollectionAmount,@ExpenseItemID,(CONVERT(varchar(100),@ExpenseItemID))
            ,@ConcernID,@userId,GETDATE(),0
           ,'From Bank Transaction',2,0)
END
 IF(@BankDepositId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount + @CollectionAmount)
	where BankID=@BankDepositId
END
  
 IF(@BankWithdrawId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount - @CollectionAmount)
	where BankID=@BankWithdrawId
END

RETURN
--------------------------------------------------------
/****** Object:  View [dbo].[vw_ProductPicker]    Script Date: 08-Dec-21 05:36:20 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


ALTER view [dbo].[vw_ProductPicker] as
Select P.Code'ProductCode',P.ProductName,G.Name'GodownName', CL.Name'ColorName', CA.Description'CategoryName', SD.IMENO, S.MRPPrice'MRPRate',P.ConcernID,P.ProductID,S.ColorID,S.GodownID,P.CategoryID,P.CompanyID,SD.SDetailID'StockDetailsId',S.StockID,CM.Name'CompanyName', SD.PRate'PRate'
From Products P
Inner Join Companies CM on CM.CompanyID=P.CompanyID and P.ConcernID=CM.ConcernID
Inner Join Categorys CA on CA.CategoryID=P.CategoryID and CA.ConcernID=P.ConcernID
Inner Join StockDetails SD on SD.ProductID=P.ProductID
Inner join Stocks S on S.StockID = SD.StockID and P.ConcernID = S.ConcernID
Inner Join Godowns G on SD.GodownID = G.GodownID and G.ConcernID = S.ConcernID
Inner Join Colors CL on CL.ColorID = SD.ColorID and CL.ConcernID = S.ConcernID
where SD.Status=1
--and S.ConcernID = 5126 Order By CA.CategoryID
 

GO
-----------------------------------------------------------
/****** Object:  StoredProcedure [dbo].[SP_ProductPickerInStock]    Script Date: 08-Dec-21 05:37:44 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[SP_ProductPickerInStock] (
	@concernId int
)
AS
	BEGIN
	  Select * from vw_ProductPicker where ConcernID=@concernId 
	END

-------------------------------
------08-Dec-2021--------------
------------------------------
/****** Object:  View [dbo].[vw_ProductPicker]    Script Date: 08-Dec-21 05:36:20 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE view [dbo].[vw_ProductPicker] as
Select P.Code'ProductCode',P.ProductName,G.Name'GodownName', CL.Name'ColorName', CA.Description'CategoryName', SD.IMENO, S.MRPPrice'MRPRate',P.ConcernID,P.ProductID,S.ColorID,S.GodownID,P.CategoryID,P.CompanyID,SD.SDetailID'StockDetailsId',S.StockID,CM.Name'CompanyName'
From Products P
Inner Join Companies CM on CM.CompanyID=P.CompanyID and P.ConcernID=CM.ConcernID
Inner Join Categorys CA on CA.CategoryID=P.CategoryID and CA.ConcernID=P.ConcernID
Inner Join StockDetails SD on SD.ProductID=P.ProductID
Inner join Stocks S on S.StockID = SD.StockID and P.ConcernID = S.ConcernID
Inner Join Godowns G on SD.GodownID = G.GodownID and G.ConcernID = S.ConcernID
Inner Join Colors CL on CL.ColorID = SD.ColorID and CL.ConcernID = S.ConcernID
where SD.Status=1
--and S.ConcernID = 5126 Order By CA.CategoryID
 

GO
-----------------------------------------------------
/****** Object:  StoredProcedure [dbo].[SP_ProductPickerInStock]    Script Date: 08-Dec-21 05:37:44 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[SP_ProductPickerInStock] (
	@concernId int
)
AS
	BEGIN
	  Select * from vw_ProductPicker where ConcernID=@concernId 
	END

-------------------------------
---04 Dec,2021----------------
------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.Employees ADD
	AdvanceLoanAmt decimal(18, 2) NULL
GO
ALTER TABLE dbo.Employees SET (LOCK_ESCALATION = TABLE)
GO
COMMIT


---------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.AdvanceSalaries ADD
	IsAdvanceLoanPay int NOT NULL CONSTRAINT DF_AdvanceSalaries_IsAdvanceLoanPay DEFAULT 0
GO
ALTER TABLE dbo.AdvanceSalaries SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

----------------------------
-----20-09-22--------------
---------------------------

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	CompanyURL nvarchar(MAX) NULL
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

----------------------------
-----27-11-21--------------
---------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.AdvanceSalaries ADD
	SalaryType int NOT NULL CONSTRAINT DF_AdvanceSalaries_SalaryType DEFAULT 0
GO
ALTER TABLE dbo.AdvanceSalaries SET (LOCK_ESCALATION = TABLE)
GO
COMMIT



----------------------------
-------20-10-21-------------
----------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.ShareInvestments ADD
	CashInHandReportStatus int NOT NULL CONSTRAINT DF_ShareInvestments_CashInHandReportStatus DEFAULT 0
GO
ALTER TABLE dbo.ShareInvestments SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

----------------------------
--------26/10/21------------
----------------------------

ALTER TABLE [dbo].[ExpenseItems] DROP CONSTRAINT [DF_ExpenseItems_CashInHandReportStatus]
GO

ALter  Table ExpenseItems drop Column CashInHandReportStatus

---------------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.Expenditures ADD
	CashInHandReportStatus int NOT NULL CONSTRAINT DF_Expenditures_CashInHandReportStatus DEFAULT 0
GO
ALTER TABLE dbo.Expenditures SET (LOCK_ESCALATION = TABLE)
GO
COMMIT




---------------------------------
-----Yearly Cash In Hand-------
21-10-21-------------------------
--------------------------------
USE [TRIMS]
GO
/****** Object:  StoredProcedure [dbo].[sp_YearlyCashInHand]    Script Date: 21-Oct-21 12:57:19 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_YearlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-02-09'


if (@ConcernID = 1)
	set @CashInHand = 1263.00
else if (@ConcernID = 5)
	set @CashInHand = 8755.00
else if (@ConcernID = 6)
	set @CashInHand = - 2.00
else if (@ConcernID = 4)
	set @CashInHand = 65000.00
else if (@ConcernID = 20)
BEGIN
	set @CashInHand = 137340.00
	set @StartDate = '2020-03-12'
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END


set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(YEAR, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

insert into #temp_Data1
select @StartDate, s.Name, sum(po.recAmt), 'Cash Sales', 0, 'Order'
from POrders po
join Suppliers s on po.SupplierID = s.SupplierID
where po.ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
 and po.RecAmt>0
group by s.SupplierID,s.Name

insert into #temp_Data1
select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 1   and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate,'Bank collections', @total, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Customer Collection(Cr))', sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 3  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Cash Delivery', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 4  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END
---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections cc 
join Suppliers s on cc.SupplierID = s.SupplierID
where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,  s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc 
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate 
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID 
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Retail/Dealer', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID 
		and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Retail/Dealere', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID 
				and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Hire', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID 
		and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Hire', 0, '', 0, 'Header'
	END

------------- -------------------------------------------- Direct Expense--------------------------------------------
set @total =isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and E.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)

if (@total) != 0
begin
insert into #temp_Data1
select @StartDate,'Expense', 0, '', 0, 'Header'

insert into #temp_Data1
select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and E.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description

insert into #temp_Data1
select @StartDate,'Total Expense', @total, '', 0, 'Header'

end

-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2 
 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE  SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
 END
----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1  and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')

END
---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1  and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1   and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID  and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
if (
(
isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 and E.CashInHandReportStatus = 0 and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)
) != 0
)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 and E.CashInHandReportStatus = 0  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
 END


 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE  SIH.ParentId=2  and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END
------------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)

set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(YEAR, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)
------------------------------
-----Monthly Cash In Hand------
21-10-21------------------------
-----------------------------
USE [TRIMS]
GO
/****** Object:  StoredProcedure [dbo].[sp_MonthlyCashInHand]    Script Date: 21-Oct-21 12:56:25 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_MonthlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0


if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-06-09'
set @CashInHand=26500
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(MONTH, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate)
and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data1
select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

insert into #temp_Data1
select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
from POrders po
join Suppliers s on po.SupplierID = s.SupplierID
where po.ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate)
and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate and po.RecAmt>0
group by s.SupplierID,s.Name

insert into #temp_Data1
select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 1  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

END
---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank collections', @total, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Customer Collection(Cr))', sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank Cash Delivery', @total, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	where BT.ConcernID = @ConcernID and TransactionType = 4 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
	group by B.BankID, B.AccountNo, B.BankName

	insert into #temp_Data1
	select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END
---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections cc 
join Suppliers s on cc.SupplierID = s.SupplierID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) 
and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(cc.amount), 'Due Collection', 0, 'Cash'
		from CashCollections cc 
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) 
		and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'
END
------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID 
				and  Month(Convert(date, InvoiceDate)) = Month(@StartDate)
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Retail/Dealer', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID 
	and  Month(Convert(date, InvoiceDate)) = Month(@StartDate)
				and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Retail/Dealere', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID 
			    and  Month(Convert(date, SalesDate)) = Month(@StartDate)
				and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge-Hire', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID 
	    and  Month(Convert(date, SalesDate)) = Month(@StartDate)
		and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge-Hire', 0, '', 0, 'Header'
	END
------------- -------------------------------------------- Direct Expense--------------------------------------------
set @total=isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1 and E.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)

if(@total) != 0
begin
	insert into #temp_Data1
	select @StartDate,'Expense', 0, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
	from Expenditures EX
	inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
	where EX.ConcernID = @ConcernID and E.status = 1 and E.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
	group by E.Description

	insert into #temp_Data1
	select @StartDate,'Total Expense', @total, '', 0, 'Header'
end

-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 2 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
 END
----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1  and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
  
  END
---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1 and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1  and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
if (
(
isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 and E.CashInHandReportStatus = 0 and  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)
) != 0
)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 and E.CashInHandReportStatus = 0 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=3 and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name

 insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')

 END



 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 WHERE SIH.ParentId=2 and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END
 ------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(MONTH, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)


---------------------------------
------Daily Cash In Hand----------

21-10-21--------------------------
------------------------------------
USE [TRIMS]
GO
/****** Object:  StoredProcedure [dbo].[sp_DailyCashInHand]    Script Date: 21-Oct-21 12:55:13 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--EXEC sp_DailyCashInHand  '11 MAY 2021 12:00:00 AM','11 MAY 2021 11:59:59 PM',16
ALTER procedure [dbo].[sp_DailyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-08-01'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)



create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(DAY, 1, Convert(date, GetDate()))
begin
	print @StartDate

	delete
	from #temp_Data1

	delete
	from #temp_Data2

	--	DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
	--	DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
	------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
	insert into #temp_Data1
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
				and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
		from POrders po
		join Suppliers s on po.SupplierID = s.SupplierID
		where po.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
		and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and po.RecAmt>0
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
	---------------------------------Expense from Bank Deposit--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

	END
	---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank collections', @total, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	inner join Customers c on BT.CustomerID = c.CustomerID
	where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
	group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	insert into #temp_Data1
	select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
	---------------------------------Expens from Bank Cash Delivery---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Cash Delivery', @total, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END
	---------------------------------Expense from Fund Out---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections cc
				join Suppliers s on cc.SupplierID = s.SupplierID
				where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
				and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
		and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
	------------------------------------------------------Expense in Product return----------------------------------
	set @total = isnull((
				select sum(PaidAmount)
				from ROrders
				where ConcernID = @ConcernID and DAY(Convert(date, ReturnDate)) = DAY(@StartDate) and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

END

	-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Cash Collection Return', @total, 'Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

	------------- -------------------------------------------- Direct Expense--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' and E.CashInHandReportStatus = 0
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' and E.CashInHandReportStatus = 0
		and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description

		insert into #temp_Data1
		select @StartDate,'Total Expense', @total, '', 0, 'Header'
	end

	-- ----------------------------Expens from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=3  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
END

	----------------------------------------------Opening Cash In Hand in Income Table--------------------------------------------------------------- 
	insert into #temp_Data2
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	-----------------------------------------------Income in Sales Order-------------------------------------------
	set @total = isnull((
				select sum(RecAmount)
				from SOrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount,Convert(varchar(10),c.CustomerType)+'Order' from SOrders so
		join Customers c on so.CustomerID = c.CustomerID
		where so.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
	    insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
   
   END
	---------------------------------Income from Bank Withdwal--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Cash Collection---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
		('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on bt.CustomerID=c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	----------------------------------------Income from Fund IN------------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.AnotherBankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.AnotherBankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-- ---------------------------------------Income from Cash Collection from Customer-------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
				), 0)

	if (@total != 0)
	BEGIN
	insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, Convert(varchar(10),c.CustomerType)+'Cash'
		from CashCollections cc
		join Customers c on cc.CustomerID = c.CustomerID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
	    insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')
		
		END
	-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
	set @total = isnull((
				select isnull(sum(DownPayment), 0)
				from CreditSales
				where ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
		from CreditSales cs
		join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')
	
	END
	--------------------------------------Income in Purchase Product return----------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and DAY(Convert(date, OrderDate)) = DAY(@StartDate) and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and status = 5
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Purchase Return Cash'

	-------------------------------Income Installment Collection from Creditsales------------------
	set @total = isnull((
				select sum(InstallmentAmt)
				from CreditSalesSchedules css
				inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
				where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
		from CreditSalesSchedules css
		inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
		inner join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
	  
	  insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')
	
	END
	-----------------------------------Income from Direct Income------------------------------------------------
	if (
			(
				isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and  E.CashInHandReportStatus = 0 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
				) != 0
			)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Description, sum(Amount), E.Description
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 2 and  E.CashInHandReportStatus = 0 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')
	
	end

	-- ----------------------------Income from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
	END

	   SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)
	IF (@total != 0)
	BEGIN
		INSERT INTO #temp_Data2
		SELECT @StartDate, '', 0.00,SIH.Name+'(Current Asset)',  sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name

		insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')
	END

	insert into #temp_Data3
	select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), '', 0.00,  ''
	from #temp_Data1 T1
	UNION ALL
	select @StartDate, 0,  '', 0, isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
	from #temp_Data2 T2

	declare @a decimal(18, 2)
	declare @b decimal(18, 2)
	declare @ExpenseWithinDate decimal(18, 2)
	declare @IncomeWithinDate decimal(18, 2)
	declare @CashInHandWithinDate decimal(18, 2)

	set @a = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @b = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @ExpenseWithinDate = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @IncomeWithinDate = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
	set @CashInHand = @CashInHand + (@b - @a)

	insert into #temp_Data3
	values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

	insert into #temp_Data3
	values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

	insert into #temp_Data3
	values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

	set @StartDate = DATEADD(DAY, 1, @StartDate)
	--select *From #temp_Data1
	--select *From #temp_Data2
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

-------------------------------------
------Profit And Loss SP------------
21-10-21-----------------------------
-------------------------------------
USE [TRIMS]
GO
/****** Object:  StoredProcedure [dbo].[sp_ProfitandLossAccount]    Script Date: 21-Oct-21 12:53:39 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_ProfitandLossAccount '2020-01-01 00:00:00','2020-05-04 23:59:59',1
ALTER PROCEDURE [dbo].[sp_ProfitandLossAccount] (@Fromdate DATETIME, @ToDate DATETIME, @ConcernID INT)
AS
BEGIN
	CREATE TABLE #temp (ID INT identity(1, 1) NOT NULL, DebitParticulars NVARCHAR(MAX), Debit DECIMAL(18, 2), CreditParticulars NVARCHAR(MAX), Credit DECIMAL(18, 2), SerialNum INT)

	DECLARE @TotalIncome DECIMAL(18, 2)
	DECLARE @TotalSalesReturn DECIMAL(18, 2)
	DECLARE @TotalPOReturn DECIMAL(18, 2)
	DECLARE @TotalExpense DECIMAL(18, 2)
	DECLARE @LastPayAdjust DECIMAL(18, 2)

	SET @TotalIncome = 0
	SET @TotalExpense = 0

	SELECT @TotalIncome = ISNULL(SUM(SOD.Quantity * ((SOD.UnitPrice - SOD.PPDAmount) - (((SOD.UnitPrice - SOD.PPDAmount) * (SO.TDAmount + SO.AdjAmount)) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)))), 0),
	@TotalExpense = ISNULL(SUM(SOD.PRate * SOD.Quantity), 0)
	FROM SOrderDetails SOD
	INNER JOIN SOrders SO
		ON SOD.SOrderID = SO.SOrderID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.SDetailID
	WHERE SO.STATUS = 1 AND SO.IsReplacement=0 AND (SO.InvoiceDate >= @Fromdate AND SO.InvoiceDate <= @ToDate) AND SO.ConcernID = @ConcernID

	SELECT @TotalSalesReturn = ISNULL(SUM(SOD.Quantity * SOD.UnitPrice), 0), @TotalPOReturn = ISNULL(SUM(STD.PRate * SOD.Quantity), 0)
	FROM ROrderDetails SOD
	INNER JOIN ROrders SO
		ON SOD.ROrderID = SO.ROrderID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailID
	WHERE (SO.ReturnDate >= @Fromdate AND SO.ReturnDate <= @ToDate) AND SO.ConcernID = @ConcernID

	--Print(Convert(varchar(123),@TotalIncome))
	--Print(Convert(varchar(123),@TotalExpense))
	SELECT @TotalIncome = @TotalIncome + ISNULL(SUM(CSP.Quantity * (CSP.UnitPrice - (CS.Discount * CSP.UnitPrice / CS.TSalesAmt))), 0),
	--+ISNULL(SUM((((((CS.InterestAmount) / (CS.TSalesAmt - CS.InterestAmount)) * (CSP.UnitPrice))) * CSP.Quantity) - (((((CS.Discount) / (CS.TSalesAmt - CS.InterestAmount)) * (CSP.UnitPrice))) * CSP.Quantity)),0), 
	@TotalExpense = @TotalExpense + ISNULL(SUM(STD.PRate * CSP.Quantity), 0)
	FROM CreditSaleDetails CSP
	INNER JOIN CreditSales CS
		ON CS.CreditSalesID = CSP.CreditSalesID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = CSP.StockDetailID
	WHERE CS.IsStatus = 1 AND CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CS.ConcernID = @ConcernID
	--Print(Convert(varchar(123),@TotalIncome))
	SELECT @TotalIncome = @TotalIncome + ISNULL(SUM(HireValue), 0)
	FROM CreditSales CS
	INNER JOIN CreditSaleDetails CSP
		ON CSP.CreditSalesID = CS.CreditSalesID
	INNER JOIN CreditSalesSchedules CSD
		ON CSD.CreditSalesID = CS.CreditSalesID
	INNER JOIN StockDetails STD
		ON STD.SDetailID = CSP.StockDetailID
	WHERE Cs.IsStatus = 1 AND CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Purchase', ISNULL(@TotalExpense, 0), '', 0.00, 1)

	IF(@TotalPOReturn>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Purchase Return', ISNULL(@TotalPOReturn, 0), '', 0.00, 2)

	IF(ISNULL(@TotalExpense - @TotalPOReturn, 0)!=0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Net Purchase', ISNULL(@TotalExpense - @TotalPOReturn, 0), '', 0.00, 3)

	IF(@TotalIncome!=0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Sales', @TotalIncome, 4)

	IF(@TotalSalesReturn>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Sales Return', @TotalSalesReturn, 5)

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Net Sales', (@TotalIncome - @TotalSalesReturn), 6)

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('', 0.0, 'Gross Profit', ISNULL((@TotalIncome - @TotalSalesReturn) - (@TotalExpense - @TotalPOReturn), 0), 7)

	--Last Pay adjustment
	SELECT @LastPayAdjust = ISNULL(SUM(CSD.LastPayAdjust), 0)
	FROM CreditSales CS
	INNER JOIN CreditSalesSchedules CSD
		ON CSD.CreditSalesID = CS.CreditSalesID
	WHERE Cs.IsStatus = 1 AND CSD.PaymentDate >= @Fromdate AND CSD.PaymentDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID

	SELECT @LastPayAdjust = @LastPayAdjust + ISNULL(SUM(CS.AdjustAmt), 0)
	FROM CashCollections CS
	WHERE Cs.TransactionType = 1 AND CS.EntryDate >= @Fromdate AND CS.EntryDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.CustomerID > 0
	
	IF(@LastPayAdjust>0)
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES ('Adjustment', ISNULL(@LastPayAdjust, 0), '', 0.00, 8)

	---------------------Income----------------------
	set @TotalIncome = ISNULL((	SELECT SUM(ex.Amount)
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 2 and exi.CashInHandReportStatus = 0),0)

	IF(@TotalIncome>0)
	BEGIN
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	SELECT '', 0.00, exi.Description, ex.Amount, 9
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 2 and exi.CashInHandReportStatus = 0

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES('',0.00,'Total Income',@TotalIncome,10)
	END

	-----------------------expense----------------------
	set @TotalExpense = ISNULL((SELECT SUM( ex.Amount)
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 1 AND exi.Description != 'Send cash to head of accounts' and exi.CashInHandReportStatus = 0
    ),0)

	IF(@TotalExpense>0)
	BEGIN
	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	SELECT exi.Description, ex.Amount, '', 0.00, 11
	FROM Expenditures ex
	JOIN ExpenseItems exi
		ON ex.ExpenseItemID = exi.ExpenseItemID
	WHERE ex.ConcernID = @ConcernID AND (ex.EntryDate >= @FromDate AND ex.EntryDate <= @ToDate) AND exi.STATUS = 1 AND exi.Description != 'Send cash to head of accounts' and exi.CashInHandReportStatus = 0

	INSERT INTO #temp (DebitParticulars, Debit, CreditParticulars, Credit, SerialNum)
	VALUES('Total Expense',@TotalExpense,'',0.00,12)
	END

	SELECT SerialNum, DebitParticulars, sum(Debit) 'Debit', CreditParticulars, sum(Credit) 'Credit'
	FROM #temp
	GROUP BY DebitParticulars, CreditParticulars, SerialNum
	ORDER BY SerialNum ASC
		--Print(Convert(varchar(123),@TotalIncome))
END



----------------------------
--21-01-21----------------
---------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.ExpenseItems ADD
	CashInHandReportStatus int NOT NULL CONSTRAINT DF_ExpenseItems_CashInHandReportStatus DEFAULT 0
GO
ALTER TABLE dbo.ExpenseItems SET (LOCK_ESCALATION = TABLE)
GO
COMMIT



--------------------------------
--------20-10-21----------------
--------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.BankTransactions ADD
	ExpenseItemID int NULL
GO
ALTER TABLE dbo.BankTransactions SET (LOCK_ESCALATION = TABLE)
GO
COMMIT



----------------------
USE [TRIMS]
GO
/****** Object:  StoredProcedure [dbo].[UpdateTotalDueForExpenditure]    Script Date: 21-Oct-21 06:54:21 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROC [dbo].[UpdateTotalDueForExpenditure]
(
	@ExpenseItemID int,
	@BankDepositId int,
	@BankWithdrawId int,
	@CollectionAmount decimal(18,2),
	@ConcernID int,
	@userId int
)
  
AS 
IF(@ExpenseItemID>0)
BEGIN
DECLARE @maxExpenseId int;
Set @maxExpenseId=(Select ExpenditureID from Expenditures)
INSERT INTO [dbo].[Expenditures]
           ([EntryDate],[Purpose],[Amount],[ExpenseItemID]
           ,[VoucherNo],[ConcernID],[CreatedBy],[CreateDate]
           ,[CustomerType],[Remarks],[WFStatus])
     VALUES
           (GETDATE(),'Direct Income from Bank Transaction'
           ,@CollectionAmount,@ExpenseItemID,CONVERT(varchar(100),@maxExpenseId)
           ,@ConcernID,@userId,GETDATE(),0
           ,'Bank Income',2)
END
 IF(@BankDepositId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount + @CollectionAmount)
	where BankID=@BankDepositId
END
  
 IF(@BankWithdrawId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount - @CollectionAmount)
	where BankID=@BankWithdrawId
END

RETURN








-------------------------
---28 Sep,2021---------
-------------------------
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

--exec [dbo].[sp_BankTransReport] 4

ALTER PROC [dbo].[sp_BankTransReport]
(
@FromDate datetime,
@ToDate datetime,
@BankID int
)
as

Create table #temp (
ConcernID int,ConcernName varchar(250),BankID int,BankName varchar(250),AccountNO varchar(250),
AccountName varchar(250),TransDate DATETIME,TransactionNo varchar(250),ChecqueNo varchar(250),Amount decimal(18,2),
FromTOAccountNo varchar(250),Remarks varchar(250),TransType varchar(250))

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5,
--Bank Expense =6,
--Bank Income = 7,
--LiaPay = 8,
--LiaRec =9

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Deposit' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where b.BankID=@BankID and bt.TransactionType=1 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Withdraw' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where b.BankID=@BankID and bt.TransactionType=2  and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
c.Name as FromTOAccountNo,bt.Remarks,'Cash Collection' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Customers c on bt.CustomerID = c.CustomerID
where b.BankID=@BankID and bt.TransactionType=3 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
sup.Name as FromTOAccountNo,bt.Remarks,'Cash Delivery' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Suppliers sup on bt.SupplierID = sup.SupplierID
where b.BankID=@BankID and bt.TransactionType=4 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
ab.AccountName+' ('+ab.AccountNo+')' as FromTOAccountNo,bt.Remarks,'Fund In' from Banks b 
join BankTransactions bt on b.BankID = bt.AnotherBankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Banks ab on bt.BankID = ab.BankID
where b.BankID=@BankID and bt.TransactionType=5 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
ab.AccountName+' ('+ab.AccountNo+')' as FromTOAccountNo,bt.Remarks,'Fund Out' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
join Banks ab on bt.AnotherBankID = ab.BankID
where b.BankID=@BankID and bt.TransactionType=5 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Bank Expense' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where b.BankID=@BankID and bt.TransactionType=6 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Bank Income' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where b.BankID=@BankID and bt.TransactionType=7 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Liability Pay' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where b.BankID=@BankID and bt.TransactionType=8 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)

insert into #temp
select bt.ConcernID,s.Name,b.BankID,b.BankName,b.AccountNo,
b.AccountName,bt.TranDate,bt.TransactionNo,bt.ChecqueNo,bt.Amount,
'' as FromTOAccountNo,bt.Remarks,'Liability Receive' from Banks b 
join BankTransactions bt on b.BankID = bt.BankID
join SisterConcerns s on bt.ConcernID = s.ConcernID
where b.BankID=@BankID and bt.TransactionType=9 and (bt.TranDate>=@FromDate and bt.TranDate<=@ToDate)


select * from #temp order by TransDate desc


-----------------------------------------------------------------
---------**********---------*********--------******--------------

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE PROC [dbo].[UpdateTotalDueForInvestment]
(
	@SIHID int,
	@SIHIdV2 int,
	@BankDepositId int,
	@BankWithdrawId int,
	@CollectionAmount decimal(18,2)
)
  
AS 

IF(@SIHID>0)
BEGIN
	UPDATE ShareInvestmentHeads Set ShareInvestmentHeads.Balance = (ShareInvestmentHeads.Balance + @CollectionAmount)
	where SIHID=@SIHID
END
 IF(@SIHIdV2>0)
BEGIN
	UPDATE ShareInvestmentHeads Set ShareInvestmentHeads.Balance = (ShareInvestmentHeads.Balance  - @CollectionAmount)
	where SIHID=@SIHIdV2
END


 IF(@BankDepositId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount + @CollectionAmount)
	where BankID=@BankDepositId
END
  
 IF(@BankWithdrawId>0)
BEGIN
	UPDATE Banks Set Banks.TotalAmount = (Banks.TotalAmount - @CollectionAmount)
	where BankID=@BankWithdrawId
END

RETURN

GO

----------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.BankTransactions ADD
	SIHID int NULL
GO
ALTER TABLE dbo.BankTransactions SET (LOCK_ESCALATION = TABLE)
GO
COMMIT



--------------------------
----22 Sep,2021-------------
------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	IsMrpUpdateShowForManager int NOT NULL CONSTRAINT DF_SystemInformations_IsMrpUpdateShowForManager DEFAULT 0
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT


-------------------------------
------Date: 17-Aug-2021-------
Sp Daily Cash In Hand
-------------------------------

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--EXEC sp_DailyCashInHand  '11 MAY 2021 12:00:00 AM','11 MAY 2021 11:59:59 PM',16
ALTER procedure [dbo].[sp_DailyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-08-01'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((SELECT TOP 1 Amount from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),0)

set @StartDate = ISNULL((SELECT TOP 1 Date from PrevBalances 
where Date>=@FromDate AND concernid=@ConcernID
ORDER BY DATE),@FromDate)



create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(DAY, 1, Convert(date, GetDate()))
begin
	print @StartDate

	delete
	from #temp_Data1

	delete
	from #temp_Data2

	--	DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
	--	DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
	------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
	insert into #temp_Data1
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
				and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate, 'Cash Paid', 0, '', 0, 'Order'

		insert into #temp_Data1
		select @StartDate, s.Name, sum(RecAmt), 'Cash Sales', 0, 'Order'
		from POrders po
		join Suppliers s on po.SupplierID = s.SupplierID
		where po.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate)
		and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and po.RecAmt>0
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate, 'Total Cash Paid', @total, '', 0, 'Header'

END 
	---------------------------------Expense from Bank Deposit--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data1
		select @StartDate,'Bank Deposit', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

		insert into #temp_Data1
		select @StartDate,'Total Bank Deposit', @total, '', 0, 'Header'

	END
	---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Bank collections', @total, '', 0, 'Header'

	insert into #temp_Data1
	select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
	from BankTransactions BT
	inner join Banks B on BT.BankID = B.BankID
	inner join Customers c on BT.CustomerID = c.CustomerID
	where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
	group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	insert into #temp_Data1
	select @StartDate,'Total Bank collections', @total, '', 0, 'Header'
END
	---------------------------------Expens from Bank Cash Delivery---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Bank Cash Delivery', @total, '', 0, 'Header'
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName
		
		insert into #temp_Data1
		select @StartDate,'Total Bank Cash Delivery', @total, '', 0, 'Header'
END
	---------------------------------Expense from Fund Out---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections cc
				join Suppliers s on cc.SupplierID = s.SupplierID
				where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
				and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Cash Delivery', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate,s.Name, sum(cc.amount), '', 0, 'Cash'
		from CashCollections cc
		join Suppliers s on cc.SupplierID = s.SupplierID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) 
		and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
		group by s.SupplierID,s.Name

		insert into #temp_Data1
		select @StartDate,'Total Cash Delivery', @total, '', 0, 'Header'
END
	------------------------------------------------------Expense in Product return----------------------------------
	set @total = isnull((
				select sum(PaidAmount)
				from ROrders
				where ConcernID = @ConcernID and DAY(Convert(date, ReturnDate)) = DAY(@StartDate) and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)
				), 0)

if (@total != 0)
BEGIN

	insert into #temp_Data1
	select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

END

	-------------------------------------------------------- Expense Cash Collection Return------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 3
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Cash Collection Return', @total, 'Cash Collection Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment charge----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data1
		select @StartDate,'Card Payment Charge', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

		insert into #temp_Data1
		select @StartDate,'Total Card Payment Charge', 0, '', 0, 'Header'
	END
	-----Hire Sales Payment charge----------------

    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName

	------------- -------------------------------------------- Direct Expense--------------------------------------------
	set @total=isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' 
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
	if (@total != 0)
	begin
		insert into #temp_Data1
		select @StartDate,'Expense', 0, '', 0, 'Header'

		insert into #temp_Data1
		select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' 
		and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description

		insert into #temp_Data1
		select @StartDate,'Total Expense', @total, '', 0, 'Header'
	end

	-- ----------------------------Expens from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		), 0)
IF (@total != 0)
BEGIN
	insert into #temp_Data1
	select @StartDate,'Lia. Pay', 0, '', 0, 'Header'

	INSERT INTO #temp_Data1
	SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
	FROM ShareInvestments SI
	INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
	WHERE (SIH.ParentId=3  AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
	GROUP BY SIH.Name

	insert into #temp_Data1
	select @StartDate,'Total Lia. Pay', @total, '', 0, 'Header'
END

	----------------------------------------------Opening Cash In Hand in Income Table--------------------------------------------------------------- 
	insert into #temp_Data2
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	-----------------------------------------------Income in Sales Order-------------------------------------------
	set @total = isnull((
				select sum(RecAmount)
				from SOrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount,Convert(varchar(10),c.CustomerType)+'Order' from SOrders so
		join Customers c on so.CustomerID = c.CustomerID
		where so.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
	    insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
   
   END
	---------------------------------Income from Bank Withdwal--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Cash Collection---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
		('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on bt.CustomerID=c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	----------------------------------------Income from Fund IN------------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.AnotherBankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.AnotherBankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-- ---------------------------------------Income from Cash Collection from Customer-------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
				), 0)

	if (@total != 0)
	BEGIN
	insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, Convert(varchar(10),c.CustomerType)+'Cash'
		from CashCollections cc
		join Customers c on cc.CustomerID = c.CustomerID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
	    insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')
		
		END
	-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
	set @total = isnull((
				select isnull(sum(DownPayment), 0)
				from CreditSales
				where ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
		from CreditSales cs
		join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')
	
	END
	--------------------------------------Income in Purchase Product return----------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and DAY(Convert(date, OrderDate)) = DAY(@StartDate) and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and status = 5
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Purchase Return Cash'

	-------------------------------Income Installment Collection from Creditsales------------------
	set @total = isnull((
				select sum(InstallmentAmt)
				from CreditSalesSchedules css
				inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
				where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
		from CreditSalesSchedules css
		inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
		inner join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
	  
	  insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')
	
	END
	-----------------------------------Income from Direct Income------------------------------------------------
	if (
			(
				isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
				) != 0
			)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Description, sum(Amount), E.Description
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 2 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')
	
	end

	-- ----------------------------Income from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=3 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
	END

	   SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)
	IF (@total != 0)
	BEGIN
		INSERT INTO #temp_Data2
		SELECT @StartDate, '', 0.00,SIH.Name+'(Current Asset)',  sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		WHERE (SIH.ParentId=2 AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name

		insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')
	END

	insert into #temp_Data3
	select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), '', 0.00,  ''
	from #temp_Data1 T1
	UNION ALL
	select @StartDate, 0,  '', 0, isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
	from #temp_Data2 T2

	declare @a decimal(18, 2)
	declare @b decimal(18, 2)
	declare @ExpenseWithinDate decimal(18, 2)
	declare @IncomeWithinDate decimal(18, 2)
	declare @CashInHandWithinDate decimal(18, 2)

	set @a = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @b = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @ExpenseWithinDate = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @IncomeWithinDate = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
	set @CashInHand = @CashInHand + (@b - @a)

	insert into #temp_Data3
	values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

	insert into #temp_Data3
	values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

	insert into #temp_Data3
	values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

	set @StartDate = DATEADD(DAY, 1, @StartDate)
	--select *From #temp_Data1
	--select *From #temp_Data2
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)


-------------------------------
------Date: 17-Aug-2021-------
-------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	IsSalesPPDiscountShow int NOT NULL CONSTRAINT DF_SystemInformations_IsSalesPPDiscountShow DEFAULT 1
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

-------------------------------
------Date: 16-Aug-2021-------
-------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	BarcodeSize int NOT NULL CONSTRAINT DF_SystemInformations_BarcodeSize DEFAULT 1
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

-------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.Products ADD
	PurchaseRate decimal(18, 2) NOT NULL CONSTRAINT DF_Products_PurchaseRate DEFAULT 0
GO
ALTER TABLE dbo.Products SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

-------------------------------
------Date: 08-Aug-2021-------
-------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.ParentCategories SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.Categorys ADD
	PCategoryID int NOT NULL CONSTRAINT DF_Categorys_PCategoryID DEFAULT 1
GO
ALTER TABLE dbo.Categorys ADD CONSTRAINT
	FK_Categorys_ParentCategories FOREIGN KEY
	(
	PCategoryID
	) REFERENCES dbo.ParentCategories
	(
	PCategoryID
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
ALTER TABLE dbo.Categorys SET (LOCK_ESCALATION = TABLE)
GO
COMMIT


-------------------------------

CREATE TABLE [dbo].[ParentCategories](
	[PCategoryID] [int] IDENTITY(1,1) NOT NULL,
	[Code] [varchar](50) NOT NULL,
	[Name] [varchar](200) NOT NULL,
	[CreatedBy] [int] NOT NULL,
	[CreateDate] [datetime] NOT NULL,
	[ModifiedBy] [int] NULL,
	[ModifiedDate] [datetime] NULL,
 CONSTRAINT [PK_ParentCategories] PRIMARY KEY CLUSTERED 
(
	[PCategoryID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

-------------------------------
------Date: 08-July-2021-------
-------------------------------
CREATE TABLE [dbo].[PrevProfitlosses](
	[Date] [date] NOT NULL,
	[ClosingBalance] [decimal](18, 2) NOT NULL,
	[ConcernID] [int] NOT NULL
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[PrevProfitlosses]  WITH CHECK ADD  CONSTRAINT [FK_PrevProfitlosses_SisterConcerns] FOREIGN KEY([ConcernID])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[PrevProfitlosses] CHECK CONSTRAINT [FK_PrevProfitlosses_SisterConcerns]
GO

-------------------------------------------------------
CREATE TABLE [dbo].[PrevBankBalances](
	[Date] [datetime] NOT NULL,
	[ClosingBalance] [decimal](18, 2) NOT NULL,
	[BankID] [int] NOT NULL,
	[ConcernID] [int] NOT NULL
) ON [PRIMARY]
GO
-------------------------------
CREATE TABLE [dbo].[PrevCustomerDues](
	[Date] [datetime] NOT NULL,
	[ClosingBalance] [decimal](18, 2) NOT NULL,
	[ConcernID] [int] NOT NULL
) ON [PRIMARY]
GO
-------------------------------
CREATE TABLE [dbo].[PrevStockValues](
	[Date] [date] NOT NULL,
	[ClosingBalance] [decimal](18, 2) NOT NULL,
	[ConcernID] [int] NOT NULL
) ON [PRIMARY]
GO


-------------------------------
CREATE TABLE [dbo].[PrevSupplierDues](
	[Date] [datetime] NOT NULL,
	[ClosingBalance] [decimal](18, 2) NOT NULL,
	[ConcernID] [int] NOT NULL,
	[SupplierID] [int] NOT NULL
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[PrevSupplierDues]  WITH CHECK ADD  CONSTRAINT [FK_PrevSupplierDues_SisterConcerns] FOREIGN KEY([ConcernID])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[PrevSupplierDues] CHECK CONSTRAINT [FK_PrevSupplierDues_SisterConcerns]
GO

ALTER TABLE [dbo].[PrevSupplierDues]  WITH CHECK ADD  CONSTRAINT [FK_PrevSupplierDues_Suppliers] FOREIGN KEY([SupplierID])
REFERENCES [dbo].[Suppliers] ([SupplierID])
GO

ALTER TABLE [dbo].[PrevSupplierDues] CHECK CONSTRAINT [FK_PrevSupplierDues_Suppliers]
GO


-------------------------------

CREATE TABLE [dbo].[PrevStockValues](
	[Date] [date] NOT NULL,
	[ClosingBalance] [decimal](18, 2) NOT NULL,
	[ConcernID] [int] NOT NULL
) ON [PRIMARY]
GO


-------------------------------
-------------------------------


-------------------------------
------Date: 07 July, 2021------
-------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
IsRetailSMSEnable int  Null,
IsHireSMSEnable int  Null,
IsCashcollSMSEnable int  Null,
IsInstallmentSMSEnable int  Null,
IsRemindSMSEnable int  null
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT













--------------------------------
----Date : 30-06-2021-----------
--------------------------------
update SystemInformations set ExpireDate='2021-07-10 00:00:00.000', 
WarningMsg=N'                  /() 
01724939433,
01777535899',
ExpireMessage=N'            /() 
01724939433,
01777535899'
--------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	ExpireDate datetime NULL,
	ExpireMessage nvarchar(MAX) NULL,
	WarningMsg nvarchar(MAX) NULL
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

--------------------------------
----Date : 23-06-2021-----------
--------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	BrandLogo varbinary(MAX) NULL,
	BLogoMimeType varchar(250) NULL
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
------------------------------------------------------
-----------------Date: 23-05-2021---------------------
------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.ShareInvestments ADD
	LiabilityType int NOT NULL CONSTRAINT DF_ShareInvestments_LiabilityType DEFAULT 0
GO
ALTER TABLE dbo.ShareInvestments SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

------------------------------------------------------
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.ShareInvestmentHeads ADD
	Balance decimal(18, 2) NOT NULL CONSTRAINT DF_ShareInvestmentHeads_Balance DEFAULT 0
GO
ALTER TABLE dbo.ShareInvestmentHeads SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.POrders ADD
	InvoiceNo varchar(150) NULL
GO
ALTER TABLE dbo.POrders SET (LOCK_ESCALATION = TABLE)
GO
COMMIT


DROP TYPE InsertPurchaseOrderTable

CREATE TYPE [dbo].[InsertPurchaseOrderTable] AS TABLE(
	[OrderDate] [datetime] NULL,
	[ChallanNo] [varchar](150) NULL,
	[SupplierId] [int] NULL,
	[GrandTotal] [decimal](18, 2) NULL,
	[TDiscount] [decimal](18, 2) NULL,
	[TotalAmt] [decimal](18, 2) NULL,
	[RecAmt] [decimal](18, 2) NULL,
	[PaymentDue] [decimal](18, 2) NULL,
	[TotalDue] [decimal](18, 2) NULL,
	[AdjAmount] [decimal](18, 2) NULL,
	[Status] [int] NULL,
	[PPTDisAmt] [decimal](18, 2) NULL,
	[NetDiscount] [decimal](18, 2) NULL,
	[LabourCost] [decimal](18, 2) NULL,
	[ConcernId] [int] NULL,
	[CreateDate] [datetime] NULL,
	[CreatedBy] [int] NULL,
	[IsDamageOrder] [int] NULL,
	[Remarks] [varchar](150) NULL,
	[InvoiceNo] [varchar](150) NULL,
	[Field1] [nvarchar](max) NULL,
	[Field2] [nvarchar](max) NULL,
	[Field3] [decimal](18, 2) NULL,
	[Field4] [decimal](18, 2) NULL,
	[Field5] [int] NULL,
	[Field6] [int] NULL
)
GO



------------------------------------------------------
-----------------Date: 12-05-2021---------------------
------------------------------------------------------
-- exec sp_ProductWiseBenefitReport '2021-04-25 00:00:00','2021-04-25 23:59:59','16'
ALTER PROCEDURE [dbo].[sp_ProductWiseBenefitReport] (
	@Fromdate DATETIME,
	@ToDate DATETIME,
	@ConcernID INT
	)
AS
WITH Final_table
AS (
	SELECT P.Code,
		P.ProductID,
		P.ProductName,
		C.Description AS 'CategoryName',
		STD.IMENO,
		(((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity AS 'SalesTotal',
		(SOD.PPDAmount + (((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity AS 'Discount',
		(SOD.PRate * SOD.Quantity) AS 'PurchaseTotal',
		((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity) - (SOD.PRate* SOD.Quantity) AS 'CommisionProfit',
		0.00 AS 'HireProfit',
		0.00 AS 'HireCollection',
		((((SOD.UnitPrice - SOD.PPDAmount) - ((SO.TDAmount + SO.AdjAmount) / (SO.GrandTotal - SO.NetDiscount + SO.TDAmount)) * (SOD.UnitPrice - SOD.PPDAmount))) * SOD.Quantity) - (SOD.PRate * SOD.Quantity) AS 'TotalProfit'
	FROM SOrderDetails SOD
	INNER JOIN SOrders SO ON SOD.SOrderID = SO.SOrderID
	INNER JOIN StockDetails STD ON STD.SDetailID = SOD.SDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE SO.STATUS = 1 AND SO.InvoiceDate >= @Fromdate AND SO.InvoiceDate <= @ToDate AND SO.ConcernID = @ConcernID
	
	UNION ALL
	
	SELECT P.Code,
		P.ProductID,
		P.ProductName,
		C.Description AS 'CategoryName',
		STD.IMENO,
		(SOD.UnitPrice* SOD.Quantity) * (-1) AS 'SalesTotal',
		0 AS 'Discount',
		(STD.PRate * SOD.Quantity) * ( -1) AS 'PurchaseTotal',
		((SOD.UnitPrice* SOD.Quantity) - (STD.PRate*SOD.Quantity ))* -1 AS 'CommisionProfit',
		0.00 AS 'HireProfit',
		0.00 AS 'HireCollection',
		((SOD.UnitPrice* SOD.Quantity) - (STD.PRate*SOD.Quantity ))* -1 AS 'TotalProfit'
	FROM ROrderDetails SOD
	INNER JOIN ROrders SO ON SOD.ROrderID = SO.ROrderID
	INNER JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE SO.ReturnDate >= @Fromdate AND SO.ReturnDate <= @ToDate AND SO.ConcernID = @ConcernID
	
	UNION ALL
	
	SELECT p.Code,
		P.ProductID,
		P.ProductName,
		C.Description AS 'CategoryName',
		STD.IMENO,
		(((CSP.UnitPrice+CSP.IntTotalAmt)-((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt)) * CSP.Quantity) AS 'SalesTotal',
		((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt) * CSP.Quantity AS 'Discount',
		STD.PRate * CSP.Quantity AS 'PurchaseTotal',
		(((CSP.UnitPrice+CSP.IntTotalAmt)-((LastPayAdjAmt+Discount)*(CSP.UnitPrice+CSP.IntTotalAmt)/TSalesAmt)) * CSP.Quantity) - (STD.PRate * CSP.Quantity) AS 'CommisionProfit',
		(CSP.IntTotalAmt * CSP.Quantity) AS 'HireProfit',
		0 AS 'HireCollection',
		0 AS 'TotalProfit'
	FROM CreditSaleDetails CSP
	INNER JOIN CreditSales CS ON CS.CreditSalesID = CSP.CreditSalesID
	INNER JOIN StockDetails STD ON STD.SDetailID = CSP.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CS.ConcernID = @ConcernID AND CS.IsStatus=1
	
	UNION ALL
	
	SELECT P.Code,
		P.ProductID,
		P.ProductName,
		C.Description AS 'CategoryName',
		Std.IMENO,
		0 AS 'SalesTotal',
		0 AS 'Discount',
		0 AS 'PurchaseTotal',
		0 AS 'CommisionProfit',
		0 AS 'HireProfit',
		SUM(HireValue) AS 'HireCollection',
		SUM(HireValue) AS 'TotalProfit'
	FROM CreditSales CS
	INNER JOIN CreditSaleDetails CSP ON CSP.CreditSalesID = CS.CreditSalesID
	INNER JOIN CreditSalesSchedules CSD ON CSD.CreditSalesID = CS.CreditSalesID
	INNER JOIN StockDetails STD ON STD.SDetailID = CSP.StockDetailID
	INNER JOIN Products P ON P.ProductID = STD.ProductID
	INNER JOIN Categorys C ON C.CategoryID = P.CategoryID
	WHERE CS.SalesDate >= @Fromdate AND CS.SalesDate <= @ToDate AND CSD.PaymentStatus = 'Paid' AND CS.ConcernID = @ConcernID AND CS.IsStatus=1
	GROUP BY P.Code,
		P.ProductID,
		P.ProductName,
		C.Description,
		Std.IMENO
	)
SELECT Code,
	ProductID,
	ProductName,
	CategoryName,
	IMENO,
	sum(SalesTotal + Discount) AS 'SalesTotal',
	sum(Discount) AS 'Discount',
	sum(SalesTotal) AS 'NetSales',
	sum(PurchaseTotal) AS 'PurchaseTotal',
	sum(CommisionProfit) AS 'CommisionProfit',
	sum(HireProfit) AS 'HireProfit',
	sum(HireCollection) AS 'HireCollection',
	sum(CommisionProfit) + sum(HireCollection) AS 'TotalProfit'
FROM Final_table
GROUP BY Code,
	ProductID,
	ProductName,
	CategoryName,
	IMENO
------------------------------------------------------

ALTER PROCEDURE [dbo].[sp_AddReturnOrder] (
	@SalesOrder [InsertReturnOrderTable] readonly,
	@SODetails [InsertReturnOrderDetailTable] readonly
	)
AS
DECLARE @SalesOrderId INT

BEGIN TRY
	BEGIN TRANSACTION

	INSERT INTO ROrders (
		InvoiceNo,
		ReturnDate,
		GrandTotal,
		CustomerID,
		PaidAmount,
		ConcernID,
		CreatedBy,
		CreateDate,
		ModifiedBy,
		ModifiedDate
		) (
		SELECT InvoiceNo,
		InvoiceDate,
		GrandTotal,
		CustomerID,
		RecAmt,
		ConcernID,
		CreatedBy,
		CreateDate,
		CreatedBy,
		CreateDate FROM @SalesOrder
		)

	SET @SalesOrderId = SCOPE_IDENTITY()

	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @GodownID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @SID INT
	DECLARE @Quantity INT
	DECLARE @SQty INT
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT
	DECLARE @ProductType INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT std.ProductID,
		std.ColorID,
		std.GodownID,
		sod1.Quantity,
		sod1.StockDetailId,
		p.ProductType
	FROM @SODetails sod1
	INNER JOIN StockDetails std ON std.SDetailID = sod1.StockDetailId
	INNER JOIN Products p on sod1.ProductId = p.ProductID

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SDetailID,
		@ProductType

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity != 0
		BEGIN
			IF(@ProductType=2) --Nobarcode
			BEGIN
				SET @SID = (
						SELECT min(sod.SOrderDetailID)
						FROM SOrderDetails sod
						INNER JOIN SOrders SO ON sod.SOrderID = SO.SOrderID
						INNER JOIN @SODetails sod1 ON sod1.ProductId = sod.ProductID
						INNER JOIN @SalesOrder so1 ON so1.CustomerID = SO.CustomerID
						INNER JOIN StockDetails std ON std.SDetailID = sod.SDetailID
						WHERE IsProductReturn != 1 and sod.ProductID=@ProductID and std.ColorID=@ColorID and std.GodownID=@GodownID
						)

				SET @SQty = (
						SELECT sum(quantity - RQuantity)
						FROM SOrderDetails
						WHERE SOrderDetailID = @SID
						)
				SET @SDetailID = (
						SELECT min(SDetailID)
						FROM SOrderDetails
						WHERE SOrderDetailID = @SID
						)
			END
			ELSE --Barcode
			BEGIN
				SET @SQty=1
				SET @SID = (
						SELECT MAX(sod.SOrderDetailID)
						FROM SOrderDetails sod
						WHERE IsProductReturn != 1 and sod.SDetailID=@SDetailID
						)
			END

			IF (@SQty > @Quantity)
			BEGIN
				SET @StockID = (
						SELECT min(StockID)
						FROM StockDetails
						WHERE SDetailID = @SDetailID
						)

				UPDATE Stocks
				SET Quantity = Quantity + @Quantity
				WHERE StockID = @StockID

				UPDATE stockdetails
				SET quantity = quantity + @Quantity,Status=1
				WHERE sdetailid = @SDetailID

				UPDATE SOrderDetails
				SET IsProductReturn = 0,
					RQuantity = RQuantity + @Quantity
				WHERE SOrderDetailID = @SID

				INSERT INTO ROrderDetails (
					ROrderID,
					ProductID,
					Quantity,
					UnitPrice,
					UTAmount,
					StockDetailID,
					ColorID,
					CheckNo,
					SQty,
					Quant,
					SID
					) (
					SELECT @SalesOrderId,
					sod.ProductId,
					@Quantity,
					sod.UnitPrice,
					sod.TAmount,
					@SDetailID,
					sod.ColorId,
					1,
					@SQty,
					@Quantity,
					@SID FROM @SODetails sod
					join StockDetails sd on sd.SDetailID = sod.StockDetailId
					where sod.ProductId=@ProductID and sod.ColorId=@ColorID and sd.GodownID=@GodownID
					)

				SET @Quantity = 0
			END
			ELSE IF (@SQty < @Quantity)
			BEGIN
				SET @StockID = (
						SELECT min(StockID)
						FROM StockDetails
						WHERE SDetailID = @SDetailID
						)

				UPDATE Stocks
				SET Quantity = Quantity + @SQty
				WHERE StockID = @StockID

				UPDATE stockdetails
				SET quantity = quantity + @SQty,Status=1
				WHERE sdetailid = @SDetailID

				UPDATE SOrderDetails
				SET IsProductReturn = 1,
					RQuantity = RQuantity + @SQty
				WHERE SOrderDetailID = @SID

				INSERT INTO ROrderDetails (
					ROrderID,
					ProductID,
					Quantity,
					UnitPrice,
					UTAmount,
					StockDetailID,
					ColorID,
					CheckNo,
					SQty,
					Quant,
					SID
					) (
					SELECT @SalesOrderId,
					sod.ProductId,
					@SQty,
					sod.UnitPrice,
					sod.TAmount,
					@SDetailID,
					@ColorID,
					2,
					@SQty,
					@Quantity,
					@SID FROM @SODetails sod
					join StockDetails sd on sd.SDetailID = sod.StockDetailId
					where sod.ProductId=@ProductID and sod.ColorId=@ColorID and sd.GodownID=@GodownID
					)

				SET @Quantity = @Quantity - @SQty
			END
					--Check No 3
			ELSE
			BEGIN
				SET @StockID = (
						SELECT min(StockID)
						FROM StockDetails
						WHERE SDetailID = @SDetailID
						)

				UPDATE Stocks
				SET Quantity = Quantity + @SQty
				WHERE StockID = @StockID

				IF(@ProductType=2)
				UPDATE stockdetails
				SET quantity = quantity + @SQty,Status=1
				WHERE sdetailid = @SDetailID
				else
				UPDATE stockdetails
				SET Status=1
				WHERE sdetailid = @SDetailID

				UPDATE SOrderDetails
				SET IsProductReturn = 1,
					RQuantity = RQuantity + @SQty
				WHERE SOrderDetailID = @SID

				INSERT INTO ROrderDetails (
					ROrderID,
					ProductID,
					Quantity,
					UnitPrice,
					UTAmount,
					StockDetailID,
					ColorID,
					CheckNo,
					SQty,
					Quant,
					SID
					) (
					SELECT @SalesOrderId,
					sod.ProductId,
					@SQty,
					sod.UnitPrice,
					sod.TAmount,
					@SDetailID,
					@ColorID,
					3,
					@SQty,
					@Quantity,
					@SID FROM @SODetails sod
					join StockDetails sd on sd.SDetailID = sod.StockDetailId
					where sod.ProductId=@ProductID and sod.ColorId=@ColorID and sd.GodownID=@GodownID
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GOdownID,
			@Quantity,
			@SDetailID,
		    @ProductType
	END

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.TotalDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	----For SR Visit
	----UPDATE SRVisitDetails
	----SET SRVisitDetails.Quantity = (SRVisitDetails.Quantity - s.Quantity)
	----from @SODetails s
	----JOIN SRVisitDetails ON SRVisitDetails.ProductID = s.ProductId AND SRVisitDetails.ColorID= s.ColorId
	--UPDATE SRVProductDetails
	--SET SRVProductDetails.Status = 4
	--from @SODetails s
	--JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	--where SRVProductDetails.Status=2


	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	RETURN 0;
END CATCH

UPDATE SOrderDetails
SET RQuantity = 0
WHERE RQuantity IS NULL

------------------------------------------------------

--EXEC sp_DailyCashInHand  '11 MAY 2021 12:00:00 AM','11 MAY 2021 11:59:59 PM',16
ALTER procedure [dbo].[sp_DailyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-08-01'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END




-- SELECT * FROM SisterConcerns
--set @CashInHand=@CashInHand+isnull(( select sum(Amount) from ShareInvestments  SI
--join  ShareInvestmentHeads SIH on SIH.SIHID=SI.SIHID 
--join ShareInvestmentHeads ph on SIH.ParentId=ph.SIHID
--where SIH.ConcernID=@ConcernID and ph.Name='Current Asset'
--),0)
set @CashInHand = ISNULL((Select Amount from PrevBalances where Date=@FromDate AND concernid=@ConcernID ),0)
if(@CashInHand!=0)
BEGIN
set @StartDate = @FromDate
END


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(DAY, 1, Convert(date, GetDate()))
begin
	print @StartDate

	delete
	from #temp_Data1

	delete
	from #temp_Data2

	--	DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
	--	DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
	------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
	insert into #temp_Data1
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate) and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Cash Paid', @total, 'Cash Sales', 0, 'Order'

	---------------------------------Expense from Bank Deposit--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on BT.CustomerID = c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	---------------------------------Expens from Bank Cash Delivery---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Expense from Fund Out---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Cash Delivery to Supplier', @total, 'Due Collection', 0, 'Cash'

	------------------------------------------------------Expense in Product return----------------------------------
	set @total = isnull((
				select sum(PaidAmount)
				from ROrders
				where ConcernID = @ConcernID and DAY(Convert(date, ReturnDate)) = DAY(@StartDate) and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
	-----Hire Sales Payment charge----------------
    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
	------------- -------------------------------------------- Direct Expense--------------------------------------------
	if (
			(
				isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' 
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
				) != 0
			)
	begin
		insert into #temp_Data1
		select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' 
		 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description
	end

	-- ----------------------------Expens from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
				WHERE (PH.Name='Liability' AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)
	IF (@total != 0)
		INSERT INTO #temp_Data1
		SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
		WHERE (PH.Name='Liability' AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name


	----------------------------------------------Opening Cash In Hand in Income Table--------------------------------------------------------------- 
	insert into #temp_Data2
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	-----------------------------------------------Income in Sales Order-------------------------------------------
	set @total = isnull((
				select sum(RecAmount)
				from SOrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount,Convert(varchar(10),c.CustomerType)+'Order' from SOrders so
		join Customers c on so.CustomerID = c.CustomerID
		where so.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
	    insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
   
   END
	---------------------------------Income from Bank Withdwal--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Cash Collection---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
		('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on bt.CustomerID=c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	----------------------------------------Income from Fund IN------------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.AnotherBankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.AnotherBankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-- ---------------------------------------Income from Cash Collection from Customer-------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
				), 0)

	if (@total != 0)
	BEGIN
	insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, Convert(varchar(10),c.CustomerType)+'Cash'
		from CashCollections cc
		join Customers c on cc.CustomerID = c.CustomerID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
	    insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')
		
		END
	-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
	set @total = isnull((
				select isnull(sum(DownPayment), 0)
				from CreditSales
				where ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
		from CreditSales cs
		join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')
	
	END
	--------------------------------------Income in Purchase Product return----------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and DAY(Convert(date, OrderDate)) = DAY(@StartDate) and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and status = 5
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Purchase Return Cash'

	-------------------------------Income Installment Collection from Creditsales------------------
	set @total = isnull((
				select sum(InstallmentAmt)
				from CreditSalesSchedules css
				inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
				where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
		from CreditSalesSchedules css
		inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
		inner join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
	  
	  insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')
	
	END
	-----------------------------------Income from Direct Income------------------------------------------------
	if (
			(
				isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
				) != 0
			)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Description, sum(Amount), E.Description
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 2 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')
	
	end

	-- ----------------------------Income from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
				WHERE (PH.Name = 'Liability' AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
		WHERE (PH.Name = 'Liability' AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
	END

	   SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
				WHERE (PH.Name='Current Asset' AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)
	IF (@total != 0)
	BEGIN
		INSERT INTO #temp_Data2
		SELECT @StartDate, '', 0.00,SIH.Name+'(Current Asset)',  sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
		WHERE (PH.Name='Current Asset' AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name

		insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')
	END

	insert into #temp_Data3
	select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), '', 0.00,  ''
	from #temp_Data1 T1
	UNION ALL
	select @StartDate, 0,  '', 0, isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
	from #temp_Data2 T2

	declare @a decimal(18, 2)
	declare @b decimal(18, 2)
	declare @ExpenseWithinDate decimal(18, 2)
	declare @IncomeWithinDate decimal(18, 2)
	declare @CashInHandWithinDate decimal(18, 2)

	set @a = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @b = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @ExpenseWithinDate = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @IncomeWithinDate = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
	set @CashInHand = @CashInHand + (@b - @a)

	insert into #temp_Data3
	values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

	insert into #temp_Data3
	values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

	insert into #temp_Data3
	values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

	set @StartDate = DATEADD(DAY, 1, @StartDate)
	--select *From #temp_Data1
	--select *From #temp_Data2
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)
------------------------------------------------------
-----------------Date: 29-04-2021---------------------
------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SMSStatus ADD
	Message_ID int NULL
GO
ALTER TABLE dbo.SMSStatus SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

------------------------------------------------------
-----------------Date: 21-04-2021---------------------
------------------------------------------------------

ALTER PROCEDURE [dbo].[AddSalesOrder] (
	@SalesOrder [INSERTSALESORDERTABLE] readonly,
	@SODetails [INSERTSODETAILTABLE] readonly,
	@RemindDate DATE,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
DECLARE @SalesOrderId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY
	BEGIN TRANSACTION

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @SalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

	--------------------------------------------------
	-----------Card Payment Bank Deposit--------------
	--------------------------------------------------
	INSERT INTO sorders (
		invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdpercentage,
		tdamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamount,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		BankTransID
		) (
		SELECT invoicedate,
		invoiceno,
		customerid,
		vatpercentage,
		vatamount,
		grandtotal,
		tdiscountpercentage,
		tdiscountamount,
		netdiscount,
		totalamount,
		paymentdue,
		recamt,
		adjamount,
		totaldue,
		STATUS,
		concernid,
		createdby,
		createdate,
		totaloffer,
		Remarks,
		CardTypeSetupID,
		CardPaidAmount,
		DepositChargePercent,
		@BankTransID FROM @SalesOrder
		)

	SET @SalesOrderId = Scope_identity()

	INSERT INTO SOrderDetails (
		ProductID,
		Quantity,
		UnitPrice,
		UTAmount,
		PPDPercentage,
		PPDAmount,
		MPRate,
		SOrderID,
		SDetailId,
		PPOffer,
		SRate,
		PRate,
		Compressor,
		Motor,
		Panel,
		Spareparts,
		Service
		) (
		SELECT SOD.ProductId,
		SOD.Quantity,
		SOD.UnitPrice,
		SOD.TAmount,
		SOD.PPDisPer,
		SOD.PPDisAmt,
		SOD.MrpRate,
		@SalesOrderId SOrderID,
		SOD.StockDetailId,
		SOD.PPOffer,
		(SOD.UnitPrice - SOD.PPDisAmt),
		STD.PRate,
		p.CompressorWarrentyMonth,
		p.PanelWarrentyMonth,
		p.MotorWarrentyMonth,
		p.SparePartsWarrentyMonth,
		p.ServiceWarrentyMonth FROM @SODetails SOD INNER JOIN StockDetails STD
		ON STD.SDetailID = SOD.StockDetailId INNER JOIN Products p
		ON STD.ProductID = p.ProductID WHERE P.ProductType = 1 OR p.ProductType = 3
		)

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue),
		reminddate = @RemindDate
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NOT NULL

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue)
	FROM @SalesOrder s
	INNER JOIN customers
		ON customers.customerid = s.customerid
	WHERE @RemindDate IS NULL

	--Stock Update 
	CREATE TABLE #tmpStock (
		ProductID INT,
		ColorID INT,
		GodownID INT,
		Qty DECIMAL(18, 2)
		)

	INSERT INTO #tmpStock (
		ProductID,
		ColorID,
		GodownID,
		Qty
		) (
		SELECT s.ProductID,
		s.ColorID,
		s.Compressor,
		SUM(s.Quantity) FROM @SODetails s 
		GROUP BY s.ProductId,
		s.ColorId,
		s.Compressor
		)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st
		ON st.ProductID = sod.ProductID AND st.ColorID = sod.ColorID AND st.GodownID = sod.GodownID

	--For barCode Product 
	UPDATE stockdetails
	SET stockdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN stockdetails
		ON stockdetails.sdetailid = s.stockdetailid
	INNER JOIN products
		ON stockdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	--*****************FIFO for Nobarcode************************** 
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @GodownID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity INT
	DECLARE @SQty INT
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.productid,
		colorid,
		s.Compressor,
		quantity,
		sorderdetailid
	FROM @SODetails s
	INNER JOIN products
		ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity != 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)

			IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity

				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.Compressor=@GodownID AND SOD.colorid = @ColorID
					)

				SET @Quantity = 0
			END
			ELSE IF (@SQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @SQty

				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@SQty,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD INNER JOIN stockdetails STD
					ON STD.sdetailid = @SDetailID INNER JOIN products p
					ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor=@GodownID
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

	--For barCode Product SRVisit Status update 
	UPDATE srvproductdetails
	SET srvproductdetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN srvproductdetails
		ON srvproductdetails.sdetailid = s.stockdetailid AND srvproductdetails.STATUS = 1
	INNER JOIN products
		ON srvproductdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	RETURN 0;
END CATCH
------------------------------------------------------

ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)

	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	--For No barcode Stock Details out and SOrderDetails Insert
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @GodownID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity  decimal(18,2)
	DECLARE @StockQty decimal(18,2)
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.ProductId,
		colorid,
		Compressor,
		s.quantity,
		sorderdetailid
	FROM @SODetails s
    JOIN products ON products.productid = s.productid
	WHERE (products.ProductType = 2 and S.Status=3)

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE (@Quantity != 0)
		BEGIN
			SET @SDetailID = (
					SELECT Min(SDetailID)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @StockQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)
				------------------Debug-------------------------
				--INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
				--VALUES('ProductID: '+Convert(varchar(40),@ProductID)+'Stock Qty:'+Convert(varchar(40),@StockQty),'ColorID: '+Convert(varchar(40),@ColorID)+'GodownID: '+Convert(varchar(40),@GodownID),1,GETDATE())
				----------------------------
			IF (@StockQty > @Quantity)
			BEGIN
				SET @StockQty = @StockQty - @Quantity
			
				UPDATE stockdetails
				SET quantity = @StockQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)

				SET @Quantity = 0
			END
			ELSE IF (@StockQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @StockQty
			
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@StockQty,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID
				
				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid =@SDetailID
					INNER JOIN products p ON STD.productid = p.productid
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

--New Products FIFO END




	--***************************************
	--*********SR visit Update***************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH

------------------------------------------------------

ALTER PROC [dbo].[ReturnSalesOrder]
(
	@SalesOrderId int,
	@UserId int
)
  
AS 
BEGIN TRY
 BEGIN TRANSACTION

 --ExistingBC = 1,
 --NoBarcode = 2,
 --AutoBC = 3  
 Create table #temp(Id int identity(1,1),ProductID int,ColorID int ,GodownID int,Qty decimal(18,2))
 Insert Into #temp(ProductID,ColorID,GodownID,Qty)
 select sod.ProductID,ColorID,GodownID,sum(sod.Quantity) from SOrderDetails sod
 join StockDetails sd on sod.SDetailID = sd.SDetailID
 where sod.SOrderID=@SalesOrderId
 group by sod.ProductID,sd.ColorID,sd.GodownID

UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity + d.Qty), ModifiedBy = @UserId, ModifiedDate = GETDATE()
FROM #temp d
JOIN Stocks ON Stocks.ProductID = d.ProductID and Stocks.ColorID=d.ColorID and Stocks.GodownID=d.GodownID

----Update StockDetails---------------------------------------------

UPDATE StockDetails
SET StockDetails.Status = 1, Quantity=StockDetails.Quantity+d.Quantity
FROM SOrderDetails d
JOIN StockDetails ON StockDetails.SDetailID = d.SDetailID
JOIN Products ON Products.ProductID= StockDetails.ProductID
WHERE d.SOrderID = @SalesOrderId and Products.ProductType=2

UPDATE StockDetails
SET StockDetails.Status = 1
FROM SOrderDetails d
JOIN StockDetails ON StockDetails.SDetailID = d.SDetailID
JOIN Products ON Products.ProductID= StockDetails.ProductID
WHERE d.SOrderID = @SalesOrderId and Products.ProductType!=2
--------------------------------------------------------------------------------------------

UPDATE SRVProductDetails
SET SRVProductDetails.Status = 3
from SOrderDetails s
JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.SDetailID
where SRVProductDetails.Status=2


UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
FROM SOrders s
JOIN Customers ON Customers.CustomerID = s.CustomerID
WHERE s.SOrderID = @SalesOrderId

--DELETE FROM SOrderDetails WHERE SOrderID = @SalesOrderId
Update SOrders Set Status = 2,ModifiedBy=@UserId,ModifiedDate=GETDATE() Where SOrderID = @SalesOrderId

Declare @BankTransID int
Declare @BankID int

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END


COMMIT
RETURN 1

END TRY

BEGIN CATCH
 IF(@@TRANCOUNT>0)
   ROLLBACK
   RETURN 0
END CATCH

------------------------------------------------------
-----------------Date: 20-04-2021---------------------
------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SOrders
	DROP CONSTRAINT FK_SOrders_SisterConcerns
GO
ALTER TABLE dbo.SisterConcerns SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SOrders
	DROP CONSTRAINT FK_SOrders_Customers
GO
ALTER TABLE dbo.Customers SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SOrders
	DROP CONSTRAINT DF_SOrders_TotalDue
GO
ALTER TABLE dbo.SOrders
	DROP CONSTRAINT DF_SOrders_Status
GO
ALTER TABLE dbo.SOrders
	DROP CONSTRAINT DF_SOrders_CreatedBy
GO
ALTER TABLE dbo.SOrders
	DROP CONSTRAINT DF_SOrders_TotalOffer
GO
ALTER TABLE dbo.SOrders
	DROP CONSTRAINT DF_SOrders_PGrandTotal
GO
ALTER TABLE dbo.SOrders
	DROP CONSTRAINT DF_SOrders_IsReplacement
GO
ALTER TABLE dbo.SOrders
	DROP CONSTRAINT DF_SOrders_BankTransID
GO
ALTER TABLE dbo.SOrders
	DROP CONSTRAINT DF_SOrders_CardPaidAmount
GO
ALTER TABLE dbo.SOrders
	DROP CONSTRAINT DF_SOrders_CardTypeSetupID
GO
ALTER TABLE dbo.SOrders
	DROP CONSTRAINT DF_SOrders_DepositChargePercent
GO
CREATE TABLE dbo.Tmp_SOrders
	(
	SOrderID int NOT NULL IDENTITY (1, 1),
	InvoiceNo varchar(150) NOT NULL,
	InvoiceDate datetime NOT NULL,
	VATPercentage decimal(18, 2) NOT NULL,
	VATAmount decimal(18, 2) NOT NULL,
	GrandTotal decimal(18, 2) NOT NULL,
	TDPercentage decimal(18, 4) NOT NULL,
	TDAmount decimal(18, 2) NOT NULL,
	TotalAmount decimal(18, 2) NOT NULL,
	PaymentDue decimal(18, 2) NOT NULL,
	RecAmount decimal(18, 2) NULL,
	NetDiscount decimal(18, 2) NULL,
	Remarks varchar(350) NULL,
	CustomerID int NOT NULL,
	AdjAmount decimal(18, 2) NOT NULL,
	TotalDue decimal(18, 2) NOT NULL,
	Status int NOT NULL,
	ConcernID int NOT NULL,
	CreatedBy int NOT NULL,
	CreateDate datetime NULL,
	ModifiedBy int NULL,
	ModifiedDate datetime NULL,
	TotalOffer decimal(18, 2) NOT NULL,
	PGrandTotal decimal(18, 2) NOT NULL,
	IsReplacement int NOT NULL,
	BankTransID int NOT NULL,
	CardPaidAmount decimal(18, 2) NOT NULL,
	CardTypeSetupID int NOT NULL,
	DepositChargePercent decimal(18, 2) NOT NULL
	)  ON [PRIMARY]
GO
ALTER TABLE dbo.Tmp_SOrders SET (LOCK_ESCALATION = TABLE)
GO
ALTER TABLE dbo.Tmp_SOrders ADD CONSTRAINT
	DF_SOrders_TDPercentage DEFAULT 0 FOR TDPercentage
GO
ALTER TABLE dbo.Tmp_SOrders ADD CONSTRAINT
	DF_SOrders_TotalDue DEFAULT ((0)) FOR TotalDue
GO
ALTER TABLE dbo.Tmp_SOrders ADD CONSTRAINT
	DF_SOrders_Status DEFAULT ((0)) FOR Status
GO
ALTER TABLE dbo.Tmp_SOrders ADD CONSTRAINT
	DF_SOrders_CreatedBy DEFAULT ((1)) FOR CreatedBy
GO
ALTER TABLE dbo.Tmp_SOrders ADD CONSTRAINT
	DF_SOrders_TotalOffer DEFAULT ((0)) FOR TotalOffer
GO
ALTER TABLE dbo.Tmp_SOrders ADD CONSTRAINT
	DF_SOrders_PGrandTotal DEFAULT ((0)) FOR PGrandTotal
GO
ALTER TABLE dbo.Tmp_SOrders ADD CONSTRAINT
	DF_SOrders_IsReplacement DEFAULT ((0)) FOR IsReplacement
GO
ALTER TABLE dbo.Tmp_SOrders ADD CONSTRAINT
	DF_SOrders_BankTransID DEFAULT ((0)) FOR BankTransID
GO
ALTER TABLE dbo.Tmp_SOrders ADD CONSTRAINT
	DF_SOrders_CardPaidAmount DEFAULT ((0)) FOR CardPaidAmount
GO
ALTER TABLE dbo.Tmp_SOrders ADD CONSTRAINT
	DF_SOrders_CardTypeSetupID DEFAULT ((0)) FOR CardTypeSetupID
GO
ALTER TABLE dbo.Tmp_SOrders ADD CONSTRAINT
	DF_SOrders_DepositChargePercent DEFAULT ((0)) FOR DepositChargePercent
GO
SET IDENTITY_INSERT dbo.Tmp_SOrders ON
GO
IF EXISTS(SELECT * FROM dbo.SOrders)
	 EXEC('INSERT INTO dbo.Tmp_SOrders (SOrderID, InvoiceNo, InvoiceDate, VATPercentage, VATAmount, GrandTotal, TDPercentage, TDAmount, TotalAmount, PaymentDue, RecAmount, NetDiscount, Remarks, CustomerID, AdjAmount, TotalDue, Status, ConcernID, CreatedBy, CreateDate, ModifiedBy, ModifiedDate, TotalOffer, PGrandTotal, IsReplacement, BankTransID, CardPaidAmount, CardTypeSetupID, DepositChargePercent)
		SELECT SOrderID, InvoiceNo, InvoiceDate, VATPercentage, VATAmount, GrandTotal, TDPercentage, TDAmount, TotalAmount, PaymentDue, RecAmount, NetDiscount, Remarks, CustomerID, AdjAmount, TotalDue, Status, ConcernID, CreatedBy, CreateDate, ModifiedBy, ModifiedDate, TotalOffer, PGrandTotal, IsReplacement, BankTransID, CardPaidAmount, CardTypeSetupID, DepositChargePercent FROM dbo.SOrders WITH (HOLDLOCK TABLOCKX)')
GO
SET IDENTITY_INSERT dbo.Tmp_SOrders OFF
GO
ALTER TABLE dbo.SOrderDetails
	DROP CONSTRAINT FK_SOrderDetails_SOrders
GO
DROP TABLE dbo.SOrders
GO
EXECUTE sp_rename N'dbo.Tmp_SOrders', N'SOrders', 'OBJECT' 
GO
ALTER TABLE dbo.SOrders ADD CONSTRAINT
	PK_SOrders PRIMARY KEY CLUSTERED 
	(
	SOrderID
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

GO
ALTER TABLE dbo.SOrders ADD CONSTRAINT
	FK_SOrders_Customers FOREIGN KEY
	(
	CustomerID
	) REFERENCES dbo.Customers
	(
	CustomerID
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
ALTER TABLE dbo.SOrders ADD CONSTRAINT
	FK_SOrders_SisterConcerns FOREIGN KEY
	(
	ConcernID
	) REFERENCES dbo.SisterConcerns
	(
	ConcernID
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SOrderDetails ADD CONSTRAINT
	FK_SOrderDetails_SOrders FOREIGN KEY
	(
	SOrderID
	) REFERENCES dbo.SOrders
	(
	SOrderID
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
ALTER TABLE dbo.SOrderDetails SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SOrderDetails
	DROP CONSTRAINT FK_SOrderDetails_SOrders
GO
ALTER TABLE dbo.SOrders SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SOrderDetails
	DROP CONSTRAINT FK_SOrderDetails_Products
GO
ALTER TABLE dbo.Products SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SOrderDetails
	DROP CONSTRAINT DF_SOrderDetails_SOrderID
GO
ALTER TABLE dbo.SOrderDetails
	DROP CONSTRAINT DF__SOrderDet__Stock__0EC32C7A
GO
ALTER TABLE dbo.SOrderDetails
	DROP CONSTRAINT DF_SOrderDetails_PPOffer
GO
ALTER TABLE dbo.SOrderDetails
	DROP CONSTRAINT DF_SOrderDetails_SRate
GO
ALTER TABLE dbo.SOrderDetails
	DROP CONSTRAINT DF_SOrderDetails_PRate
GO
ALTER TABLE dbo.SOrderDetails
	DROP CONSTRAINT DF_SOrderDetails_Remarks
GO
ALTER TABLE dbo.SOrderDetails
	DROP CONSTRAINT DF_SOrderDetails_IsProductReturn
GO
ALTER TABLE dbo.SOrderDetails
	DROP CONSTRAINT DF_SOrderDetails_RQuantity
GO
ALTER TABLE dbo.SOrderDetails
	DROP CONSTRAINT DF_SOrderDetails_ReplaceProductType
GO
CREATE TABLE dbo.Tmp_SOrderDetails
	(
	SOrderDetailID int NOT NULL IDENTITY (1, 1),
	ProductID int NOT NULL,
	UnitPrice decimal(18, 2) NOT NULL,
	PPDPercentage decimal(18, 4) NOT NULL,
	PPDAmount decimal(18, 2) NOT NULL,
	Quantity decimal(18, 2) NOT NULL,
	UTAmount decimal(18, 2) NOT NULL,
	SOrderID int NOT NULL,
	MPRate decimal(18, 2) NOT NULL,
	SDetailID int NOT NULL,
	PPOffer decimal(18, 2) NOT NULL,
	SRate decimal(18, 2) NOT NULL,
	PRate decimal(18, 2) NOT NULL,
	RStockDetailId int NULL,
	RepOrderID int NULL,
	RepUnitPrice decimal(18, 2) NULL,
	Remarks varchar(500) NULL,
	IsProductReturn int NOT NULL,
	Compressor varchar(200) NULL,
	Motor varchar(200) NULL,
	Panel varchar(200) NULL,
	Spareparts varchar(200) NULL,
	Service varchar(200) NULL,
	RQuantity decimal(18, 2) NOT NULL,
	ReplaceProductType int NOT NULL
	)  ON [PRIMARY]
GO
ALTER TABLE dbo.Tmp_SOrderDetails SET (LOCK_ESCALATION = TABLE)
GO
ALTER TABLE dbo.Tmp_SOrderDetails ADD CONSTRAINT
	DF_SOrderDetails_PPDPercentage DEFAULT 0 FOR PPDPercentage
GO
ALTER TABLE dbo.Tmp_SOrderDetails ADD CONSTRAINT
	DF_SOrderDetails_SOrderID DEFAULT ((0)) FOR SOrderID
GO
ALTER TABLE dbo.Tmp_SOrderDetails ADD CONSTRAINT
	DF__SOrderDet__Stock__0EC32C7A DEFAULT ((1)) FOR SDetailID
GO
ALTER TABLE dbo.Tmp_SOrderDetails ADD CONSTRAINT
	DF_SOrderDetails_PPOffer DEFAULT ((0)) FOR PPOffer
GO
ALTER TABLE dbo.Tmp_SOrderDetails ADD CONSTRAINT
	DF_SOrderDetails_SRate DEFAULT ((0)) FOR SRate
GO
ALTER TABLE dbo.Tmp_SOrderDetails ADD CONSTRAINT
	DF_SOrderDetails_PRate DEFAULT ((0)) FOR PRate
GO
ALTER TABLE dbo.Tmp_SOrderDetails ADD CONSTRAINT
	DF_SOrderDetails_Remarks DEFAULT ('') FOR Remarks
GO
ALTER TABLE dbo.Tmp_SOrderDetails ADD CONSTRAINT
	DF_SOrderDetails_IsProductReturn DEFAULT ((0)) FOR IsProductReturn
GO
ALTER TABLE dbo.Tmp_SOrderDetails ADD CONSTRAINT
	DF_SOrderDetails_RQuantity DEFAULT ((0)) FOR RQuantity
GO
ALTER TABLE dbo.Tmp_SOrderDetails ADD CONSTRAINT
	DF_SOrderDetails_ReplaceProductType DEFAULT ((0)) FOR ReplaceProductType
GO
SET IDENTITY_INSERT dbo.Tmp_SOrderDetails ON
GO
IF EXISTS(SELECT * FROM dbo.SOrderDetails)
	 EXEC('INSERT INTO dbo.Tmp_SOrderDetails (SOrderDetailID, ProductID, UnitPrice, PPDPercentage, PPDAmount, Quantity, UTAmount, SOrderID, MPRate, SDetailID, PPOffer, SRate, PRate, RStockDetailId, RepOrderID, RepUnitPrice, Remarks, IsProductReturn, Compressor, Motor, Panel, Spareparts, Service, RQuantity, ReplaceProductType)
		SELECT SOrderDetailID, ProductID, UnitPrice, PPDPercentage, PPDAmount, Quantity, UTAmount, SOrderID, MPRate, SDetailID, PPOffer, SRate, PRate, RStockDetailId, RepOrderID, RepUnitPrice, Remarks, IsProductReturn, Compressor, Motor, Panel, Spareparts, Service, RQuantity, ReplaceProductType FROM dbo.SOrderDetails WITH (HOLDLOCK TABLOCKX)')
GO
SET IDENTITY_INSERT dbo.Tmp_SOrderDetails OFF
GO
DROP TABLE dbo.SOrderDetails
GO
EXECUTE sp_rename N'dbo.Tmp_SOrderDetails', N'SOrderDetails', 'OBJECT' 
GO
ALTER TABLE dbo.SOrderDetails ADD CONSTRAINT
	PK_SOrderDetails PRIMARY KEY CLUSTERED 
	(
	SOrderDetailID
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]

GO
CREATE NONCLUSTERED INDEX IX_SOrderDetails_ProductID ON dbo.SOrderDetails
	(
	ProductID
	) WITH( STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
ALTER TABLE dbo.SOrderDetails ADD CONSTRAINT
	FK_SOrderDetails_Products FOREIGN KEY
	(
	ProductID
	) REFERENCES dbo.Products
	(
	ProductID
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
ALTER TABLE dbo.SOrderDetails ADD CONSTRAINT
	FK_SOrderDetails_SOrders FOREIGN KEY
	(
	SOrderID
	) REFERENCES dbo.SOrders
	(
	SOrderID
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
COMMIT

------------------------------------------------------
drop proc UpdateSalesOrder
drop proc AddSalesOrder
drop type InsertSalesOrderTable
drop type InsertSODetailTable

CREATE TYPE [dbo].[InsertSalesOrderTable] AS TABLE(
	[InvoiceDate] [datetime] NULL,
	[InvoiceNo] [varchar](150) NULL,
	[VatPercentage] [decimal](18, 2) NULL,
	[VatAmount] [decimal](18, 2) NULL,
	[GrandTotal] [decimal](18, 2) NULL,
	[TDiscountPercentage] [decimal](18, 4) NULL,
	[TDiscountAmount] [decimal](18, 2) NULL,
	[RecAmt] [decimal](18, 2) NULL,
	[PaymentDue] [decimal](18, 2) NULL,
	[TotalAmount] [decimal](18, 2) NULL,
	[TotalDue] [decimal](18, 2) NULL,
	[AdjAmount] [decimal](18, 2) NULL,
	[Status] [int] NULL,
	[CustomerId] [int] NULL,
	[ConcernId] [int] NULL,
	[CreatedBy] [int] NULL,
	[CreateDate] [datetime] NULL,
	[TotalOffer] [decimal](18, 2) NULL,
	[NetDiscount] [decimal](18, 2) NULL,
	[Remarks] [varchar](150) NULL,
	[CardPaidAmount] [decimal](18, 2) NULL,
	[CardTypeSetupID] [int] NULL,
	[DepositChargePercent] [decimal](18, 2) NULL
)
GO

CREATE TYPE [dbo].[InsertSODetailTable] AS TABLE(
	[SOrderDetailID] [int] NULL,
	[ProductId] [int] NULL,
	[StockDetailId] [int] NULL,
	[ColorId] [int] NULL,
	[Status] [int] NULL,
	[Quantity] [decimal](18, 2) NULL,
	[UnitPrice] [decimal](18, 2) NULL,
	[TAmount] [decimal](18, 2) NULL,
	[PPDisPer] [decimal](18,4) NULL,
	[PPDisAmt] [decimal](18, 2) NULL,
	[MrpRate] [decimal](18, 2) NULL,
	[PPOffer] [decimal](18, 2) NULL,
	[Compressor] [int] NULL,
	[Motor] [int] NULL,
	[Panel] [int] NULL,
	[Spareparts] [int] NULL,
	[Service] [int] NULL
)
GO


------------------------------------------------------
-----------------Date: 18-04-2021---------------------
------------------------------------------------------

ALTER PROCEDURE [dbo].[UpdateSalesOrder] (
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
	)
AS
BEGIN TRY
	BEGIN TRANSACTION

	--status New=3,Updated=4,Deleted=5
	-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
	FROM SOrders s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID
	WHERE s.SOrderID = @SalesOrderId

	UPDATE Customers
	SET Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
	FROM @SalesOrder s
	INNER JOIN Customers ON Customers.CustomerID = s.CustomerID

	UPDATE SOrders
	SET InvoiceDate = s.InvoiceDate,
		InvoiceNo = s.InvoiceNo,
		CustomerID = s.CustomerID,
		VATPercentage = s.VATPercentage,
		VATAmount = s.VATAmount,
		GrandTotal = s.GrandTotal,
		TDPercentage = s.TDiscountPercentage,
		TDAmount = s.TDiscountAmount,
		NetDiscount = s.NetDiscount,
		TotalAmount = s.TotalAmount,
		PaymentDue = s.PaymentDue,
		RecAmount = s.RecAmt,
		AdjAmount = s.AdjAmount,
		TotalDue = s.TotalDue,
		STATUS = s.STATUS,
		ConcernID = s.ConcernID,
		ModifiedBy = s.CreatedBy,
		ModifiedDate = s.CreateDate
	FROM @SalesOrder s
	WHERE SOrderID = @SalesOrderId

	--***************************
	--Return Old Products Start
	--***************************
	--Stock Details Nobarcode retunr
	UPDATE sd
	SET sd.Quantity = (sd.Quantity + s.Quantity),sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType=2 and tsd.Status=5
	--Barcode return
	UPDATE sd
	SET sd.Status=1
	FROM SOrderDetails s
	INNER JOIN StockDetails sd ON sd.SDetailID = s.SDetailID
	INNER JOIN @SODetails tsd ON s.SOrderDetailID= tsd.SOrderDetailID
	JOIN Products p on sd.ProductID=p.ProductID
	WHERE s.SOrderID=@SalesOrderId and p.ProductType!=2 and tsd.Status=5

	Create Table #tmpStock(ProductID int, ColorID int, GodownID int, Qty decimal(18,2))

	INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where s.Status=5
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity + sod.Qty)
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID
	--***************************
	--Return Old products end
	--***************************

	--delete
	DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

	--Barcode update
	UPDATE sod
	SET sod.ProductID = SD.ProductId,
		sod.Quantity = SD.Quantity,
		sod.UnitPrice = SD.UnitPrice,
		sod.UTAmount = SD.TAmount,
		sod.PPDPercentage = SD.PPDisPer,
		sod.PPDAmount = SD.PPDisAmt,
		sod.MPRate = SD.MrpRate,
		sod.SOrderID = @SalesOrderId,
		sod.SDetailID = SD.StockDetailId,
		sod.Compressor = p.CompressorWarrentyMonth,
		sod.Motor = p.MotorWarrentyMonth,
		sod.Panel = p.PanelWarrentyMonth,
		sod.Spareparts = p.SparePartsWarrentyMonth,
		sod.Service = p.ServiceWarrentyMonth,
		sod.PRate = std.PRate
	FROM @SODetails SD
	JOIN SOrderDetails sod on SD.SOrderDetailID = sod.SOrderDetailID
	Join StockDetails std on SD.StockDetailId = std.SDetailID
	INNER JOIN Products p ON SD.ProductId = p.ProductID
	WHERE SD.STATUS = 4 and p.ProductType!=2

	--Barcode Insert
	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where (P.ProductType!=2 and SOD.Status=3)
	)

	--Stock out
	delete #tmpStock

    INSERT INTO #tmpStock(ProductID,ColorID,GodownID,Qty)
	(select s.ProductID,s.ColorID,s.Compressor,SUM(s.Quantity)  From  @SODetails s
	where  s.Status = 3 OR s.Status = 4
	group by s.ProductId,s.ColorId,s.Compressor
	)

	UPDATE st
	SET st.Quantity = (st.Quantity - sod.Qty),ModifiedBy=@UserId,ModifiedDate=GETDATE()
	FROM #tmpStock sod
	INNER JOIN Stocks st ON st.ProductID = sod.ProductID and st.ColorID=sod.ColorID and st.GodownID=sod.GodownID

	--Stock Details out for Autobarcode or Existing Barcode
	UPDATE StockDetails
	SET StockDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
	JOIN Products p on s.ProductId = p.ProductID
	WHERE (s.Status = 3 OR s.Status = 4) and p.ProductType!=2



	--For No barcode Stock Details out and SOrderDetails Insert
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @GodownID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity  decimal(18,2)
	DECLARE @StockQty decimal(18,2)
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.ProductId,
		colorid,
		Compressor,
		s.quantity,
		sorderdetailid
	FROM @SODetails s
    JOIN products ON products.productid = s.productid
	WHERE (products.ProductType = 2 and S.Status=3)

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID,
		@ColorID,
		@GodownID,
		@Quantity,
		@SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE (@Quantity != 0)
		BEGIN
			SET @SDetailID = (
					SELECT Min(SDetailID)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND GodownID = @GodownID AND quantity != 0 AND STATUS = 1
					)
			SET @StockQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)
				------------------Debug-------------------------
				--INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
				--VALUES('ProductID: '+Convert(varchar(40),@ProductID)+'Stock Qty:'+Convert(varchar(40),@StockQty),'ColorID: '+Convert(varchar(40),@ColorID)+'GodownID: '+Convert(varchar(40),@GodownID),1,GETDATE())
				----------------------------
			IF (@StockQty > @Quantity)
			BEGIN
				SET @StockQty = @StockQty - @Quantity
			
				UPDATE stockdetails
				SET quantity = @StockQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid = SOD.stockdetailid 
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)

				SET @Quantity = 0
			END
			ELSE IF (@StockQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @StockQty
			
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@StockQty,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid = SOD.stockdetailid 
					INNER JOIN products p ON STD.productid = p.productid 
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0,
					STATUS = 2
				WHERE sdetailid = @SDetailID
				
				INSERT INTO sorderdetails (
					productid,
					quantity,
					unitprice,
					utamount,
					ppdpercentage,
					ppdamount,
					mprate,
					sorderid,
					sdetailid,
					ppoffer,
					srate,
					prate,
					compressor,
					motor,
					panel,
					spareparts,
					service
					) (
					SELECT SOD.productid,
					@Quantity,
					SOD.unitprice,
					SOD.tamount,
					SOD.ppdisper,
					SOD.ppdisamt,
					SOD.mrprate,
					@SalesOrderId SOrderID,
					@SDetailID,
					SOD.ppoffer,
					(SOD.unitprice - SOD.ppdisamt),
					STD.prate,
					p.compressorwarrentymonth,
					p.panelwarrentymonth,
					p.motorwarrentymonth,
					p.sparepartswarrentymonth,
					p.servicewarrentymonth FROM @SODetails SOD 
					INNER JOIN stockdetails STD ON STD.sdetailid = SOD.stockdetailid 
					INNER JOIN products p ON STD.productid = p.productid
					WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID AND SOD.Compressor = @GodownID AND STD.SDetailID=@SDetailID AND SOD.Status=3
					)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID,
			@ColorID,
			@GodownID,
			@Quantity,
			@SOrderDetailID
	END

--New Products FIFO END




	--***************************************
	--*********SR visit Update***************
	--***************************************
	--Nobarcode
	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty - s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 5

	--UPDATE SVD
	--SET SVD.SoldQty = SVD.SoldQty + s.Quantity
	--FROM @SODetails s
	--INNER JOIN SRVisitDetails SVD ON SVD.ProductID = s.ProductId AND SVD.ColorID = s.ColorId
	--JOIn SRVisits SRV on svd.SRVisitID = SRV.SRVisitID
	--INNER JOIN products ON s.ProductId = products.ProductID
	--WHERE Products.producttype = 2 and SRV.EmployeeID=@EmployeeID --AND s.STATUS = 3 OR s.STATUS = 4

	--For barCode Product SRVisit Status update
	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 2
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 3 OR s.STATUS = 4

	UPDATE SRVProductDetails
	SET SRVProductDetails.STATUS = 1
	FROM @SODetails s
	INNER JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
	INNER JOIN Products ON SRVProductDetails.ProductID = Products.ProductID
	WHERE Products.ProductType = 1 OR Products.ProductType = 3 AND s.STATUS = 5


	UPDATE SVPD
	SET SVPD.Status=2
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty=0

	UPDATE SVPD
	SET SVPD.Status=1
	FROM @SODetails s
	INNER JOIN SRVProductDetails SVPD ON SVPD.ProductID = s.ProductId AND SVPD.ColorID = s.ColorId
	INNER JOIN SRVisitDetails SRVD on SVPD.SRVisitDID = SRVD.SRVisitDID
	INNER JOIN products ON s.ProductId = products.ProductID
	WHERE Products.producttype = 2 --and SRVD.Quantity-SRVD.SoldQty>0

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK
		Declare @CreatedDate datetime,@CreatedBy int

		select @CreatedBy=CreatedBy,@CreatedDate=CreateDate from @SalesOrder 
		INSERT INTO Errors(Message,StackTrace,CreatedBy,CreateDate)
		VALUES(ERROR_MESSAGE(),ERROR_PROCEDURE()+':'+CONVERT(Varchar(10),ERROR_LINE())+'-'+ERROR_MESSAGE(),@CreatedBy,GETDATE())
	RETURN 0;
END CATCH


------------------------------------------------------
-----------------Date: 12-04-2021---------------------
------------------------------------------------------
ALTER PROC [dbo].[ReturnPurchaseOrder]
(
	@PurchaseOrderId int,
	@UserId int
)
  
AS 
BEGIN TRY
BEGIN TRANSACTION

UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - p.PaymentDue)
FROM POrders p
JOIN Suppliers ON Suppliers.SupplierID = p.SupplierID
WHERE p.POrderID = @PurchaseOrderId

UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity - d.Quantity), ModifiedBy = @UserId, ModifiedDate = GETDATE()
FROM POrderDetails d
JOIN Stocks ON Stocks.ProductID = d.ProductID AND Stocks.ColorID = d.ColorID AND Stocks.GodownID=d.GodownID
WHERE d.POrderID = @PurchaseOrderId

update StockDetails set Status=3 WHERE POrderDetailID IN (SELECT POrderDetailID from POrderDetails WHERE POrderID = @PurchaseOrderId)
--DELETE FROM StockDetails WHERE POrderDetailID IN (SELECT POrderDetailID from POrderDetails WHERE POrderID = @PurchaseOrderId)
--DELETE FROM POProductDetails WHERE POrderDetailID IN(SELECT POrderDetailID from POrderDetails WHERE POrderID = @PurchaseOrderId)
--DELETE FROM POrderDetails WHERE POrderID = @PurchaseOrderId
Update POrders Set Status = 2 Where POrderID = @PurchaseOrderId


COMMIT

RETURN 1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		RETURN 0;
END CATCH
------------------------------------------------------
-----------------Date: 08-04-2021---------------------
------------------------------------------------------
------------------------------------------------------
/****** Object:  Table [dbo].[PrevBalances]    Script Date: 08-04-2021 03:11:19 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[PrevBalances](
	[ID] [int] IDENTITY(1,1) NOT NULL,
	[Date] [datetime] NOT NULL,
	[Amount] [decimal](18, 2) NOT NULL,
	[ConcernID] [int] NOT NULL,
 CONSTRAINT [PK_PrevBalances] PRIMARY KEY CLUSTERED 
(
	[ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[PrevBalances]  WITH CHECK ADD  CONSTRAINT [FK_PrevBalances_SisterConcerns] FOREIGN KEY([ConcernID])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[PrevBalances] CHECK CONSTRAINT [FK_PrevBalances_SisterConcerns]
GO

--------------------------------------------------------------------------------------------------------

/****** Object:  StoredProcedure [dbo].[sp_DailyCashInHand]    Script Date: 08-04-2021 03:55:56 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--EXEC sp_DailyCashInHand  '10 Mar 2021 12:00:00 AM','10 Mar 2021 11:59:59 PM',3051
ALTER procedure [dbo].[sp_DailyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-08-01'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END




-- SELECT * FROM SisterConcerns
--set @CashInHand=@CashInHand+isnull(( select sum(Amount) from ShareInvestments  SI
--join  ShareInvestmentHeads SIH on SIH.SIHID=SI.SIHID 
--join ShareInvestmentHeads ph on SIH.ParentId=ph.SIHID
--where SIH.ConcernID=@ConcernID and ph.Name='Current Asset'
--),0)
set @CashInHand = ISNULL((Select Amount from PrevBalances where Date=@FromDate AND concernid=@ConcernID ),0)
if(@CashInHand!=0)
BEGIN
set @StartDate = @FromDate
END


create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(DAY, 1, Convert(date, GetDate()))
begin
	print @StartDate

	delete
	from #temp_Data1

	delete
	from #temp_Data2

	--	DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
	--	DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
	------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
	insert into #temp_Data1
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, OrderDate)) = DAY(@StartDate) and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Cash Paid', @total, 'Cash Sales', 0, 'Order'

	---------------------------------Expense from Bank Deposit--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 1 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate,('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then 'Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end)), sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on BT.CustomerID = c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	---------------------------------Expens from Bank Cash Delivery---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Expense from Fund Out---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 2
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Cash Delivery to Supplier', @total, 'Due Collection', 0, 'Cash'

	------------------------------------------------------Expense in Product return----------------------------------
	set @total = isnull((
				select sum(PaidAmount)
				from ROrders
				where ConcernID = @ConcernID and DAY(Convert(date, ReturnDate)) = DAY(@StartDate) and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'

------------------------------------------------------Expense in Card Payment----------------------------------
	set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from SOrders
				where ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
				and status = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Retail/Dealer)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from SOrders
		join BankTransactions bt on SOrders.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where SOrders.ConcernID = @ConcernID and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate) 
		and status = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
	-----Hire Sales Payment charge----------------
    set @total = isnull((
				select sum((CardPaidAmount*DepositChargePercent)/100)
				from CreditSales
				where ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
				and IsStatus = 1 and CardPaidAmount>0
				), 0)

	if (@total != 0)
		insert into #temp_Data1
		select @StartDate, b.AccountNo+','+b.BankName+'(Card Payment Charge-Hire)', sum((CardPaidAmount*DepositChargePercent)/100), 'Card Payment Charge', 0, 'Cash'
		from CreditSales
		join BankTransactions bt on CreditSales.BankTransID=bt.BankTranID
		join Banks b on bt.BankID = b.BankID
		where CreditSales.ConcernID = @ConcernID and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate) 
		and IsStatus = 1 and CardPaidAmount>0
		group by b.BankID,b.AccountNo,b.BankName
	------------- -------------------------------------------- Direct Expense--------------------------------------------
	if (
			(
				isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' 
						and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
				) != 0
			)
	begin
		insert into #temp_Data1
		select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 1 and E.Description!='Send cash to head of accounts' 
		 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description
	end

	-- ----------------------------Expens from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
				WHERE (PH.Name='Liability' AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)
	IF (@total != 0)
		INSERT INTO #temp_Data1
		SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
		WHERE (PH.Name='Liability' AND SIH.ConcernID=@ConcernID) AND TransactionType = 2 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name


	----------------------------------------------Opening Cash In Hand in Income Table--------------------------------------------------------------- 
	insert into #temp_Data2
	select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

	-----------------------------------------------Income in Sales Order-------------------------------------------
	set @total = isnull((
				select sum(RecAmount)
				from SOrders
				where ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount,Convert(varchar(10),c.CustomerType)+'Order' from SOrders so
		join Customers c on so.CustomerID = c.CustomerID
		where so.ConcernID = @ConcernID and status = 1 and DAY(Convert(date, InvoiceDate)) = DAY(@StartDate) and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)
	    insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
   
   END
	---------------------------------Income from Bank Withdwal--------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID= @ConcernID and TransactionType = 2 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 4 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	---------------------------------Income from Bank Cash Collection---------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.BankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount),
		('('+ B.AccountNo + ',' + B.BankName +')'+ (case when c.CustomerType=1 or c.CustomerType=3 then ' Previous Bank collections(Retail)' else 'Previous Bank collections(Dealer)' end))
		from BankTransactions BT
		inner join Banks B on BT.BankID = B.BankID
		inner join Customers c on bt.CustomerID=c.CustomerID
		where BT.ConcernID = @ConcernID and TransactionType = 3 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName,c.CustomerType

	----------------------------------------Income from Fund IN------------------------
	set @total = isnull((
				select sum(Amount)
				from BankTransactions BT
				inner join Banks B on BT.AnotherBankID = B.BankID
				where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
		from BankTransactions BT
		inner join Banks B on BT.AnotherBankID = B.BankID
		where BT.ConcernID = @ConcernID and TransactionType = 5 and DAY(Convert(date, TranDate)) = DAY(@StartDate) and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)
		group by B.BankID, B.AccountNo, B.BankName

	-- ---------------------------------------Income from Cash Collection from Customer-------------------
	set @total = isnull((
				select sum(Amount)
				from CashCollections
				where ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
				), 0)

	if (@total != 0)
	BEGIN
	insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, Convert(varchar(10),c.CustomerType)+'Cash'
		from CashCollections cc
		join Customers c on cc.CustomerID = c.CustomerID
		where cc.ConcernID = @ConcernID and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1
	    insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')
		
		END
	-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
	set @total = isnull((
				select isnull(sum(DownPayment), 0)
				from CreditSales
				where ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
		from CreditSales cs
		join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID and IsStatus = 1 and DAY(Convert(date, SalesDate)) = DAY(@StartDate) and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)
		insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')
	
	END
	--------------------------------------Income in Purchase Product return----------------------------------
	set @total = isnull((
				select sum(RecAmt)
				from POrders
				where ConcernID = @ConcernID and DAY(Convert(date, OrderDate)) = DAY(@StartDate) and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and status = 5
				), 0)

	if (@total != 0)
		insert into #temp_Data2
		select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Purchase Return Cash'

	-------------------------------Income Installment Collection from Creditsales------------------
	set @total = isnull((
				select sum(InstallmentAmt)
				from CreditSalesSchedules css
				inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
				where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
				), 0)

	if (@total != 0)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
		from CreditSalesSchedules css
		inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
		inner join Customers c on cs.CustomerID = c.CustomerID
		where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and DAY(Convert(date, PaymentDate)) = DAY(@StartDate) and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)
	  insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')
	
	END
	-----------------------------------Income from Direct Income------------------------------------------------
	if (
			(
				isnull((
						select sum(Amount)
						from Expenditures EX
						inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
						where E.ConcernID = @ConcernID and E.status = 2 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
						), 0)
				) != 0
			)
	BEGIN
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

		insert into #temp_Data2
		select @StartDate as TransDate, '', 0, E.Description, sum(Amount), E.Description
		from Expenditures EX
		inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
		where E.ConcernID = @ConcernID and E.status = 2 and DAY(Convert(date, EntryDate)) = DAY(@StartDate) and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)
		group by E.Description
	    insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')
	
	end

	-- ----------------------------Income from ShareInvestment ----------------------------------------
	SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
				WHERE (PH.Name = 'Liability' AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)

	IF (@total != 0)
	BEGIN
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

		INSERT INTO #temp_Data2
		SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
		WHERE (PH.Name = 'Liability' AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name
		insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
	END

	   SET @total = isnull((
				SELECT sum(Amount)
				FROM ShareInvestments SI
				INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
				INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
				WHERE (PH.Name='Current Asset' AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
				), 0)
	IF (@total != 0)
	BEGIN
		INSERT INTO #temp_Data2
		SELECT @StartDate, '', 0.00,SIH.Name+'(Current Asset)',  sum(Amount), 'Cash'
		FROM ShareInvestments SI
		INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
		INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
		WHERE (PH.Name='Current Asset' AND SIH.ConcernID=@ConcernID) AND TransactionType = 1 AND DAY(Convert(DATE, EntryDate)) = DAY(@StartDate) AND Month(Convert(DATE, EntryDate)) = Month(@StartDate) AND Year(Convert(DATE, EntryDate)) = Year(@StartDate)
		GROUP BY SIH.Name

		insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')
	END

	insert into #temp_Data3
	select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), '', 0.00,  ''
	from #temp_Data1 T1
	UNION 
	select @StartDate, 0,  '', 0, isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
	from #temp_Data2 T2

	declare @a decimal(18, 2)
	declare @b decimal(18, 2)
	declare @ExpenseWithinDate decimal(18, 2)
	declare @IncomeWithinDate decimal(18, 2)
	declare @CashInHandWithinDate decimal(18, 2)

	set @a = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @b = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
				), 0.00)
	set @ExpenseWithinDate = isnull((
				select sum(ExpenseAmt)
				from #temp_Data1
				where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @IncomeWithinDate = isnull((
				select sum(IncomeAmt)
				from #temp_Data2
				where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
				), 0.00)
	set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
	set @CashInHand = @CashInHand + (@b - @a)

	insert into #temp_Data3
	values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

	insert into #temp_Data3
	values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

	insert into #temp_Data3
	values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

	set @StartDate = DATEADD(DAY, 1, @StartDate)
	--select *From #temp_Data1
	--select *From #temp_Data2
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

---------------------------------------------------------------------------------------------------

/****** Object:  StoredProcedure [dbo].[sp_MonthlyCashInHand]    Script Date: 08-04-2021 04:05:18 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_MonthlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0


--set @CashInHand=@CashInHand+isnull(( select sum(Amount) from ShareInvestments  SI
--join  ShareInvestmentHeads SIH on SIH.SIHID=SI.SIHID 
--join ShareInvestmentHeads ph on SIH.ParentId=ph.SIHID
--where SIH.ConcernID=@ConcernID and ph.Name='Current Asset'
--),0)

if(@ConcernID=4)
set @StartDate = '2019-08-30'
ELSE if(@ConcernID=1)
begin
set @StartDate = '2019-10-01'
set @CashInHand=14147
end
ELSE if(@ConcernID=18)
begin
set @StartDate = '2020-06-01'
set @CashInHand=12451
END
ELSE if(@ConcernID=12)
begin
set @StartDate = '2020-08-01'
set @CashInHand=0.00
END
ELSE if(@ConcernID=2028)
begin
set @StartDate = '2020-08-19'
set @CashInHand=1202.00
END
ELSE if(@ConcernID=2030)
begin
set @StartDate = '2020-08-19'
set @CashInHand=2250.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END



set @CashInHand = ISNULL((Select Amount from PrevBalances where Date=@FromDate AND concernid=@ConcernID ),0)
if(@CashInHand!=0)
BEGIN
set @StartDate = @FromDate
END

create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(MONTH, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1  and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, 'Cash Paid', @total, 'Cash Sales', 0, 'Order'

---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Customer Collection(Cr))', sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, 'Cash Delivery to Supplier', @total, 'Due Collection', 0, 'Cash'

------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Month(Convert(date, ReturnDate)) = Month(@StartDate) and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'


------------- -------------------------------------------- Direct Expense--------------------------------------------
if (
(
isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)
) != 0
)
begin
insert into #temp_Data1
select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
end

-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
 WHERE PH.Name='Liability' and SI.ConcernID=@ConcernID AND TransactionType = 2 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
 INSERT INTO #temp_Data1
 SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
 WHERE PH.Name='Liability'and SI.ConcernID=@ConcernID AND TransactionType = 2 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1  and Month(Convert(date, InvoiceDate)) = Month(@StartDate) and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')
  
  END
---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4 and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Month(Convert(date, TranDate)) = Month(@StartDate) and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID  and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1 and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1  and Month(Convert(date, SalesDate)) = Month(@StartDate) and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and Month(Convert(date, OrderDate)) = Month(@StartDate) and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid' and Month(Convert(date, PaymentDate)) = Month(@StartDate) and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
if (
(
isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)
) != 0
)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2 and Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
 WHERE  PH.Name = 'Liability'and SI.ConcernID=@ConcernID AND TransactionType = 1 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
 WHERE PH.Name = 'Liability' and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name

 insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')

 END



 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
 WHERE  PH.Name = 'Current Asset'and SI.ConcernID=@ConcernID AND TransactionType = 1 AND  Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
 INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
 WHERE PH.Name = 'Current Asset' and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Month(Convert(date, EntryDate)) = Month(@StartDate) and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END
 ------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(MONTH, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

--------------------------------------------------------------------------------------------------------

/****** Object:  StoredProcedure [dbo].[sp_YearlyCashInHand]    Script Date: 08-04-2021 04:05:36 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--exec sp_MonthlyCashInHand'2020-01-01 00:00:00','2020-01-31 23:59:59','1'
--EXEC sp_DailyCashInHand  '01 Feb 2019 12:00:00 AM','07 Feb 2019 11:59:59 PM',1
ALTER procedure [dbo].[sp_YearlyCashInHand] (@FromDate datetime, @ToDate datetime, @ConcernID int)
as
declare @id int
declare @total decimal(18, 2)
declare @CashInHand decimal(18, 2)
declare @StartDate date
declare @InitailDate date

--Deposit = 1,
--Withdraw = 2,
--CashCollection = 3,
--CashDelivery = 4,
--FundTransfer = 5
set @StartDate = '2019-02-02'
set @CashInHand = 0

if(@ConcernID=4)
set @StartDate = '2019-02-09'

--set @CashInHand=@CashInHand+isnull(( select sum(Amount) from ShareInvestments  SI
--join  ShareInvestmentHeads SIH on SIH.SIHID=SI.SIHID 
--join ShareInvestmentHeads ph on SIH.ParentId=ph.SIHID
--where SIH.ConcernID=@ConcernID and ph.Name='Current Asset'
--),0)

if (@ConcernID = 1)
	set @CashInHand = 1263.00
else if (@ConcernID = 5)
	set @CashInHand = 8755.00
else if (@ConcernID = 6)
	set @CashInHand = - 2.00
else if (@ConcernID = 4)
	set @CashInHand = 65000.00
else if (@ConcernID = 20)
BEGIN
	set @CashInHand = 137340.00
	set @StartDate = '2020-03-12'
END
ELSE if(@ConcernID=3034)
begin
set @StartDate = '2021-02-01'
set @CashInHand=-595988.00
END
ELSE if(@ConcernID=3051)
begin
set @StartDate = '2021-03-10'
set @CashInHand=131149
END
ELSE if(@ConcernID=3093)
begin
set @StartDate = '2021-02-04'
set @CashInHand=16000
END
ELSE if(@ConcernID=3095)
begin
set @StartDate = '2021-03-08'
set @CashInHand=28100
END
ELSE if(@ConcernID=3063)
begin
set @StartDate = '2021-03-14'
set @CashInHand=192447
END
ELSE if(@ConcernID=5106)
begin
set @StartDate = '2021-04-08'
set @CashInHand=155000
END


set @CashInHand = ISNULL((Select Amount from PrevBalances where Date=@FromDate AND concernid=@ConcernID ),0)
if(@CashInHand!=0)
BEGIN
set @StartDate = @FromDate
END

create table #temp_Data1 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data2 (TransDate date, id int IDENTITY(1, 1), Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

create table #temp_Data3 (TransDate date, id int, Expense varchar(250), ExpenseAmt decimal(18, 2), Income varchar(250), IncomeAmt decimal(18, 2), Module varchar(250))

set @InitailDate=@StartDate
---------------------------------------------------------------------------------------------------------------------------------------
while (@StartDate) < DATEADD(YEAR, 1, Convert(date, GetDate()))
begin
print @StartDate

delete
from #temp_Data1

delete
from #temp_Data2

-- DBCC CHECKIDENT (#temp_Data1, RESEED, 0)
-- DBCC CHECKIDENT (#temp_Data2, RESEED, 0)
------------------------------------------------------  Opening Cash In Hand----------------------------------------------------------------
insert into #temp_Data1
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

--------------- -------------------------------------------- From Purchase Order-------------------------------------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID and status = 1   and Year(Convert(date, OrderDate)) = Year(@StartDate) and  OrderDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, 'Cash Paid', @total, 'Cash Sales', 0, 'Order'

---------------------------------Expense from Bank Deposit--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1 and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Bank Deposit)', sum(Amount), 'Bank Deposit', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 1   and Year(Convert(date, TranDate)) = Year(@StartDate) and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Expense from Bank Cash Collection as Bank Deposit---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Customer Collection(Cr))', sum(Amount), 'Bank Cash Collection as Bank Deposit', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Expens from Bank Cash Delivery---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Cr))', sum(Amount), 'Bank Cash Delivery', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Expense from Fund Out---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, B.AccountNo + ',' + B.BankName + '(Fund Out)', sum(Amount), 'Bank Fund Out', 0, 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-------------------------------------------------------- Expense Cash Delivery to Supplier------------------------------------------------------------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 2
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, 'Cash Delivery to Supplier', @total, 'Due Collection', 0, 'Cash'

------------------------------------------------------Expense in Product return----------------------------------
set @total = isnull((
select sum(PaidAmount)
from ROrders
where ConcernID = @ConcernID  and Year(Convert(date, ReturnDate)) = Year(@StartDate)  and  ReturnDate>= @InitailDate 
), 0)

if (@total != 0)
insert into #temp_Data1
select @StartDate, 'Sales Return', @total, 'Sales Return', 0, 'Cash'


------------- -------------------------------------------- Direct Expense--------------------------------------------
if (
(
isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)
) != 0
)
begin
insert into #temp_Data1
select @StartDate as TransDate, E.Description, sum(Amount), '', 0, 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 1   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
end

-- ----------------------------Expens from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
 WHERE PH.Name='Liability'and SI.ConcernID=@ConcernID AND TransactionType = 2 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
 INSERT INTO #temp_Data1
 SELECT @StartDate, SIH.Name+'(Lia. Pay)', sum(Amount), 'Liabilities Paid', 0, 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
 WHERE PH.Name='Liability' and SI.ConcernID=@ConcernID AND TransactionType = 2 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
----------------------------------------------Opening Cash In Hand in Income Table---------------------------------------------------------------
insert into #temp_Data2
select @StartDate, '', 0, 'Opening Cash In Hand', @CashInHand, 'CashInHand'

-----------------------------------------------Income in Sales Order-------------------------------------------
set @total = isnull((
select sum(RecAmount)
from SOrders
where ConcernID = @ConcernID and status = 1 and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Cash Sales', 0.00, 'Header')

insert into #temp_Data2
select @StartDate 'TransDate', 'Cash Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, so.RecAmount, 'Order' from SOrders so
join Customers c on so.CustomerID = c.CustomerID
where so.ConcernID = @ConcernID and status = 1  and Year(Convert(date, InvoiceDate)) = Year(@StartDate)  and  InvoiceDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Cash Sales', 0.00, 'Total Cash Sales',@total, 'Header')

   END
---------------------------------Income from Bank Withdwal--------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Withdwal', 0, B.AccountNo + ',' + B.BankName + '(Withdrawal)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 2   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Delivery as withdrwal---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Delivery as withdrwal', 0, B.AccountNo + ',' + B.BankName + '(Supplier Payment(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 4  and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

---------------------------------Income from Bank Cash Collection---------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Cash Collection', 0, B.AccountNo + ',' + B.BankName + '(Customer Collection(Dr))', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.BankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 3   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

----------------------------------------Income from Fund IN------------------------
set @total = isnull((
select sum(Amount)
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Bank Fund IN', 0, B.AccountNo + ',' + B.BankName + '(Fund In)', sum(Amount), 'Cash'
from BankTransactions BT
inner join Banks B on BT.AnotherBankID = B.BankID
where BT.ConcernID = @ConcernID and TransactionType = 5   and Year(Convert(date, TranDate)) = Year(@StartDate)  and  TranDate>= @InitailDate
group by B.BankID, B.AccountNo, B.BankName

-- ---------------------------------------Income from Cash Collection from Customer-------------------
set @total = isnull((
select sum(Amount)
from CashCollections
where ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate) and TransactionType = 1  and  EntryDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Cash Collections', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, 'Due Paid', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, cc.Amount, 'Cash'
from CashCollections cc
join Customers c on cc.CustomerID = c.CustomerID
where cc.ConcernID = @ConcernID   and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate and TransactionType = 1
insert into #temp_Data2 values(@StartDate, 'Cash Collections', 0.00, 'Total Cash Collections',@total, 'Header')

END
-- ------------------------------------Income DownPayment from CreditSales   ----------------------------
set @total = isnull((
select isnull(sum(DownPayment), 0)
from CreditSales
where ConcernID = @ConcernID and IsStatus = 1  and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
), 0)

if (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'DownPayment', 0.00, 'Header')
insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, DownPayment, 'DownPayment'
from CreditSales cs
join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID and IsStatus = 1   and Year(Convert(date, SalesDate)) = Year(@StartDate)  and  SalesDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'DownPayment', 0.00, 'Total DownPayment', @total, 'Header')

END
--------------------------------------Income in Purchase Product return----------------------------------
set @total = isnull((
select sum(RecAmt)
from POrders
where ConcernID = @ConcernID  and Year(Convert(date, OrderDate)) = Year(@StartDate)  and  OrderDate>= @InitailDate and status = 5
), 0)

if (@total != 0)
insert into #temp_Data2
select @StartDate, 'Purchase Return', 0, 'Purchase Return', @total, 'Cash'

-------------------------------Income Installment Collection from Creditsales------------------
set @total = isnull((
select sum(InstallmentAmt)
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
where ConcernID = @ConcernID AND css.InstallmentAmt!=0 and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and PaymentDate >= @InitailDate
), 0)

if (@total != 0)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Installment Collection', 0.00, 'Header')

insert into #temp_Data2
select @StartDate, '', 0,RTrim(c.Code)+','+ c.Name+','+c.ContactNo, InstallmentAmt, 'InstallmentCollection'
from CreditSalesSchedules css
inner join CreditSales cs on css.CreditSalesID = cs.CreditSalesID
inner join Customers c on cs.CustomerID = c.CustomerID
where cs.ConcernID = @ConcernID AND  css.InstallmentAmt!=0  and cs.IsStatus = 1 and PaymentStatus = 'Paid'  and Year(Convert(date, PaymentDate)) = Year(@StartDate)  and  PaymentDate>= @InitailDate
insert into #temp_Data2 values(@StartDate, 'Installment Collection', 0.00, 'Total Installment Collection', @total, 'Header')

END
-----------------------------------Income from Direct Income------------------------------------------------
if (
(
isnull((
select sum(Amount)
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
), 0)
) != 0
)
BEGIN
   insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Direct Income', 0.00, 'Header')

insert into #temp_Data2
select @StartDate as TransDate, '', 0, E.Description, sum(Amount), 'EX'
from Expenditures EX
inner join ExpenseItems E on E.ExpenseItemID = EX.ExpenseItemID
where EX.ConcernID = @ConcernID and E.status = 2  and Year(Convert(date, EntryDate)) = Year(@StartDate)  and  EntryDate>= @InitailDate
group by E.Description
 insert into #temp_Data2 values(@StartDate, 'Direct Income', 0.00, 'Total Direct Income',@total, 'Header')

end

-- ----------------------------Income from ShareInvestment ----------------------------------------
SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
 WHERE PH.Name = 'Liability' and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Liabilites Received', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, 'Liabilites Received', 0, SIH.Name, sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
 WHERE PH.Name = 'Liability' and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
insert into #temp_Data2 values(@StartDate, 'Liabilites Received', 0.00, 'Total Liabilites Received',@total, 'Header')
 END


 SET @total = isnull((
 SELECT sum(Amount)
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
 WHERE PH.Name = 'Current Asset' and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 ), 0)
IF (@total != 0)
BEGIN
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Current Asset', 0.00, 'Header')

 INSERT INTO #temp_Data2
 SELECT @StartDate, '', 0, SIH.Name+'(Current Asset)', sum(Amount), 'Cash'
 FROM ShareInvestments SI
 INNER JOIN ShareInvestmentHeads SIH ON SI.SIHID = SIH.SIHID
INNER JOIN ShareInvestmentHeads PH  ON SIH.ParentId = PH.SIHID
 WHERE PH.Name = 'Current Asset' and SI.ConcernID=@ConcernID AND TransactionType = 1 AND Year(Convert(date, EntryDate)) = Year(@StartDate) and  EntryDate>= @InitailDate
 GROUP BY SIH.Name
 insert into #temp_Data2 values(@StartDate, 'Current Asset', 0.00, 'Total Current Asset',@total, 'Header')

 END
------------------------------------------------------------------------------------------

insert into #temp_Data3
select @StartDate, isnull(T1.id, 3), isnull(T1.Expense, ''), isnull(T1.ExpenseAmt, 0.00), isnull(T2.Income, ''), isnull(T2.IncomeAmt, 0.00), isnull(T2.Module, '')
from #temp_Data1 T1
full join #temp_Data2 T2 on T1.id = T2.id

declare @a decimal(18, 2)
declare @b decimal(18, 2)
declare @ExpenseWithinDate decimal(18, 2)
declare @IncomeWithinDate decimal(18, 2)
declare @CashInHandWithinDate decimal(18, 2)

set @a = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @b = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header'
), 0.00)
set @ExpenseWithinDate = isnull((
select sum(ExpenseAmt)
from #temp_Data1
where Expense not in ('Total Payable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)
set @IncomeWithinDate = isnull((
select sum(IncomeAmt)
from #temp_Data2
where Income not in ('Total Receivable', 'Opening Cash In Hand') and Module!='Header' and TransDate >= @FromDate and TransDate <= @ToDate
), 0.00)

set @CashInHandWithinDate = @IncomeWithinDate - @ExpenseWithinDate
set @CashInHand = @CashInHand + (@b - @a)

insert into #temp_Data3
values (@StartDate, 2, 'Total Payable', @a, 'Total Receivable', @b, 'Total')

insert into #temp_Data3
values (@StartDate, 2, 'Current Cash In Hand', @CashInHandWithinDate, '', 0, 'CashInHand')

insert into #temp_Data3
values (@StartDate, 2, 'Closing Cash In Hand', @CashInHand, 'Closing Cash In Hand', @CashInHand, 'CashInHand')

set @StartDate = DATEADD(YEAR, 1, @StartDate)
end

select Convert(datetime, TransDate) as TransDate, id, Expense, ExpenseAmt, Income, IncomeAmt,Module
from #temp_Data3
where Convert(date, TransDate) >= Convert(date, @FromDate) and Convert(date, TransDate) <= Convert(date, @ToDate)

------------------------------------------------------
-----------------Date: 23-01-2021---------------------
------------------------------------------------------
------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.Expenditures ADD
	Head nvarchar(MAX) NULL
GO
ALTER TABLE dbo.Expenditures SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SisterConcerns SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.ExpenseItems ADD
	ConcernID int NOT NULL CONSTRAINT DF_ExpenseItems_ConcernID DEFAULT 1
GO
ALTER TABLE dbo.ExpenseItems ADD CONSTRAINT
	FK_ExpenseItems_SisterConcerns FOREIGN KEY
	(
	ConcernID
	) REFERENCES dbo.SisterConcerns
	(
	ConcernID
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
ALTER TABLE dbo.ExpenseItems SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.ExpenseItems ADD
	CreatedBy int NOT NULL CONSTRAINT DF_ExpenseItems_CreatedBy DEFAULT 1019,
	CreateDate datetime NULL,
	ModifiedBy int NULL,
	ModifiedDate datetime NULL
GO
ALTER TABLE dbo.ExpenseItems SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

update ExpenseItems set CreateDate=GETDATE()
------------------------------------------------------
-----------------Date: 14-11-2020---------------------
------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.Products ADD
	MRP decimal(18, 2) NOT NULL CONSTRAINT DF_Products_MRP DEFAULT 0
GO
ALTER TABLE dbo.Products SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
------------------------------------------------------
-----------------Date: 05-08-2020---------------------
------------------------------------------------------
DROP type InsertRODetailTable
drop proc sp_AddReplacementOrder

CREATE TYPE [dbo].[InsertRODetailTable] AS TABLE(
	[SOrderDetailID] [int] NULL,
	[ProductId] [int] NULL,
	[StockDetailId] [int] NULL,
	[RStockDetailId] [int] NULL,
	[ColorId] [int] NULL,
	[Status] [int] NULL,
	[Quantity] [decimal](18, 2) NULL,
	[UnitPrice] [decimal](18, 2) NULL,
	[TAmount] [decimal](18, 2) NULL,
	[PPDisPer] [decimal](18, 2) NULL,
	[PPDisAmt] [decimal](18, 2) NULL,
	[MrpRate] [decimal](18, 2) NULL,
	[PPOffer] [decimal](18, 2) NULL,
	[RepOrderID] [int] NULL,
	[RepUnitPrice] [decimal](18, 2) NULL,
	[Remarks] [varchar](500) NULL,
	IsDamage int NULL
)
GO
------------------------------------------------------

alter PROC [dbo].[sp_AddReplacementOrder]
(
@SalesOrder [InsertReplaceOrderTable] readonly,
@SODetails [InsertRODetailTable] readonly
)
 
AS
DECLARE @SalesOrderId INT

BEGIN TRY  
 BEGIN TRANSACTION
 
INSERT INTO SOrders
(
InvoiceDate, InvoiceNo, CustomerID, VATPercentage, VATAmount, GrandTotal, TDPercentage, TDAmount, NetDiscount,TotalAmount,
PaymentDue, RecAmount, AdjAmount, TotalDue, Status, ConcernID, CreatedBy, CreateDate,TotalOffer,IsReplacement
)
(
Select InvoiceDate, InvoiceNo, CustomerID, VATPercentage, VATAmount, GrandTotal, TDiscountPercentage, TDiscountAmount,NetDiscount,
TotalAmount, PaymentDue, RecAmt, AdjAmount, TotalDue, Status, ConcernID, CreatedBy, CreateDate,TotalOffer,IsReplacement from @SalesOrder)

UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + s.TotalDue)
from @SalesOrder s
JOIN Customers ON Customers.CustomerID = s.CustomerID

SET @SalesOrderId = SCOPE_IDENTITY()

update SOrderDetails set RStockDetailId=s.RStockDetailId ,RepOrderID=@SalesOrderId,RepUnitPrice=s.UnitPrice,Remarks = s.Remarks
from @SODetails s
JOIN SOrderDetails SOD ON SOD.SDetailID = s.StockDetailId
join SOrders SO on SOD.SOrderID = SO.SOrderID
where SOD.SDetailId in (select StockDetailId from @SODetails) and SO.Status!=4 and SOD.IsProductReturn!=1

INSERT INTO SOrderDetails
(
ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, PPDAmount, MPRate, SOrderID, SDetailID,PPOffer,Remarks
)
(
Select ProductId, Quantity, UnitPrice, TAmount,  PPDisPer,
PPDisAmt, MrpRate, @SalesOrderId SOrderID, RStockDetailId,PPOffer,Remarks from @SODetails)

--**************************************************************
--***********Stock decrease for new product*********************
UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity - s.Quantity)
from @SODetails s
JOIN Stocks ON Stocks.ProductID = s.ProductId AND Stocks.ColorID= s.ColorId

UPDATE StockDetails
SET StockDetails.Status = 2
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.RStockDetailId



--**************************************************************
--*********************not damage*******************************
UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity + s.Quantity)
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
JOIN Stocks ON Stocks.StockID= StockDetails.StockID
where s.IsDamage=0

UPDATE StockDetails
SET StockDetails.Status = 1
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
where s.IsDamage=0

--**************************************************************
--*********************damage***********************************
UPDATE StockDetails
SET StockDetails.Status = 4
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
where s.IsDamage=1


UPDATE SRVProductDetails
SET SRVProductDetails.Status = 2
from @SODetails s
JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.RStockDetailId
where SRVProductDetails.Status=1

COMMIT

RETURN 1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

RETURN 0;
END CATCH


------------------------------------------------------
-----------------Date: 09-03-2020---------------------
------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.CreditSalesSchedules ADD
	BankTransID int NOT NULL CONSTRAINT DF_CreditSalesSchedules_BankTransID DEFAULT 0,
	CardPaidAmount decimal(18, 2) NOT NULL CONSTRAINT DF_CreditSalesSchedules_CardPaidAmount DEFAULT 0,
	CardTypeSetupID int NOT NULL CONSTRAINT DF_CreditSalesSchedules_CardTypeSetupID DEFAULT 0,
	DepositChargePercent decimal(18, 2) NOT NULL CONSTRAINT DF_CreditSalesSchedules_DepositChargePercent DEFAULT 0
GO
ALTER TABLE dbo.CreditSalesSchedules SET (LOCK_ESCALATION = TABLE)
GO
COMMIT



------------------------------------------------------
drop Proc InstallmentPayment
drop Proc AddCreditSalesOrder
drop Type InsertCSSchedulesTable

CREATE TYPE [dbo].[InsertCSSchedulesTable] AS TABLE(
	[MonthDate] [datetime] NULL,
	[Balance] [money] NULL,
	[InstallmentAmt] [money] NULL,
	[PaymentDate] [datetime] NULL,
	[PaymentStatus] [nvarchar](150) NULL,
	[InterestAmount] [money] NULL,
	[ClosingBalance] [money] NULL,
	[ScheduleNo] [int] NULL,
	[Remarks] [nvarchar](max) NULL,
	[IsUnExpected] [int] NULL,
	[HireValue] [decimal](18, 2) NULL,
	[NetValue] [decimal](18, 2) NULL,
	[ExpectedInstallment] [decimal](18, 2) NULL,
	[CardPaidAmount] [decimal](18, 2) NULL,
	[CardTypeSetupID] [int] NULL,
	[DepositChargePercent] [decimal](18, 2) NULL,
	BankTransID [int] NULL

)
GO

------------------------------------------------------

Create PROC [dbo].[InstallmentPayment]
(
	@SalesOrderId int,
	@InstallmentAmount decimal(18,2),
	@Schedules [InsertCSSchedulesTable] readonly,
	@LastPayAdjustment decimal(18,2),
    @BankTrans [InsertBankTransTable] readonly,
	@CardTypeSetupID int
)
  
AS 
BEGIN TRY
 BEGIN TRANSACTION 

 -----------------Card Payment Bank Deposit--------------
DECLARE @BankTransID INT

	SET @BankTransID = 0;
	--SET @CardTypeSetupID = ISNULL((
	--			SELECT CardTypeSetupID
	--			FROM @Schedules where CardTypeSetupID>0
	--			), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) 
			(
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

------------------Card Payment Bank Deposit--------------

UPDATE CreditSales SET Remaining = (Remaining - (@InstallmentAmount+@LastPayAdjustment)),LastPayAdjAmt=@LastPayAdjustment
Where CreditSalesID = @SalesOrderId

Declare @CustomerID int,@RemainingAmount decimal(18,2),@LastScheduleID int
set @CustomerID=(Select CustomerID from CreditSales where CreditSalesID=@SalesOrderId)


UPDATE Customers Set CreditDue = (CreditDue - (@InstallmentAmount+@LastPayAdjustment)) where CustomerID=@CustomerID


DELETE CreditSalesSchedules WHERE CreditSalesID = @SalesOrderId

INSERT INTO CreditSalesSchedules
(
MonthDate, Balance, InstallmentAmt, PaymentDate, 
CreditSalesID, PaymentStatus, InterestAmount, ClosingBalance,
ScheduleNo, Remarks, IsUnExpected,HireValue,NetValue,ExpectedInstallment,
CardPaidAmount,CardTypeSetupID,DepositChargePercent,BankTransID
)
(
Select MonthDate, Balance, InstallmentAmt, PaymentDate, 
@SalesOrderId CreditSalesID, PaymentStatus, InterestAmount, ClosingBalance, 
ScheduleNo, Remarks, IsUnExpected,HireValue,NetValue,ExpectedInstallment,
CardPaidAmount,CardTypeSetupID,DepositChargePercent,BankTransID
from @Schedules
)

set @LastScheduleID=ISNULL((select TOP 1 CSScheduleID from CreditSalesSchedules where CreditSalesID=@SalesOrderId and InstallmentAmt>0 and PaymentStatus='Paid' order by ScheduleNo desc),0)
update CreditSalesSchedules set LastPayAdjust=@LastPayAdjustment,BankTransID=@BankTransID where CSScheduleID=@LastScheduleID


UPDATE CreditSales SET LastPayAdjAmt=LastPayAdjAmt+Remaining WHERE (Remaining<1 AND Remaining>-1) AND Remaining!=0
UPDATE CreditSales SET Remaining=0 WHERE (Remaining<1 AND Remaining>-1) AND Remaining!=0

set @RemainingAmount = (Select Remaining from CreditSales where CreditSalesID=@SalesOrderId)

IF (@RemainingAmount=0)
BEGIN
 Update CreditSalesSchedules set PaymentStatus='Paid',InstallmentAmt=0,PaymentDate=GETDATE() where CreditSalesID=@SalesOrderId and PaymentStatus='Due'
END

COMMIT

RETURN 1

END TRY

BEGIN CATCH
  IF(@@TRANCOUNT>0)
    ROLLBACK
	RETURN 0
END CATCH
------------------------------------------------------
-----------------Date: 07-03-2020---------------------
------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.CreditSales ADD
	BankTransID int NOT NULL CONSTRAINT DF_CreditSales_BankTransID DEFAULT ((0)),
	CardPaidAmount decimal(18, 2) NOT NULL CONSTRAINT DF_CreditSales_CardPaidAmount DEFAULT ((0)),
	CardTypeSetupID int NOT NULL CONSTRAINT DF_CreditSales_CardTypeSetupID DEFAULT ((0)),
	DepositChargePercent decimal(18, 2) NOT NULL CONSTRAINT DF_CreditSales_DepositChargePercent DEFAULT ((0))
GO
ALTER TABLE dbo.CreditSales SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SOrders ADD
	BankTransID int NOT NULL CONSTRAINT DF_SOrders_BankTransID DEFAULT 0,
	CardPaidAmount decimal(18, 2) NOT NULL CONSTRAINT DF_SOrders_CardPaidAmount DEFAULT 0,
	CardTypeSetupID int NOT NULL CONSTRAINT DF_SOrders_CardTypeSetupID DEFAULT 0,
	DepositChargePercent decimal(18, 2) NOT NULL CONSTRAINT DF_SOrders_DepositChargePercent DEFAULT 0
GO
ALTER TABLE dbo.SOrders SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
------------------------------------------------------
CREATE TABLE [dbo].[CardTypes](
	[CardTypeID] [int] IDENTITY(1,1) NOT NULL,
	[Code] [varchar](50) NOT NULL,
	[Description] [varchar](550) NOT NULL,
	[Status] [int] NOT NULL,
	[Sequence] [int] NOT NULL,
	[ConcernID] [int] NOT NULL,
 CONSTRAINT [PK_CardTypes] PRIMARY KEY CLUSTERED 
(
	[CardTypeID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[CardTypes]  WITH CHECK ADD  CONSTRAINT [FK_CardTypes_SisterConcerns] FOREIGN KEY([ConcernID])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[CardTypes] CHECK CONSTRAINT [FK_CardTypes_SisterConcerns]
GO

------------------------------------------------------
CREATE TABLE [dbo].[CardTypeSetups](
	[CardTypeSetupID] [int] IDENTITY(1,1) NOT NULL,
	[Code] [varchar](50) NOT NULL,
	[BankID] [int] NOT NULL,
	[CardTypeID] [int] NOT NULL,
	[Percentage] [decimal](18, 2) NOT NULL,
	[ConcernID] [int] NOT NULL,
 CONSTRAINT [PK_CardTypeSetups] PRIMARY KEY CLUSTERED 
(
	[CardTypeSetupID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[CardTypeSetups] ADD  CONSTRAINT [DF_CardTypeSetups_Percentage]  DEFAULT ((0)) FOR [Percentage]
GO

ALTER TABLE [dbo].[CardTypeSetups]  WITH CHECK ADD  CONSTRAINT [FK_CardTypeSetups_Banks] FOREIGN KEY([BankID])
REFERENCES [dbo].[Banks] ([BankID])
GO

ALTER TABLE [dbo].[CardTypeSetups] CHECK CONSTRAINT [FK_CardTypeSetups_Banks]
GO

ALTER TABLE [dbo].[CardTypeSetups]  WITH CHECK ADD  CONSTRAINT [FK_CardTypeSetups_CardTypes] FOREIGN KEY([CardTypeID])
REFERENCES [dbo].[CardTypes] ([CardTypeID])
GO

ALTER TABLE [dbo].[CardTypeSetups] CHECK CONSTRAINT [FK_CardTypeSetups_CardTypes]
GO

ALTER TABLE [dbo].[CardTypeSetups]  WITH CHECK ADD  CONSTRAINT [FK_CardTypeSetups_SisterConcerns] FOREIGN KEY([ConcernID])
REFERENCES [dbo].[SisterConcerns] ([ConcernID])
GO

ALTER TABLE [dbo].[CardTypeSetups] CHECK CONSTRAINT [FK_CardTypeSetups_SisterConcerns]
GO


------------------------------------------------------
CREATE TYPE [dbo].[InsertBankTransTable] AS TABLE(
	[TranDate] [datetime] NULL,
	[TransactionNo] [varchar](150) NULL,
	[TransactionType] [int] NULL,
	[Amount] [decimal](18, 2) NULL,
	[BankID] [int] NULL,
	[CustomerID] [int] NULL,
	[SupplierID] [int] NULL,
	[AnotherBankID] [int] NULL,
	[ChecqueNo] [varchar](150) NULL,
	[Remarks] [varchar](500) NULL,
	[ConcernID] [int] NULL
)
GO

------------------------------------------------------
drop Proc AddSalesOrder
drop Proc UpdateSalesOrder
drop type InsertSalesOrderTable

CREATE TYPE [dbo].[InsertSalesOrderTable] AS TABLE(
	[InvoiceDate] [datetime] NULL,
	[InvoiceNo] [varchar](150) NULL,
	[VatPercentage] [decimal](18, 2) NULL,
	[VatAmount] [decimal](18, 2) NULL,
	[GrandTotal] [decimal](18, 2) NULL,
	[TDiscountPercentage] [decimal](18, 2) NULL,
	[TDiscountAmount] [decimal](18, 2) NULL,
	[RecAmt] [decimal](18, 2) NULL,
	[PaymentDue] [decimal](18, 2) NULL,
	[TotalAmount] [decimal](18, 2) NULL,
	[TotalDue] [decimal](18, 2) NULL,
	[AdjAmount] [decimal](18, 2) NULL,
	[Status] [int] NULL,
	[CustomerId] [int] NULL,
	[ConcernId] [int] NULL,
	[CreatedBy] [int] NULL,
	[CreateDate] [datetime] NULL,
	[TotalOffer] [decimal](18, 2) NULL,
	[NetDiscount] [decimal](18, 2) NULL,
	[Remarks] [varchar](150) NULL,
    [CardPaidAmount] [decimal](18, 2) NULL,
	[CardTypeSetupID] [int] NULL,
	[DepositChargePercent] [decimal](18, 2) NULL
)
GO

------------------------------------------------------

Create PROC [dbo].[UpdateSalesOrder]
(
	@UserId int,
	@SalesOrderId int,
	@SalesOrder [InsertSalesOrderTable] readonly,
	@SODetails [InsertSODetailTable] readonly,
	@BankTrans [InsertBankTransTable] readonly
)
  
AS 
 
 BEGIN TRY  
 BEGIN TRANSACTION 
 --status New=3,Updated=4,Deleted=5
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int
Declare @BankID int

set @BankTransID = ISNULL((Select BankTransID from SOrders where SOrderID=@SalesOrderId),0)

IF(@BankTransID>0)
BEGIN 
set @BankID = ISNULL((Select BankID from BankTransactions where BankTranID=@BankTransID),0)

  update Banks set TotalAmount=TotalAmount-bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

  delete BankTransactions where BankTranID=@BankTransID
END

 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
-------------------------------------------------
-----------Card Payment Bank Deposit--------------
-------------------------------------------------

UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue - s.PaymentDue)
From SOrders s
JOIN Customers ON Customers.CustomerID = s.CustomerID
Where s.SOrderID = @SalesOrderId

UPDATE Customers Set Customers.TotalDue = (Customers.TotalDue + s.PaymentDue)
from @SalesOrder s
JOIN Customers ON Customers.CustomerID = s.CustomerID

Update SOrders SET
InvoiceDate = s.InvoiceDate, InvoiceNo = s.InvoiceNo, CustomerID = s.CustomerID, VATPercentage = s.VATPercentage,
VATAmount = s.VATAmount, GrandTotal = s.GrandTotal, TDPercentage = s.TDiscountPercentage, TDAmount = s.TDiscountAmount,NetDiscount=s.NetDiscount,
TotalAmount = s.TotalAmount, PaymentDue = s.PaymentDue, RecAmount = s.RecAmt, AdjAmount = s.AdjAmount, TotalDue = s.TotalDue, Status = s.Status,
ConcernID = s.ConcernID, ModifiedBy = s.CreatedBy, ModifiedDate = s.CreateDate,Remarks=s.Remarks,
CardTypeSetupID=s.CardTypeSetupID,CardPaidAmount=s.CardPaidAmount,DepositChargePercent=s.DepositChargePercent
FROM @SalesOrder s
Where SOrderID = @SalesOrderId

Update SOrderDetails
SET SOrderDetails.ProductID = SD.ProductId, SOrderDetails.Quantity = SD.Quantity, SOrderDetails.UnitPrice = SD.UnitPrice, 
SOrderDetails.UTAmount = SD.TAmount, SOrderDetails.PPDPercentage = SD.PPDisPer, SOrderDetails.PPDAmount = SD.PPDisAmt,
SOrderDetails.MPRate = SD.MrpRate, SOrderDetails.SOrderID = @SalesOrderId, SOrderDetails.SDetailID = SD.StockDetailId,
SOrderDetails.Compressor=p.CompressorWarrentyMonth,SOrderDetails.Motor=p.MotorWarrentyMonth,SOrderDetails.Panel=p.PanelWarrentyMonth,SOrderDetails.Spareparts=p.SparePartsWarrentyMonth,SOrderDetails.Service = p.ServiceWarrentyMonth
FROM @SODetails SD
join Products p on SD.ProductId = p.ProductID
WHERE SD.Status = 4

INSERT INTO SOrderDetails
(
ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, PPDAmount, MPRate, SOrderID, SDetailID,Compressor,Motor,Panel,Spareparts,Service
)
(
Select sd.ProductId, Quantity, UnitPrice, TAmount,  PPDisPer,
PPDisAmt, MrpRate, @SalesOrderId SOrderID, StockDetailId,p.CompressorWarrentyMonth,p.PanelWarrentyMonth,p.MotorWarrentyMonth,p.SparePartsWarrentyMonth,p.ServiceWarrentyMonth  from @SODetails sd
join Products p on sd.ProductID = p.ProductID
 WHERE Status = 3
)

DELETE FROM SOrderDetails WHERE SOrderDetailID IN (SELECT SOrderDetailID FROM @SODetails WHERE Status = 5)

UPDATE Stocks
SET Stocks.Quantity = (Stocks.Quantity - s.Quantity)
from @SODetails s
JOIN Stocks ON Stocks.ProductID = s.ProductId AND Stocks.ColorID = s.ColorId
WHERE s.Status = 3 OR s.Status = 4

UPDATE StockDetails SET StockDetails.Status = 2
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
WHERE s.Status = 3 OR s.Status = 4

UPDATE Stocks SET Stocks.Quantity = (Stocks.Quantity + s.Quantity), ModifiedBy = @UserId, ModifiedDate = GETDATE()
from @SODetails s
JOIN Stocks ON Stocks.ProductID = s.ProductId AND Stocks.ColorID = s.ColorId
WHERE s.Status = 5

UPDATE StockDetails
SET StockDetails.Status = 1
from @SODetails s
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId
WHERE s.Status = 5

--For barCode Product SRVisit Status update
UPDATE SRVProductDetails
SET SRVProductDetails.Status = 2
from @SODetails s
JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
join Products on SRVProductDetails.ProductID = Products.ProductID
where Products.ProductType=1 or Products.ProductType=3 and s.Status = 3 OR s.Status = 4


UPDATE SRVProductDetails
SET SRVProductDetails.Status = 3
from @SODetails s
JOIN SRVProductDetails ON SRVProductDetails.SDetailID = s.StockDetailId
join Products on SRVProductDetails.ProductID = Products.ProductID
where Products.ProductType=1 or Products.ProductType=3 and s.Status = 5


COMMIT

RETURN 1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		RETURN 0;
END CATCH

------------------------------------------------------

Create PROC [dbo].[AddSalesOrder] (@SalesOrder [INSERTSALESORDERTABLE] readonly,
     @SODetails [INSERTSODETAILTABLE] readonly, 
     @RemindDate DATE,
	 @BankTrans [InsertBankTransTable] readonly)
AS
DECLARE @SalesOrderId INT
DECLARE @CardTypeSetupID int
DECLARE @BankTransID int

BEGIN TRY
	BEGIN TRANSACTION
--------------------------------------------------
-----------Card Payment Bank Deposit--------------
--------------------------------------------------
 set @BankTransID =0;
 set @CardTypeSetupID = ISNULL((select CardTypeSetupID from @SalesOrder),0)
 IF(@CardTypeSetupID>0)
 BEGIN
  Insert into BankTransactions
  (
    Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType
  )
  (
    select Amount,AnotherBankID,BankID,ChecqueNo,ConcernID,CustomerID,Remarks,SupplierID,TranDate,TransactionNo,TransactionType from @BankTrans
  )
  set @BankTransID = SCOPE_IDENTITY();
  update Banks set TotalAmount=TotalAmount+bt.Amount
  from BankTransactions bt 
  join Banks b on bt.BankID = b.BankID
  where bt.BankTranID=@BankTransID

 END
--------------------------------------------------
-----------Card Payment Bank Deposit--------------
--------------------------------------------------

	INSERT INTO sorders (invoicedate, invoiceno, customerid, vatpercentage, vatamount, grandtotal,
	tdpercentage, tdamount, netdiscount, totalamount, paymentdue, recamount, adjamount, totaldue, 
	STATUS, concernid, createdby, createdate, totaloffer,Remarks,CardTypeSetupID,CardPaidAmount,DepositChargePercent,BankTransID) 
	(SELECT invoicedate, invoiceno, customerid, vatpercentage, vatamount, grandtotal,
	tdiscountpercentage, tdiscountamount, netdiscount, totalamount, paymentdue, recamt, adjamount, totaldue, STATUS,
	concernid, createdby, createdate, totaloffer,Remarks,CardTypeSetupID,CardPaidAmount,DepositChargePercent,@BankTransID FROM @SalesOrder)
    
	SET @SalesOrderId = Scope_identity()

	INSERT INTO SOrderDetails 
	(ProductID, Quantity, UnitPrice, UTAmount, PPDPercentage, 
	PPDAmount, MPRate, SOrderID, SDetailId, PPOffer, 
	SRate, PRate,Compressor, Motor, Panel,
    Spareparts, Service) 
	(SELECT
	 SOD.ProductId, SOD.Quantity, SOD.UnitPrice, SOD.TAmount, SOD.PPDisPer,
	 SOD.PPDisAmt, SOD.MrpRate, @SalesOrderId SOrderID, SOD.StockDetailId, SOD.PPOffer,
	 (SOD.UnitPrice - SOD.PPDisAmt), STD.PRate,p.CompressorWarrentyMonth, p.PanelWarrentyMonth,
	 p.MotorWarrentyMonth, p.SparePartsWarrentyMonth, p.ServiceWarrentyMonth FROM @SODetails SOD 
	JOIN StockDetails STD ON STD.SDetailID = SOD.StockDetailId 
	JOIN Products p ON STD.ProductID = p.ProductID
	where P.ProductType=1 or p.ProductType=3
	)

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue), reminddate = @RemindDate
	FROM @SalesOrder s
	JOIN customers ON customers.customerid = s.customerid
	WHERE @RemindDate IS NOT NULL

	UPDATE customers
	SET customers.totaldue = (customers.totaldue + s.totaldue)
	FROM @SalesOrder s
	JOIN customers ON customers.customerid = s.customerid
	WHERE @RemindDate IS NULL



	UPDATE stocks
	SET stocks.quantity = (stocks.quantity - s.quantity)
	FROM @SODetails s
	JOIN stocks ON stocks.productid = s.productid AND stocks.colorid = s.colorid AND Stocks.GodownID=s.Compressor

	--For barCode Product 
	UPDATE stockdetails
	SET stockdetails.STATUS = 2
	FROM @SODetails s
	JOIN stockdetails ON stockdetails.sdetailid = s.stockdetailid
	JOIN products ON stockdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

--*****************FIFO for Nobarcode************************** 
	DECLARE @ProductID INT
	DECLARE @StockID INT
	DECLARE @SDetailID INT
	DECLARE @ColorID INT
	DECLARE @SalesRate INT
	DECLARE @PRate INT
	DECLARE @POrderDetailID INT
	DECLARE @SOrderDetailID INT
	DECLARE @Quantity INT
	DECLARE @SQty INT
	DECLARE @UnitPrice INT
	DECLARE @MRPRate INT

	DECLARE cur CURSOR LOCAL
	FOR
	SELECT s.productid, colorid, quantity, sorderdetailid
	FROM @SODetails s
	JOIN products ON products.productid = s.productid
	WHERE products.producttype = 2

	OPEN cur

	FETCH NEXT
	FROM cur
	INTO @ProductID, @ColorID, @Quantity, @SOrderDetailID

	WHILE @@FETCH_STATUS = 0
	BEGIN
		WHILE @Quantity != 0
		BEGIN
			SET @SDetailID = (
					SELECT Min(sdetailid)
					FROM stockdetails
					WHERE productid = @ProductID AND colorid = @ColorID AND quantity != 0 AND STATUS = 1
					)
			SET @SQty = (
					SELECT quantity
					FROM stockdetails
					WHERE sdetailid = @SDetailID
					)

			IF (@SQty > @Quantity)
			BEGIN
				SET @SQty = @SQty - @Quantity

				UPDATE stockdetails
				SET quantity = @SQty
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (productid, quantity, unitprice, utamount, ppdpercentage, ppdamount, mprate, sorderid, sdetailid, ppoffer, srate, prate, compressor, motor, panel, spareparts, service) (SELECT SOD.productid, @Quantity, SOD.unitprice, SOD.tamount, SOD.ppdisper, SOD.ppdisamt, SOD.mrprate, @SalesOrderId SOrderID, @SDetailID, SOD.ppoffer, (SOD.unitprice - SOD.ppdisamt), STD.prate, p.compressorwarrentymonth, p.panelwarrentymonth, p.motorwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @SODetails SOD JOIN stockdetails STD ON STD.sdetailid = SOD.stockdetailid JOIN products p ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID)

				SET @Quantity = 0
			END
			ELSE IF (@SQty < @Quantity)
			BEGIN
				SET @Quantity = @Quantity - @SQty

				UPDATE stockdetails
				SET quantity = 0, STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (productid, quantity, unitprice, utamount, ppdpercentage, ppdamount, mprate, sorderid, sdetailid, ppoffer, srate, prate, compressor, motor, panel, spareparts, service) (SELECT SOD.productid, @SQty, SOD.unitprice, SOD.tamount, SOD.ppdisper, SOD.ppdisamt, SOD.mrprate, @SalesOrderId SOrderID, @SDetailID, SOD.ppoffer, (SOD.unitprice - SOD.ppdisamt), STD.prate, p.compressorwarrentymonth, p.panelwarrentymonth, p.motorwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @SODetails SOD JOIN stockdetails STD ON STD.sdetailid = SOD.stockdetailid JOIN products p ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID)
			END
			ELSE
			BEGIN
				UPDATE stockdetails
				SET quantity = 0, STATUS = 2
				WHERE sdetailid = @SDetailID

				INSERT INTO sorderdetails (productid, quantity, unitprice, utamount, ppdpercentage, ppdamount, mprate, sorderid, sdetailid, ppoffer, srate, prate, compressor, motor, panel, spareparts, service) (SELECT SOD.productid, @Quantity, SOD.unitprice, SOD.tamount, SOD.ppdisper, SOD.ppdisamt, SOD.mrprate, @SalesOrderId SOrderID, @SDetailID, SOD.ppoffer, (SOD.unitprice - SOD.ppdisamt), STD.prate, p.compressorwarrentymonth, p.panelwarrentymonth, p.motorwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @SODetails SOD JOIN stockdetails STD ON STD.sdetailid = SOD.stockdetailid JOIN products p ON STD.productid = p.productid WHERE SOD.productid = @ProductID AND SOD.colorid = @ColorID)

				SET @Quantity = 0
			END
		END

		FETCH NEXT
		FROM cur
		INTO @ProductID, @ColorID, @Quantity, @SOrderDetailID
	END

	--For barCode Product SRVisit Status update 
	UPDATE srvproductdetails
	SET srvproductdetails.STATUS = 2
	FROM @SODetails s
	JOIN srvproductdetails ON srvproductdetails.sdetailid = s.stockdetailid AND srvproductdetails.STATUS = 1
	JOIN products ON srvproductdetails.productid = products.productid
	WHERE products.producttype = 1 OR products.producttype = 3

	COMMIT

	RETURN 1;
END TRY

BEGIN CATCH
	IF @@TRANCOUNT > 0
		ROLLBACK

	RETURN 0;
END CATCH

------------------------------------------------------
drop proc AddCreditSalesOrder
drop type InsertCreditSalesOrderTable


CREATE TYPE [dbo].[InsertCreditSalesOrderTable] AS TABLE(
	[InvoiceNo] [varchar](150) NULL,
	[CustomerID] [int] NULL,
	[TSalesAmt] [money] NULL,
	[NoOfInstallment] [int] NULL,
	[InstallmentPrinciple] [money] NULL,
	[IssueDate] [datetime] NULL,
	[UserName] [varchar](250) NULL,
	[Remaining] [money] NULL,
	[InterestRate] [decimal](6, 2) NULL,
	[InterestAmount] [decimal](18, 2) NULL,
	[SalesDate] [datetime] NULL,
	[DownPayment] [money] NULL,
	[WInterestAmt] [money] NULL,
	[FixedAmount] [money] NULL,
	[IsStatus] [int] NULL,
	[UnExInstallment] [int] NULL,
	[Quantity] [int] NULL,
	[Discount] [money] NULL,
	[NetAmount] [money] NULL,
	[IsUnExpected] [bit] NULL,
	[Remarks] [varchar](max) NULL,
	[Status] [bit] NULL,
	[VatPercentage] [decimal](18, 2) NULL,
	[VatAmount] [decimal](18, 2) NULL,
	[TotalDue] [money] NULL,
	[ConcernId] [int] NULL,
	[CreatedBy] [int] NULL,
	[CreateDate] [datetime] NULL,
	[TotalOffer] [decimal](18, 2) NULL,
	[InstallmentPeriod] [varchar](max) NULL,
	[CardPaidAmount] [decimal](18, 2) NULL,
	[CardTypeSetupID] [int] NULL,
	[DepositChargePercent] [decimal](18, 2) NULL
)
GO
------------------------------------------------------
Create PROCEDURE [dbo].[AddCreditSalesOrder] (
@CSalesOrder [dbo].[INSERTCREDITSALESORDERTABLE] readonly, 
@CSODetails [INSERTCSODETAILTABLE] readonly,
@CSSchedules [INSERTCSSCHEDULESTABLE] readonly,
@BankTrans [InsertBankTransTable] readonly)
AS
DECLARE @CreditSalesId INT
DECLARE @CardTypeSetupID INT
DECLARE @BankTransID INT

BEGIN TRY  
 BEGIN TRANSACTION 

-----------------Card Payment Bank Deposit--------------
	SET @BankTransID = 0;
	SET @CardTypeSetupID = ISNULL((
				SELECT CardTypeSetupID
				FROM @CSalesOrder
				), 0)

	IF (@CardTypeSetupID > 0)
	BEGIN
		INSERT INTO BankTransactions (
			Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType
			) (
			SELECT Amount,
			AnotherBankID,
			BankID,
			ChecqueNo,
			ConcernID,
			CustomerID,
			Remarks,
			SupplierID,
			TranDate,
			TransactionNo,
			TransactionType FROM @BankTrans
			)

		SET @BankTransID = SCOPE_IDENTITY();

		UPDATE Banks
		SET TotalAmount = TotalAmount + bt.Amount
		FROM BankTransactions bt
		INNER JOIN Banks b
			ON bt.BankID = b.BankID
		WHERE bt.BankTranID = @BankTransID
	END

------------------Card Payment Bank Deposit--------------

INSERT INTO creditsales (invoiceno, customerid, tsalesamt, noofinstallment,
 intallmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamt, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,BankTransID)
(SELECT
 invoiceno, customerid, tsalesamt, noofinstallment, 
 installmentprinciple, issuedate, username, remaining,
 interestrate, interestamount, salesdate, downpayment,
 winterestamt, fixedamount, isstatus, unexinstallment, quantity, discount, netamount, isunexpected, 
 remarks, vatpercentage, vatamount, STATUS, concernid, createdby, createdate, totaloffer, installmentperiod,
 CardTypeSetupID,CardPaidAmount,DepositChargePercent,@BankTransID FROM @CSalesOrder)

UPDATE customers
SET customers.CreditDue = (customers.CreditDue + s.totaldue)
FROM @CSalesOrder s
INNER JOIN customers ON customers.customerid = s.customerid

SET @CreditSalesId = Scope_identity()

INSERT INTO CreditSaleDetails 
( 
ProductID ,UnitPrice, Quantity, UTAmount, CreditSalesID,  
MPRateTotal, MPRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,Compressor,Motor,
Panel,Spareparts,Service
) 
( 
Select sd.ProductID ,UnitPrice, Quantity, UTAmount, @CreditSalesId CreditSalesID,  
MPRateTotal, MrpRate, StockDetailID,PPOffer,IntPercentage,IntTotalAmt,p.CompressorWarrentyMonth,p.MotorWarrentyMonth,
p.PanelWarrentyMonth,p.SparePartsWarrentyMonth,p.ServiceWarrentyMonth from @CSODetails sd
join Products p on sd.ProductID=p.ProductID 
where p.ProductType!=2
) 

UPDATE stocks
SET stocks.quantity = (stocks.quantity - s.quantity)
FROM @CSODetails s
INNER JOIN stocks ON stocks.productid = s.productid AND stocks.colorid = s.colorid AND Stocks.GodownID=s.Compressor

UPDATE StockDetails 
SET StockDetails.Status = 2 
from @CSODetails s 
JOIN StockDetails ON StockDetails.SDetailID = s.StockDetailId 
join Products on StockDetails.ProductID = Products.ProductID 
where Products.ProductType!=2 

--***************FIFO for Nobarcode Product**********************
DECLARE @ProductID INT
DECLARE @StockID INT
DECLARE @SDetailID INT
DECLARE @ColorID INT
DECLARE @SalesRate INT
DECLARE @PRate INT
DECLARE @POrderDetailID INT
DECLARE @CreditSaleProductsID INT
DECLARE @Quantity INT
DECLARE @SQty INT
DECLARE @UnitPrice INT
DECLARE @MRPRate INT

DECLARE cur CURSOR LOCAL
FOR
SELECT s.productid, s.colorid, s.quantity, creditsalesdetailsid
-- from   InsertCSODetailTable SOD join CreditSales SO on SO.CreditSalesID=SOD.CreditSalesID where SO.Status=1
FROM @CSODetails s
INNER JOIN stockdetails ON stockdetails.sdetailid = s.stockdetailid
INNER JOIN products ON stockdetails.productid = products.productid
where Products.ProductType=2 
OPEN cur

FETCH NEXT
FROM cur
INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID

WHILE @@FETCH_STATUS = 0
BEGIN
	WHILE @Quantity != 0
	BEGIN
		SET @SDetailID = (
				SELECT Min(sdetailid)
				FROM stockdetails
				WHERE productid = @ProductID AND colorid = @ColorID AND quantity != 0 AND STATUS = 1
				)
		SET @SQty = (
				SELECT quantity
				FROM stockdetails
				WHERE sdetailid = @SDetailID
				)

		IF (@SQty > @Quantity)
		BEGIN
			SET @SQty = @SQty - @Quantity

			UPDATE stockdetails
			SET quantity = @SQty
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service)
			 (SELECT sd.productid, unitprice, @Quantity, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID  =@CreditSaleProductsID
			SET @Quantity = 0
		END
		ELSE IF (@SQty < @Quantity)
		BEGIN
			SET @Quantity = @Quantity - @SQty

			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate, stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service) (SELECT sd.productid, unitprice, @SQty, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate, @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID)
				--update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
		END
		ELSE
		BEGIN
			UPDATE stockdetails
			SET quantity = 0, STATUS = 2
			WHERE sdetailid = @SDetailID

			INSERT INTO creditsaledetails (
			productid, unitprice, quantity, utamount, creditsalesid, mpratetotal, mprate,
			 stockdetailid, ppoffer, intpercentage, inttotalamt, compressor, motor, panel, spareparts, service
			 ) 
			 (SELECT 
			  sd.productid, unitprice, @SQty, utamount, @CreditSalesId CreditSalesID, mpratetotal, mrprate,
			  @SDetailID, ppoffer, intpercentage, inttotalamt, p.compressorwarrentymonth, p.motorwarrentymonth, 
			  p.panelwarrentymonth, p.sparepartswarrentymonth, p.servicewarrentymonth FROM @CSODetails sd 
			  INNER JOIN products p ON sd.productid = p.productid WHERE sd.productid = @ProductID AND sd.colorid = @ColorID
			  )

			-- update CreditSaleDetails set StockDetailID=@SDetailID where CreditSaleDetailsID=@CreditSaleProductsID
			SET @Quantity = 0
		END
	END

	FETCH NEXT
	FROM cur
	INTO @ProductID, @ColorID, @Quantity, @CreditSaleProductsID
END

INSERT INTO creditsalesschedules (monthdate, balance, installmentamt, 
paymentdate, creditsalesid, paymentstatus, interestamount, closingbalance,
 scheduleno, remarks, isunexpected, hirevalue, netvalue)
(SELECT monthdate, balance, installmentamt,
 paymentdate, @CreditSalesId CreditSalesID, paymentstatus, interestamount, closingbalance,
  scheduleno, remarks, isunexpected, hirevalue, netvalue FROM @CSSchedules)

COMMIT
RETURN 1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		RETURN 0;
END CATCH
------------------------------------------------------
-----------------Date: 29-02-2020---------------------
------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.CreditSalesSchedules ADD
	LastPayAdjust decimal(18, 2) NOT NULL CONSTRAINT DF_CreditSalesSchedules_LastPayAdjust DEFAULT 0
GO
ALTER TABLE dbo.CreditSalesSchedules SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
------------------------------------------------------

declare @CustomerID int
declare @LastScheduleID int
declare @CreditSalesID int
declare @CustomerName varchar(200)
declare @TotalDue decimal(18,2)
declare @TotalPaymentDue decimal(18,2)
declare @TotalCashCollection decimal(18,2)
declare @OpeningDue decimal(18,2)
declare @CreditDue decimal(18,2)
declare @ProdutReturnAmount decimal(18,2)
declare @LastPayAdjustment decimal(18,2)

declare emp_cur Cursor local for select cs.CreditSalesID,cs.LastPayAdjAmt from CreditSales cs
where cs.LastPayAdjAmt>0
open emp_cur
fetch next from emp_cur into  @CreditSalesID ,@LastPayAdjustment
while @@FETCH_STATUS=0
BEGIN

set @LastScheduleID=ISNULL((select TOP 1 CSScheduleID from CreditSalesSchedules where CreditSalesID=@CreditSalesID and InstallmentAmt>0 and PaymentStatus='Paid' order by ScheduleNo desc),0)
update CreditSalesSchedules set LastPayAdjust=@LastPayAdjustment where CSScheduleID=@LastScheduleID

fetch next from emp_cur into  @CreditSalesID,@LastPayAdjustment
END
CLOSE emp_cur;
DEALLOCATE emp_cur;


------------------------------------------------------
ALTER PROC [dbo].[InstallmentPayment]
(
	@SalesOrderId int,
	@InstallmentAmount decimal(18,2),
	@Schedules [InsertCSSchedulesTable] readonly,
	@LastPayAdjustment decimal(18,2)
)
  
AS 
BEGIN TRY
 BEGIN TRANSACTION 
UPDATE CreditSales SET Remaining = (Remaining - (@InstallmentAmount+@LastPayAdjustment)),LastPayAdjAmt=@LastPayAdjustment
Where CreditSalesID = @SalesOrderId

Declare @CustomerID int,@RemainingAmount decimal(18,2),@LastScheduleID int
set @CustomerID=(Select CustomerID from CreditSales where CreditSalesID=@SalesOrderId)


UPDATE Customers Set CreditDue = (CreditDue - (@InstallmentAmount+@LastPayAdjustment)) where CustomerID=@CustomerID


DELETE CreditSalesSchedules WHERE CreditSalesID = @SalesOrderId

INSERT INTO CreditSalesSchedules
(
MonthDate, Balance, InstallmentAmt, PaymentDate, 
CreditSalesID, PaymentStatus, InterestAmount, ClosingBalance, ScheduleNo, Remarks, IsUnExpected,HireValue,NetValue,ExpectedInstallment
)
(
Select MonthDate, Balance, InstallmentAmt, PaymentDate, 
@SalesOrderId CreditSalesID, PaymentStatus, InterestAmount, ClosingBalance, 
ScheduleNo, Remarks, IsUnExpected,HireValue,NetValue,ExpectedInstallment from @Schedules
)

IF(@LastPayAdjustment>0)
BEGIN
set @LastScheduleID=ISNULL((select TOP 1 CSScheduleID from CreditSalesSchedules where CreditSalesID=@SalesOrderId and InstallmentAmt>0 and PaymentStatus='Paid' order by ScheduleNo desc),0)
update CreditSalesSchedules set LastPayAdjust=@LastPayAdjustment where CSScheduleID=@LastScheduleID
END

UPDATE CreditSales SET LastPayAdjAmt=LastPayAdjAmt+Remaining WHERE (Remaining<1 AND Remaining>-1) AND Remaining!=0
UPDATE CreditSales SET Remaining=0 WHERE (Remaining<1 AND Remaining>-1) AND Remaining!=0

set @RemainingAmount = (Select Remaining from CreditSales where CreditSalesID=@SalesOrderId)

IF (@RemainingAmount=0)
BEGIN
 Update CreditSalesSchedules set PaymentStatus='Paid',InstallmentAmt=0,PaymentDate=GETDATE() where CreditSalesID=@SalesOrderId and PaymentStatus='Due'
END

COMMIT

RETURN 1

END TRY

BEGIN CATCH
  IF(@@TRANCOUNT>0)
    ROLLBACK
	RETURN 0
END CATCH







------------------------------------------------------
-----------------Date: 27-02-2020---------------------
------------------------------------------------------

ALTER PROC [dbo].[sp_AddReturnPurchaseOrder]
(
	@PurchaseOrder [InsertPurchaseOrderTable] readonly,
	@PODetails [InsertPODetailTable] readonly,
	@POProductDetails [InsertReturnPOProductDetailTable] readonly,
	@OutPOrderID int out,
	@Result int out
)
  
AS 
DECLARE @PurchaseOrderId int

BEGIN TRY  
 BEGIN TRANSACTION 
  
INSERT INTO POrders
(
OrderDate, ChallanNo, SupplierID, GrandTotal, TDiscount, TotalAmt, AdjAmount, RecAmt, PaymentDue, TotalDue,
Status, PPDisAmt, NetDiscount, LaborCost, ConcernID, CreateDate, CreatedBy,IsDamageOrder
)
(
Select OrderDate, ChallanNo, SupplierID, GrandTotal, TDiscount, TotalAmt, AdjAmount, RecAmt, PaymentDue, TotalDue,
Status, PPTDisAmt, NetDiscount, LabourCost, ConcernID, CreateDate, CreatedBy,IsDamageOrder from @PurchaseOrder)

UPDATE Suppliers Set Suppliers.TotalDue = (Suppliers.TotalDue - p.PaymentDue)
from @PurchaseOrder p
JOIN Suppliers ON Suppliers.SupplierID = p.SupplierId
where p.IsDamageOrder!=1

SET @PurchaseOrderId = SCOPE_IDENTITY()


INSERT INTO POrderDetails
(
ProductID, ColorID,GodownID, Quantity, UnitPrice, TAmount, PPDISPer, PPDISAmt, MRPRate, POrderID,SalesRate,ExtraPPDISPer,ExtraPPDISAmt,PPOFFER,CreditSalesRate
)
(
Select ProductId, ColorId,GodownId, Quantity, UnitPrice, TAmount,  PPDisPer,
PPDisAmt, MrpRate, @PurchaseOrderId POrderID,SalesRate,ExtraPPDISPer,ExtraPPDISAmt,PPOffer,CreditSalesRate  from @PODetails)

INSERT INTO POProductDetails
(
ProductID, ColorID, IMENO, POrderDetailID,ReturnSDetailID,ReturnQty
)
(
Select POPD.ProductId, POPD.ColorId, POPD.IMENo, POD.POrderDetailID,POPD.ReturnSDetailID,POPD.ReturnQty from @POProductDetails POPD
INNER JOIN POrderDetails POD ON POD.ProductID = POPD.ProductId AND POD.ColorID = POPD.ColorId AND POD.POrderID = @PurchaseOrderId
)

-----------------------------Delete IMEI----------------------------------
declare @POrderID int
declare @SupplierID int
declare @ProductID int
declare @ColorID int
declare @ProductType int
declare @StockID int
declare @SDetailID int
declare @POrderDetailID int
declare @TotalDue decimal(18,2)
declare @GrandTotal decimal(18,2)
declare @TotalAmount decimal(18,2)
declare @NetDiscount decimal(18,2)
declare @PPDISAmt decimal(18,2)
declare @PaymentDue decimal(18,2)
declare @MRPRate decimal(18,2)
declare @UnitPrice decimal(18,2)
declare @PPDISPer decimal(18,2)
declare @IMEI varchar(300)
declare @POPDID int
declare @Quantity decimal(18,2)

declare cur CURSOR LOCAL 
for  select  sd.StockID,SDetailID,POrderDetailID,sd.ProductID,sd.IMENO,st.ReturnQty,p.ProductType,sd.ColorID
     from @POProductDetails st
     join StockDetails sd on st.ReturnSDetailID =sd.SDetailID
	 join Products p on sd.ProductID = p.ProductID
     where sd.Status=1
open cur
         fetch next from cur into @StockID,@SDetailID,@POrderDetailID,@ProductID,@IMEI,@Quantity,@ProductType,@ColorID
         
while @@FETCH_STATUS = 0
BEGIN


----Update stock Start
update Stocks set Quantity=Quantity-@Quantity where StockID=@StockID

IF(@ProductType=2)
BEGIN
update StockDetails set Quantity=Quantity-@Quantity where SDetailID=@SDetailID
update StockDetails set Status=3 where SDetailID=@SDetailID and Quantity=0
END
ELSE
update StockDetails set Status=3 where SDetailID=@SDetailID

delete [dbo].[SRVProductDetails] where SDetailID=@SDetailID


  fetch next from cur into @StockID,@SDetailID,@POrderDetailID,@ProductID,@IMEI,@Quantity,@ProductType,@ColorID
END


COMMIT

SET @OutPOrderID=@PurchaseOrderId
SET @Result =1;

END TRY

BEGIN CATCH

    IF @@TRANCOUNT > 0
        ROLLBACK

		SET @Result =0;

END CATCH

------------------------------------------------------
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.POProductDetails ADD
	ReturnQty decimal(18, 2) NOT NULL CONSTRAINT DF_POProductDetails_ReturnQty DEFAULT 0,
	ReturnSDetailID int NULL
GO
ALTER TABLE dbo.POProductDetails SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
------------------------------------------------------
-----------------Date: 28-01-2020---------------------
------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SisterConcerns ADD
	SalesShowPercent decimal(18, 2) NOT NULL CONSTRAINT DF_SisterConcerns_SalesShowPercent DEFAULT 0,
	PurchaseShowPercent decimal(18, 2) NOT NULL CONSTRAINT DF_SisterConcerns_PurchaseShowPercent DEFAULT 0,
	StockShowPercent decimal(18, 2) NOT NULL CONSTRAINT DF_SisterConcerns_StockShowPercent DEFAULT 0
GO
ALTER TABLE dbo.SisterConcerns SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

------------------------------------------------------
-----------------Date: 16-01-2020---------------------
------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	CompanyLogo varbinary(MAX) NULL,
	LogoMimeType varchar(250) NULL
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
------------------------------------------------------
-----------------Date: 15-01-2020---------------------
------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
EXECUTE sp_rename N'dbo.SMSBillPayments.CreatedDate', N'Tmp_CreateDate', 'COLUMN' 
GO
EXECUTE sp_rename N'dbo.SMSBillPayments.Tmp_CreateDate', N'CreateDate', 'COLUMN' 
GO
ALTER TABLE dbo.SMSBillPayments SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
------------------------------------------------------
-----------------Date: 14-01-2020---------------------
------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SisterConcerns SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.Banks ADD
	ConcernID int NOT NULL CONSTRAINT DF_Banks_ConcernID DEFAULT 1
GO
ALTER TABLE dbo.Banks ADD CONSTRAINT
	FK_Banks_SisterConcerns FOREIGN KEY
	(
	ConcernID
	) REFERENCES dbo.SisterConcerns
	(
	ConcernID
	) ON UPDATE  NO ACTION 
	 ON DELETE  NO ACTION 
	
GO
ALTER TABLE dbo.Banks SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

------------------------------------------------------
/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SisterConcerns ADD
	ParentID int NOT NULL CONSTRAINT DF_SisterConcerns_ParentID DEFAULT 0
GO
ALTER TABLE dbo.SisterConcerns SET (LOCK_ESCALATION = TABLE)
GO
COMMIT

------------------------------------------------------
-----------------Date: 12-01-2020---------------------
------------------------------------------------------

/* To prevent any potential data loss issues, you should review this script in detail before running it outside the context of the database designer.*/
BEGIN TRANSACTION
SET QUOTED_IDENTIFIER ON
SET ARITHABORT ON
SET NUMERIC_ROUNDABORT OFF
SET CONCAT_NULL_YIELDS_NULL ON
SET ANSI_NULLS ON
SET ANSI_PADDING ON
SET ANSI_WARNINGS ON
COMMIT
BEGIN TRANSACTION
GO
ALTER TABLE dbo.SystemInformations ADD
	SMSProviderID int NOT NULL CONSTRAINT DF_SystemInformations_SMSProviderID DEFAULT 0
GO
ALTER TABLE dbo.SystemInformations SET (LOCK_ESCALATION = TABLE)
GO
COMMIT
------------------------------------------------
INSERT [dbo].[SMSFormates] ([SMSFormateID], [Code], [SMSDescription], [SMSType]) VALUES (1, N'00001', N'Sales', 1)
INSERT [dbo].[SMSFormates] ([SMSFormateID], [Code], [SMSDescription], [SMSType]) VALUES (2, N'00002', N'Purchase', 2)
INSERT [dbo].[SMSFormates] ([SMSFormateID], [Code], [SMSDescription], [SMSType]) VALUES (3, N'00003', N'CashCollection', 3)
INSERT [dbo].[SMSFormates] ([SMSFormateID], [Code], [SMSDescription], [SMSType]) VALUES (4, N'00004', N'InstallmentCollection', 4)
INSERT [dbo].[SMSFormates] ([SMSFormateID], [Code], [SMSDescription], [SMSType]) VALUES (5, N'00005', N'Installment Alert', 5)
INSERT [dbo].[SMSFormates] ([SMSFormateID], [Code], [SMSDescription], [SMSType]) VALUES (6, N'00006', N'Offer', 6)
INSERT [dbo].[SMSFormates] ([SMSFormateID], [Code], [SMSDescription], [SMSType]) VALUES (7, N'00007', N'Error', 7)
INSERT [dbo].[SMSFormates] ([SMSFormateID], [Code], [SMSDescription], [SMSType]) VALUES (8, N'00008', N'Registration', 8)
-----------------------------------------------------

INSERT [dbo].[MenuItems] ([Title], [Description], [ParentId], [Url], [WithoutView], [Sequence], [Icon]) VALUES (N'SMS Service', N'SMS Service', 0, N'###', 0, 9, N'<i class="fa fa-commenting" aria-hidden="true"></i>')
INSERT [dbo].[MenuItems] ([Title], [Description], [ParentId], [Url], [WithoutView], [Sequence], [Icon]) VALUES (N'SMS Inbox', N'SMS Inbox', 1192, N'/SMSService/', 0, 1, N'<i class="fa fa-inbox" aria-hidden="true"></i>')
INSERT [dbo].[MenuItems] ([Title], [Description], [ParentId], [Url], [WithoutView], [Sequence], [Icon]) VALUES ( N'Send SMS', N'Send SMS', 1192, N'/SMSService/SendSMS/', 0, 2, N'<i class="fa fa-paper-plane" aria-hidden="true"></i>')
INSERT [dbo].[MenuItems] ([Title], [Description], [ParentId], [Url], [WithoutView], [Sequence], [Icon]) VALUES (N'SMS Bill', N'SMS Bill', 1192, N'/SMSBillPayment/', 0, 3, N'<i class="fa fa-money" aria-hidden="true"></i>')
INSERT [dbo].[MenuItems] ([Title], [Description], [ParentId], [Url], [WithoutView], [Sequence], [Icon]) VALUES (N'SMS Report', N'SMS Report', 1192, N'/SMSService/SMSReport', 0, 4, N'<i class="fa fa-flag-checkered" aria-hidden="true"></i>')